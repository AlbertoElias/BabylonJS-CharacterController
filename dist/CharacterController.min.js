var org;!function(t){!function(t){!function(t){!function(t){var i=BABYLON.Vector3,e=BABYLON.Ray,s=function(){function t(t,s,a,r){var o=this;this.slopeLimit=30,this.maxSlopeLimit=45,this.sl=Math.PI*this.slopeLimit/180,this.sl2=Math.PI*this.maxSlopeLimit/180,this.started=!1,this.walkSpeed=3,this.runSpeed=2*this.walkSpeed,this.backSpeed=this.walkSpeed/2,this.jumpSpeed=2*this.walkSpeed,this.leftSpeed=this.walkSpeed/2,this.rightSpeed=this.walkSpeed/2,this.prevAnim=null,this.gravity=9.8,this.avStartPos=new i(0,0,0),this.grounded=!1,this.freeFallDist=0,this.fallFrameCountMin=50,this.fallFrameCount=0,this.inFreeFall=!1,this.wasWalking=!1,this.wasRunning=!1,this.jumpStartPosY=0,this.jumpTime=0,this.movFallTime=0,this.idleFallTime=0,this.groundFrameCount=0,this.groundFrameMax=10,this.ray=new e(i.Zero(),i.One(),1),this.rayDir=i.Zero(),this.move=!1,this.avatarSkeleton=s,this.initAnims(),this.camera=a,this.avatar=t,this.scene=r,this.key=new h,window.addEventListener("keydown",function(t){return o.onKeyDown(t)},!1),window.addEventListener("keyup",function(t){return o.onKeyUp(t)},!1),this.renderer=function(){o.moveAVandCamera()}}return t.prototype.setAvatar=function(t){this.avatar=t},t.prototype.setAvatarSkeleton=function(t){this.avatarSkeleton=t},t.prototype.setSlopeLimit=function(t){this.slopeLimit=t,this.sl=Math.PI*t/180},t.prototype.setWalkSpeed=function(t){this.walkSpeed=t},t.prototype.setRunSpeed=function(t){this.runSpeed=t},t.prototype.setBackSpeed=function(t){this.backSpeed=t},t.prototype.setJumpSpeed=function(t){this.jumpSpeed=t},t.prototype.setLeftSpeed=function(t){this.leftSpeed=t},t.prototype.setRightSpeed=function(t){this.rightSpeed=t},t.prototype.start=function(){this.started||(this.started=!0,this.key.reset(),this.movFallTime=0,this.idleFallTime=.001,this.grounded=!1,this.updateTargetValue(),this.scene.registerBeforeRender(this.renderer),this.scene)},t.prototype.stop=function(){this.started&&(this.started=!1,this.scene.unregisterBeforeRender(this.renderer))},t.prototype.initAnims=function(){this.walk=new a("walk",!0,1,!0),this.walkBack=new a("walkBack",!0,.5,!0),this.idle=new a("idle",!0,1,!0),this.run=new a("run",!0,1,!0),this.jump=new a("jump",!1,2,!0),this.fall=new a("fall",!1,1,!0),this.turnLeft=new a("turnLeft",!0,.5,!0),this.turnRight=new a("turnRight",!0,.5,!0),this.strafeLeft=new a("strafeLeft",!0,1,!0),this.strafeRight=new a("strafeRight",!0,1,!0),this.slideBack=new a("slideBack",!0,1,!0)},t.prototype.moveAVandCamera=function(){this.avStartPos.copyFrom(this.avatar.position);var t=null,i=this.scene.getEngine().getDeltaTime()/1e3;this.key.jump&&!this.inFreeFall?(this.grounded=!1,this.idleFallTime=0,t=this.doJump(i)):this.anyMovement()||this.inFreeFall?(this.grounded=!1,this.idleFallTime=0,t=this.doMove(i)):this.inFreeFall||(t=this.doIdle(i)),null!=t&&null!==this.avatarSkeleton&&this.prevAnim!==t&&(t.exist&&this.avatarSkeleton.beginAnimation(t.name,t.l,t.r),this.prevAnim=t),this.updateTargetValue()},t.prototype.doJump=function(t){var e=null;e=this.jump,0===this.jumpTime&&(this.jumpStartPosY=this.avatar.position.y);var s=this.jumpSpeed-this.gravity*this.jumpTime,a=s*t-.5*this.gravity*t*t;this.jumpTime=this.jumpTime+t;var h,r=0;if(this.avatar.rotation.y=-4.69-this.camera.alpha,this.wasRunning||this.wasWalking?(this.wasRunning?r=this.runSpeed*t:this.wasWalking&&(r=this.walkSpeed*t),h=this.moveVector.clone(),h.y=0,h=h.normalize(),h.scaleToRef(r,h),h.y=a):h=new i(0,a,0),this.avatar.moveWithCollisions(h),a<0)if(e=this.fall,this.avatar.position.y>this.avStartPos.y||this.avatar.position.y===this.avStartPos.y&&h.length()>.001)this.endJump();else if(this.avatar.position.y<this.jumpStartPosY){var o=this.avatar.position.subtract(this.avStartPos);this.areVectorsEqual(o,h,.001)||this.verticalSlope(o)<=this.sl&&this.endJump()}return e},t.prototype.endJump=function(){this.key.jump=!1,this.jumpTime=0,this.wasWalking=!1,this.wasRunning=!1},t.prototype.areVectorsEqual=function(t,i,e){return Math.abs(t.x-i.x)<e&&Math.abs(t.y-i.y)<e&&Math.abs(t.z-i.z)<e},t.prototype.verticalSlope=function(t){return Math.atan(Math.abs(t.y/Math.sqrt(t.x*t.x+t.z*t.z)))},t.prototype.doMove=function(t){var i=this.movFallTime*this.gravity;this.freeFallDist=i*t+this.gravity*t*t/2,this.movFallTime=this.movFallTime+t;var e=!1,s=null;if(this.inFreeFall)this.moveVector.y=-this.freeFallDist,e=!0;else if(this.wasWalking=!1,this.wasRunning=!1,this.key.forward){var a=0;this.key.shift?(this.wasRunning=!0,a=this.runSpeed*t,s=this.run):(this.wasWalking=!0,a=this.walkSpeed*t,s=this.walk),this.moveVector=this.avatar.calcMovePOV(0,-this.freeFallDist,a),e=!0}else this.key.backward?(this.moveVector=this.avatar.calcMovePOV(0,-this.freeFallDist,-this.backSpeed*t),s=this.walkBack,e=!0):this.key.stepLeft?(s=this.strafeLeft,this.moveVector=this.avatar.calcMovePOV(-this.leftSpeed*t,-this.freeFallDist,0),e=!0):this.key.stepRight&&(s=this.strafeRight,this.moveVector=this.avatar.calcMovePOV(this.rightSpeed*t,-this.freeFallDist,0),e=!0);if(this.key.stepLeft||this.key.stepRight||(this.key.turnLeft?(this.camera.alpha=this.camera.alpha+.022,e||(this.avatar.rotation.y=-4.69-this.camera.alpha,s=this.turnLeft)):this.key.turnRight&&(this.camera.alpha=this.camera.alpha-.022,e||(this.avatar.rotation.y=-4.69-this.camera.alpha,s=this.turnRight))),e&&(this.avatar.rotation.y=-4.69-this.camera.alpha,this.moveVector.length()>.001))if(this.avatar.moveWithCollisions(this.moveVector),this.avatar.position.y>this.avStartPos.y){var h=this.avatar.position.subtract(this.avStartPos);this.verticalSlope(h)>this.sl2&&(this.avatar.position.copyFrom(this.avStartPos),this.endFreeFall()),this.verticalSlope(h)<this.sl?this.endFreeFall():(this.fallFrameCount=0,this.inFreeFall=!1)}else if(this.avatar.position.y<this.avStartPos.y){var h=this.avatar.position.subtract(this.avStartPos);this.areVectorsEqual(h,this.moveVector,.001)?(this.inFreeFall=!0,++this.fallFrameCount>this.fallFrameCountMin&&(s=this.fall)):this.verticalSlope(h)<=this.sl?this.endFreeFall():(this.fallFrameCount=0,this.inFreeFall=!1)}else this.endFreeFall();return s},t.prototype.endFreeFall=function(){this.movFallTime=0,this.fallFrameCount=0,this.inFreeFall=!1},t.prototype.doIdle=function(t){if(this.grounded)return this.idle;this.wasWalking=!1,this.wasRunning=!1,this.movFallTime=0;var e=this.idle;if(this.fallFrameCount=0,0===t)this.freeFallDist=5;else{var s=this.idleFallTime*this.gravity;this.freeFallDist=s*t+this.gravity*t*t/2,this.idleFallTime=this.idleFallTime+t}if(this.freeFallDist<.01)return e;var a=new i(0,-this.freeFallDist,0);if(this.avatar.rotation.y=-4.69-this.camera.alpha,this.avatar.moveWithCollisions(a),this.avatar.position.y>this.avStartPos.y||this.avatar.position.y===this.avStartPos.y)this.groundIt();else if(this.avatar.position.y<this.avStartPos.y){var h=this.avatar.position.subtract(this.avStartPos);this.areVectorsEqual(h,a,.001)||(this.verticalSlope(h)<=this.sl?(this.groundIt(),this.avatar.position.copyFrom(this.avStartPos)):(this.unGroundIt(),e=this.slideBack))}return e},t.prototype.groundIt=function(){++this.groundFrameCount>this.groundFrameMax&&(this.grounded=!0,this.idleFallTime=0)},t.prototype.unGroundIt=function(){this.grounded=!1,this.groundFrameCount=0},t.prototype.updateTargetValue=function(){this.camera.target.copyFromFloats(this.avatar.position.x,this.avatar.position.y+1.5,this.avatar.position.z),this.bounceCamera()},t.prototype.bounceCamera=function(){this.camera.position.subtractToRef(this.camera.target,this.rayDir),this.ray.origin=this.camera.target,this.ray.length=this.rayDir.length(),this.ray.direction=this.rayDir.normalize();var t=this.scene.pickWithRay(this.ray,null,!0);t.hit&&(this.camera.position=t.pickedPoint)},t.prototype.onKeyDown=function(t){var i=t,e=String.fromCharCode(i.keyCode);32===i.keyCode?this.key.jump=!0:16===i.keyCode?this.key.shift=!0:"W"===e||38===i.keyCode?this.key.forward=!0:"A"===e||37===i.keyCode?this.key.turnLeft=!0:"D"===e||39===i.keyCode?this.key.turnRight=!0:"S"===e||40===i.keyCode?this.key.backward=!0:"Q"===e?this.key.stepLeft=!0:"E"===e&&(this.key.stepRight=!0),this.move=this.anyMovement()},t.prototype.anyMovement=function(){return this.key.forward||this.key.backward||this.key.turnLeft||this.key.turnRight||this.key.stepLeft||this.key.stepRight},t.prototype.onKeyUp=function(t){var i=t,e=String.fromCharCode(i.keyCode);32===i.keyCode||(16===i.keyCode?this.key.shift=!1:"W"===e||38===i.keyCode?this.key.forward=!1:"A"===e||37===i.keyCode?this.key.turnLeft=!1:"D"===e||39===i.keyCode?this.key.turnRight=!1:"S"===e||40===i.keyCode?this.key.backward=!1:"Q"===e?this.key.stepLeft=!1:"E"===e&&(this.key.stepRight=!1)),this.move=this.anyMovement()},t.prototype.horizontalMove=function(t,i){var e=t.x-i.x,s=t.z-i.z;return Math.sqrt(e*e+s*s)},t}();t.CharacterControl=s;var a=function(){function t(t,i,e,s){this.exist=!1,this.name=t,this.l=i,this.r=e,this.exist=s}return t}();t.AnimData=a;var h=function(){function t(){this.forward=!1,this.backward=!1,this.turnRight=!1,this.turnLeft=!1,this.stepRight=!1,this.stepLeft=!1,this.jump=!1,this.shift=!1}return t.prototype.reset=function(){this.forward=!1,this.backward=!1,this.turnRight=!1,this.turnLeft=!1,this.stepRight=!1,this.stepLeft=!1,this.jump=!1,this.shift=!1},t}();t.Key=h}(t.component||(t.component={}))}(t.babylonjs||(t.babylonjs={}))}(t.ssatguru||(t.ssatguru={}))}(org||(org={}));