var org;!function(t){!function(t){!function(t){!function(t){var e=BABYLON.Vector3,i=BABYLON.Ray,s=function(){function t(t,s,a,r){var n=this;this.walkSpeed=3,this.runSpeed=2*this.walkSpeed,this.backSpeed=this.walkSpeed/2,this.jumpSpeed=2*this.walkSpeed,this.leftSpeed=this.walkSpeed/2,this.rightSpeed=this.walkSpeed/2,this.gravity=9.8,this.minSlopeLimit=30,this.maxSlopeLimit=45,this.sl=Math.PI*this.minSlopeLimit/180,this.sl2=Math.PI*this.maxSlopeLimit/180,this.walkKey="W",this.walkBackKey="S",this.turnLeftKey="A",this.turnRightKey="D",this.strafeLeftKey="Q",this.strafeRightKey="E",this.jumpKey="32",this.walkCode=38,this.walkBackCode=40,this.turnLeftCode=37,this.turnRightCode=39,this.strafeLeftCode=0,this.strafeRightCode=0,this.jumpCode=32,this.elasticCamera=!0,this.started=!1,this.prevAnim=null,this.avStartPos=new e(0,0,0),this.grounded=!1,this.freeFallDist=0,this.fallFrameCountMin=50,this.fallFrameCount=0,this.inFreeFall=!1,this.wasWalking=!1,this.wasRunning=!1,this.jumpStartPosY=0,this.jumpTime=0,this.movFallTime=0,this.idleFallTime=0,this.groundFrameCount=0,this.groundFrameMax=10,this.ray=new i(e.Zero(),e.One(),1),this.rayDir=e.Zero(),this.move=!1,this.avatarSkeleton=s,this.initAnims(s),this.camera=a,this.avatar=t,this.scene=r,this.key=new h,window.addEventListener("keydown",function(t){return n.onKeyDown(t)},!1),window.addEventListener("keyup",function(t){return n.onKeyUp(t)},!1),this.renderer=function(){n.moveAVandCamera()}}return t.prototype.setAvatar=function(t){this.avatar=t},t.prototype.setAvatarSkeleton=function(t){this.avatarSkeleton=t},t.prototype.setSlopeLimit=function(t,e){this.minSlopeLimit=t,this.maxSlopeLimit=e,this.sl=Math.PI*t/180,this.sl2=Math.PI*this.maxSlopeLimit/180},t.prototype.setWalkSpeed=function(t){this.walkSpeed=t},t.prototype.setRunSpeed=function(t){this.runSpeed=t},t.prototype.setBackSpeed=function(t){this.backSpeed=t},t.prototype.setJumpSpeed=function(t){this.jumpSpeed=t},t.prototype.setLeftSpeed=function(t){this.leftSpeed=t},t.prototype.setRightSpeed=function(t){this.rightSpeed=t},t.prototype.setGravity=function(t){this.gravity=t},t.prototype.setWalkAnim=function(t,e){this.walk.name=t,this.walk.rate=e},t.prototype.setRunAnim=function(t,e){this.run.name=t,this.run.rate=e},t.prototype.setWalkBackAnim=function(t,e){this.walkBack.name=t,this.walkBack.rate=e},t.prototype.setSlideBackAnim=function(t,e){this.slideBack.name=t,this.slideBack.rate=e},t.prototype.setIdleAnim=function(t,e){this.idle.name=t,this.idle.rate=e},t.prototype.setStrafeRightAnim=function(t,e){this.strafeRight.name=t,this.strafeRight.rate=e},t.prototype.setSrafeLeftAnim=function(t,e){this.strafeLeft.name=t,this.strafeLeft.rate=e},t.prototype.setJumpAnim=function(t,e){this.jump.name=t,this.jump.rate=e},t.prototype.setFallAnim=function(t,e){this.fall.name=t,this.fall.rate=e},t.prototype.setWalkKey=function(t){this.walkKey=t},t.prototype.setWalkBackKey=function(t){this.walkBackKey=t},t.prototype.setTurnLeftKey=function(t){this.turnLeftKey=t},t.prototype.setTurnRightKey=function(t){this.turnRightKey=t},t.prototype.setStrafeLeftKey=function(t){this.strafeLeftKey=t},t.prototype.setStrafeRightKey=function(t){this.strafeRightKey=t},t.prototype.setJumpKey=function(t){this.jumpKey=t},t.prototype.setWalkCode=function(t){this.walkCode=t},t.prototype.setWalkBackCode=function(t){this.walkBackCode=t},t.prototype.setTurnLeftCode=function(t){this.turnLeftCode=t},t.prototype.setTurnRightCode=function(t){this.turnRightCode=t},t.prototype.setStrafeLeftCode=function(t){this.strafeLeftCode=t},t.prototype.setStrafeRightCode=function(t){this.strafeRightCode=t},t.prototype.setJumpCode=function(t){this.jumpCode=t},t.prototype.setCameraElastic=function(t){this.elasticCamera=t},t.prototype.initAnims=function(t){this.walk=new a("walk",!0,1,!0),this.walkBack=new a("walkBack",!0,.5,!0),this.idle=new a("idle",!0,1,!0),this.run=new a("run",!0,1,!0),this.jump=new a("jump",!1,2,!0),this.fall=new a("fall",!1,1,!0),this.turnLeft=new a("turnLeft",!0,.5,!0),this.turnRight=new a("turnRight",!0,.5,!0),this.strafeLeft=new a("strafeLeft",!0,1,!0),this.strafeRight=new a("strafeRight",!0,1,!0),this.slideBack=new a("slideBack",!0,1,!0),null==t.getAnimationRange("walk")&&(this.walk.exist=!1),null==t.getAnimationRange("walkBack")&&(this.walkBack.exist=!1),null==t.getAnimationRange("idle")&&(this.idle.exist=!1),null==t.getAnimationRange("run")&&(this.run.exist=!1),null==t.getAnimationRange("jump")&&(this.jump.exist=!1),null==t.getAnimationRange("fall")&&(this.fall.exist=!1),null==t.getAnimationRange("turnLeft")&&(this.turnLeft.exist=!1),null==t.getAnimationRange("turnRight")&&(this.turnRight.exist=!1),null==t.getAnimationRange("strafeLeft")&&(this.strafeLeft.exist=!1),null==t.getAnimationRange("strafeRight")&&(this.strafeRight.exist=!1),null==t.getAnimationRange("slideBack")&&(this.slideBack.exist=!1)},t.prototype.start=function(){this.started||(this.started=!0,this.key.reset(),this.movFallTime=0,this.idleFallTime=.001,this.grounded=!1,this.updateTargetValue(),this.scene.registerBeforeRender(this.renderer),this.scene)},t.prototype.stop=function(){this.started&&(this.started=!1,this.scene.unregisterBeforeRender(this.renderer))},t.prototype.moveAVandCamera=function(){this.avStartPos.copyFrom(this.avatar.position);var t=null,e=this.scene.getEngine().getDeltaTime()/1e3;this.key.jump&&!this.inFreeFall?(this.grounded=!1,this.idleFallTime=0,t=this.doJump(e)):this.anyMovement()||this.inFreeFall?(this.grounded=!1,this.idleFallTime=0,t=this.doMove(e)):this.inFreeFall||(t=this.doIdle(e)),null!=t&&null!==this.avatarSkeleton&&this.prevAnim!==t&&(t.exist&&this.avatarSkeleton.beginAnimation(t.name,t.loop,t.rate),this.prevAnim=t),this.updateTargetValue()},t.prototype.doJump=function(t){var i=null;i=this.jump,0===this.jumpTime&&(this.jumpStartPosY=this.avatar.position.y);var s=this.jumpSpeed-this.gravity*this.jumpTime,a=s*t-.5*this.gravity*t*t;this.jumpTime=this.jumpTime+t;var h,r=0;if(this.avatar.rotation.y=-4.69-this.camera.alpha,this.wasRunning||this.wasWalking?(this.wasRunning?r=this.runSpeed*t:this.wasWalking&&(r=this.walkSpeed*t),h=this.moveVector.clone(),h.y=0,h=h.normalize(),h.scaleToRef(r,h),h.y=a):h=new e(0,a,0),this.avatar.moveWithCollisions(h),a<0)if(i=this.fall,this.avatar.position.y>this.avStartPos.y||this.avatar.position.y===this.avStartPos.y&&h.length()>.001)this.endJump();else if(this.avatar.position.y<this.jumpStartPosY){var n=this.avatar.position.subtract(this.avStartPos);this.areVectorsEqual(n,h,.001)||this.verticalSlope(n)<=this.sl&&this.endJump()}return i},t.prototype.endJump=function(){this.key.jump=!1,this.jumpTime=0,this.wasWalking=!1,this.wasRunning=!1},t.prototype.areVectorsEqual=function(t,e,i){return Math.abs(t.x-e.x)<i&&Math.abs(t.y-e.y)<i&&Math.abs(t.z-e.z)<i},t.prototype.verticalSlope=function(t){return Math.atan(Math.abs(t.y/Math.sqrt(t.x*t.x+t.z*t.z)))},t.prototype.doMove=function(t){var e=this.movFallTime*this.gravity;this.freeFallDist=e*t+this.gravity*t*t/2,this.movFallTime=this.movFallTime+t;var i=!1,s=null;if(this.inFreeFall)this.moveVector.y=-this.freeFallDist,i=!0;else if(this.wasWalking=!1,this.wasRunning=!1,this.key.forward){var a=0;this.key.shift?(this.wasRunning=!0,a=this.runSpeed*t,s=this.run):(this.wasWalking=!0,a=this.walkSpeed*t,s=this.walk),this.moveVector=this.avatar.calcMovePOV(0,-this.freeFallDist,a),i=!0}else this.key.backward?(this.moveVector=this.avatar.calcMovePOV(0,-this.freeFallDist,-this.backSpeed*t),s=this.walkBack,i=!0):this.key.stepLeft?(s=this.strafeLeft,this.moveVector=this.avatar.calcMovePOV(-this.leftSpeed*t,-this.freeFallDist,0),i=!0):this.key.stepRight&&(s=this.strafeRight,this.moveVector=this.avatar.calcMovePOV(this.rightSpeed*t,-this.freeFallDist,0),i=!0);if(this.key.stepLeft||this.key.stepRight||(this.key.turnLeft?(this.camera.alpha=this.camera.alpha+.022,i||(this.avatar.rotation.y=-4.69-this.camera.alpha,s=this.turnLeft)):this.key.turnRight&&(this.camera.alpha=this.camera.alpha-.022,i||(this.avatar.rotation.y=-4.69-this.camera.alpha,s=this.turnRight))),i&&(this.avatar.rotation.y=-4.69-this.camera.alpha,this.moveVector.length()>.001))if(this.avatar.moveWithCollisions(this.moveVector),this.avatar.position.y>this.avStartPos.y){var h=this.avatar.position.subtract(this.avStartPos);this.verticalSlope(h)>this.sl2&&(this.avatar.position.copyFrom(this.avStartPos),this.endFreeFall()),this.verticalSlope(h)<this.sl?this.endFreeFall():(this.fallFrameCount=0,this.inFreeFall=!1)}else if(this.avatar.position.y<this.avStartPos.y){var h=this.avatar.position.subtract(this.avStartPos);this.areVectorsEqual(h,this.moveVector,.001)?(this.inFreeFall=!0,++this.fallFrameCount>this.fallFrameCountMin&&(s=this.fall)):this.verticalSlope(h)<=this.sl?this.endFreeFall():(this.fallFrameCount=0,this.inFreeFall=!1)}else this.endFreeFall();return s},t.prototype.endFreeFall=function(){this.movFallTime=0,this.fallFrameCount=0,this.inFreeFall=!1},t.prototype.doIdle=function(t){if(this.grounded)return this.idle;this.wasWalking=!1,this.wasRunning=!1,this.movFallTime=0;var i=this.idle;if(this.fallFrameCount=0,0===t)this.freeFallDist=5;else{var s=this.idleFallTime*this.gravity;this.freeFallDist=s*t+this.gravity*t*t/2,this.idleFallTime=this.idleFallTime+t}if(this.freeFallDist<.01)return i;var a=new e(0,-this.freeFallDist,0);if(this.avatar.rotation.y=-4.69-this.camera.alpha,this.avatar.moveWithCollisions(a),this.avatar.position.y>this.avStartPos.y||this.avatar.position.y===this.avStartPos.y)this.groundIt();else if(this.avatar.position.y<this.avStartPos.y){var h=this.avatar.position.subtract(this.avStartPos);this.areVectorsEqual(h,a,.001)||(this.verticalSlope(h)<=this.sl?(this.groundIt(),this.avatar.position.copyFrom(this.avStartPos)):(this.unGroundIt(),i=this.slideBack))}return i},t.prototype.groundIt=function(){++this.groundFrameCount>this.groundFrameMax&&(this.grounded=!0,this.idleFallTime=0)},t.prototype.unGroundIt=function(){this.grounded=!1,this.groundFrameCount=0},t.prototype.updateTargetValue=function(){this.camera.target.copyFromFloats(this.avatar.position.x,this.avatar.position.y+1.5,this.avatar.position.z),this.elasticCamera&&this.snapCamera()},t.prototype.snapCamera=function(){this.camera.position.subtractToRef(this.camera.target,this.rayDir),this.ray.origin=this.camera.target,this.ray.length=this.rayDir.length(),this.ray.direction=this.rayDir.normalize();var t=this.scene.pickWithRay(this.ray,null,!0);t.hit&&(this.camera.position=t.pickedPoint)},t.prototype.anyMovement=function(){return this.key.forward||this.key.backward||this.key.turnLeft||this.key.turnRight||this.key.stepLeft||this.key.stepRight},t.prototype.onKeyDown=function(t){var e=t,i=String.fromCharCode(e.keyCode);i===this.jumpKey||e.keyCode===this.jumpCode?this.key.jump=!0:16===e.keyCode?this.key.shift=!0:i===this.walkKey||e.keyCode===this.walkCode?this.key.forward=!0:i===this.turnLeftKey||e.keyCode===this.turnLeftCode?this.key.turnLeft=!0:i===this.turnRightKey||e.keyCode===this.turnRightCode?this.key.turnRight=!0:i===this.walkBackKey||e.keyCode===this.walkBackCode?this.key.backward=!0:i===this.strafeLeftKey||e.keyCode===this.strafeLeftCode?this.key.stepLeft=!0:i!==this.strafeRightKey&&e.keyCode!==this.strafeRightCode||(this.key.stepRight=!0),this.move=this.anyMovement()},t.prototype.onKeyUp=function(t){var e=t,i=String.fromCharCode(e.keyCode);16===e.keyCode?this.key.shift=!1:i===this.walkKey||e.keyCode===this.walkCode?this.key.forward=!1:i===this.turnLeftKey||e.keyCode===this.turnLeftCode?this.key.turnLeft=!1:i===this.turnRightKey||e.keyCode===this.turnRightCode?this.key.turnRight=!1:i===this.walkBackKey||e.keyCode===this.walkBackCode?this.key.backward=!1:i===this.strafeLeftKey||e.keyCode===this.strafeLeftCode?this.key.stepLeft=!1:i!==this.strafeRightKey&&e.keyCode!==this.strafeRightCode||(this.key.stepRight=!1),this.move=this.anyMovement()},t.prototype.horizontalMove=function(t,e){var i=t.x-e.x,s=t.z-e.z;return Math.sqrt(i*i+s*s)},t}();t.CharacterControl=s;var a=function(){function t(t,e,i,s){this.exist=!1,this.name=t,this.loop=e,this.rate=i,this.exist=s}return t}();t.AnimData=a;var h=function(){function t(){this.reset()}return t.prototype.reset=function(){this.forward=!1,this.backward=!1,this.turnRight=!1,this.turnLeft=!1,this.stepRight=!1,this.stepLeft=!1,this.jump=!1,this.shift=!1},t}();t.Key=h}(t.component||(t.component={}))}(t.babylonjs||(t.babylonjs={}))}(t.ssatguru||(t.ssatguru={}))}(org||(org={}));