!function(t,i){if("object"==typeof exports&&"object"==typeof module)module.exports=i();else if("function"==typeof define&&define.amd)define([],i);else{var e=i();for(var s in e)("object"==typeof exports?exports:t)[s]=e[s]}}(self,(()=>(()=>{"use strict";var t={d:(i,e)=>{for(var s in e)t.o(e,s)&&!t.o(i,s)&&Object.defineProperty(i,s,{enumerable:!0,get:e[s]})},o:(t,i)=>Object.prototype.hasOwnProperty.call(t,i),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"t",{value:!0})}},i={};t.r(i),t.d(i,{ActionData:()=>RM,ActionMap:()=>IM,CCSettings:()=>MM,CharacterController:()=>xM});class e{constructor(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this.l=null,this.postProcesses=new Array}static AddParser(t,i){this.u[t]=i}static GetParser(t){return this.u[t]?this.u[t]:null}static AddIndividualParser(t,i){this.v[t]=i}static GetIndividualParser(t){return this.v[t]?this.v[t]:null}static Parse(t,i,e,s){for(const n in this.u)Object.prototype.hasOwnProperty.call(this.u,n)&&this.u[n](t,i,e,s)}get environmentTexture(){return this.l}set environmentTexture(t){this.l=t}getNodes(){let t=new Array;return t=t.concat(this.meshes),t=t.concat(this.lights),t=t.concat(this.cameras),t=t.concat(this.transformNodes),this.skeletons.forEach((i=>t=t.concat(i.bones))),t}}e.u={},e.v={};class s{constructor(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}static get HasTriggers(){for(const t in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,t))return!0;return!1}static get HasPickTriggers(){for(const t in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,t)){const i=parseInt(t);if(i>=1&&i<=7)return!0}return!1}static HasSpecificTrigger(t){for(const i in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,i)){if(parseInt(i)===t)return!0}return!1}}s.Triggers={};class n{constructor(t,i=!1,e,s){this.initialize(t,i,e,s)}initialize(t,i=!1,e,s){return this.mask=t,this.skipNextObservers=i,this.target=e,this.currentTarget=s,this}}class r{constructor(t,i,e=null){this.callback=t,this.mask=i,this.scope=e,this.S=!1,this.unregisterOnNextCall=!1}}class h{constructor(t){this.C=new Array,this.T=0,this.I=new n(0),t&&(this.M=t)}static FromPromise(t,i){const e=new h;return t.then((t=>{e.notifyObservers(t)})).catch((t=>{if(!i)throw t;i.notifyObservers(t)})),e}get observers(){return this.C}add(t,i=-1,e=!1,s=null,n=!1){if(!t)return null;const h=new r(t,i,s);return h.unregisterOnNextCall=n,e?this.C.unshift(h):this.C.push(h),this.M&&this.M(h),h}addOnce(t){return this.add(t,void 0,void 0,void 0,!0)}remove(t){if(!t)return!1;return-1!==this.C.indexOf(t)&&(this._(t),!0)}removeCallback(t,i){for(let e=0;e<this.C.length;e++){const s=this.C[e];if(!s.S&&(s.callback===t&&(!i||i===s.scope)))return this._(s),!0}return!1}_(t){this.T++,t.unregisterOnNextCall=!1,t.S=!0,setTimeout((()=>{this.N(t)}),0)}N(t,i=!0){if(!t)return!1;const e=this.C.indexOf(t);return-1!==e&&(i&&this.T--,this.C.splice(e,1),!0)}makeObserverTopPriority(t){this.N(t,!1),this.C.unshift(t)}makeObserverBottomPriority(t){this.N(t,!1),this.C.push(t)}notifyObservers(t,i=-1,e,s,n){if(!this.C.length)return!0;const r=this.I;r.mask=i,r.target=e,r.currentTarget=s,r.skipNextObservers=!1,r.lastReturnValue=t,r.userInfo=n;for(const e of this.C)if(!e.S&&(e.mask&i&&(e.unregisterOnNextCall&&this._(e),e.scope?r.lastReturnValue=e.callback.apply(e.scope,[t,r]):r.lastReturnValue=e.callback(t,r)),r.skipNextObservers))return!1;return!0}notifyObserver(t,i,e=-1){if(t.S)return;const s=this.I;s.mask=e,s.skipNextObservers=!1,t.unregisterOnNextCall&&this._(t),t.callback(i,s)}hasObservers(){return this.C.length-this.T>0}clear(){this.C=new Array,this.M=null,this.T=0}clone(){const t=new h;return t.C=this.C.slice(0),t}hasSpecificMask(t=-1){for(const i of this.C)if(i.mask&t||i.mask===t)return!0;return!1}}class o{static WithinEpsilon(t,i,e=1401298e-51){return Math.abs(t-i)<=e}static ToHex(t){const i=t.toString(16);return t<=15?("0"+i).toUpperCase():i.toUpperCase()}static Sign(t){return 0===(t=+t)||isNaN(t)?t:t>0?1:-1}static Clamp(t,i=0,e=1){return Math.min(e,Math.max(i,t))}static Log2(t){return Math.log(t)*Math.LOG2E}static ILog2(t){if(Math.log2)return Math.floor(Math.log2(t));if(t<0)return NaN;if(0===t)return-1/0;let i=0;if(t<1){for(;t<1;)i++,t*=2;i=-i}else if(t>1)for(;t>1;)i++,t=Math.floor(t/2);return i}static Repeat(t,i){return t-Math.floor(t/i)*i}static Normalize(t,i,e){return(t-i)/(e-i)}static Denormalize(t,i,e){return t*(e-i)+i}static DeltaAngle(t,i){let e=o.Repeat(i-t,360);return e>180&&(e-=360),e}static PingPong(t,i){const e=o.Repeat(t,2*i);return i-Math.abs(e-i)}static SmoothStep(t,i,e){let s=o.Clamp(e);return s=-2*s*s*s+3*s*s,i*s+t*(1-s)}static MoveTowards(t,i,e){let s=0;return s=Math.abs(i-t)<=e?i:t+o.Sign(i-t)*e,s}static MoveTowardsAngle(t,i,e){const s=o.DeltaAngle(t,i);let n=0;return-e<s&&s<e?n=i:(i=t+s,n=o.MoveTowards(t,i,e)),n}static Lerp(t,i,e){return t+(i-t)*e}static LerpAngle(t,i,e){let s=o.Repeat(i-t,360);return s>180&&(s-=360),t+s*o.Clamp(e)}static InverseLerp(t,i,e){let s=0;return s=t!=i?o.Clamp((e-t)/(i-t)):0,s}static Hermite(t,i,e,s,n){const r=n*n,h=n*r;return t*(2*h-3*r+1)+e*(-2*h+3*r)+i*(h-2*r+n)+s*(h-r)}static Hermite1stDerivative(t,i,e,s,n){const r=n*n;return 6*(r-n)*t+(3*r-4*n+1)*i+6*(-r+n)*e+(3*r-2*n)*s}static RandomRange(t,i){return t===i?t:Math.random()*(i-t)+t}static RangeToPercent(t,i,e){return(t-i)/(e-i)}static PercentToRange(t,i,e){return(e-i)*t+i}static NormalizeRadians(t){return t-=o.TwoPi*Math.floor((t+Math.PI)/o.TwoPi)}static HCF(t,i){const e=t%i;return 0===e?i:o.HCF(i,e)}}o.TwoPi=2*Math.PI;const a=1/2.2,l=2.2,c=(1+Math.sqrt(5))/2,u=.001;class f{static BuildArray(t,i){const e=[];for(let s=0;s<t;++s)e.push(i());return e}static BuildTuple(t,i){return f.BuildArray(t,i)}}const d=["push","splice","pop","shift","unshift"];function p(t,i){const e=d.map((e=>function(t,i,e){const s=t[i];if("function"!=typeof s)return null;const n=function(){const s=t.length,r=n.previous.apply(t,arguments);return e(i,s),r};return s.next=n,n.previous=s,t[i]=n,()=>{const e=n.previous;if(!e)return;const s=n.next;s?(e.next=s,s.previous=e):(e.next=void 0,t[i]=e),n.next=void 0,n.previous=void 0}}(t,e,i)));return()=>{e.forEach((t=>{null==t||t()}))}}const m={};function v(t,i){m[t]=i}function g(t){return m[t]}class S{static SetMatrixPrecision(t){if(S.MatrixTrackPrecisionChange=!1,t&&!S.MatrixUse64Bits&&S.MatrixTrackedMatrices)for(let t=0;t<S.MatrixTrackedMatrices.length;++t){const i=S.MatrixTrackedMatrices[t],e=i.P;i.P=new Array(16);for(let t=0;t<16;++t)i.P[t]=e[t]}S.MatrixUse64Bits=t,S.MatrixCurrentType=S.MatrixUse64Bits?Array:Float32Array,S.MatrixTrackedMatrices=null}}S.MatrixUse64Bits=!1,S.MatrixTrackPrecisionChange=!0,S.MatrixCurrentType=Float32Array,S.MatrixTrackedMatrices=[];class E{static get LastCreatedEngine(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this.D}}E.Instances=new Array,E.D=null,E.UseFallbackTexture=!0,E.FallbackTexture="";const A=t=>parseInt(t.toString().replace(/\W/g,""));class C{constructor(t=0,i=0){this.x=t,this.y=i}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){let t=A(this.x);return t=397*t^A(this.y),t}toArray(t,i=0){return t[i]=this.x,t[i+1]=this.y,this}fromArray(t,i=0){return C.FromArrayToRef(t,i,this),this}asArray(){const t=new Array;return this.toArray(t,0),t}copyFrom(t){return this.x=t.x,this.y=t.y,this}copyFromFloats(t,i){return this.x=t,this.y=i,this}set(t,i){return this.copyFromFloats(t,i)}add(t){return new this.constructor(this.x+t.x,this.y+t.y)}addToRef(t,i){return i.x=this.x+t.x,i.y=this.y+t.y,i}addInPlace(t){return this.x+=t.x,this.y+=t.y,this}addVector3(t){return new this.constructor(this.x+t.x,this.y+t.y)}subtract(t){return new this.constructor(this.x-t.x,this.y-t.y)}subtractToRef(t,i){return i.x=this.x-t.x,i.y=this.y-t.y,i}subtractInPlace(t){return this.x-=t.x,this.y-=t.y,this}multiplyInPlace(t){return this.x*=t.x,this.y*=t.y,this}multiply(t){return new this.constructor(this.x*t.x,this.y*t.y)}multiplyToRef(t,i){return i.x=this.x*t.x,i.y=this.y*t.y,i}multiplyByFloats(t,i){return new this.constructor(this.x*t,this.y*i)}divide(t){return new this.constructor(this.x/t.x,this.y/t.y)}divideToRef(t,i){return i.x=this.x/t.x,i.y=this.y/t.y,i}divideInPlace(t){return this.divideToRef(t,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(t){return t.copyFromFloats(-1*this.x,-1*this.y)}scaleInPlace(t){return this.x*=t,this.y*=t,this}scale(t){const i=new this.constructor(0,0);return this.scaleToRef(t,i),i}scaleToRef(t,i){return i.x=this.x*t,i.y=this.y*t,i}scaleAndAddToRef(t,i){return i.x+=this.x*t,i.y+=this.y*t,i}equals(t){return t&&this.x===t.x&&this.y===t.y}equalsWithEpsilon(t,i=.001){return t&&o.WithinEpsilon(this.x,t.x,i)&&o.WithinEpsilon(this.y,t.y,i)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(t,i){const e=Math.cos(t),s=Math.sin(t);return i.x=e*this.x-s*this.y,i.y=s*this.x+e*this.y,i}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return C.NormalizeToRef(this,this),this}clone(){return new this.constructor(this.x,this.y)}static Zero(){return new C(0,0)}static One(){return new C(1,1)}static get ZeroReadOnly(){return C.O}static FromArray(t,i=0){return new C(t[i],t[i+1])}static FromArrayToRef(t,i,e){return e.x=t[i],e.y=t[i+1],e}static CatmullRom(t,i,e,s,n){const r=n*n,h=n*r,o=.5*(2*i.x+(-t.x+e.x)*n+(2*t.x-5*i.x+4*e.x-s.x)*r+(-t.x+3*i.x-3*e.x+s.x)*h),a=.5*(2*i.y+(-t.y+e.y)*n+(2*t.y-5*i.y+4*e.y-s.y)*r+(-t.y+3*i.y-3*e.y+s.y)*h);return new t.constructor(o,a)}static Clamp(t,i,e){let s=t.x;s=s>e.x?e.x:s,s=s<i.x?i.x:s;let n=t.y;return n=n>e.y?e.y:n,n=n<i.y?i.y:n,new t.constructor(s,n)}static Hermite(t,i,e,s,n){const r=n*n,h=n*r,o=2*h-3*r+1,a=-2*h+3*r,l=h-2*r+n,c=h-r,u=t.x*o+e.x*a+i.x*l+s.x*c,f=t.y*o+e.y*a+i.y*l+s.y*c;return new t.constructor(u,f)}static Hermite1stDerivative(t,i,e,s,n){const r=new t.constructor;return this.Hermite1stDerivativeToRef(t,i,e,s,n,r),r}static Hermite1stDerivativeToRef(t,i,e,s,n,r){const h=n*n;return r.x=6*(h-n)*t.x+(3*h-4*n+1)*i.x+6*(-h+n)*e.x+(3*h-2*n)*s.x,r.y=6*(h-n)*t.y+(3*h-4*n+1)*i.y+6*(-h+n)*e.y+(3*h-2*n)*s.y,r}static Lerp(t,i,e){const s=t.x+(i.x-t.x)*e,n=t.y+(i.y-t.y)*e;return new t.constructor(s,n)}static Dot(t,i){return t.x*i.x+t.y*i.y}static Normalize(t){const i=new t.constructor;return this.NormalizeToRef(t,i),i}static NormalizeToRef(t,i){const e=t.length();return 0===e||(i.x=t.x/e,i.y=t.y/e),i}static Minimize(t,i){const e=t.x<i.x?t.x:i.x,s=t.y<i.y?t.y:i.y;return new t.constructor(e,s)}static Maximize(t,i){const e=t.x>i.x?t.x:i.x,s=t.y>i.y?t.y:i.y;return new t.constructor(e,s)}static Transform(t,i){const e=new t.constructor;return C.TransformToRef(t,i,e),e}static TransformToRef(t,i,e){const s=i.m,n=t.x*s[0]+t.y*s[4]+s[12],r=t.x*s[1]+t.y*s[5]+s[13];return e.x=n,e.y=r,e}static PointInTriangle(t,i,e,s){const n=.5*(-e.y*s.x+i.y*(-e.x+s.x)+i.x*(e.y-s.y)+e.x*s.y),r=n<0?-1:1,h=(i.y*s.x-i.x*s.y+(s.y-i.y)*t.x+(i.x-s.x)*t.y)*r,o=(i.x*e.y-i.y*e.x+(i.y-e.y)*t.x+(e.x-i.x)*t.y)*r;return h>0&&o>0&&h+o<2*n*r}static Distance(t,i){return Math.sqrt(C.DistanceSquared(t,i))}static DistanceSquared(t,i){const e=t.x-i.x,s=t.y-i.y;return e*e+s*s}static Center(t,i){const e=new t.constructor;return C.CenterToRef(t,i,e)}static CenterToRef(t,i,e){return e.copyFromFloats((t.x+i.x)/2,(t.y+i.y)/2)}static DistanceOfPointFromSegment(t,i,e){const s=C.DistanceSquared(i,e);if(0===s)return C.Distance(t,i);const n=e.subtract(i),r=Math.max(0,Math.min(1,C.Dot(t.subtract(i),n)/s)),h=i.add(n.multiplyByFloats(r,r));return C.Distance(t,h)}}C.O=C.Zero();class w{constructor(t=0,i=0,e=0){this.F=!0,this.U=t,this.V=i,this.k=e}get x(){return this.U}set x(t){this.U=t,this.F=!0}get y(){return this.V}set y(t){this.V=t,this.F=!0}get z(){return this.k}set z(t){this.k=t,this.F=!0}toString(){return`{X: ${this.U} Y: ${this.V} Z: ${this.k}}`}getClassName(){return"Vector3"}getHashCode(){let t=A(this.U);return t=397*t^A(this.V),t=397*t^A(this.k),t}asArray(){const t=[];return this.toArray(t,0),t}toArray(t,i=0){return t[i]=this.U,t[i+1]=this.V,t[i+2]=this.k,this}fromArray(t,i=0){return w.FromArrayToRef(t,i,this),this}toQuaternion(){return T.RotationYawPitchRoll(this.V,this.U,this.k)}addInPlace(t){return this.addInPlaceFromFloats(t.U,t.V,t.k)}addInPlaceFromFloats(t,i,e){return this.x+=t,this.y+=i,this.z+=e,this}add(t){return new this.constructor(this.U+t.U,this.V+t.V,this.k+t.k)}addToRef(t,i){return i.copyFromFloats(this.U+t.U,this.V+t.V,this.k+t.k)}subtractInPlace(t){return this.x-=t.U,this.y-=t.V,this.z-=t.k,this}subtract(t){return new this.constructor(this.U-t.U,this.V-t.V,this.k-t.k)}subtractToRef(t,i){return this.subtractFromFloatsToRef(t.U,t.V,t.k,i)}subtractFromFloats(t,i,e){return new this.constructor(this.U-t,this.V-i,this.k-e)}subtractFromFloatsToRef(t,i,e,s){return s.copyFromFloats(this.U-t,this.V-i,this.k-e)}negate(){return new this.constructor(-this.U,-this.V,-this.k)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this}negateToRef(t){return t.copyFromFloats(-1*this.U,-1*this.V,-1*this.k)}scaleInPlace(t){return this.x*=t,this.y*=t,this.z*=t,this}scale(t){return new this.constructor(this.U*t,this.V*t,this.k*t)}scaleToRef(t,i){return i.copyFromFloats(this.U*t,this.V*t,this.k*t)}getNormalToRef(t){const i=this.length();let e=Math.acos(this.y/i);const s=Math.atan2(this.z,this.x);e>Math.PI/2?e-=Math.PI/2:e+=Math.PI/2;const n=i*Math.sin(e)*Math.cos(s),r=i*Math.cos(e),h=i*Math.sin(e)*Math.sin(s);return t.set(n,r,h),t}applyRotationQuaternionToRef(t,i){const e=t.w*this.x+t.y*this.z-t.z*this.y,s=t.w*this.y+t.z*this.x-t.x*this.z,n=t.w*this.z+t.x*this.y-t.y*this.x,r=-t.x*this.x-t.y*this.y-t.z*this.z;return i.x=e*t.w+r*-t.x+s*-t.z-n*-t.y,i.y=s*t.w+r*-t.y+n*-t.x-e*-t.z,i.z=n*t.w+r*-t.z+e*-t.y-s*-t.x,i}applyRotationQuaternionInPlace(t){return this.applyRotationQuaternionToRef(t,this)}applyRotationQuaternion(t){return this.applyRotationQuaternionToRef(t,new this.constructor)}scaleAndAddToRef(t,i){return i.addInPlaceFromFloats(this.U*t,this.V*t,this.k*t)}projectOnPlane(t,i){const e=new this.constructor;return this.projectOnPlaneToRef(t,i,e),e}projectOnPlaneToRef(t,i,e){const s=t.normal,n=t.d,r=I.Vector3[0];this.subtractToRef(i,r),r.normalize();const h=w.Dot(r,s);if(Math.abs(h)<Math.pow(10,-10))e.setAll(1/0);else{const t=-(w.Dot(i,s)+n)/h,o=r.scaleInPlace(t);i.addToRef(o,e)}return e}equals(t){return t&&this.U===t.U&&this.V===t.V&&this.k===t.k}equalsWithEpsilon(t,i=.001){return t&&o.WithinEpsilon(this.U,t.U,i)&&o.WithinEpsilon(this.V,t.V,i)&&o.WithinEpsilon(this.k,t.k,i)}equalsToFloats(t,i,e){return this.U===t&&this.V===i&&this.k===e}multiplyInPlace(t){return this.x*=t.U,this.y*=t.V,this.z*=t.k,this}multiply(t){return this.multiplyByFloats(t.U,t.V,t.k)}multiplyToRef(t,i){return i.copyFromFloats(this.U*t.U,this.V*t.V,this.k*t.k)}multiplyByFloats(t,i,e){return new this.constructor(this.U*t,this.V*i,this.k*e)}divide(t){return new this.constructor(this.U/t.U,this.V/t.V,this.k/t.k)}divideToRef(t,i){return i.copyFromFloats(this.U/t.U,this.V/t.V,this.k/t.k)}divideInPlace(t){return this.divideToRef(t,this)}minimizeInPlace(t){return this.minimizeInPlaceFromFloats(t.U,t.V,t.k)}maximizeInPlace(t){return this.maximizeInPlaceFromFloats(t.U,t.V,t.k)}minimizeInPlaceFromFloats(t,i,e){return t<this.U&&(this.x=t),i<this.V&&(this.y=i),e<this.k&&(this.z=e),this}maximizeInPlaceFromFloats(t,i,e){return t>this.U&&(this.x=t),i>this.V&&(this.y=i),e>this.k&&(this.z=e),this}isNonUniformWithinEpsilon(t){const i=Math.abs(this.U),e=Math.abs(this.V);if(!o.WithinEpsilon(i,e,t))return!0;const s=Math.abs(this.k);return!o.WithinEpsilon(i,s,t)||!o.WithinEpsilon(e,s,t)}get isNonUniform(){const t=Math.abs(this.U);if(t!==Math.abs(this.V))return!0;return t!==Math.abs(this.k)}floor(){return new this.constructor(Math.floor(this.U),Math.floor(this.V),Math.floor(this.k))}fract(){return new this.constructor(this.U-Math.floor(this.U),this.V-Math.floor(this.V),this.k-Math.floor(this.k))}length(){return Math.sqrt(this.U*this.U+this.V*this.V+this.k*this.k)}lengthSquared(){return this.U*this.U+this.V*this.V+this.k*this.k}get hasAZeroComponent(){return this.U*this.V*this.k==0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(t){return"xyz"===(t=t.toLowerCase())||(I.Vector3[0].copyFrom(this),["x","y","z"].forEach(((i,e)=>{this[i]=I.Vector3[0][t[e]]}))),this}rotateByQuaternionToRef(t,i){return t.toRotationMatrix(I.Matrix[0]),w.TransformCoordinatesToRef(this,I.Matrix[0],i),i}rotateByQuaternionAroundPointToRef(t,i,e){return this.subtractToRef(i,I.Vector3[0]),I.Vector3[0].rotateByQuaternionToRef(t,I.Vector3[0]),i.addToRef(I.Vector3[0],e),e}cross(t){const i=new this.constructor;return w.CrossToRef(this,t,i)}normalizeFromLength(t){return 0===t||1===t?this:this.scaleInPlace(1/t)}normalizeToNew(){const t=new this.constructor(0,0,0);return this.normalizeToRef(t),t}normalizeToRef(t){const i=this.length();return 0===i||1===i?t.copyFromFloats(this.U,this.V,this.k):this.scaleToRef(1/i,t)}clone(){return new this.constructor(this.U,this.V,this.k)}copyFrom(t){return this.copyFromFloats(t.U,t.V,t.k)}copyFromFloats(t,i,e){return this.x=t,this.y=i,this.z=e,this}set(t,i,e){return this.copyFromFloats(t,i,e)}setAll(t){return this.x=this.y=this.z=t,this}static GetClipFactor(t,i,e,s){const n=w.Dot(t,e)-s;return n/(n-(w.Dot(i,e)-s))}static GetAngleBetweenVectors(t,i,e){const s=t.normalizeToRef(I.Vector3[1]),n=i.normalizeToRef(I.Vector3[2]);let r=w.Dot(s,n);r=o.Clamp(r,-1,1);const h=Math.acos(r),a=I.Vector3[3];return w.CrossToRef(s,n,a),w.Dot(a,e)>0?isNaN(h)?0:h:isNaN(h)?-Math.PI:-Math.acos(r)}static GetAngleBetweenVectorsOnPlane(t,i,e){I.Vector3[0].copyFrom(t);const s=I.Vector3[0];I.Vector3[1].copyFrom(i);const n=I.Vector3[1];I.Vector3[2].copyFrom(e);const r=I.Vector3[2],h=I.Vector3[3],a=I.Vector3[4];s.normalize(),n.normalize(),r.normalize(),w.CrossToRef(r,s,h),w.CrossToRef(h,r,a);const l=Math.atan2(w.Dot(n,h),w.Dot(n,a));return o.NormalizeRadians(l)}static PitchYawRollToMoveBetweenPointsToRef(t,i,e){const s=M.Vector3[0];return i.subtractToRef(t,s),e.y=Math.atan2(s.x,s.z)||0,e.x=Math.atan2(Math.sqrt(s.x**2+s.z**2),s.y)||0,e.z=0,e}static PitchYawRollToMoveBetweenPoints(t,i){const e=w.Zero();return w.PitchYawRollToMoveBetweenPointsToRef(t,i,e)}static SlerpToRef(t,i,e,s){e=o.Clamp(e,0,1);const n=I.Vector3[0],r=I.Vector3[1];n.copyFrom(t);const h=n.length();n.normalizeFromLength(h),r.copyFrom(i);const a=r.length();r.normalizeFromLength(a);const l=w.Dot(n,r);let c,u;if(l<.999){const t=Math.acos(l),i=1/Math.sin(t);c=Math.sin((1-e)*t)*i,u=Math.sin(e*t)*i}else c=1-e,u=e;return n.scaleInPlace(c),r.scaleInPlace(u),s.copyFrom(n).addInPlace(r),s.scaleInPlace(o.Lerp(h,a,e)),s}static SmoothToRef(t,i,e,s,n){return w.SlerpToRef(t,i,0===s?1:e/s,n),n}static FromArray(t,i=0){return new w(t[i],t[i+1],t[i+2])}static FromFloatArray(t,i){return w.FromArray(t,i)}static FromArrayToRef(t,i,e){return e.x=t[i],e.y=t[i+1],e.z=t[i+2],e}static FromFloatArrayToRef(t,i,e){return w.FromArrayToRef(t,i,e)}static FromFloatsToRef(t,i,e,s){return s.copyFromFloats(t,i,e),s}static Zero(){return new w(0,0,0)}static One(){return new w(1,1,1)}static Up(){return new w(0,1,0)}static get UpReadOnly(){return w.G}static get DownReadOnly(){return w.H}static get RightReadOnly(){return w.W}static get LeftReadOnly(){return w.$}static get LeftHandedForwardReadOnly(){return w.j}static get RightHandedForwardReadOnly(){return w.K}static get ZeroReadOnly(){return w.O}static Down(){return new w(0,-1,0)}static Forward(t=!1){return new w(0,0,t?-1:1)}static Backward(t=!1){return new w(0,0,t?1:-1)}static Right(){return new w(1,0,0)}static Left(){return new w(-1,0,0)}static TransformCoordinates(t,i){const e=w.Zero();return w.TransformCoordinatesToRef(t,i,e),e}static TransformCoordinatesToRef(t,i,e){return w.TransformCoordinatesFromFloatsToRef(t.U,t.V,t.k,i,e),e}static TransformCoordinatesFromFloatsToRef(t,i,e,s,n){const r=s.m,h=t*r[0]+i*r[4]+e*r[8]+r[12],o=t*r[1]+i*r[5]+e*r[9]+r[13],a=t*r[2]+i*r[6]+e*r[10]+r[14],l=1/(t*r[3]+i*r[7]+e*r[11]+r[15]);return n.x=h*l,n.y=o*l,n.z=a*l,n}static TransformNormal(t,i){const e=w.Zero();return w.TransformNormalToRef(t,i,e),e}static TransformNormalToRef(t,i,e){return this.TransformNormalFromFloatsToRef(t.U,t.V,t.k,i,e),e}static TransformNormalFromFloatsToRef(t,i,e,s,n){const r=s.m;return n.x=t*r[0]+i*r[4]+e*r[8],n.y=t*r[1]+i*r[5]+e*r[9],n.z=t*r[2]+i*r[6]+e*r[10],n}static CatmullRom(t,i,e,s,n){const r=n*n,h=n*r,o=.5*(2*i.U+(-t.U+e.U)*n+(2*t.U-5*i.U+4*e.U-s.U)*r+(-t.U+3*i.U-3*e.U+s.U)*h),a=.5*(2*i.V+(-t.V+e.V)*n+(2*t.V-5*i.V+4*e.V-s.V)*r+(-t.V+3*i.V-3*e.V+s.V)*h),l=.5*(2*i.k+(-t.k+e.k)*n+(2*t.k-5*i.k+4*e.k-s.k)*r+(-t.k+3*i.k-3*e.k+s.k)*h);return new t.constructor(o,a,l)}static Clamp(t,i,e){const s=new t.constructor;return w.ClampToRef(t,i,e,s),s}static ClampToRef(t,i,e,s){let n=t.U;n=n>e.U?e.U:n,n=n<i.U?i.U:n;let r=t.V;r=r>e.V?e.V:r,r=r<i.V?i.V:r;let h=t.k;return h=h>e.k?e.k:h,h=h<i.k?i.k:h,s.copyFromFloats(n,r,h),s}static CheckExtends(t,i,e){i.minimizeInPlace(t),e.maximizeInPlace(t)}static Hermite(t,i,e,s,n){const r=n*n,h=n*r,o=2*h-3*r+1,a=-2*h+3*r,l=h-2*r+n,c=h-r,u=t.U*o+e.U*a+i.U*l+s.U*c,f=t.V*o+e.V*a+i.V*l+s.V*c,d=t.k*o+e.k*a+i.k*l+s.k*c;return new t.constructor(u,f,d)}static Hermite1stDerivative(t,i,e,s,n){const r=new t.constructor;return this.Hermite1stDerivativeToRef(t,i,e,s,n,r),r}static Hermite1stDerivativeToRef(t,i,e,s,n,r){const h=n*n;return r.x=6*(h-n)*t.x+(3*h-4*n+1)*i.x+6*(-h+n)*e.x+(3*h-2*n)*s.x,r.y=6*(h-n)*t.y+(3*h-4*n+1)*i.y+6*(-h+n)*e.y+(3*h-2*n)*s.y,r.z=6*(h-n)*t.z+(3*h-4*n+1)*i.z+6*(-h+n)*e.z+(3*h-2*n)*s.z,r}static Lerp(t,i,e){const s=new t.constructor(0,0,0);return w.LerpToRef(t,i,e,s),s}static LerpToRef(t,i,e,s){return s.x=t.U+(i.U-t.U)*e,s.y=t.V+(i.V-t.V)*e,s.z=t.k+(i.k-t.k)*e,s}static Dot(t,i){return t.U*i.U+t.V*i.V+t.k*i.k}static Cross(t,i){const e=new t.constructor;return w.CrossToRef(t,i,e),e}static CrossToRef(t,i,e){const s=t.V*i.k-t.k*i.V,n=t.k*i.U-t.U*i.k,r=t.U*i.V-t.V*i.U;return e.copyFromFloats(s,n,r),e}static Normalize(t){const i=w.Zero();return w.NormalizeToRef(t,i),i}static NormalizeToRef(t,i){return t.normalizeToRef(i),i}static Project(t,i,e,s){const n=new t.constructor;return w.ProjectToRef(t,i,e,s,n),n}static ProjectToRef(t,i,e,s,n){const r=s.width,h=s.height,o=s.x,a=s.y,l=I.Matrix[1];R.FromValuesToRef(r/2,0,0,0,0,-h/2,0,0,0,0,.5,0,o+r/2,h/2+a,.5,1,l);const c=I.Matrix[0];return i.multiplyToRef(e,c),c.multiplyToRef(l,c),w.TransformCoordinatesToRef(t,c,n),n}static Reflect(t,i){return this.ReflectToRef(t,i,new w)}static ReflectToRef(t,i,e){const s=M.Vector3[0];return s.copyFrom(i).scaleInPlace(2*w.Dot(t,i)),e.copyFrom(t).subtractInPlace(s)}static J(t,i,e){w.TransformCoordinatesToRef(t,i,e);const s=i.m,n=t.U*s[3]+t.V*s[7]+t.k*s[11]+s[15];return o.WithinEpsilon(n,1)&&e.scaleInPlace(1/n),e}static UnprojectFromTransform(t,i,e,s,n){return this.Unproject(t,i,e,s,n,R.IdentityReadOnly)}static Unproject(t,i,e,s,n,r){const h=new t.constructor;return w.UnprojectToRef(t,i,e,s,n,r,h),h}static UnprojectToRef(t,i,e,s,n,r,h){return w.UnprojectFloatsToRef(t.U,t.V,t.k,i,e,s,n,r,h),h}static UnprojectFloatsToRef(t,i,e,s,n,r,h,o,a){var l;const c=I.Matrix[0];r.multiplyToRef(h,c),c.multiplyToRef(o,c),c.invert();const u=I.Vector3[0];return u.x=t/s*2-1,u.y=-(i/n*2-1),(null===(l=E.LastCreatedEngine)||void 0===l?void 0:l.isNDCHalfZRange)?u.z=e:u.z=2*e-1,w.J(u,c,a),a}static Minimize(t,i){const e=new t.constructor;return e.copyFrom(t),e.minimizeInPlace(i),e}static Maximize(t,i){const e=new t.constructor;return e.copyFrom(t),e.maximizeInPlace(i),e}static Distance(t,i){return Math.sqrt(w.DistanceSquared(t,i))}static DistanceSquared(t,i){const e=t.U-i.U,s=t.V-i.V,n=t.k-i.k;return e*e+s*s+n*n}static ProjectOnTriangleToRef(t,i,e,s,n){const r=I.Vector3[0],h=I.Vector3[1],a=I.Vector3[2],l=I.Vector3[3],c=I.Vector3[4];e.subtractToRef(i,r),s.subtractToRef(i,h),s.subtractToRef(e,a);const f=r.length(),d=h.length(),p=a.length();if(f<u||d<u||p<u)return n.copyFrom(i),w.Distance(t,i);t.subtractToRef(i,c),w.CrossToRef(r,h,l);const m=l.length();if(m<u)return n.copyFrom(i),w.Distance(t,i);l.normalizeFromLength(m);let v=c.length();if(v<u)return n.copyFrom(i),0;c.normalizeFromLength(v);const g=w.Dot(l,c),S=I.Vector3[5],E=I.Vector3[6];S.copyFrom(l).scaleInPlace(-v*g),E.copyFrom(t).addInPlace(S);const A=I.Vector3[4],C=I.Vector3[5],x=I.Vector3[7],T=I.Vector3[8];A.copyFrom(r).scaleInPlace(1/f),T.copyFrom(h).scaleInPlace(1/d),A.addInPlace(T).scaleInPlace(-1),C.copyFrom(r).scaleInPlace(-1/f),T.copyFrom(a).scaleInPlace(1/p),C.addInPlace(T).scaleInPlace(-1),x.copyFrom(a).scaleInPlace(-1/p),T.copyFrom(h).scaleInPlace(-1/d),x.addInPlace(T).scaleInPlace(-1);const R=I.Vector3[9];let M;R.copyFrom(E).subtractInPlace(i),w.CrossToRef(A,R,T),M=w.Dot(T,l);const b=M;R.copyFrom(E).subtractInPlace(e),w.CrossToRef(C,R,T),M=w.Dot(T,l);const _=M;R.copyFrom(E).subtractInPlace(s),w.CrossToRef(x,R,T),M=w.Dot(T,l);const y=M,N=I.Vector3[10];let P,D;b>0&&_<0?(N.copyFrom(r),P=i,D=e):_>0&&y<0?(N.copyFrom(a),P=e,D=s):(N.copyFrom(h).scaleInPlace(-1),P=s,D=i);const L=I.Vector3[9],O=I.Vector3[4];P.subtractToRef(E,T),D.subtractToRef(E,L),w.CrossToRef(T,L,O);if(!(w.Dot(O,l)<0))return n.copyFrom(E),Math.abs(v*g);const F=I.Vector3[5];w.CrossToRef(N,O,F),F.normalize();const B=I.Vector3[9];B.copyFrom(P).subtractInPlace(E);const U=B.length();if(U<u)return n.copyFrom(P),w.Distance(t,P);B.normalizeFromLength(U);const V=w.Dot(F,B),k=I.Vector3[7];k.copyFrom(E).addInPlace(F.scaleInPlace(U*V)),T.copyFrom(k).subtractInPlace(P),v=N.length(),N.normalizeFromLength(v);let G=w.Dot(T,N)/Math.max(v,u);return G=o.Clamp(G,0,1),k.copyFrom(P).addInPlace(N.scaleInPlace(G*v)),n.copyFrom(k),w.Distance(t,k)}static Center(t,i){return w.CenterToRef(t,i,w.Zero())}static CenterToRef(t,i,e){return e.copyFromFloats((t.U+i.U)/2,(t.V+i.V)/2,(t.k+i.k)/2)}static RotationFromAxis(t,i,e){const s=new t.constructor;return w.RotationFromAxisToRef(t,i,e,s),s}static RotationFromAxisToRef(t,i,e,s){const n=I.Quaternion[0];return T.RotationQuaternionFromAxisToRef(t,i,e,n),n.toEulerAnglesToRef(s),s}}w.G=w.Up(),w.H=w.Down(),w.j=w.Forward(!1),w.K=w.Forward(!0),w.W=w.Right(),w.$=w.Left(),w.O=w.Zero();class x{constructor(t=0,i=0,e=0,s=0){this.x=t,this.y=i,this.z=e,this.w=s}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){let t=A(this.x);return t=397*t^A(this.y),t=397*t^A(this.z),t=397*t^A(this.w),t}asArray(){const t=new Array;return this.toArray(t,0),t}toArray(t,i){return void 0===i&&(i=0),t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z,t[i+3]=this.w,this}fromArray(t,i=0){return x.FromArrayToRef(t,i,this),this}addInPlace(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add(t){return new this.constructor(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}addToRef(t,i){return i.x=this.x+t.x,i.y=this.y+t.y,i.z=this.z+t.z,i.w=this.w+t.w,i}subtractInPlace(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subtract(t){return new this.constructor(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}subtractToRef(t,i){return i.x=this.x-t.x,i.y=this.y-t.y,i.z=this.z-t.z,i.w=this.w-t.w,i}subtractFromFloats(t,i,e,s){return new this.constructor(this.x-t,this.y-i,this.z-e,this.w-s)}subtractFromFloatsToRef(t,i,e,s,n){return n.x=this.x-t,n.y=this.y-i,n.z=this.z-e,n.w=this.w-s,n}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(t){return t.copyFromFloats(-1*this.x,-1*this.y,-1*this.z,-1*this.w)}scaleInPlace(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}scale(t){return new this.constructor(this.x*t,this.y*t,this.z*t,this.w*t)}scaleToRef(t,i){return i.x=this.x*t,i.y=this.y*t,i.z=this.z*t,i.w=this.w*t,i}scaleAndAddToRef(t,i){return i.x+=this.x*t,i.y+=this.y*t,i.z+=this.z*t,i.w+=this.w*t,i}equals(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}equalsWithEpsilon(t,i=.001){return t&&o.WithinEpsilon(this.x,t.x,i)&&o.WithinEpsilon(this.y,t.y,i)&&o.WithinEpsilon(this.z,t.z,i)&&o.WithinEpsilon(this.w,t.w,i)}equalsToFloats(t,i,e,s){return this.x===t&&this.y===i&&this.z===e&&this.w===s}multiplyInPlace(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiply(t){return new this.constructor(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)}multiplyToRef(t,i){return i.x=this.x*t.x,i.y=this.y*t.y,i.z=this.z*t.z,i.w=this.w*t.w,i}multiplyByFloats(t,i,e,s){return new this.constructor(this.x*t,this.y*i,this.z*e,this.w*s)}divide(t){return new this.constructor(this.x/t.x,this.y/t.y,this.z/t.z,this.w/t.w)}divideToRef(t,i){return i.x=this.x/t.x,i.y=this.y/t.y,i.z=this.z/t.z,i.w=this.w/t.w,i}divideInPlace(t){return this.divideToRef(t,this)}minimizeInPlace(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this}maximizeInPlace(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){const t=this.length();return 0===t?this:this.scaleInPlace(1/t)}toVector3(){return new w(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}copyFromFloats(t,i,e,s){return this.x=t,this.y=i,this.z=e,this.w=s,this}set(t,i,e,s){return this.copyFromFloats(t,i,e,s)}setAll(t){return this.x=this.y=this.z=this.w=t,this}static FromArray(t,i){return i||(i=0),new x(t[i],t[i+1],t[i+2],t[i+3])}static FromArrayToRef(t,i,e){return e.x=t[i],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}static FromFloatArrayToRef(t,i,e){return x.FromArrayToRef(t,i,e),e}static FromFloatsToRef(t,i,e,s,n){return n.x=t,n.y=i,n.z=e,n.w=s,n}static Zero(){return new x(0,0,0,0)}static One(){return new x(1,1,1,1)}static get ZeroReadOnly(){return x.O}static Normalize(t){const i=x.Zero();return x.NormalizeToRef(t,i),i}static NormalizeToRef(t,i){return i.copyFrom(t),i.normalize(),i}static Minimize(t,i){const e=new t.constructor;return e.copyFrom(t),e.minimizeInPlace(i),e}static Maximize(t,i){const e=new t.constructor;return e.copyFrom(t),e.maximizeInPlace(i),e}static Distance(t,i){return Math.sqrt(x.DistanceSquared(t,i))}static DistanceSquared(t,i){const e=t.x-i.x,s=t.y-i.y,n=t.z-i.z,r=t.w-i.w;return e*e+s*s+n*n+r*r}static Center(t,i){return x.CenterToRef(t,i,x.Zero())}static CenterToRef(t,i,e){return e.copyFromFloats((t.x+i.x)/2,(t.y+i.y)/2,(t.z+i.z)/2,(t.w+i.w)/2)}static TransformCoordinates(t,i){const e=x.Zero();return x.TransformCoordinatesToRef(t,i,e),e}static TransformCoordinatesToRef(t,i,e){return x.TransformCoordinatesFromFloatsToRef(t.U,t.V,t.k,i,e),e}static TransformCoordinatesFromFloatsToRef(t,i,e,s,n){const r=s.m,h=t*r[0]+i*r[4]+e*r[8]+r[12],o=t*r[1]+i*r[5]+e*r[9]+r[13],a=t*r[2]+i*r[6]+e*r[10]+r[14],l=t*r[3]+i*r[7]+e*r[11]+r[15];return n.x=h,n.y=o,n.z=a,n.w=l,n}static TransformNormal(t,i){const e=new t.constructor;return x.TransformNormalToRef(t,i,e),e}static TransformNormalToRef(t,i,e){const s=i.m,n=t.x*s[0]+t.y*s[4]+t.z*s[8],r=t.x*s[1]+t.y*s[5]+t.z*s[9],h=t.x*s[2]+t.y*s[6]+t.z*s[10];return e.x=n,e.y=r,e.z=h,e.w=t.w,e}static TransformNormalFromFloatsToRef(t,i,e,s,n,r){const h=n.m;return r.x=t*h[0]+i*h[4]+e*h[8],r.y=t*h[1]+i*h[5]+e*h[9],r.z=t*h[2]+i*h[6]+e*h[10],r.w=s,r}static FromVector3(t,i=0){return new x(t.U,t.V,t.k,i)}}x.O=x.Zero();class T{constructor(t=0,i=0,e=0,s=1){this.F=!0,this.U=t,this.V=i,this.k=e,this.tt=s}get x(){return this.U}set x(t){this.U=t,this.F=!0}get y(){return this.V}set y(t){this.V=t,this.F=!0}get z(){return this.k}set z(t){this.k=t,this.F=!0}get w(){return this.tt}set w(t){this.tt=t,this.F=!0}toString(){return`{X: ${this.U} Y: ${this.V} Z: ${this.k} W: ${this.tt}}`}getClassName(){return"Quaternion"}getHashCode(){let t=A(this.U);return t=397*t^A(this.V),t=397*t^A(this.k),t=397*t^A(this.tt),t}asArray(){return[this.U,this.V,this.k,this.tt]}toArray(t,i=0){return t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z,t[i+3]=this.w,this}equals(t){return t&&this.U===t.U&&this.V===t.V&&this.k===t.k&&this.tt===t.tt}equalsWithEpsilon(t,i=.001){return t&&o.WithinEpsilon(this.U,t.U,i)&&o.WithinEpsilon(this.V,t.V,i)&&o.WithinEpsilon(this.k,t.k,i)&&o.WithinEpsilon(this.tt,t.tt,i)}clone(){return new this.constructor(this.U,this.V,this.k,this.tt)}copyFrom(t){return this.x=t.U,this.y=t.V,this.z=t.k,this.w=t.tt,this}copyFromFloats(t,i,e,s){return this.x=t,this.y=i,this.z=e,this.w=s,this}set(t,i,e,s){return this.copyFromFloats(t,i,e,s)}add(t){return new this.constructor(this.U+t.U,this.V+t.V,this.k+t.k,this.tt+t.tt)}addInPlace(t){return this.U+=t.U,this.V+=t.V,this.k+=t.k,this.tt+=t.tt,this}subtract(t){return new this.constructor(this.U-t.U,this.V-t.V,this.k-t.k,this.tt-t.tt)}subtractInPlace(t){return this.U-=t.U,this.V-=t.V,this.k-=t.k,this.tt-=t.tt,this}scale(t){return new this.constructor(this.U*t,this.V*t,this.k*t,this.tt*t)}scaleToRef(t,i){return i.x=this.U*t,i.y=this.V*t,i.z=this.k*t,i.w=this.tt*t,i}scaleInPlace(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}scaleAndAddToRef(t,i){return i.x+=this.U*t,i.y+=this.V*t,i.z+=this.k*t,i.w+=this.tt*t,i}multiply(t){const i=new this.constructor(0,0,0,1);return this.multiplyToRef(t,i),i}multiplyToRef(t,i){const e=this.U*t.tt+this.V*t.k-this.k*t.V+this.tt*t.U,s=-this.U*t.k+this.V*t.tt+this.k*t.U+this.tt*t.V,n=this.U*t.V-this.V*t.U+this.k*t.tt+this.tt*t.k,r=-this.U*t.U-this.V*t.V-this.k*t.k+this.tt*t.tt;return i.copyFromFloats(e,s,n,r),i}multiplyInPlace(t){return this.multiplyToRef(t,this),this}conjugateToRef(t){return t.copyFromFloats(-this.U,-this.V,-this.k,this.tt),t}conjugateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this}conjugate(){return new this.constructor(-this.U,-this.V,-this.k,this.tt)}invert(){const t=this.conjugate(),i=this.lengthSquared();return 0==i||1==i||t.scaleInPlace(1/i),t}invertInPlace(){this.conjugateInPlace();const t=this.lengthSquared();return 0==t||1==t||this.scaleInPlace(1/t),this}lengthSquared(){return this.U*this.U+this.V*this.V+this.k*this.k+this.tt*this.tt}length(){return Math.sqrt(this.lengthSquared())}normalize(){const t=this.length();if(0===t)return this;const i=1/t;return this.scaleInPlace(i),this}normalizeToNew(){const t=this.length();if(0===t)return this.clone();const i=1/t;return this.scale(i)}toEulerAngles(){const t=w.Zero();return this.toEulerAnglesToRef(t),t}toEulerAnglesToRef(t){const i=this.k,e=this.U,s=this.V,n=this.tt,r=s*i-e*n,h=.4999999;if(r<-h)t.y=2*Math.atan2(s,n),t.x=Math.PI/2,t.z=0;else if(r>h)t.y=2*Math.atan2(s,n),t.x=-Math.PI/2,t.z=0;else{const h=n*n,o=i*i,a=e*e,l=s*s;t.z=Math.atan2(2*(e*s+i*n),-o-a+l+h),t.x=Math.asin(-2*r),t.y=Math.atan2(2*(i*e+s*n),o-a-l+h)}return t}toRotationMatrix(t){return R.FromQuaternionToRef(this,t),t}fromRotationMatrix(t){return T.FromRotationMatrixToRef(t,this),this}static FromRotationMatrix(t){const i=new T;return T.FromRotationMatrixToRef(t,i),i}static FromRotationMatrixToRef(t,i){const e=t.m,s=e[0],n=e[4],r=e[8],h=e[1],o=e[5],a=e[9],l=e[2],c=e[6],u=e[10],f=s+o+u;let d;return f>0?(d=.5/Math.sqrt(f+1),i.w=.25/d,i.x=(c-a)*d,i.y=(r-l)*d,i.z=(h-n)*d):s>o&&s>u?(d=2*Math.sqrt(1+s-o-u),i.w=(c-a)/d,i.x=.25*d,i.y=(n+h)/d,i.z=(r+l)/d):o>u?(d=2*Math.sqrt(1+o-s-u),i.w=(r-l)/d,i.x=(n+h)/d,i.y=.25*d,i.z=(a+c)/d):(d=2*Math.sqrt(1+u-s-o),i.w=(h-n)/d,i.x=(r+l)/d,i.y=(a+c)/d,i.z=.25*d),i}static Dot(t,i){return t.U*i.U+t.V*i.V+t.k*i.k+t.tt*i.tt}static AreClose(t,i,e=.1){const s=T.Dot(t,i);return 1-s*s<=e}static SmoothToRef(t,i,e,s,n){let r=0===s?1:e/s;return r=o.Clamp(r,0,1),T.SlerpToRef(t,i,r,n),n}static Zero(){return new T(0,0,0,0)}static Inverse(t){return new t.constructor(-t.U,-t.V,-t.k,t.tt)}static InverseToRef(t,i){return i.set(-t.U,-t.V,-t.k,t.tt),i}static Identity(){return new T(0,0,0,1)}static IsIdentity(t){return t&&0===t.U&&0===t.V&&0===t.k&&1===t.tt}static RotationAxis(t,i){return T.RotationAxisToRef(t,i,new T)}static RotationAxisToRef(t,i,e){const s=Math.sin(i/2);return t.normalize(),e.w=Math.cos(i/2),e.x=t.U*s,e.y=t.V*s,e.z=t.k*s,e}static FromArray(t,i){return i||(i=0),new T(t[i],t[i+1],t[i+2],t[i+3])}static FromArrayToRef(t,i,e){return e.x=t[i],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}static FromEulerAngles(t,i,e){const s=new T;return T.RotationYawPitchRollToRef(i,t,e,s),s}static FromEulerAnglesToRef(t,i,e,s){return T.RotationYawPitchRollToRef(i,t,e,s),s}static FromEulerVector(t){const i=new T;return T.RotationYawPitchRollToRef(t.V,t.U,t.k,i),i}static FromEulerVectorToRef(t,i){return T.RotationYawPitchRollToRef(t.V,t.U,t.k,i),i}static FromUnitVectorsToRef(t,i,e){const s=w.Dot(t,i)+1;return s<u?Math.abs(t.x)>Math.abs(t.z)?e.set(-t.y,t.x,0,0):e.set(0,-t.z,t.y,0):(w.CrossToRef(t,i,M.Vector3[0]),e.set(M.Vector3[0].x,M.Vector3[0].y,M.Vector3[0].z,s)),e.normalize()}static RotationYawPitchRoll(t,i,e){const s=new T;return T.RotationYawPitchRollToRef(t,i,e,s),s}static RotationYawPitchRollToRef(t,i,e,s){const n=.5*e,r=.5*i,h=.5*t,o=Math.sin(n),a=Math.cos(n),l=Math.sin(r),c=Math.cos(r),u=Math.sin(h),f=Math.cos(h);return s.x=f*l*a+u*c*o,s.y=u*c*a-f*l*o,s.z=f*c*o-u*l*a,s.w=f*c*a+u*l*o,s}static RotationAlphaBetaGamma(t,i,e){const s=new T;return T.RotationAlphaBetaGammaToRef(t,i,e,s),s}static RotationAlphaBetaGammaToRef(t,i,e,s){const n=.5*(e+t),r=.5*(e-t),h=.5*i;return s.x=Math.cos(r)*Math.sin(h),s.y=Math.sin(r)*Math.sin(h),s.z=Math.sin(n)*Math.cos(h),s.w=Math.cos(n)*Math.cos(h),s}static RotationQuaternionFromAxis(t,i,e){const s=new T(0,0,0,0);return T.RotationQuaternionFromAxisToRef(t,i,e,s),s}static RotationQuaternionFromAxisToRef(t,i,e,s){const n=I.Matrix[0];return R.FromXYZAxesToRef(t.normalize(),i.normalize(),e.normalize(),n),T.FromRotationMatrixToRef(n,s),s}static FromLookDirectionLH(t,i){const e=new T;return T.FromLookDirectionLHToRef(t,i,e),e}static FromLookDirectionLHToRef(t,i,e){const s=I.Matrix[0];return R.LookDirectionLHToRef(t,i,s),T.FromRotationMatrixToRef(s,e),e}static FromLookDirectionRH(t,i){const e=new T;return T.FromLookDirectionRHToRef(t,i,e),e}static FromLookDirectionRHToRef(t,i,e){const s=I.Matrix[0];return R.LookDirectionRHToRef(t,i,s),T.FromRotationMatrixToRef(s,e)}static Slerp(t,i,e){const s=T.Identity();return T.SlerpToRef(t,i,e,s),s}static SlerpToRef(t,i,e,s){let n,r,h=t.U*i.U+t.V*i.V+t.k*i.k+t.tt*i.tt,o=!1;if(h<0&&(o=!0,h=-h),h>.999999)r=1-e,n=o?-e:e;else{const t=Math.acos(h),i=1/Math.sin(t);r=Math.sin((1-e)*t)*i,n=o?-Math.sin(e*t)*i:Math.sin(e*t)*i}return s.x=r*t.U+n*i.U,s.y=r*t.V+n*i.V,s.z=r*t.k+n*i.k,s.w=r*t.tt+n*i.tt,s}static Hermite(t,i,e,s,n){const r=n*n,h=n*r,o=2*h-3*r+1,a=-2*h+3*r,l=h-2*r+n,c=h-r,u=t.U*o+e.U*a+i.U*l+s.U*c,f=t.V*o+e.V*a+i.V*l+s.V*c,d=t.k*o+e.k*a+i.k*l+s.k*c,p=t.tt*o+e.tt*a+i.tt*l+s.tt*c;return new t.constructor(u,f,d,p)}static Hermite1stDerivative(t,i,e,s,n){const r=new t.constructor;return this.Hermite1stDerivativeToRef(t,i,e,s,n,r),r}static Hermite1stDerivativeToRef(t,i,e,s,n,r){const h=n*n;return r.x=6*(h-n)*t.x+(3*h-4*n+1)*i.x+6*(-h+n)*e.x+(3*h-2*n)*s.x,r.y=6*(h-n)*t.y+(3*h-4*n+1)*i.y+6*(-h+n)*e.y+(3*h-2*n)*s.y,r.z=6*(h-n)*t.z+(3*h-4*n+1)*i.z+6*(-h+n)*e.z+(3*h-2*n)*s.z,r.w=6*(h-n)*t.w+(3*h-4*n+1)*i.w+6*(-h+n)*e.w+(3*h-2*n)*s.w,r}}class R{constructor(){this.it=!1,this.et=!0,this.st=!0,this.nt=!0,this.updateFlag=-1,S.MatrixTrackPrecisionChange&&S.MatrixTrackedMatrices.push(this),this.P=new S.MatrixCurrentType(16),this.markAsUpdated()}static get Use64Bits(){return S.MatrixUse64Bits}get m(){return this.P}markAsUpdated(){this.updateFlag=R.rt++,this.it=!1,this.st=!1,this.et=!0,this.nt=!0}ht(t,i=!1,e=!1,s=!0){this.it=t,this.st=t||e,this.et=!this.it&&i,this.nt=!this.st&&s}isIdentity(){if(this.et){this.et=!1;const t=this.P;this.it=1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]}return this.it}isIdentityAs3x2(){return this.nt&&(this.nt=!1,1!==this.P[0]||1!==this.P[5]||1!==this.P[15]||0!==this.P[1]||0!==this.P[2]||0!==this.P[3]||0!==this.P[4]||0!==this.P[6]||0!==this.P[7]||0!==this.P[8]||0!==this.P[9]||0!==this.P[10]||0!==this.P[11]||0!==this.P[12]||0!==this.P[13]||0!==this.P[14]?this.st=!1:this.st=!0),this.st}determinant(){if(!0===this.it)return 1;const t=this.P,i=t[0],e=t[1],s=t[2],n=t[3],r=t[4],h=t[5],o=t[6],a=t[7],l=t[8],c=t[9],u=t[10],f=t[11],d=t[12],p=t[13],m=t[14],v=t[15],g=u*v-m*f,S=c*v-p*f,E=c*m-p*u,A=l*v-d*f,C=l*m-u*d,w=l*p-d*c;return i*+(h*g-o*S+a*E)+e*-(r*g-o*A+a*C)+s*+(r*S-h*A+a*w)+n*-(r*E-h*C+o*w)}toArray(){return this.P}asArray(){return this.P}invert(){return this.invertToRef(this),this}reset(){return R.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this.ht(!1),this}add(t){const i=new this.constructor;return this.addToRef(t,i),i}addToRef(t,i){const e=this.P,s=i.P,n=t.m;for(let t=0;t<16;t++)s[t]=e[t]+n[t];return i.markAsUpdated(),i}addToSelf(t){const i=this.P,e=t.m;for(let t=0;t<16;t++)i[t]+=e[t];return this.markAsUpdated(),this}invertToRef(t){if(!0===this.it)return R.IdentityToRef(t),t;const i=this.P,e=i[0],s=i[1],n=i[2],r=i[3],h=i[4],o=i[5],a=i[6],l=i[7],c=i[8],u=i[9],f=i[10],d=i[11],p=i[12],m=i[13],v=i[14],g=i[15],S=f*g-v*d,E=u*g-m*d,A=u*v-m*f,C=c*g-p*d,w=c*v-f*p,x=c*m-p*u,T=+(o*S-a*E+l*A),I=-(h*S-a*C+l*w),M=+(h*E-o*C+l*x),b=-(h*A-o*w+a*x),_=e*T+s*I+n*M+r*b;if(0===_)return t.copyFrom(this),t;const y=1/_,N=a*g-v*l,P=o*g-m*l,D=o*v-m*a,L=h*g-p*l,O=h*v-p*a,F=h*m-p*o,B=a*d-f*l,U=o*d-u*l,V=o*f-u*a,k=h*d-c*l,G=h*f-c*a,z=h*u-c*o,H=-(s*S-n*E+r*A),X=+(e*S-n*C+r*w),W=-(e*E-s*C+r*x),$=+(e*A-s*w+n*x),Y=+(s*N-n*P+r*D),j=-(e*N-n*L+r*O),K=+(e*P-s*L+r*F),q=-(e*D-s*O+n*F),Q=-(s*B-n*U+r*V),Z=+(e*B-n*k+r*G),J=-(e*U-s*k+r*z),tt=+(e*V-s*G+n*z);return R.FromValuesToRef(T*y,H*y,Y*y,Q*y,I*y,X*y,j*y,Z*y,M*y,W*y,K*y,J*y,b*y,$*y,q*y,tt*y,t),t}addAtIndex(t,i){return this.P[t]+=i,this.markAsUpdated(),this}multiplyAtIndex(t,i){return this.P[t]*=i,this.markAsUpdated(),this}setTranslationFromFloats(t,i,e){return this.P[12]=t,this.P[13]=i,this.P[14]=e,this.markAsUpdated(),this}addTranslationFromFloats(t,i,e){return this.P[12]+=t,this.P[13]+=i,this.P[14]+=e,this.markAsUpdated(),this}setTranslation(t){return this.setTranslationFromFloats(t.U,t.V,t.k)}getTranslation(){return new w(this.P[12],this.P[13],this.P[14])}getTranslationToRef(t){return t.x=this.P[12],t.y=this.P[13],t.z=this.P[14],t}removeRotationAndScaling(){const t=this.m;return R.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t[12],t[13],t[14],t[15],this),this.ht(0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]),this}multiply(t){const i=new this.constructor;return this.multiplyToRef(t,i),i}copyFrom(t){t.copyToArray(this.P);const i=t;return this.updateFlag=i.updateFlag,this.ht(i.it,i.et,i.st,i.nt),this}copyToArray(t,i=0){const e=this.P;return t[i]=e[0],t[i+1]=e[1],t[i+2]=e[2],t[i+3]=e[3],t[i+4]=e[4],t[i+5]=e[5],t[i+6]=e[6],t[i+7]=e[7],t[i+8]=e[8],t[i+9]=e[9],t[i+10]=e[10],t[i+11]=e[11],t[i+12]=e[12],t[i+13]=e[13],t[i+14]=e[14],t[i+15]=e[15],this}multiplyToRef(t,i){return this.it?(i.copyFrom(t),i):t.it?(i.copyFrom(this),i):(this.multiplyToArray(t,i.P,0),i.markAsUpdated(),i)}multiplyToArray(t,i,e){const s=this.P,n=t.m,r=s[0],h=s[1],o=s[2],a=s[3],l=s[4],c=s[5],u=s[6],f=s[7],d=s[8],p=s[9],m=s[10],v=s[11],g=s[12],S=s[13],E=s[14],A=s[15],C=n[0],w=n[1],x=n[2],T=n[3],R=n[4],I=n[5],M=n[6],b=n[7],_=n[8],y=n[9],N=n[10],P=n[11],D=n[12],L=n[13],O=n[14],F=n[15];return i[e]=r*C+h*R+o*_+a*D,i[e+1]=r*w+h*I+o*y+a*L,i[e+2]=r*x+h*M+o*N+a*O,i[e+3]=r*T+h*b+o*P+a*F,i[e+4]=l*C+c*R+u*_+f*D,i[e+5]=l*w+c*I+u*y+f*L,i[e+6]=l*x+c*M+u*N+f*O,i[e+7]=l*T+c*b+u*P+f*F,i[e+8]=d*C+p*R+m*_+v*D,i[e+9]=d*w+p*I+m*y+v*L,i[e+10]=d*x+p*M+m*N+v*O,i[e+11]=d*T+p*b+m*P+v*F,i[e+12]=g*C+S*R+E*_+A*D,i[e+13]=g*w+S*I+E*y+A*L,i[e+14]=g*x+S*M+E*N+A*O,i[e+15]=g*T+S*b+E*P+A*F,this}equals(t){const i=t;if(!i)return!1;if((this.it||i.it)&&!this.et&&!i.et)return this.it&&i.it;const e=this.m,s=i.m;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]&&e[9]===s[9]&&e[10]===s[10]&&e[11]===s[11]&&e[12]===s[12]&&e[13]===s[13]&&e[14]===s[14]&&e[15]===s[15]}clone(){const t=new this.constructor;return t.copyFrom(this),t}getClassName(){return"Matrix"}getHashCode(){let t=A(this.P[0]);for(let i=1;i<16;i++)t=397*t^A(this.P[i]);return t}decomposeToTransformNode(t){return t.rotationQuaternion=t.rotationQuaternion||new T,this.decompose(t.scaling,t.rotationQuaternion,t.position)}decompose(t,i,e,s){if(this.it)return e&&e.setAll(0),t&&t.setAll(1),i&&i.copyFromFloats(0,0,0,1),!0;const n=this.P;if(e&&e.copyFromFloats(n[12],n[13],n[14]),(t=t||I.Vector3[0]).x=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),t.y=Math.sqrt(n[4]*n[4]+n[5]*n[5]+n[6]*n[6]),t.z=Math.sqrt(n[8]*n[8]+n[9]*n[9]+n[10]*n[10]),s){const i=s.scaling.x<0?-1:1,e=s.scaling.y<0?-1:1,n=s.scaling.z<0?-1:1;t.x*=i,t.y*=e,t.z*=n}else this.determinant()<=0&&(t.y*=-1);if(0===t.U||0===t.V||0===t.k)return i&&i.copyFromFloats(0,0,0,1),!1;if(i){const e=1/t.U,s=1/t.V,r=1/t.k;R.FromValuesToRef(n[0]*e,n[1]*e,n[2]*e,0,n[4]*s,n[5]*s,n[6]*s,0,n[8]*r,n[9]*r,n[10]*r,0,0,0,0,1,I.Matrix[0]),T.FromRotationMatrixToRef(I.Matrix[0],i)}return!0}getRow(t){if(t<0||t>3)return null;const i=4*t;return new x(this.P[i+0],this.P[i+1],this.P[i+2],this.P[i+3])}getRowToRef(t,i){if(t>=0&&t<3){const e=4*t;i.x=this.P[e+0],i.y=this.P[e+1],i.z=this.P[e+2],i.w=this.P[e+3]}return i}setRow(t,i){return this.setRowFromFloats(t,i.x,i.y,i.z,i.w)}transpose(){const t=new this.constructor;return R.TransposeToRef(this,t),t}transposeToRef(t){return R.TransposeToRef(this,t),t}setRowFromFloats(t,i,e,s,n){if(t<0||t>3)return this;const r=4*t;return this.P[r+0]=i,this.P[r+1]=e,this.P[r+2]=s,this.P[r+3]=n,this.markAsUpdated(),this}scale(t){const i=new this.constructor;return this.scaleToRef(t,i),i}scaleToRef(t,i){for(let e=0;e<16;e++)i.P[e]=this.P[e]*t;return i.markAsUpdated(),i}scaleAndAddToRef(t,i){for(let e=0;e<16;e++)i.P[e]+=this.P[e]*t;return i.markAsUpdated(),i}toNormalMatrix(t){const i=I.Matrix[0];this.invertToRef(i),i.transposeToRef(t);const e=t.P;return R.FromValuesToRef(e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,0,0,0,1,t),t}getRotationMatrix(){const t=new this.constructor;return this.getRotationMatrixToRef(t),t}getRotationMatrixToRef(t){const i=I.Vector3[0];if(!this.decompose(i))return R.IdentityToRef(t),t;const e=this.P,s=1/i.U,n=1/i.V,r=1/i.k;return R.FromValuesToRef(e[0]*s,e[1]*s,e[2]*s,0,e[4]*n,e[5]*n,e[6]*n,0,e[8]*r,e[9]*r,e[10]*r,0,0,0,0,1,t),t}toggleModelMatrixHandInPlace(){const t=this.P;return t[2]*=-1,t[6]*=-1,t[8]*=-1,t[9]*=-1,t[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const t=this.P;return t[8]*=-1,t[9]*=-1,t[10]*=-1,t[11]*=-1,this.markAsUpdated(),this}static FromArray(t,i=0){const e=new R;return R.FromArrayToRef(t,i,e),e}static FromArrayToRef(t,i,e){for(let s=0;s<16;s++)e.P[s]=t[s+i];return e.markAsUpdated(),e}static FromFloat32ArrayToRefScaled(t,i,e,s){for(let n=0;n<16;n++)s.P[n]=t[n+i]*e;return s.markAsUpdated(),s}static get IdentityReadOnly(){return R.ot}static FromValuesToRef(t,i,e,s,n,r,h,o,a,l,c,u,f,d,p,m,v){const g=v.P;g[0]=t,g[1]=i,g[2]=e,g[3]=s,g[4]=n,g[5]=r,g[6]=h,g[7]=o,g[8]=a,g[9]=l,g[10]=c,g[11]=u,g[12]=f,g[13]=d,g[14]=p,g[15]=m,v.markAsUpdated()}static FromValues(t,i,e,s,n,r,h,o,a,l,c,u,f,d,p,m){const v=new R,g=v.P;return g[0]=t,g[1]=i,g[2]=e,g[3]=s,g[4]=n,g[5]=r,g[6]=h,g[7]=o,g[8]=a,g[9]=l,g[10]=c,g[11]=u,g[12]=f,g[13]=d,g[14]=p,g[15]=m,v.markAsUpdated(),v}static Compose(t,i,e){const s=new R;return R.ComposeToRef(t,i,e,s),s}static ComposeToRef(t,i,e,s){const n=s.P,r=i.U,h=i.V,o=i.k,a=i.tt,l=r+r,c=h+h,u=o+o,f=r*l,d=r*c,p=r*u,m=h*c,v=h*u,g=o*u,S=a*l,E=a*c,A=a*u,C=t.U,w=t.V,x=t.k;return n[0]=(1-(m+g))*C,n[1]=(d+A)*C,n[2]=(p-E)*C,n[3]=0,n[4]=(d-A)*w,n[5]=(1-(f+g))*w,n[6]=(v+S)*w,n[7]=0,n[8]=(p+E)*x,n[9]=(v-S)*x,n[10]=(1-(f+m))*x,n[11]=0,n[12]=e.U,n[13]=e.V,n[14]=e.k,n[15]=1,s.markAsUpdated(),s}static Identity(){const t=R.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return t.ht(!0),t}static IdentityToRef(t){return R.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,t),t.ht(!0),t}static Zero(){const t=R.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return t.ht(!1),t}static RotationX(t){const i=new R;return R.RotationXToRef(t,i),i}static Invert(t){const i=new t.constructor;return t.invertToRef(i),i}static RotationXToRef(t,i){const e=Math.sin(t),s=Math.cos(t);return R.FromValuesToRef(1,0,0,0,0,s,e,0,0,-e,s,0,0,0,0,1,i),i.ht(1===s&&0===e),i}static RotationY(t){const i=new R;return R.RotationYToRef(t,i),i}static RotationYToRef(t,i){const e=Math.sin(t),s=Math.cos(t);return R.FromValuesToRef(s,0,-e,0,0,1,0,0,e,0,s,0,0,0,0,1,i),i.ht(1===s&&0===e),i}static RotationZ(t){const i=new R;return R.RotationZToRef(t,i),i}static RotationZToRef(t,i){const e=Math.sin(t),s=Math.cos(t);return R.FromValuesToRef(s,e,0,0,-e,s,0,0,0,0,1,0,0,0,0,1,i),i.ht(1===s&&0===e),i}static RotationAxis(t,i){const e=new R;return R.RotationAxisToRef(t,i,e),e}static RotationAxisToRef(t,i,e){const s=Math.sin(-i),n=Math.cos(-i),r=1-n;t.normalize();const h=e.P;return h[0]=t.U*t.U*r+n,h[1]=t.U*t.V*r-t.k*s,h[2]=t.U*t.k*r+t.V*s,h[3]=0,h[4]=t.V*t.U*r+t.k*s,h[5]=t.V*t.V*r+n,h[6]=t.V*t.k*r-t.U*s,h[7]=0,h[8]=t.k*t.U*r-t.V*s,h[9]=t.k*t.V*r+t.U*s,h[10]=t.k*t.k*r+n,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,e.markAsUpdated(),e}static RotationAlignToRef(t,i,e){const s=w.Dot(i,t),n=e.P;if(s<-.999)n[0]=-1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0;else{const e=w.Cross(i,t),r=1/(1+s);n[0]=e.U*e.U*r+s,n[1]=e.V*e.U*r-e.k,n[2]=e.k*e.U*r+e.V,n[3]=0,n[4]=e.U*e.V*r+e.k,n[5]=e.V*e.V*r+s,n[6]=e.k*e.V*r-e.U,n[7]=0,n[8]=e.U*e.k*r-e.V,n[9]=e.V*e.k*r+e.U,n[10]=e.k*e.k*r+s,n[11]=0}return n[12]=0,n[13]=0,n[14]=0,n[15]=1,e.markAsUpdated(),e}static RotationYawPitchRoll(t,i,e){const s=new R;return R.RotationYawPitchRollToRef(t,i,e,s),s}static RotationYawPitchRollToRef(t,i,e,s){return T.RotationYawPitchRollToRef(t,i,e,I.Quaternion[0]),I.Quaternion[0].toRotationMatrix(s),s}static Scaling(t,i,e){const s=new R;return R.ScalingToRef(t,i,e,s),s}static ScalingToRef(t,i,e,s){return R.FromValuesToRef(t,0,0,0,0,i,0,0,0,0,e,0,0,0,0,1,s),s.ht(1===t&&1===i&&1===e),s}static Translation(t,i,e){const s=new R;return R.TranslationToRef(t,i,e,s),s}static TranslationToRef(t,i,e,s){return R.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t,i,e,1,s),s.ht(0===t&&0===i&&0===e),s}static Lerp(t,i,e){const s=new t.constructor;return R.LerpToRef(t,i,e,s),s}static LerpToRef(t,i,e,s){const n=s.P,r=t.m,h=i.m;for(let t=0;t<16;t++)n[t]=r[t]*(1-e)+h[t]*e;return s.markAsUpdated(),s}static DecomposeLerp(t,i,e){const s=new t.constructor;return R.DecomposeLerpToRef(t,i,e,s),s}static DecomposeLerpToRef(t,i,e,s){const n=I.Vector3[0],r=I.Quaternion[0],h=I.Vector3[1];t.decompose(n,r,h);const o=I.Vector3[2],a=I.Quaternion[1],l=I.Vector3[3];i.decompose(o,a,l);const c=I.Vector3[4];w.LerpToRef(n,o,e,c);const u=I.Quaternion[2];T.SlerpToRef(r,a,e,u);const f=I.Vector3[5];return w.LerpToRef(h,l,e,f),R.ComposeToRef(c,u,f,s),s}static LookAtLH(t,i,e){const s=new R;return R.LookAtLHToRef(t,i,e,s),s}static LookAtLHToRef(t,i,e,s){const n=I.Vector3[0],r=I.Vector3[1],h=I.Vector3[2];i.subtractToRef(t,h),h.normalize(),w.CrossToRef(e,h,n);const o=n.lengthSquared();0===o?n.x=1:n.normalizeFromLength(Math.sqrt(o)),w.CrossToRef(h,n,r),r.normalize();const a=-w.Dot(n,t),l=-w.Dot(r,t),c=-w.Dot(h,t);R.FromValuesToRef(n.U,r.U,h.U,0,n.V,r.V,h.V,0,n.k,r.k,h.k,0,a,l,c,1,s)}static LookAtRH(t,i,e){const s=new R;return R.LookAtRHToRef(t,i,e,s),s}static LookAtRHToRef(t,i,e,s){const n=I.Vector3[0],r=I.Vector3[1],h=I.Vector3[2];t.subtractToRef(i,h),h.normalize(),w.CrossToRef(e,h,n);const o=n.lengthSquared();0===o?n.x=1:n.normalizeFromLength(Math.sqrt(o)),w.CrossToRef(h,n,r),r.normalize();const a=-w.Dot(n,t),l=-w.Dot(r,t),c=-w.Dot(h,t);return R.FromValuesToRef(n.U,r.U,h.U,0,n.V,r.V,h.V,0,n.k,r.k,h.k,0,a,l,c,1,s),s}static LookDirectionLH(t,i){const e=new R;return R.LookDirectionLHToRef(t,i,e),e}static LookDirectionLHToRef(t,i,e){const s=I.Vector3[0];s.copyFrom(t),s.scaleInPlace(-1);const n=I.Vector3[1];return w.CrossToRef(i,s,n),R.FromValuesToRef(n.U,n.V,n.k,0,i.U,i.V,i.k,0,s.U,s.V,s.k,0,0,0,0,1,e),e}static LookDirectionRH(t,i){const e=new R;return R.LookDirectionRHToRef(t,i,e),e}static LookDirectionRHToRef(t,i,e){const s=I.Vector3[2];return w.CrossToRef(i,t,s),R.FromValuesToRef(s.U,s.V,s.k,0,i.U,i.V,i.k,0,t.U,t.V,t.k,0,0,0,0,1,e),e}static OrthoLH(t,i,e,s,n){const r=new R;return R.OrthoLHToRef(t,i,e,s,r,n),r}static OrthoLHToRef(t,i,e,s,n,r){const h=2/t,o=2/i,a=2/(s-e),l=-(s+e)/(s-e);return R.FromValuesToRef(h,0,0,0,0,o,0,0,0,0,a,0,0,0,l,1,n),r&&n.multiplyToRef(b,n),n.ht(1===h&&1===o&&1===a&&0===l),n}static OrthoOffCenterLH(t,i,e,s,n,r,h){const o=new R;return R.OrthoOffCenterLHToRef(t,i,e,s,n,r,o,h),o}static OrthoOffCenterLHToRef(t,i,e,s,n,r,h,o){const a=2/(i-t),l=2/(s-e),c=2/(r-n),u=-(r+n)/(r-n),f=(t+i)/(t-i),d=(s+e)/(e-s);return R.FromValuesToRef(a,0,0,0,0,l,0,0,0,0,c,0,f,d,u,1,h),o&&h.multiplyToRef(b,h),h.markAsUpdated(),h}static OrthoOffCenterRH(t,i,e,s,n,r,h){const o=new R;return R.OrthoOffCenterRHToRef(t,i,e,s,n,r,o,h),o}static OrthoOffCenterRHToRef(t,i,e,s,n,r,h,o){return R.OrthoOffCenterLHToRef(t,i,e,s,n,r,h,o),h.P[10]*=-1,h}static PerspectiveLH(t,i,e,s,n,r=0){const h=new R,o=2*e/t,a=2*e/i,l=(s+e)/(s-e),c=-2*s*e/(s-e),u=Math.tan(r);return R.FromValuesToRef(o,0,0,0,0,a,0,u,0,0,l,1,0,0,c,0,h),n&&h.multiplyToRef(b,h),h.ht(!1),h}static PerspectiveFovLH(t,i,e,s,n,r=0,h=!1){const o=new R;return R.PerspectiveFovLHToRef(t,i,e,s,o,!0,n,r,h),o}static PerspectiveFovLHToRef(t,i,e,s,n,r=!0,h,o=0,a=!1){const l=e,c=s,u=1/Math.tan(.5*t),f=r?u/i:u,d=r?u:u*i,p=a&&0===l?-1:0!==c?(c+l)/(c-l):1,m=a&&0===l?2*c:0!==c?-2*c*l/(c-l):-2*l,v=Math.tan(o);return R.FromValuesToRef(f,0,0,0,0,d,0,v,0,0,p,1,0,0,m,0,n),h&&n.multiplyToRef(b,n),n.ht(!1),n}static PerspectiveFovReverseLHToRef(t,i,e,s,n,r=!0,h,o=0){const a=1/Math.tan(.5*t),l=r?a/i:a,c=r?a:a*i,u=Math.tan(o);return R.FromValuesToRef(l,0,0,0,0,c,0,u,0,0,-e,1,0,0,1,0,n),h&&n.multiplyToRef(b,n),n.ht(!1),n}static PerspectiveFovRH(t,i,e,s,n,r=0,h=!1){const o=new R;return R.PerspectiveFovRHToRef(t,i,e,s,o,!0,n,r,h),o}static PerspectiveFovRHToRef(t,i,e,s,n,r=!0,h,o=0,a=!1){const l=e,c=s,u=1/Math.tan(.5*t),f=r?u/i:u,d=r?u:u*i,p=a&&0===l?1:0!==c?-(c+l)/(c-l):-1,m=a&&0===l?2*c:0!==c?-2*c*l/(c-l):-2*l,v=Math.tan(o);return R.FromValuesToRef(f,0,0,0,0,d,0,v,0,0,p,-1,0,0,m,0,n),h&&n.multiplyToRef(b,n),n.ht(!1),n}static PerspectiveFovReverseRHToRef(t,i,e,s,n,r=!0,h,o=0){const a=1/Math.tan(.5*t),l=r?a/i:a,c=r?a:a*i,u=Math.tan(o);return R.FromValuesToRef(l,0,0,0,0,c,0,u,0,0,-e,-1,0,0,-1,0,n),h&&n.multiplyToRef(b,n),n.ht(!1),n}static PerspectiveFovWebVRToRef(t,i,e,s,n=!1,r,h=0){const o=n?-1:1,a=Math.tan(t.upDegrees*Math.PI/180),l=Math.tan(t.downDegrees*Math.PI/180),c=Math.tan(t.leftDegrees*Math.PI/180),u=Math.tan(t.rightDegrees*Math.PI/180),f=2/(c+u),d=2/(a+l),p=Math.tan(h),m=s.P;return m[0]=f,m[1]=m[2]=m[3]=m[4]=0,m[5]=d,m[6]=0,m[7]=p,m[8]=(c-u)*f*.5,m[9]=-(a-l)*d*.5,m[10]=-e/(i-e),m[11]=1*o,m[12]=m[13]=m[15]=0,m[14]=-2*e*i/(e-i),r&&s.multiplyToRef(b,s),s.markAsUpdated(),s}static GetFinalMatrix(t,i,e,s,n,r){const h=t.width,o=t.height,a=t.x,l=t.y,c=R.FromValues(h/2,0,0,0,0,-o/2,0,0,0,0,r-n,0,a+h/2,o/2+l,n,1),u=new i.constructor;return i.multiplyToRef(e,u),u.multiplyToRef(s,u),u.multiplyToRef(c,u)}static GetAsMatrix2x2(t){const i=t.m,e=[i[0],i[1],i[4],i[5]];return S.MatrixUse64Bits?e:new Float32Array(e)}static GetAsMatrix3x3(t){const i=t.m,e=[i[0],i[1],i[2],i[4],i[5],i[6],i[8],i[9],i[10]];return S.MatrixUse64Bits?e:new Float32Array(e)}static Transpose(t){const i=new t.constructor;return R.TransposeToRef(t,i),i}static TransposeToRef(t,i){const e=i.P,s=t.m;return e[0]=s[0],e[1]=s[4],e[2]=s[8],e[3]=s[12],e[4]=s[1],e[5]=s[5],e[6]=s[9],e[7]=s[13],e[8]=s[2],e[9]=s[6],e[10]=s[10],e[11]=s[14],e[12]=s[3],e[13]=s[7],e[14]=s[11],e[15]=s[15],i.markAsUpdated(),i.ht(t.it,t.et),i}static Reflection(t){const i=new R;return R.ReflectionToRef(t,i),i}static ReflectionToRef(t,i){t.normalize();const e=t.normal.x,s=t.normal.y,n=t.normal.z,r=-2*e,h=-2*s,o=-2*n;return R.FromValuesToRef(r*e+1,h*e,o*e,0,r*s,h*s+1,o*s,0,r*n,h*n,o*n+1,0,r*t.d,h*t.d,o*t.d,1,i),i}static FromXYZAxesToRef(t,i,e,s){return R.FromValuesToRef(t.U,t.V,t.k,0,i.U,i.V,i.k,0,e.U,e.V,e.k,0,0,0,0,1,s),s}static FromQuaternionToRef(t,i){const e=t.U*t.U,s=t.V*t.V,n=t.k*t.k,r=t.U*t.V,h=t.k*t.tt,o=t.k*t.U,a=t.V*t.tt,l=t.V*t.k,c=t.U*t.tt;return i.P[0]=1-2*(s+n),i.P[1]=2*(r+h),i.P[2]=2*(o-a),i.P[3]=0,i.P[4]=2*(r-h),i.P[5]=1-2*(n+e),i.P[6]=2*(l+c),i.P[7]=0,i.P[8]=2*(o+a),i.P[9]=2*(l-c),i.P[10]=1-2*(s+e),i.P[11]=0,i.P[12]=0,i.P[13]=0,i.P[14]=0,i.P[15]=1,i.markAsUpdated(),i}}R.rt=0,R.ot=R.Identity();class I{}I.Vector3=f.BuildTuple(11,w.Zero),I.Matrix=f.BuildTuple(2,R.Identity),I.Quaternion=f.BuildTuple(3,T.Zero);class M{}M.Vector2=f.BuildTuple(3,C.Zero),M.Vector3=f.BuildTuple(13,w.Zero),M.Vector4=f.BuildTuple(3,x.Zero),M.Quaternion=f.BuildTuple(2,T.Zero),M.Matrix=f.BuildTuple(8,R.Identity),v("BABYLON.Vector2",C),v("BABYLON.Vector3",w),v("BABYLON.Vector4",x),v("BABYLON.Matrix",R);const b=R.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);class _{constructor(t=0,i=0,e=0){this.r=t,this.g=i,this.b=e}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let t=255*this.r|0;return t=397*t^(255*this.g|0),t=397*t^(255*this.b|0),t}toArray(t,i=0){return t[i]=this.r,t[i+1]=this.g,t[i+2]=this.b,this}fromArray(t,i=0){return _.FromArrayToRef(t,i,this),this}toColor4(t=1){return new y(this.r,this.g,this.b,t)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return.3*this.r+.59*this.g+.11*this.b}multiply(t){return new _(this.r*t.r,this.g*t.g,this.b*t.b)}multiplyToRef(t,i){return i.r=this.r*t.r,i.g=this.g*t.g,i.b=this.b*t.b,this}equals(t){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b}equalsFloats(t,i,e){return this.r===t&&this.g===i&&this.b===e}scale(t){return new _(this.r*t,this.g*t,this.b*t)}scaleInPlace(t){return this.r*=t,this.g*=t,this.b*=t,this}scaleToRef(t,i){return i.r=this.r*t,i.g=this.g*t,i.b=this.b*t,this}scaleAndAddToRef(t,i){return i.r+=this.r*t,i.g+=this.g*t,i.b+=this.b*t,this}clampToRef(t=0,i=1,e){return e.r=o.Clamp(this.r,t,i),e.g=o.Clamp(this.g,t,i),e.b=o.Clamp(this.b,t,i),this}add(t){return new _(this.r+t.r,this.g+t.g,this.b+t.b)}addToRef(t,i){return i.r=this.r+t.r,i.g=this.g+t.g,i.b=this.b+t.b,this}subtract(t){return new _(this.r-t.r,this.g-t.g,this.b-t.b)}subtractToRef(t,i){return i.r=this.r-t.r,i.g=this.g-t.g,i.b=this.b-t.b,this}clone(){return new _(this.r,this.g,this.b)}copyFrom(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copyFromFloats(t,i,e){return this.r=t,this.g=i,this.b=e,this}set(t,i,e){return this.copyFromFloats(t,i,e)}toHexString(){const t=Math.round(255*this.r),i=Math.round(255*this.g),e=Math.round(255*this.b);return"#"+o.ToHex(t)+o.ToHex(i)+o.ToHex(e)}toLinearSpace(){const t=new _;return this.toLinearSpaceToRef(t),t}toHSV(){const t=new _;return this.toHSVToRef(t),t}toHSVToRef(t){const i=this.r,e=this.g,s=this.b,n=Math.max(i,e,s),r=Math.min(i,e,s);let h=0,o=0;const a=n,l=n-r;0!==n&&(o=l/n),n!=r&&(n==i?(h=(e-s)/l,e<s&&(h+=6)):n==e?h=(s-i)/l+2:n==s&&(h=(i-e)/l+4),h*=60),t.r=h,t.g=o,t.b=a}toLinearSpaceToRef(t){return t.r=Math.pow(this.r,l),t.g=Math.pow(this.g,l),t.b=Math.pow(this.b,l),this}toGammaSpace(){const t=new _;return this.toGammaSpaceToRef(t),t}toGammaSpaceToRef(t){return t.r=Math.pow(this.r,a),t.g=Math.pow(this.g,a),t.b=Math.pow(this.b,a),this}static HSVtoRGBToRef(t,i,e,s){const n=e*i,r=t/60,h=n*(1-Math.abs(r%2-1));let o=0,a=0,l=0;r>=0&&r<=1?(o=n,a=h):r>=1&&r<=2?(o=h,a=n):r>=2&&r<=3?(a=n,l=h):r>=3&&r<=4?(a=h,l=n):r>=4&&r<=5?(o=h,l=n):r>=5&&r<=6&&(o=n,l=h);const c=e-n;s.set(o+c,a+c,l+c)}static FromHSV(t,i,e){const s=new _(0,0,0);return _.HSVtoRGBToRef(t,i,e,s),s}static FromHexString(t){if("#"!==t.substring(0,1)||7!==t.length)return new _(0,0,0);const i=parseInt(t.substring(1,3),16),e=parseInt(t.substring(3,5),16),s=parseInt(t.substring(5,7),16);return _.FromInts(i,e,s)}static FromArray(t,i=0){return new _(t[i],t[i+1],t[i+2])}static FromArrayToRef(t,i=0,e){e.r=t[i],e.g=t[i+1],e.b=t[i+2]}static FromInts(t,i,e){return new _(t/255,i/255,e/255)}static Lerp(t,i,e){const s=new _(0,0,0);return _.LerpToRef(t,i,e,s),s}static LerpToRef(t,i,e,s){s.r=t.r+(i.r-t.r)*e,s.g=t.g+(i.g-t.g)*e,s.b=t.b+(i.b-t.b)*e}static Hermite(t,i,e,s,n){const r=n*n,h=n*r,o=2*h-3*r+1,a=-2*h+3*r,l=h-2*r+n,c=h-r,u=t.r*o+e.r*a+i.r*l+s.r*c,f=t.g*o+e.g*a+i.g*l+s.g*c,d=t.b*o+e.b*a+i.b*l+s.b*c;return new _(u,f,d)}static Hermite1stDerivative(t,i,e,s,n){const r=_.Black();return this.Hermite1stDerivativeToRef(t,i,e,s,n,r),r}static Hermite1stDerivativeToRef(t,i,e,s,n,r){const h=n*n;r.r=6*(h-n)*t.r+(3*h-4*n+1)*i.r+6*(-h+n)*e.r+(3*h-2*n)*s.r,r.g=6*(h-n)*t.g+(3*h-4*n+1)*i.g+6*(-h+n)*e.g+(3*h-2*n)*s.g,r.b=6*(h-n)*t.b+(3*h-4*n+1)*i.b+6*(-h+n)*e.b+(3*h-2*n)*s.b}static Red(){return new _(1,0,0)}static Green(){return new _(0,1,0)}static Blue(){return new _(0,0,1)}static Black(){return new _(0,0,0)}static get BlackReadOnly(){return _.lt}static White(){return new _(1,1,1)}static Purple(){return new _(.5,0,.5)}static Magenta(){return new _(1,0,1)}static Yellow(){return new _(1,1,0)}static Gray(){return new _(.5,.5,.5)}static Teal(){return new _(0,1,1)}static Random(){return new _(Math.random(),Math.random(),Math.random())}}_.lt=_.Black();class y{constructor(t=0,i=0,e=0,s=1){this.r=t,this.g=i,this.b=e,this.a=s}addInPlace(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(t,i=0){return t[i]=this.r,t[i+1]=this.g,t[i+2]=this.b,t[i+3]=this.a,this}fromArray(t,i=0){return y.FromArrayToRef(t,i,this),this}equals(t){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}add(t){return new y(this.r+t.r,this.g+t.g,this.b+t.b,this.a+t.a)}subtract(t){return new y(this.r-t.r,this.g-t.g,this.b-t.b,this.a-t.a)}subtractToRef(t,i){return i.r=this.r-t.r,i.g=this.g-t.g,i.b=this.b-t.b,i.a=this.a-t.a,this}scale(t){return new y(this.r*t,this.g*t,this.b*t,this.a*t)}scaleInPlace(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this}scaleToRef(t,i){return i.r=this.r*t,i.g=this.g*t,i.b=this.b*t,i.a=this.a*t,this}scaleAndAddToRef(t,i){return i.r+=this.r*t,i.g+=this.g*t,i.b+=this.b*t,i.a+=this.a*t,this}clampToRef(t=0,i=1,e){return e.r=o.Clamp(this.r,t,i),e.g=o.Clamp(this.g,t,i),e.b=o.Clamp(this.b,t,i),e.a=o.Clamp(this.a,t,i),this}multiply(t){return new y(this.r*t.r,this.g*t.g,this.b*t.b,this.a*t.a)}multiplyToRef(t,i){return i.r=this.r*t.r,i.g=this.g*t.g,i.b=this.b*t.b,i.a=this.a*t.a,i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let t=255*this.r|0;return t=397*t^(255*this.g|0),t=397*t^(255*this.b|0),t=397*t^(255*this.a|0),t}clone(){return new y(this.r,this.g,this.b,this.a)}copyFrom(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}copyFromFloats(t,i,e,s){return this.r=t,this.g=i,this.b=e,this.a=s,this}set(t,i,e,s){return this.copyFromFloats(t,i,e,s)}toHexString(t=!1){const i=Math.round(255*this.r),e=Math.round(255*this.g),s=Math.round(255*this.b);if(t)return"#"+o.ToHex(i)+o.ToHex(e)+o.ToHex(s);const n=Math.round(255*this.a);return"#"+o.ToHex(i)+o.ToHex(e)+o.ToHex(s)+o.ToHex(n)}toLinearSpace(){const t=new y;return this.toLinearSpaceToRef(t),t}toLinearSpaceToRef(t){return t.r=Math.pow(this.r,l),t.g=Math.pow(this.g,l),t.b=Math.pow(this.b,l),t.a=this.a,this}toGammaSpace(){const t=new y;return this.toGammaSpaceToRef(t),t}toGammaSpaceToRef(t){return t.r=Math.pow(this.r,a),t.g=Math.pow(this.g,a),t.b=Math.pow(this.b,a),t.a=this.a,this}static FromHexString(t){if("#"!==t.substring(0,1)||9!==t.length&&7!==t.length)return new y(0,0,0,0);const i=parseInt(t.substring(1,3),16),e=parseInt(t.substring(3,5),16),s=parseInt(t.substring(5,7),16),n=9===t.length?parseInt(t.substring(7,9),16):255;return y.FromInts(i,e,s,n)}static Lerp(t,i,e){const s=new y(0,0,0,0);return y.LerpToRef(t,i,e,s),s}static LerpToRef(t,i,e,s){s.r=t.r+(i.r-t.r)*e,s.g=t.g+(i.g-t.g)*e,s.b=t.b+(i.b-t.b)*e,s.a=t.a+(i.a-t.a)*e}static Hermite(t,i,e,s,n){const r=n*n,h=n*r,o=2*h-3*r+1,a=-2*h+3*r,l=h-2*r+n,c=h-r,u=t.r*o+e.r*a+i.r*l+s.r*c,f=t.g*o+e.g*a+i.g*l+s.g*c,d=t.b*o+e.b*a+i.b*l+s.b*c,p=t.a*o+e.a*a+i.a*l+s.a*c;return new y(u,f,d,p)}static Hermite1stDerivative(t,i,e,s,n){const r=new y;return this.Hermite1stDerivativeToRef(t,i,e,s,n,r),r}static Hermite1stDerivativeToRef(t,i,e,s,n,r){const h=n*n;r.r=6*(h-n)*t.r+(3*h-4*n+1)*i.r+6*(-h+n)*e.r+(3*h-2*n)*s.r,r.g=6*(h-n)*t.g+(3*h-4*n+1)*i.g+6*(-h+n)*e.g+(3*h-2*n)*s.g,r.b=6*(h-n)*t.b+(3*h-4*n+1)*i.b+6*(-h+n)*e.b+(3*h-2*n)*s.b,r.a=6*(h-n)*t.a+(3*h-4*n+1)*i.a+6*(-h+n)*e.a+(3*h-2*n)*s.a}static FromColor3(t,i=1){return new y(t.r,t.g,t.b,i)}static FromArray(t,i=0){return new y(t[i],t[i+1],t[i+2],t[i+3])}static FromArrayToRef(t,i=0,e){e.r=t[i],e.g=t[i+1],e.b=t[i+2],e.a=t[i+3]}static FromInts(t,i,e,s){return new y(t/255,i/255,e/255,s/255)}static CheckColors4(t,i){if(t.length===3*i){const i=[];for(let e=0;e<t.length;e+=3){const s=e/3*4;i[s]=t[e],i[s+1]=t[e+1],i[s+2]=t[e+2],i[s+3]=1}return i}return t}}class N{}N.Color3=f.BuildArray(3,_.Black),N.Color4=f.BuildArray(3,(()=>new y(0,0,0,0))),v("BABYLON.Color3",_),v("BABYLON.Color4",y);class P{constructor(t,i){this.triggerOptions=t,this.onBeforeExecuteObservable=new h,t.parameter?(this.trigger=t.trigger,this.ct=t.parameter):t.trigger?this.trigger=t.trigger:this.trigger=t,this.ut=this,this.ft=i}dt(){}getTriggerParameter(){return this.ct}setTriggerParameter(t){this.ct=t}vt(){const t=this.ft;if(!t)return!0;const i=this.gt.getScene().getRenderId();return t.St!==i&&(t.St=i,t.Et=t.isValid()),t.Et}At(t){this.vt()&&(this.onBeforeExecuteObservable.notifyObservers(this),this.ut.execute(t),this.skipToNextActiveAction())}execute(t){}skipToNextActiveAction(){this.ut.Ct?(this.ut.Ct.gt||(this.ut.Ct.gt=this.gt),this.ut=this.ut.Ct):this.ut=this}then(t){return this.Ct=t,t.gt=this.gt,t.dt(),t}wt(t){return this.gt.wt(t)}xt(t,i){return this.gt.xt(t,i)}serialize(t){}Tt(t,i){const e={type:1,children:[],name:t.name,properties:t.properties||[]};if(this.Ct&&this.Ct.serialize(e),this.ft){const t=this.ft.serialize();return t.children.push(e),i&&i.children.push(t),t}return i&&i.children.push(e),e}}P.Rt=t=>"number"==typeof t?t.toString():"boolean"==typeof t?t?"true":"false":t instanceof C?t.x+", "+t.y:t instanceof w?t.x+", "+t.y+", "+t.z:t instanceof _?t.r+", "+t.g+", "+t.b:t instanceof y?t.r+", "+t.g+", "+t.b+", "+t.a:t,P.It=t=>({name:"target",targetType:t.Mt?"MeshProperties":t.bt?"LightProperties":t._t?"CameraProperties":t.yt?"MaterialProperties":"SceneProperties",value:t.Nt?"Scene":t.name}),v("BABYLON.Action",P);class D{constructor(t,i,e,s,n,r){this.source=t,this.pointerX=i,this.pointerY=e,this.meshUnderPointer=s,this.sourceEvent=n,this.additionalData=r}static CreateNew(t,i,e){const s=t.getScene();return new D(t,s.pointerX,s.pointerY,s.meshUnderPointer||t,i,e)}static CreateNewFromSprite(t,i,e,s){return new D(t,i.pointerX,i.pointerY,i.meshUnderPointer,e,s)}static CreateNewFromScene(t,i){return new D(null,t.pointerX,t.pointerY,t.meshUnderPointer,i)}static CreateNewFromPrimitive(t,i,e,s){return new D(t,i.x,i.y,null,e,s)}}class L{constructor(t){this.gt=t}isValid(){return!0}wt(t){return this.gt.wt(t)}xt(t,i){return this.gt.xt(t,i)}serialize(){}Tt(t){return{type:2,children:[],name:t.name,properties:t.properties}}}class O extends L{constructor(t,i,e,s,n=O.IsEqual){super(t),this.propertyPath=e,this.value=s,this.operator=n,this.Pt=i,this.Dt=this.xt(i,this.propertyPath),this.Lt=this.wt(this.propertyPath)}static get IsEqual(){return O.Ot}static get IsDifferent(){return O.Ft}static get IsGreater(){return O.Bt}static get IsLesser(){return O.Ut}isValid(){switch(this.operator){case O.IsGreater:return this.Dt[this.Lt]>this.value;case O.IsLesser:return this.Dt[this.Lt]<this.value;case O.IsEqual:case O.IsDifferent:{let t;return t=this.value.equals?this.value.equals(this.Dt[this.Lt]):this.value===this.Dt[this.Lt],this.operator===O.IsEqual?t:!t}}return!1}serialize(){return this.Tt({name:"ValueCondition",properties:[P.It(this.Pt),{name:"propertyPath",value:this.propertyPath},{name:"value",value:P.Rt(this.value)},{name:"operator",value:O.GetOperatorName(this.operator)}]})}static GetOperatorName(t){switch(t){case O.Ot:return"IsEqual";case O.Ft:return"IsDifferent";case O.Bt:return"IsGreater";case O.Ut:return"IsLesser";default:return""}}}O.Ot=0,O.Ft=1,O.Bt=2,O.Ut=3;v("BABYLON.ValueCondition",O),v("BABYLON.PredicateCondition",class extends L{constructor(t,i){super(t),this.predicate=i}isValid(){return this.predicate()}}),v("BABYLON.StateCondition",class extends L{constructor(t,i,e){super(t),this.value=e,this.Pt=i}isValid(){return this.Pt.state===this.value}serialize(){return this.Tt({name:"StateCondition",properties:[P.It(this.Pt),{name:"value",value:this.value}]})}});class F{static Vt(t,i){let e=F.kt[t];return e?e.current++:(e={limit:i,current:1},F.kt[t]=e),e.current<=e.limit}static Gt(t,i=1){var e;const s=F.kt[t];if(!s||!F.MessageLimitReached)return;const n=this.zt[i];s.current===s.limit&&F[n.name](F.MessageLimitReached.replace(/%LIMIT%/g,""+s.limit).replace(/%TYPE%/g,null!==(e=n.name)&&void 0!==e?e:""))}static Ht(t){F.Xt=t+F.Xt,F.OnNewCacheEntry&&F.OnNewCacheEntry(t)}static Wt(t){const i=t=>t<10?"0"+t:""+t,e=new Date;return"["+i(e.getHours())+":"+i(e.getMinutes())+":"+i(e.getSeconds())+"]: "+t}static $t(t,i){}static Yt(t=1,i,e){if(void 0!==e&&!F.Vt(i,e))return;const s=F.Wt(i),n=this.zt[t];n.logFunc&&n.logFunc("BJS - "+s);const r=`<div style='color:${n.color}'>${s}</div><br>`;F.Ht(r),F.Gt(i,t)}static get LogCache(){return F.Xt}static ClearLogCache(){F.Xt="",F.kt={},F.errorsCount=0}static set LogLevels(t){F.Log=F.$t,F.Warn=F.$t,F.Error=F.$t,[F.MessageLogLevel,F.WarningLogLevel,F.ErrorLogLevel].forEach((i=>{if((t&i)===i){const t=this.zt[i];F[t.name]=F.Yt.bind(F,i)}}))}}F.NoneLogLevel=0,F.MessageLogLevel=1,F.WarningLogLevel=2,F.ErrorLogLevel=4,F.AllLogLevel=7,F.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",F.Xt="",F.kt={},F.zt=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}],F.errorsCount=0,F.Log=F.Yt.bind(F,F.MessageLogLevel),F.Warn=F.Yt.bind(F,F.WarningLogLevel),F.Error=F.Yt.bind(F,F.ErrorLogLevel);class B extends P{constructor(t=0,i){super(t,i)}execute(){}serialize(t){return super.Tt({name:"DoNothingAction",properties:[]},t)}}class U extends P{constructor(t,i,e,s){super(t,s),this.Pt=i,this.jt=e}dt(){}execute(){if(this.Pt.parent===this.jt)return;const t=this.jt.getWorldMatrix().clone();t.invert(),this.Pt.position=w.TransformCoordinates(this.Pt.position,t),this.Pt.parent=this.jt}serialize(t){return super.Tt({name:"SetParentAction",properties:[P.It(this.Pt),P.It(this.jt)]},t)}}v("BABYLON.SetParentAction",U),v("BABYLON.ExecuteCodeAction",class extends P{constructor(t,i,e){super(t,e),this.func=i}execute(t){this.func(t)}}),v("BABYLON.DoNothingAction",B),v("BABYLON.StopAnimationAction",class extends P{constructor(t,i,e){super(t,e),this.Pt=i}dt(){}execute(){this.gt.getScene().stopAnimation(this.Pt)}serialize(t){return super.Tt({name:"StopAnimationAction",properties:[P.It(this.Pt)]},t)}}),v("BABYLON.PlayAnimationAction",class extends P{constructor(t,i,e,s,n,r){super(t,r),this.from=e,this.to=s,this.loop=n,this.Pt=i}dt(){}execute(){this.gt.getScene().beginAnimation(this.Pt,this.from,this.to,this.loop)}serialize(t){return super.Tt({name:"PlayAnimationAction",properties:[P.It(this.Pt),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:P.Rt(this.loop)||!1}]},t)}}),v("BABYLON.IncrementValueAction",class extends P{constructor(t,i,e,s,n){super(t,n),this.propertyPath=e,this.value=s,this.Pt=this.Dt=i}dt(){this.Dt=this.xt(this.Dt,this.propertyPath),this.Lt=this.wt(this.propertyPath),"number"!=typeof this.Dt[this.Lt]&&F.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this.Dt[this.Lt]+=this.value,this.Pt.markAsDirty&&this.Pt.markAsDirty(this.Lt)}serialize(t){return super.Tt({name:"IncrementValueAction",properties:[P.It(this.Pt),{name:"propertyPath",value:this.propertyPath},{name:"value",value:P.Rt(this.value)}]},t)}}),v("BABYLON.SetValueAction",class extends P{constructor(t,i,e,s,n){super(t,n),this.propertyPath=e,this.value=s,this.Pt=this.Dt=i}dt(){this.Dt=this.xt(this.Dt,this.propertyPath),this.Lt=this.wt(this.propertyPath)}execute(){this.Dt[this.Lt]=this.value,this.Pt.markAsDirty&&this.Pt.markAsDirty(this.Lt)}serialize(t){return super.Tt({name:"SetValueAction",properties:[P.It(this.Pt),{name:"propertyPath",value:this.propertyPath},{name:"value",value:P.Rt(this.value)}]},t)}}),v("BABYLON.SetStateAction",class extends P{constructor(t,i,e,s){super(t,s),this.value=e,this.Pt=i}execute(){this.Pt.state=this.value}serialize(t){return super.Tt({name:"SetStateAction",properties:[P.It(this.Pt),{name:"value",value:this.value}]},t)}}),v("BABYLON.SetParentAction",U),v("BABYLON.SwitchBooleanAction",class extends P{constructor(t,i,e,s){super(t,s),this.propertyPath=e,this.Pt=this.Dt=i}dt(){this.Dt=this.xt(this.Dt,this.propertyPath),this.Lt=this.wt(this.propertyPath)}execute(){this.Dt[this.Lt]=!this.Dt[this.Lt]}serialize(t){return super.Tt({name:"SwitchBooleanAction",properties:[P.It(this.Pt),{name:"propertyPath",value:this.propertyPath}]},t)}}),v("BABYLON.CombineAction",class extends P{constructor(t,i,e,s=!0){super(t,e),this.children=i,this.enableChildrenConditions=s}dt(){for(let t=0;t<this.children.length;t++)this.children[t].gt=this.gt,this.children[t].dt()}execute(t){for(const i of this.children)this.enableChildrenConditions&&!i.vt()||i.execute(t)}serialize(t){const i=super.Tt({name:"CombineAction",properties:[],combine:[]},t);for(let t=0;t<this.children.length;t++)i.combine.push(this.children[t].serialize(null));return i}});const V=(t,i)=>t?t.getClassName&&"Mesh"===t.getClassName()?null:t.getClassName&&"SubMesh"===t.getClassName()?t.clone(i):t.clone?t.clone():null:null;class k{static DeepCopy(t,i,e,s){const n=function(t){const i=[];do{Object.getOwnPropertyNames(t).forEach((function(t){-1===i.indexOf(t)&&i.push(t)}))}while(t=Object.getPrototypeOf(t));return i}(t);for(const r of n){if("_"===r[0]&&(!s||-1===s.indexOf(r)))continue;if(r.endsWith("Observable"))continue;if(e&&-1!==e.indexOf(r))continue;const n=t[r],h=typeof n;if("function"!==h)try{if("object"===h)if(n instanceof Array){if(i[r]=[],n.length>0)if("object"==typeof n[0])for(let t=0;t<n.length;t++){const e=V(n[t],i);-1===i[r].indexOf(e)&&i[r].push(e)}else i[r]=n.slice(0)}else i[r]=V(n,i);else i[r]=n}catch(t){F.Warn(t.message)}}}}class G extends s{constructor(t){super(),(t=t||E.LastCreatedScene)&&(this.Kt=t,t.actionManagers.push(this))}dispose(){const t=this.Kt.actionManagers.indexOf(this);for(let t=0;t<this.actions.length;t++){const i=this.actions[t];G.Triggers[i.trigger]--,0===G.Triggers[i.trigger]&&delete G.Triggers[i.trigger]}t>-1&&this.Kt.actionManagers.splice(t,1)}getScene(){return this.Kt}hasSpecificTriggers(t){for(let i=0;i<this.actions.length;i++){const e=this.actions[i];if(t.indexOf(e.trigger)>-1)return!0}return!1}hasSpecificTriggers2(t,i){for(let e=0;e<this.actions.length;e++){const s=this.actions[e];if(t==s.trigger||i==s.trigger)return!0}return!1}hasSpecificTrigger(t,i){for(let e=0;e<this.actions.length;e++){const s=this.actions[e];if(s.trigger===t){if(!i)return!0;if(i(s.getTriggerParameter()))return!0}}return!1}get hasPointerTriggers(){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(i.trigger>=G.OnPickTrigger&&i.trigger<=G.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(i.trigger>=G.OnPickTrigger&&i.trigger<=G.OnPickUpTrigger)return!0}return!1}registerAction(t){return t.trigger===G.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(F.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(t),this.getScene().qt++,G.Triggers[t.trigger]?G.Triggers[t.trigger]++:G.Triggers[t.trigger]=1,t.gt=this,t.dt(),t)}unregisterAction(t){const i=this.actions.indexOf(t);return-1!==i&&(this.actions.splice(i,1),G.Triggers[t.trigger]-=1,0===G.Triggers[t.trigger]&&delete G.Triggers[t.trigger],t.gt=null,this.getScene().qt--,!0)}processTrigger(t,i){for(let e=0;e<this.actions.length;e++){const s=this.actions[e];if(s.trigger===t){if(i&&(t===G.OnKeyUpTrigger||t===G.OnKeyDownTrigger)){const t=s.getTriggerParameter();if(t&&t!==i.sourceEvent.keyCode){if(!t.toLowerCase)continue;const e=t.toLowerCase();if(e!==i.sourceEvent.key){const t=i.sourceEvent.charCode?i.sourceEvent.charCode:i.sourceEvent.keyCode;if(String.fromCharCode(t).toLowerCase()!==e)continue}}}s.At(i)}}}xt(t,i){const e=i.split(".");for(let i=0;i<e.length-1;i++)t=t[e[i]];return t}wt(t){const i=t.split(".");return i[i.length-1]}serialize(t){const i={children:new Array,name:t,type:3,properties:new Array};for(let t=0;t<this.actions.length;t++){const e={type:0,children:new Array,name:G.GetTriggerName(this.actions[t].trigger),properties:new Array},s=this.actions[t].triggerOptions;if(s&&"number"!=typeof s)if(s.parameter instanceof Node)e.properties.push(P.It(s.parameter));else if("object"==typeof s.parameter){const t={};k.DeepCopy(s.parameter,t,["mesh"]),s.parameter&&s.parameter.mesh&&(t.Qt=s.parameter.mesh.id),e.properties.push({name:"parameter",targetType:null,value:t})}else e.properties.push({name:"parameter",targetType:null,value:s.parameter});this.actions[t].serialize(e),i.children.push(e)}return i}static Parse(t,i,e){const s=new G(e);null===i?e.actionManager=s:i.actionManager=s;const n=(t,i,e,s)=>{if(null===s){const t=parseFloat(i);return"true"===i||"false"===i?"true"===i:isNaN(t)?i:t}const n=s.split("."),r=i.split(",");for(let t=0;t<n.length;t++)e=e[n[t]];if("boolean"==typeof e)return"true"===r[0];if("string"==typeof e)return r[0];const h=new Array;for(let t=0;t<r.length;t++)h.push(parseFloat(r[t]));return e instanceof w?w.FromArray(h):e instanceof x?x.FromArray(h):e instanceof _?_.FromArray(h):e instanceof y?y.FromArray(h):parseFloat(r[0])},r=(t,i,h,o,a=null)=>{if(t.detached)return;const l=new Array;let c=null,u=null;const f=t.combine&&t.combine.length>0;if(2===t.type?l.push(s):l.push(i),f){const i=new Array;for(let e=0;e<t.combine.length;e++)r(t.combine[e],G.NothingTrigger,h,o,i);l.push(i)}else for(let i=0;i<t.properties.length;i++){let s=t.properties[i].value;const r=t.properties[i].name,h=t.properties[i].targetType;"target"===r?s=c="SceneProperties"===h?e:"MaterialProperties"===h?e.getMaterialByName(s):e.getNodeByName(s):"parent"===r?s=e.getNodeByName(s):"sound"===r?e.getSoundByName&&(s=e.getSoundByName(s)):"propertyPath"!==r?s=2===t.type&&"operator"===r?O[s]:n(0,s,c,"value"===r?u:null):u=s,l.push(s)}if(null===a?l.push(h):l.push(null),"InterpolateValueAction"===t.name){const t=l[l.length-2];l[l.length-1]=t,l[l.length-2]=h}let d=((t,i)=>{const e=g("BABYLON."+t);return e&&new e(...i)})(t.name,l);if(d instanceof L&&null!==h){const t=new B(i,h);o?o.then(t):s.registerAction(t),o=t}null===a?d instanceof L?(h=d,d=o):(h=null,o?o.then(d):s.registerAction(d)):a.push(d);for(let e=0;e<t.children.length;e++)r(t.children[e],i,h,d,null)};for(let i=0;i<t.children.length;i++){let s;const n=t.children[i];if(n.properties.length>0){const t=n.properties[0].value,i=null===n.properties[0].targetType?t:e.getMeshByName(t);i.Qt&&(i.mesh=e.getMeshById(i.Qt)),s={trigger:G[n.name],parameter:i}}else s=G[n.name];for(let t=0;t<n.children.length;t++)n.detached||r(n.children[t],s,null,null)}}static GetTriggerName(t){switch(t){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}G.NothingTrigger=0,G.OnPickTrigger=1,G.OnLeftPickTrigger=2,G.OnRightPickTrigger=3,G.OnCenterPickTrigger=4,G.OnPickDownTrigger=5,G.OnDoublePickTrigger=6,G.OnPickUpTrigger=7,G.OnPickOutTrigger=16,G.OnLongPressTrigger=8,G.OnPointerOverTrigger=9,G.OnPointerOutTrigger=10,G.OnEveryFrameTrigger=11,G.OnIntersectionEnterTrigger=12,G.OnIntersectionExitTrigger=13,G.OnKeyDownTrigger=14,G.OnKeyUpTrigger=15;v("BABYLON.PlaySoundAction",class extends P{constructor(t,i,e){super(t,e),this.Zt=i}dt(){}execute(){void 0!==this.Zt&&this.Zt.play()}serialize(t){return super.Tt({name:"PlaySoundAction",properties:[{name:"sound",value:this.Zt.name}]},t)}}),v("BABYLON.StopSoundAction",class extends P{constructor(t,i,e){super(t,e),this.Zt=i}dt(){}execute(){void 0!==this.Zt&&this.Zt.stop()}serialize(t){return super.Tt({name:"StopSoundAction",properties:[{name:"sound",value:this.Zt.name}]},t)}});class z{static Eval(t,i){return"true"===(t=t.match(/\([^()]*\)/g)?t.replace(/\([^()]*\)/g,(t=>(t=t.slice(1,t.length-1),z.Jt(t,i)))):z.Jt(t,i))||"false"!==t&&z.Eval(t,i)}static Jt(t,i){let e;i=i||(t=>"true"===t);const s=t.split("||");for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t)){let n=z.ti(s[t].trim());const r=n.split("&&");if(r.length>1)for(let t=0;t<r.length;++t){const s=z.ti(r[t].trim());if(e="true"!==s&&"false"!==s?"!"===s[0]?!i(s.substring(1)):i(s):"true"===s,!e){n="false";break}}if(e||"true"===n){e=!0;break}e="true"!==n&&"false"!==n?"!"===n[0]?!i(n.substring(1)):i(n):"true"===n}return e?"true":"false"}static ti(t){return"!true"===(t=(t=t.replace(/^[\s!]+/,(t=>(t=t.replace(/[\s]/g,(()=>""))).length%2?"!":""))).trim())?t="false":"!false"===t&&(t="true"),t}}class H{static EnableFor(t){t.ii=t.ii||{},t.hasTags=()=>H.HasTags(t),t.addTags=i=>H.AddTagsTo(t,i),t.removeTags=i=>H.RemoveTagsFrom(t,i),t.matchesTagsQuery=i=>H.MatchesQuery(t,i)}static DisableFor(t){delete t.ii,delete t.hasTags,delete t.addTags,delete t.removeTags,delete t.matchesTagsQuery}static HasTags(t){if(!t.ii)return!1;const i=t.ii;for(const t in i)if(Object.prototype.hasOwnProperty.call(i,t))return!0;return!1}static GetTags(t,i=!0){if(!t.ii)return null;if(i){const i=[];for(const e in t.ii)Object.prototype.hasOwnProperty.call(t.ii,e)&&!0===t.ii[e]&&i.push(e);return i.join(" ")}return t.ii}static AddTagsTo(t,i){if(!i)return;if("string"!=typeof i)return;i.split(" ").forEach((function(i){H.ei(t,i)}))}static ei(t,i){""!==(i=i.trim())&&"true"!==i&&"false"!==i&&(i.match(/[\s]/)||i.match(/^([!]|([|]|[&]){2})/)||(H.EnableFor(t),t.ii[i]=!0))}static RemoveTagsFrom(t,i){if(!H.HasTags(t))return;const e=i.split(" ");for(const i in e)H.si(t,e[i])}static si(t,i){delete t.ii[i]}static MatchesQuery(t,i){return void 0===i||(""===i?H.HasTags(t):z.Eval(i,(i=>H.HasTags(t)&&t.ii[i])))}}function X(t){return`${t} needs to be imported before as it contains a side-effect required by your code.`}const W={},$={},Y=function(t,i,e){const s=t();H&&H.AddTagsTo(s,i.tags);const n=j(s);for(const t in n){const r=n[t],h=i[t],o=r.type;if(null!=h&&("uniqueId"!==t||ot.AllowLoadingUniqueId))switch(o){case 0:case 6:case 11:s[t]=h;break;case 1:s[t]=e||h.isRenderTarget?h:h.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:s[t]=e?h:h.clone()}}return s};function j(t){const i=t.getClassName();if($[i])return $[i];$[i]={};const e=$[i];let s=t,n=i;for(;n;){const t=W[n];for(const i in t)e[i]=t[i];let i,r=!1;do{if(i=Object.getPrototypeOf(s),!i.getClassName){r=!0;break}if(i.getClassName()!==n)break;s=i}while(i);if(r)break;n=i.getClassName(),s=i}return e}function K(t,i){return(e,s)=>{const n=function(t){const i=t.getClassName();return W[i]||(W[i]={}),W[i]}(e);n[s]||(n[s]={type:t,sourceName:i})}}function q(t,i=null){return function(t,i=null){return(e,s)=>{const n=i||"_"+s;Object.defineProperty(e,s,{get:function(){return this[n]},set:function(i){"function"==typeof this.equals&&this.equals(i)||this[n]!==i&&(this[n]=i,e[t].apply(this))},enumerable:!0,configurable:!0})}}(t,i)}function Q(t){return K(0,t)}function Z(t){return K(1,t)}function J(t){return K(2,t)}function tt(t){return K(3,t)}function it(t){return K(4,t)}function et(t){return K(5,t)}function st(t){return K(6,t)}function nt(t){return K(8,t)}function rt(t){return K(9,t)}function ht(t){return K(12,t)}class ot{static AppendSerializedAnimations(t,i){if(t.animations){i.animations=[];for(let e=0;e<t.animations.length;e++){const s=t.animations[e];i.animations.push(s.serialize())}}}static Serialize(t,i){i||(i={}),H&&(i.tags=H.GetTags(t));const e=j(t);for(const s in e){const n=e[s],r=n.sourceName||s,h=n.type,o=t[s];if(null!=o&&("uniqueId"!==s||ot.AllowLoadingUniqueId))switch(h){case 0:i[r]=o;break;case 1:case 3:case 7:case 9:i[r]=o.serialize();break;case 2:case 4:case 5:case 8:case 10:case 12:i[r]=o.asArray();break;case 6:case 11:i[r]=o.id}}return i}static Parse(t,i,e,s=null){const n=t();s||(s=""),H&&H.AddTagsTo(n,i.tags);const r=j(n);for(const t in r){const h=r[t],o=i[h.sourceName||t],a=h.type;if(null!=o&&("uniqueId"!==t||ot.AllowLoadingUniqueId)){const i=n;switch(a){case 0:i[t]=o;break;case 1:e&&(i[t]=ot.ni(o,e,s));break;case 2:i[t]=_.FromArray(o);break;case 3:i[t]=ot.ri(o);break;case 4:i[t]=C.FromArray(o);break;case 5:i[t]=w.FromArray(o);break;case 6:e&&(i[t]=e.getLastMeshById(o));break;case 7:i[t]=ot.hi(o);break;case 8:i[t]=y.FromArray(o);break;case 9:i[t]=ot.oi(o);break;case 10:i[t]=T.FromArray(o);break;case 11:e&&(i[t]=e.getCameraById(o));break;case 12:i[t]=R.FromArray(o)}}}return n}static Clone(t,i){return Y(t,i,!1)}static Instanciate(t,i){return Y(t,i,!0)}}function at(t,i,e,s){const n=e.value;e.value=(...e)=>{let r=n;if("undefined"!=typeof _native&&_native[i]){const t=_native[i];r=s?(...i)=>s(...i)?t(...i):n(...i):t}return t[i]=r,r(...e)}}var lt;ot.AllowLoadingUniqueId=!1,ot.oi=t=>{throw X("ImageProcessingConfiguration")},ot.ri=t=>{throw X("FresnelParameters")},ot.hi=t=>{throw X("ColorCurves")},ot.ni=(t,i,e)=>{throw X("Texture")},at.filter=function(t){return(i,e,s)=>at(i,e,s,t)},function(t){t[t.NONE=0]="NONE",t[t.STEP=1]="STEP"}(lt||(lt={}));class ct{constructor(t,i,e){this.name=t,this.from=i,this.to=e}clone(){return new ct(this.name,this.from,this.to)}}function ut(t,i,e,s){var n,r=arguments.length,h=r<3?i:null===s?s=Object.getOwnPropertyDescriptor(i,e):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)h=Reflect.decorate(t,i,e,s);else for(var o=t.length-1;o>=0;o--)(n=t[o])&&(h=(r<3?n(h):r>3?n(i,e,h):n(i,e))||h);return r>3&&h&&Object.defineProperty(i,e,h),h}Object.create;Object.create;class ft{constructor(){this.ai=!1,this.li=!1,this.ci=-1,this.ui=!0,this.fi=!0,this.di=!0,this.pi=new h,this.mi=new h}}class dt{constructor(t,i=null){this.F=!1,this.vi=new ft,this.state="",this.metadata=null,this.reservedDataStore=null,this.gi=null,this.onAccessibilityTagChangedObservable=new h,this.Si=null,this.animations=new Array,this.Ei={},this.onReady=null,this.Ai=-1,this.Ci=-1,this.wi=-1,this.xi=null,this.Ti=null,this.Ri=null,this.Ii={},this.Mi=null,this.bi=null,this._i=R.Identity(),this.yi=0,this.Ni=!0,this.Pi=null,this.Di=!0,this.onDisposeObservable=new h,this.Li=null,this.Oi=new Array,this.name=t,this.id=t,this.Kt=i||E.LastCreatedScene,this.uniqueId=this.Kt.getUniqueId(),this.Fi()}static AddNodeConstructor(t,i){this.Bi[t]=i}static Construct(t,i,e,s){const n=this.Bi[t];return n?n(i,e,s):null}set accessibilityTag(t){this.gi=t,this.onAccessibilityTagChangedObservable.notifyObservers(t)}get accessibilityTag(){return this.gi}get doNotSerialize(){return!!this.vi.ai||!!this.Mi&&this.Mi.doNotSerialize}set doNotSerialize(t){this.vi.ai=t}isDisposed(){return this.vi.li}set parent(t){if(this.Mi===t)return;const i=this.Mi;if(this.Mi&&void 0!==this.Mi.bi&&null!==this.Mi.bi){const i=this.Mi.bi.indexOf(this);-1!==i&&this.Mi.bi.splice(i,1),t||this.vi.li||this.Ui()}this.Mi=t,this.Mi&&(void 0!==this.Mi.bi&&null!==this.Mi.bi||(this.Mi.bi=new Array),this.Mi.bi.push(this),i||this.Vi()),this.ki()}get parent(){return this.Mi}Gi(t){t.parentId=this.uniqueId}Ui(){-1===this.vi.ci&&(this.vi.ci=this.Kt.rootNodes.length,this.Kt.rootNodes.push(this))}Vi(){if(-1!==this.vi.ci){const t=this.Kt.rootNodes,i=t.length-1;t[this.vi.ci]=t[i],t[this.vi.ci].vi.ci=this.vi.ci,this.Kt.rootNodes.pop(),this.vi.ci=-1}}get animationPropertiesOverride(){return this.Pi?this.Pi:this.Kt.animationPropertiesOverride}set animationPropertiesOverride(t){this.Pi=t}getClassName(){return"Node"}set onDispose(t){this.Li&&this.onDisposeObservable.remove(this.Li),this.Li=this.onDisposeObservable.add(t)}get onEnabledStateChangedObservable(){return this.vi.pi}get onClonedObservable(){return this.vi.mi}getScene(){return this.Kt}getEngine(){return this.Kt.getEngine()}addBehavior(t,i=!1){return-1!==this.Oi.indexOf(t)||(t.init(),this.Kt.isLoading&&!i?this.Kt.onDataLoadedObservable.addOnce((()=>{t.attach(this)})):t.attach(this),this.Oi.push(t)),this}removeBehavior(t){const i=this.Oi.indexOf(t);return-1===i||(this.Oi[i].detach(),this.Oi.splice(i,1)),this}get behaviors(){return this.Oi}getBehaviorByName(t){for(const i of this.Oi)if(i.name===t)return i;return null}getWorldMatrix(){return this.Ai!==this.Kt.getRenderId()&&this.computeWorldMatrix(),this._i}zi(){return this.Ni&&(this.Ni=!1,this.yi=this._i.determinant()),this.yi}get worldMatrixFromCache(){return this._i}Fi(){this.Ii={},this.Ii.parent=void 0}updateCache(t){!t&&this.isSynchronized()||(this.Ii.parent=this.parent,this.Hi())}Xi(t,i=!0){return this.parent?this.parent.Xi(t,!1):null}Hi(t){}Wi(){return!0}$i(){this.Mi&&(this.Ci=this.Mi.wi)}isSynchronizedWithParent(){return!this.Mi||!this.Mi.F&&this.Ci===this.Mi.wi&&this.Mi.isSynchronized()}isSynchronized(){return this.Ii.parent!==this.Mi?(this.Ii.parent=this.Mi,!1):!(this.Mi&&!this.isSynchronizedWithParent())&&this.Wi()}isReady(t=!1){return this.vi.di}markAsDirty(t){return this.Ai=Number.MAX_VALUE,this.F=!0,this}isEnabled(t=!0){return!1===t?this.vi.ui:!!this.vi.ui&&this.vi.fi}ki(){this.vi.fi=!this.Mi||this.Mi.isEnabled(),this.bi&&this.bi.forEach((t=>{t.ki()}))}setEnabled(t){this.vi.ui!==t&&(this.vi.ui=t,this.ki(),this.vi.pi.notifyObservers(t))}isDescendantOf(t){return!!this.parent&&(this.parent===t||this.parent.isDescendantOf(t))}Yi(t,i=!1,e){if(this.bi)for(let s=0;s<this.bi.length;s++){const n=this.bi[s];e&&!e(n)||t.push(n),i||n.Yi(t,!1,e)}}getDescendants(t,i){const e=new Array;return this.Yi(e,t,i),e}getChildMeshes(t,i){const e=[];return this.Yi(e,t,(t=>(!i||i(t))&&void 0!==t.cullingStrategy)),e}getChildren(t,i=!0){return this.getDescendants(i,t)}ji(t){t!==this.vi.di&&(t?(this.onReady&&this.onReady(this),this.vi.di=!0):this.vi.di=!1)}getAnimationByName(t){for(let i=0;i<this.animations.length;i++){const e=this.animations[i];if(e.name===t)return e}return null}createAnimationRange(t,i,e){if(!this.Ei[t]){this.Ei[t]=dt.Ki(t,i,e);for(let s=0,n=this.animations.length;s<n;s++)this.animations[s]&&this.animations[s].createRange(t,i,e)}}deleteAnimationRange(t,i=!0){for(let e=0,s=this.animations.length;e<s;e++)this.animations[e]&&this.animations[e].deleteRange(t,i);this.Ei[t]=null}getAnimationRange(t){return this.Ei[t]||null}getAnimationRanges(){const t=[];let i;for(i in this.Ei)t.push(this.Ei[i]);return t}beginAnimation(t,i,e,s){const n=this.getAnimationRange(t);return n?this.Kt.beginAnimation(this,n.from,n.to,i,e,s):null}serializeAnimationRanges(){const t=[];for(const i in this.Ei){const e=this.Ei[i];if(!e)continue;const s={};s.name=i,s.from=e.from,s.to=e.to,t.push(s)}return t}computeWorldMatrix(t){return this._i||(this._i=R.Identity()),this._i}dispose(t,i=!1){if(this.vi.li=!0,!t){const e=this.getDescendants(!0);for(const s of e)s.dispose(t,i)}this.parent?this.parent=null:this.Vi(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const t of this.Oi)t.detach();this.Oi.length=0,this.metadata=null}static ParseAnimationRanges(t,i,e){if(i.ranges)for(let e=0;e<i.ranges.length;e++){const s=i.ranges[e];t.createAnimationRange(s.name,s.from,s.to)}}getHierarchyBoundingVectors(t=!0,i=null){let e,s;this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);const n=this;if(n.getBoundingInfo&&n.subMeshes){const t=n.getBoundingInfo();e=t.boundingBox.minimumWorld.clone(),s=t.boundingBox.maximumWorld.clone()}else e=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new w(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(t){const t=this.getDescendants(!1);for(const n of t){const t=n;if(t.computeWorldMatrix(!0),i&&!i(t))continue;if(!t.getBoundingInfo||0===t.getTotalVertices())continue;const r=t.getBoundingInfo().boundingBox,h=r.minimumWorld,o=r.maximumWorld;w.CheckExtends(h,e,s),w.CheckExtends(o,e,s)}}return{min:e,max:s}}}dt.Ki=(t,i,e)=>{throw X("AnimationRange")},dt.Bi={},ut([Q()],dt.prototype,"name",void 0),ut([Q()],dt.prototype,"id",void 0),ut([Q()],dt.prototype,"uniqueId",void 0),ut([Q()],dt.prototype,"state",void 0),ut([Q()],dt.prototype,"metadata",void 0);class pt{constructor(t,i){this.width=t,this.height=i}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let t=0|this.width;return t=397*t^(0|this.height),t}copyFrom(t){this.width=t.width,this.height=t.height}copyFromFloats(t,i){return this.width=t,this.height=i,this}set(t,i){return this.copyFromFloats(t,i)}multiplyByFloats(t,i){return new pt(this.width*t,this.height*i)}clone(){return new pt(this.width,this.height)}equals(t){return!!t&&(this.width===t.width&&this.height===t.height)}get surface(){return this.width*this.height}static Zero(){return new pt(0,0)}add(t){return new pt(this.width+t.width,this.height+t.height)}subtract(t){return new pt(this.width-t.width,this.height-t.height)}static Lerp(t,i,e){const s=t.width+(i.width-t.width)*e,n=t.height+(i.height-t.height)*e;return new pt(s,n)}}class mt{constructor(){this.qi="undefined"!=typeof _native&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest,this.Qi=""}Zi(){if(!this.Ji(this.Qi))for(const t in mt.CustomRequestHeaders){const i=mt.CustomRequestHeaders[t];i&&this.qi.setRequestHeader(t,i)}}Ji(t){return mt.SkipRequestModificationForBabylonCDN&&(t.includes("preview.babylonjs.com")||t.includes("cdn.babylonjs.com"))}get onprogress(){return this.qi.onprogress}set onprogress(t){this.qi.onprogress=t}get readyState(){return this.qi.readyState}get status(){return this.qi.status}get statusText(){return this.qi.statusText}get response(){return this.qi.response}get responseURL(){return this.qi.responseURL}get responseText(){return this.qi.responseText}get responseType(){return this.qi.responseType}set responseType(t){this.qi.responseType=t}get timeout(){return this.qi.timeout}set timeout(t){this.qi.timeout=t}addEventListener(t,i,e){this.qi.addEventListener(t,i,e)}removeEventListener(t,i,e){this.qi.removeEventListener(t,i,e)}abort(){this.qi.abort()}send(t){mt.CustomRequestHeaders&&this.Zi(),this.qi.send(t)}open(t,i){for(const t of mt.CustomRequestModifiers){if(this.Ji(i))return;t(this.qi,i)}return i=(i=i.replace("file:http:","http:")).replace("file:https:","https:"),this.Qi=i,this.qi.open(t,i,!0)}setRequestHeader(t,i){this.qi.setRequestHeader(t,i)}getResponseHeader(t){return this.qi.getResponseHeader(t)}}mt.CustomRequestHeaders={},mt.CustomRequestModifiers=new Array,mt.SkipRequestModificationForBabylonCDN=!0;class vt{constructor(t,i,e,s,n,r){this.name=t,this.targetProperty=i,this.framePerSecond=e,this.dataType=s,this.loopMode=n,this.enableBlending=r,this.te=null,this.ie=new Array,this.ee=new Array,this.blendingSpeed=.01,this.Ei={},this.targetPropertyPath=i.split("."),this.dataType=s,this.loopMode=void 0===n?vt.ANIMATIONLOOPMODE_CYCLE:n,this.uniqueId=vt.se++}static ne(t,i,e,s,n,r,h,o){let a;if(!isNaN(parseFloat(n))&&isFinite(n)?a=vt.ANIMATIONTYPE_FLOAT:n instanceof T?a=vt.ANIMATIONTYPE_QUATERNION:n instanceof w?a=vt.ANIMATIONTYPE_VECTOR3:n instanceof C?a=vt.ANIMATIONTYPE_VECTOR2:n instanceof _?a=vt.ANIMATIONTYPE_COLOR3:n instanceof y?a=vt.ANIMATIONTYPE_COLOR4:n instanceof pt&&(a=vt.ANIMATIONTYPE_SIZE),null==a)return null;const l=new vt(t,i,e,a,h),c=[{frame:0,value:n},{frame:s,value:r}];return l.setKeys(c),void 0!==o&&l.setEasingFunction(o),l}static CreateAnimation(t,i,e,s){const n=new vt(t+"Animation",t,e,i,vt.ANIMATIONLOOPMODE_CONSTANT);return n.setEasingFunction(s),n}static CreateAndStartAnimation(t,i,e,s,n,r,h,o,a,l,c){const u=vt.ne(t,e,s,n,r,h,o,a);return u?(i.getScene&&(c=i.getScene()),c?c.beginDirectAnimation(i,[u],0,n,1===u.loopMode,1,l):null):null}static CreateAndStartHierarchyAnimation(t,i,e,s,n,r,h,o,a,l,c){const u=vt.ne(t,s,n,r,h,o,a,l);if(!u)return null;return i.getScene().beginDirectHierarchyAnimation(i,e,[u],0,r,1===u.loopMode,1,c)}static CreateMergeAndStartAnimation(t,i,e,s,n,r,h,o,a,l){const c=vt.ne(t,e,s,n,r,h,o,a);return c?(i.animations.push(c),i.getScene().beginAnimation(i,0,n,1===c.loopMode,1,l)):null}static MakeAnimationAdditive(t,i=0,e,s=!1,n){let r=t;if(s&&(r=t.clone(),r.name=n||r.name),!r.re.length)return r;i=i>=0?i:0;let h=0;const o=r.re[0];let a=r.re.length-1;const l=r.re[a],c={referenceValue:o.value,referencePosition:M.Vector3[0],referenceQuaternion:M.Quaternion[0],referenceScaling:M.Vector3[1],keyPosition:M.Vector3[2],keyQuaternion:M.Quaternion[1],keyScaling:M.Vector3[3]};let u=!1,f=o.frame,d=l.frame;if(e){const t=r.getRange(e);t&&(f=t.from,d=t.to)}let p=o.frame===f,m=l.frame===d;if(1===r.re.length){const t=r.he(r.re[0]);c.referenceValue=t.clone?t.clone():t,u=!0}else if(i<=o.frame){const t=r.he(o.value);c.referenceValue=t.clone?t.clone():t,u=!0}else if(i>=l.frame){const t=r.he(l.value);c.referenceValue=t.clone?t.clone():t,u=!0}let v=0;for(;!u||!p||!m&&v<r.re.length-1;){const t=r.re[v],e=r.re[v+1];if(!u&&i>=t.frame&&i<=e.frame){let s;if(i===t.frame)s=r.he(t.value);else if(i===e.frame)s=r.he(e.value);else{const t={key:v,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT};s=r.oe(i,t)}c.referenceValue=s.clone?s.clone():s,u=!0}if(!p&&f>=t.frame&&f<=e.frame){if(f===t.frame)h=v;else if(f===e.frame)h=v+1;else{const t={key:v,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},i=r.oe(f,t),e={frame:f,value:i.clone?i.clone():i};r.re.splice(v+1,0,e),h=v+1}p=!0}if(!m&&d>=t.frame&&d<=e.frame){if(d===t.frame)a=v;else if(d===e.frame)a=v+1;else{const t={key:v,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},i=r.oe(d,t),e={frame:d,value:i.clone?i.clone():i};r.re.splice(v+1,0,e),a=v+1}m=!0}v++}for(r.dataType===vt.ANIMATIONTYPE_QUATERNION?c.referenceValue.normalize().conjugateInPlace():r.dataType===vt.ANIMATIONTYPE_MATRIX&&(c.referenceValue.decompose(c.referenceScaling,c.referenceQuaternion,c.referencePosition),c.referenceQuaternion.normalize().conjugateInPlace()),v=h;v<=a;v++){const t=r.re[v];if(!v||r.dataType===vt.ANIMATIONTYPE_FLOAT||t.value!==o.value)switch(r.dataType){case vt.ANIMATIONTYPE_MATRIX:t.value.decompose(c.keyScaling,c.keyQuaternion,c.keyPosition),c.keyPosition.subtractInPlace(c.referencePosition),c.keyScaling.divideInPlace(c.referenceScaling),c.referenceQuaternion.multiplyToRef(c.keyQuaternion,c.keyQuaternion),R.ComposeToRef(c.keyScaling,c.keyQuaternion,c.keyPosition,t.value);break;case vt.ANIMATIONTYPE_QUATERNION:c.referenceValue.multiplyToRef(t.value,t.value);break;case vt.ANIMATIONTYPE_VECTOR2:case vt.ANIMATIONTYPE_VECTOR3:case vt.ANIMATIONTYPE_COLOR3:case vt.ANIMATIONTYPE_COLOR4:t.value.subtractToRef(c.referenceValue,t.value);break;case vt.ANIMATIONTYPE_SIZE:t.value.width-=c.referenceValue.width,t.value.height-=c.referenceValue.height;break;default:t.value-=c.referenceValue}}return r}static TransitionTo(t,i,e,s,n,r,h,o=null){if(h<=0)return e[t]=i,o&&o(),null;const a=n*(h/1e3);r.setKeys([{frame:0,value:e[t].clone?e[t].clone():e[t]},{frame:a,value:i}]),e.animations||(e.animations=[]),e.animations.push(r);const l=s.beginAnimation(e,0,a,!1);return l.onAnimationEnd=o,l}get runtimeAnimations(){return this.ie}get hasRunningRuntimeAnimations(){for(const t of this.ie)if(!t.isStopped())return!0;return!1}toString(t){let i="Name: "+this.name+", property: "+this.targetProperty;if(i+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],i+=", nKeys: "+(this.re?this.re.length:"none"),i+=", nRanges: "+(this.Ei?Object.keys(this.Ei).length:"none"),t){i+=", Ranges: {";let t=!0;for(const e in this.Ei)t&&(i+=", ",t=!1),i+=e;i+="}"}return i}addEvent(t){this.ee.push(t),this.ee.sort(((t,i)=>t.frame-i.frame))}removeEvents(t){for(let i=0;i<this.ee.length;i++)this.ee[i].frame===t&&(this.ee.splice(i,1),i--)}getEvents(){return this.ee}createRange(t,i,e){this.Ei[t]||(this.Ei[t]=new ct(t,i,e))}deleteRange(t,i=!0){const e=this.Ei[t];if(e){if(i){const t=e.from,i=e.to;for(let e=this.re.length-1;e>=0;e--)this.re[e].frame>=t&&this.re[e].frame<=i&&this.re.splice(e,1)}this.Ei[t]=null}}getRange(t){return this.Ei[t]}getKeys(){return this.re}getHighestFrame(){let t=0;for(let i=0,e=this.re.length;i<e;i++)t<this.re[i].frame&&(t=this.re[i].frame);return t}getEasingFunction(){return this.te}setEasingFunction(t){this.te=t}floatInterpolateFunction(t,i,e){return o.Lerp(t,i,e)}floatInterpolateFunctionWithTangents(t,i,e,s,n){return o.Hermite(t,i,e,s,n)}quaternionInterpolateFunction(t,i,e){return T.Slerp(t,i,e)}quaternionInterpolateFunctionWithTangents(t,i,e,s,n){return T.Hermite(t,i,e,s,n).normalize()}vector3InterpolateFunction(t,i,e){return w.Lerp(t,i,e)}vector3InterpolateFunctionWithTangents(t,i,e,s,n){return w.Hermite(t,i,e,s,n)}vector2InterpolateFunction(t,i,e){return C.Lerp(t,i,e)}vector2InterpolateFunctionWithTangents(t,i,e,s,n){return C.Hermite(t,i,e,s,n)}sizeInterpolateFunction(t,i,e){return pt.Lerp(t,i,e)}color3InterpolateFunction(t,i,e){return _.Lerp(t,i,e)}color3InterpolateFunctionWithTangents(t,i,e,s,n){return _.Hermite(t,i,e,s,n)}color4InterpolateFunction(t,i,e){return y.Lerp(t,i,e)}color4InterpolateFunctionWithTangents(t,i,e,s,n){return y.Hermite(t,i,e,s,n)}he(t){return"function"==typeof t?t():t}evaluate(t){return this.oe(t,{key:0,repeatCount:0,loopMode:vt.ANIMATIONLOOPMODE_CONSTANT})}oe(t,i){if(i.loopMode===vt.ANIMATIONLOOPMODE_CONSTANT&&i.repeatCount>0)return i.highLimitValue.clone?i.highLimitValue.clone():i.highLimitValue;const e=this.re,s=e.length;let n=i.key;for(;n>=0&&t<e[n].frame;)--n;for(;n+1<=s-1&&t>=e[n+1].frame;)++n;if(i.key=n,n<0)return this.he(e[0].value);if(n+1>s-1)return this.he(e[s-1].value);const r=e[n],h=e[n+1],o=this.he(r.value),a=this.he(h.value);if(r.interpolation===lt.STEP)return h.frame>t?o:a;const l=void 0!==r.outTangent&&void 0!==h.inTangent,c=h.frame-r.frame;let u=(t-r.frame)/c;const f=this.getEasingFunction();switch(null!==f&&(u=f.ease(u)),this.dataType){case vt.ANIMATIONTYPE_FLOAT:{const t=l?this.floatInterpolateFunctionWithTangents(o,r.outTangent*c,a,h.inTangent*c,u):this.floatInterpolateFunction(o,a,u);switch(i.loopMode){case vt.ANIMATIONLOOPMODE_CYCLE:case vt.ANIMATIONLOOPMODE_CONSTANT:return t;case vt.ANIMATIONLOOPMODE_RELATIVE:return i.offsetValue*i.repeatCount+t}break}case vt.ANIMATIONTYPE_QUATERNION:{const t=l?this.quaternionInterpolateFunctionWithTangents(o,r.outTangent.scale(c),a,h.inTangent.scale(c),u):this.quaternionInterpolateFunction(o,a,u);switch(i.loopMode){case vt.ANIMATIONLOOPMODE_CYCLE:case vt.ANIMATIONLOOPMODE_CONSTANT:return t;case vt.ANIMATIONLOOPMODE_RELATIVE:return t.addInPlace(i.offsetValue.scale(i.repeatCount))}return t}case vt.ANIMATIONTYPE_VECTOR3:{const t=l?this.vector3InterpolateFunctionWithTangents(o,r.outTangent.scale(c),a,h.inTangent.scale(c),u):this.vector3InterpolateFunction(o,a,u);switch(i.loopMode){case vt.ANIMATIONLOOPMODE_CYCLE:case vt.ANIMATIONLOOPMODE_CONSTANT:return t;case vt.ANIMATIONLOOPMODE_RELATIVE:return t.add(i.offsetValue.scale(i.repeatCount))}break}case vt.ANIMATIONTYPE_VECTOR2:{const t=l?this.vector2InterpolateFunctionWithTangents(o,r.outTangent.scale(c),a,h.inTangent.scale(c),u):this.vector2InterpolateFunction(o,a,u);switch(i.loopMode){case vt.ANIMATIONLOOPMODE_CYCLE:case vt.ANIMATIONLOOPMODE_CONSTANT:return t;case vt.ANIMATIONLOOPMODE_RELATIVE:return t.add(i.offsetValue.scale(i.repeatCount))}break}case vt.ANIMATIONTYPE_SIZE:switch(i.loopMode){case vt.ANIMATIONLOOPMODE_CYCLE:case vt.ANIMATIONLOOPMODE_CONSTANT:return this.sizeInterpolateFunction(o,a,u);case vt.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(o,a,u).add(i.offsetValue.scale(i.repeatCount))}break;case vt.ANIMATIONTYPE_COLOR3:{const t=l?this.color3InterpolateFunctionWithTangents(o,r.outTangent.scale(c),a,h.inTangent.scale(c),u):this.color3InterpolateFunction(o,a,u);switch(i.loopMode){case vt.ANIMATIONLOOPMODE_CYCLE:case vt.ANIMATIONLOOPMODE_CONSTANT:return t;case vt.ANIMATIONLOOPMODE_RELATIVE:return t.add(i.offsetValue.scale(i.repeatCount))}break}case vt.ANIMATIONTYPE_COLOR4:{const t=l?this.color4InterpolateFunctionWithTangents(o,r.outTangent.scale(c),a,h.inTangent.scale(c),u):this.color4InterpolateFunction(o,a,u);switch(i.loopMode){case vt.ANIMATIONLOOPMODE_CYCLE:case vt.ANIMATIONLOOPMODE_CONSTANT:return t;case vt.ANIMATIONLOOPMODE_RELATIVE:return t.add(i.offsetValue.scale(i.repeatCount))}break}case vt.ANIMATIONTYPE_MATRIX:switch(i.loopMode){case vt.ANIMATIONLOOPMODE_CYCLE:case vt.ANIMATIONLOOPMODE_CONSTANT:return vt.AllowMatricesInterpolation?this.matrixInterpolateFunction(o,a,u,i.workValue):o;case vt.ANIMATIONLOOPMODE_RELATIVE:return o}}return 0}matrixInterpolateFunction(t,i,e,s){return vt.AllowMatrixDecomposeForInterpolation?s?(R.DecomposeLerpToRef(t,i,e,s),s):R.DecomposeLerp(t,i,e):s?(R.LerpToRef(t,i,e,s),s):R.Lerp(t,i,e)}clone(){const t=new vt(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(t.enableBlending=this.enableBlending,t.blendingSpeed=this.blendingSpeed,this.re&&t.setKeys(this.re),this.Ei){t.Ei={};for(const i in this.Ei){const e=this.Ei[i];e&&(t.Ei[i]=e.clone())}}return t}setKeys(t){this.re=t.slice(0)}serialize(){const t={};t.name=this.name,t.property=this.targetProperty,t.framePerSecond=this.framePerSecond,t.dataType=this.dataType,t.loopBehavior=this.loopMode,t.enableBlending=this.enableBlending,t.blendingSpeed=this.blendingSpeed;const i=this.dataType;t.keys=[];const e=this.getKeys();for(let s=0;s<e.length;s++){const n=e[s],r={};switch(r.frame=n.frame,i){case vt.ANIMATIONTYPE_FLOAT:r.values=[n.value],void 0!==n.inTangent&&r.values.push(n.inTangent),void 0!==n.outTangent&&(void 0===n.inTangent&&r.values.push(void 0),r.values.push(n.outTangent)),void 0!==n.interpolation&&(void 0===n.inTangent&&r.values.push(void 0),void 0===n.outTangent&&r.values.push(void 0),r.values.push(n.interpolation));break;case vt.ANIMATIONTYPE_QUATERNION:case vt.ANIMATIONTYPE_MATRIX:case vt.ANIMATIONTYPE_VECTOR3:case vt.ANIMATIONTYPE_COLOR3:case vt.ANIMATIONTYPE_COLOR4:r.values=n.value.asArray(),null!=n.inTangent&&r.values.push(n.inTangent.asArray()),null!=n.outTangent&&(void 0===n.inTangent&&r.values.push(void 0),r.values.push(n.outTangent.asArray())),void 0!==n.interpolation&&(void 0===n.inTangent&&r.values.push(void 0),void 0===n.outTangent&&r.values.push(void 0),r.values.push(n.interpolation))}t.keys.push(r)}t.ranges=[];for(const i in this.Ei){const e=this.Ei[i];if(!e)continue;const s={};s.name=i,s.from=e.from,s.to=e.to,t.ranges.push(s)}return t}static ae(t,i,e){const s=t.constructor;return s.Lerp?s.Lerp(t,i,e):s.Slerp?s.Slerp(t,i,e):t.toFixed?t*(1-e)+e*i:i}static Parse(t){const i=new vt(t.name,t.property,t.framePerSecond,t.dataType,t.loopBehavior),e=t.dataType,s=[];let n,r;for(t.enableBlending&&(i.enableBlending=t.enableBlending),t.blendingSpeed&&(i.blendingSpeed=t.blendingSpeed),r=0;r<t.keys.length;r++){const i=t.keys[r];let h,o,a;switch(e){case vt.ANIMATIONTYPE_FLOAT:n=i.values[0],i.values.length>=2&&(h=i.values[1]),i.values.length>=3&&(o=i.values[2]),i.values.length>=4&&(a=i.values[3]);break;case vt.ANIMATIONTYPE_QUATERNION:if(n=T.FromArray(i.values),i.values.length>=8){const t=T.FromArray(i.values.slice(4,8));t.equals(T.Zero())||(h=t)}if(i.values.length>=12){const t=T.FromArray(i.values.slice(8,12));t.equals(T.Zero())||(o=t)}i.values.length>=13&&(a=i.values[12]);break;case vt.ANIMATIONTYPE_MATRIX:n=R.FromArray(i.values),i.values.length>=17&&(a=i.values[16]);break;case vt.ANIMATIONTYPE_COLOR3:n=_.FromArray(i.values),i.values[3]&&(h=_.FromArray(i.values[3])),i.values[4]&&(o=_.FromArray(i.values[4])),i.values[5]&&(a=i.values[5]);break;case vt.ANIMATIONTYPE_COLOR4:n=y.FromArray(i.values),i.values[4]&&(h=y.FromArray(i.values[4])),i.values[5]&&(o=y.FromArray(i.values[5])),i.values[6]&&(a=y.FromArray(i.values[6]));break;case vt.ANIMATIONTYPE_VECTOR3:default:n=w.FromArray(i.values),i.values[3]&&(h=w.FromArray(i.values[3])),i.values[4]&&(o=w.FromArray(i.values[4])),i.values[5]&&(a=i.values[5])}const l={};l.frame=i.frame,l.value=n,null!=h&&(l.inTangent=h),null!=o&&(l.outTangent=o),null!=a&&(l.interpolation=a),s.push(l)}if(i.setKeys(s),t.ranges)for(r=0;r<t.ranges.length;r++)n=t.ranges[r],i.createRange(n.name,n.from,n.to);return i}static AppendSerializedAnimations(t,i){ot.AppendSerializedAnimations(t,i)}static ParseFromFileAsync(t,i){return new Promise(((e,s)=>{const n=new mt;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){let i=JSON.parse(n.responseText);if(i.animations&&(i=i.animations),i.length){const t=new Array;for(const e of i)t.push(this.Parse(e));e(t)}else{const s=this.Parse(i);t&&(s.name=t),e(s)}}else s("Unable to load the animation")})),n.open("GET",i),n.send()}))}static ParseFromSnippetAsync(t){return new Promise(((i,e)=>{const s=new mt;s.addEventListener("readystatechange",(()=>{if(4==s.readyState)if(200==s.status){const e=JSON.parse(JSON.parse(s.responseText).jsonPayload);if(e.animations){const s=JSON.parse(e.animations),n=new Array;for(const i of s.animations){const e=this.Parse(i);e.snippetId=t,n.push(e)}i(n)}else{const s=JSON.parse(e.animation),n=this.Parse(s);n.snippetId=t,i(n)}}else e("Unable to load the snippet "+t)})),s.open("GET",this.SnippetUrl+"/"+t.replace(/#/g,"/")),s.send()}))}}vt.se=0,vt.AllowMatricesInterpolation=!1,vt.AllowMatrixDecomposeForInterpolation=!0,vt.SnippetUrl="https://snippet.babylonjs.com",vt.ANIMATIONTYPE_FLOAT=0,vt.ANIMATIONTYPE_VECTOR3=1,vt.ANIMATIONTYPE_QUATERNION=2,vt.ANIMATIONTYPE_MATRIX=3,vt.ANIMATIONTYPE_COLOR3=4,vt.ANIMATIONTYPE_COLOR4=7,vt.ANIMATIONTYPE_VECTOR2=5,vt.ANIMATIONTYPE_SIZE=6,vt.ANIMATIONLOOPMODE_RELATIVE=0,vt.ANIMATIONLOOPMODE_CYCLE=1,vt.ANIMATIONLOOPMODE_CONSTANT=2,vt.CreateFromSnippetAsync=vt.ParseFromSnippetAsync,v("BABYLON.Animation",vt),dt.Ki=(t,i,e)=>new ct(t,i,e);v("BABYLON.InterpolateValueAction",class extends P{constructor(t,i,e,s,n=1e3,r,o,a){super(t,r),this.duration=1e3,this.onInterpolationDoneObservable=new h,this.propertyPath=e,this.value=s,this.duration=n,this.stopOtherAnimations=o,this.onInterpolationDone=a,this.Pt=this.Dt=i}dt(){this.Dt=this.xt(this.Dt,this.propertyPath),this.Lt=this.wt(this.propertyPath)}execute(){const t=this.gt.getScene(),i=[{frame:0,value:this.Dt[this.Lt]},{frame:100,value:this.value}];let e;if("number"==typeof this.value)e=vt.ANIMATIONTYPE_FLOAT;else if(this.value instanceof _)e=vt.ANIMATIONTYPE_COLOR3;else if(this.value instanceof w)e=vt.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof R)e=vt.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof T))return void F.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");e=vt.ANIMATIONTYPE_QUATERNION}const s=new vt("InterpolateValueAction",this.Lt,1e3/this.duration*100,e,vt.ANIMATIONLOOPMODE_CONSTANT);s.setKeys(i),this.stopOtherAnimations&&t.stopAnimation(this.Dt);t.beginDirectAnimation(this.Dt,[s],0,100,!1,1,(()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()}))}serialize(t){return super.Tt({name:"InterpolateValueAction",properties:[P.It(this.Pt),{name:"propertyPath",value:this.propertyPath},{name:"value",value:P.Rt(this.value)},{name:"duration",value:P.Rt(this.duration)},{name:"stopOtherAnimations",value:P.Rt(this.stopOtherAnimations)||!1}]},t)}});const gt=Object.freeze(new T(0,0,0,0)),St=Object.freeze(w.Zero()),Et=Object.freeze(C.Zero()),At=Object.freeze(pt.Zero()),Ct=Object.freeze(_.Black());class wt{constructor(t,i,e,s){if(this.ee=new Array,this.le=0,this.ce=new Array,this.ue=null,this.fe={},this.de={},this.pe=!1,this.me=0,this.ve=null,this.ge=null,this.Se=null,this.Ee="",this.Ae=1,this.Ce=0,this.we=0,this.xe=0,this.Te=!1,this.Re=i,this.Pt=t,this.Kt=e,this.Ie=s,this.Me=[],i.ie.push(this),this.be={key:0,repeatCount:0,loopMode:this._e()},this.Re.dataType===vt.ANIMATIONTYPE_MATRIX&&(this.be.workValue=R.Zero()),this.re=this.Re.getKeys(),this.ye=this.re[0].frame,this.Ne=this.re[this.re.length-1].frame,this.Pe=this.re[0].value,this.De=this.re[this.re.length-1].value,0!==this.ye){const t={frame:0,value:this.Pe};this.re.splice(0,0,t)}if(this.Pt instanceof Array){let t=0;for(const i of this.Pt)this.Le(i,t),this.Oe(t),t++;this.Te=!0}else this.Le(this.Pt),this.Oe(),this.Te=!1,this.Se=this.Me[0];const n=i.getEvents();n&&n.length>0&&n.forEach((t=>{this.ee.push(t.Fe())})),this.Be=t&&t.animationPropertiesOverride?t.animationPropertiesOverride.enableBlending:this.Re.enableBlending}get currentFrame(){return this.le}get weight(){return this.Ae}get currentValue(){return this.ve}get targetPath(){return this.Ee}get target(){return this.ge}get isAdditive(){return this.Ie&&this.Ie.isAdditive}Le(t,i=0){const e=this.Re.targetPropertyPath;if(e.length>1){let s=t[e[0]];for(let t=1;t<e.length-1;t++)s=s[e[t]];this.Ee=e[e.length-1],this.Me[i]=s}else this.Ee=e[0],this.Me[i]=t}get animation(){return this.Re}reset(t=!1){if(t)if(this.Pt instanceof Array){let t=0;for(const i of this.Pt)void 0!==this.ce[t]&&this.Ue(i,this.Me[t],this.ce[t],-1,t),t++}else void 0!==this.ce[0]&&this.Ue(this.Pt,this.Se,this.ce[0],-1,0);this.fe={},this.de={},this.le=0,this.me=0;for(let t=0;t<this.ee.length;t++)this.ee[t].isDone=!1}isStopped(){return this.pe}dispose(){const t=this.Re.runtimeAnimations.indexOf(this);t>-1&&this.Re.runtimeAnimations.splice(t,1)}setValue(t,i){if(this.Te)for(let e=0;e<this.Pt.length;e++){const s=this.Pt[e];this.Ue(s,this.Me[e],t,i,e)}else this.Ue(this.Pt,this.Se,t,i,0)}Oe(t=0){let i;const e=this.Me[t];i=e.getRestPose&&"_matrix"===this.Ee?e.getRestPose():e[this.Ee],i&&i.clone?this.ce[t]=i.clone():this.ce[t]=i}Ue(t,i,e,s,n){if(this.ge=i,this.Ae=s,this.Be&&this.me<=1){if(!this.ue){const t=i[this.Ee];t.clone?this.ue=t.clone():this.ue=t}this.ue.m?vt.AllowMatrixDecomposeForInterpolation?this.ve?R.DecomposeLerpToRef(this.ue,e,this.me,this.ve):this.ve=R.DecomposeLerp(this.ue,e,this.me):this.ve?R.LerpToRef(this.ue,e,this.me,this.ve):this.ve=R.Lerp(this.ue,e,this.me):this.ve=vt.ae(this.ue,e,this.me);const s=t&&t.animationPropertiesOverride?t.animationPropertiesOverride.blendingSpeed:this.Re.blendingSpeed;this.me+=s}else this.ve?this.ve.copyFrom?this.ve.copyFrom(e):this.ve=e:(null==e?void 0:e.clone)?this.ve=e.clone():this.ve=e;-1!==s?this.Kt.Ve(this,this.ce[n]):i[this.Ee]=this.ve,t.markAsDirty&&t.markAsDirty(this.Re.targetProperty)}_e(){return this.Pt&&this.Pt.animationPropertiesOverride?this.Pt.animationPropertiesOverride.loopMode:this.Re.loopMode}goToFrame(t){const i=this.Re.getKeys();t<i[0].frame?t=i[0].frame:t>i[i.length-1].frame&&(t=i[i.length-1].frame);const e=this.ee;if(e.length)for(let i=0;i<e.length;i++)e[i].onlyOnce||(e[i].isDone=e[i].frame<t);this.le=t;const s=this.Re.oe(t,this.be);this.setValue(s,-1)}ke(t){const i=this.we*(this.Re.framePerSecond*t)/1e3;this.Ce=this.xe-i}animate(t,i,e,s,n,r=-1){const h=this.Re,o=h.targetPropertyPath;if(!o||o.length<1)return this.pe=!0,!1;let a=!0;(i<this.ye||i>this.Ne)&&(i=this.ye),(e<this.ye||e>this.Ne)&&(e=this.Ne);const l=e-i;let c;const u=t*(h.framePerSecond*n)/1e3+this.Ce;let f,d=0;if(this.we=t,this.xe=u,!s&&e>=i&&u>=l)a=!1,d=h.he(this.De);else if(!s&&i>=e&&u<=l)a=!1,d=h.he(this.Pe);else if(this.be.loopMode!==vt.ANIMATIONLOOPMODE_CYCLE){const t=e.toString()+i.toString();if(!this.fe[t]){this.be.repeatCount=0,this.be.loopMode=vt.ANIMATIONLOOPMODE_CYCLE;const s=h.oe(i,this.be),n=h.oe(e,this.be);switch(this.be.loopMode=this._e(),h.dataType){case vt.ANIMATIONTYPE_FLOAT:this.fe[t]=n-s;break;case vt.ANIMATIONTYPE_QUATERNION:case vt.ANIMATIONTYPE_VECTOR3:case vt.ANIMATIONTYPE_VECTOR2:case vt.ANIMATIONTYPE_SIZE:case vt.ANIMATIONTYPE_COLOR3:this.fe[t]=n.subtract(s)}this.de[t]=n}d=this.de[t],c=this.fe[t]}if(void 0===c)switch(h.dataType){case vt.ANIMATIONTYPE_FLOAT:c=0;break;case vt.ANIMATIONTYPE_QUATERNION:c=gt;break;case vt.ANIMATIONTYPE_VECTOR3:c=St;break;case vt.ANIMATIONTYPE_VECTOR2:c=Et;break;case vt.ANIMATIONTYPE_SIZE:c=At;break;case vt.ANIMATIONTYPE_COLOR3:c=Ct}if(this.Ie&&this.Ie.syncRoot){const t=this.Ie.syncRoot;f=i+(e-i)*((t.masterFrame-t.fromFrame)/(t.toFrame-t.fromFrame))}else f=u>0&&i>e||u<0&&i<e?a&&0!==l?e+u%l:i:a&&0!==l?i+u%l:e;const p=this.ee;if(n>0&&this.currentFrame>f||n<0&&this.currentFrame<f){this.Ge();for(let t=0;t<p.length;t++)p[t].onlyOnce||(p[t].isDone=!1);this.be.key=n>0?0:h.getKeys().length-1}this.le=f,this.be.repeatCount=0===l?0:u/l>>0,this.be.highLimitValue=d,this.be.offsetValue=c;const m=h.oe(f,this.be);if(this.setValue(m,r),p.length)for(let t=0;t<p.length;t++)if(l>0&&f>=p[t].frame&&p[t].frame>=i||l<0&&f<=p[t].frame&&p[t].frame<=i){const i=p[t];i.isDone||(i.onlyOnce&&(p.splice(t,1),t--),i.isDone=!0,i.action(f))}return a||(this.pe=!0),a}}function xt(){return"undefined"!=typeof window}function Tt(){return"undefined"!=typeof navigator}function Rt(){return"undefined"!=typeof document}function It(t){let i="",e=t.firstChild;for(;e;)3===e.nodeType&&(i+=e.textContent),e=e.nextSibling;return i}const Mt={IsWindowObjectExist:xt,IsNavigatorAvailable:Tt,IsDocumentAvailable:Rt,GetDOMTextContent:It};class bt{static get Now(){return Mt.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}class _t{}_t.FilesToLoad={};class yt extends Error{}yt.ze=Object.setPrototypeOf||((t,i)=>(t.__proto__=i,t));const Nt=0,Pt=1e3,Dt=3e3,Lt=4e3,Ot=4001,Ft=4002;class Bt extends yt{constructor(t,i,e){super(t),this.errorCode=i,this.innerError=e,this.name="RuntimeError",yt.ze(this,Bt.prototype)}}const Ut=t=>{const i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let e,s,n,r,h,o,a,l="",c=0;const u=ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):new Uint8Array(t);for(;c<u.length;)e=u[c++],s=c<u.length?u[c++]:Number.NaN,n=c<u.length?u[c++]:Number.NaN,r=e>>2,h=(3&e)<<4|s>>4,o=(15&s)<<2|n>>6,a=63&n,isNaN(s)?o=a=64:isNaN(n)&&(a=64),l+=i.charAt(r)+i.charAt(h)+i.charAt(o)+i.charAt(a);return l},Vt=t=>atob(t),kt=t=>{const i=Vt(t),e=i.length,s=new Uint8Array(new ArrayBuffer(e));for(let t=0;t<e;t++)s[t]=i.charCodeAt(t);return s.buffer};class Gt{constructor(){this.children=[]}isValid(t){return!0}process(t,i){var e,s,n,r,h,o;let a="";if(this.line){let l=this.line;const c=i.processor;if(c){c.lineProcessor&&(l=c.lineProcessor(l,i.isFragment,i.processingContext));const a=null!==(s=null===(e=i.processor)||void 0===e?void 0:e.attributeKeywordName)&&void 0!==s?s:"attribute",u=i.isFragment&&(null===(n=i.processor)||void 0===n?void 0:n.varyingFragmentKeywordName)?null===(r=i.processor)||void 0===r?void 0:r.varyingFragmentKeywordName:!i.isFragment&&(null===(h=i.processor)||void 0===h?void 0:h.varyingVertexKeywordName)?null===(o=i.processor)||void 0===o?void 0:o.varyingVertexKeywordName:"varying";if(!i.isFragment&&c.attributeProcessor&&this.line.startsWith(a))l=c.attributeProcessor(this.line,t,i.processingContext);else if(c.varyingProcessor&&this.line.startsWith(u))l=c.varyingProcessor(this.line,i.isFragment,t,i.processingContext);else if(c.uniformProcessor&&c.uniformRegexp&&c.uniformRegexp.test(this.line))i.lookForClosingBracketForUniformBuffer||(l=c.uniformProcessor(this.line,i.isFragment,t,i.processingContext));else if(c.uniformBufferProcessor&&c.uniformBufferRegexp&&c.uniformBufferRegexp.test(this.line))i.lookForClosingBracketForUniformBuffer||(l=c.uniformBufferProcessor(this.line,i.isFragment,i.processingContext),i.lookForClosingBracketForUniformBuffer=!0);else if(c.textureProcessor&&c.textureRegexp&&c.textureRegexp.test(this.line))l=c.textureProcessor(this.line,i.isFragment,t,i.processingContext);else if((c.uniformProcessor||c.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!i.lookForClosingBracketForUniformBuffer){/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?c.uniformProcessor&&(l=c.uniformProcessor(this.line,i.isFragment,t,i.processingContext)):c.uniformBufferProcessor&&(l=c.uniformBufferProcessor(this.line,i.isFragment,i.processingContext),i.lookForClosingBracketForUniformBuffer=!0)}i.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(i.lookForClosingBracketForUniformBuffer=!1,c.endOfUniformBufferProcessor&&(l=c.endOfUniformBufferProcessor(this.line,i.isFragment,i.processingContext)))}a+=l+"\r\n"}return this.children.forEach((e=>{a+=e.process(t,i)})),this.additionalDefineKey&&(t[this.additionalDefineKey]=this.additionalDefineValue||"true"),a}}class zt{constructor(){this.He=[]}get currentLine(){return this.He[this.lineIndex]}get canRead(){return this.lineIndex<this.He.length-1}set lines(t){this.He.length=0;for(const i of t){if("#"===i[0]){this.He.push(i);continue}if(i.trim().startsWith("//")){this.He.push(i);continue}const t=i.split(";");for(let i=0;i<t.length;i++){let e=t[i];e=e.trim(),e&&this.He.push(e+(i!==t.length-1?";":""))}}}}class Ht extends Gt{process(t,i){for(let e=0;e<this.children.length;e++){const s=this.children[e];if(s.isValid(t))return s.process(t,i)}return""}}class Xt extends Gt{isValid(t){return this.testExpression.isTrue(t)}}class Wt{isTrue(t){return!0}static postfixToInfix(t){const i=[];for(const e of t)if(void 0===Wt.Xe[e])i.push(e);else{const t=i[i.length-1],s=i[i.length-2];i.length-=2,i.push(`(${s}${e}${t})`)}return i[i.length-1]}static infixToPostfix(t){const i=[];let e=-1;const s=()=>{a=a.trim(),""!==a&&(i.push(a),a="")},n=t=>{e<Wt.We.length-1&&(Wt.We[++e]=t)},r=()=>Wt.We[e],h=()=>-1===e?"!!INVALID EXPRESSION!!":Wt.We[e--];let o=0,a="";for(;o<t.length;){const l=t.charAt(o),c=o<t.length-1?t.substr(o,2):"";if("("===l)a="",n(l);else if(")"===l){for(s();-1!==e&&"("!==r();)i.push(h());h()}else if(Wt.Xe[c]>1){for(s();-1!==e&&Wt.Xe[r()]>=Wt.Xe[c];)i.push(h());n(c),o++}else a+=l;o++}for(s();-1!==e;)"("===r()?h():i.push(h());return i}}Wt.Xe={")":0,"(":1,"||":2,"&&":3},Wt.We=["","","","","","","","","","","","","","","","","","","",""];class $t extends Wt{constructor(t,i=!1){super(),this.define=t,this.not=i}isTrue(t){let i=void 0!==t[this.define];return this.not&&(i=!i),i}}class Yt extends Wt{isTrue(t){return this.leftOperand.isTrue(t)||this.rightOperand.isTrue(t)}}class jt extends Wt{isTrue(t){return this.leftOperand.isTrue(t)&&this.rightOperand.isTrue(t)}}class Kt extends Wt{constructor(t,i,e){super(),this.define=t,this.operand=i,this.testValue=e}isTrue(t){let i=t[this.define];void 0===i&&(i=this.define);let e=!1;const s=parseInt(i),n=parseInt(this.testValue);switch(this.operand){case">":e=s>n;break;case"<":e=s<n;break;case"<=":e=s<=n;break;case">=":e=s>=n;break;case"==":e=s===n}return e}}var qt;!function(t){t[t.GLSL=0]="GLSL",t[t.WGSL=1]="WGSL"}(qt||(qt={}));const Qt=/defined\s*?\((.+?)\)/g,Zt=/defined\s*?\[(.+?)\]/g,Jt=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g;class ti{static Initialize(t){t.processor&&t.processor.initializeShaders&&t.processor.initializeShaders(t.processingContext)}static Process(t,i,e,s){var n;(null===(n=i.processor)||void 0===n?void 0:n.preProcessShaderCode)&&(t=i.processor.preProcessShaderCode(t,i.isFragment)),this.$e(t,i,(t=>{i.processCodeAfterIncludes&&(t=i.processCodeAfterIncludes(i.isFragment?"fragment":"vertex",t));const n=this.Ye(t,i,s);e(n,t)}))}static PreProcess(t,i,e,s){var n;(null===(n=i.processor)||void 0===n?void 0:n.preProcessShaderCode)&&(t=i.processor.preProcessShaderCode(t,i.isFragment)),this.$e(t,i,(t=>{i.processCodeAfterIncludes&&(t=i.processCodeAfterIncludes(i.isFragment?"fragment":"vertex",t));const n=this.je(t,i,s);e(n,t)}))}static Finalize(t,i,e){return e.processor&&e.processor.finalizeShaders?e.processor.finalizeShaders(t,i,e.processingContext):{vertexCode:t,fragmentCode:i}}static Ke(t,i){var e;if(null===(e=i.processor)||void 0===e?void 0:e.noPrecision)return t;const s=i.shouldUseHighPrecisionShader;return-1===t.indexOf("precision highp float")?t=s?"precision highp float;\n"+t:"precision mediump float;\n"+t:s||(t=t.replace("precision highp float","precision mediump float")),t}static qe(t){const i=/defined\((.+)\)/.exec(t);if(i&&i.length)return new $t(i[1].trim(),"!"===t[0]);const e=["==",">=","<=","<",">"];let s="",n=0;for(s of e)if(n=t.indexOf(s),n>-1)break;if(-1===n)return new $t(t);const r=t.substring(0,n).trim(),h=t.substring(n+s.length).trim();return new Kt(r,s,h)}static Qe(t){t=t.replace(Qt,"defined[$1]");const i=Wt.infixToPostfix(t),e=[];for(const t of i)if("||"!==t&&"&&"!==t)e.push(t);else if(e.length>=2){let i=e[e.length-1],s=e[e.length-2];e.length-=2;const n="&&"==t?new jt:new Yt;"string"==typeof i&&(i=i.replace(Zt,"defined($1)")),"string"==typeof s&&(s=s.replace(Zt,"defined($1)")),n.leftOperand="string"==typeof s?this.qe(s):s,n.rightOperand="string"==typeof i?this.qe(i):i,e.push(n)}let s=e[e.length-1];return"string"==typeof s&&(s=s.replace(Zt,"defined($1)")),"string"==typeof s?this.qe(s):s}static Ze(t,i){const e=new Xt,s=t.substring(0,i);let n=t.substring(i);return n=n.substring(0,(n.indexOf("//")+1||n.length+1)-1).trim(),e.testExpression="#ifdef"===s?new $t(n):"#ifndef"===s?new $t(n,!0):this.Qe(n),e}static Je(t,i,e){let s=t.currentLine;for(;this.ts(t,e);){s=t.currentLine;const n=s.substring(0,5).toLowerCase();if("#else"===n){const e=new Gt;return i.children.push(e),void this.ts(t,e)}if("#elif"===n){const t=this.Ze(s,5);i.children.push(t),e=t}}}static ts(t,i){for(;t.canRead;){t.lineIndex++;const e=t.currentLine,s=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(e);if(s&&s.length){switch(s[0]){case"#ifdef":{const s=new Ht;i.children.push(s);const n=this.Ze(e,6);s.children.push(n),this.Je(t,s,n);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const s=new Ht;i.children.push(s);const n=this.Ze(e,7);s.children.push(n),this.Je(t,s,n);break}case"#if":{const s=new Ht,n=this.Ze(e,3);i.children.push(s),s.children.push(n),this.Je(t,s,n);break}}}else{const t=new Gt;if(t.line=e,i.children.push(t),"#"===e[0]&&"d"===e[1]){const i=e.replace(";","").split(" ");t.additionalDefineKey=i[1],3===i.length&&(t.additionalDefineValue=i[2])}}}return!1}static es(t,i,e){const s=new Gt,n=new zt;return n.lineIndex=-1,n.lines=t.split("\n"),this.ts(n,s),s.process(i,e)}static ss(t,i){var e;const s=t.defines,n={};for(const t of s){const i=t.replace("#define","").replace(";","").trim().split(" ");n[i[0]]=i.length>1?i[1]:""}return(null===(e=t.processor)||void 0===e?void 0:e.shaderLanguage)===qt.GLSL&&(n.GL_ES="true"),n.ns=t.version,n[t.platformName]="true",i.rs(n),n}static Ye(t,i,e){let s=this.Ke(t,i);if(!i.processor)return s;if(i.processor.shaderLanguage===qt.GLSL&&-1!==s.indexOf("#version 3")&&(s=s.replace("#version 300 es",""),!i.processor.parseGLES3))return s;const n=i.defines,r=this.ss(i,e);return i.processor.preProcessor&&(s=i.processor.preProcessor(s,n,i.isFragment,i.processingContext)),s=this.es(s,r,i),i.processor.postProcessor&&(s=i.processor.postProcessor(s,n,i.isFragment,i.processingContext,e)),e.hs.needShaderCodeInlining&&(s=e.inlineShaderCode(s)),s}static je(t,i,e){var s,n;let r=t;const h=i.defines,o=this.ss(i,e);return(null===(s=i.processor)||void 0===s?void 0:s.preProcessor)&&(r=i.processor.preProcessor(r,h,i.isFragment,i.processingContext)),r=this.es(r,o,i),(null===(n=i.processor)||void 0===n?void 0:n.postProcessor)&&(r=i.processor.postProcessor(r,h,i.isFragment,i.processingContext,e)),e.hs.needShaderCodeInlining&&(r=e.inlineShaderCode(r)),r}static $e(t,i,e){let s=Jt.exec(t),n=new String(t),r=!1;for(;null!=s;){let h=s[1];if(-1!==h.indexOf("__decl__")&&(h=h.replace(/__decl__/,""),i.supportsUniformBuffers&&(h=h.replace(/Vertex/,"Ubo"),h=h.replace(/Fragment/,"Ubo")),h+="Declaration"),!i.includesShadersStore[h]){const t=i.shadersRepository+"ShadersInclude/"+h+".fx";return void ti.os(t,(t=>{i.includesShadersStore[h]=t,this.$e(n,i,e)}))}{let t=i.includesShadersStore[h];if(s[2]){const i=s[3].split(",");for(let e=0;e<i.length;e+=2){const s=new RegExp(i[e],"g"),n=i[e+1];t=t.replace(s,n)}}if(s[4]){const e=s[5];if(-1!==e.indexOf("..")){const s=e.split(".."),n=parseInt(s[0]);let r=parseInt(s[1]),h=t.slice(0);t="",isNaN(r)&&(r=i.indexParameters[s[1]]);for(let e=n;e<r;e++)i.supportsUniformBuffers||(h=h.replace(/light\{X\}.(\w*)/g,((t,i)=>i+"{X}"))),t+=h.replace(/\{X\}/g,e.toString())+"\n"}else i.supportsUniformBuffers||(t=t.replace(/light\{X\}.(\w*)/g,((t,i)=>i+"{X}"))),t=t.replace(/\{X\}/g,e)}n=n.replace(s[0],t),r=r||t.indexOf("#include<")>=0||t.indexOf("#include <")>=0}s=Jt.exec(t)}r?this.$e(n.toString(),i,e):e(n)}static os(t,i,e,s,n,r){throw X("FileTools")}}class ii{static GetShadersRepository(t=qt.GLSL){return t===qt.GLSL?ii.ShadersRepository:ii.ShadersRepositoryWGSL}static GetShadersStore(t=qt.GLSL){return t===qt.GLSL?ii.ShadersStore:ii.ShadersStoreWGSL}static GetIncludesShadersStore(t=qt.GLSL){return t===qt.GLSL?ii.IncludesShadersStore:ii.IncludesShadersStoreWGSL}}ii.ShadersRepository="src/Shaders/",ii.ShadersStore={},ii.IncludesShadersStore={},ii.ShadersRepositoryWGSL="src/ShadersWGSL/",ii.ShadersStoreWGSL={},ii.IncludesShadersStoreWGSL={};class ei{constructor(t,i,e,s=null,n,r=null,o=null,a=null,l=null,c,u="",f=qt.GLSL){var d,p,m;let v;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new h,this.onErrorObservable=new h,this.ls=null,this.cs=!1,this.us=!1,this.fs=null,this.li=!1,this.ps=!1,this.vs={},this.gs=!1,this.Ss={},this.di=!1,this.Es="",this.As=!1,this.Cs={},this.ws="",this.xs=null,this.Ts="",this.Rs="",this.Is=null,this.Ms=null,this.bs="",this._s="",this.ys="",this.Ns="",this.Ps="",this.Ds="",this.name=t,this.ws=u;let g,S,E=null;if(i.attributes){const t=i;if(this.Ls=e,this.Os=t.attributes,this.Fs=t.uniformsNames.concat(t.samplers),this.Bs=t.samplers.slice(),this.defines=t.defines,this.onError=t.onError,this.onCompiled=t.onCompiled,this.xs=t.fallbacks,this.Us=t.indexParameters,this.Is=t.transformFeedbackVaryings||null,this.gs=!!t.multiTarget,this.Vs=null!==(d=t.shaderLanguage)&&void 0!==d?d:qt.GLSL,t.uniformBuffersNames){this.ks=t.uniformBuffersNames.slice();for(let i=0;i<t.uniformBuffersNames.length;i++)this.vs[t.uniformBuffersNames[i]]=i}E=null!==(p=t.processFinalCode)&&void 0!==p?p:null,v=null!==(m=t.processCodeAfterIncludes)&&void 0!==m?m:void 0}else this.Ls=n,this.defines=null==r?"":r,this.Fs=e.concat(s),this.Bs=s?s.slice():[],this.Os=i,this.ks=[],this.Vs=f,this.onError=l,this.onCompiled=a,this.Us=c,this.xs=o;this.Gs={},this.uniqueId=ei.zs++;const A=xt()?this.Ls.getHostDocument():null;t.vertexSource?g="source:"+t.vertexSource:t.vertexElement?(g=A?A.getElementById(t.vertexElement):null,g||(g=t.vertexElement)):g=t.vertex||t,t.fragmentSource?S="source:"+t.fragmentSource:t.fragmentElement?(S=A?A.getElementById(t.fragmentElement):null,S||(S=t.fragmentElement)):S=t.fragment||t,this.Hs=this.Ls.Xs(this.Vs);let C={defines:this.defines.split("\n"),indexParameters:this.Us,isFragment:!1,shouldUseHighPrecisionShader:this.Ls.Ws,processor:this.Ls.$s(this.Vs),supportsUniformBuffers:this.Ls.supportsUniformBuffers,shadersRepository:ii.GetShadersRepository(this.Vs),includesShadersStore:ii.GetIncludesShadersStore(this.Vs),version:(100*this.Ls.version).toString(),platformName:this.Ls.shaderPlatformName,processingContext:this.Hs,isNDCHalfZRange:this.Ls.isNDCHalfZRange,useReverseDepthBuffer:this.Ls.useReverseDepthBuffer,processCodeAfterIncludes:v};const w=[void 0,void 0],x=()=>{if(w[0]&&w[1]){C.isFragment=!0;const[i,e]=w;ti.Process(e,C,((e,s)=>{this.Ns=s,E&&(e=E("fragment",e));const n=ti.Finalize(i,e,C);C=null,this.Ys(n.vertexCode,n.fragmentCode,t)}),this.Ls)}};this.js(g,"Vertex","",(t=>{ti.Initialize(C),ti.Process(t,C,((i,e)=>{this.Ps=t,this.ys=e,E&&(i=E("vertex",i)),w[0]=i,x()}),this.Ls)})),this.js(S,"Fragment","Pixel",(t=>{this.Ds=t,w[1]=t,x()}));const T=function(t){return function(){if(this.Ms){this.Ms[t].apply(this.Ms,arguments)}return this}};["Int?","UInt?","IntArray?","UIntArray?","Array?","Color?","Vector?","Float?","Matrices","Matrix","Matrix3x3","Matrix2x2","Quaternion","DirectColor4"].forEach((t=>{const i=`set${t}`;i.endsWith("?")?["",2,3,4].forEach((t=>{this[i.slice(0,-1)+t]=this[i.slice(0,-1)+t]||T(i.slice(0,-1)+t).bind(this)})):this[i]=this[i]||T(i).bind(this)}))}static get ShadersRepository(){return ii.ShadersRepository}static set ShadersRepository(t){ii.ShadersRepository=t}get onBindObservable(){return this.ls||(this.ls=new h),this.ls}Ys(t,i,e){if(e){const s=e.vertexElement||e.vertex||e.spectorName||e,n=e.fragmentElement||e.fragment||e.spectorName||e;this.bs=(this.Vs===qt.WGSL?"//":"")+"#define SHADER_NAME vertex:"+s+"\n"+t,this._s=(this.Vs===qt.WGSL?"//":"")+"#define SHADER_NAME fragment:"+n+"\n"+i}else this.bs=t,this._s=i;this.Ks()}get key(){return this.ws}isReady(){try{return this.qs()}catch(t){return!1}}qs(){return!!this.di||!!this.Ms&&this.Ms.isReady}getEngine(){return this.Ls}getPipelineContext(){return this.Ms}getAttributesNames(){return this.Os}getAttributeLocation(t){return this.Qs[t]}getAttributeLocationByName(t){return this.Gs[t]}getAttributesCount(){return this.Qs.length}getUniformIndex(t){return this.Fs.indexOf(t)}getUniform(t){return this.Cs[t]}getSamplers(){return this.Bs}getUniformNames(){return this.Fs}getUniformBuffersNames(){return this.ks}getIndexParameters(){return this.Us}getCompilationError(){return this.Es}allFallbacksProcessed(){return this.As}executeWhenCompiled(t){this.isReady()?t(this):(this.onCompileObservable.add((i=>{t(i)})),this.Ms&&!this.Ms.isAsync||setTimeout((()=>{this.Zs(null)}),16))}Zs(t){try{if(this.qs())return}catch(i){return void this.Js(i,t)}this.li||setTimeout((()=>{this.Zs(t)}),16)}js(t,i,e,s){if("undefined"!=typeof HTMLElement&&t instanceof HTMLElement){return void s(It(t))}if("source:"===t.substr(0,7))return void s(t.substr(7));if("base64:"===t.substr(0,7)){return void s(window.atob(t.substr(7)))}const n=ii.GetShadersStore(this.Vs);if(n[t+i+"Shader"])return void s(n[t+i+"Shader"]);if(e&&n[t+e+"Shader"])return void s(n[t+e+"Shader"]);let r;r="."===t[0]||"/"===t[0]||t.indexOf("http")>-1?t:ii.GetShadersRepository(this.Vs)+t,this.Ls.tn(r+"."+i.toLowerCase()+".fx",s)}get vertexSourceCode(){var t,i;return this.Ts&&this.Rs?this.Ts:null!==(i=null===(t=this.Ms)||void 0===t?void 0:t.en())&&void 0!==i?i:this.bs}get fragmentSourceCode(){var t,i;return this.Ts&&this.Rs?this.Rs:null!==(i=null===(t=this.Ms)||void 0===t?void 0:t.sn())&&void 0!==i?i:this._s}get vertexSourceCodeBeforeMigration(){return this.ys}get fragmentSourceCodeBeforeMigration(){return this.Ns}get rawVertexSourceCode(){return this.Ps}get rawFragmentSourceCode(){return this.Ds}nn(t,i,e,s){this.di=!1,this.Ts=t,this.Rs=i,this.onError=(t,i)=>{s&&s(i)},this.onCompiled=()=>{const t=this.getEngine().scenes;if(t)for(let i=0;i<t.length;i++)t[i].markAllMaterialsAsDirty(63);this.Ms.rn(e)},this.xs=null,this.Ks()}Ks(){const t=this.Os,i=this.defines,e=this.Ms;this.di=!1;try{const s=this.Ls;this.Ms=s.createPipelineContext(this.Hs),this.Ms.hn=this.ws;const n=this.nn.bind(this);this.Ts&&this.Rs?s.on(this.Ms,this.Ts,this.Rs,!0,this.Ps,this.Ds,n,null,this.Is,this.ws):s.on(this.Ms,this.bs,this._s,!1,this.Ps,this.Ds,n,i,this.Is,this.ws),s.an(this.Ms,(()=>{if(this.Qs=[],this.Ms.ln(this,this.vs,this.Fs,this.Cs,this.Bs,this.Ss,t,this.Qs),t)for(let i=0;i<t.length;i++){const e=t[i];this.Gs[e]=this.Qs[i]}s.bindSamplers(this),this.Es="",this.di=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this.xs&&this.xs.unBindMesh(),e&&this.getEngine().cn(e)})),this.Ms.isAsync&&this.Zs(e)}catch(t){this.Js(t,e)}}un(t,i,e){const s=e?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let n=null;if(i&&t){const r=i.match(s);if(r&&2===r.length){const i=parseInt(r[1]),s=t.split("\n",-1);s.length>=i&&(n=`Offending line [${i}] in ${e?"fragment":"vertex"} code: ${s[i-1]}`)}}return[t,n]}Js(t,i=null){var e,s,n;this.Es=t.message;const r=this.Os,h=this.xs;if(F.Error("Unable to compile effect:"),F.Error("Uniforms: "+this.Fs.map((function(t){return" "+t}))),F.Error("Attributes: "+r.map((function(t){return" "+t}))),F.Error("Defines:\r\n"+this.defines),ei.LogShaderCodeOnCompilationError){let t=null,i=null,r=null;(null===(e=this.Ms)||void 0===e?void 0:e.en())&&([r,t]=this.un(this.Ms.en(),this.Es,!1),r&&(F.Error("Vertex code:"),F.Error(r))),(null===(s=this.Ms)||void 0===s?void 0:s.sn())&&([r,i]=this.un(null===(n=this.Ms)||void 0===n?void 0:n.sn(),this.Es,!0),r&&(F.Error("Fragment code:"),F.Error(r))),t&&F.Error(t),i&&F.Error(i)}F.Error("Error: "+this.Es);const o=()=>{this.onError&&this.onError(this,this.Es),this.onErrorObservable.notifyObservers(this)};i&&(this.Ms=i,this.di=!0,o()),h?(this.Ms=null,h.hasMoreFallbacks?(this.As=!1,F.Error("Trying next fallback."),this.defines=h.reduce(this.defines,this),this.Ks()):(this.As=!0,o(),this.onErrorObservable.clear(),this.xs&&this.xs.unBindMesh())):(this.As=!0,i||o())}get isSupported(){return""===this.Es}fn(t,i){this.Ls.fn(this.Ss[t],i,t)}setTexture(t,i){this.Ls.setTexture(this.Ss[t],this.Cs[t],i,t)}setDepthStencilTexture(t,i){this.Ls.setDepthStencilTexture(this.Ss[t],this.Cs[t],i,t)}setTextureArray(t,i){const e=t+"Ex";if(-1===this.Bs.indexOf(e+"0")){const s=this.Bs.indexOf(t);for(let t=1;t<i.length;t++){const i=e+(t-1).toString();this.Bs.splice(s+t,0,i)}let n=0;for(const t of this.Bs)this.Ss[t]=n,n+=1}this.Ls.setTextureArray(this.Ss[t],this.Cs[t],i,t)}setTextureFromPostProcess(t,i){this.Ls.setTextureFromPostProcess(this.Ss[t],i,t)}setTextureFromPostProcessOutput(t,i){this.Ls.setTextureFromPostProcessOutput(this.Ss[t],i,t)}bindUniformBuffer(t,i){const e=this.vs[i];void 0===e||ei.dn[e]===t&&this.Ls.hs.useUBOBindingCache||(ei.dn[e]=t,this.Ls.bindUniformBufferBase(t,e,i))}bindUniformBlock(t,i){this.Ls.bindUniformBlock(this.Ms,t,i)}setFloatArray(t,i){return this.Ms.setArray(t,i),this}setFloatArray2(t,i){return this.Ms.setArray2(t,i),this}setFloatArray3(t,i){return this.Ms.setArray3(t,i),this}setFloatArray4(t,i){return this.Ms.setArray4(t,i),this}setBool(t,i){return this.Ms.setInt(t,i?1:0),this}dispose(){var t;null===(t=this.Ms)||void 0===t||t.dispose(),this.Ls.pn(this),this.li=!0}static RegisterShader(t,i,e,s=qt.GLSL){i&&(ii.GetShadersStore(s)[`${t}PixelShader`]=i),e&&(ii.GetShadersStore(s)[`${t}VertexShader`]=e)}static ResetCache(){ei.dn={}}}ei.LogShaderCodeOnCompilationError=!0,ei.zs=0,ei.dn={},ei.ShadersStore=ii.ShadersStore,ei.IncludesShadersStore=ii.IncludesShadersStore;class si{constructor(t=!0){this.mn=!1,this.vn=!1,this.gn=!1,this.Sn=!1,this.En=!1,this.An=!1,this.Cn=!1,t&&this.reset()}get isDirty(){return this.gn||this.mn||this.vn||this.Sn||this.En||this.An||this.Cn}get zOffset(){return this.wn}set zOffset(t){this.wn!==t&&(this.wn=t,this.An=!0)}get zOffsetUnits(){return this.xn}set zOffsetUnits(t){this.xn!==t&&(this.xn=t,this.An=!0)}get cullFace(){return this.Tn}set cullFace(t){this.Tn!==t&&(this.Tn=t,this.Sn=!0)}get cull(){return this.Rn}set cull(t){this.Rn!==t&&(this.Rn=t,this.En=!0)}get depthFunc(){return this.In}set depthFunc(t){this.In!==t&&(this.In=t,this.gn=!0)}get depthMask(){return this.Mn}set depthMask(t){this.Mn!==t&&(this.Mn=t,this.vn=!0)}get depthTest(){return this.bn}set depthTest(t){this.bn!==t&&(this.bn=t,this.mn=!0)}get frontFace(){return this._n}set frontFace(t){this._n!==t&&(this._n=t,this.Cn=!0)}reset(){this.Mn=!0,this.bn=!0,this.In=null,this.Tn=null,this.Rn=null,this.wn=0,this.xn=0,this._n=null,this.mn=!0,this.vn=!0,this.gn=!1,this.Sn=!1,this.En=!1,this.An=!0,this.Cn=!1}apply(t){this.isDirty&&(this.En&&(this.cull?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),this.En=!1),this.Sn&&(t.cullFace(this.cullFace),this.Sn=!1),this.vn&&(t.depthMask(this.depthMask),this.vn=!1),this.mn&&(this.depthTest?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this.mn=!1),this.gn&&(t.depthFunc(this.depthFunc),this.gn=!1),this.An&&(this.zOffset||this.zOffsetUnits?(t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(this.zOffset,this.zOffsetUnits)):t.disable(t.POLYGON_OFFSET_FILL),this.An=!1),this.Cn&&(t.frontFace(this.frontFace),this.Cn=!1))}}class ni{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=ni.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=ni.KEEP,this.opDepthFail=ni.KEEP,this.opStencilDepthPass=ni.REPLACE}get stencilFunc(){return this.func}set stencilFunc(t){this.func=t}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(t){this.funcRef=t}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(t){this.funcMask=t}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(t){this.opStencilFail=t}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(t){this.opDepthFail=t}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(t){this.opStencilDepthPass=t}get stencilMask(){return this.mask}set stencilMask(t){this.mask=t}get stencilTest(){return this.enabled}set stencilTest(t){this.enabled=t}}ni.ALWAYS=519,ni.KEEP=7680,ni.REPLACE=7681;class ri{constructor(){this.yn=new Array(4),this.Nn=new Array(2),this.Pn=new Array(4),this.Dn=!1,this.Ln=!1,this.On=!1,this.Fn=!1,this.Bn=!1,this.reset()}get isDirty(){return this.On||this.Fn||this.Bn}get alphaBlend(){return this.Ln}set alphaBlend(t){this.Ln!==t&&(this.Ln=t,this.On=!0)}setAlphaBlendConstants(t,i,e,s){this.Pn[0]===t&&this.Pn[1]===i&&this.Pn[2]===e&&this.Pn[3]===s||(this.Pn[0]=t,this.Pn[1]=i,this.Pn[2]=e,this.Pn[3]=s,this.Dn=!0)}setAlphaBlendFunctionParameters(t,i,e,s){this.yn[0]===t&&this.yn[1]===i&&this.yn[2]===e&&this.yn[3]===s||(this.yn[0]=t,this.yn[1]=i,this.yn[2]=e,this.yn[3]=s,this.Fn=!0)}setAlphaEquationParameters(t,i){this.Nn[0]===t&&this.Nn[1]===i||(this.Nn[0]=t,this.Nn[1]=i,this.Bn=!0)}reset(){this.Ln=!1,this.yn[0]=null,this.yn[1]=null,this.yn[2]=null,this.yn[3]=null,this.Nn[0]=null,this.Nn[1]=null,this.Pn[0]=null,this.Pn[1]=null,this.Pn[2]=null,this.Pn[3]=null,this.On=!0,this.Fn=!1,this.Bn=!1,this.Dn=!1}apply(t){this.isDirty&&(this.On&&(this.Ln?t.enable(t.BLEND):t.disable(t.BLEND),this.On=!1),this.Fn&&(t.blendFuncSeparate(this.yn[0],this.yn[1],this.yn[2],this.yn[3]),this.Fn=!1),this.Bn&&(t.blendEquationSeparate(this.Nn[0],this.Nn[1]),this.Bn=!1),this.Dn&&(t.blendColor(this.Pn[0],this.Pn[1],this.Pn[2],this.Pn[3]),this.Dn=!1))}}class hi{constructor(){this.samplingMode=-1,this.Un=!0,this.Vn=null,this.kn=null,this.Gn=null,this.zn=null,this.Hn=0}get wrapU(){return this.Vn}set wrapU(t){this.Vn=t}get wrapV(){return this.kn}set wrapV(t){this.kn=t}get wrapR(){return this.Gn}set wrapR(t){this.Gn=t}get anisotropicFilteringLevel(){return this.zn}set anisotropicFilteringLevel(t){this.zn=t}get comparisonFunction(){return this.Hn}set comparisonFunction(t){this.Hn=t}get useMipMaps(){return this.Un}set useMipMaps(t){this.Un=t}setParameters(t=1,i=1,e=1,s=1,n=2,r=0){return this.Vn=t,this.kn=i,this.Gn=e,this.zn=s,this.samplingMode=n,this.Hn=r,this}compareSampler(t){return this.Vn===t.Vn&&this.kn===t.kn&&this.Gn===t.Gn&&this.zn===t.zn&&this.samplingMode===t.samplingMode&&this.Hn===t.Hn&&this.Un===t.Un}}var oi;!function(t){t[t.Unknown=0]="Unknown",t[t.Url=1]="Url",t[t.Temp=2]="Temp",t[t.Raw=3]="Raw",t[t.Dynamic=4]="Dynamic",t[t.RenderTarget=5]="RenderTarget",t[t.MultiRenderTarget=6]="MultiRenderTarget",t[t.Cube=7]="Cube",t[t.CubeRaw=8]="CubeRaw",t[t.CubePrefiltered=9]="CubePrefiltered",t[t.Raw3D=10]="Raw3D",t[t.Raw2DArray=11]="Raw2DArray",t[t.DepthStencil=12]="DepthStencil",t[t.CubeRawRGBD=13]="CubeRawRGBD",t[t.Depth=14]="Depth"}(oi||(oi={}));class ai extends hi{constructor(t,i,e=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new h,this.onErrorObservable=new h,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this.Xn=!1,this.Wn=-1,this.$n=oi.Unknown,this.Yn=null,this.jn=null,this.Kn=null,this.qn=null,this.Qn=0,this.Zn="",this.Jn=null,this.tr=null,this.ir=null,this.er=null,this.sr=!1,this.nr=null,this.rr=null,this.hr=null,this.ar=!1,this.lr=0,this.cr=0,this.ur=!1,this.dr=null,this.pr=null,this.mr=null,this.vr=!1,this.gr=!1,this.Sr=null,this.Er=null,this.Ar=null,this.Cr=1,this.wr=null,this.Ls=t,this.$n=i,this.Tr=ai.Rr++,e||(this.Er=t.Ir())}get useMipMaps(){return this.generateMipMaps}set useMipMaps(t){this.generateMipMaps=t}get uniqueId(){return this.Tr}Mr(t){this.Tr=t}getEngine(){return this.Ls}get source(){return this.$n}incrementReferences(){this.Cr++}updateSize(t,i,e=1){this.Ls.updateTextureDimensions(this,t,i,e),this.width=t,this.height=i,this.depth=e,this.baseWidth=t,this.baseHeight=i,this.baseDepth=e,this.Qn=t*i*e}br(){var t;if(this.isReady=!1,this.er=null,this.Vn=null,this.kn=null,this.Gn=null,this.zn=null,this.onRebuildCallback){const t=this.onRebuildCallback(this),i=i=>{i._r(this,!1),this.isReady=t.isReady};return void(t.isAsync?t.proxy.then(i):i(t.proxy))}let i;switch(this.source){case oi.Temp:break;case oi.Url:return void(i=this.Ls.createTexture(null!==(t=this.yr)&&void 0!==t?t:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,(t=>{t._r(this,!1),this.isReady=!0}),null,this.Yn,void 0,this.format,this.Zn,void 0,void 0,void 0,this.ur));case oi.Raw:i=this.Ls.createRawTexture(this.jn,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this.nr,this.type,void 0,this.ur),i._r(this,!1),this.isReady=!0;break;case oi.Raw3D:i=this.Ls.createRawTexture3D(this.jn,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this.nr,this.type),i._r(this,!1),this.isReady=!0;break;case oi.Raw2DArray:i=this.Ls.createRawTexture2DArray(this.jn,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this.nr,this.type),i._r(this,!1),this.isReady=!0;break;case oi.Dynamic:i=this.Ls.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),i._r(this,!1),this.Ls.updateDynamicTexture(this,this.Ls.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case oi.Cube:return void(i=this.Ls.createCubeTexture(this.url,null,this.Jn,!this.generateMipMaps,(()=>{i._r(this,!1),this.isReady=!0}),null,this.format,this.Zn,!1,0,0,null,void 0,this.ur));case oi.CubeRaw:i=this.Ls.createRawCubeTexture(this.Kn,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this.nr),i._r(this,!1),this.isReady=!0;break;case oi.CubeRawRGBD:return;case oi.CubePrefiltered:return i=this.Ls.createPrefilteredCubeTexture(this.url,null,this.lr,this.cr,(t=>{t&&t._r(this,!1),this.isReady=!0}),null,this.format,this.Zn),void(i.rr=this.rr)}}_r(t,i=!0){var e;null===(e=this.Er)||void 0===e||e.setUsage(t.$n,this.generateMipMaps,this.isCube,this.width,this.height),t.Er=this.Er,i&&(t.vr=this.vr),this.dr&&(t.dr&&t.dr.dispose(),t.dr=this.dr),this.pr&&(t.pr&&t.pr.dispose(),t.pr=this.pr),this.mr&&(t.mr&&t.mr.dispose(),t.mr=this.mr),this.Sr&&(t.Sr&&t.Sr.dispose(),t.Sr=this.Sr);const s=this.Ls.getLoadedTexturesCache();let n=s.indexOf(this);-1!==n&&s.splice(n,1),n=s.indexOf(t),-1===n&&s.push(t)}dispose(){this.Cr--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),0===this.Cr&&(this.Ls.Nr(this),this.Er=null)}}ai.Rr=0;class li{constructor(){this.shaderLanguage=qt.GLSL}postProcessor(t,i,e,s,n){if(!n.getCaps().drawBuffersExtension){const i=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;t=t.replace(i,"")}return t}}class ci{constructor(){this.shaderLanguage=qt.GLSL}attributeProcessor(t){return t.replace("attribute","in")}varyingProcessor(t,i){return t.replace("varying",i?"in":"out")}postProcessor(t,i,e){const s=-1!==t.search(/#extension.+GL_EXT_draw_buffers.+require/);if(t=(t=t.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),e)t=(t=(t=(t=(t=(t=(t=t.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(s?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");else{if(-1!==i.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+t}return t}}class ui{constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=ui.Rr++}get underlyingResource(){return null}}ui.Rr=0;class fi extends ui{constructor(t){super(),this.Yn=t}get underlyingResource(){return this.Yn}}const di=["Int","Int2","Int3","Int4","UInt","UInt2","UInt3","UInt4","Vector2","Vector3","Vector4","Float2","Float","Float3","Float4","Quaternion","Color3","Color4","DirectColor4"];class pi{constructor(){this.Pr={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null;const t=[],i=function(){t.length=0,Array.prototype.push.apply(t,arguments),t[0]=this.Cs[t[0]]},e=e=>{const s=di.includes(e.substring(3))&&"FloatN";if(s){const n=this[`_cache${s}`];return function(){const s=this.engine[e];i.apply(this,arguments),n.apply(this,arguments)&&(s.apply(this.engine,t)||(this.Pr[arguments[0]]=null))}}return function(){const s=this.engine[e];i.apply(this,arguments),void 0!==arguments[1]&&(this.Pr[arguments[0]]=null,s.apply(this.engine,t))}};["Int?","UInt?","IntArray?","UIntArray?","Array?","Float?","Matrices","Matrix3x3","Matrix2x2"].forEach((t=>{const i=`set${t}`;this[i]||(i.endsWith("?")?["",2,3,4].forEach((t=>{this[i.slice(0,-1)+t]=this[i.slice(0,-1)+t]||e(i.slice(0,-1)+t).bind(this)})):this[i]=this[i]||e(i).bind(this))}))}get isAsync(){return this.isParallelCompiled}get isReady(){return!!this.program&&(!this.isParallelCompiled||this.engine.Dr(this))}rn(t){t&&this.program&&t(this.program)}ln(t,i,e,s,n,r,h,o){const a=this.engine;if(a.supportsUniformBuffers)for(const e in i)t.bindUniformBlock(e,i[e]);let l;for(this.engine.getUniforms(this,e).forEach(((t,i)=>{s[e[i]]=t})),this.Cs=s,l=0;l<n.length;l++){null==t.getUniform(n[l])&&(n.splice(l,1),l--)}n.forEach(((t,i)=>{r[t]=i}));for(const t of a.getAttributes(this,h))o.push(t)}dispose(){this.Cs={}}Lr(t,i){const e=this.Pr[t],s=i.updateFlag;return(void 0===e||e!==s)&&(this.Pr[t]=s,!0)}Fr(t,i,e,s,n){let r=this.Pr[arguments[0]];if(!r||r.length!==arguments.length-1)return r=Array.prototype.slice.call(arguments,1),this.Pr[arguments[0]]=r,!0;let h=!1;for(let t=0;t<r.length;++t)r[t]!==arguments[t+1]&&(r[t]=arguments[t+1],h=!0);return h}Br(t,i,e){return this.Fr(t,i,e)}Ur(t,i,e,s){return this.Fr(t,i,e,s)}Vr(t,i,e,s,n){return this.Fr(t,i,e,s,n)}setMatrix(t,i){this.Lr(t,i)&&(this.engine.setMatrices(this.Cs[t],i.toArray())||(this.Pr[t]=null))}setVector2(t,i){this.setFloat2(t,i.x,i.y)}setVector3(t,i){this.setFloat3(t,i.x,i.y,i.z)}setVector4(t,i){this.setFloat4(t,i.x,i.y,i.z,i.w)}setQuaternion(t,i){this.setFloat4(t,i.x,i.y,i.z,i.w)}setColor3(t,i){this.setFloat3(t,i.r,i.g,i.b)}setColor4(t,i,e){this.setFloat4(t,i.r,i.g,i.b,e)}setDirectColor4(t,i){this.setFloat4(t,i.r,i.g,i.b,i.a)}en(){return this.vertexShader?this.engine.kr(this.vertexShader):null}sn(){return this.fragmentShader?this.engine.kr(this.fragmentShader):null}}class mi{constructor(t=null,i){if(this.Gr=null,this.zr=i,!t&&!(t=i.createTexture()))throw new Error("Unable to create webGL texture");this.set(t)}get underlyingResource(){return this.Hr}setUsage(){}set(t){this.Hr=t}reset(){this.Hr=null,this.Gr=null}release(){this.Gr&&(this.zr.deleteRenderbuffer(this.Gr),this.Gr=null),this.Hr&&this.zr.deleteTexture(this.Hr),this.reset()}}class vi{constructor(t,i=!0){this.effect=null,this.defines=null,this.drawContext=t.createDrawContext(),i&&(this.materialContext=t.createMaterialContext())}static IsWrapper(t){return void 0===t.getPipelineContext}static GetEffect(t){return void 0===t.getPipelineContext?t.effect:t}setEffect(t,i,e=!0){var s;this.effect=t,void 0!==i&&(this.defines=i),e&&(null===(s=this.drawContext)||void 0===s||s.reset())}dispose(){var t;null===(t=this.drawContext)||void 0===t||t.dispose()}}class gi{constructor(t=!0){this.Xr=!1,this.Wr=!1,this.$r=!1,this.Yr=!1,this.useStencilGlobalOnly=!1,t&&this.reset()}get isDirty(){return this.Xr||this.Wr||this.$r||this.Yr}get func(){return this.jr}set func(t){this.jr!==t&&(this.jr=t,this.$r=!0)}get funcRef(){return this.Kr}set funcRef(t){this.Kr!==t&&(this.Kr=t,this.$r=!0)}get funcMask(){return this.qr}set funcMask(t){this.qr!==t&&(this.qr=t,this.$r=!0)}get opStencilFail(){return this.Qr}set opStencilFail(t){this.Qr!==t&&(this.Qr=t,this.Yr=!0)}get opDepthFail(){return this.Zr}set opDepthFail(t){this.Zr!==t&&(this.Zr=t,this.Yr=!0)}get opStencilDepthPass(){return this.Jr}set opStencilDepthPass(t){this.Jr!==t&&(this.Jr=t,this.Yr=!0)}get mask(){return this.th}set mask(t){this.th!==t&&(this.th=t,this.Wr=!0)}get enabled(){return this.ih}set enabled(t){this.ih!==t&&(this.ih=t,this.Xr=!0)}reset(){var t;this.stencilMaterial=void 0,null===(t=this.stencilGlobal)||void 0===t||t.reset(),this.Xr=!0,this.Wr=!0,this.$r=!0,this.Yr=!0}apply(t){var i;if(!t)return;const e=!this.useStencilGlobalOnly&&!!(null===(i=this.stencilMaterial)||void 0===i?void 0:i.enabled);this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this.Xr&&(this.enabled?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.Xr=!1),this.Wr&&(t.stencilMask(this.mask),this.Wr=!1),this.$r&&(t.stencilFunc(this.func,this.funcRef,this.funcMask),this.$r=!1),this.Yr&&(t.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this.Yr=!1))}}class Si{}class Ei{constructor(t,i,e,s){this.hn="WebGL",this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this.eh=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new h,this.sh=0,this.nh=new Array,this.rh=new Array,this.hh=1,this.oh=!1,this.ah=!0,this.lh=!1,this.uh=!1,this.fh=!1,this.dh=new Array,this.onContextLostObservable=new h,this.onContextRestoredObservable=new h,this.ph=!1,this.mh=!1,this.disableVertexArrayObjects=!1,this.gh=!0,this.Sh=!0,this.Eh=new si,this.Ah=new gi,this.Ch=new ni,this.wh=new ri,this.xh=1,this.Th=0,this.Rh=new Array,this.Ih=new Array,this.Mh=0,this.bh=-1,this._h={},this.yh={},this.Nh=[],this.Ph=!1,this.Dh=new Array,this.Lh=null,this.Oh=null,this.Fh=new Array,this.Bh=new Array,this.Uh=new Array,this.Vh=!1,this.kh=!1,this.Gh=new Array,this.zh=0,this.Hh=null,this.Xh=new Array,this.adaptToDeviceRatio=!1,this.Wh=1,this.$h=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new h,this.Yh=!1,this.jh=0,this.Kh=!1,this.qh={x:0,y:0,z:0,w:0},this.Qh=null,this.enableUnpackFlipYCached=!0,this.Zh={},this.startTime=bt.Now;let n=null;if(e=e||{},this.Jh=e,this.adaptToDeviceRatio=null!=s&&s,this.Ah.stencilGlobal=this.Ch,S.SetMatrixPrecision(!!e.useHighPrecisionMatrix),!t)return;if(s=s||e.adaptToDeviceRatio||!1,t.getContext){if(n=t,this.io=n,void 0!==i&&(e.antialias=i),void 0===e.deterministicLockstep&&(e.deterministicLockstep=!1),void 0===e.lockstepMaxSteps&&(e.lockstepMaxSteps=4),void 0===e.timeStep&&(e.timeStep=1/60),void 0===e.preserveDrawingBuffer&&(e.preserveDrawingBuffer=!1),void 0===e.audioEngine&&(e.audioEngine=!0),void 0!==e.audioEngineOptions&&void 0!==e.audioEngineOptions.audioContext&&(this.eo=e.audioEngineOptions.audioContext),void 0!==e.audioEngineOptions&&void 0!==e.audioEngineOptions.audioDestination&&(this.so=e.audioEngineOptions.audioDestination),void 0===e.stencil&&(e.stencil=!0),!1===e.premultipliedAlpha&&(this.premultipliedAlpha=!1),void 0===e.xrCompatible&&(e.xrCompatible=!0),void 0!==e.useExactSrgbConversions&&(this.Kh=e.useExactSrgbConversions),this.mh=!!e.doNotHandleContextLost,navigator&&navigator.userAgent){this.no=()=>{const t=navigator.userAgent;this.hostInformation.isMobile=-1!==t.indexOf("Mobile")||-1!==t.indexOf("Mac")&&Rt()&&"ontouchend"in document},this.no(),xt()&&window.addEventListener("resize",this.no);const t=navigator.userAgent;for(const i of Ei.ExceptionList){const s=i.key,n=i.targets;if(new RegExp(s).test(t)){if(i.capture&&i.captureConstraint){const e=i.capture,s=i.captureConstraint,n=new RegExp(e).exec(t);if(n&&n.length>0){if(parseInt(n[n.length-1])>=s)continue}}for(const t of n)switch(t){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":e.antialias=!1;break;case"maxMSAASamples":this.Hh=1}}}}if(this.mh||(this.ro=t=>{t.preventDefault(),this.ph=!0,F.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this.ho=()=>{this.oo(this.ao.bind(this))},n.addEventListener("webglcontextlost",this.ro,!1),n.addEventListener("webglcontextrestored",this.ho,!1),e.powerPreference="high-performance"),this.uh=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.uh&&(e.xrCompatible=!1),!e.disableWebGL2Support)try{this.lo=n.getContext("webgl2",e)||n.getContext("experimental-webgl2",e),this.lo&&(this.hh=2,this.co="WEBGL2",this.lo.deleteQuery||(this.hh=1,this.co="WEBGL1"))}catch(t){}if(!this.lo){if(!n)throw new Error("The provided canvas is null or undefined.");try{this.lo=n.getContext("webgl",e)||n.getContext("experimental-webgl",e)}catch(t){throw new Error("WebGL not supported")}}if(!this.lo)throw new Error("WebGL not supported")}else{this.lo=t,this.io=this.lo.canvas,this.lo.renderbufferStorageMultisample?(this.hh=2,this.co="WEBGL2"):this.co="WEBGL1";const i=this.lo.getContextAttributes();i&&(e.stencil=i.stencil)}this.lo.pixelStorei(this.lo.UNPACK_COLORSPACE_CONVERSION_WEBGL,this.lo.NONE),void 0!==e.useHighPrecisionFloats&&(this.ah=e.useHighPrecisionFloats);const r=xt()&&window.devicePixelRatio||1,o=e.limitDeviceRatio||r;this.uo=s?1/Math.min(o,r):1,this.Wh=r,this.resize(),this.fo=!!e.stencil,this.ao(),this.do();for(let t=0;t<this.po.maxVertexAttribs;t++)this.Fh[t]=new Si;this.mo=this.webGLVersion>1?new ci:new li,this.lh=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);const a=`Babylon.js v${Ei.Version}`;console.log(a+` - ${this.description}`),this.io&&this.io.setAttribute&&this.io.setAttribute("data-engine",a)}static get NpmPackage(){return"babylonjs@5.44.0"}static get Version(){return"5.44.0"}get description(){let t=this.name+this.webGLVersion;return this.po.parallelShaderCompile&&(t+=" - Parallel shader compilation"),t}get name(){return this.hn}set name(t){this.hn=t}get version(){return this.hh}static get ShadersRepository(){return ei.ShadersRepository}static set ShadersRepository(t){ei.ShadersRepository=t}$s(t){return this.mo}get useReverseDepthBuffer(){return this.eh}set useReverseDepthBuffer(t){t!==this.eh&&(this.eh=t,this.Eh.depthFunc=t?518:515)}get frameId(){return this.sh}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this.Jh}get Ws(){return!(!this.po.highPrecisionShaderSupported||!this.ah)}get needPOTTextures(){return this.hh<2||this.forcePOTTextures}get activeRenderLoops(){return this.dh}get doNotHandleContextLost(){return this.mh}set doNotHandleContextLost(t){this.mh=t}get vo(){return!1}set framebufferDimensionsObject(t){this.So=t}get currentViewport(){return this.Eo}get emptyTexture(){return this.Ao||(this.Ao=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this.Ao}get emptyTexture3D(){return this.Co||(this.Co=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this.Co}get emptyTexture2DArray(){return this.wo||(this.wo=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this.wo}get emptyCubeTexture(){if(!this.xo){const t=new Uint8Array(4),i=[t,t,t,t,t,t];this.xo=this.createRawCubeTexture(i,1,5,0,!1,!1,1)}return this.xo}get isWebGPU(){return this.Yh}get shaderPlatformName(){return this.co}get snapshotRendering(){return!1}set snapshotRendering(t){}get snapshotRenderingMode(){return this.jh}set snapshotRenderingMode(t){this.jh=t}get useExactSrgbConversions(){return this.Kh}snapshotRenderingReset(){this.snapshotRendering=!1}static To(t,i){if("undefined"==typeof document)return new OffscreenCanvas(t,i);const e=document.createElement("canvas");return e.width=t,e.height=i,e}createCanvas(t,i){return Ei.To(t,i)}createCanvasImage(){return document.createElement("img")}oo(t){setTimeout((async()=>{var i;this.Oh=null;const e=this.Eh.depthTest,s=this.Eh.depthFunc,n=this.Eh.depthMask,r=this.Ch.stencilTest;await t(),this.wipeCaches(!0),this.Ro(),null===(i=this.Io)||void 0===i||i.call(this),this.Mo(),this.bo(),this._o(),this.wipeCaches(!0),this.Eh.depthTest=e,this.Eh.depthFunc=s,this.Eh.depthMask=n,this.Ch.stencilTest=r,F.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this.ph=!1}),0)}yo(t,i,e){this.io=t}Xs(t){return null}bo(){const t=this.Rh.slice();for(const i of t)i.br()}_o(){const t=this.Ih.slice();for(const i of t)i.br()}Ro(){for(const t in this.yh){const i=this.yh[t];i.Ms=null,i.cs=!1,i.Ks()}ei.ResetCache()}areAllEffectsReady(){for(const t in this.yh){if(!this.yh[t].isReady())return!1}return!0}Mo(){for(const t of this.nh)t.br();for(const t of this.rh)t.br()}ao(){var t;this.po={maxTexturesImageUnits:this.lo.getParameter(this.lo.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this.lo.getParameter(this.lo.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this.lo.getParameter(this.lo.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.lo.getParameter(this.lo.MAX_TEXTURE_SIZE),maxSamples:this.hh>1?this.lo.getParameter(this.lo.MAX_SAMPLES):1,maxCubemapTextureSize:this.lo.getParameter(this.lo.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this.lo.getParameter(this.lo.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this.lo.getParameter(this.lo.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this.lo.getParameter(this.lo.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this.lo.getParameter(this.lo.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this.lo.getParameter(this.lo.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this.lo.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this.hh>1||null!==this.lo.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this.lo.getExtension("WEBGL_compressed_texture_astc")||this.lo.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this.lo.getExtension("EXT_texture_compression_bptc")||this.lo.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this.lo.getExtension("WEBGL_compressed_texture_s3tc")||this.lo.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this.lo.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this.lo.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this.lo.getExtension("WEBGL_compressed_texture_pvrtc")||this.lo.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this.lo.getExtension("WEBGL_compressed_texture_etc1")||this.lo.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this.lo.getExtension("WEBGL_compressed_texture_etc")||this.lo.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this.lo.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this.lo.getExtension("EXT_texture_filter_anisotropic")||this.lo.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this.lo.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this.hh>1||null!==this.lo.getExtension("OES_element_index_uint"),fragmentDepthSupported:this.hh>1||null!==this.lo.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this.lo.getExtension("EXT_disjoint_timer_query_webgl2")||this.lo.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this.hh>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this.hh>1&&this.lo.getExtension("EXT_color_buffer_float")),textureFloat:!!(this.hh>1||this.lo.getExtension("OES_texture_float")),textureHalfFloat:!!(this.hh>1||this.lo.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this.hh>1||this.lo.getExtension("EXT_shader_texture_lod")),blendMinMax:!1,multiview:this.lo.getExtension("OVR_multiview2"),oculusMultiview:this.lo.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this.hh>1,canUseGLVertexID:this.hh>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this.hh>1,textureMaxLevel:this.hh>1,texture2DArrayMaxLayerCount:this.hh>1?256:128},this.No=this.lo.getParameter(this.lo.VERSION);const i=this.lo.getExtension("WEBGL_debug_renderer_info");if(null!=i&&(this.Po=this.lo.getParameter(i.UNMASKED_RENDERER_WEBGL),this.Do=this.lo.getParameter(i.UNMASKED_VENDOR_WEBGL)),this.Do||(this.Do=this.lo.getParameter(this.lo.VENDOR)||"Unknown vendor"),this.Po||(this.Po=this.lo.getParameter(this.lo.RENDERER)||"Unknown renderer"),36193!==this.lo.HALF_FLOAT_OES&&(this.lo.HALF_FLOAT_OES=36193),34842!==this.lo.RGBA16F&&(this.lo.RGBA16F=34842),34836!==this.lo.RGBA32F&&(this.lo.RGBA32F=34836),35056!==this.lo.DEPTH24_STENCIL8&&(this.lo.DEPTH24_STENCIL8=35056),this.po.timerQuery&&(1===this.hh&&(this.lo.getQuery=this.po.timerQuery.getQueryEXT.bind(this.po.timerQuery)),this.po.canUseTimestampForTimerQuery=(null!==(t=this.lo.getQuery(this.po.timerQuery.TIMESTAMP_EXT,this.po.timerQuery.QUERY_COUNTER_BITS_EXT))&&void 0!==t?t:0)>0),this.po.maxAnisotropy=this.po.textureAnisotropicFilterExtension?this.lo.getParameter(this.po.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this.po.textureFloatLinearFiltering=!(!this.po.textureFloat||!this.lo.getExtension("OES_texture_float_linear")),this.po.textureFloatRender=!(!this.po.textureFloat||!this.Lo()),this.po.textureHalfFloatLinearFiltering=!!(this.hh>1||this.po.textureHalfFloat&&this.lo.getExtension("OES_texture_half_float_linear")),this.po.astc&&(this.lo.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this.po.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this.po.bptc&&(this.lo.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this.po.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this.po.s3tc_srgb&&(this.lo.COMPRESSED_SRGB_S3TC_DXT1_EXT=this.po.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this.lo.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this.po.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this.lo.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this.po.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this.po.etc2&&(this.lo.COMPRESSED_SRGB8_ETC2=this.po.etc2.COMPRESSED_SRGB8_ETC2,this.lo.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this.po.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this.hh>1&&5131!==this.lo.HALF_FLOAT_OES&&(this.lo.HALF_FLOAT_OES=5131),this.po.textureHalfFloatRender=this.po.textureHalfFloat&&this.Oo(),this.hh>1)this.po.drawBuffersExtension=!0,this.po.maxMSAASamples=null!==this.Hh?this.Hh:this.lo.getParameter(this.lo.MAX_SAMPLES);else{const t=this.lo.getExtension("WEBGL_draw_buffers");if(null!==t){this.po.drawBuffersExtension=!0,this.lo.drawBuffers=t.drawBuffersWEBGL.bind(t),this.lo.DRAW_FRAMEBUFFER=this.lo.FRAMEBUFFER;for(let i=0;i<16;i++)this.lo["COLOR_ATTACHMENT"+i+"_WEBGL"]=t["COLOR_ATTACHMENT"+i+"_WEBGL"]}}if(this.hh>1)this.po.depthTextureExtension=!0;else{const t=this.lo.getExtension("WEBGL_depth_texture");null!=t&&(this.po.depthTextureExtension=!0,this.lo.UNSIGNED_INT_24_8=t.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this.po.vertexArrayObject=!1;else if(this.hh>1)this.po.vertexArrayObject=!0;else{const t=this.lo.getExtension("OES_vertex_array_object");null!=t&&(this.po.vertexArrayObject=!0,this.lo.createVertexArray=t.createVertexArrayOES.bind(t),this.lo.bindVertexArray=t.bindVertexArrayOES.bind(t),this.lo.deleteVertexArray=t.deleteVertexArrayOES.bind(t))}if(this.hh>1)this.po.instancedArrays=!0;else{const t=this.lo.getExtension("ANGLE_instanced_arrays");null!=t?(this.po.instancedArrays=!0,this.lo.drawArraysInstanced=t.drawArraysInstancedANGLE.bind(t),this.lo.drawElementsInstanced=t.drawElementsInstancedANGLE.bind(t),this.lo.vertexAttribDivisor=t.vertexAttribDivisorANGLE.bind(t)):this.po.instancedArrays=!1}if(this.lo.getShaderPrecisionFormat){const t=this.lo.getShaderPrecisionFormat(this.lo.VERTEX_SHADER,this.lo.HIGH_FLOAT),i=this.lo.getShaderPrecisionFormat(this.lo.FRAGMENT_SHADER,this.lo.HIGH_FLOAT);t&&i&&(this.po.highPrecisionShaderSupported=0!==t.precision&&0!==i.precision)}if(this.hh>1)this.po.blendMinMax=!0;else{const t=this.lo.getExtension("EXT_blend_minmax");null!=t&&(this.po.blendMinMax=!0,this.lo.MAX=t.MAX_EXT,this.lo.MIN=t.MIN_EXT)}if(!this.po.supportSRGBBuffers){if(this.hh>1)this.po.supportSRGBBuffers=!0;else{const t=this.lo.getExtension("EXT_sRGB");null!=t&&(this.po.supportSRGBBuffers=!0,this.lo.SRGB=t.SRGB_EXT,this.lo.SRGB8=t.SRGB_ALPHA_EXT,this.lo.SRGB8_ALPHA8=t.SRGB_ALPHA_EXT)}this.po.supportSRGBBuffers=this.po.supportSRGBBuffers&&!(!this.Jh||!this.Jh.forceSRGBBufferSupportState)}this.Eh.depthTest=!0,this.Eh.depthFunc=this.lo.LEQUAL,this.Eh.depthMask=!0,this.zh=this.po.maxCombinedTexturesImageUnits;for(let t=0;t<this.zh;t++)this.Gh.push(t)}do(){this.hs={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:1!==this.hh,supportDepthStencilTexture:1!==this.hh,supportShadowSamplers:1!==this.hh,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this.hh,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this.hh,basisNeedsPOT:1===this.hh,support3DTextures:1!==this.hh,needTypeSuffixInShaderConstants:1!==this.hh,supportMSAA:1!==this.hh,supportSSAO2:1!==this.hh,supportExtendedTextureFormats:1!==this.hh,supportSwitchCaseInShader:1!==this.hh,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,Fo:!1}}get webGLVersion(){return this.hh}getClassName(){return"ThinEngine"}get isStencilEnable(){return this.fo}Bo(){if(this.tr)return;this.tr=this.createCanvas(1,1);const t=this.tr.getContext("2d");t&&(this.ir=t)}resetTextureCache(){for(const t in this._h)Object.prototype.hasOwnProperty.call(this._h,t)&&(this._h[t]=null);this.bh=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this.Do,renderer:this.Po,version:this.No}}setHardwareScalingLevel(t){this.uo=t,this.resize()}getHardwareScalingLevel(){return this.uo}getLoadedTexturesCache(){return this.Rh}getCaps(){return this.po}stopRenderLoop(t){if(!t)return void(this.dh=[]);const i=this.dh.indexOf(t);i>=0&&this.dh.splice(i,1)}Uo(){if(!this.ph){let t=!0;if(!this.renderEvenInBackground&&this.oh&&(t=!1),t){this.beginFrame();for(let t=0;t<this.dh.length;t++){(0,this.dh[t])()}this.endFrame()}}this.dh.length>0?this.Vo=this.ko(this.Go,this.getHostWindow()):this.fh=!1}getRenderingCanvas(){return this.io}getAudioContext(){return this.eo}getAudioDestination(){return this.so}getHostWindow(){return xt()?this.io&&this.io.ownerDocument&&this.io.ownerDocument.defaultView?this.io.ownerDocument.defaultView:window:null}getRenderWidth(t=!1){return!t&&this.zo?this.zo.width:this.So?this.So.framebufferWidth:this.lo.drawingBufferWidth}getRenderHeight(t=!1){return!t&&this.zo?this.zo.height:this.So?this.So.framebufferHeight:this.lo.drawingBufferHeight}ko(t,i){return Ei.QueueNewFrame(t,i)}runRenderLoop(t){-1===this.dh.indexOf(t)&&(this.dh.push(t),this.fh||(this.fh=!0,this.Go=this.Uo.bind(this),this.Vo=this.ko(this.Go,this.getHostWindow())))}clear(t,i,e,s=!1){const n=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=n;let r=0;i&&t&&(this.lo.clearColor(t.r,t.g,t.b,void 0!==t.a?t.a:1),r|=this.lo.COLOR_BUFFER_BIT),e&&(this.useReverseDepthBuffer?(this.Eh.depthFunc=this.lo.GEQUAL,this.lo.clearDepth(0)):this.lo.clearDepth(1),r|=this.lo.DEPTH_BUFFER_BIT),s&&(this.lo.clearStencil(0),r|=this.lo.STENCIL_BUFFER_BIT),this.lo.clear(r)}Ho(t,i,e,s){t===this.qh.x&&i===this.qh.y&&e===this.qh.z&&s===this.qh.w||(this.qh.x=t,this.qh.y=i,this.qh.z=e,this.qh.w=s,this.lo.viewport(t,i,e,s))}setViewport(t,i,e){const s=i||this.getRenderWidth(),n=e||this.getRenderHeight(),r=t.x||0,h=t.y||0;this.Eo=t,this.Ho(r*s,h*n,s*t.width,n*t.height)}beginFrame(){}endFrame(){this.lh&&this.flushFramebuffer(),this.sh++}resize(t=!1){let i,e;if(this.adaptToDeviceRatio){const t=xt()&&window.devicePixelRatio||1,i=this.Wh/t;this.Wh=t,this.uo*=i}xt()?(i=this.io?this.io.clientWidth||this.io.width:window.innerWidth,e=this.io?this.io.clientHeight||this.io.height:window.innerHeight):(i=this.io?this.io.width:100,e=this.io?this.io.height:100),this.setSize(i/this.uo,e/this.uo,t)}setSize(t,i,e=!1){return!!this.io&&(t|=0,i|=0,!(!e&&this.io.width===t&&this.io.height===i)&&(this.io.width=t,this.io.height=i,!0))}bindFramebuffer(t,i=0,e,s,n,r=0,h=0){var o,a,l,c,u;const f=t;this.zo&&this.unBindFramebuffer(this.zo),this.zo=t,this.Xo(f.Wo?f.Wo:f.$o);const d=this.lo;t.is2DArray?d.framebufferTextureLayer(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,null===(o=t.texture.Er)||void 0===o?void 0:o.underlyingResource,r,h):t.isCube&&d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+i,null===(a=t.texture.Er)||void 0===a?void 0:a.underlyingResource,r);const p=t.Yo;if(p){const e=t.jo?d.DEPTH_STENCIL_ATTACHMENT:d.DEPTH_ATTACHMENT;t.is2DArray?d.framebufferTextureLayer(d.FRAMEBUFFER,e,null===(l=p.Er)||void 0===l?void 0:l.underlyingResource,r,h):t.isCube?d.framebufferTexture2D(d.FRAMEBUFFER,e,d.TEXTURE_CUBE_MAP_POSITIVE_X+i,null===(c=p.Er)||void 0===c?void 0:c.underlyingResource,r):d.framebufferTexture2D(d.FRAMEBUFFER,e,d.TEXTURE_2D,null===(u=p.Er)||void 0===u?void 0:u.underlyingResource,r)}this.Eo&&!n?this.setViewport(this.Eo,e,s):(e||(e=t.width,r&&(e/=Math.pow(2,r))),s||(s=t.height,r&&(s/=Math.pow(2,r))),this.Ho(0,0,e,s)),this.wipeCaches()}setState(t,i=0,e,s=!1,n,r,h=0){var o,a;(this.Eh.cull!==t||e)&&(this.Eh.cull=t);const l=null===(a=null!==(o=this.cullBackFaces)&&void 0!==o?o:n)||void 0===a||a?this.lo.BACK:this.lo.FRONT;(this.Eh.cullFace!==l||e)&&(this.Eh.cullFace=l),this.setZOffset(i),this.setZOffsetUnits(h);const c=s?this.lo.CW:this.lo.CCW;(this.Eh.frontFace!==c||e)&&(this.Eh.frontFace=c),this.Ah.stencilMaterial=r}getDepthBuffer(){return this.Eh.depthTest}setDepthBuffer(t){this.Eh.depthTest=t}setZOffset(t){this.Eh.zOffset=this.useReverseDepthBuffer?-t:t}getZOffset(){const t=this.Eh.zOffset;return this.useReverseDepthBuffer?-t:t}setZOffsetUnits(t){this.Eh.zOffsetUnits=this.useReverseDepthBuffer?-t:t}getZOffsetUnits(){const t=this.Eh.zOffsetUnits;return this.useReverseDepthBuffer?-t:t}Xo(t){this.Lh!==t&&(this.lo.bindFramebuffer(this.lo.FRAMEBUFFER,t),this.Lh=t)}Ko(){return null===this.Lh}generateMipmaps(t){this.qo(this.lo.TEXTURE_2D,t,!0),this.lo.generateMipmap(this.lo.TEXTURE_2D),this.qo(this.lo.TEXTURE_2D,null)}unBindFramebuffer(t,i=!1,e){var s;const n=t;this.zo=null;const r=this.lo;if(n.Wo){if(t.isMulti)return void this.unBindMultiColorAttachmentFramebuffer(t,i,e);r.bindFramebuffer(r.READ_FRAMEBUFFER,n.Wo),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,n.$o),r.blitFramebuffer(0,0,t.width,t.height,0,0,t.width,t.height,r.COLOR_BUFFER_BIT,r.NEAREST)}!(null===(s=t.texture)||void 0===s?void 0:s.generateMipMaps)||i||t.isCube||this.generateMipmaps(t.texture),e&&(n.Wo&&this.Xo(n.$o),e()),this.Xo(null)}flushFramebuffer(){this.lo.flush()}restoreDefaultFramebuffer(){this.zo?this.unBindFramebuffer(this.zo):this.Xo(null),this.Eo&&this.setViewport(this.Eo),this.wipeCaches()}Qo(){this.bindArrayBuffer(null),this.Zo=null}createVertexBuffer(t){return this.Jo(t,this.lo.STATIC_DRAW)}Jo(t,i){const e=this.lo.createBuffer();if(!e)throw new Error("Unable to create vertex buffer");const s=new fi(e);return this.bindArrayBuffer(s),t instanceof Array?this.lo.bufferData(this.lo.ARRAY_BUFFER,new Float32Array(t),i):this.lo.bufferData(this.lo.ARRAY_BUFFER,t,i),this.Qo(),s.references=1,s}createDynamicVertexBuffer(t){return this.Jo(t,this.lo.DYNAMIC_DRAW)}ta(){this.bindIndexBuffer(null),this.ia=null}createIndexBuffer(t,i){const e=this.lo.createBuffer(),s=new fi(e);if(!e)throw new Error("Unable to create index buffer");this.bindIndexBuffer(s);const n=this.ea(t);return this.lo.bufferData(this.lo.ELEMENT_ARRAY_BUFFER,n,i?this.lo.DYNAMIC_DRAW:this.lo.STATIC_DRAW),this.ta(),s.references=1,s.is32Bits=4===n.BYTES_PER_ELEMENT,s}ea(t){if(2===t.BYTES_PER_ELEMENT)return t;if(this.po.uintIndices){if(t instanceof Uint32Array)return t;for(let i=0;i<t.length;i++)if(t[i]>=65535)return new Uint32Array(t);return new Uint16Array(t)}return new Uint16Array(t)}bindArrayBuffer(t){this.Vh||this.sa(),this.na(t,this.lo.ARRAY_BUFFER)}bindUniformBlock(t,i,e){const s=t.program,n=this.lo.getUniformBlockIndex(s,i);this.lo.uniformBlockBinding(s,n,e)}bindIndexBuffer(t){this.Vh||this.sa(),this.na(t,this.lo.ELEMENT_ARRAY_BUFFER)}na(t,i){(this.Vh||this.Dh[i]!==t)&&(this.lo.bindBuffer(i,t?t.underlyingResource:null),this.Dh[i]=t)}updateArrayBuffer(t){this.lo.bufferSubData(this.lo.ARRAY_BUFFER,0,t)}ra(t,i,e,s,n,r,h){const o=this.Fh[i];if(!o)return;let a=!1;o.active?(o.buffer!==t&&(o.buffer=t,a=!0),o.size!==e&&(o.size=e,a=!0),o.type!==s&&(o.type=s,a=!0),o.normalized!==n&&(o.normalized=n,a=!0),o.stride!==r&&(o.stride=r,a=!0),o.offset!==h&&(o.offset=h,a=!0)):(a=!0,o.active=!0,o.index=i,o.size=e,o.type=s,o.normalized=n,o.stride=r,o.offset=h,o.buffer=t),(a||this.Vh)&&(this.bindArrayBuffer(t),s===this.lo.UNSIGNED_INT||s===this.lo.INT?this.lo.vertexAttribIPointer(i,e,s,r,h):this.lo.vertexAttribPointer(i,e,s,n,r,h))}ha(t){null!=t&&this.ia!==t&&(this.ia=t,this.bindIndexBuffer(t),this.Ph=t.is32Bits)}oa(t,i,e){const s=i.getAttributesNames();this.Vh||this.sa(),this.unbindAllAttributes();for(let n=0;n<s.length;n++){const r=i.getAttributeLocation(n);if(r>=0){const i=s[n];let h=null;if(e&&(h=e[i]),h||(h=t[i]),!h)continue;this.lo.enableVertexAttribArray(r),this.Vh||(this.Nh[r]=!0);const o=h.getBuffer();o&&(this.ra(o,r,h.getSize(),h.type,h.normalized,h.byteStride,h.byteOffset),h.getIsInstanced()&&(this.lo.vertexAttribDivisor(r,h.getInstanceDivisor()),this.Vh||(this.Bh.push(r),this.Uh.push(o))))}}}recordVertexArrayObject(t,i,e,s){const n=this.lo.createVertexArray();if(!n)throw new Error("Unable to create VAO");return this.Vh=!0,this.lo.bindVertexArray(n),this.kh=!0,this.oa(t,e,s),this.bindIndexBuffer(i),this.Vh=!1,this.lo.bindVertexArray(null),n}bindVertexArrayObject(t,i){this.aa!==t&&(this.aa=t,this.lo.bindVertexArray(t),this.Zo=null,this.ia=null,this.Ph=null!=i&&i.is32Bits,this.kh=!0)}bindBuffersDirectly(t,i,e,s,n){if(this.Zo!==t||this.la!==n){this.Zo=t,this.la=n;const i=n.getAttributesCount();this.sa(),this.unbindAllAttributes();let r=0;for(let h=0;h<i;h++)if(h<e.length){const i=n.getAttributeLocation(h);i>=0&&(this.lo.enableVertexAttribArray(i),this.Nh[i]=!0,this.ra(t,i,e[h],this.lo.FLOAT,!1,s,r)),r+=4*e[h]}}this.ha(i)}sa(){this.aa&&(this.aa=null,this.lo.bindVertexArray(null))}bindBuffers(t,i,e,s){this.Zo===t&&this.la===e||(this.Zo=t,this.la=e,this.oa(t,e,s)),this.ha(i)}unbindInstanceAttributes(){let t;for(let i=0,e=this.Bh.length;i<e;i++){const e=this.Uh[i];t!=e&&e.references&&(t=e,this.bindArrayBuffer(e));const s=this.Bh[i];this.lo.vertexAttribDivisor(s,0)}this.Uh.length=0,this.Bh.length=0}releaseVertexArrayObject(t){this.lo.deleteVertexArray(t)}ca(t){return t.references--,0===t.references&&(this.ua(t),!0)}ua(t){this.lo.deleteBuffer(t.underlyingResource)}updateAndBindInstancesBuffer(t,i,e){if(this.bindArrayBuffer(t),i&&this.lo.bufferSubData(this.lo.ARRAY_BUFFER,0,i),void 0!==e[0].index)this.bindInstancesBuffer(t,e,!0);else for(let i=0;i<4;i++){const s=e[i];this.Nh[s]||(this.lo.enableVertexAttribArray(s),this.Nh[s]=!0),this.ra(t,s,4,this.lo.FLOAT,!1,64,16*i),this.lo.vertexAttribDivisor(s,1),this.Bh.push(s),this.Uh.push(t)}}bindInstancesBuffer(t,i,e=!0){this.bindArrayBuffer(t);let s=0;if(e)for(let t=0;t<i.length;t++){s+=4*i[t].attributeSize}for(let e=0;e<i.length;e++){const n=i[e];void 0===n.index&&(n.index=this.fa.getAttributeLocationByName(n.attributeName)),n.index<0||(this.Nh[n.index]||(this.lo.enableVertexAttribArray(n.index),this.Nh[n.index]=!0),this.ra(t,n.index,n.attributeSize,n.attributeType||this.lo.FLOAT,n.normalized||!1,s,n.offset),this.lo.vertexAttribDivisor(n.index,void 0===n.divisor?1:n.divisor),this.Bh.push(n.index),this.Uh.push(t))}}disableInstanceAttributeByName(t){if(!this.fa)return;const i=this.fa.getAttributeLocationByName(t);this.disableInstanceAttribute(i)}disableInstanceAttribute(t){let i,e=!1;for(;-1!==(i=this.Bh.indexOf(t));)this.Bh.splice(i,1),this.Uh.splice(i,1),e=!0,i=this.Bh.indexOf(t);e&&(this.lo.vertexAttribDivisor(t,0),this.disableAttributeByIndex(t))}disableAttributeByIndex(t){this.lo.disableVertexAttribArray(t),this.Nh[t]=!1,this.Fh[t].active=!1}draw(t,i,e,s){this.drawElementsType(t?0:1,i,e,s)}drawPointClouds(t,i,e){this.drawArraysType(2,t,i,e)}drawUnIndexed(t,i,e,s){this.drawArraysType(t?0:1,i,e,s)}drawElementsType(t,i,e,s){this.applyStates(),this.da();const n=this.pa(t),r=this.Ph?this.lo.UNSIGNED_INT:this.lo.UNSIGNED_SHORT,h=this.Ph?4:2;s?this.lo.drawElementsInstanced(n,e,r,i*h,s):this.lo.drawElements(n,e,r,i*h)}drawArraysType(t,i,e,s){this.applyStates(),this.da();const n=this.pa(t);s?this.lo.drawArraysInstanced(n,i,e,s):this.lo.drawArrays(n,i,e)}pa(t){switch(t){case 0:default:return this.lo.TRIANGLES;case 2:case 3:return this.lo.POINTS;case 1:case 4:return this.lo.LINES;case 5:return this.lo.LINE_LOOP;case 6:return this.lo.LINE_STRIP;case 7:return this.lo.TRIANGLE_STRIP;case 8:return this.lo.TRIANGLE_FAN}}da(){}pn(t){this.yh[t.ws]&&delete this.yh[t.ws];const i=t.getPipelineContext();i&&this.cn(i)}cn(t){const i=t;i&&i.program&&(i.program.ma=null,this.lo.deleteProgram(i.program))}rs(t){if(t)return this.isNDCHalfZRange?t.IS_NDC_HALF_ZRANGE="":delete t.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?t.USE_REVERSE_DEPTHBUFFER="":delete t.USE_REVERSE_DEPTHBUFFER,void(this.useExactSrgbConversions?t.USE_EXACT_SRGB_CONVERSIONS="":delete t.USE_EXACT_SRGB_CONVERSIONS);{let t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+="\n"),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+="\n"),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}}createEffect(t,i,e,s,n,r,h,o,a,l=qt.GLSL){var c;const u=t.vertexElement||t.vertex||t.vertexToken||t.vertexSource||t,f=t.fragmentElement||t.fragment||t.fragmentToken||t.fragmentSource||t,d=this.rs();let p=null!==(c=null!=n?n:i.defines)&&void 0!==c?c:"";d&&(p+=d);const m=u+"+"+f+"@"+p;if(this.yh[m]){const t=this.yh[m];return h&&t.isReady()&&h(t),t}const v=new ei(t,i,e,s,this,n,r,h,o,a,m,l);return this.yh[m]=v,v}static va(t,i,e=""){return e+(i?i+"\n":"")+t}ga(t,i,e,s){return this.Sa(Ei.va(t,e,s),i)}Sa(t,i){const e=this.lo,s=e.createShader("vertex"===i?e.VERTEX_SHADER:e.FRAGMENT_SHADER);if(!s){let t=e.NO_ERROR,s=e.NO_ERROR;for(;(s=e.getError())!==e.NO_ERROR;)t=s;throw new Error(`Something went wrong while creating a gl ${i} shader object. gl error=${t}, gl isContextLost=${e.isContextLost()}, _contextWasLost=${this.ph}`)}return e.shaderSource(s,t),e.compileShader(s),s}kr(t){return this.lo.getShaderSource(t)}createRawShaderProgram(t,i,e,s,n=null){s=s||this.lo;const r=this.Sa(i,"vertex"),h=this.Sa(e,"fragment");return this.Ea(t,r,h,s,n)}createShaderProgram(t,i,e,s,n,r=null){n=n||this.lo;const h=this.hh>1?"#version 300 es\n#define WEBGL2 \n":"",o=this.ga(i,"vertex",s,h),a=this.ga(e,"fragment",s,h);return this.Ea(t,o,a,n,r)}inlineShaderCode(t){return t}createPipelineContext(t){const i=new pi;return i.engine=this,this.po.parallelShaderCompile&&(i.isParallelCompiled=!0),i}createMaterialContext(){}createDrawContext(){}Ea(t,i,e,s,n=null){const r=s.createProgram();if(t.program=r,!r)throw new Error("Unable to create program");return s.attachShader(r,i),s.attachShader(r,e),s.linkProgram(r),t.context=s,t.vertexShader=i,t.fragmentShader=e,t.isParallelCompiled||this.Aa(t),r}Aa(t){const i=t.context,e=t.vertexShader,s=t.fragmentShader,n=t.program;if(!i.getProgramParameter(n,i.LINK_STATUS)){if(!this.lo.getShaderParameter(e,this.lo.COMPILE_STATUS)){const i=this.lo.getShaderInfoLog(e);if(i)throw t.vertexCompilationError=i,new Error("VERTEX SHADER "+i)}if(!this.lo.getShaderParameter(s,this.lo.COMPILE_STATUS)){const i=this.lo.getShaderInfoLog(s);if(i)throw t.fragmentCompilationError=i,new Error("FRAGMENT SHADER "+i)}const r=i.getProgramInfoLog(n);if(r)throw t.programLinkError=r,new Error(r)}if(this.validateShaderPrograms){i.validateProgram(n);if(!i.getProgramParameter(n,i.VALIDATE_STATUS)){const e=i.getProgramInfoLog(n);if(e)throw t.programValidationError=e,new Error(e)}}i.deleteShader(e),i.deleteShader(s),t.vertexShader=void 0,t.fragmentShader=void 0,t.onCompiled&&(t.onCompiled(),t.onCompiled=void 0)}on(t,i,e,s,n,r,h,o,a,l){const c=t;c.program=s?this.createRawShaderProgram(c,i,e,void 0,a):this.createShaderProgram(c,i,e,o,void 0,a),c.program.ma=h}Dr(t){const i=t;return!!this.lo.getProgramParameter(i.program,this.po.parallelShaderCompile.COMPLETION_STATUS_KHR)&&(this.Aa(i),!0)}an(t,i){const e=t;if(!e.isParallelCompiled)return void i();const s=e.onCompiled;e.onCompiled=s?()=>{s(),i()}:i}getUniforms(t,i){const e=new Array,s=t;for(let t=0;t<i.length;t++)e.push(this.lo.getUniformLocation(s.program,i[t]));return e}getAttributes(t,i){const e=[],s=t;for(let t=0;t<i.length;t++)try{e.push(this.lo.getAttribLocation(s.program,i[t]))}catch(t){e.push(-1)}return e}enableEffect(t){(t=null!==t&&vi.IsWrapper(t)?t.effect:t)&&t!==this.fa&&(this.Ah.stencilMaterial=void 0,this.bindSamplers(t),this.fa=t,t.onBind&&t.onBind(t),t.ls&&t.ls.notifyObservers(t))}setInt(t,i){return!!t&&(this.lo.uniform1i(t,i),!0)}setInt2(t,i,e){return!!t&&(this.lo.uniform2i(t,i,e),!0)}setInt3(t,i,e,s){return!!t&&(this.lo.uniform3i(t,i,e,s),!0)}setInt4(t,i,e,s,n){return!!t&&(this.lo.uniform4i(t,i,e,s,n),!0)}setIntArray(t,i){return!!t&&(this.lo.uniform1iv(t,i),!0)}setIntArray2(t,i){return!(!t||i.length%2!=0)&&(this.lo.uniform2iv(t,i),!0)}setIntArray3(t,i){return!(!t||i.length%3!=0)&&(this.lo.uniform3iv(t,i),!0)}setIntArray4(t,i){return!(!t||i.length%4!=0)&&(this.lo.uniform4iv(t,i),!0)}setUInt(t,i){return!!t&&(this.lo.uniform1ui(t,i),!0)}setUInt2(t,i,e){return!!t&&(this.lo.uniform2ui(t,i,e),!0)}setUInt3(t,i,e,s){return!!t&&(this.lo.uniform3ui(t,i,e,s),!0)}setUInt4(t,i,e,s,n){return!!t&&(this.lo.uniform4ui(t,i,e,s,n),!0)}setUIntArray(t,i){return!!t&&(this.lo.uniform1uiv(t,i),!0)}setUIntArray2(t,i){return!(!t||i.length%2!=0)&&(this.lo.uniform2uiv(t,i),!0)}setUIntArray3(t,i){return!(!t||i.length%3!=0)&&(this.lo.uniform3uiv(t,i),!0)}setUIntArray4(t,i){return!(!t||i.length%4!=0)&&(this.lo.uniform4uiv(t,i),!0)}setArray(t,i){return!!t&&(!(i.length<1)&&(this.lo.uniform1fv(t,i),!0))}setArray2(t,i){return!(!t||i.length%2!=0)&&(this.lo.uniform2fv(t,i),!0)}setArray3(t,i){return!(!t||i.length%3!=0)&&(this.lo.uniform3fv(t,i),!0)}setArray4(t,i){return!(!t||i.length%4!=0)&&(this.lo.uniform4fv(t,i),!0)}setMatrices(t,i){return!!t&&(this.lo.uniformMatrix4fv(t,!1,i),!0)}setMatrix3x3(t,i){return!!t&&(this.lo.uniformMatrix3fv(t,!1,i),!0)}setMatrix2x2(t,i){return!!t&&(this.lo.uniformMatrix2fv(t,!1,i),!0)}setFloat(t,i){return!!t&&(this.lo.uniform1f(t,i),!0)}setFloat2(t,i,e){return!!t&&(this.lo.uniform2f(t,i,e),!0)}setFloat3(t,i,e,s){return!!t&&(this.lo.uniform3f(t,i,e,s),!0)}setFloat4(t,i,e,s,n){return!!t&&(this.lo.uniform4f(t,i,e,s,n),!0)}applyStates(){if(this.Eh.apply(this.lo),this.Ah.apply(this.lo),this.wh.apply(this.lo),this.Sh){this.Sh=!1;const t=this.gh;this.lo.colorMask(t,t,t,t)}}setColorWrite(t){t!==this.gh&&(this.Sh=!0,this.gh=t)}getColorWrite(){return this.gh}get depthCullingState(){return this.Eh}get alphaState(){return this.wh}get stencilState(){return this.Ch}get stencilStateComposer(){return this.Ah}clearInternalTexturesCache(){this.Rh.length=0}wipeCaches(t){this.preventCacheWipeBetweenFrames&&!t||(this.fa=null,this.qh.x=0,this.qh.y=0,this.qh.z=0,this.qh.w=0,this.sa(),t&&(this.Ca=null,this.resetTextureCache(),this.Ah.reset(),this.Eh.reset(),this.Eh.depthFunc=this.lo.LEQUAL,this.wh.reset(),this.xh=1,this.Th=0,this.gh=!0,this.Sh=!0,this.Qh=null,this.lo.pixelStorei(this.lo.UNPACK_COLORSPACE_CONVERSION_WEBGL,this.lo.NONE),this.lo.pixelStorei(this.lo.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.kh=!0,this.unbindAllAttributes()),this.Qo(),this.ia=null,this.la=null,this.bindIndexBuffer(null))}wa(t,i){const e=this.lo;let s=e.NEAREST,n=e.NEAREST;switch(t){case 11:s=e.LINEAR,n=i?e.LINEAR_MIPMAP_NEAREST:e.LINEAR;break;case 3:s=e.LINEAR,n=i?e.LINEAR_MIPMAP_LINEAR:e.LINEAR;break;case 8:s=e.NEAREST,n=i?e.NEAREST_MIPMAP_LINEAR:e.NEAREST;break;case 4:s=e.NEAREST,n=i?e.NEAREST_MIPMAP_NEAREST:e.NEAREST;break;case 5:s=e.NEAREST,n=i?e.LINEAR_MIPMAP_NEAREST:e.LINEAR;break;case 6:s=e.NEAREST,n=i?e.LINEAR_MIPMAP_LINEAR:e.LINEAR;break;case 7:s=e.NEAREST,n=e.LINEAR;break;case 1:s=e.NEAREST,n=e.NEAREST;break;case 9:s=e.LINEAR,n=i?e.NEAREST_MIPMAP_NEAREST:e.NEAREST;break;case 10:s=e.LINEAR,n=i?e.NEAREST_MIPMAP_LINEAR:e.NEAREST;break;case 2:s=e.LINEAR,n=e.LINEAR;break;case 12:s=e.LINEAR,n=e.NEAREST}return{min:n,mag:s}}xa(){const t=this.lo.createTexture();if(!t)throw new Error("Unable to create texture");return t}Ir(){return new mi(this.xa(),this.lo)}Ta(t,i,e=!0,s=oi.Unknown){var n;let r=!1,h=0,o=3,a=5,l=!1,c=1;void 0!==i&&"object"==typeof i?(r=!!i.generateMipMaps,h=void 0===i.type?0:i.type,o=void 0===i.samplingMode?3:i.samplingMode,a=void 0===i.format?5:i.format,l=void 0!==i.useSRGBBuffer&&i.useSRGBBuffer,c=null!==(n=i.samples)&&void 0!==n?n:1):r=!!i,l&&(l=this.po.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==h||this.po.textureFloatLinearFiltering)&&(2!==h||this.po.textureHalfFloatLinearFiltering)||(o=1),1!==h||this.po.textureFloat||(h=0,F.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const u=this.lo,f=new ai(this,s),d=t.width||t,p=t.height||t,m=t.layers||0,v=this.wa(o,r),g=0!==m?u.TEXTURE_2D_ARRAY:u.TEXTURE_2D,S=this.Ra(h,a,l),E=this.Ia(a),A=this.Ma(h);return this.qo(g,f),0!==m?(f.is2DArray=!0,u.texImage3D(g,0,S,d,p,m,0,E,A,null)):u.texImage2D(g,0,S,d,p,0,E,A,null),u.texParameteri(g,u.TEXTURE_MAG_FILTER,v.mag),u.texParameteri(g,u.TEXTURE_MIN_FILTER,v.min),u.texParameteri(g,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(g,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),r&&this.lo.generateMipmap(g),this.qo(g,null),f.ur=l,f.baseWidth=d,f.baseHeight=p,f.width=d,f.height=p,f.depth=m,f.isReady=!0,f.samples=c,f.generateMipMaps=r,f.samplingMode=o,f.type=h,f.format=a,this.Rh.push(f),f}ba(t,i){return t&&this.po.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||i)}_a(t,i,e,s,n=3,r=null,h=null,o,a,l=null,c=null,u=null,f=null,d,p,m){const v="data:"===(t=t||"").substr(0,5),g="blob:"===t.substr(0,5),S=v&&-1!==t.indexOf(";base64,"),A=c||new ai(this,oi.Url),C=t;!this.$h||S||c||l||(t=this.$h(t)),C!==t&&(A.yr=C);const w=t.lastIndexOf(".");let x=f||(w>-1?t.substring(w).toLowerCase():""),T=null;x.indexOf("?")>-1&&(x=x.split("?")[0]);for(const t of Ei.ya)if(t.canLoad(x,d)){T=t;break}s&&s.addPendingData(A),A.url=t,A.generateMipMaps=!i,A.samplingMode=n,A.invertY=e,A.ur=this.ba(!!m,i),this.mh||(A.Yn=l);let R=null;r&&!c&&(R=A.onLoadedObservable.add(r)),c||this.Rh.push(A);const I=(e,c)=>{s&&s.removePendingData(A),t===C?(R&&A.onLoadedObservable.remove(R),E.UseFallbackTexture&&this._a(E.FallbackTexture,i,A.invertY,s,n,null,h,o,a,l,A),e=(e||"Unknown error")+(E.UseFallbackTexture?" - Fallback texture was used":""),A.onErrorObservable.notifyObservers({message:e,exception:c}),h&&h(e,c)):(F.Warn(`Failed to load ${t}, falling back to ${C}`),this._a(C,i,A.invertY,s,n,r,h,o,a,l,A,u,f,d,p,m))};if(T){const i=t=>{T.loadData(t,A,((t,i,e,r,h,a)=>{a?I("TextureLoader failed to load data"):o(A,x,s,{width:t,height:i},A.invertY,!e,r,(()=>(h(),!1)),n)}),p)};l?l instanceof ArrayBuffer?i(new Uint8Array(l)):ArrayBuffer.isView(l)?i(l):h&&h("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this.tn(t,(t=>i(new Uint8Array(t))),void 0,s?s.offlineProvider:void 0,!0,((t,i)=>{I("Unable to load "+(t&&t.responseURL,i))}))}else{const e=t=>{g&&!this.mh&&(A.Yn=t),o(A,x,s,t,A.invertY,i,!1,a,n)};!v||S?l&&("string"==typeof l.decoding||l.close)?e(l):Ei.Na(t,e,I,s?s.offlineProvider:null,d,A.invertY&&this.hs.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):"string"==typeof l||l instanceof ArrayBuffer||ArrayBuffer.isView(l)||l instanceof Blob?Ei.Na(l,e,I,s?s.offlineProvider:null,d,A.invertY&&this.hs.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):l&&e(l)}return A}createTexture(t,i,e,s,n=3,r=null,h=null,o=null,a=null,l=null,c=null,u,f,d,p){return this._a(t,i,e,s,n,r,h,this.Pa.bind(this),((t,i,e,n,r,h)=>{const o=this.lo,a=e.width===t&&e.height===i,c=l?this.Ia(l,r.ur):".jpg"!==n||r.ur?r.ur?o.SRGB8_ALPHA8:o.RGBA:o.RGB;let u=l?this.Ia(l):".jpg"!==n||r.ur?o.RGBA:o.RGB;if(r.ur&&1===this.webGLVersion&&(u=c),a)return o.texImage2D(o.TEXTURE_2D,0,c,u,o.UNSIGNED_BYTE,e),!1;const f=this.po.maxTextureSize;if(e.width>f||e.height>f||!this.vo)return this.Bo(),!(!this.tr||!this.ir)&&(this.tr.width=t,this.tr.height=i,this.ir.drawImage(e,0,0,e.width,e.height,0,0,t,i),o.texImage2D(o.TEXTURE_2D,0,c,u,o.UNSIGNED_BYTE,this.tr),r.width=t,r.height=i,!1);{const t=new ai(this,oi.Temp);this.qo(o.TEXTURE_2D,t,!0),o.texImage2D(o.TEXTURE_2D,0,c,u,o.UNSIGNED_BYTE,e),this.Da(t,r,s,c,(()=>{this.Nr(t),this.qo(o.TEXTURE_2D,r,!0),h()}))}return!0}),o,a,l,c,u,f,p)}static Na(t,i,e,s,n,r){throw X("FileTools")}Da(t,i,e,s,n){}createRawTexture(t,i,e,s,n,r,h,o=null,a=0,l=0,c=!1){throw X("Engine.RawTexture")}createRawCubeTexture(t,i,e,s,n,r,h,o=null){throw X("Engine.RawTexture")}createRawTexture3D(t,i,e,s,n,r,h,o,a=null,l=0){throw X("Engine.RawTexture")}createRawTexture2DArray(t,i,e,s,n,r,h,o,a=null,l=0){throw X("Engine.RawTexture")}La(t){this.Qh!==t&&(this.lo.pixelStorei(this.lo.UNPACK_FLIP_Y_WEBGL,t?1:0),this.enableUnpackFlipYCached&&(this.Qh=t))}Oa(){return this.lo.getParameter(this.lo.UNPACK_ALIGNMENT)}Fa(t){return t.isCube?this.lo.TEXTURE_CUBE_MAP:t.is3D?this.lo.TEXTURE_3D:t.is2DArray||t.isMultiview?this.lo.TEXTURE_2D_ARRAY:this.lo.TEXTURE_2D}updateTextureSamplingMode(t,i,e=!1){const s=this.Fa(i),n=this.wa(t,i.generateMipMaps||e);this.Ba(s,this.lo.TEXTURE_MAG_FILTER,n.mag,i),this.Ba(s,this.lo.TEXTURE_MIN_FILTER,n.min),e&&(i.generateMipMaps=!0,this.lo.generateMipmap(s)),this.qo(s,null),i.samplingMode=t}updateTextureDimensions(t,i,e,s=1){}updateTextureWrappingMode(t,i,e=null,s=null){const n=this.Fa(t);null!==i&&(this.Ba(n,this.lo.TEXTURE_WRAP_S,this.Ua(i),t),t.Vn=i),null!==e&&(this.Ba(n,this.lo.TEXTURE_WRAP_T,this.Ua(e),t),t.kn=e),(t.is2DArray||t.is3D)&&null!==s&&(this.Ba(n,this.lo.TEXTURE_WRAP_R,this.Ua(s),t),t.Gn=s),this.qo(n,null)}Va(t,i,e,s,n,r=1){const h=i.width||i,o=i.height||i,a=i.layers||0;t.baseWidth=h,t.baseHeight=o,t.width=h,t.height=o,t.is2DArray=a>0,t.depth=a,t.isReady=!0,t.samples=r,t.generateMipMaps=!1,t.samplingMode=s?2:1,t.type=0,t.Hn=n;const l=this.lo,c=this.Fa(t),u=this.wa(t.samplingMode,!1);l.texParameteri(c,l.TEXTURE_MAG_FILTER,u.mag),l.texParameteri(c,l.TEXTURE_MIN_FILTER,u.min),l.texParameteri(c,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(c,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===n?(l.texParameteri(c,l.TEXTURE_COMPARE_FUNC,515),l.texParameteri(c,l.TEXTURE_COMPARE_MODE,l.NONE)):(l.texParameteri(c,l.TEXTURE_COMPARE_FUNC,n),l.texParameteri(c,l.TEXTURE_COMPARE_MODE,l.COMPARE_REF_TO_TEXTURE)))}ka(t,i,e,s,n,r=0,h=0){const o=this.lo;let a=o.TEXTURE_2D;if(t.isCube&&(a=o.TEXTURE_CUBE_MAP_POSITIVE_X+r),t.ur)switch(i){case 37492:case 36196:this.po.etc2?i=o.COMPRESSED_SRGB8_ETC2:t.ur=!1;break;case 37496:this.po.etc2?i=o.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t.ur=!1;break;case 36492:i=o.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:i=o.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this.po.s3tc_srgb?i=o.COMPRESSED_SRGB_S3TC_DXT1_EXT:t.ur=!1;break;case 33777:this.po.s3tc_srgb?i=o.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:t.ur=!1;break;case 33779:this.po.s3tc_srgb?i=o.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:t.ur=!1;break;default:t.ur=!1}this.lo.compressedTexImage2D(a,h,i,e,s,0,n)}Ga(t,i,e=0,s=0,n,r=!1){const h=this.lo,o=this.Ma(t.type),a=this.Ia(t.format),l=void 0===n?this.Ra(t.type,t.format,t.ur):this.Ia(n,t.ur);this.La(t.invertY);let c=h.TEXTURE_2D;t.isCube&&(c=h.TEXTURE_CUBE_MAP_POSITIVE_X+e);const u=Math.round(Math.log(t.width)*Math.LOG2E),f=Math.round(Math.log(t.height)*Math.LOG2E),d=r?t.width:Math.pow(2,Math.max(u-s,0)),p=r?t.height:Math.pow(2,Math.max(f-s,0));h.texImage2D(c,s,l,d,p,0,a,o,i)}updateTextureData(t,i,e,s,n,r,h=0,o=0,a=!1){const l=this.lo,c=this.Ma(t.type),u=this.Ia(t.format);this.La(t.invertY);let f=l.TEXTURE_2D,d=l.TEXTURE_2D;t.isCube&&(d=l.TEXTURE_CUBE_MAP_POSITIVE_X+h,f=l.TEXTURE_CUBE_MAP),this.qo(f,t,!0),l.texSubImage2D(d,o,e,s,n,r,u,c,i),a&&this.lo.generateMipmap(d),this.qo(f,null)}za(t,i,e=0,s=0){const n=this.lo,r=t.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this.qo(r,t,!0),this.Ga(t,i,e,s),this.qo(r,null,!0)}Ha(t,i,e,s,n){const r=this.lo;if(!r)return;const h=this.wa(n,!e);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,h.mag),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,h.min),e||s||r.generateMipmap(r.TEXTURE_2D),this.qo(r.TEXTURE_2D,null),i&&i.removePendingData(t),t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear()}Pa(t,i,e,s,n,r,h,o,a=3){const l=this.getCaps().maxTextureSize,c=Math.min(l,this.needPOTTextures?Ei.GetExponentOfTwo(s.width,l):s.width),u=Math.min(l,this.needPOTTextures?Ei.GetExponentOfTwo(s.height,l):s.height),f=this.lo;f&&(t.Er?(this.qo(f.TEXTURE_2D,t,!0),this.La(void 0===n||!!n),t.baseWidth=s.width,t.baseHeight=s.height,t.width=c,t.height=u,t.isReady=!0,o(c,u,s,i,t,(()=>{this.Ha(t,e,r,h,a)}))||this.Ha(t,e,r,h,a)):e&&e.removePendingData(t))}Xa(t,i,e,s,n=1){const r=this.lo;if(t&&i)return this.Wa(e,s,n,r.DEPTH_STENCIL,r.DEPTH24_STENCIL8,r.DEPTH_STENCIL_ATTACHMENT);if(i){let t=r.DEPTH_COMPONENT16;return this.hh>1&&(t=r.DEPTH_COMPONENT32F),this.Wa(e,s,n,t,t,r.DEPTH_ATTACHMENT)}return t?this.Wa(e,s,n,r.STENCIL_INDEX8,r.STENCIL_INDEX8,r.STENCIL_ATTACHMENT):null}Wa(t,i,e,s,n,r,h=!0){const o=this.lo.createRenderbuffer();return this.$a(o,t,i,e,s,n,r,h)}$a(t,i,e,s,n,r,h,o=!0){const a=this.lo;return a.bindRenderbuffer(a.RENDERBUFFER,t),s>1&&a.renderbufferStorageMultisample?a.renderbufferStorageMultisample(a.RENDERBUFFER,s,r,i,e):a.renderbufferStorage(a.RENDERBUFFER,n,i,e),a.framebufferRenderbuffer(a.FRAMEBUFFER,h,a.RENDERBUFFER,t),o&&a.bindRenderbuffer(a.RENDERBUFFER,null),t}Nr(t){var i;this.Ya(null===(i=t.Er)||void 0===i?void 0:i.underlyingResource),this.unbindAllTextures();const e=this.Rh.indexOf(t);-1!==e&&this.Rh.splice(e,1),t.dr&&t.dr.dispose(),t.pr&&t.pr.dispose(),t.mr&&t.mr.dispose(),t.Sr&&t.Sr.dispose()}ja(t){const i=this.Ih.indexOf(t);-1!==i&&this.Ih.splice(i,1)}Ya(t){t&&this.lo.deleteTexture(t)}Ka(t){this.Ca!==t&&(this.lo.useProgram(t),this.Ca=t)}bindSamplers(t){const i=t.getPipelineContext();this.Ka(i.program);const e=t.getSamplers();for(let i=0;i<e.length;i++){const s=t.getUniform(e[i]);s&&(this.Zh[i]=s)}this.fa=null}qa(){this.bh!==this.Mh&&(this.lo.activeTexture(this.lo.TEXTURE0+this.Mh),this.bh=this.Mh)}qo(t,i,e=!1,s=!1){var n,r;let h=!1;const o=i&&i.Wn>-1;e&&o&&(this.Mh=i.Wn);if(this._h[this.Mh]!==i||s){if(this.qa(),i&&i.isMultiview)throw console.error(t,i),"_bindTextureDirectly called with a multiview texture!";this.lo.bindTexture(t,null!==(r=null===(n=null==i?void 0:i.Er)||void 0===n?void 0:n.underlyingResource)&&void 0!==r?r:null),this._h[this.Mh]=i,i&&(i.Wn=this.Mh)}else e&&(h=!0,this.qa());return o&&!e&&this.Qa(i.Wn,this.Mh),h}fn(t,i,e){if(void 0===t)return;i&&(i.Wn=t),this.Mh=t;const s=i?this.Fa(i):this.lo.TEXTURE_2D;this.qo(s,i)}unbindAllTextures(){for(let t=0;t<this.zh;t++)this.Mh=t,this.qo(this.lo.TEXTURE_2D,null),this.qo(this.lo.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this.qo(this.lo.TEXTURE_3D,null),this.qo(this.lo.TEXTURE_2D_ARRAY,null))}setTexture(t,i,e,s){void 0!==t&&(i&&(this.Zh[t]=i),this.Za(t,e))}Qa(t,i){const e=this.Zh[t];e&&e.Ja!==i&&(this.lo.uniform1i(e,i),e.Ja=i)}Ua(t){switch(t){case 1:return this.lo.REPEAT;case 0:return this.lo.CLAMP_TO_EDGE;case 2:return this.lo.MIRRORED_REPEAT}return this.lo.REPEAT}Za(t,i,e=!1,s=!1,n=""){if(!i)return null!=this._h[t]&&(this.Mh=t,this.qo(this.lo.TEXTURE_2D,null),this.qo(this.lo.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this.qo(this.lo.TEXTURE_3D,null),this.qo(this.lo.TEXTURE_2D_ARRAY,null))),!1;if(i.video)this.Mh=t,i.update();else if(4===i.delayLoadState)return i.delayLoad(),!1;let r;r=s?i.depthStencilTexture:i.isReady()?i.getInternalTexture():i.isCube?this.emptyCubeTexture:i.is3D?this.emptyTexture3D:i.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!e&&r&&(r.Wn=t);let h=!0;this._h[t]===r&&(e||this.Qa(r.Wn,t),h=!1),this.Mh=t;const o=this.Fa(r);if(h&&this.qo(o,r,e),r&&!r.isMultiview){if(r.isCube&&r.er!==i.coordinatesMode){r.er=i.coordinatesMode;const t=3!==i.coordinatesMode&&5!==i.coordinatesMode?1:0;i.wrapU=t,i.wrapV=t}r.Vn!==i.wrapU&&(r.Vn=i.wrapU,this.Ba(o,this.lo.TEXTURE_WRAP_S,this.Ua(i.wrapU),r)),r.kn!==i.wrapV&&(r.kn=i.wrapV,this.Ba(o,this.lo.TEXTURE_WRAP_T,this.Ua(i.wrapV),r)),r.is3D&&r.Gn!==i.wrapR&&(r.Gn=i.wrapR,this.Ba(o,this.lo.TEXTURE_WRAP_R,this.Ua(i.wrapR),r)),this.tl(o,r,i.anisotropicFilteringLevel)}return!0}setTextureArray(t,i,e,s){if(void 0!==t&&i){this.il&&this.il.length===e.length||(this.il=new Int32Array(e.length));for(let i=0;i<e.length;i++){const s=e[i].getInternalTexture();s?(this.il[i]=t+i,s.Wn=t+i):this.il[i]=-1}this.lo.uniform1iv(i,this.il);for(let t=0;t<e.length;t++)this.Za(this.il[t],e[t],!0)}}tl(t,i,e){const s=this.po.textureAnisotropicFilterExtension;11!==i.samplingMode&&3!==i.samplingMode&&2!==i.samplingMode&&(e=1),s&&i.zn!==e&&(this.el(t,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(e,this.po.maxAnisotropy),i),i.zn=e)}el(t,i,e,s){this.qo(t,s,!0,!0),this.lo.texParameterf(t,i,e)}Ba(t,i,e,s){s&&this.qo(t,s,!0,!0),this.lo.texParameteri(t,i,e)}unbindAllAttributes(){if(this.kh){this.kh=!1;for(let t=0;t<this.po.maxVertexAttribs;t++)this.disableAttributeByIndex(t)}else for(let t=0,i=this.Nh.length;t<i;t++)t>=this.po.maxVertexAttribs||!this.Nh[t]||this.disableAttributeByIndex(t)}releaseEffects(){for(const t in this.yh){const i=this.yh[t].getPipelineContext();this.cn(i)}this.yh={}}dispose(){var t;this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this.Ao&&(this.Nr(this.Ao),this.Ao=null),this.xo&&(this.Nr(this.xo),this.xo=null),this.Oh&&this.lo.deleteFramebuffer(this.Oh),this.releaseEffects(),null===(t=this.releaseComputeEffects)||void 0===t||t.call(this),this.unbindAllAttributes(),this.Zh={},xt()&&this.io&&(this.mh||(this.io.removeEventListener("webglcontextlost",this.ro),this.io.removeEventListener("webglcontextrestored",this.ho)),window.removeEventListener("resize",this.no)),this.tr=null,this.ir=null,this.Fh.length=0,this.io=null,this.Ca=null,this.Go=null,ei.ResetCache();for(const t of this.Xh)t.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}attachContextLostEvent(t){this.io&&this.io.addEventListener("webglcontextlost",t,!1)}attachContextRestoredEvent(t){this.io&&this.io.addEventListener("webglcontextrestored",t,!1)}getError(){return this.lo.getError()}Lo(){return this.hh>1?this.po.colorBufferFloat:this.sl(1)}Oo(){return this.hh>1?this.po.colorBufferFloat:this.sl(2)}sl(t){const i=this.lo;for(;i.getError()!==i.NO_ERROR;);let e=!0;const s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,0,this.Ra(t),1,1,0,i.RGBA,this.Ma(t),null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);const n=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,n),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0);const r=i.checkFramebufferStatus(i.FRAMEBUFFER);if(e=e&&r===i.FRAMEBUFFER_COMPLETE,e=e&&i.getError()===i.NO_ERROR,e&&(i.clear(i.COLOR_BUFFER_BIT),e=e&&i.getError()===i.NO_ERROR),e){i.bindFramebuffer(i.FRAMEBUFFER,null);const t=i.RGBA,s=i.UNSIGNED_BYTE,n=new Uint8Array(4);i.readPixels(0,0,1,1,t,s,n),e=e&&i.getError()===i.NO_ERROR}for(i.deleteTexture(s),i.deleteFramebuffer(n),i.bindFramebuffer(i.FRAMEBUFFER,null);!e&&i.getError()!==i.NO_ERROR;);return e}Ma(t){if(1===this.hh){switch(t){case 1:return this.lo.FLOAT;case 2:return this.lo.HALF_FLOAT_OES;case 0:return this.lo.UNSIGNED_BYTE;case 8:return this.lo.UNSIGNED_SHORT_4_4_4_4;case 9:return this.lo.UNSIGNED_SHORT_5_5_5_1;case 10:return this.lo.UNSIGNED_SHORT_5_6_5}return this.lo.UNSIGNED_BYTE}switch(t){case 3:return this.lo.BYTE;case 0:return this.lo.UNSIGNED_BYTE;case 4:return this.lo.SHORT;case 5:return this.lo.UNSIGNED_SHORT;case 6:return this.lo.INT;case 7:return this.lo.UNSIGNED_INT;case 1:return this.lo.FLOAT;case 2:return this.lo.HALF_FLOAT;case 8:return this.lo.UNSIGNED_SHORT_4_4_4_4;case 9:return this.lo.UNSIGNED_SHORT_5_5_5_1;case 10:return this.lo.UNSIGNED_SHORT_5_6_5;case 11:return this.lo.UNSIGNED_INT_2_10_10_10_REV;case 12:return this.lo.UNSIGNED_INT_24_8;case 13:return this.lo.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this.lo.UNSIGNED_INT_5_9_9_9_REV;case 15:return this.lo.FLOAT_32_UNSIGNED_INT_24_8_REV}return this.lo.UNSIGNED_BYTE}Ia(t,i=!1){let e=i?this.lo.SRGB8_ALPHA8:this.lo.RGBA;switch(t){case 0:e=this.lo.ALPHA;break;case 1:e=this.lo.LUMINANCE;break;case 2:e=this.lo.LUMINANCE_ALPHA;break;case 6:e=this.lo.RED;break;case 7:e=this.lo.RG;break;case 4:e=i?this.lo.SRGB:this.lo.RGB;break;case 5:e=i?this.lo.SRGB8_ALPHA8:this.lo.RGBA}if(this.hh>1)switch(t){case 8:e=this.lo.RED_INTEGER;break;case 9:e=this.lo.RG_INTEGER;break;case 10:e=this.lo.RGB_INTEGER;break;case 11:e=this.lo.RGBA_INTEGER}return e}Ra(t,i,e=!1){if(1===this.hh){if(void 0!==i)switch(i){case 0:return this.lo.ALPHA;case 1:return this.lo.LUMINANCE;case 2:return this.lo.LUMINANCE_ALPHA;case 4:return e?this.lo.SRGB:this.lo.RGB}return this.lo.RGBA}switch(t){case 3:switch(i){case 6:return this.lo.R8_SNORM;case 7:return this.lo.RG8_SNORM;case 4:return this.lo.RGB8_SNORM;case 8:return this.lo.R8I;case 9:return this.lo.RG8I;case 10:return this.lo.RGB8I;case 11:return this.lo.RGBA8I;default:return this.lo.RGBA8_SNORM}case 0:switch(i){case 6:return this.lo.R8;case 7:return this.lo.RG8;case 4:return e?this.lo.SRGB8:this.lo.RGB8;case 5:return e?this.lo.SRGB8_ALPHA8:this.lo.RGBA8;case 8:return this.lo.R8UI;case 9:return this.lo.RG8UI;case 10:return this.lo.RGB8UI;case 11:return this.lo.RGBA8UI;case 0:return this.lo.ALPHA;case 1:return this.lo.LUMINANCE;case 2:return this.lo.LUMINANCE_ALPHA;default:return this.lo.RGBA8}case 4:switch(i){case 8:return this.lo.R16I;case 9:return this.lo.RG16I;case 10:return this.lo.RGB16I;default:return this.lo.RGBA16I}case 5:switch(i){case 8:return this.lo.R16UI;case 9:return this.lo.RG16UI;case 10:return this.lo.RGB16UI;default:return this.lo.RGBA16UI}case 6:switch(i){case 8:return this.lo.R32I;case 9:return this.lo.RG32I;case 10:return this.lo.RGB32I;default:return this.lo.RGBA32I}case 7:switch(i){case 8:return this.lo.R32UI;case 9:return this.lo.RG32UI;case 10:return this.lo.RGB32UI;default:return this.lo.RGBA32UI}case 1:switch(i){case 6:return this.lo.R32F;case 7:return this.lo.RG32F;case 4:return this.lo.RGB32F;default:return this.lo.RGBA32F}case 2:switch(i){case 6:return this.lo.R16F;case 7:return this.lo.RG16F;case 4:return this.lo.RGB16F;default:return this.lo.RGBA16F}case 10:return this.lo.RGB565;case 13:return this.lo.R11F_G11F_B10F;case 14:return this.lo.RGB9_E5;case 8:return this.lo.RGBA4;case 9:return this.lo.RGB5_A1;case 11:switch(i){case 5:default:return this.lo.RGB10_A2;case 11:return this.lo.RGB10_A2UI}}return e?this.lo.SRGB8_ALPHA8:this.lo.RGBA8}nl(t){return 1===t?this.lo.RGBA32F:2===t?this.lo.RGBA16F:this.lo.RGBA8}tn(t,i,e,s,n,r){const h=Ei.os(t,i,e,s,n,r);return this.Xh.push(h),h.onCompleteObservable.add((t=>{this.Xh.splice(this.Xh.indexOf(t),1)})),h}static os(t,i,e,s,n,r){throw X("FileTools")}readPixels(t,i,e,s,n=!0,r=!0){const h=n?4:3,o=n?this.lo.RGBA:this.lo.RGB,a=new Uint8Array(s*e*h);return r&&this.flushFramebuffer(),this.lo.readPixels(t,i,e,s,o,this.lo.UNSIGNED_BYTE,a),Promise.resolve(a)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this.rl)return!this.rl;if(null===this.hl)try{const t=this.To(1,1),i=t.getContext("webgl")||t.getContext("experimental-webgl");this.hl=null!=i&&!!window.WebGLRenderingContext}catch(t){this.hl=!1}return this.hl}static get HasMajorPerformanceCaveat(){if(null===this.rl)try{const t=this.To(1,1),i=t.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||t.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this.rl=!i}catch(t){this.rl=!1}return this.rl}static CeilingPOT(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}static FloorPOT(t){return t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,(t|=t>>16)-(t>>1)}static NearestPOT(t){const i=Ei.CeilingPOT(t),e=Ei.FloorPOT(t);return i-t>t-e?e:i}static GetExponentOfTwo(t,i,e=2){let s;switch(e){case 1:s=Ei.FloorPOT(t);break;case 2:s=Ei.NearestPOT(t);break;default:s=Ei.CeilingPOT(t)}return Math.min(s,i)}static QueueNewFrame(t,i){if(xt()){const{requestPostAnimationFrame:e,requestAnimationFrame:s}=i||window;if("function"==typeof e)return e(t);if("function"==typeof s)return s(t)}else if("function"==typeof requestAnimationFrame)return requestAnimationFrame(t);return setTimeout(t,16)}getHostDocument(){return this.io&&this.io.ownerDocument?this.io.ownerDocument:Rt()?document:null}}Ei.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],Ei.ya=[],Ei.CollisionsEpsilon=.001,Ei.hl=null,Ei.rl=null;class Ai{static SetImmediate(t){xt()&&window.setImmediate?window.setImmediate(t):setTimeout(t,1)}}const Ci=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class wi extends Bt{constructor(t,i){super(t,Lt),this.name="LoadFileError",yt.ze(this,wi.prototype),i instanceof mt?this.request=i:this.file=i}}class xi extends Bt{constructor(t,i){super(t,Ot),this.request=i,this.name="RequestFileError",yt.ze(this,xi.prototype)}}class Ti extends Bt{constructor(t,i){super(t,Ft),this.file=i,this.name="ReadFileError",yt.ze(this,Ti.prototype)}}const Ri={DefaultRetryStrategy:class{static ExponentialBackoff(t=3,i=500){return(e,s,n)=>0!==s.status||n>=t||-1!==e.indexOf("file:")?-1:Math.pow(2,n)*i}}.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:t=>t},Ii=t=>t=t.replace(/#/gm,"%23"),Mi=(t,i)=>{if((!t||0!==t.indexOf("data:"))&&Ri.CorsBehavior)if("string"==typeof Ri.CorsBehavior||Ri.CorsBehavior instanceof String)i.crossOrigin=Ri.CorsBehavior;else{const e=Ri.CorsBehavior(t);e&&(i.crossOrigin=e)}},bi=(t,i,e,s,n="",r)=>{var h;let o,a=!1;t instanceof ArrayBuffer||ArrayBuffer.isView(t)?"undefined"!=typeof Blob&&"undefined"!=typeof URL?(o=URL.createObjectURL(new Blob([t],{type:n})),a=!0):o=`data:${n};base64,`+Ut(t):t instanceof Blob?(o=URL.createObjectURL(t),a=!0):(o=Ii(t),o=Ri.PreprocessUrl(t));const l=E.LastCreatedEngine,c=i=>{if(e){const s=o||t.toString();e(`Error while trying to load image: ${0===s.indexOf("http")||s.length<=128?s:s.slice(0,128)+"..."}`,i)}};if("undefined"==typeof Image||null!==(h=null==l?void 0:l.hs.forceBitmapOverHTMLImageElement)&&void 0!==h&&h)return yi(o,(s=>{l.createImageBitmap(new Blob([s],{type:n}),{premultiplyAlpha:"none",...r}).then((t=>{i(t),a&&URL.revokeObjectURL(o)})).catch((i=>{e&&e("Error while trying to load image: "+t,i)}))}),void 0,s||void 0,!0,((t,i)=>{c(i)})),null;const u=new Image;Mi(o,u);const f=[],d=()=>{f.forEach((t=>{t.target.removeEventListener(t.name,t.handler)})),f.length=0};f.push({target:u,name:"load",handler:()=>{d(),i(u),a&&u.src&&URL.revokeObjectURL(u.src)}}),f.push({target:u,name:"error",handler:t=>{d(),c(t),a&&u.src&&URL.revokeObjectURL(u.src)}}),f.push({target:document,name:"securitypolicyviolation",handler:t=>{d();const i=new Error(`CSP violation of policy ${t.effectiveDirective} ${t.blockedURI}. Current policy is ${t.originalPolicy}`);E.UseFallbackTexture=!1,c(i),a&&u.src&&URL.revokeObjectURL(u.src),u.src=""}}),f.forEach((t=>{t.target.addEventListener(t.name,t.handler)}));const p="blob:"===o.substring(0,5),m="data:"===o.substring(0,5),v=()=>{p||m?u.src=o:yi(o,((t,i,e)=>{const s=new Blob([t],{type:!n&&e?e:n}),r=URL.createObjectURL(s);a=!0,u.src=r}),void 0,s||void 0,!0,((t,i)=>{c(i)}))},g=()=>{s&&s.loadImage(o,u)};if(!p&&!m&&s&&s.enableTexturesOffline)s.open(g,v);else{if(-1!==o.indexOf("file:")){const t=decodeURIComponent(o.substring(5).toLowerCase());if(_t.FilesToLoad[t]&&"undefined"!=typeof URL){try{let i;try{i=URL.createObjectURL(_t.FilesToLoad[t])}catch(e){i=URL.createObjectURL(_t.FilesToLoad[t])}u.src=i,a=!0}catch(t){u.src=""}return u}}v()}return u},_i=(t,i,e,s,n)=>{const r=new FileReader,o={onCompleteObservable:new h,abort:()=>r.abort()};return r.onloadend=()=>o.onCompleteObservable.notifyObservers(o),n&&(r.onerror=()=>{n(new Ti(`Unable to read ${t.name}`,t))}),r.onload=t=>{i(t.target.result)},e&&(r.onprogress=e),s?r.readAsArrayBuffer(t):r.readAsText(t),o},yi=(t,i,e,s,n,r,o)=>{if(t.name)return _i(t,i,e,n,r?t=>{r(void 0,t)}:void 0);const a=t;if(-1!==a.indexOf("file:")){let t=decodeURIComponent(a.substring(5).toLowerCase());0===t.indexOf("./")&&(t=t.substring(2));const s=_t.FilesToLoad[t];if(s)return _i(s,i,e,n,r?t=>r(void 0,new wi(t.message,t.file)):void 0)}const{match:l,type:c}=Li(a);if(l){const t={onCompleteObservable:new h,abort:()=>()=>{}};try{const t=n?Oi(a):Fi(a);i(t,void 0,c)}catch(t){r?r(void 0,t):F.Error(t.message||"Failed to parse the Data URL")}return Ai.SetImmediate((()=>{t.onCompleteObservable.notifyObservers(t)})),t}return Ni(a,((t,e)=>{i(t,null==e?void 0:e.responseURL,null==e?void 0:e.getResponseHeader("content-type"))}),e,s,n,r?t=>{r(t.request,new wi(t.message,t.request))}:void 0,o)},Ni=(t,i,e,s,n,r,o)=>{t=Ii(t),t=Ri.PreprocessUrl(t);const a=Ri.BaseUrl+t;let l=!1;const c={onCompleteObservable:new h,abort:()=>l=!0},u=()=>{let t,s=new mt,h=null;const u=()=>{s&&(e&&s.removeEventListener("progress",e),t&&s.removeEventListener("readystatechange",t),s.removeEventListener("loadend",f))};let f=()=>{u(),c.onCompleteObservable.notifyObservers(c),c.onCompleteObservable.clear(),e=void 0,t=null,f=null,r=void 0,o=void 0,i=void 0};c.abort=()=>{l=!0,f&&f(),s&&s.readyState!==(XMLHttpRequest.DONE||4)&&s.abort(),null!==h&&(clearTimeout(h),h=null),s=null};const d=t=>{const i=t.message||"Unknown error";r&&s?r(new xi(i,s)):F.Error(i)},p=c=>{if(s){if(s.open("GET",a),o)try{o(s)}catch(t){return void d(t)}n&&(s.responseType="arraybuffer"),e&&s.addEventListener("progress",e),f&&s.addEventListener("loadend",f),t=()=>{if(!l&&s&&s.readyState===(XMLHttpRequest.DONE||4)){if(t&&s.removeEventListener("readystatechange",t),s.status>=200&&s.status<300||0===s.status&&(!xt()||Pi())){try{i&&i(n?s.response:s.responseText,s)}catch(t){d(t)}return}const e=Ri.DefaultRetryStrategy;if(e){const t=e(a,s,c);if(-1!==t)return u(),s=new mt,void(h=setTimeout((()=>p(c+1)),t))}const o=new xi("Error status: "+s.status+" "+s.statusText+" - Unable to load "+a,s);r&&r(o)}},s.addEventListener("readystatechange",t),s.send()}};p(0)};if(s&&s.enableSceneOffline){const h=t=>{t&&t.status>400?r&&r(t):u()},o=()=>{s&&s.loadFile(Ri.BaseUrl+t,(t=>{!l&&i&&i(t),c.onCompleteObservable.notifyObservers(c)}),e?t=>{!l&&e&&e(t)}:void 0,h,n)};s.open(o,h)}else u();return c},Pi=()=>"undefined"!=typeof location&&"file:"===location.protocol,Di=t=>Ci.test(t),Li=t=>{const i=Ci.exec(t);if(null===i||0===i.length)return{match:!1,type:""};return{match:!0,type:i[0].replace("data:","").replace("base64,","")}};function Oi(t){return kt(t.split(",")[1])}const Fi=t=>Vt(t.split(",")[1]);let Bi;Ei.Na=bi,Ei.os=yi,ti.os=yi;((t,i,e,s,n,r,h,o,a,l)=>{Bi={DecodeBase64UrlToBinary:t,DecodeBase64UrlToString:i,DefaultRetryStrategy:e.DefaultRetryStrategy,BaseUrl:e.BaseUrl,CorsBehavior:e.CorsBehavior,PreprocessUrl:e.PreprocessUrl,IsBase64DataUrl:s,IsFileURL:n,LoadFile:r,LoadImage:h,ReadFile:o,RequestFile:a,SetCorsBehavior:l},Object.defineProperty(Bi,"DefaultRetryStrategy",{get:function(){return e.DefaultRetryStrategy},set:function(t){e.DefaultRetryStrategy=t}}),Object.defineProperty(Bi,"BaseUrl",{get:function(){return e.BaseUrl},set:function(t){e.BaseUrl=t}}),Object.defineProperty(Bi,"PreprocessUrl",{get:function(){return e.PreprocessUrl},set:function(t){e.PreprocessUrl=t}}),Object.defineProperty(Bi,"CorsBehavior",{get:function(){return e.CorsBehavior},set:function(t){e.CorsBehavior=t}})})(Oi,Fi,Ri,Di,Pi,yi,bi,_i,Ni,Mi);class Ui{static Instantiate(t){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[t])return this.RegisteredExternalClasses[t];const i=g(t);if(i)return i;F.Warn(t+" not found, you may have missed an import.");const e=t.split(".");let s=window||this;for(let t=0,i=e.length;t<i;t++)s=s[e[t]];return"function"!=typeof s?null:s}}function Vi(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const i=16*Math.random()|0;return("x"===t?i:3&i|8).toString(16)}))}Ui.RegisteredExternalClasses={};class ki{static get BaseUrl(){return Ri.BaseUrl}static set BaseUrl(t){Ri.BaseUrl=t}static get DefaultRetryStrategy(){return Ri.DefaultRetryStrategy}static set DefaultRetryStrategy(t){Ri.DefaultRetryStrategy=t}static get CorsBehavior(){return Ri.CorsBehavior}static set CorsBehavior(t){Ri.CorsBehavior=t}static get UseFallbackTexture(){return E.UseFallbackTexture}static set UseFallbackTexture(t){E.UseFallbackTexture=t}static get RegisteredExternalClasses(){return Ui.RegisteredExternalClasses}static set RegisteredExternalClasses(t){Ui.RegisteredExternalClasses=t}static get fallbackTexture(){return E.FallbackTexture}static set fallbackTexture(t){E.FallbackTexture=t}static FetchToRef(t,i,e,s,n,r){const h=4*((Math.abs(t)*e%e|0)+(Math.abs(i)*s%s|0)*e);r.r=n[h]/255,r.g=n[h+1]/255,r.b=n[h+2]/255,r.a=n[h+3]/255}static Mix(t,i,e){return t*(1-e)+i*e}static Instantiate(t){return Ui.Instantiate(t)}static SetImmediate(t){Ai.SetImmediate(t)}static IsExponentOfTwo(t){let i=1;do{i*=2}while(i<t);return i===t}static FloatRound(t){return Math.fround?Math.fround(t):(ki.ol[0]=t,ki.ol[0])}static GetFilename(t){const i=t.lastIndexOf("/");return i<0?t:t.substring(i+1)}static GetFolderPath(t,i=!1){const e=t.lastIndexOf("/");return e<0?i?t:"":t.substring(0,e+1)}static ToDegrees(t){return 180*t/Math.PI}static ToRadians(t){return t*Math.PI/180}static SmoothAngleChange(t,i,e=.9){const s=this.ToRadians(t),n=this.ToRadians(i);return this.ToDegrees(Math.atan2((1-e)*Math.sin(n)+e*Math.sin(s),(1-e)*Math.cos(n)+e*Math.cos(s)))}static MakeArray(t,i){return!0===i||void 0!==t&&null!=t?Array.isArray(t)?t:[t]:null}static GetPointerPrefix(t){let i="pointer";return xt()&&!window.PointerEvent&&(i="mouse"),!t.uh||t.lh||document&&"ontouchend"in document||(i="mouse"),i}static SetCorsBehavior(t,i){Mi(t,i)}static SetReferrerPolicyBehavior(t,i){i.referrerPolicy=t}static CleanUrl(t){return t=t.replace(/#/gm,"%23")}static get PreprocessUrl(){return Ri.PreprocessUrl}static set PreprocessUrl(t){Ri.PreprocessUrl=t}static LoadImage(t,i,e,s,n,r){return bi(t,i,e,s,n,r)}static LoadFile(t,i,e,s,n,r){return yi(t,i,e,s,n,r)}static LoadFileAsync(t,i=!0){return new Promise(((e,s)=>{yi(t,(t=>{e(t)}),void 0,void 0,i,((t,i)=>{s(i)}))}))}static LoadScript(t,i,e,s){if("function"==typeof importScripts){try{importScripts(t),i()}catch(i){null==e||e(`Unable to load script '${t}' in worker`,i)}return}if(!xt())return void(null==e||e(`Cannot load script '${t}' outside of a window or a worker`));const n=document.getElementsByTagName("head")[0],r=document.createElement("script");r.setAttribute("type","text/javascript"),r.setAttribute("src",t),s&&(r.id=s),r.onload=()=>{i&&i()},r.onerror=i=>{e&&e(`Unable to load script '${t}'`,i)},n.appendChild(r)}static LoadScriptAsync(t){return new Promise(((i,e)=>{this.LoadScript(t,(()=>{i()}),((t,i)=>{e(i||new Error(t))}))}))}static ReadFileAsDataURL(t,i,e){const s=new FileReader,n={onCompleteObservable:new h,abort:()=>s.abort()};return s.onloadend=()=>{n.onCompleteObservable.notifyObservers(n)},s.onload=t=>{i(t.target.result)},s.onprogress=e,s.readAsDataURL(t),n}static ReadFile(t,i,e,s,n){return _i(t,i,e,s,n)}static FileAsURL(t){const i=new Blob([t]);return window.URL.createObjectURL(i)}static Format(t,i=2){return t.toFixed(i)}static DeepCopy(t,i,e,s){k.DeepCopy(t,i,e,s)}static IsEmpty(t){for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!1;return!0}static RegisterTopRootEvents(t,i){for(let e=0;e<i.length;e++){const s=i[e];t.addEventListener(s.name,s.handler,!1);try{window.parent&&window.parent.addEventListener(s.name,s.handler,!1)}catch(t){}}}static UnregisterTopRootEvents(t,i){for(let e=0;e<i.length;e++){const s=i[e];t.removeEventListener(s.name,s.handler);try{t.parent&&t.parent.removeEventListener(s.name,s.handler)}catch(t){}}}static async DumpFramebuffer(t,i,e,s,n="image/png",r){throw X("DumpTools")}static DumpData(t,i,e,s,n="image/png",r,h=!1,o=!1,a){throw X("DumpTools")}static DumpDataAsync(t,i,e,s="image/png",n,r=!1,h=!1,o){throw X("DumpTools")}static ToBlob(t,i,e="image/png",s){t.toBlob||(t.toBlob=function(t,i,e){setTimeout((()=>{const s=atob(this.toDataURL(i,e).split(",")[1]),n=s.length,r=new Uint8Array(n);for(let t=0;t<n;t++)r[t]=s.charCodeAt(t);t(new Blob([r]))}))}),t.toBlob((function(t){i(t)}),e,s)}static DownloadBlob(t,i){if("download"in document.createElement("a")){if(!i){const t=new Date;i="screenshot_"+((t.getFullYear()+"-"+(t.getMonth()+1)).slice(2)+"-"+t.getDate()+"_"+t.getHours()+"-"+("0"+t.getMinutes()).slice(-2))+".png"}ki.Download(t,i)}else if(t&&"undefined"!=typeof URL){const i=URL.createObjectURL(t),e=window.open("");if(!e)return;const s=e.document.createElement("img");s.onload=function(){URL.revokeObjectURL(i)},s.src=i,e.document.body.appendChild(s)}}static EncodeScreenshotCanvasData(t,i,e="image/png",s,n){if(i){i(t.toDataURL(e,n))}else this.ToBlob(t,(function(t){t&&ki.DownloadBlob(t,s)}),e,n)}static Download(t,i){if("undefined"==typeof URL)return;const e=window.URL.createObjectURL(t),s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=e,s.download=i,s.addEventListener("click",(()=>{s.parentElement&&s.parentElement.removeChild(s)})),s.click(),window.URL.revokeObjectURL(e)}static BackCompatCameraNoPreventDefault(t){return"boolean"==typeof t[0]?t[0]:"boolean"==typeof t[1]&&t[1]}static CreateScreenshot(t,i,e,s,n="image/png"){throw X("ScreenshotTools")}static CreateScreenshotAsync(t,i,e,s="image/png"){throw X("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(t,i,e,s,n="image/png",r=1,h=!1,o){throw X("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(t,i,e,s="image/png",n=1,r=!1,h){throw X("ScreenshotTools")}static RandomId(){return Vi()}static IsBase64(t){return Di(t)}static DecodeBase64(t){return Oi(t)}static get errorsCount(){return F.errorsCount}static Log(t){F.Log(t)}static Warn(t){F.Warn(t)}static Error(t){F.Error(t)}static get LogCache(){return F.LogCache}static ClearLogCache(){F.ClearLogCache()}static set LogLevels(t){F.LogLevels=t}static set PerformanceLogLevel(t){return(t&ki.PerformanceUserMarkLogLevel)===ki.PerformanceUserMarkLogLevel?(ki.StartPerformanceCounter=ki.al,void(ki.EndPerformanceCounter=ki.ll)):(t&ki.PerformanceConsoleLogLevel)===ki.PerformanceConsoleLogLevel?(ki.StartPerformanceCounter=ki.cl,void(ki.EndPerformanceCounter=ki.ul)):(ki.StartPerformanceCounter=ki.fl,void(ki.EndPerformanceCounter=ki.dl))}static fl(t,i){}static dl(t,i){}static al(t,i=!0){if(!ki.pl){if(!xt())return;ki.pl=window.performance}i&&ki.pl.mark&&ki.pl.mark(t+"-Begin")}static ll(t,i=!0){i&&ki.pl.mark&&(ki.pl.mark(t+"-End"),ki.pl.measure(t,t+"-Begin",t+"-End"))}static cl(t,i=!0){i&&(ki.al(t,i),console.time&&console.time(t))}static ul(t,i=!0){i&&(ki.ll(t,i),console.timeEnd(t))}static get Now(){return bt.Now}static GetClassName(t,i=!1){let e=null;if(!i&&t.getClassName)e=t.getClassName();else{if(t instanceof Object){e=(i?t:Object.getPrototypeOf(t)).constructor.ml}e||(e=typeof t)}return e}static First(t,i){for(const e of t)if(i(e))return e;return null}static getFullClassName(t,i=!1){let e=null,s=null;if(!i&&t.getClassName)e=t.getClassName();else{if(t instanceof Object){const n=i?t:Object.getPrototypeOf(t);e=n.constructor.ml,s=n.constructor.vl}e||(e=typeof t)}return e?(null!=s?s+".":"")+e:null}static DelayAsync(t){return new Promise((i=>{setTimeout((()=>{i()}),t)}))}static IsSafari(){return!!Tt()&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}}ki.UseCustomRequestHeaders=!1,ki.CustomRequestHeaders=mt.CustomRequestHeaders,ki.ol=new Float32Array(1),ki.GetDOMTextContent=It,ki.GetAbsoluteUrl="object"==typeof document?t=>{const i=document.createElement("a");return i.href=t,i.href}:"function"==typeof URL&&"object"==typeof location?t=>new URL(t,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},ki.NoneLogLevel=F.NoneLogLevel,ki.MessageLogLevel=F.MessageLogLevel,ki.WarningLogLevel=F.WarningLogLevel,ki.ErrorLogLevel=F.ErrorLogLevel,ki.AllLogLevel=F.AllLogLevel,ki.IsWindowObjectExist=xt,ki.PerformanceNoneLogLevel=0,ki.PerformanceUserMarkLogLevel=1,ki.PerformanceConsoleLogLevel=2,ki.StartPerformanceCounter=ki.fl,ki.EndPerformanceCounter=ki.dl;class Gi{constructor(t,i,e,s=0){this.iterations=t,this.index=s-1,this.gl=!1,this.Sl=i,this.El=e}executeNext(){this.gl||(this.index+1<this.iterations?(++this.index,this.Sl(this)):this.breakLoop())}breakLoop(){this.gl=!0,this.El()}static Run(t,i,e,s=0){const n=new Gi(t,i,e,s);return n.executeNext(),n}static SyncAsyncForLoop(t,i,e,s,n,r=0){return Gi.Run(Math.ceil(t/i),(s=>{n&&n()?s.breakLoop():setTimeout((()=>{for(let r=0;r<i;++r){const h=s.index*i+r;if(h>=t)break;if(e(h),n&&n()){s.breakLoop();break}}s.executeNext()}),r)}),s)}}E.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";class zi{constructor(t){this.length=0,this.data=new Array(t),this.Al=zi.Cl++}push(t){this.data[this.length++]=t,this.length>this.data.length&&(this.data.length*=2)}forEach(t){for(let i=0;i<this.length;i++)t(this.data[i])}sort(t){this.data.sort(t)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(t){if(0!==t.length){this.length+t.length>this.data.length&&(this.data.length=2*(this.length+t.length));for(let i=0;i<t.length;i++)this.data[this.length++]=(t.data||t)[i]}}indexOf(t){const i=this.data.indexOf(t);return i>=this.length?-1:i}contains(t){return-1!==this.indexOf(t)}}zi.Cl=0;class Hi extends zi{constructor(){super(...arguments),this.wl=0}push(t){super.push(t),t.xl||(t.xl={}),t.xl[this.Al]=this.wl}pushNoDuplicate(t){return(!t.xl||t.xl[this.Al]!==this.wl)&&(this.push(t),!0)}reset(){super.reset(),this.wl++}concatWithNoDuplicate(t){if(0!==t.length){this.length+t.length>this.data.length&&(this.data.length=2*(this.length+t.length));for(let i=0;i<t.length;i++){const e=(t.data||t)[i];this.pushNoDuplicate(e)}}}}class Xi{constructor(){this.Tl=0,this.Rl={}}copyFrom(t){this.clear(),t.forEach(((t,i)=>this.add(t,i)))}get(t){const i=this.Rl[t];if(void 0!==i)return i}getOrAddWithFactory(t,i){let e=this.get(t);return void 0!==e||(e=i(t),e&&this.add(t,e)),e}getOrAdd(t,i){const e=this.get(t);return void 0!==e?e:(this.add(t,i),i)}contains(t){return void 0!==this.Rl[t]}add(t,i){return void 0===this.Rl[t]&&(this.Rl[t]=i,++this.Tl,!0)}set(t,i){return void 0!==this.Rl[t]&&(this.Rl[t]=i,!0)}getAndRemove(t){const i=this.get(t);return void 0!==i?(delete this.Rl[t],--this.Tl,i):null}remove(t){return!!this.contains(t)&&(delete this.Rl[t],--this.Tl,!0)}clear(){this.Rl={},this.Tl=0}get count(){return this.Tl}forEach(t){for(const i in this.Rl){t(i,this.Rl[i])}}first(t){for(const i in this.Rl){const e=t(i,this.Rl[i]);if(e)return e}return null}}class Wi{constructor(t){if(this.re=[],this.F=!0,this.Il=!0,this.Ml=!1,this.bl=!0,this._l=!0,this.yl=!0,this.Nl=!0,this.Pl=!0,this.Dl=!0,this.Ll=!1,this.Ol=!1,this.Fl=!1,this.Bl=!1,this.Ul=t,t)for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&this.Vl(i)}get isDirty(){return this.F}markAsProcessed(){this.F=!1,this.bl=!1,this._l=!1,this.yl=!1,this.Il=!1,this.Ml=!1,this.Nl=!1,this.Pl=!1,this.Dl=!1}markAsUnprocessed(){this.F=!0}markAllAsDirty(){this._l=!0,this.bl=!0,this.Il=!0,this.yl=!0,this.Nl=!0,this.Dl=!0,this.F=!0}markAsImageProcessingDirty(){this.Dl=!0,this.F=!0}markAsLightDirty(t=!1){this.Il=!0,this.Ml=this.Ml||t,this.F=!0}markAsAttributesDirty(){this.bl=!0,this.F=!0}markAsTexturesDirty(){this._l=!0,this.F=!0}markAsFresnelDirty(){this.yl=!0,this.F=!0}markAsMiscDirty(){this.Nl=!0,this.F=!0}markAsPrePassDirty(){this.Pl=!0,this.F=!0}rebuild(){this.re.length=0;for(const t of Object.keys(this))"_"!==t[0]&&this.re.push(t);if(this.Ul)for(const t in this.Ul)-1===this.re.indexOf(t)&&this.re.push(t)}isEqual(t){if(this.re.length!==t.re.length)return!1;for(let i=0;i<this.re.length;i++){const e=this.re[i];if(this[e]!==t[e])return!1}return!0}cloneTo(t){this.re.length!==t.re.length&&(t.re=this.re.slice(0));for(let i=0;i<this.re.length;i++){const e=this.re[i];t[e]=this[e]}}reset(){this.re.forEach((t=>this.Vl(t)))}Vl(t){var i,e,s,n,r;const h=null!==(s=null===(e=null===(i=this.Ul)||void 0===i?void 0:i[t])||void 0===e?void 0:e.type)&&void 0!==s?s:typeof this[t],o=null===(r=null===(n=this.Ul)||void 0===n?void 0:n[t])||void 0===r?void 0:r.default;switch(h){case"number":this[t]=null!=o?o:0;break;case"string":this[t]=null!=o?o:"";break;default:this[t]=null!=o&&o}}toString(){let t="";for(let i=0;i<this.re.length;i++){const e=this.re[i],s=this[e];switch(typeof s){case"number":case"string":t+="#define "+e+" "+s+"\n";break;default:s&&(t+="#define "+e+"\n")}}return t}}class $i{constructor(){this.kl=!0,this.Gl=new y(0,0,0,0),this.zl=new y(0,0,0,0),this.Hl=new y(0,0,0,0),this.Xl=new y(0,0,0,0),this.Wl=new y(0,0,0,0),this.$l=new y(0,0,0,0),this.Yl=new y(0,0,0,0),this.jl=30,this.Kl=0,this.ql=0,this.Ql=0,this.Zl=30,this.Jl=0,this.tc=0,this.ic=0,this.ec=30,this.sc=0,this.nc=0,this.rc=0,this.hc=30,this.oc=0,this.ac=0,this.lc=0}get globalHue(){return this.jl}set globalHue(t){this.jl=t,this.kl=!0}get globalDensity(){return this.Kl}set globalDensity(t){this.Kl=t,this.kl=!0}get globalSaturation(){return this.ql}set globalSaturation(t){this.ql=t,this.kl=!0}get globalExposure(){return this.Ql}set globalExposure(t){this.Ql=t,this.kl=!0}get highlightsHue(){return this.Zl}set highlightsHue(t){this.Zl=t,this.kl=!0}get highlightsDensity(){return this.Jl}set highlightsDensity(t){this.Jl=t,this.kl=!0}get highlightsSaturation(){return this.tc}set highlightsSaturation(t){this.tc=t,this.kl=!0}get highlightsExposure(){return this.ic}set highlightsExposure(t){this.ic=t,this.kl=!0}get midtonesHue(){return this.ec}set midtonesHue(t){this.ec=t,this.kl=!0}get midtonesDensity(){return this.sc}set midtonesDensity(t){this.sc=t,this.kl=!0}get midtonesSaturation(){return this.nc}set midtonesSaturation(t){this.nc=t,this.kl=!0}get midtonesExposure(){return this.rc}set midtonesExposure(t){this.rc=t,this.kl=!0}get shadowsHue(){return this.hc}set shadowsHue(t){this.hc=t,this.kl=!0}get shadowsDensity(){return this.oc}set shadowsDensity(t){this.oc=t,this.kl=!0}get shadowsSaturation(){return this.ac}set shadowsSaturation(t){this.ac=t,this.kl=!0}get shadowsExposure(){return this.lc}set shadowsExposure(t){this.lc=t,this.kl=!0}getClassName(){return"ColorCurves"}static Bind(t,i,e="vCameraColorCurvePositive",s="vCameraColorCurveNeutral",n="vCameraColorCurveNegative"){t.kl&&(t.kl=!1,t.cc(t.jl,t.Kl,t.ql,t.Ql,t.zl),t.cc(t.Zl,t.Jl,t.tc,t.ic,t.Gl),t.Gl.multiplyToRef(t.zl,t.Hl),t.cc(t.ec,t.sc,t.nc,t.rc,t.Gl),t.Gl.multiplyToRef(t.zl,t.Xl),t.cc(t.hc,t.oc,t.ac,t.lc,t.Gl),t.Gl.multiplyToRef(t.zl,t.Wl),t.Hl.subtractToRef(t.Xl,t.$l),t.Xl.subtractToRef(t.Wl,t.Yl)),i&&(i.setFloat4(e,t.$l.r,t.$l.g,t.$l.b,t.$l.a),i.setFloat4(s,t.Xl.r,t.Xl.g,t.Xl.b,t.Xl.a),i.setFloat4(n,t.Yl.r,t.Yl.g,t.Yl.b,t.Yl.a))}static PrepareUniforms(t){t.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}cc(t,i,e,s,n){null!=t&&(t=$i.uc(t,0,360),i=$i.uc(i,-100,100),e=$i.uc(e,-100,100),s=$i.uc(s,-100,100),i=$i.fc(i),i*=.5,s=$i.fc(s),i<0&&(i*=-1,t=(t+180)%360),$i.dc(t,i,50+.25*s,n),n.scaleToRef(2,n),n.a=1+.01*e)}static fc(t){t/=100;let i=Math.abs(t);return i=Math.pow(i,2),t<0&&(i*=-1),i*=100,i}static dc(t,i,e,s){let n=$i.uc(t,0,360);const r=$i.uc(i/100,0,1),h=$i.uc(e/100,0,1);if(0===r)s.r=h,s.g=h,s.b=h;else{n/=60;const t=Math.floor(n),i=n-t,e=h*(1-r),o=h*(1-r*i),a=h*(1-r*(1-i));switch(t){case 0:s.r=h,s.g=a,s.b=e;break;case 1:s.r=o,s.g=h,s.b=e;break;case 2:s.r=e,s.g=h,s.b=a;break;case 3:s.r=e,s.g=o,s.b=h;break;case 4:s.r=a,s.g=e,s.b=h;break;default:s.r=h,s.g=e,s.b=o}}s.a=1}static uc(t,i,e){return Math.min(Math.max(t,i),e)}clone(){return ot.Clone((()=>new $i),this)}serialize(){return ot.Serialize(this)}static Parse(t){return ot.Parse((()=>new $i),t,null,null)}}ut([Q()],$i.prototype,"_globalHue",void 0),ut([Q()],$i.prototype,"_globalDensity",void 0),ut([Q()],$i.prototype,"_globalSaturation",void 0),ut([Q()],$i.prototype,"_globalExposure",void 0),ut([Q()],$i.prototype,"_highlightsHue",void 0),ut([Q()],$i.prototype,"_highlightsDensity",void 0),ut([Q()],$i.prototype,"_highlightsSaturation",void 0),ut([Q()],$i.prototype,"_highlightsExposure",void 0),ut([Q()],$i.prototype,"_midtonesHue",void 0),ut([Q()],$i.prototype,"_midtonesDensity",void 0),ut([Q()],$i.prototype,"_midtonesSaturation",void 0),ut([Q()],$i.prototype,"_midtonesExposure",void 0),ot.hi=$i.Parse;class Yi extends Wi{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class ji{constructor(){this.colorCurves=new $i,this.mc=!1,this.vc=!1,this.gc=!0,this.Sc=!0,this.Ec=1,this.Ac=!1,this.Cc=ji.TONEMAPPING_STANDARD,this.wc=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new y(0,0,0,0),this.vignetteCameraFov=.5,this.xc=ji.VIGNETTEMODE_MULTIPLY,this.Tc=!1,this.Rc=!1,this.Ic=1/255,this.Mc=!1,this.bc=!1,this.ui=!0,this.onUpdateParameters=new h}get colorCurvesEnabled(){return this.mc}set colorCurvesEnabled(t){this.mc!==t&&(this.mc=t,this._c())}get colorGradingTexture(){return this.yc}set colorGradingTexture(t){this.yc!==t&&(this.yc=t,this._c())}get colorGradingEnabled(){return this.vc}set colorGradingEnabled(t){this.vc!==t&&(this.vc=t,this._c())}get colorGradingWithGreenDepth(){return this.gc}set colorGradingWithGreenDepth(t){this.gc!==t&&(this.gc=t,this._c())}get colorGradingBGR(){return this.Sc}set colorGradingBGR(t){this.Sc!==t&&(this.Sc=t,this._c())}get exposure(){return this.Ec}set exposure(t){this.Ec!==t&&(this.Ec=t,this._c())}get toneMappingEnabled(){return this.Ac}set toneMappingEnabled(t){this.Ac!==t&&(this.Ac=t,this._c())}get toneMappingType(){return this.Cc}set toneMappingType(t){this.Cc!==t&&(this.Cc=t,this._c())}get contrast(){return this.wc}set contrast(t){this.wc!==t&&(this.wc=t,this._c())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(t){this.vignetteCenterY=t}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(t){this.vignetteCenterX=t}get vignetteBlendMode(){return this.xc}set vignetteBlendMode(t){this.xc!==t&&(this.xc=t,this._c())}get vignetteEnabled(){return this.Tc}set vignetteEnabled(t){this.Tc!==t&&(this.Tc=t,this._c())}get ditheringEnabled(){return this.Rc}set ditheringEnabled(t){this.Rc!==t&&(this.Rc=t,this._c())}get ditheringIntensity(){return this.Ic}set ditheringIntensity(t){this.Ic!==t&&(this.Ic=t,this._c())}get skipFinalColorClamp(){return this.Mc}set skipFinalColorClamp(t){this.Mc!==t&&(this.Mc=t,this._c())}get applyByPostProcess(){return this.bc}set applyByPostProcess(t){this.bc!==t&&(this.bc=t,this._c())}get isEnabled(){return this.ui}set isEnabled(t){this.ui!==t&&(this.ui=t,this._c())}_c(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(t,i){i.EXPOSURE&&t.push("exposureLinear"),i.CONTRAST&&t.push("contrast"),i.COLORGRADING&&t.push("colorTransformSettings"),(i.VIGNETTE||i.DITHER)&&t.push("vInverseScreenSize"),i.VIGNETTE&&(t.push("vignetteSettings1"),t.push("vignetteSettings2")),i.COLORCURVES&&$i.PrepareUniforms(t),i.DITHER&&t.push("ditherIntensity")}static PrepareSamplers(t,i){i.COLORGRADING&&t.push("txColorTransform")}prepareDefines(t,i=!1){if(i!==this.applyByPostProcess||!this.ui)return t.VIGNETTE=!1,t.TONEMAPPING=!1,t.TONEMAPPING_ACES=!1,t.CONTRAST=!1,t.EXPOSURE=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.DITHER=!1,t.IMAGEPROCESSING=!1,t.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,void(t.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this.ui);if(t.VIGNETTE=this.vignetteEnabled,t.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===ji.Nc,t.VIGNETTEBLENDMODEOPAQUE=!t.VIGNETTEBLENDMODEMULTIPLY,t.TONEMAPPING=this.toneMappingEnabled,this.Cc===ji.TONEMAPPING_ACES)t.TONEMAPPING_ACES=!0;else t.TONEMAPPING_ACES=!1;t.CONTRAST=1!==this.contrast,t.EXPOSURE=1!==this.exposure,t.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,t.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,t.COLORGRADING?t.COLORGRADING3D=this.colorGradingTexture.is3D:t.COLORGRADING3D=!1,t.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,t.SAMPLER3DBGRMAP=this.colorGradingBGR,t.DITHER=this.Rc,t.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,t.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,t.IMAGEPROCESSING=t.VIGNETTE||t.TONEMAPPING||t.CONTRAST||t.EXPOSURE||t.COLORCURVES||t.COLORGRADING||t.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(t,i){if(this.mc&&this.colorCurves&&$i.Bind(this.colorCurves,t),this.Tc||this.Rc){const e=1/t.getEngine().getRenderWidth(),s=1/t.getEngine().getRenderHeight();if(t.setFloat2("vInverseScreenSize",e,s),this.Rc&&t.setFloat("ditherIntensity",.5*this.Ic),this.Tc){const n=null!=i?i:s/e;let r=Math.tan(.5*this.vignetteCameraFov),h=r*n;const o=Math.sqrt(h*r);h=ki.Mix(h,o,this.vignetteStretch),r=ki.Mix(r,o,this.vignetteStretch),t.setFloat4("vignetteSettings1",h,r,-h*this.vignetteCenterX,-r*this.vignetteCenterY);const a=-2*this.vignetteWeight;t.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,a)}}if(t.setFloat("exposureLinear",this.exposure),t.setFloat("contrast",this.contrast),this.colorGradingTexture){t.setTexture("txColorTransform",this.colorGradingTexture);const i=this.colorGradingTexture.getSize().height;t.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return ot.Clone((()=>new ji),this)}serialize(){return ot.Serialize(this)}static Parse(t){const i=ot.Parse((()=>new ji),t,null,null);return void 0!==t.vignetteCentreX&&(i.vignetteCenterX=t.vignetteCentreX),void 0!==t.vignetteCentreY&&(i.vignetteCenterY=t.vignetteCentreY),i}static get VIGNETTEMODE_MULTIPLY(){return this.Nc}static get VIGNETTEMODE_OPAQUE(){return this.Pc}}var Ki,qi,Qi,Zi,Ji,te,ie,ee,se;ji.TONEMAPPING_STANDARD=0,ji.TONEMAPPING_ACES=1,ji.Nc=0,ji.Pc=1,ut([K(7,Ki)],ji.prototype,"colorCurves",void 0),ut([Q()],ji.prototype,"_colorCurvesEnabled",void 0),ut([Z("colorGradingTexture")],ji.prototype,"_colorGradingTexture",void 0),ut([Q()],ji.prototype,"_colorGradingEnabled",void 0),ut([Q()],ji.prototype,"_colorGradingWithGreenDepth",void 0),ut([Q()],ji.prototype,"_colorGradingBGR",void 0),ut([Q()],ji.prototype,"_exposure",void 0),ut([Q()],ji.prototype,"_toneMappingEnabled",void 0),ut([Q()],ji.prototype,"_toneMappingType",void 0),ut([Q()],ji.prototype,"_contrast",void 0),ut([Q()],ji.prototype,"vignetteStretch",void 0),ut([Q()],ji.prototype,"vignetteCenterX",void 0),ut([Q()],ji.prototype,"vignetteCenterY",void 0),ut([Q()],ji.prototype,"vignetteWeight",void 0),ut([nt()],ji.prototype,"vignetteColor",void 0),ut([Q()],ji.prototype,"vignetteCameraFov",void 0),ut([Q()],ji.prototype,"_vignetteBlendMode",void 0),ut([Q()],ji.prototype,"_vignetteEnabled",void 0),ut([Q()],ji.prototype,"_ditheringEnabled",void 0),ut([Q()],ji.prototype,"_ditheringIntensity",void 0),ut([Q()],ji.prototype,"_skipFinalColorClamp",void 0),ut([Q()],ji.prototype,"_applyByPostProcess",void 0),ut([Q()],ji.prototype,"_isEnabled",void 0),ot.oi=ji.Parse,Ei.prototype.createUniformBuffer=function(t){const i=this.lo.createBuffer();if(!i)throw new Error("Unable to create uniform buffer");const e=new fi(i);return this.bindUniformBuffer(e),t instanceof Float32Array?this.lo.bufferData(this.lo.UNIFORM_BUFFER,t,this.lo.STATIC_DRAW):this.lo.bufferData(this.lo.UNIFORM_BUFFER,new Float32Array(t),this.lo.STATIC_DRAW),this.bindUniformBuffer(null),e.references=1,e},Ei.prototype.createDynamicUniformBuffer=function(t){const i=this.lo.createBuffer();if(!i)throw new Error("Unable to create dynamic uniform buffer");const e=new fi(i);return this.bindUniformBuffer(e),t instanceof Float32Array?this.lo.bufferData(this.lo.UNIFORM_BUFFER,t,this.lo.DYNAMIC_DRAW):this.lo.bufferData(this.lo.UNIFORM_BUFFER,new Float32Array(t),this.lo.DYNAMIC_DRAW),this.bindUniformBuffer(null),e.references=1,e},Ei.prototype.updateUniformBuffer=function(t,i,e,s){this.bindUniformBuffer(t),void 0===e&&(e=0),void 0===s?i instanceof Float32Array?this.lo.bufferSubData(this.lo.UNIFORM_BUFFER,e,i):this.lo.bufferSubData(this.lo.UNIFORM_BUFFER,e,new Float32Array(i)):i instanceof Float32Array?this.lo.bufferSubData(this.lo.UNIFORM_BUFFER,0,i.subarray(e,e+s)):this.lo.bufferSubData(this.lo.UNIFORM_BUFFER,0,new Float32Array(i).subarray(e,e+s)),this.bindUniformBuffer(null)},Ei.prototype.bindUniformBuffer=function(t){this.lo.bindBuffer(this.lo.UNIFORM_BUFFER,t?t.underlyingResource:null)},Ei.prototype.bindUniformBufferBase=function(t,i,e){this.lo.bindBufferBase(this.lo.UNIFORM_BUFFER,i,t?t.underlyingResource:null)},Ei.prototype.bindUniformBlock=function(t,i,e){const s=t.program,n=this.lo.getUniformBlockIndex(s,i);4294967295!==n&&this.lo.uniformBlockBinding(s,n,e)};class ne{constructor(t,i,e,s,n=!1){this.Pr={},this.Ls=t,this.Dc=!t.supportsUniformBuffers||n,this.Lc=e,this.hn=null!=s?s:"no-name",this.Rl=i||[],this.Oc={},this.Fc={},this.Bc={},this.Uc=0,this.Vc=!1,this.Ls.hs.trackUbosInFrame&&(this.kc=[],this.Gc=-1,this.zc=!1,this.Hc=0),this.Dc?(this.updateMatrix3x3=this.Xc,this.updateMatrix2x2=this.Wc,this.updateFloat=this.$c,this.updateFloat2=this.Yc,this.updateFloat3=this.jc,this.updateFloat4=this.Kc,this.updateFloatArray=this.qc,this.updateArray=this.Qc,this.updateIntArray=this.Zc,this.updateUIntArray=this.Jc,this.updateMatrix=this.tu,this.updateMatrices=this.iu,this.updateVector3=this.eu,this.updateVector4=this.su,this.updateColor3=this.nu,this.updateColor4=this.ru,this.updateDirectColor4=this.hu,this.updateInt=this.ou,this.updateInt2=this.au,this.updateInt3=this.lu,this.updateInt4=this.cu,this.updateUInt=this.uu,this.updateUInt2=this.fu,this.updateUInt3=this.du,this.updateUInt4=this.pu):(this.Ls.nh.push(this),this.updateMatrix3x3=this.mu,this.updateMatrix2x2=this.vu,this.updateFloat=this.gu,this.updateFloat2=this.Su,this.updateFloat3=this.Eu,this.updateFloat4=this.Au,this.updateFloatArray=this.Cu,this.updateArray=this.wu,this.updateIntArray=this.xu,this.updateUIntArray=this.Tu,this.updateMatrix=this.Ru,this.updateMatrices=this.Iu,this.updateVector3=this.Mu,this.updateVector4=this._u,this.updateColor3=this.yu,this.updateColor4=this.Nu,this.updateDirectColor4=this.Pu,this.updateInt=this.Du,this.updateInt2=this.Lu,this.updateInt3=this.Ou,this.updateInt4=this.Fu,this.updateUInt=this.Bu,this.updateUInt2=this.Uu,this.updateUInt3=this.Vu,this.updateUInt4=this.ku)}get useUbo(){return!this.Dc}get isSync(){return!this.Vc}isDynamic(){return void 0!==this.Lc}getData(){return this.Gu}getBuffer(){return this.Yn}zu(t){let i;if(i=t<=2?t:4,this.Uc%i!=0){const t=this.Uc;this.Uc+=i-this.Uc%i;const e=this.Uc-t;for(let t=0;t<e;t++)this.Rl.push(0)}}addUniform(t,i,e=0){if(this.Dc)return;if(void 0!==this.Oc[t])return;let s;if(e>0){if(i instanceof Array)throw"addUniform should not be use with Array in UBO: "+t;if(this.zu(4),this.Bc[t]={strideSize:i,arraySize:e},16==i)i*=e;else{i=i*e+(4-i)*e}s=[];for(let t=0;t<i;t++)s.push(0)}else{if(i instanceof Array)s=i,i=s.length;else{s=[];for(let t=0;t<i;t++)s.push(0)}this.zu(i)}this.Fc[t]=i,this.Oc[t]=this.Uc,this.Uc+=i;for(let t=0;t<i;t++)this.Rl.push(s[t]);this.Vc=!0}addMatrix(t,i){this.addUniform(t,Array.prototype.slice.call(i.toArray()))}addFloat2(t,i,e){const s=[i,e];this.addUniform(t,s)}addFloat3(t,i,e,s){const n=[i,e,s];this.addUniform(t,n)}addColor3(t,i){const e=[i.r,i.g,i.b];this.addUniform(t,e)}addColor4(t,i,e){const s=[i.r,i.g,i.b,e];this.addUniform(t,s)}addVector3(t,i){const e=[i.x,i.y,i.z];this.addUniform(t,e)}addMatrix3x3(t){this.addUniform(t,12)}addMatrix2x2(t){this.addUniform(t,8)}create(){this.Dc||this.Yn||(this.zu(4),this.Gu=new Float32Array(this.Rl),this.br(),this.Vc=!0)}br(){!this.Dc&&this.Gu&&(this.Lc?this.Yn=this.Ls.createDynamicUniformBuffer(this.Gu):this.Yn=this.Ls.createUniformBuffer(this.Gu),this.Ls.hs.trackUbosInFrame&&(this.kc.push([this.Yn,this.Ls.hs.checkUbosContentBeforeUpload?this.Gu.slice():void 0]),this.Gc=this.kc.length-1,this.zc=!1))}get Hu(){return this.kc.length}get Xu(){return this.Gc}get name(){return this.hn}Wu(t,i){for(let e=0;e<t.length;++e)if(t[e]!==i[e])return!1;return!0}$u(t,i){for(let e=0;e<t.length;++e)i[e]=t[e]}update(){if(!this.Dc)if(this.bindUniformBuffer(),this.Yn)if(this.Lc||this.Vc){if(this.kc&&this.kc.length>1&&this.kc[this.Gc][1]){if(this.Wu(this.Gu,this.kc[this.Gc][1]))return this.Vc=!1,void(this.zc=this.Ls.hs.trackUbosInFrame);this.$u(this.Gu,this.kc[this.Gc][1])}this.Ls.updateUniformBuffer(this.Yn,this.Gu),this.Ls.hs.Fo&&(ne.Yu[this.hn]||(ne.Yu[this.hn]=0),ne.Yu[this.hn]++),this.Vc=!1,this.zc=this.Ls.hs.trackUbosInFrame}else this.zc=this.Ls.hs.trackUbosInFrame;else this.create()}ju(){this.Gc+1<this.kc.length?(this.Gc++,this.Yn=this.kc[this.Gc][0],this.zc=!1,this.Vc=!0):this.br()}Ku(){this.Ls.hs.trackUbosInFrame&&this.Hc!==this.Ls.frameId&&(this.Hc=this.Ls.frameId,this.zc=!1,this.kc&&this.kc.length>0?(this.Vc=0!==this.Gc,this.Gc=0,this.Yn=this.kc[this.Gc][0]):this.Gc=-1)}updateUniform(t,i,e){this.Ku();let s=this.Oc[t];if(void 0===s){if(this.Yn)return void F.Error("Cannot add an uniform after UBO has been created.");this.addUniform(t,e),s=this.Oc[t]}if(this.Yn||this.create(),this.Lc)for(let t=0;t<e;t++)this.Gu[s+t]=i[t];else{let t=!1;for(let n=0;n<e;n++)(16===e&&!this.Ls.hs.uniformBufferHardCheckMatrix||this.Gu[s+n]!==ki.FloatRound(i[n]))&&(t=!0,this.zc&&this.ju(),this.Gu[s+n]=i[n]);this.Vc=this.Vc||t}}updateUniformArray(t,i,e){this.Ku();const s=this.Oc[t];if(void 0===s)return void F.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");this.Yn||this.create();const n=this.Bc[t];if(this.Lc)for(let t=0;t<e;t++)this.Gu[s+t]=i[t];else{let t=!1,r=0,h=0;for(let o=0;o<e;o++)if(this.Gu[s+4*h+r]!==ki.FloatRound(i[o])&&(t=!0,this.zc&&this.ju(),this.Gu[s+4*h+r]=i[o]),r++,r===n.strideSize){for(;r<4;r++)this.Gu[s+4*h+r]=0;r=0,h++}this.Vc=this.Vc||t}}Lr(t,i){this.Ku();const e=this.Pr[t],s=i.updateFlag;return(void 0===e||e!==s)&&(this.Pr[t]=s,!0)}mu(t,i){for(let t=0;t<3;t++)ne.qu[4*t]=i[3*t],ne.qu[4*t+1]=i[3*t+1],ne.qu[4*t+2]=i[3*t+2],ne.qu[4*t+3]=0;this.updateUniform(t,ne.qu,12)}Xc(t,i){this.fa.setMatrix3x3(t,i)}Wc(t,i){this.fa.setMatrix2x2(t,i)}vu(t,i){for(let t=0;t<2;t++)ne.qu[4*t]=i[2*t],ne.qu[4*t+1]=i[2*t+1],ne.qu[4*t+2]=0,ne.qu[4*t+3]=0;this.updateUniform(t,ne.qu,8)}$c(t,i){this.fa.setFloat(t,i)}gu(t,i){ne.qu[0]=i,this.updateUniform(t,ne.qu,1)}Yc(t,i,e,s=""){this.fa.setFloat2(t+s,i,e)}Su(t,i,e){ne.qu[0]=i,ne.qu[1]=e,this.updateUniform(t,ne.qu,2)}jc(t,i,e,s,n=""){this.fa.setFloat3(t+n,i,e,s)}Eu(t,i,e,s){ne.qu[0]=i,ne.qu[1]=e,ne.qu[2]=s,this.updateUniform(t,ne.qu,3)}Kc(t,i,e,s,n,r=""){this.fa.setFloat4(t+r,i,e,s,n)}Au(t,i,e,s,n){ne.qu[0]=i,ne.qu[1]=e,ne.qu[2]=s,ne.qu[3]=n,this.updateUniform(t,ne.qu,4)}qc(t,i){this.fa.setFloatArray(t,i)}Cu(t,i){this.updateUniformArray(t,i,i.length)}Qc(t,i){this.fa.setArray(t,i)}wu(t,i){this.updateUniformArray(t,i,i.length)}Zc(t,i){this.fa.setIntArray(t,i)}xu(t,i){ne.Qu.set(i),this.updateUniformArray(t,ne.qu,i.length)}Jc(t,i){this.fa.setUIntArray(t,i)}Tu(t,i){ne.Zu.set(i),this.updateUniformArray(t,ne.qu,i.length)}tu(t,i){this.fa.setMatrix(t,i)}Ru(t,i){this.Lr(t,i)&&this.updateUniform(t,i.toArray(),16)}iu(t,i){this.fa.setMatrices(t,i)}Iu(t,i){this.updateUniform(t,i,i.length)}eu(t,i){this.fa.setVector3(t,i)}Mu(t,i){ne.qu[0]=i.x,ne.qu[1]=i.y,ne.qu[2]=i.z,this.updateUniform(t,ne.qu,3)}su(t,i){this.fa.setVector4(t,i)}_u(t,i){ne.qu[0]=i.x,ne.qu[1]=i.y,ne.qu[2]=i.z,ne.qu[3]=i.w,this.updateUniform(t,ne.qu,4)}nu(t,i,e=""){this.fa.setColor3(t+e,i)}yu(t,i){ne.qu[0]=i.r,ne.qu[1]=i.g,ne.qu[2]=i.b,this.updateUniform(t,ne.qu,3)}ru(t,i,e,s=""){this.fa.setColor4(t+s,i,e)}hu(t,i,e=""){this.fa.setDirectColor4(t+e,i)}Nu(t,i,e){ne.qu[0]=i.r,ne.qu[1]=i.g,ne.qu[2]=i.b,ne.qu[3]=e,this.updateUniform(t,ne.qu,4)}Pu(t,i){ne.qu[0]=i.r,ne.qu[1]=i.g,ne.qu[2]=i.b,ne.qu[3]=i.a,this.updateUniform(t,ne.qu,4)}ou(t,i,e=""){this.fa.setInt(t+e,i)}Du(t,i){ne.Qu[0]=i,this.updateUniform(t,ne.qu,1)}au(t,i,e,s=""){this.fa.setInt2(t+s,i,e)}Lu(t,i,e){ne.Qu[0]=i,ne.Qu[1]=e,this.updateUniform(t,ne.qu,2)}lu(t,i,e,s,n=""){this.fa.setInt3(t+n,i,e,s)}Ou(t,i,e,s){ne.Qu[0]=i,ne.Qu[1]=e,ne.Qu[2]=s,this.updateUniform(t,ne.qu,3)}cu(t,i,e,s,n,r=""){this.fa.setInt4(t+r,i,e,s,n)}Fu(t,i,e,s,n){ne.Qu[0]=i,ne.Qu[1]=e,ne.Qu[2]=s,ne.Qu[3]=n,this.updateUniform(t,ne.qu,4)}uu(t,i,e=""){this.fa.setUInt(t+e,i)}Bu(t,i){ne.Zu[0]=i,this.updateUniform(t,ne.qu,1)}fu(t,i,e,s=""){this.fa.setUInt2(t+s,i,e)}Uu(t,i,e){ne.Zu[0]=i,ne.Zu[1]=e,this.updateUniform(t,ne.qu,2)}du(t,i,e,s,n=""){this.fa.setUInt3(t+n,i,e,s)}Vu(t,i,e,s){ne.Zu[0]=i,ne.Zu[1]=e,ne.Zu[2]=s,this.updateUniform(t,ne.qu,3)}pu(t,i,e,s,n,r=""){this.fa.setUInt4(t+r,i,e,s,n)}ku(t,i,e,s,n){ne.Zu[0]=i,ne.Zu[1]=e,ne.Zu[2]=s,ne.Zu[3]=n,this.updateUniform(t,ne.qu,4)}setTexture(t,i){this.fa.setTexture(t,i)}updateUniformDirectly(t,i){this.updateUniform(t,i,i.length),this.update()}bindToEffect(t,i){this.fa=t,this.Ju=i}bindUniformBuffer(){!this.Dc&&this.Yn&&this.fa&&this.fa.bindUniformBuffer(this.Yn,this.Ju)}unbindEffect(){this.fa=void 0,this.Ju=void 0}setDataBuffer(t){if(!this.kc)return this.Yn===t;for(let i=0;i<this.kc.length;++i){if(this.kc[i][0]===t)return this.Gc=i,this.Yn=t,this.zc=!1,this.fa=void 0,!0}return!1}dispose(){if(this.Dc)return;const t=this.Ls.nh,i=t.indexOf(this);if(-1!==i&&(t[i]=t[t.length-1],t.pop()),this.Ls.hs.trackUbosInFrame&&this.kc)for(let t=0;t<this.kc.length;++t){const i=this.kc[t][0];this.Ls.ca(i)}else this.Yn&&this.Ls.ca(this.Yn)&&(this.Yn=null)}}ne.Yu={},ne.tf=256,ne.qu=new Float32Array(ne.tf),ne.Qu=new Int32Array(ne.qu.buffer),ne.Zu=new Uint32Array(ne.qu.buffer);class re{constructor(t,i,e,s=0,n=!1,r=!1,h=!1,o){this.if=!1,t.getScene?this.Ls=t.getScene().getEngine():this.Ls=t,this.ef=e,this.sf=r,this.nf=o||1,i instanceof ui?(this.Rl=null,this.Yn=i):(this.Rl=i,this.Yn=null),this.byteStride=h?s:s*Float32Array.BYTES_PER_ELEMENT,n||this.create()}createVertexBuffer(t,i,e,s,n,r=!1,h){const o=r?i:i*Float32Array.BYTES_PER_ELEMENT,a=s?r?s:s*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new he(this.Ls,this,t,this.ef,!0,a,void 0===n?this.sf:n,o,e,void 0,void 0,!0,this.nf||h)}isUpdatable(){return this.ef}getData(){return this.Rl}getBuffer(){return this.Yn}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(t=null){!t&&this.Yn||(t=t||this.Rl)&&(this.Yn?this.ef&&(this.Ls.updateDynamicVertexBuffer(this.Yn,t),this.Rl=t):this.ef?(this.Yn=this.Ls.createDynamicVertexBuffer(t),this.Rl=t):this.Yn=this.Ls.createVertexBuffer(t))}br(){this.Yn=null,this.create(this.Rl)}update(t){this.create(t)}updateDirectly(t,i,e,s=!1){this.Yn&&this.ef&&(this.Ls.updateDynamicVertexBuffer(this.Yn,t,s?i:i*Float32Array.BYTES_PER_ELEMENT,e?e*this.byteStride:void 0),this.Rl=0===i&&void 0===e?t:null)}rf(){this.Yn&&(this.if?this.Yn.references++:this.if=!0)}dispose(){this.Yn&&this.Ls.ca(this.Yn)&&(this.Yn=null,this.Rl=null)}}class he{constructor(t,i,e,s,n,r,h,o,a,l,c=!1,u=!1,f=1,d=!1){if(i instanceof re?(this.Yn=i,this.hf=d):(this.Yn=new re(t,i,s,r,n,h,u),this.hf=!0),this.uniqueId=he.Rr++,this.af=e,null==l){const t=this.getData();this.type=he.FLOAT,t instanceof Int8Array?this.type=he.BYTE:t instanceof Uint8Array?this.type=he.UNSIGNED_BYTE:t instanceof Int16Array?this.type=he.SHORT:t instanceof Uint16Array?this.type=he.UNSIGNED_SHORT:t instanceof Int32Array?this.type=he.INT:t instanceof Uint32Array&&(this.type=he.UNSIGNED_INT)}else this.type=l;const p=he.GetTypeByteLength(this.type);u?(this.Qn=a||(r?r/p:he.DeduceStride(e)),this.byteStride=r||this.Yn.byteStride||this.Qn*p,this.byteOffset=o||0):(this.Qn=a||r||he.DeduceStride(e),this.byteStride=r?r*p:this.Yn.byteStride||this.Qn*p,this.byteOffset=(o||0)*p),this.normalized=c,this.sf=void 0!==h&&h,this.lf=h?f:0,this.cf()}get instanceDivisor(){return this.lf}set instanceDivisor(t){const i=0!=t;this.lf=t,i!==this.sf&&(this.sf=i,this.cf())}cf(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this.Qn<<4)+((this.sf?1:0)<<6)+(this.byteStride<<12)}br(){this.Yn&&this.Yn.br()}getKind(){return this.af}isUpdatable(){return this.Yn.isUpdatable()}getData(){return this.Yn.getData()}getFloatData(t,i){const e=this.getData();if(!e)return null;const s=this.getSize()*he.GetTypeByteLength(this.type),n=t*this.getSize();if(this.type!==he.FLOAT||this.byteStride!==s){const t=new Float32Array(n);return this.forEach(n,((i,e)=>t[e]=i)),t}if(!(e instanceof Array||e instanceof Float32Array)||0!==this.byteOffset||e.length!==n){if(e instanceof Array){const t=this.byteOffset/4;return e.slice(t,t+n)}if(e instanceof ArrayBuffer)return new Float32Array(e,this.byteOffset,n);{let t=e.byteOffset+this.byteOffset;if(i){const i=new Float32Array(n),s=new Float32Array(e.buffer,t,n);return i.set(s),i}const s=t%4;return s&&(t=Math.max(0,t-s)),new Float32Array(e.buffer,t,n)}}return i?e.slice():e}getBuffer(){return this.Yn.getBuffer()}getStrideSize(){return this.byteStride/he.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/he.GetTypeByteLength(this.type)}getSize(t=!1){return t?this.Qn*he.GetTypeByteLength(this.type):this.Qn}getIsInstanced(){return this.sf}getInstanceDivisor(){return this.lf}create(t){this.Yn.create(t)}update(t){this.Yn.update(t)}updateDirectly(t,i,e=!1){this.Yn.updateDirectly(t,i,void 0,e)}dispose(){this.hf&&this.Yn.dispose()}forEach(t,i){he.ForEach(this.Yn.getData(),this.byteOffset,this.byteStride,this.Qn,this.type,t,this.normalized,i)}static DeduceStride(t){switch(t){case he.UVKind:case he.UV2Kind:case he.UV3Kind:case he.UV4Kind:case he.UV5Kind:case he.UV6Kind:return 2;case he.NormalKind:case he.PositionKind:return 3;case he.ColorKind:case he.MatricesIndicesKind:case he.MatricesIndicesExtraKind:case he.MatricesWeightsKind:case he.MatricesWeightsExtraKind:case he.TangentKind:return 4;default:throw new Error("Invalid kind '"+t+"'")}}static GetTypeByteLength(t){switch(t){case he.BYTE:case he.UNSIGNED_BYTE:return 1;case he.SHORT:case he.UNSIGNED_SHORT:return 2;case he.INT:case he.UNSIGNED_INT:case he.FLOAT:return 4;default:throw new Error(`Invalid type '${t}'`)}}static ForEach(t,i,e,s,n,r,h,o){if(t instanceof Array){let n=i/4;const h=e/4;for(let i=0;i<r;i+=s){for(let e=0;e<s;e++)o(t[n+e],i+e);n+=h}}else{const a=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),l=he.GetTypeByteLength(n);for(let t=0;t<r;t+=s){let r=i;for(let i=0;i<s;i++){o(he.uf(a,n,r,h),t+i),r+=l}i+=e}}}static uf(t,i,e,s){switch(i){case he.BYTE:{let i=t.getInt8(e);return s&&(i=Math.max(i/127,-1)),i}case he.UNSIGNED_BYTE:{let i=t.getUint8(e);return s&&(i/=255),i}case he.SHORT:{let i=t.getInt16(e,!0);return s&&(i=Math.max(i/32767,-1)),i}case he.UNSIGNED_SHORT:{let i=t.getUint16(e,!0);return s&&(i/=65535),i}case he.INT:return t.getInt32(e,!0);case he.UNSIGNED_INT:return t.getUint32(e,!0);case he.FLOAT:return t.getFloat32(e,!0);default:throw new Error(`Invalid component type ${i}`)}}}he.Rr=0,he.BYTE=5120,he.UNSIGNED_BYTE=5121,he.SHORT=5122,he.UNSIGNED_SHORT=5123,he.INT=5124,he.UNSIGNED_INT=5125,he.FLOAT=5126,he.PositionKind="position",he.NormalKind="normal",he.TangentKind="tangent",he.UVKind="uv",he.UV2Kind="uv2",he.UV3Kind="uv3",he.UV4Kind="uv4",he.UV5Kind="uv5",he.UV6Kind="uv6",he.ColorKind="color",he.ColorInstanceKind="instanceColor",he.MatricesIndicesKind="matricesIndices",he.MatricesWeightsKind="matricesWeights",he.MatricesIndicesExtraKind="matricesIndicesExtra",he.MatricesWeightsExtraKind="matricesWeightsExtra";class oe{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(t=!1,i=!0){if(!this.pickedMesh||i&&!this.pickedMesh.isVerticesDataPresent(he.NormalKind))return null;const e=this.pickedMesh.getIndices();if(!e)return null;let s;if(i){const t=this.pickedMesh.getVerticesData(he.NormalKind);let i=w.FromArray(t,3*e[3*this.faceId]),n=w.FromArray(t,3*e[3*this.faceId+1]),r=w.FromArray(t,3*e[3*this.faceId+2]);i=i.scale(this.bu),n=n.scale(this.bv),r=r.scale(1-this.bu-this.bv),s=new w(i.x+n.x+r.x,i.y+n.y+r.y,i.z+n.z+r.z)}else{const t=this.pickedMesh.getVerticesData(he.PositionKind),i=w.FromArray(t,3*e[3*this.faceId]),n=w.FromArray(t,3*e[3*this.faceId+1]),r=w.FromArray(t,3*e[3*this.faceId+2]),h=i.subtract(n),o=r.subtract(n);s=w.Cross(h,o)}const n=(t,i)=>{let e=t.getWorldMatrix();t.nonUniformScaling&&(M.Matrix[0].copyFrom(e),e=M.Matrix[0],e.setTranslationFromFloats(0,0,0),e.invert(),e.transposeToRef(M.Matrix[1]),e=M.Matrix[1]),w.TransformNormalToRef(i,e,i)};if(t&&n(this.pickedMesh,s),this.ray){const i=M.Vector3[0].copyFrom(s);t||n(this.pickedMesh,i),w.Dot(i,this.ray.direction)>0&&s.negateInPlace()}return s.normalize(),s}getTextureCoordinates(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(he.UVKind))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(he.UVKind);if(!i)return null;let e=C.FromArray(i,2*t[3*this.faceId]),s=C.FromArray(i,2*t[3*this.faceId+1]),n=C.FromArray(i,2*t[3*this.faceId+2]);return e=e.scale(this.bu),s=s.scale(this.bv),n=n.scale(1-this.bu-this.bv),new C(e.x+s.x+n.x,e.y+s.y+n.y)}}class ae{constructor(t){this.ff={},this.Kt=t}df(){if(this.ff[he.PositionKind])return;const t=[];t.push(1,1),t.push(-1,1),t.push(-1,-1),t.push(1,-1),this.ff[he.PositionKind]=new he(this.Kt.getEngine(),t,he.PositionKind,!1,!1,2),this.pf()}pf(){const t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this.Xu=this.Kt.getEngine().createIndexBuffer(t)}br(){const t=this.ff[he.PositionKind];t&&(t.br(),this.pf())}mf(t=null,i=null){const e=this.Kt.activeCamera;return!!e&&(!(!(i=i||e.vf.filter((t=>null!=t)))||0===i.length||!this.Kt.postProcessesEnabled)&&(i[0].activate(e,t,null!=i),!0))}directRender(t,i=null,e=!1,s=0,n=0,r=!1){var h;const o=this.Kt.getEngine();for(let a=0;a<t.length;a++){a<t.length-1?t[a+1].activate(this.Kt.activeCamera,null==i?void 0:i.texture):(i?o.bindFramebuffer(i,s,void 0,void 0,e,n):r||o.restoreDefaultFramebuffer(),null===(h=o.gf)||void 0===h||h.call(o,`post process ${t[a].name} output`));const l=t[a],c=l.apply();c&&(l.onBeforeRenderObservable.notifyObservers(c),this.df(),o.bindBuffers(this.ff,this.Xu,c),o.drawElementsType(0,0,6),l.onAfterRenderObservable.notifyObservers(c))}o.setDepthBuffer(!0),o.setDepthWrite(!0)}Sf(t,i,e,s,n=!1){var r;const h=this.Kt.activeCamera;if(!h)return;if(0===(s=s||h.vf.filter((t=>null!=t))).length||!this.Kt.postProcessesEnabled)return;const o=this.Kt.getEngine();for(let a=0,l=s.length;a<l;a++){const c=s[a];if(a<l-1?c.Ef=s[a+1].activate(h,null==i?void 0:i.texture):(i?(o.bindFramebuffer(i,e,void 0,void 0,n),c.Ef=i):(o.restoreDefaultFramebuffer(),c.Ef=null),null===(r=o.gf)||void 0===r||r.call(o,`post process ${s[a].name} output`)),t)break;const u=c.apply();u&&(c.onBeforeRenderObservable.notifyObservers(u),this.df(),o.bindBuffers(this.ff,this.Xu,u),o.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(u))}o.setDepthBuffer(!0),o.setDepthWrite(!0),o.setAlphaMode(0)}dispose(){const t=this.ff[he.PositionKind];t&&(t.dispose(),this.ff[he.PositionKind]=null),this.Xu&&(this.Kt.getEngine().ca(this.Xu),this.Xu=null)}}class le{constructor(t,i,e=null,s=null,n=null){this.index=t,this.Af=new zi(256),this.Cf=new zi(256),this.wf=new zi(256),this.xf=new zi(256),this.Tf=new zi(256),this.Rf=new zi(256),this.If=!0,this.Mf=new Hi(16),this.Kt=i,this.opaqueSortCompareFn=e,this.alphaTestSortCompareFn=s,this.transparentSortCompareFn=n}set opaqueSortCompareFn(t){this.bf=t||le.PainterSortCompare,this._f=this.yf}set alphaTestSortCompareFn(t){this.Nf=t||le.PainterSortCompare,this.Pf=this.Df}set transparentSortCompareFn(t){this.Lf=t||le.defaultTransparentSortCompare,this.Of=this.Ff}render(t,i,e,s){if(t)return void t(this.Af,this.wf,this.Cf,this.xf);const n=this.Kt.getEngine();0!==this.xf.length&&(n.setColorWrite(!1),this.Pf(this.xf),n.setColorWrite(!0)),0!==this.Af.length&&this._f(this.Af),0!==this.wf.length&&this.Pf(this.wf);const r=n.getStencilBuffer();if(n.setStencilBuffer(!1),i&&this.Bf(),e&&this.Uf(s),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this.Cf.length||this.Kt.useOrderIndependentTransparency){if(n.setStencilBuffer(r),this.Kt.useOrderIndependentTransparency){const t=this.Kt.depthPeelingRenderer.render(this.Cf);t.length&&this.Of(t)}else this.Of(this.Cf);n.setAlphaMode(0)}if(n.setStencilBuffer(!1),this.Mf.length){for(let t=0;t<this.Mf.length;t++)this.Mf.data[t].render();n.setAlphaMode(0)}n.setStencilBuffer(r)}yf(t){return le.Vf(t,this.bf,this.Kt.activeCamera,!1)}Df(t){return le.Vf(t,this.Nf,this.Kt.activeCamera,!1)}Ff(t){return le.Vf(t,this.Lf,this.Kt.activeCamera,!0)}static Vf(t,i,e,s){let n,r=0;const h=e?e.globalPosition:le.kf;if(s)for(;r<t.length;r++)n=t.data[r],n.Gf=n.getMesh().alphaIndex,n.zf=w.Distance(n.getBoundingInfo().boundingSphere.centerWorld,h);const o=t.length===t.data.length?t.data:t.data.slice(0,t.length);i&&o.sort(i);const a=o[0].getMesh().getScene();for(r=0;r<o.length;r++)if(n=o[r],!a.Hf||n.isInFrustum(a.Xf)){if(s){const t=n.getMaterial();if(t&&t.needDepthPrePass){const i=t.getScene().getEngine();i.setColorWrite(!1),i.setAlphaMode(0),n.render(!1),i.setColorWrite(!0)}}n.render(s)}}static defaultTransparentSortCompare(t,i){return t.Gf>i.Gf?1:t.Gf<i.Gf?-1:le.backToFrontSortCompare(t,i)}static backToFrontSortCompare(t,i){return t.zf<i.zf?1:t.zf>i.zf?-1:0}static frontToBackSortCompare(t,i){return t.zf<i.zf?-1:t.zf>i.zf?1:0}static PainterSortCompare(t,i){const e=t.getMesh(),s=i.getMesh();return e.material&&s.material?e.material.uniqueId-s.material.uniqueId:e.uniqueId-s.uniqueId}prepare(){this.Af.reset(),this.Cf.reset(),this.wf.reset(),this.xf.reset(),this.Tf.reset(),this.prepareSprites(),this.Mf.reset(),this.If=!0}prepareSprites(){this.Rf.reset()}dispose(){this.Af.dispose(),this.Cf.dispose(),this.wf.dispose(),this.xf.dispose(),this.Tf.dispose(),this.Rf.dispose(),this.Mf.dispose()}dispatch(t,i,e){void 0===i&&(i=t.getMesh()),void 0===e&&(e=t.getMaterial()),null!=e&&(e.needAlphaBlendingForMesh(i)?this.Cf.push(t):e.needAlphaTesting()?(e.needDepthPrePass&&this.xf.push(t),this.wf.push(t)):(e.needDepthPrePass&&this.xf.push(t),this.Af.push(t)),i.Wf=this,i.$f&&i.$f.isEnabled&&this.Mf.pushNoDuplicate(i.$f),this.If=!1)}dispatchSprites(t){this.Rf.push(t),this.If=!1}dispatchParticles(t){this.Tf.push(t),this.If=!1}Uf(t){if(0===this.Tf.length)return;const i=this.Kt.activeCamera;this.Kt.onBeforeParticlesRenderingObservable.notifyObservers(this.Kt);for(let e=0;e<this.Tf.length;e++){const s=this.Tf.data[e];if(0===(i&&i.layerMask&s.layerMask))continue;const n=s.emitter;n.position&&t&&-1===t.indexOf(n)||this.Kt.Yf.addCount(s.render(),!1)}this.Kt.onAfterParticlesRenderingObservable.notifyObservers(this.Kt)}Bf(){if(!this.Kt.spritesEnabled||0===this.Rf.length)return;const t=this.Kt.activeCamera;this.Kt.onBeforeSpritesRenderingObservable.notifyObservers(this.Kt);for(let i=0;i<this.Rf.length;i++){const e=this.Rf.data[i];0!==(t&&t.layerMask&e.layerMask)&&e.render()}this.Kt.onAfterSpritesRenderingObservable.notifyObservers(this.Kt)}}le.kf=w.Zero();class ce{}class ue{constructor(t){this.jf=!1,this.Kf=new Array,this.qf={},this.Qf={},this.Zf={},this.Jf={},this.td=new ce,this.ed=!1,this.Kt=t;for(let t=ue.MIN_RENDERINGGROUPS;t<ue.MAX_RENDERINGGROUPS;t++)this.qf[t]={autoClear:!0,depth:!0,stencil:!0}}get maintainStateBetweenFrames(){return this.ed}set maintainStateBetweenFrames(t){if(t!==this.ed&&(this.ed=t,!this.ed)){for(const t of this.Kt.meshes)if(t.subMeshes)for(const i of t.subMeshes)i.sd=!1;for(const t of this.Kt.spriteManagers)t.sd=!1;for(const t of this.Kt.particleSystems)t.sd=!1}}getRenderingGroup(t){const i=t||0;return this.nd(i),this.Kf[i]}rd(t=!0,i=!0){this.hd||(this.Kt.getEngine().clear(null,!1,t,i),this.hd=!0)}render(t,i,e,s){const n=this.td;if(n.scene=this.Kt,n.camera=this.Kt.activeCamera,this.Kt.spriteManagers&&s)for(let t=0;t<this.Kt.spriteManagers.length;t++){const i=this.Kt.spriteManagers[t];this.dispatchSprites(i)}for(let r=ue.MIN_RENDERINGGROUPS;r<ue.MAX_RENDERINGGROUPS;r++){this.hd=r===ue.MIN_RENDERINGGROUPS;const h=this.Kf[r];if(!h||h.If)continue;const o=Math.pow(2,r);if(n.renderingGroupId=r,this.Kt.onBeforeRenderingGroupObservable.notifyObservers(n,o),ue.AUTOCLEAR){const t=this.jf?this.Kt.getAutoClearDepthStencilSetup(r):this.qf[r];t&&t.autoClear&&this.rd(t.depth,t.stencil)}for(const t of this.Kt.od)t.action(r);h.render(t,s,e,i);for(const t of this.Kt.ad)t.action(r);this.Kt.onAfterRenderingGroupObservable.notifyObservers(n,o)}}reset(){if(!this.maintainStateBetweenFrames)for(let t=ue.MIN_RENDERINGGROUPS;t<ue.MAX_RENDERINGGROUPS;t++){const i=this.Kf[t];i&&i.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let t=ue.MIN_RENDERINGGROUPS;t<ue.MAX_RENDERINGGROUPS;t++){const i=this.Kf[t];i&&i.prepareSprites()}}dispose(){this.freeRenderingGroups(),this.Kf.length=0,this.td=null}freeRenderingGroups(){for(let t=ue.MIN_RENDERINGGROUPS;t<ue.MAX_RENDERINGGROUPS;t++){const i=this.Kf[t];i&&i.dispose()}}nd(t){void 0===this.Kf[t]&&(this.Kf[t]=new le(t,this.Kt,this.Qf[t],this.Zf[t],this.Jf[t]))}dispatchSprites(t){this.maintainStateBetweenFrames&&t.sd||(t.sd=!0,this.getRenderingGroup(t.renderingGroupId).dispatchSprites(t))}dispatchParticles(t){this.maintainStateBetweenFrames&&t.sd||(t.sd=!0,this.getRenderingGroup(t.renderingGroupId).dispatchParticles(t))}dispatch(t,i,e){void 0===i&&(i=t.getMesh()),this.maintainStateBetweenFrames&&t.sd||(t.sd=!0,this.getRenderingGroup(i.renderingGroupId).dispatch(t,i,e))}setRenderingOrder(t,i=null,e=null,s=null){if(this.Qf[t]=i,this.Zf[t]=e,this.Jf[t]=s,this.Kf[t]){const i=this.Kf[t];i.opaqueSortCompareFn=this.Qf[t],i.alphaTestSortCompareFn=this.Zf[t],i.transparentSortCompareFn=this.Jf[t]}}setRenderingAutoClearDepthStencil(t,i,e=!0,s=!0){this.qf[t]={autoClear:i,depth:e,stencil:s}}getAutoClearDepthStencilSetup(t){return this.qf[t]}}ue.MAX_RENDERINGGROUPS=4,ue.MIN_RENDERINGGROUPS=0,ue.AUTOCLEAR=!0;class fe{}fe.NAME_EFFECTLAYER="EffectLayer",fe.NAME_LAYER="Layer",fe.NAME_LENSFLARESYSTEM="LensFlareSystem",fe.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",fe.NAME_PARTICLESYSTEM="ParticleSystem",fe.NAME_GAMEPAD="Gamepad",fe.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",fe.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",fe.NAME_PREPASSRENDERER="PrePassRenderer",fe.NAME_DEPTHRENDERER="DepthRenderer",fe.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",fe.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",fe.NAME_SPRITE="Sprite",fe.NAME_SUBSURFACE="SubSurface",fe.NAME_OUTLINERENDERER="Outline",fe.NAME_PROCEDURALTEXTURE="ProceduralTexture",fe.NAME_SHADOWGENERATOR="ShadowGenerator",fe.NAME_OCTREE="Octree",fe.NAME_PHYSICSENGINE="PhysicsEngine",fe.NAME_AUDIO="Audio",fe.NAME_FLUIDRENDERER="FluidRenderer",fe.STEP_ISREADYFORMESH_EFFECTLAYER=0,fe.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,fe.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,fe.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,fe.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,fe.STEP_BEFORECAMERADRAW_PREPASS=0,fe.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,fe.STEP_BEFORECAMERADRAW_LAYER=2,fe.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,fe.STEP_BEFORERENDERTARGETDRAW_LAYER=1,fe.STEP_BEFORERENDERINGMESH_PREPASS=0,fe.STEP_BEFORERENDERINGMESH_OUTLINE=1,fe.STEP_AFTERRENDERINGMESH_PREPASS=0,fe.STEP_AFTERRENDERINGMESH_OUTLINE=1,fe.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,fe.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,fe.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,fe.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,fe.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,fe.STEP_BEFORECLEAR_PREPASS=1,fe.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,fe.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,fe.STEP_AFTERRENDERTARGETDRAW_LAYER=1,fe.STEP_AFTERCAMERADRAW_PREPASS=0,fe.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,fe.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,fe.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,fe.STEP_AFTERCAMERADRAW_LAYER=4,fe.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,fe.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,fe.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,fe.STEP_AFTERRENDER_AUDIO=0,fe.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,fe.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,fe.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,fe.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,fe.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,fe.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,fe.STEP_POINTERMOVE_SPRITE=0,fe.STEP_POINTERDOWN_SPRITE=0,fe.STEP_POINTERUP_SPRITE=0;class de extends Array{constructor(t){super(...t)}static Create(){return Object.create(de.prototype)}registerStep(t,i,e){let s=0,n=Number.MAX_VALUE;for(;s<this.length;s++){if(n=this[s].index,t<n)break}this.splice(s,0,{index:t,component:i,action:e.bind(i)})}clear(){this.length=0}}class pe{}pe.POINTERDOWN=1,pe.POINTERUP=2,pe.POINTERMOVE=4,pe.POINTERWHEEL=8,pe.POINTERPICK=16,pe.POINTERTAP=32,pe.POINTERDOUBLETAP=64;class me{constructor(t,i){this.type=t,this.event=i}}class ve extends me{constructor(t,i,e,s){super(t,i),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new C(e,s)}}class ge extends me{constructor(t,i,e,s=null){super(t,i),this.ld=e,this.ud=s}get pickInfo(){return this.ld||this.fd(),this.ld}fd(){this.ud&&(this.ld=this.ud.dd(this.event.pointerId),this.ud.pd(this.ld,this.event),this.ud=null)}}class Se{}Se.KEYDOWN=1,Se.KEYUP=2;class Ee{constructor(t,i){this.type=t,this.event=i}}class Ae extends Ee{constructor(t,i){super(t,i),this.type=t,this.event=i,this.skipOnKeyboardObservable=!1}get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(t){this.skipOnKeyboardObservable=t}}!function(t){t[t.Generic=0]="Generic",t[t.Keyboard=1]="Keyboard",t[t.Mouse=2]="Mouse",t[t.Touch=3]="Touch",t[t.DualShock=4]="DualShock",t[t.Xbox=5]="Xbox",t[t.Switch=6]="Switch",t[t.DualSense=7]="DualSense"}(qi||(qi={})),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.LeftClick=2]="LeftClick",t[t.MiddleClick=3]="MiddleClick",t[t.RightClick=4]="RightClick",t[t.BrowserBack=5]="BrowserBack",t[t.BrowserForward=6]="BrowserForward",t[t.MouseWheelX=7]="MouseWheelX",t[t.MouseWheelY=8]="MouseWheelY",t[t.MouseWheelZ=9]="MouseWheelZ",t[t.Move=12]="Move"}(Qi||(Qi={})),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.LeftClick=2]="LeftClick",t[t.MiddleClick=3]="MiddleClick",t[t.RightClick=4]="RightClick",t[t.BrowserBack=5]="BrowserBack",t[t.BrowserForward=6]="BrowserForward",t[t.MouseWheelX=7]="MouseWheelX",t[t.MouseWheelY=8]="MouseWheelY",t[t.MouseWheelZ=9]="MouseWheelZ",t[t.DeltaHorizontal=10]="DeltaHorizontal",t[t.DeltaVertical=11]="DeltaVertical"}(Zi||(Zi={})),function(t){t[t.Cross=0]="Cross",t[t.Circle=1]="Circle",t[t.Square=2]="Square",t[t.Triangle=3]="Triangle",t[t.L1=4]="L1",t[t.R1=5]="R1",t[t.L2=6]="L2",t[t.R2=7]="R2",t[t.Share=8]="Share",t[t.Options=9]="Options",t[t.L3=10]="L3",t[t.R3=11]="R3",t[t.DPadUp=12]="DPadUp",t[t.DPadDown=13]="DPadDown",t[t.DPadLeft=14]="DPadLeft",t[t.DPadRight=15]="DPadRight",t[t.Home=16]="Home",t[t.TouchPad=17]="TouchPad",t[t.LStickXAxis=18]="LStickXAxis",t[t.LStickYAxis=19]="LStickYAxis",t[t.RStickXAxis=20]="RStickXAxis",t[t.RStickYAxis=21]="RStickYAxis"}(Ji||(Ji={})),function(t){t[t.Cross=0]="Cross",t[t.Circle=1]="Circle",t[t.Square=2]="Square",t[t.Triangle=3]="Triangle",t[t.L1=4]="L1",t[t.R1=5]="R1",t[t.L2=6]="L2",t[t.R2=7]="R2",t[t.Create=8]="Create",t[t.Options=9]="Options",t[t.L3=10]="L3",t[t.R3=11]="R3",t[t.DPadUp=12]="DPadUp",t[t.DPadDown=13]="DPadDown",t[t.DPadLeft=14]="DPadLeft",t[t.DPadRight=15]="DPadRight",t[t.Home=16]="Home",t[t.TouchPad=17]="TouchPad",t[t.LStickXAxis=18]="LStickXAxis",t[t.LStickYAxis=19]="LStickYAxis",t[t.RStickXAxis=20]="RStickXAxis",t[t.RStickYAxis=21]="RStickYAxis"}(te||(te={})),function(t){t[t.A=0]="A",t[t.B=1]="B",t[t.X=2]="X",t[t.Y=3]="Y",t[t.LB=4]="LB",t[t.RB=5]="RB",t[t.LT=6]="LT",t[t.RT=7]="RT",t[t.Back=8]="Back",t[t.Start=9]="Start",t[t.LS=10]="LS",t[t.RS=11]="RS",t[t.DPadUp=12]="DPadUp",t[t.DPadDown=13]="DPadDown",t[t.DPadLeft=14]="DPadLeft",t[t.DPadRight=15]="DPadRight",t[t.Home=16]="Home",t[t.LStickXAxis=17]="LStickXAxis",t[t.LStickYAxis=18]="LStickYAxis",t[t.RStickXAxis=19]="RStickXAxis",t[t.RStickYAxis=20]="RStickYAxis"}(ie||(ie={})),function(t){t[t.B=0]="B",t[t.A=1]="A",t[t.Y=2]="Y",t[t.X=3]="X",t[t.L=4]="L",t[t.R=5]="R",t[t.ZL=6]="ZL",t[t.ZR=7]="ZR",t[t.Minus=8]="Minus",t[t.Plus=9]="Plus",t[t.LS=10]="LS",t[t.RS=11]="RS",t[t.DPadUp=12]="DPadUp",t[t.DPadDown=13]="DPadDown",t[t.DPadLeft=14]="DPadLeft",t[t.DPadRight=15]="DPadRight",t[t.Home=16]="Home",t[t.Capture=17]="Capture",t[t.LStickXAxis=18]="LStickXAxis",t[t.LStickYAxis=19]="LStickYAxis",t[t.RStickXAxis=20]="RStickXAxis",t[t.RStickYAxis=21]="RStickYAxis"}(ee||(ee={})),function(t){t[t.PointerMove=0]="PointerMove",t[t.PointerDown=1]="PointerDown",t[t.PointerUp=2]="PointerUp"}(se||(se={}));class Ce{}Ce.DOM_DELTA_PIXEL=0,Ce.DOM_DELTA_LINE=1,Ce.DOM_DELTA_PAGE=2;class we{static CreateDeviceEvent(t,i,e,s,n,r){switch(t){case qi.Keyboard:return this.md(e,s,n,r);case qi.Mouse:if(e===Qi.MouseWheelX||e===Qi.MouseWheelY||e===Qi.MouseWheelZ)return this.vd(t,i,e,s,n,r);case qi.Touch:return this.gd(t,i,e,s,n,r);default:throw`Unable to generate event for device ${qi[t]}`}}static gd(t,i,e,s,n,r){const h=this.Sd(t,i,e,s,n,r);return t===qi.Mouse?(h.deviceType=qi.Mouse,h.pointerId=1,h.pointerType="mouse"):(h.deviceType=qi.Touch,h.pointerId=i,h.pointerType="touch"),e===Qi.Move?h.type="pointermove":e>=Qi.LeftClick&&e<=Qi.RightClick&&(h.type=1===s?"pointerdown":"pointerup",h.button=e-2),h}static vd(t,i,e,s,n,r){const h=this.Sd(t,i,e,s,n,r);switch(h.type="wheel",h.deltaMode=Ce.DOM_DELTA_PIXEL,h.deltaX=0,h.deltaY=0,h.deltaZ=0,e){case Qi.MouseWheelX:h.deltaX=s;break;case Qi.MouseWheelY:h.deltaY=s;break;case Qi.MouseWheelZ:h.deltaZ=s}return h}static Sd(t,i,e,s,n,r){const h=this.Ed(r),o=n.pollInput(t,i,Qi.Horizontal),a=n.pollInput(t,i,Qi.Vertical);return r?(h.movementX=0,h.movementY=0,h.offsetX=h.movementX-r.getBoundingClientRect().x,h.offsetY=h.movementY-r.getBoundingClientRect().y):(h.movementX=n.pollInput(t,i,Zi.DeltaHorizontal),h.movementY=n.pollInput(t,i,Zi.DeltaVertical),h.offsetX=0,h.offsetY=0),this.Ad(h,n),h.clientX=o,h.clientY=a,h.x=o,h.y=a,h.deviceType=t,h.deviceSlot=i,h.inputIndex=e,h}static md(t,i,e,s){const n=this.Ed(s);return this.Ad(n,e),n.deviceType=qi.Keyboard,n.deviceSlot=0,n.inputIndex=t,n.type=1===i?"keydown":"keyup",n.key=String.fromCharCode(t),n.keyCode=t,n}static Ad(t,i){const e=i.isDeviceAvailable(qi.Keyboard),s=e&&1===i.pollInput(qi.Keyboard,0,18),n=e&&1===i.pollInput(qi.Keyboard,0,17),r=e&&(1===i.pollInput(qi.Keyboard,0,91)||1===i.pollInput(qi.Keyboard,0,92)||1===i.pollInput(qi.Keyboard,0,93)),h=e&&1===i.pollInput(qi.Keyboard,0,16);t.altKey=s,t.ctrlKey=n,t.metaKey=r,t.shiftKey=h}static Ed(t){const i={preventDefault:()=>{}};return i.target=t,i}}class xe{constructor(t,i,e){this.Cd=_native.DeviceInputSystem?new _native.DeviceInputSystem(t,i,((t,i,s,n)=>{const r=we.CreateDeviceEvent(t,i,s,n,this);e(t,i,r)})):this.wd()}pollInput(t,i,e){return this.Cd.pollInput(t,i,e)}isDeviceAvailable(t){return t===qi.Mouse||t===qi.Touch}dispose(){this.Cd.dispose()}wd(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const Te=Object.keys(Qi).length/2;class Re{constructor(t,i,e,s){this.xd=[],this.Td=!1,this.Rd=!1,this.Id=ki.IsSafari(),this.Md=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this.bd=t=>{},this._d=t=>{},this.yd=t=>{},this.Nd=t=>{},this.Pd=t=>{},this.Dd=t=>{},this.Ld=t=>{},this.Od=t=>{},this.Fd=t=>{},this.Bd=!1,this.Ud=-1,this.Vd=Mt.IsNavigatorAvailable()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this.kd=0,this.Gd=null,this.zd=t=>{},this.Hd=t=>{},this.Xd=ki.GetPointerPrefix(t),this.Ls=t,this.Wd=i,this.$d=e,this.Yd=s,this.jd(),this.Md&&(this.Kd=[]),this.Ls.qd||(this.Ls.qd=()=>{this.jd()})}pollInput(t,i,e){const s=this.xd[t][i];if(!s)throw`Unable to find device ${qi[t]}`;t>=qi.DualShock&&t<=qi.DualSense&&this.Qd(t,i,e);const n=s[e];if(void 0===n)throw`Unable to find input ${e} for device ${qi[t]} in slot ${i}`;return e===Qi.Move&&ki.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),n}isDeviceAvailable(t){return void 0!==this.xd[t]}dispose(){this.Wd=()=>{},this.$d=()=>{},this.Yd=()=>{},delete this.Ls.qd,this.Zd&&this.Jd()}jd(){const t=null==this?void 0:this.Ls.getInputElement();if(t&&(!this.Bd||this.Zd!==t)){if(this.Jd(),this.xd)for(const t of this.xd)if(t)for(const i in t){const e=t[+i];if(e)for(let t=0;t<e.length;t++)e[t]=0}this.Zd=t,this.Zd.tabIndex=-1!==this.Zd.tabIndex?this.Zd.tabIndex:this.Ls.canvasTabIndex,this.tp(),this.ip(),this.ep(),this.Bd=!0,this.sp()}}Jd(){this.Zd&&(this.Zd.removeEventListener("blur",this.yd),this.Zd.removeEventListener("blur",this.Fd),this.Zd.removeEventListener("keydown",this.bd),this.Zd.removeEventListener("keyup",this._d),this.Zd.removeEventListener(this.Xd+"move",this.Nd),this.Zd.removeEventListener(this.Xd+"down",this.Pd),this.Zd.removeEventListener(this.Xd+"up",this.Dd),this.Zd.removeEventListener(this.Xd+"cancel",this.Ld),this.Zd.removeEventListener(this.np,this.Od),window.removeEventListener("gamepadconnected",this.zd),window.removeEventListener("gamepaddisconnected",this.Hd)),this.Gd&&this.Ls.onEndFrameObservable.remove(this.Gd),this.Bd=!1}sp(){if(navigator.getGamepads){const t=navigator.getGamepads();for(const i of t)i&&this.rp(i)}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this.hp(qi.Mouse,0,0,0)}rp(t){const i=this.op(t.id),e=t.index;this.ap=this.ap||new Array(t.index+1),this.lp(i,e,t.buttons.length+t.axes.length),this.ap[e]=i}hp(t,i,e,s){this.Rd||(this.Rd=!0),this.lp(t,i,Te);const n=this.xd[t][i];n[0]=e,n[1]=s}lp(t,i,e){if(void 0===i)throw`Unable to register device ${qi[t]} to undefined slot.`;if(this.xd[t]||(this.xd[t]={}),!this.xd[t][i]){const s=new Array(e);s.fill(0),this.xd[t][i]=s,this.Wd(t,i)}}cp(t,i){this.xd[t][i]&&(delete this.xd[t][i],this.$d(t,i))}tp(){this.bd=t=>{this.Td||(this.Td=!0,this.lp(qi.Keyboard,0,255));const i=this.xd[qi.Keyboard][0];if(i){i[t.keyCode]=1;const e=t;e.inputIndex=t.keyCode,this.Md&&t.metaKey&&"Meta"!==t.key&&(this.Kd.includes(t.keyCode)||this.Kd.push(t.keyCode)),this.Yd(qi.Keyboard,0,e)}},this._d=t=>{this.Td||(this.Td=!0,this.lp(qi.Keyboard,0,255));const i=this.xd[qi.Keyboard][0];if(i){i[t.keyCode]=0;const e=t;if(e.inputIndex=t.keyCode,this.Md&&"Meta"===t.key&&this.Kd.length>0){for(const t of this.Kd){const e=we.CreateDeviceEvent(qi.Keyboard,0,t,0,this,this.Zd);i[t]=0,this.Yd(qi.Keyboard,0,e)}this.Kd.splice(0,this.Kd.length)}this.Yd(qi.Keyboard,0,e)}},this.yd=()=>{if(this.Td){const t=this.xd[qi.Keyboard][0];for(let i=0;i<t.length;i++)if(0!==t[i]){t[i]=0;const e=we.CreateDeviceEvent(qi.Keyboard,0,i,0,this,this.Zd);this.Yd(qi.Keyboard,0,e)}this.Md&&this.Kd.splice(0,this.Kd.length)}},this.Zd.addEventListener("keydown",this.bd),this.Zd.addEventListener("keyup",this._d),this.Zd.addEventListener("blur",this.yd)}ip(){this.kd=Mt.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this.fp||(this.fp=new Array(this.kd));for(let t=0;t<this.kd;t++)this.fp[t]=-1;this.Nd=t=>{const i=this.dp(t),e=i===qi.Mouse?0:this.fp.indexOf(t.pointerId);this.xd[i]||(this.xd[i]={}),this.xd[i][e]||this.hp(i,e,t.clientX,t.clientY);const s=this.xd[i][e];if(s){const n=t;n.inputIndex=Qi.Move,s[Qi.Horizontal]=t.clientX,s[Qi.Vertical]=t.clientY,this.Yd(i,e,n),this.Id||-1===t.button||(n.inputIndex=t.button+2,s[t.button+2]=s[t.button+2]?0:1,this.Yd(i,e,n))}},this.Pd=t=>{const i=this.dp(t);let e=i===qi.Mouse?0:t.pointerId;if(i===qi.Touch){const i=this.fp.indexOf(-1);if(!(i>=0))return void ki.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this.kd}`);e=i,this.fp[i]=t.pointerId}this.xd[i]||(this.xd[i]={}),this.xd[i][e]?i===qi.Touch&&this.Wd(i,e):this.hp(i,e,t.clientX,t.clientY);const s=this.xd[i][e];if(s){const n=s[Qi.Horizontal],r=s[Qi.Vertical];if(i===qi.Mouse){if(-1===this.Ud&&(void 0===t.pointerId?this.Ud=this.Vd?0:1:this.Ud=t.pointerId),!document.pointerLockElement)try{this.Zd.setPointerCapture(this.Ud)}catch(t){}}else if(t.pointerId&&!document.pointerLockElement)try{this.Zd.setPointerCapture(t.pointerId)}catch(t){}s[Qi.Horizontal]=t.clientX,s[Qi.Vertical]=t.clientY,s[t.button+2]=1;const h=t;h.inputIndex=t.button+2,this.Yd(i,e,h),n===t.clientX&&r===t.clientY||(h.inputIndex=Qi.Move,this.Yd(i,e,h))}},this.Dd=t=>{var i,e,s,n,r;const h=this.dp(t),o=h===qi.Mouse?0:this.fp.indexOf(t.pointerId);if(h===qi.Touch){if(-1===o)return;this.fp[o]=-1}const a=null===(i=this.xd[h])||void 0===i?void 0:i[o];if(a&&0!==a[t.button+2]){const i=a[Qi.Horizontal],l=a[Qi.Vertical];a[Qi.Horizontal]=t.clientX,a[Qi.Vertical]=t.clientY,a[t.button+2]=0;const c=t;i===t.clientX&&l===t.clientY||(c.inputIndex=Qi.Move,this.Yd(h,o,c)),c.inputIndex=t.button+2,h===qi.Mouse&&this.Ud>=0&&(null===(s=(e=this.Zd).hasPointerCapture)||void 0===s?void 0:s.call(e,this.Ud))?this.Zd.releasePointerCapture(this.Ud):t.pointerId&&(null===(r=(n=this.Zd).hasPointerCapture)||void 0===r?void 0:r.call(n,t.pointerId))&&this.Zd.releasePointerCapture(t.pointerId),this.Yd(h,o,c),h===qi.Touch&&this.$d(h,o)}},this.Ld=t=>{var i,e,s,n;if("mouse"===t.pointerType){const t=this.xd[qi.Mouse][0];this.Ud>=0&&(null===(e=(i=this.Zd).hasPointerCapture)||void 0===e?void 0:e.call(i,this.Ud))&&this.Zd.releasePointerCapture(this.Ud);for(let i=Qi.LeftClick;i<=Qi.BrowserForward;i++)if(1===t[i]){t[i]=0;const e=we.CreateDeviceEvent(qi.Mouse,0,i,0,this,this.Zd);this.Yd(qi.Mouse,0,e)}}else{const i=this.fp.indexOf(t.pointerId);(null===(n=(s=this.Zd).hasPointerCapture)||void 0===n?void 0:n.call(s,t.pointerId))&&this.Zd.releasePointerCapture(t.pointerId),this.xd[qi.Touch][i][Qi.LeftClick]=0;const e=we.CreateDeviceEvent(qi.Touch,i,Qi.LeftClick,0,this,this.Zd);this.Yd(qi.Touch,i,e),this.fp[i]=-1,this.$d(qi.Touch,i)}},this.np="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let t=!1;const i=function(){};try{const e=Object.defineProperty({},"passive",{get:function(){t=!0}});this.Zd.addEventListener("test",i,e),this.Zd.removeEventListener("test",i,e)}catch(t){}this.Fd=()=>{var t,i,e,s,n;if(this.isDeviceAvailable(qi.Mouse)){const e=this.xd[qi.Mouse][0];this.Ud>=0&&(null===(i=(t=this.Zd).hasPointerCapture)||void 0===i?void 0:i.call(t,this.Ud))&&this.Zd.releasePointerCapture(this.Ud);for(let t=Qi.LeftClick;t<=Qi.BrowserForward;t++)if(1===e[t]){e[t]=0;const i=we.CreateDeviceEvent(qi.Mouse,0,t,0,this,this.Zd);this.Yd(qi.Mouse,0,i)}}if(this.isDeviceAvailable(qi.Touch)){const t=this.xd[qi.Touch];for(let i=0;i<this.fp.length;i++){const r=this.fp[i];if((null===(s=(e=this.Zd).hasPointerCapture)||void 0===s?void 0:s.call(e,r))&&this.Zd.releasePointerCapture(r),-1!==r&&1===(null===(n=t[i])||void 0===n?void 0:n[Qi.LeftClick])){t[i][Qi.LeftClick]=0;const e=we.CreateDeviceEvent(qi.Touch,i,Qi.LeftClick,0,this,this.Zd);this.Yd(qi.Touch,i,e),this.fp[i]=-1,this.$d(qi.Touch,i)}}}},this.Od=t=>{const i=qi.Mouse;this.xd[i]||(this.xd[i]=[]),this.xd[i][0]||(this.Rd=!0,this.lp(i,0,Te));const e=this.xd[i][0];if(e){e[Qi.MouseWheelX]=t.deltaX||0,e[Qi.MouseWheelY]=t.deltaY||t.wheelDelta||0,e[Qi.MouseWheelZ]=t.deltaZ||0;const s=t;0!==e[Qi.MouseWheelX]&&(s.inputIndex=Qi.MouseWheelX,this.Yd(i,0,s)),0!==e[Qi.MouseWheelY]&&(s.inputIndex=Qi.MouseWheelY,this.Yd(i,0,s)),0!==e[Qi.MouseWheelZ]&&(s.inputIndex=Qi.MouseWheelZ,this.Yd(i,0,s))}},this.Zd.addEventListener(this.Xd+"move",this.Nd),this.Zd.addEventListener(this.Xd+"down",this.Pd),this.Zd.addEventListener(this.Xd+"up",this.Dd),this.Zd.addEventListener(this.Xd+"cancel",this.Ld),this.Zd.addEventListener("blur",this.Fd),this.Zd.addEventListener(this.np,this.Od,!!t&&{passive:!1}),this.Gd=this.Ls.onEndFrameObservable.add((()=>{if(this.isDeviceAvailable(qi.Mouse)){const t=this.xd[qi.Mouse][0];t[Qi.MouseWheelX]=0,t[Qi.MouseWheelY]=0,t[Qi.MouseWheelZ]=0}}))}ep(){this.zd=t=>{this.rp(t.gamepad)},this.Hd=t=>{if(this.ap){const i=this.op(t.gamepad.id),e=t.gamepad.index;this.cp(i,e),delete this.ap[e]}},window.addEventListener("gamepadconnected",this.zd),window.addEventListener("gamepaddisconnected",this.Hd)}Qd(t,i,e){const s=navigator.getGamepads()[i];if(s&&t===this.ap[i]){const n=this.xd[t][i];e>=s.buttons.length?n[e]=s.axes[e-s.buttons.length].valueOf():n[e]=s.buttons[e].value}}op(t){return-1!==t.indexOf("054c")?-1!==t.indexOf("0ce6")?qi.DualSense:qi.DualShock:-1!==t.indexOf("Xbox One")||-1!==t.search("Xbox 360")||-1!==t.search("xinput")?qi.Xbox:-1!==t.indexOf("057e")?qi.Switch:qi.Generic}dp(t){let i=qi.Mouse;return("touch"===t.pointerType||"pen"===t.pointerType||t.touches)&&(i=qi.Touch),i}}class Ie{constructor(t,i,e=0){this.deviceType=i,this.deviceSlot=e,this.onInputChangedObservable=new h,this.pp=t}getInput(t){return this.pp.pollInput(this.deviceType,this.deviceSlot,t)}}class Me{constructor(t){this.mp=new Array,this.vp=0,this.registerManager=t=>{for(let i=0;i<this.gp.length;i++){const e=this.gp[i];for(const s in e){const e=+s;t.Sp(new Ie(this.pp,i,e))}}this.mp.push(t)},this.unregisterManager=t=>{const i=this.mp.indexOf(t);i>-1&&this.mp.splice(i,1)};const i=Object.keys(qi).length/2;this.gp=new Array(i);const e=(t,i)=>{this.gp[t]||(this.gp[t]=new Array),this.gp[t][i]||(this.gp[t][i]=i);for(const e of this.mp){const s=new Ie(this.pp,t,i);e.Sp(s)}},s=(t,i)=>{var e;(null===(e=this.gp[t])||void 0===e?void 0:e[i])&&delete this.gp[t][i];for(const e of this.mp)e.Ep(t,i)},n=(t,i,e)=>{if(e)for(const s of this.mp)s.Yd(t,i,e)};"undefined"!=typeof _native?this.pp=new xe(e,s,n):this.pp=new Re(t,e,s,n)}dispose(){this.pp.dispose()}}class be{constructor(t){const i=Object.keys(qi).length/2;this.gp=new Array(i),this.Ap=new Array(i),this.Ls=t,this.Ls.Cp||(this.Ls.Cp=new Me(t)),this.Ls.Cp.vp++,this.onDeviceConnectedObservable=new h((t=>{for(const i of this.gp)if(i)for(const e of i)e&&this.onDeviceConnectedObservable.notifyObserver(t,e)})),this.onDeviceDisconnectedObservable=new h,this.Ls.Cp.registerManager(this),this.Li=t.onDisposeObservable.add((()=>{this.dispose()}))}getDeviceSource(t,i){if(void 0===i){if(void 0===this.Ap[t])return null;i=this.Ap[t]}return this.gp[t]&&void 0!==this.gp[t][i]?this.gp[t][i]:null}getDeviceSources(t){return this.gp[t]?this.gp[t].filter((t=>!!t)):[]}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this.Ls.Cp&&(this.Ls.Cp.unregisterManager(this),--this.Ls.Cp.vp<1&&(this.Ls.Cp.dispose(),delete this.Ls.Cp)),this.Ls.onDisposeObservable.remove(this.Li)}Sp(t){this.gp[t.deviceType]||(this.gp[t.deviceType]=new Array),this.gp[t.deviceType][t.deviceSlot]||(this.gp[t.deviceType][t.deviceSlot]=t,this.wp(t.deviceType)),this.onDeviceConnectedObservable.notifyObservers(t)}Ep(t,i){var e,s;const n=null===(e=this.gp[t])||void 0===e?void 0:e[i];this.onDeviceDisconnectedObservable.notifyObservers(n),(null===(s=this.gp[t])||void 0===s?void 0:s[i])&&delete this.gp[t][i],this.wp(t)}Yd(t,i,e){var s,n;null===(n=null===(s=this.gp[t])||void 0===s?void 0:s[i])||void 0===n||n.onInputChangedObservable.notifyObservers(e)}wp(t){switch(t){case qi.Keyboard:case qi.Mouse:this.Ap[t]=0;break;case qi.Touch:case qi.DualSense:case qi.DualShock:case qi.Xbox:case qi.Switch:case qi.Generic:{delete this.Ap[t];const i=this.gp[t];if(i)for(let e=0;e<i.length;e++)if(i[e]){this.Ap[t]=e;break}break}}}}class _e{constructor(){this.xp=!1,this.Tp=!1,this.Rp=!1,this.Ip=!1}get singleClick(){return this.xp}get doubleClick(){return this.Tp}get hasSwiped(){return this.Rp}get ignore(){return this.Ip}set singleClick(t){this.xp=t}set doubleClick(t){this.Tp=t}set hasSwiped(t){this.Rp=t}set ignore(t){this.Ip=t}}class ye{constructor(t){this.Mp=!1,this.bp=!1,this._p=null,this.yp=null,this.Np=0,this.Pp=!1,this.Dp=!1,this.Lp=-1,this.Op=!1,this.Fp=!1,this.Bp=0,this.Vp=0,this.kp=new C(0,0),this.Gp=new C(0,0),this.zp=0,this.Hp=0,this.Xp={},this.Wp={},this.$p=null,this.Yp=0,this.Cp=null,this.Kt=t||E.LastCreatedScene,this.Kt}get meshUnderPointer(){return this.$p&&(this.$p.fd(),this.$p=null),this.jp}getMeshUnderPointerByPointerId(t){return this.Wp[t]||null}get unTranslatedPointer(){return new C(this.Kp,this.qp)}get pointerX(){return this.Bp}set pointerX(t){this.Bp=t}get pointerY(){return this.Vp}set pointerY(t){this.Vp=t}Qp(t){const i=this.Kt.getEngine().getInputElementClientRect();i&&(this.Bp=t.clientX-i.left,this.Vp=t.clientY-i.top,this.Kp=this.Bp,this.qp=this.Vp)}Zp(t,i){const e=this.Kt,s=e.getEngine(),n=s.getInputElement();n&&(n.tabIndex=s.canvasTabIndex,e.doNotHandleCursors||(n.style.cursor=e.defaultCursor)),this.Jp(t,i.pointerId,e);for(const i of e.tm){const e=!!(null==t?void 0:t.pickedMesh);t=i.action(this.Kp,this.qp,t,e,n)}const r=i.inputIndex>=Qi.MouseWheelX&&i.inputIndex<=Qi.MouseWheelZ?pe.POINTERWHEEL:pe.POINTERMOVE;let h;e.onPointerMove&&(t=t||this.dd(i.pointerId),e.onPointerMove(i,t,r)),t?(h=new ge(r,i,t),this.pd(t,i)):(h=new ge(r,i,null,this),this.$p=h),e.onPointerObservable.hasObservers()&&e.onPointerObservable.notifyObservers(h,r)}pd(t,i){const e=this.Kt;t&&e.im&&(t.ray||(t.ray=e.createPickingRay(i.offsetX,i.offsetY,R.Identity(),e.activeCamera)))}sm(t,i){return this.Yp++,this.Kt.onPointerObservable.add(t,i)}nm(t){return this.Yp--,this.Kt.onPointerObservable.remove(t)}rm(){return!!(this.Kt.onPointerObservable.observers.length>this.Yp||this.Kt.onPointerPick)}hm(t,i,e){const s=this.Kt,n=new ve(e,i,this.Kp,this.qp);return t&&(n.originalPickingInfo=t,n.ray=t.ray,t.originMesh&&(n.nearInteractionPickingInfo=t)),s.onPrePointerObservable.notifyObservers(n,e),!!n.skipOnPointerObservable}dd(t){const i=this.Kt,e=i.pick(this.Kp,this.qp,i.pointerMovePredicate,!1,i.cameraToUseForPointers,i.pointerMoveTrianglePredicate);return this.Jp(e,t,i),e}Jp(t,i,e){const s=e.getEngine().getInputElement();if(null==t?void 0:t.pickedMesh){if(this.setPointerOverMesh(t.pickedMesh,i,t),!e.doNotHandleCursors&&s&&this.jp){const t=this.jp.Xi();t&&t.hasPointerTriggers&&(s.style.cursor=t.hoverCursor||e.hoverCursor)}}else this.setPointerOverMesh(null,i,t)}simulatePointerMove(t,i){const e=new PointerEvent("pointermove",i);e.inputIndex=Qi.Move,this.hm(t,e,pe.POINTERMOVE)||this.Zp(t,e)}simulatePointerDown(t,i){const e=new PointerEvent("pointerdown",i);e.inputIndex=e.button+2,this.hm(t,e,pe.POINTERDOWN)||this.om(t,e)}om(t,i){const e=this.Kt;if(null==t?void 0:t.pickedMesh){this.am=t.pickedMesh;const s=t.pickedMesh.Xi();if(s){if(s.hasPickTriggers)switch(s.processTrigger(5,D.CreateNew(t.pickedMesh,i)),i.button){case 0:s.processTrigger(2,D.CreateNew(t.pickedMesh,i));break;case 1:s.processTrigger(4,D.CreateNew(t.pickedMesh,i));break;case 2:s.processTrigger(3,D.CreateNew(t.pickedMesh,i))}s.hasSpecificTrigger(8)&&window.setTimeout((()=>{const t=e.pick(this.Kp,this.qp,(t=>t.isPickable&&t.isVisible&&t.isReady()&&t.actionManager&&t.actionManager.hasSpecificTrigger(8)&&t===this.am),!1,e.cameraToUseForPointers);(null==t?void 0:t.pickedMesh)&&s&&0!==this.Np&&Date.now()-this.zp>ye.LongPressDelay&&!this.lm()&&(this.zp=0,s.processTrigger(8,D.CreateNew(t.pickedMesh,i)))}),ye.LongPressDelay)}}else for(const s of e.um)t=s.action(this.Kp,this.qp,t,i,!1);let s;const n=pe.POINTERDOWN;t?(e.onPointerDown&&e.onPointerDown(i,t,n),s=new ge(n,i,t),this.pd(t,i)):s=new ge(n,i,null,this),e.onPointerObservable.hasObservers()&&e.onPointerObservable.notifyObservers(s,n)}lm(){return this.Dp}simulatePointerUp(t,i,e){const s=new PointerEvent("pointerup",i);s.inputIndex=Qi.Move;const n=new _e;e?n.doubleClick=!0:n.singleClick=!0,this.hm(t,s,pe.POINTERUP)||this.fm(t,s,n)}fm(t,i,e){const s=this.Kt;if(null==t?void 0:t.pickedMesh){if(this.dm=t.pickedMesh,this.am===this.dm&&(s.onPointerPick&&s.onPointerPick(i,t),e.singleClick&&!e.ignore&&s.onPointerObservable.observers.length>this.Yp)){const e=pe.POINTERPICK,n=new ge(e,i,t);this.pd(t,i),s.onPointerObservable.notifyObservers(n,e)}const n=t.pickedMesh.Xi();if(n&&!e.ignore){n.processTrigger(7,D.CreateNew(t.pickedMesh,i,t)),!e.hasSwiped&&e.singleClick&&n.processTrigger(1,D.CreateNew(t.pickedMesh,i,t));const s=t.pickedMesh.Xi(6);e.doubleClick&&s&&s.processTrigger(6,D.CreateNew(t.pickedMesh,i,t))}}else if(!e.ignore)for(const n of s.pm)t=n.action(this.Kp,this.qp,t,i,e.doubleClick);if(this.am&&this.am!==this.dm){const t=this.am.Xi(16);t&&t.processTrigger(16,D.CreateNew(this.am,i))}if(!e.ignore){const n=new ge(pe.POINTERUP,i,t);if(this.pd(t,i),s.onPointerObservable.notifyObservers(n,pe.POINTERUP),s.onPointerUp&&s.onPointerUp(i,t,pe.POINTERUP),!e.hasSwiped&&!this.Op&&!this.Fp){let n=0;if(e.singleClick?n=pe.POINTERTAP:e.doubleClick&&(n=pe.POINTERDOUBLETAP),n){const e=new ge(n,i,t);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(n)&&s.onPointerObservable.notifyObservers(e,n)}}}}isPointerCaptured(t=0){return this.Xp[t]}attachControl(t=!0,i=!0,e=!0,n=null){const r=this.Kt,h=r.getEngine();n||(n=h.getInputElement()),this.Mp&&this.detachControl(),n&&(this.vm=n),this.Cp=new be(h),this.gm=t=>{if(!this.bp){const i=r.skipPointerUpPicking||0===r.qt&&!this.rm()&&!r.onPointerUp?null:r.pick(this.Kp,this.qp,r.pointerUpPredicate,!1,r.cameraToUseForPointers);this._p=i,i&&(t=i.hit&&i.pickedMesh?i.pickedMesh.Xi():null),this.bp=!0}return t},this.Sm=(t,i,e)=>{(Date.now()-this.Hp>ye.DoubleClickDelay&&!this.Pp||t!==this.Em)&&(this.Pp=!1,i.singleClick=!0,i.ignore=!1,e(i,this._p))},this.Am=(t,i,e,n)=>{const r=new _e;this._p=null;let h=null,o=t.hasSpecificMask(pe.POINTERPICK)||i.hasSpecificMask(pe.POINTERPICK)||t.hasSpecificMask(pe.POINTERTAP)||i.hasSpecificMask(pe.POINTERTAP)||t.hasSpecificMask(pe.POINTERDOUBLETAP)||i.hasSpecificMask(pe.POINTERDOUBLETAP);!o&&s&&(h=this.gm(h,r),h&&(o=h.hasPickTriggers));let a=!1;if(o){const o=e.button;if(r.hasSwiped=this.lm(),!r.hasSwiped){let e=!ye.ExclusiveDoubleClickMode;e||(e=!t.hasSpecificMask(pe.POINTERDOUBLETAP)&&!i.hasSpecificMask(pe.POINTERDOUBLETAP),e&&!s.HasSpecificTrigger(6)&&(h=this.gm(h,r),h&&(e=!h.hasSpecificTrigger(6)))),e?(Date.now()-this.Hp>ye.DoubleClickDelay||o!==this.Em)&&(r.singleClick=!0,n(r,this._p),a=!0):(this.Cm=this.wm,this.wm=window.setTimeout(this.Sm.bind(this,o,r,n),ye.DoubleClickDelay));let l=t.hasSpecificMask(pe.POINTERDOUBLETAP)||i.hasSpecificMask(pe.POINTERDOUBLETAP);!l&&s.HasSpecificTrigger(6)&&(h=this.gm(h,r),h&&(l=h.hasSpecificTrigger(6))),l&&(o===this.Em&&Date.now()-this.Hp<ye.DoubleClickDelay&&!this.Pp?(r.hasSwiped||this.lm()?(this.Pp=!1,this.Hp=this.zp,this.Gp.x=this.kp.x,this.Gp.y=this.kp.y,this.Em=o,ye.ExclusiveDoubleClickMode?(this.Cm&&clearTimeout(this.Cm),this.Cm=this.wm,n(r,this.yp)):n(r,this._p)):(this.Hp=0,this.Pp=!0,r.doubleClick=!0,r.ignore=!1,ye.ExclusiveDoubleClickMode&&this.Cm&&clearTimeout(this.Cm),this.Cm=this.wm,n(r,this._p)),a=!0):(this.Pp=!1,this.Hp=this.zp,this.Gp.x=this.kp.x,this.Gp.y=this.kp.y,this.Em=o))}}a||n(r,this._p)},this.xm=t=>{if(void 0===t.pointerId&&(t.pointerId=0),this.Qp(t),this.Dp||-1===this.Lp||(this.Dp=Math.abs(this.kp.x-this.Bp)>ye.DragMovementThreshold||Math.abs(this.kp.y-this.Vp)>ye.DragMovementThreshold),this.hm(null,t,t.inputIndex>=Qi.MouseWheelX&&t.inputIndex<=Qi.MouseWheelZ?pe.POINTERWHEEL:pe.POINTERMOVE))return;if(!r.cameraToUseForPointers&&!r.activeCamera)return;if(r.skipPointerMovePicking)return void this.Zp(new oe,t);r.pointerMovePredicate||(r.pointerMovePredicate=t=>t.isPickable&&t.isVisible&&t.isReady()&&t.isEnabled()&&(t.enablePointerMoveEvents||r.constantlyUpdateMeshUnderPointer||null!==t.Xi())&&(!r.cameraToUseForPointers||0!=(r.cameraToUseForPointers.layerMask&t.layerMask)));const i=r.qt>0?this.dd(t.pointerId):null;this.Zp(i,t)},this.Tm=t=>{if(this.Np++,this.am=null,this.bp=!1,void 0===t.pointerId&&(t.pointerId=0),this.Qp(t),-1===this.Lp&&(this.Lp=t.button),r.preventDefaultOnPointerDown&&n&&(t.preventDefault(),n.focus()),this.kp.x=this.Bp,this.kp.y=this.Vp,this.zp=Date.now(),this.hm(null,t,pe.POINTERDOWN))return;if(!r.cameraToUseForPointers&&!r.activeCamera)return;let i;this.Xp[t.pointerId]=!0,r.pointerDownPredicate||(r.pointerDownPredicate=t=>t.isPickable&&t.isVisible&&t.isReady()&&t.isEnabled()&&(!r.cameraToUseForPointers||0!=(r.cameraToUseForPointers.layerMask&t.layerMask))),this.am=null,i=r.skipPointerDownPicking||0===r.qt&&!this.rm()&&!r.onPointerDown?new oe:r.pick(this.Kp,this.qp,r.pointerDownPredicate,!1,r.cameraToUseForPointers),this.om(i,t)},this.Rm=t=>{0!==this.Np&&(this.Np--,this.dm=null,this.bp=!1,void 0===t.pointerId&&(t.pointerId=0),this.Qp(t),r.preventDefaultOnPointerUp&&n&&(t.preventDefault(),n.focus()),this.Am(r.onPrePointerObservable,r.onPointerObservable,t,((i,e)=>{if(r.onPrePointerObservable.hasObservers()&&(this.Op=!1,!i.ignore)){if(this.hm(null,t,pe.POINTERUP))return void(this.Lp===t.button&&(this.Dp=!1,this.Lp=-1));i.hasSwiped||(i.singleClick&&r.onPrePointerObservable.hasSpecificMask(pe.POINTERTAP)&&this.hm(null,t,pe.POINTERTAP)&&(this.Op=!0),i.doubleClick&&r.onPrePointerObservable.hasSpecificMask(pe.POINTERDOUBLETAP)&&this.hm(null,t,pe.POINTERDOUBLETAP)&&(this.Op=!0))}this.Xp[t.pointerId]=!1,(r.cameraToUseForPointers||r.activeCamera)&&(r.pointerUpPredicate||(r.pointerUpPredicate=t=>t.isPickable&&t.isVisible&&t.isReady()&&t.isEnabled()&&(!r.cameraToUseForPointers||0!=(r.cameraToUseForPointers.layerMask&t.layerMask))),!this.bp&&(s&&s.HasTriggers||this.rm()||r.onPointerUp)&&this.gm(null,i),e||(e=this._p),this.fm(e,t,i),this.yp=this._p,this.Lp===t.button&&(this.Dp=!1,this.Lp=-1))})))},this.Im=t=>{const i=Se.KEYDOWN;if(r.onPreKeyboardObservable.hasObservers()){const e=new Ae(i,t);if(r.onPreKeyboardObservable.notifyObservers(e,i),e.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const e=new Ee(i,t);r.onKeyboardObservable.notifyObservers(e,i)}r.actionManager&&r.actionManager.processTrigger(14,D.CreateNewFromScene(r,t))},this.Mm=t=>{const i=Se.KEYUP;if(r.onPreKeyboardObservable.hasObservers()){const e=new Ae(i,t);if(r.onPreKeyboardObservable.notifyObservers(e,i),e.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const e=new Ee(i,t);r.onKeyboardObservable.notifyObservers(e,i)}r.actionManager&&r.actionManager.processTrigger(15,D.CreateNewFromScene(r,t))},this.Cp.onDeviceConnectedObservable.add((s=>{s.deviceType===qi.Mouse?s.onInputChangedObservable.add((n=>{n.inputIndex===Qi.LeftClick||n.inputIndex===Qi.MiddleClick||n.inputIndex===Qi.RightClick||n.inputIndex===Qi.BrowserBack||n.inputIndex===Qi.BrowserForward?i&&1===s.getInput(n.inputIndex)?this.Tm(n):t&&0===s.getInput(n.inputIndex)&&this.Rm(n):e&&(n.inputIndex===Qi.Move?this.xm(n):n.inputIndex!==Qi.MouseWheelX&&n.inputIndex!==Qi.MouseWheelY&&n.inputIndex!==Qi.MouseWheelZ||this.xm(n))})):s.deviceType===qi.Touch?s.onInputChangedObservable.add((n=>{n.inputIndex===Qi.LeftClick&&(i&&1===s.getInput(n.inputIndex)?(this.Tm(n),this.Np>1&&(this.Fp=!0)):t&&0===s.getInput(n.inputIndex)&&(this.Rm(n),0===this.Np&&(this.Fp=!1))),e&&n.inputIndex===Qi.Move&&this.xm(n)})):s.deviceType===qi.Keyboard&&s.onInputChangedObservable.add((t=>{"keydown"===t.type?this.Im(t):"keyup"===t.type&&this.Mm(t)}))})),this.Mp=!0}detachControl(){this.Mp&&(this.Cp.dispose(),this.Cp=null,this.vm&&!this.Kt.doNotHandleCursors&&(this.vm.style.cursor=this.Kt.defaultCursor),this.Mp=!1,this.vm=null)}setPointerOverMesh(t,i=0,e){if(!(this.Wp[i]!==t||t&&t._m.bm))return;const s=this.Wp[i];let n;s&&(n=s.Xi(10),n&&n.processTrigger(10,D.CreateNew(s,void 0,{pointerId:i}))),t?(this.Wp[i]=t,this.jp=t,n=t.Xi(9),n&&n.processTrigger(9,D.CreateNew(t,void 0,{pointerId:i,pickResult:e}))):(delete this.Wp[i],this.jp=null)}getPointerOverMesh(){return this.meshUnderPointer}ym(t){this.jp===t&&(this.jp=null),this.am===t&&(this.am=null),this.dm===t&&(this.dm=null);for(const i in this.Wp)this.Wp[i]===t&&delete this.Wp[i]}}ye.DragMovementThreshold=10,ye.LongPressDelay=500,ye.DoubleClickDelay=300,ye.ExclusiveDoubleClickMode=!1;class Ne{constructor(){this.Nm=0,this.Pm=0,this.Dm=0,this.Lm=0,this.Om=0,this.Fm=0,this.Bm=0,this.Um=0,this.Vm=0,this.km=0,this.Gm=0}get min(){return this.Pm}get max(){return this.Dm}get average(){return this.Lm}get lastSecAverage(){return this.Om}get current(){return this.Fm}get total(){return this.Um}get count(){return this.Bm}fetchNewFrame(){this.Bm++,this.Fm=0,this.Gm++}addCount(t,i){Ne.Enabled&&(this.Fm+=t,i&&this.zm())}beginMonitoring(){Ne.Enabled&&(this.Nm=bt.Now)}endMonitoring(t=!0){if(!Ne.Enabled)return;t&&this.fetchNewFrame();const i=bt.Now;this.Fm=i-this.Nm,t&&this.zm()}zm(){this.Um+=this.Fm,this.Vm+=this.Fm,this.Pm=Math.min(this.Pm,this.Fm),this.Dm=Math.max(this.Dm,this.Fm),this.Lm=this.Um/this.Bm;const t=bt.Now;t-this.km>1e3&&(this.Om=this.Vm/this.Gm,this.km=t,this.Vm=0,this.Gm=0)}}Ne.Enabled=!0;class Pe{constructor(t,i,e,s){this.normal=new w(t,i,e),this.d=s}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new Pe(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let t=this.normal.getHashCode();return t=397*t^(0|this.d),t}normalize(){const t=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let i=0;return 0!==t&&(i=1/t),this.normal.x*=i,this.normal.y*=i,this.normal.z*=i,this.d*=i,this}transform(t){const i=Pe.Hm;t.invertToRef(i);const e=i.m,s=this.normal.x,n=this.normal.y,r=this.normal.z,h=this.d,o=s*e[0]+n*e[1]+r*e[2]+h*e[3],a=s*e[4]+n*e[5]+r*e[6]+h*e[7],l=s*e[8]+n*e[9]+r*e[10]+h*e[11],c=s*e[12]+n*e[13]+r*e[14]+h*e[15];return new Pe(o,a,l,c)}dotCoordinate(t){return this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z+this.d}copyFromPoints(t,i,e){const s=i.x-t.x,n=i.y-t.y,r=i.z-t.z,h=e.x-t.x,o=e.y-t.y,a=e.z-t.z,l=n*a-r*o,c=r*h-s*a,u=s*o-n*h,f=Math.sqrt(l*l+c*c+u*u);let d;return d=0!==f?1/f:0,this.normal.x=l*d,this.normal.y=c*d,this.normal.z=u*d,this.d=-(this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z),this}isFrontFacingTo(t,i){return w.Dot(this.normal,t)<=i}signedDistanceTo(t){return w.Dot(t,this.normal)+this.d}static FromArray(t){return new Pe(t[0],t[1],t[2],t[3])}static FromPoints(t,i,e){const s=new Pe(0,0,0,0);return s.copyFromPoints(t,i,e),s}static FromPositionAndNormal(t,i){const e=new Pe(0,0,0,0);return i.normalize(),e.normal=i,e.d=-(i.x*t.x+i.y*t.y+i.z*t.z),e}static SignedDistanceToPlaneFromPositionAndNormal(t,i,e){const s=-(i.x*t.x+i.y*t.y+i.z*t.z);return w.Dot(e,i)+s}}Pe.Hm=R.Identity();class De{static GetPlanes(t){const i=[];for(let t=0;t<6;t++)i.push(new Pe(0,0,0,0));return De.GetPlanesToRef(t,i),i}static GetNearPlaneToRef(t,i){const e=t.m;i.normal.x=e[3]+e[2],i.normal.y=e[7]+e[6],i.normal.z=e[11]+e[10],i.d=e[15]+e[14],i.normalize()}static GetFarPlaneToRef(t,i){const e=t.m;i.normal.x=e[3]-e[2],i.normal.y=e[7]-e[6],i.normal.z=e[11]-e[10],i.d=e[15]-e[14],i.normalize()}static GetLeftPlaneToRef(t,i){const e=t.m;i.normal.x=e[3]+e[0],i.normal.y=e[7]+e[4],i.normal.z=e[11]+e[8],i.d=e[15]+e[12],i.normalize()}static GetRightPlaneToRef(t,i){const e=t.m;i.normal.x=e[3]-e[0],i.normal.y=e[7]-e[4],i.normal.z=e[11]-e[8],i.d=e[15]-e[12],i.normalize()}static GetTopPlaneToRef(t,i){const e=t.m;i.normal.x=e[3]-e[1],i.normal.y=e[7]-e[5],i.normal.z=e[11]-e[9],i.d=e[15]-e[13],i.normalize()}static GetBottomPlaneToRef(t,i){const e=t.m;i.normal.x=e[3]+e[1],i.normal.y=e[7]+e[5],i.normal.z=e[11]+e[9],i.d=e[15]+e[13],i.normalize()}static GetPlanesToRef(t,i){De.GetNearPlaneToRef(t,i[0]),De.GetFarPlaneToRef(t,i[1]),De.GetLeftPlaneToRef(t,i[2]),De.GetRightPlaneToRef(t,i[3]),De.GetTopPlaneToRef(t,i[4]),De.GetBottomPlaneToRef(t,i[5])}}class Le{static get UniqueId(){const t=this.Xm;return this.Xm++,t}}Le.Xm=1;class Oe{static CompareLightsPriority(t,i){return t.shadowEnabled!==i.shadowEnabled?(i.shadowEnabled?1:0)-(t.shadowEnabled?1:0):i.renderPriority-t.renderPriority}}var Fe,Be,Ue,Ve;Oe.FALLOFF_DEFAULT=0,Oe.FALLOFF_PHYSICAL=1,Oe.FALLOFF_GLTF=2,Oe.FALLOFF_STANDARD=3,Oe.LIGHTMAP_DEFAULT=0,Oe.LIGHTMAP_SPECULAR=1,Oe.LIGHTMAP_SHADOWSONLY=2,Oe.INTENSITYMODE_AUTOMATIC=0,Oe.INTENSITYMODE_LUMINOUSPOWER=1,Oe.INTENSITYMODE_LUMINOUSINTENSITY=2,Oe.INTENSITYMODE_ILLUMINANCE=3,Oe.INTENSITYMODE_LUMINANCE=4,Oe.LIGHTTYPEID_POINTLIGHT=0,Oe.LIGHTTYPEID_DIRECTIONALLIGHT=1,Oe.LIGHTTYPEID_SPOTLIGHT=2,Oe.LIGHTTYPEID_HEMISPHERICLIGHT=3,function(t){t[t.BackwardCompatible=0]="BackwardCompatible",t[t.Intermediate=1]="Intermediate",t[t.Aggressive=2]="Aggressive"}(Fe||(Fe={}));class ke extends e{constructor(t,i){super(),this.ud=new ye(this),this.cameraToUseForPointers=null,this.Nt=!0,this.Wm=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new y(.2,.2,.3,1),this.ambientColor=new _(0,0,0),this.environmentIntensity=1,this.$m=Fe.BackwardCompatible,this.Ym=!1,this.jm=!1,this.Km=!1,this.animationsEnabled=!0,this.Pi=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=new Array,this.onDisposeObservable=new h,this.Li=null,this.onBeforeRenderObservable=new h,this.qm=null,this.onAfterRenderObservable=new h,this.onAfterRenderCameraObservable=new h,this.Qm=null,this.onBeforeAnimationsObservable=new h,this.onAfterAnimationsObservable=new h,this.onBeforeDrawPhaseObservable=new h,this.onAfterDrawPhaseObservable=new h,this.onReadyObservable=new h,this.onBeforeCameraRenderObservable=new h,this.Zm=null,this.onAfterCameraRenderObservable=new h,this.Jm=null,this.onBeforeActiveMeshesEvaluationObservable=new h,this.onAfterActiveMeshesEvaluationObservable=new h,this.onBeforeParticlesRenderingObservable=new h,this.onAfterParticlesRenderingObservable=new h,this.onDataLoadedObservable=new h,this.onNewCameraAddedObservable=new h,this.onCameraRemovedObservable=new h,this.onNewLightAddedObservable=new h,this.onLightRemovedObservable=new h,this.onNewGeometryAddedObservable=new h,this.onGeometryRemovedObservable=new h,this.onNewTransformNodeAddedObservable=new h,this.onTransformNodeRemovedObservable=new h,this.onNewMeshAddedObservable=new h,this.onMeshRemovedObservable=new h,this.onNewSkeletonAddedObservable=new h,this.onSkeletonRemovedObservable=new h,this.onNewMaterialAddedObservable=new h,this.onNewMultiMaterialAddedObservable=new h,this.onMaterialRemovedObservable=new h,this.onMultiMaterialRemovedObservable=new h,this.onNewTextureAddedObservable=new h,this.onTextureRemovedObservable=new h,this.onBeforeRenderTargetsRenderObservable=new h,this.onAfterRenderTargetsRenderObservable=new h,this.onBeforeStepObservable=new h,this.onAfterStepObservable=new h,this.onActiveCameraChanged=new h,this.onActiveCamerasChanged=new h,this.onBeforeRenderingGroupObservable=new h,this.onAfterRenderingGroupObservable=new h,this.onMeshImportedObservable=new h,this.onAnimationFileImportedObservable=new h,this.tv=new Hi(256),this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1,this.onPrePointerObservable=new h,this.onPointerObservable=new h,this.onPreKeyboardObservable=new h,this.onKeyboardObservable=new h,this.iv=!1,this.ev=0,this.sv=0,this.nv=0,this.rv=!0,this.hv=ke.FOGMODE_NONE,this.fogColor=new _(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this.ov=!0,this.av=!0,this.lv=null,this.cv=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this.fv=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new w(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this.probesEnabled=!0,this.dv=new Hi(256),this.proceduralTexturesEnabled=!0,this.pv=new Ne,this.mv=new Ne,this.Yf=new Ne,this.vv=new Ne,this.gv=0,this.animationTimeScale=1,this.Sv=0,this.sh=0,this.Ev=null,this.Av=!1,this.Cv=!1,this.wv=-1,this.xv=-1,this.Tv=new Array(256),this.Xh=new Array,this.Rv=new Array,this.li=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this.Iv=new zi(256),this.Mv=new zi(256),this._v=new Hi(256),this.yv=new Hi(256),this.Nv=new zi(256),this.Pv=new Hi(32),this.Dv=new Hi(32),this.Lv=new Array,this.Ov=R.Zero(),this.requireLightSorting=!1,this.Fv=[],this.Bv=[],this.Uv=[],this.Vv=de.Create(),this.kv=de.Create(),this.Gv=de.Create(),this.zv=de.Create(),this.Hv=de.Create(),this.Xv=de.Create(),this.Wv=de.Create(),this.$v=de.Create(),this.Yv=de.Create(),this.jv=de.Create(),this.Kv=de.Create(),this.qv=de.Create(),this.od=de.Create(),this.Qv=de.Create(),this.Zv=de.Create(),this.ad=de.Create(),this.Jv=de.Create(),this.tg=de.Create(),this.ig=de.Create(),this.eg=de.Create(),this.sg=de.Create(),this.tm=de.Create(),this.um=de.Create(),this.pm=de.Create(),this.ng=null,this.rg={data:[],length:0},this.hg={data:[],length:0},this.og=!1,this.lg=!1,this.Hf=!1,this.cg=!1,this.ug=!0,this.getDeterministicFrameTime=()=>this.Ls.getTimeStep(),this.qt=0,this.fg=!1,this.dg=null,this.activeCameras=new Array;const e={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...i};this.Ls=t||E.LastCreatedEngine,e.virtual?this.Ls.pg.push(this):(E.D=this,this.Ls.scenes.push(this)),this.mg=null,this.vg=new ue(this),ae&&(this.postProcessManager=new ae(this)),xt()&&this.attachControl(),this.gg(),ji&&(this.Sg=new ji),this.setDefaultCandidateProviders(),e.useGeometryUniqueIdsMap&&(this.ng={}),this.useMaterialMeshMap=e.useMaterialMeshMap,this.useClonedMeshMap=e.useClonedMeshMap,i&&i.virtual||this.Ls.onNewSceneAddedObservable.notifyObservers(this)}static DefaultMaterialFactory(t){throw X("StandardMaterial")}static CollisionCoordinatorFactory(){throw X("DefaultCollisionCoordinator")}get environmentTexture(){return this.l}set environmentTexture(t){this.l!==t&&(this.l=t,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this.Sg}get performancePriority(){return this.$m}set performancePriority(t){if(t!==this.$m)switch(this.$m=t,t){case Fe.BackwardCompatible:this.skipFrustumClipping=!1,this.vg.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case Fe.Intermediate:this.skipFrustumClipping=!1,this.vg.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case Fe.Aggressive:this.skipFrustumClipping=!0,this.vg.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1}}set forceWireframe(t){this.Ym!==t&&(this.Ym=t,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this.Ym}set skipFrustumClipping(t){this.jm!==t&&(this.jm=t)}get skipFrustumClipping(){return this.jm}set forcePointsCloud(t){this.Km!==t&&(this.Km=t,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this.Km}get animationPropertiesOverride(){return this.Pi}set animationPropertiesOverride(t){this.Pi=t}set onDispose(t){this.Li&&this.onDisposeObservable.remove(this.Li),this.Li=this.onDisposeObservable.add(t)}set beforeRender(t){this.qm&&this.onBeforeRenderObservable.remove(this.qm),t&&(this.qm=this.onBeforeRenderObservable.add(t))}set afterRender(t){this.Qm&&this.onAfterRenderObservable.remove(this.Qm),t&&(this.Qm=this.onAfterRenderObservable.add(t))}set beforeCameraRender(t){this.Zm&&this.onBeforeCameraRenderObservable.remove(this.Zm),this.Zm=this.onBeforeCameraRenderObservable.add(t)}set afterCameraRender(t){this.Jm&&this.onAfterCameraRenderObservable.remove(this.Jm),this.Jm=this.onAfterCameraRenderObservable.add(t)}get unTranslatedPointer(){return this.ud.unTranslatedPointer}static get DragMovementThreshold(){return ye.DragMovementThreshold}static set DragMovementThreshold(t){ye.DragMovementThreshold=t}static get LongPressDelay(){return ye.LongPressDelay}static set LongPressDelay(t){ye.LongPressDelay=t}static get DoubleClickDelay(){return ye.DoubleClickDelay}static set DoubleClickDelay(t){ye.DoubleClickDelay=t}static get ExclusiveDoubleClickMode(){return ye.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(t){ye.ExclusiveDoubleClickMode=t}bindEyePosition(t,i="vEyePosition",e=!1){var s;const n=this.Eg?this.Eg:this.Ag?this.Ag:null!==(s=this.activeCamera.globalPosition)&&void 0!==s?s:this.activeCamera.devicePosition,r=this.useRightHandedSystem===(null!=this.Ag);return M.Vector4[0].set(n.x,n.y,n.z,r?-1:1),t&&(e?t.setFloat3(i,M.Vector4[0].x,M.Vector4[0].y,M.Vector4[0].z):t.setVector4(i,M.Vector4[0])),M.Vector4[0]}finalizeSceneUbo(){const t=this.getSceneUniformBuffer(),i=this.bindEyePosition(null);return t.updateFloat4("vEyePosition",i.x,i.y,i.z,i.w),t.update(),t}set useRightHandedSystem(t){this.iv!==t&&(this.iv=t,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this.iv}setStepId(t){this.sv=t}getStepId(){return this.sv}getInternalStep(){return this.nv}set fogEnabled(t){this.rv!==t&&(this.rv=t,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this.rv}set fogMode(t){this.hv!==t&&(this.hv=t,this.markAllMaterialsAsDirty(16))}get fogMode(){return this.hv}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(t){this.ov!==t&&(this.ov=t,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this.ov}set lightsEnabled(t){this.av!==t&&(this.av=t,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this.av}get activeCameras(){return this.Cg}set activeCameras(t){this.lv&&(this.lv(),this.lv=null),t&&(this.lv=p(t,(()=>{this.onActiveCamerasChanged.notifyObservers(this)}))),this.Cg=t}get activeCamera(){return this.wg}set activeCamera(t){t!==this.wg&&(this.wg=t,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this.xg||(this.xg=ke.DefaultMaterialFactory(this)),this.xg}set defaultMaterial(t){this.xg=t}set texturesEnabled(t){this.cv!==t&&(this.cv=t,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this.cv}set skeletonsEnabled(t){this.fv!==t&&(this.fv=t,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this.fv}get collisionCoordinator(){return this.Tg||(this.Tg=ke.CollisionCoordinatorFactory(),this.Tg.init(this)),this.Tg}get renderingManager(){return this.vg}get frustumPlanes(){return this.Xf}Rg(){if(this.Uv.length>0){for(const t of this.Uv)t.register();this.Uv.length=0}}Ig(t){this.Fv.push(t),this.Uv.push(t);const i=t;i.addFromContainer&&i.serialize&&this.Bv.push(i)}Mg(t){for(const i of this.Fv)if(i.name===t)return i;return null}getClassName(){return"Scene"}bg(){return this.rg.data=this.meshes,this.rg.length=this.meshes.length,this.rg}_g(t){return this.hg.data=t.subMeshes,this.hg.length=t.subMeshes.length,this.hg}setDefaultCandidateProviders(){this.getActiveMeshCandidates=this.bg.bind(this),this.getActiveSubMeshCandidates=this._g.bind(this),this.getIntersectingSubMeshCandidates=this._g.bind(this),this.getCollidingSubMeshCandidates=this._g.bind(this)}get meshUnderPointer(){return this.ud.meshUnderPointer}get pointerX(){return this.ud.pointerX}set pointerX(t){this.ud.pointerX=t}get pointerY(){return this.ud.pointerY}set pointerY(t){this.ud.pointerY=t}getCachedMaterial(){return this.yg}getCachedEffect(){return this.Ng}getCachedVisibility(){return this.Pg}isCachedMaterialInvalid(t,i,e=1){return this.Ng!==i||this.yg!==t||this.Pg!==e}getEngine(){return this.Ls}getTotalVertices(){return this.pv.current}get totalVerticesPerfCounter(){return this.pv}getActiveIndices(){return this.mv.current}get totalActiveIndicesPerfCounter(){return this.mv}getActiveParticles(){return this.Yf.current}get activeParticlesPerfCounter(){return this.Yf}getActiveBones(){return this.vv.current}get activeBonesPerfCounter(){return this.vv}getActiveMeshes(){return this.Iv}getAnimationRatio(){return void 0!==this.Dg?this.Dg:1}getRenderId(){return this.Sv}getFrameId(){return this.sh}incrementRenderId(){this.Sv++}gg(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(t,i){return this.ud.simulatePointerMove(t,i),this}simulatePointerDown(t,i){return this.ud.simulatePointerDown(t,i),this}simulatePointerUp(t,i,e){return this.ud.simulatePointerUp(t,i,e),this}isPointerCaptured(t=0){return this.ud.isPointerCaptured(t)}attachControl(t=!0,i=!0,e=!0){this.ud.attachControl(t,i,e)}detachControl(){this.ud.detachControl()}isReady(t=!0){if(this.li)return!1;let i;const e=this.getEngine();let s=!0;for(this.Rv.length>0&&(s=!1),t&&(this.Mv.reset(),this.yv.reset()),i=0;i<this.meshes.length;i++){const n=this.meshes[i];if(!n.subMeshes||0===n.subMeshes.length)continue;if(!n.isReady(!0)){s=!1;continue}const r=n.hasThinInstances||"InstancedMesh"===n.getClassName()||"InstancedLinesMesh"===n.getClassName()||e.getCaps().instancedArrays&&n.instances.length>0;for(const t of this.Xv)t.action(n,r)||(s=!1);if(!t)continue;const h=n.material||this.defaultMaterial;if(h)if(h.Lg)for(const t of n.subMeshes){const i=t.getMaterial();i&&i.hasRenderTargetTextures&&null!=i.getRenderTargetTextures&&-1===this.Mv.indexOf(i)&&(this.Mv.push(i),this.yv.concatWithNoDuplicate(i.getRenderTargetTextures()))}else h.hasRenderTargetTextures&&null!=h.getRenderTargetTextures&&-1===this.Mv.indexOf(h)&&(this.Mv.push(h),this.yv.concatWithNoDuplicate(h.getRenderTargetTextures()))}if(!s)return!1;if(!e.areAllEffectsReady())return!1;if(t)for(i=0;i<this.yv.length;++i){if(!this.yv.data[i].isReadyForRendering())return!1}for(i=0;i<this.geometries.length;i++){if(2===this.geometries[i].delayLoadState)return!1}if(this.activeCameras&&this.activeCameras.length>0){for(const t of this.activeCameras)if(!t.isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(const t of this.particleSystems)if(!t.isReady())return!1;return!0}resetCachedMaterial(){this.yg=null,this.Ng=null,this.Pg=null}registerBeforeRender(t){this.onBeforeRenderObservable.add(t)}unregisterBeforeRender(t){this.onBeforeRenderObservable.removeCallback(t)}registerAfterRender(t){this.onAfterRenderObservable.add(t)}unregisterAfterRender(t){this.onAfterRenderObservable.removeCallback(t)}Og(t){const i=()=>{t(),setTimeout((()=>{this.unregisterBeforeRender(i)}))};this.registerBeforeRender(i)}executeOnceBeforeRender(t,i){void 0!==i?setTimeout((()=>{this.Og(t)}),i):this.Og(t)}addPendingData(t){this.Rv.push(t)}removePendingData(t){const i=this.isLoading,e=this.Rv.indexOf(t);-1!==e&&this.Rv.splice(e,1),i&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this.Rv.length}get isLoading(){return this.Rv.length>0}executeWhenReady(t,i=!1){this.onReadyObservable.addOnce(t),null===this.Ev&&this.Zs(i)}whenReadyAsync(t=!1){return new Promise((i=>{this.executeWhenReady((()=>{i()}),t)}))}Zs(t=!1){return this.Rg(),this.isReady(t)?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this.Ev=null)):this.li?(this.onReadyObservable.clear(),void(this.Ev=null)):void(this.Ev=setTimeout((()=>{this.incrementRenderId(),this.Zs(t)}),100))}get animatables(){return this.Lv}resetLastAnimationTimeFrame(){this.Fg=bt.Now}getViewMatrix(){return this.Bg}getProjectionMatrix(){return this.Ug}getTransformMatrix(){return this.Ov}setTransformMatrix(t,i,e,s){e||s||!this.Vg||(this.Vg.dispose(),this.Vg=null),this.wv===t.updateFlag&&this.xv===i.updateFlag||(this.wv=t.updateFlag,this.xv=i.updateFlag,this.Bg=t,this.Ug=i,this.Bg.multiplyToRef(this.Ug,this.Ov),this.Xf?De.GetPlanesToRef(this.Ov,this.Xf):this.Xf=De.GetPlanes(this.Ov),this.Vg&&this.Vg.useUbo?this.kg(e,s):this.Gg.useUbo&&(this.Gg.updateMatrix("viewProjection",this.Ov),this.Gg.updateMatrix("view",this.Bg),this.Gg.updateMatrix("projection",this.Ug)))}getSceneUniformBuffer(){return this.Vg?this.Vg:this.Gg}createSceneUniformBuffer(t){const i=new ne(this.Ls,void 0,!1,null!=t?t:"scene");return i.addUniform("viewProjection",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}setSceneUniformBuffer(t){this.Gg=t,this.wv=-1,this.xv=-1}getUniqueId(){return Le.UniqueId}addMesh(t,i=!1){this.Wm||(this.meshes.push(t),t.zg(),t.parent||t.Ui(),this.onNewMeshAddedObservable.notifyObservers(t),i&&t.getChildMeshes().forEach((t=>{this.addMesh(t)})))}removeMesh(t,i=!1){const e=this.meshes.indexOf(t);return-1!==e&&(this.meshes[e]=this.meshes[this.meshes.length-1],this.meshes.pop(),t.parent||t.Vi()),this.ud.ym(t),this.onMeshRemovedObservable.notifyObservers(t),i&&t.getChildMeshes().forEach((t=>{this.removeMesh(t)})),e}addTransformNode(t){this.Wm||t.getScene()===this&&-1!==t.Hg||(t.Hg=this.transformNodes.length,this.transformNodes.push(t),t.parent||t.Ui(),this.onNewTransformNodeAddedObservable.notifyObservers(t))}removeTransformNode(t){const i=t.Hg;if(-1!==i){if(i!==this.transformNodes.length-1){const t=this.transformNodes[this.transformNodes.length-1];this.transformNodes[i]=t,t.Hg=i}t.Hg=-1,this.transformNodes.pop(),t.parent||t.Vi()}return this.onTransformNodeRemovedObservable.notifyObservers(t),i}removeSkeleton(t){const i=this.skeletons.indexOf(t);return-1!==i&&(this.skeletons.splice(i,1),this.onSkeletonRemovedObservable.notifyObservers(t),this.Xg(this.Pv)),i}removeMorphTargetManager(t){const i=this.morphTargetManagers.indexOf(t);return-1!==i&&this.morphTargetManagers.splice(i,1),i}removeLight(t){const i=this.lights.indexOf(t);if(-1!==i){for(const i of this.meshes)i.Wg(t,!1);this.lights.splice(i,1),this.sortLightsByPriority(),t.parent||t.Vi()}return this.onLightRemovedObservable.notifyObservers(t),i}removeCamera(t){const i=this.cameras.indexOf(t);if(-1!==i&&(this.cameras.splice(i,1),t.parent||t.Vi()),this.activeCameras){const i=this.activeCameras.indexOf(t);-1!==i&&this.activeCameras.splice(i,1)}return this.activeCamera===t&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(t),i}removeParticleSystem(t){const i=this.particleSystems.indexOf(t);return-1!==i&&(this.particleSystems.splice(i,1),this.Xg(this.Nv)),i}removeAnimation(t){const i=this.animations.indexOf(t);return-1!==i&&this.animations.splice(i,1),i}stopAnimation(t,i,e){}removeAnimationGroup(t){const i=this.animationGroups.indexOf(t);return-1!==i&&this.animationGroups.splice(i,1),i}removeMultiMaterial(t){const i=this.multiMaterials.indexOf(t);return-1!==i&&this.multiMaterials.splice(i,1),this.onMultiMaterialRemovedObservable.notifyObservers(t),i}removeMaterial(t){const i=t.$g;if(-1!==i&&i<this.materials.length){if(i!==this.materials.length-1){const t=this.materials[this.materials.length-1];this.materials[i]=t,t.$g=i}t.$g=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(t),i}removeActionManager(t){const i=this.actionManagers.indexOf(t);return-1!==i&&this.actionManagers.splice(i,1),i}removeTexture(t){const i=this.textures.indexOf(t);return-1!==i&&this.textures.splice(i,1),this.onTextureRemovedObservable.notifyObservers(t),i}addLight(t){if(!this.Wm){this.lights.push(t),this.sortLightsByPriority(),t.parent||t.Ui();for(const i of this.meshes)-1===i.lightSources.indexOf(t)&&(i.lightSources.push(t),i.zg());this.onNewLightAddedObservable.notifyObservers(t)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(Oe.CompareLightsPriority)}addCamera(t){this.Wm||(this.cameras.push(t),this.onNewCameraAddedObservable.notifyObservers(t),t.parent||t.Ui())}addSkeleton(t){this.Wm||(this.skeletons.push(t),this.onNewSkeletonAddedObservable.notifyObservers(t))}addParticleSystem(t){this.Wm||this.particleSystems.push(t)}addAnimation(t){this.Wm||this.animations.push(t)}addAnimationGroup(t){this.Wm||this.animationGroups.push(t)}addMultiMaterial(t){this.Wm||(this.multiMaterials.push(t),this.onNewMultiMaterialAddedObservable.notifyObservers(t))}addMaterial(t){this.Wm||t.getScene()===this&&-1!==t.$g||(t.$g=this.materials.length,this.materials.push(t),this.onNewMaterialAddedObservable.notifyObservers(t))}addMorphTargetManager(t){this.Wm||this.morphTargetManagers.push(t)}addGeometry(t){this.Wm||(this.ng&&(this.ng[t.uniqueId]=this.geometries.length),this.geometries.push(t))}addActionManager(t){this.actionManagers.push(t)}addTexture(t){this.Wm||(this.textures.push(t),this.onNewTextureAddedObservable.notifyObservers(t))}switchActiveCamera(t,i=!0){this.Ls.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=t,i&&t.attachControl())}setActiveCameraById(t){const i=this.getCameraById(t);return i?(this.activeCamera=i,i):null}setActiveCameraByName(t){const i=this.getCameraByName(t);return i?(this.activeCamera=i,i):null}getAnimationGroupByName(t){for(let i=0;i<this.animationGroups.length;i++)if(this.animationGroups[i].name===t)return this.animationGroups[i];return null}Yg(t,i){for(let t=0;t<this.materials.length;t++){const e=this.materials[t];if(i(e))return e}if(t)for(let t=0;t<this.multiMaterials.length;t++){const e=this.multiMaterials[t];if(i(e))return e}return null}getMaterialByUniqueID(t,i=!1){return this.Yg(i,(i=>i.uniqueId===t))}getMaterialById(t,i=!1){return this.Yg(i,(i=>i.id===t))}getMaterialByName(t,i=!1){return this.Yg(i,(i=>i.name===t))}getLastMaterialById(t,i=!1){for(let i=this.materials.length-1;i>=0;i--)if(this.materials[i].id===t)return this.materials[i];if(i)for(let i=this.multiMaterials.length-1;i>=0;i--)if(this.multiMaterials[i].id===t)return this.multiMaterials[i];return null}getTextureByUniqueId(t){for(let i=0;i<this.textures.length;i++)if(this.textures[i].uniqueId===t)return this.textures[i];return null}getTextureByName(t){for(let i=0;i<this.textures.length;i++)if(this.textures[i].name===t)return this.textures[i];return null}getCameraById(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].id===t)return this.cameras[i];return null}getCameraByUniqueId(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].uniqueId===t)return this.cameras[i];return null}getCameraByName(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].name===t)return this.cameras[i];return null}getBoneById(t){for(let i=0;i<this.skeletons.length;i++){const e=this.skeletons[i];for(let i=0;i<e.bones.length;i++)if(e.bones[i].id===t)return e.bones[i]}return null}getBoneByName(t){for(let i=0;i<this.skeletons.length;i++){const e=this.skeletons[i];for(let i=0;i<e.bones.length;i++)if(e.bones[i].name===t)return e.bones[i]}return null}getLightByName(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].name===t)return this.lights[i];return null}getLightById(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].id===t)return this.lights[i];return null}getLightByUniqueId(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].uniqueId===t)return this.lights[i];return null}getParticleSystemById(t){for(let i=0;i<this.particleSystems.length;i++)if(this.particleSystems[i].id===t)return this.particleSystems[i];return null}getGeometryById(t){for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].id===t)return this.geometries[i];return null}jg(t){if(this.ng){const i=this.ng[t];if(void 0!==i)return this.geometries[i]}else for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].uniqueId===t)return this.geometries[i];return null}pushGeometry(t,i){return!(!i&&this.jg(t.uniqueId))&&(this.addGeometry(t),this.onNewGeometryAddedObservable.notifyObservers(t),!0)}removeGeometry(t){let i;if(this.ng){if(i=this.ng[t.uniqueId],void 0===i)return!1}else if(i=this.geometries.indexOf(t),i<0)return!1;if(i!==this.geometries.length-1){const t=this.geometries[this.geometries.length-1];t&&(this.geometries[i]=t,this.ng&&(this.ng[t.uniqueId]=i))}return this.ng&&(this.ng[t.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(t),!0}getGeometries(){return this.geometries}getMeshById(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].id===t)return this.meshes[i];return null}getMeshesById(t){return this.meshes.filter((function(i){return i.id===t}))}getTransformNodeById(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].id===t)return this.transformNodes[i];return null}getTransformNodeByUniqueId(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].uniqueId===t)return this.transformNodes[i];return null}getTransformNodesById(t){return this.transformNodes.filter((function(i){return i.id===t}))}getMeshByUniqueId(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].uniqueId===t)return this.meshes[i];return null}getLastMeshById(t){for(let i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===t)return this.meshes[i];return null}getLastEntryById(t){let i;for(i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===t)return this.meshes[i];for(i=this.transformNodes.length-1;i>=0;i--)if(this.transformNodes[i].id===t)return this.transformNodes[i];for(i=this.cameras.length-1;i>=0;i--)if(this.cameras[i].id===t)return this.cameras[i];for(i=this.lights.length-1;i>=0;i--)if(this.lights[i].id===t)return this.lights[i];return null}getNodeById(t){const i=this.getMeshById(t);if(i)return i;const e=this.getTransformNodeById(t);if(e)return e;const s=this.getLightById(t);if(s)return s;const n=this.getCameraById(t);if(n)return n;const r=this.getBoneById(t);return r||null}getNodeByName(t){const i=this.getMeshByName(t);if(i)return i;const e=this.getTransformNodeByName(t);if(e)return e;const s=this.getLightByName(t);if(s)return s;const n=this.getCameraByName(t);if(n)return n;const r=this.getBoneByName(t);return r||null}getMeshByName(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].name===t)return this.meshes[i];return null}getTransformNodeByName(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].name===t)return this.transformNodes[i];return null}getLastSkeletonById(t){for(let i=this.skeletons.length-1;i>=0;i--)if(this.skeletons[i].id===t)return this.skeletons[i];return null}getSkeletonByUniqueId(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].uniqueId===t)return this.skeletons[i];return null}getSkeletonById(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].id===t)return this.skeletons[i];return null}getSkeletonByName(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].name===t)return this.skeletons[i];return null}getMorphTargetManagerById(t){for(let i=0;i<this.morphTargetManagers.length;i++)if(this.morphTargetManagers[i].uniqueId===t)return this.morphTargetManagers[i];return null}getMorphTargetById(t){for(let i=0;i<this.morphTargetManagers.length;++i){const e=this.morphTargetManagers[i];for(let i=0;i<e.numTargets;++i){const s=e.getTarget(i);if(s.id===t)return s}}return null}getMorphTargetByName(t){for(let i=0;i<this.morphTargetManagers.length;++i){const e=this.morphTargetManagers[i];for(let i=0;i<e.numTargets;++i){const s=e.getTarget(i);if(s.name===t)return s}}return null}getPostProcessByName(t){for(let i=0;i<this.postProcesses.length;++i){const e=this.postProcesses[i];if(e.name===t)return e}return null}isActiveMesh(t){return-1!==this.Iv.indexOf(t)}get uid(){return this.mg||(this.mg=ki.RandomId()),this.mg}addExternalData(t,i){return this.Kg||(this.Kg=new Xi),this.Kg.add(t,i)}getExternalData(t){return this.Kg?this.Kg.get(t):null}getOrAddExternalDataWithFactory(t,i){return this.Kg||(this.Kg=new Xi),this.Kg.getOrAddWithFactory(t,i)}removeExternalData(t){return this.Kg.remove(t)}qg(t,i,e,s){if(s||t.isInFrustum(this.Xf)){for(const e of this.$v)e.action(i,t);const e=t.getMaterial();null!=e&&(e.hasRenderTargetTextures&&null!=e.getRenderTargetTextures&&-1===this.Mv.indexOf(e)&&(this.Mv.push(e),this.yv.concatWithNoDuplicate(e.getRenderTargetTextures())),this.vg.dispatch(t,i,e))}}freeProcessedMaterials(){this.Mv.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this.og}set blockfreeActiveMeshesAndRenderingGroups(t){this.og!==t&&(t&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this.og=t)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this.Iv.dispose(),this.activeCamera&&this.activeCamera.Iv&&this.activeCamera.Iv.dispose(),this.activeCameras))for(let t=0;t<this.activeCameras.length;t++){const i=this.activeCameras[t];i&&i.Iv&&i.Iv.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this.vg&&this.vg.freeRenderingGroups(),this.textures))for(let t=0;t<this.textures.length;t++){const i=this.textures[t];i&&i.renderList&&i.freeRenderingGroups()}}Qg(){return this.Av}freezeActiveMeshes(t=!1,i,e,s=!0,n=!1){return this.executeWhenReady((()=>{if(this.activeCamera){if(this.Xf||this.updateTransformMatrix(),this.Zg(),this.lg=!0,this.Hf=n,this.cg=t,s)for(let t=0;t<this.Iv.length;t++)this.Iv.data[t].Jg();i&&i()}else e&&e("No active camera found")})),this}unfreezeActiveMeshes(){for(let t=0;t<this.meshes.length;t++){const i=this.meshes[t];i._m&&(i._m.tS=!1)}for(let t=0;t<this.Iv.length;t++)this.Iv.data[t].iS();return this.lg=!1,this}Xg(t){(!this.Ls.snapshotRendering||1!==this.Ls.snapshotRenderingMode)&&this.lg&&this.Iv.length||this.onBeforeRenderObservable.addOnce((()=>t.dispose()))}Zg(){var t;if(this.Ls.snapshotRendering&&1===this.Ls.snapshotRenderingMode)return void(this.Iv.length>0&&(null===(t=this.activeCamera)||void 0===t||t.Iv.reset(),this.Iv.reset(),this.vg.reset(),this.Mv.reset(),this.Nv.reset(),this.Pv.reset(),this.Dv.reset()));if(this.lg&&this.Iv.length){if(!this.cg){const t=this.Iv.length;for(let i=0;i<t;i++){this.Iv.data[i].computeWorldMatrix()}}if(this.Nv){const t=this.Nv.length;for(let i=0;i<t;i++)this.Nv.data[i].animate()}return void this.vg.resetSprites()}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera.Iv.reset(),this.Iv.reset(),this.vg.reset(),this.Mv.reset(),this.Nv.reset(),this.Pv.reset(),this.Dv.reset(),this.yv.reset();for(const t of this.Wv)t.action();const i=this.getActiveMeshCandidates(),e=i.length;for(let t=0;t<e;t++){const e=i.data[t];if(e._m.eS=!1,e.isBlocked)continue;if(this.pv.addCount(e.getTotalVertices(),!1),!e.isReady()||!e.isEnabled()||e.scaling.hasAZeroComponent)continue;e.computeWorldMatrix(),e.actionManager&&e.actionManager.hasSpecificTriggers2(12,13)&&this.dv.pushNoDuplicate(e);let s=this.customLODSelector?this.customLODSelector(e,this.activeCamera):e.getLOD(this.activeCamera);if(e._m.sS=s,e._m.eS=!0,null!=s&&(s!==e&&0!==s.billboardMode&&s.computeWorldMatrix(),e.nS(),e.isVisible&&e.visibility>0&&0!=(e.layerMask&this.activeCamera.layerMask)&&(this.jm||e.alwaysSelectAsActiveMesh||e.isInFrustum(this.Xf)))){this.Iv.push(e),this.activeCamera.Iv.push(e),s!==e&&s.rS(this.Sv,!1);for(const t of this.Yv)t.action(e);e.rS(this.Sv,!1)&&(e.isAnInstance?e._m.hS&&(s=e):s._m.oS=!1,s._m.tS=!0,this.aS(e,s)),e.lS()}}if(this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let t=0;t<this.particleSystems.length;t++){const i=this.particleSystems[t];if(!i.isStarted()||!i.emitter)continue;const e=i.emitter;e.position&&!e.isEnabled()||(this.Nv.push(i),i.animate(),this.vg.dispatchParticles(i))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}aS(t,i){this.fv&&null!==i.skeleton&&void 0!==i.skeleton&&(this.Pv.pushNoDuplicate(i.skeleton)&&(i.skeleton.prepare(),this.vv.addCount(i.skeleton.bones.length,!1)),i.computeBonesUsingShaders||this.Dv.pushNoDuplicate(i));let e=t.hasInstances||t.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this.jm||i.alwaysSelectAsActiveMesh;if(i&&i.subMeshes&&i.subMeshes.length>0){const s=this.getActiveSubMeshCandidates(i),n=s.length;e=e||1===n;for(let r=0;r<n;r++){const n=s.data[r];this.qg(n,i,t,e)}}}updateTransformMatrix(t){if(this.activeCamera)if(this.activeCamera.cS){const i=this.activeCamera.uS[0],e=this.activeCamera.uS[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(t),e.getViewMatrix(),e.getProjectionMatrix(t))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(t))}fS(t,i=!0){t&&t.dS?t.dS.fS():t&&t.outputRenderTarget?t.outputRenderTarget.fS():this.Ls.Ko()||this.Ls.restoreDefaultFramebuffer(),i&&this.pS(t)}pS(t){if(t&&t.dS);else if(t&&t.outputRenderTarget&&!t.cS){const i=t.outputRenderTarget;i.onClearObservable.hasObservers()?i.onClearObservable.notifyObservers(this.Ls):i.skipInitialClear||(this.autoClear&&this.Ls.clear(i.clearColor||this.clearColor,!i.mS,!0,!0),i.mS=!0)}else this.Cv?this.Ls.clear(null,!1,!0,!0):(this.Cv=!0,this.vS())}gS(t,i,e=!0){var s,n,r;if(t&&t.SS)return;const h=this.Ls;if(this.wg=t,!this.activeCamera)throw new Error("Active camera not set");if(h.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this.Sv++,!this.prePass&&e){let i=!0;t.cS&&t.outputRenderTarget&&(i=t.outputRenderTarget.skipInitialClear,this.autoClear&&(t.outputRenderTarget.skipInitialClear=!1)),this.fS(this.wg),t.cS&&t.outputRenderTarget&&(t.outputRenderTarget.skipInitialClear=i)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this.Zg();for(let t=0;t<this.Dv.length;t++){const i=this.Dv.data[t];i.applySkeleton(i.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._v.concatWithNoDuplicate(this.yv),t.customRenderTargets&&t.customRenderTargets.length>0&&this._v.concatWithNoDuplicate(t.customRenderTargets),i&&i.customRenderTargets&&i.customRenderTargets.length>0&&this._v.concatWithNoDuplicate(i.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._v.pushNoDuplicate(this.environmentTexture);for(const t of this.Hv)t.action(this._v);let o=!1;if(this.renderTargetsEnabled){if(this.Av=!0,this._v.length>0){ki.StartPerformanceCounter("Render targets",this._v.length>0);for(let t=0;t<this._v.length;t++){const i=this._v.data[t];if(i.ES()){this.Sv++;const t=i.activeCamera&&i.activeCamera!==this.activeCamera;i.render(t,this.dumpNextRenderTargets),o=!0}}ki.EndPerformanceCounter("Render targets",this._v.length>0),this.Sv++}for(const t of this.jv)o=t.action(this.activeCamera)||o;this.Av=!1}this.Ls.currentRenderPassId=null!==(r=null!==(n=null===(s=t.outputRenderTarget)||void 0===s?void 0:s.renderPassId)&&void 0!==n?n:t.renderPassId)&&void 0!==r?r:0,o&&!this.prePass&&this.fS(this.wg,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),!this.postProcessManager||t.dS||this.prePass||this.postProcessManager.mf();for(const t of this.Kv)t.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),h.snapshotRendering&&1===h.snapshotRenderingMode&&this.finalizeSceneUbo(),this.vg.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const t of this.Jv)t.action(this.activeCamera);if(this.postProcessManager&&!t.dS){const i=t.outputRenderTarget?t.outputRenderTarget.renderTarget:void 0;this.postProcessManager.Sf(t.isIntermediate,i)}for(const t of this.tg)t.action(this.activeCamera);this._v.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}AS(t,i=!0){if(0===t.cameraRigMode||t.cS)return t.cS&&!this.Vg&&this.CS(),this.gS(t,void 0,i),void this.onAfterRenderCameraObservable.notifyObservers(t);if(t.wS)this.xS(t);else{this.onBeforeCameraRenderObservable.notifyObservers(t);for(let i=0;i<t.uS.length;i++)this.gS(t.uS[i],t)}this.wg=t,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(t)}TS(){for(let t=0;t<this.dv.length;t++){const i=this.dv.data[t];if(i.actionManager)for(let t=0;i.actionManager&&t<i.actionManager.actions.length;t++){const e=i.actionManager.actions[t];if(12===e.trigger||13===e.trigger){const t=e.getTriggerParameter(),s=t.mesh?t.mesh:t,n=s.intersectsMesh(i,t.usePreciseIntersection),r=i.IS.indexOf(s);n&&-1===r?12===e.trigger?(e.At(D.CreateNew(i,void 0,s)),i.IS.push(s)):13===e.trigger&&i.IS.push(s):!n&&r>-1&&(13===e.trigger&&e.At(D.CreateNew(i,void 0,s)),i.actionManager.hasSpecificTrigger(13,(t=>{const i=t.mesh?t.mesh:t;return s===i}))&&13!==e.trigger||i.IS.splice(r,1))}}}}MS(t){}bS(){}animate(){if(this.Ls.isDeterministicLockStep()){let t=Math.max(ke.MinDeltaTime,Math.min(this.Ls.getDeltaTime(),ke.MaxDeltaTime))+this.ev;const i=this.Ls.getTimeStep(),e=1e3/i/1e3;let s=0;const n=this.Ls.getLockstepMaxSteps();let r=Math.floor(t/i);for(r=Math.min(r,n);t>0&&s<r;)this.onBeforeStepObservable.notifyObservers(this),this.Dg=i*e,this.bS(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this.MS(i),this.onAfterStepObservable.notifyObservers(this),this.sv++,s++,t-=i;this.ev=t<0?0:t}else{const t=this.useConstantAnimationDeltaTime?16:Math.max(ke.MinDeltaTime,Math.min(this.Ls.getDeltaTime(),ke.MaxDeltaTime));this.Dg=.06*t,this.bS(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this.MS(t)}}vS(){(this.autoClearDepthAndStencil||this.autoClear)&&this.Ls.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_S(t){var i;if((null==t?void 0:t.outputRenderTarget)&&!(null==t?void 0:t.isRigCamera)&&(t.outputRenderTarget.mS=!1),null===(i=null==t?void 0:t.rigCameras)||void 0===i?void 0:i.length)for(let i=0;i<t.rigCameras.length;++i){const e=t.rigCameras[i].outputRenderTarget;e&&(e.mS=!1)}}resetDrawCache(t){if(this.meshes)for(const i of this.meshes)i.resetDrawCache(t)}render(t=!0,i=!1){var e,s,n;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&null===this.Ev&&this.Zs(),this.sh++,this.Cv=!1,this._S(this.activeCamera),(null===(e=this.activeCameras)||void 0===e?void 0:e.length)&&this.activeCameras.forEach(this._S),this.Rg(),this.Yf.fetchNewFrame(),this.pv.fetchNewFrame(),this.mv.fetchNewFrame(),this.vv.fetchNewFrame(),this.dv.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),i||this.animate();for(const t of this.Vv)t.action();if(t)if(this.activeCameras&&this.activeCameras.length>0)for(let t=0;t<this.activeCameras.length;t++){const i=this.activeCameras[t];if(i.update(),0!==i.cameraRigMode)for(let t=0;t<i.uS.length;t++)i.uS[t].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(let t=0;t<this.activeCamera.uS.length;t++)this.activeCamera.uS[t].update();this.onBeforeRenderObservable.notifyObservers(this);const r=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const h=(null===(s=this.activeCameras)||void 0===s?void 0:s.length)?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){ki.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this.Av=!0;for(let t=0;t<this.customRenderTargets.length;t++){const i=this.customRenderTargets[t];if(i.ES()){if(this.Sv++,this.activeCamera=i.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");r.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),i.render(h!==this.activeCamera,this.dumpNextRenderTargets)}}ki.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this.Av=!1,this.Sv++}this.Ls.currentRenderPassId=null!==(n=null==h?void 0:h.renderPassId)&&void 0!==n?n:0,this.activeCamera=h,this.wg&&22!==this.wg.cameraRigMode&&!this.prePass&&this.fS(this.wg,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const t of this.kv)t.action();this.pS(this.activeCamera);for(const t of this.zv)t.action(this._v);if(this.activeCameras&&this.activeCameras.length>0)for(let t=0;t<this.activeCameras.length;t++)this.AS(this.activeCameras[t],t>0);else{if(!this.activeCamera)throw new Error("No camera defined");this.AS(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this.TS();for(const t of this.sg)t.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this.Tv.length){for(let t=0;t<this.Tv.length;t++){const i=this.Tv[t];i&&i.dispose()}this.Tv.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this.vv.addCount(0,!0),this.mv.addCount(0,!0),this.Yf.addCount(0,!0),this.Ls.restoreDefaultFramebuffer()}freezeMaterials(){for(let t=0;t<this.materials.length;t++)this.materials[t].freeze()}unfreezeMaterials(){for(let t=0;t<this.materials.length;t++)this.materials[t].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this.Uv.length=0,this.Xv.clear(),this.Wv.clear(),this.$v.clear(),this.Yv.clear(),this.jv.clear(),this.Kv.clear(),this.qv.clear(),this.od.clear(),this.Qv.clear(),this.Zv.clear(),this.ad.clear(),this.Jv.clear(),this.ig.clear(),this.sg.clear(),this.Vv.clear(),this.kv.clear(),this.zv.clear(),this.Hv.clear(),this.tm.clear(),this.um.clear(),this.pm.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera.Iv.dispose(),this.activeCamera=null),this.activeCameras=null,this.Iv.dispose(),this.vg.dispose(),this.Mv.dispose(),this.Nv.dispose(),this.Pv.dispose(),this.Dv.dispose(),this._v.dispose(),this.yv.dispose(),this.tv.dispose(),this.dv.dispose(),this.Tv.length=0;const t=this.Xh.slice();for(const i of t)i.abort();this.Xh.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(t){console.error("An error occurred while calling onDisposeObservable!",t)}this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.detachControl();if(this.Ls.getInputElement())for(let t=0;t<this.cameras.length;t++)this.cameras[t].detachControl();this.yS(this.animationGroups),this.yS(this.lights),this.yS(this.meshes,(t=>t.dispose(!0))),this.yS(this.transformNodes,(t=>t.dispose(!0)));const i=this.cameras;this.yS(i),this.xg&&this.xg.dispose(),this.yS(this.multiMaterials),this.yS(this.materials),this.yS(this.particleSystems),this.yS(this.postProcesses),this.yS(this.textures),this.yS(this.morphTargetManagers),this.Gg.dispose(),this.Vg&&this.Vg.dispose(),this.postProcessManager.dispose(),this.yS(this.Fv);let e=this.Ls.scenes.indexOf(this);e>-1&&this.Ls.scenes.splice(e,1),E.D===this&&(this.Ls.scenes.length>0?E.D=this.Ls.scenes[this.Ls.scenes.length-1]:E.D=null),e=this.Ls.pg.indexOf(this),e>-1&&this.Ls.pg.splice(e,1),this.Ls.wipeCaches(!0),this.li=!0}yS(t,i){const e=t.slice(0);i=null!=i?i:t=>t.dispose();for(const t of e)i(t);t.length=0}get isDisposed(){return this.li}clearCachedVertexData(){for(let t=0;t<this.meshes.length;t++){const i=this.meshes[t].geometry;i&&i.clearCachedData()}}cleanCachedTextureBuffer(){for(const t of this.textures){t.Yn&&(t.Yn=null)}}getWorldExtends(t){const i=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e=new w(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return t=t||(()=>!0),this.meshes.filter(t).forEach((t=>{if(t.computeWorldMatrix(!0),!t.subMeshes||0===t.subMeshes.length||t.infiniteDistance)return;const s=t.getBoundingInfo(),n=s.boundingBox.minimumWorld,r=s.boundingBox.maximumWorld;w.CheckExtends(n,i,e),w.CheckExtends(r,i,e)})),{min:i,max:e}}createPickingRay(t,i,e,s,n=!1){throw X("Ray")}createPickingRayToRef(t,i,e,s,n,r=!1,h=!1){throw X("Ray")}createPickingRayInCameraSpace(t,i,e){throw X("Ray")}createPickingRayInCameraSpaceToRef(t,i,e,s){throw X("Ray")}get im(){return!1}pick(t,i,e,s,n,r){return new oe}pickWithBoundingInfo(t,i,e,s,n){return new oe}pickWithRay(t,i,e,s){throw X("Ray")}multiPick(t,i,e,s,n){throw X("Ray")}multiPickWithRay(t,i,e){throw X("Ray")}setPointerOverMesh(t,i,e){this.ud.setPointerOverMesh(t,i,e)}getPointerOverMesh(){return this.ud.getPointerOverMesh()}NS(){for(const t of this.geometries)t.br();for(const t of this.meshes)t.br();this.postProcessManager&&this.postProcessManager.br();for(const t of this.Fv)t.rebuild();for(const t of this.particleSystems)t.rebuild();if(this.spriteManagers)for(const t of this.spriteManagers)t.rebuild()}PS(){for(const t of this.textures)t.br();this.markAllMaterialsAsDirty(1)}DS(t,i,e){if(void 0===i)return t;const s=[];e=e||(t=>{});for(const n in t){const r=t[n];H&&H.MatchesQuery(r,i)&&(s.push(r),e(r))}return s}getMeshesByTags(t,i){return this.DS(this.meshes,t,i)}getCamerasByTags(t,i){return this.DS(this.cameras,t,i)}getLightsByTags(t,i){return this.DS(this.lights,t,i)}getMaterialByTags(t,i){return this.DS(this.materials,t,i).concat(this.DS(this.multiMaterials,t,i))}getTransformNodesByTags(t,i){return this.DS(this.transformNodes,t,i)}setRenderingOrder(t,i=null,e=null,s=null){this.vg.setRenderingOrder(t,i,e,s)}setRenderingAutoClearDepthStencil(t,i,e=!0,s=!0){this.vg.setRenderingAutoClearDepthStencil(t,i,e,s)}getAutoClearDepthStencilSetup(t){return this.vg.getAutoClearDepthStencilSetup(t)}get blockMaterialDirtyMechanism(){return this.fg}set blockMaterialDirtyMechanism(t){this.fg!==t&&(this.fg=t,t||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(t,i){if(!this.fg)for(const e of this.materials)i&&!i(e)||e.markAsDirty(t)}tn(t,i,e,s,n,r,h){const o=yi(t,i,e,s?this.offlineProvider:void 0,n,r,h);return this.Xh.push(o),o.onCompleteObservable.add((t=>{this.Xh.splice(this.Xh.indexOf(t),1)})),o}OS(t,i,e,s,n){return new Promise(((r,h)=>{this.tn(t,(t=>{r(t)}),i,e,s,((t,i)=>{h(i)}),n)}))}FS(t,i,e,s,n,r,h){const o=Ni(t,i,e,s?this.offlineProvider:void 0,n,r,h);return this.Xh.push(o),o.onCompleteObservable.add((t=>{this.Xh.splice(this.Xh.indexOf(t),1)})),o}BS(t,i,e,s,n){return new Promise(((r,h)=>{this.FS(t,(t=>{r(t)}),i,e,s,(t=>{h(t)}),n)}))}US(t,i,e,s,n){const r=_i(t,i,e,s,n);return this.Xh.push(r),r.onCompleteObservable.add((t=>{this.Xh.splice(this.Xh.indexOf(t),1)})),r}VS(t,i,e){return new Promise(((s,n)=>{this.US(t,(t=>{s(t)}),i,e,(t=>{n(t)}))}))}getPerfCollector(){throw X("performanceViewerSceneExtension")}}ke.FOGMODE_NONE=0,ke.FOGMODE_EXP=1,ke.FOGMODE_EXP2=2,ke.FOGMODE_LINEAR=3,ke.MinDeltaTime=1,ke.MaxDeltaTime=1e3,ke.prototype.setActiveCameraByID=function(t){return this.setActiveCameraById(t)},ke.prototype.getLastMaterialByID=function(t){return this.getLastMaterialById(t)},ke.prototype.getMaterialByID=function(t){return this.getMaterialById(t)},ke.prototype.getTextureByUniqueID=function(t){return this.getTextureByUniqueId(t)},ke.prototype.getCameraByID=function(t){return this.getCameraById(t)},ke.prototype.getCameraByUniqueID=function(t){return this.getCameraByUniqueId(t)},ke.prototype.getBoneByID=function(t){return this.getBoneById(t)},ke.prototype.getLightByID=function(t){return this.getLightById(t)},ke.prototype.getLightByUniqueID=function(t){return this.getLightByUniqueId(t)},ke.prototype.getParticleSystemByID=function(t){return this.getParticleSystemById(t)},ke.prototype.getGeometryByID=function(t){return this.getGeometryById(t)},ke.prototype.getMeshByID=function(t){return this.getMeshById(t)},ke.prototype.getMeshesByID=function(t){return this.getMeshesById(t)},ke.prototype.getTransformNodeByID=function(t){return this.getTransformNodeById(t)},ke.prototype.getTransformNodeByUniqueID=function(t){return this.getTransformNodeByUniqueId(t)},ke.prototype.getTransformNodesByID=function(t){return this.getTransformNodesById(t)},ke.prototype.getMeshByUniqueID=function(t){return this.getMeshByUniqueId(t)},ke.prototype.getLastMeshByID=function(t){return this.getLastMeshById(t)},ke.prototype.getLastEntryByID=function(t){return this.getLastEntryById(t)},ke.prototype.getNodeByID=function(t){return this.getNodeById(t)},ke.prototype.getLastSkeletonByID=function(t){return this.getLastSkeletonById(t)},function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD",t[t.BONE=2]="BONE"}(Be||(Be={}));class Ge{}Ge.X=new w(1,0,0),Ge.Y=new w(0,1,0),Ge.Z=new w(0,0,1),function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.Z=2]="Z"}(Ue||(Ue={}));class ze extends dt{constructor(t,i,e=null,s=null,n=null,r=null,h=null){super(t,i.getScene()),this.name=t,this.children=new Array,this.animations=new Array,this.kS=null,this.GS=new R,this.zS=new R,this.HS=1,this.XS=new R,this.WS=!0,this.$S=!1,this.YS=null,this.jS=null,this.KS=i,this.qS=s?s.clone():R.Identity(),this.QS=n||this.qS.clone(),this.ZS=r||this.qS.clone(),this.kS=h,i.bones.push(this),this.setParent(e,!1),(r||s)&&this.JS()}get tE(){return this.iE(),this.qS}set tE(t){this.$S=!1,t.updateFlag!==this.qS.updateFlag&&(this.qS.copyFrom(t),this.eE())}getClassName(){return"Bone"}getSkeleton(){return this.KS}get parent(){return this.Mi}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return null===this.kS?this.getSkeleton().bones.indexOf(this):this.kS}set parent(t){this.setParent(t)}setParent(t,i=!0){if(this.parent!==t){if(this.parent){const t=this.parent.children.indexOf(this);-1!==t&&this.parent.children.splice(t,1)}this.Mi=t,this.parent&&this.parent.children.push(this),i&&this.JS(),this.markAsDirty()}}getLocalMatrix(){return this.iE(),this.qS}getBaseMatrix(){return this.ZS}getRestPose(){return this.QS}setRestPose(t){this.QS.copyFrom(t)}getBindPose(){return this.ZS}setBindPose(t){this.updateMatrix(t)}getWorldMatrix(){return this.XS}returnToRest(){var t;if(this.YS){const i=M.Vector3[0],e=M.Quaternion[0],s=M.Vector3[1];this.getRestPose().decompose(i,e,s),this.YS.position.copyFrom(s),this.YS.rotationQuaternion=null!==(t=this.YS.rotationQuaternion)&&void 0!==t?t:T.Identity(),this.YS.rotationQuaternion.copyFrom(e),this.YS.scaling.copyFrom(i)}else this.tE=this.QS}getInvertedAbsoluteTransform(){return this.zS}getAbsoluteTransform(){return this.GS}linkTransformNode(t){this.YS&&this.KS.sE--,this.YS=t,this.YS&&this.KS.sE++}getTransformNode(){return this.YS}get position(){return this.nE(),this.rE}set position(t){this.nE(),this.rE.copyFrom(t),this.hE()}get rotation(){return this.getRotation()}set rotation(t){this.setRotation(t)}get rotationQuaternion(){return this.nE(),this.oE}set rotationQuaternion(t){this.setRotationQuaternion(t)}get scaling(){return this.getScale()}set scaling(t){this.setScale(t)}get animationPropertiesOverride(){return this.KS.animationPropertiesOverride}nE(){this.WS&&(this.WS=!1,this.aE||(this.aE=w.Zero(),this.oE=T.Zero(),this.rE=w.Zero()),this.qS.decompose(this.aE,this.oE,this.rE))}iE(){this.$S&&(this.aE?(this.$S=!1,R.ComposeToRef(this.aE,this.oE,this.rE,this.qS)):this.$S=!1)}updateMatrix(t,i=!0,e=!0){this.ZS.copyFrom(t),i&&this.JS(),e?this.tE=t:this.markAsDirty()}JS(t,i=!0){if(t||(t=this.ZS),this.parent?t.multiplyToRef(this.parent.GS,this.GS):this.GS.copyFrom(t),this.GS.invertToRef(this.zS),i)for(let t=0;t<this.children.length;t++)this.children[t].JS();this.HS=this.GS.determinant()<0?-1:1}markAsDirty(){return this.Ai++,this.wi++,this.KS.lE(),this}hE(){this.markAsDirty(),this.$S=!0}eE(){this.markAsDirty(),this.WS=!0}translate(t,i=Be.LOCAL,e){const s=this.getLocalMatrix();if(i==Be.LOCAL)s.addAtIndex(12,t.x),s.addAtIndex(13,t.y),s.addAtIndex(14,t.z);else{let i=null;e&&(i=e.getWorldMatrix()),this.KS.computeAbsoluteTransforms();const n=ze.cE[0],r=ze.uE[0];this.parent?e&&i?(n.copyFrom(this.parent.getAbsoluteTransform()),n.multiplyToRef(i,n)):n.copyFrom(this.parent.getAbsoluteTransform()):R.IdentityToRef(n),n.setTranslationFromFloats(0,0,0),n.invert(),w.TransformCoordinatesToRef(t,n,r),s.addAtIndex(12,r.x),s.addAtIndex(13,r.y),s.addAtIndex(14,r.z)}this.eE()}setPosition(t,i=Be.LOCAL,e){const s=this.getLocalMatrix();if(i==Be.LOCAL)s.setTranslationFromFloats(t.x,t.y,t.z);else{let i=null;e&&(i=e.getWorldMatrix()),this.KS.computeAbsoluteTransforms();const n=ze.cE[0],r=ze.uE[0];this.parent?(e&&i?(n.copyFrom(this.parent.getAbsoluteTransform()),n.multiplyToRef(i,n)):n.copyFrom(this.parent.getAbsoluteTransform()),n.invert()):R.IdentityToRef(n),w.TransformCoordinatesToRef(t,n,r),s.setTranslationFromFloats(r.x,r.y,r.z)}this.eE()}setAbsolutePosition(t,i){this.setPosition(t,Be.WORLD,i)}scale(t,i,e,s=!1){const n=this.getLocalMatrix(),r=ze.cE[0];R.ScalingToRef(t,i,e,r),r.multiplyToRef(n,n),r.invert();for(const s of this.children){const n=s.getLocalMatrix();n.multiplyToRef(r,n),n.multiplyAtIndex(12,t),n.multiplyAtIndex(13,i),n.multiplyAtIndex(14,e),s.eE()}if(this.eE(),s)for(const n of this.children)n.scale(t,i,e,s)}setScale(t){this.nE(),this.aE.copyFrom(t),this.hE()}getScale(){return this.nE(),this.aE}getScaleToRef(t){this.nE(),t.copyFrom(this.aE)}setYawPitchRoll(t,i,e,s=Be.LOCAL,n){if(s===Be.LOCAL){const r=ze.fE;return T.RotationYawPitchRollToRef(t,i,e,r),void this.setRotationQuaternion(r,s,n)}const r=ze.cE[0];if(!this.dE(r,n))return;const h=ze.cE[1];R.RotationYawPitchRollToRef(t,i,e,h),r.multiplyToRef(h,h),this.pE(h,s,n)}rotate(t,i,e=Be.LOCAL,s){const n=ze.cE[0];n.setTranslationFromFloats(0,0,0),R.RotationAxisToRef(t,i,n),this.pE(n,e,s)}setAxisAngle(t,i,e=Be.LOCAL,s){if(e===Be.LOCAL){const n=ze.fE;return T.RotationAxisToRef(t,i,n),void this.setRotationQuaternion(n,e,s)}const n=ze.cE[0];if(!this.dE(n,s))return;const r=ze.cE[1];R.RotationAxisToRef(t,i,r),n.multiplyToRef(r,r),this.pE(r,e,s)}setRotation(t,i=Be.LOCAL,e){this.setYawPitchRoll(t.y,t.x,t.z,i,e)}setRotationQuaternion(t,i=Be.LOCAL,e){if(i===Be.LOCAL)return this.nE(),this.oE.copyFrom(t),void this.hE();const s=ze.cE[0];if(!this.dE(s,e))return;const n=ze.cE[1];R.FromQuaternionToRef(t,n),s.multiplyToRef(n,n),this.pE(n,i,e)}setRotationMatrix(t,i=Be.LOCAL,e){if(i===Be.LOCAL){const s=ze.fE;return T.FromRotationMatrixToRef(t,s),void this.setRotationQuaternion(s,i,e)}const s=ze.cE[0];if(!this.dE(s,e))return;const n=ze.cE[1];n.copyFrom(t),s.multiplyToRef(t,n),this.pE(n,i,e)}pE(t,i=Be.LOCAL,e){const s=this.getLocalMatrix(),n=s.m[12],r=s.m[13],h=s.m[14],o=this.getParent(),a=ze.cE[3],l=ze.cE[4];o&&i==Be.WORLD?(e?(a.copyFrom(e.getWorldMatrix()),o.getAbsoluteTransform().multiplyToRef(a,a)):a.copyFrom(o.getAbsoluteTransform()),l.copyFrom(a),l.invert(),s.multiplyToRef(a,s),s.multiplyToRef(t,s),s.multiplyToRef(l,s)):i==Be.WORLD&&e?(a.copyFrom(e.getWorldMatrix()),l.copyFrom(a),l.invert(),s.multiplyToRef(a,s),s.multiplyToRef(t,s),s.multiplyToRef(l,s)):s.multiplyToRef(t,s),s.setTranslationFromFloats(n,r,h),this.computeAbsoluteTransforms(),this.eE()}dE(t,i){const e=ze.cE[2];return t.copyFrom(this.getAbsoluteTransform()),i?(t.multiplyToRef(i.getWorldMatrix(),t),R.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,e)):R.IdentityToRef(e),t.invert(),!isNaN(t.m[0])&&(e.multiplyAtIndex(0,this.HS),t.multiplyToRef(e,t),!0)}getPosition(t=Be.LOCAL,i=null){const e=w.Zero();return this.getPositionToRef(t,i,e),e}getPositionToRef(t=Be.LOCAL,i,e){if(t==Be.LOCAL){const t=this.getLocalMatrix();e.x=t.m[12],e.y=t.m[13],e.z=t.m[14]}else{let t=null;i&&(t=i.getWorldMatrix()),this.KS.computeAbsoluteTransforms();let s=ze.cE[0];i&&t?(s.copyFrom(this.getAbsoluteTransform()),s.multiplyToRef(t,s)):s=this.getAbsoluteTransform(),e.x=s.m[12],e.y=s.m[13],e.z=s.m[14]}}getAbsolutePosition(t=null){const i=w.Zero();return this.getPositionToRef(Be.WORLD,t,i),i}getAbsolutePositionToRef(t,i){this.getPositionToRef(Be.WORLD,t,i)}computeAbsoluteTransforms(){if(this.iE(),this.parent)this.qS.multiplyToRef(this.parent.GS,this.GS);else{this.GS.copyFrom(this.qS);const t=this.KS.getPoseMatrix();t&&this.GS.multiplyToRef(t,this.GS)}const t=this.children,i=t.length;for(let e=0;e<i;e++)t[e].computeAbsoluteTransforms()}getDirection(t,i=null){const e=w.Zero();return this.getDirectionToRef(t,i,e),e}getDirectionToRef(t,i=null,e){let s=null;i&&(s=i.getWorldMatrix()),this.KS.computeAbsoluteTransforms();const n=ze.cE[0];n.copyFrom(this.getAbsoluteTransform()),i&&s&&n.multiplyToRef(s,n),w.TransformNormalToRef(t,n,e),e.normalize()}getRotation(t=Be.LOCAL,i=null){const e=w.Zero();return this.getRotationToRef(t,i,e),e}getRotationToRef(t=Be.LOCAL,i=null,e){const s=ze.fE;this.getRotationQuaternionToRef(t,i,s),s.toEulerAnglesToRef(e)}getRotationQuaternion(t=Be.LOCAL,i=null){const e=T.Identity();return this.getRotationQuaternionToRef(t,i,e),e}getRotationQuaternionToRef(t=Be.LOCAL,i=null,e){if(t==Be.LOCAL)this.nE(),e.copyFrom(this.oE);else{const t=ze.cE[0],s=this.getAbsoluteTransform();i?s.multiplyToRef(i.getWorldMatrix(),t):t.copyFrom(s),t.multiplyAtIndex(0,this.HS),t.multiplyAtIndex(1,this.HS),t.multiplyAtIndex(2,this.HS),t.decompose(void 0,e,void 0)}}getRotationMatrix(t=Be.LOCAL,i){const e=R.Identity();return this.getRotationMatrixToRef(t,i,e),e}getRotationMatrixToRef(t=Be.LOCAL,i,e){if(t==Be.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(e);else{const t=ze.cE[0],s=this.getAbsoluteTransform();i?s.multiplyToRef(i.getWorldMatrix(),t):t.copyFrom(s),t.multiplyAtIndex(0,this.HS),t.multiplyAtIndex(1,this.HS),t.multiplyAtIndex(2,this.HS),t.getRotationMatrixToRef(e)}}getAbsolutePositionFromLocal(t,i=null){const e=w.Zero();return this.getAbsolutePositionFromLocalToRef(t,i,e),e}getAbsolutePositionFromLocalToRef(t,i=null,e){let s=null;i&&(s=i.getWorldMatrix()),this.KS.computeAbsoluteTransforms();let n=ze.cE[0];i&&s?(n.copyFrom(this.getAbsoluteTransform()),n.multiplyToRef(s,n)):n=this.getAbsoluteTransform(),w.TransformCoordinatesToRef(t,n,e)}getLocalPositionFromAbsolute(t,i=null){const e=w.Zero();return this.getLocalPositionFromAbsoluteToRef(t,i,e),e}getLocalPositionFromAbsoluteToRef(t,i=null,e){let s=null;i&&(s=i.getWorldMatrix()),this.KS.computeAbsoluteTransforms();const n=ze.cE[0];n.copyFrom(this.getAbsoluteTransform()),i&&s&&n.multiplyToRef(s,n),n.invert(),w.TransformCoordinatesToRef(t,n,e)}setCurrentPoseAsRest(){this.setRestPose(this.getLocalMatrix())}}ze.uE=f.BuildArray(2,w.Zero),ze.fE=T.Identity(),ze.cE=f.BuildArray(5,R.Identity);class He{constructor(t,i,e=0,s=100,n=!1,r=1,o,a,l,c=!1){this.target=i,this.fromFrame=e,this.toFrame=s,this.loopAnimation=n,this.onAnimationEnd=o,this.onAnimationLoop=l,this.isAdditive=c,this.mE=null,this.vE=null,this.gE=null,this.ie=new Array,this.SE=!1,this.EE=1,this.Ae=-1,this.AE=null,this.CE=null,this.wE=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new h,this.onAnimationLoopObservable=new h,this.Kt=t,a&&this.appendAnimations(i,a),this.EE=r,t.Lv.push(this)}get syncRoot(){return this.AE}get masterFrame(){return 0===this.ie.length?0:this.ie[0].currentFrame}get weight(){return this.Ae}set weight(t){this.Ae=-1!==t?Math.min(Math.max(t,0),1):-1}get speedRatio(){return this.EE}set speedRatio(t){for(let i=0;i<this.ie.length;i++){this.ie[i].ke(t)}this.EE=t,null!==this.wE&&this.goToFrame(this.wE)}syncWith(t){if(this.AE=t,t){const t=this.Kt.Lv.indexOf(this);t>-1&&(this.Kt.Lv.splice(t,1),this.Kt.Lv.push(this))}return this}getAnimations(){return this.ie}appendAnimations(t,i){for(let e=0;e<i.length;e++){const s=i[e],n=new wt(t,s,this.Kt,this);n.Ge=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this.ie.push(n)}}getAnimationByTargetProperty(t){const i=this.ie;for(let e=0;e<i.length;e++)if(i[e].animation.targetProperty===t)return i[e].animation;return null}getRuntimeAnimationByTargetProperty(t){const i=this.ie;for(let e=0;e<i.length;e++)if(i[e].animation.targetProperty===t)return i[e];return null}reset(){const t=this.ie;for(let i=0;i<t.length;i++)t[i].reset(!0);this.mE=null,this.vE=null}enableBlending(t){const i=this.ie;for(let e=0;e<i.length;e++)i[e].animation.enableBlending=!0,i[e].animation.blendingSpeed=t}disableBlending(){const t=this.ie;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!1}goToFrame(t){var i;const e=this.ie;if(e[0]){const s=e[0].animation.framePerSecond;this.CE=null!==(i=this.CE)&&void 0!==i?i:e[0].currentFrame;const n=0===this.speedRatio?0:(t-this.CE)/s*1e3/this.speedRatio;this.gE=-n}for(let i=0;i<e.length;i++)e[i].goToFrame(t);this.wE=t}pause(){this.SE||(this.SE=!0)}restart(){this.SE=!1}xE(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(t,i){if(t||i){const e=this.Kt.Lv.indexOf(this);if(e>-1){const s=this.ie;for(let e=s.length-1;e>=0;e--){const n=s[e];t&&n.animation.name!=t||(i&&!i(n.target)||(n.dispose(),s.splice(e,1)))}0==s.length&&(this.Kt.Lv.splice(e,1),this.xE())}}else{const t=this.Kt.Lv.indexOf(this);if(t>-1){this.Kt.Lv.splice(t,1);const i=this.ie;for(let t=0;t<i.length;t++)i[t].dispose();this.xE()}}}waitAsync(){return new Promise((t=>{this.onAnimationEndObservable.add((()=>{t(this)}),void 0,void 0,this,!0)}))}bS(t){if(this.SE)return this.animationStarted=!1,null===this.vE&&(this.vE=t),!0;if(null===this.mE?(this.mE=t,this.vE=null):null!==this.vE&&(this.mE+=t-this.vE,this.vE=null),null!==this.gE&&(this.mE+=this.gE,this.gE=null,this.CE=null),this.wE=null,0===this.Ae)return!0;let i=!1;const e=this.ie;let s;for(s=0;s<e.length;s++){const n=e[s].animate(t-this.mE,this.fromFrame,this.toFrame,this.loopAnimation,this.EE,this.Ae);i=i||n}if(this.animationStarted=i,!i){if(this.disposeOnEnd)for(s=this.Kt.Lv.indexOf(this),this.Kt.Lv.splice(s,1),s=0;s<e.length;s++)e[s].dispose();this.xE(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return i}}ke.prototype.bS=function(){if(!this.animationsEnabled)return;const t=bt.Now;if(!this.Fg){if(this.Rv.length>0)return;this.Fg=t}this.deltaTime=this.useConstantAnimationDeltaTime?16:(t-this.Fg)*this.animationTimeScale,this.Fg=t;const i=this.Lv;if(0===i.length)return;this.gv+=this.deltaTime;const e=this.gv;for(let t=0;t<i.length;t++){const s=i[t];!s.bS(e)&&s.disposeOnEnd&&t--}this.TE()},ke.prototype.beginWeightedAnimation=function(t,i,e,s=1,n,r=1,h,o,a,l,c=!1){const u=this.beginAnimation(t,i,e,n,r,h,o,!1,a,l,c);return u.weight=s,u},ke.prototype.beginAnimation=function(t,i,e,s,n=1,r,h,o=!0,a,l,c=!1){i>e&&n>0&&(n*=-1),o&&this.stopAnimation(t,void 0,a),h||(h=new He(this,t,i,e,s,n,r,void 0,l,c));const u=!a||a(t);if(t.animations&&u&&h.appendAnimations(t,t.animations),t.getAnimatables){const c=t.getAnimatables();for(let t=0;t<c.length;t++)this.beginAnimation(c[t],i,e,s,n,r,h,o,a,l)}return h.reset(),h},ke.prototype.beginHierarchyAnimation=function(t,i,e,s,n,r=1,h,o,a=!0,l,c,u=!1){const f=t.getDescendants(i),d=[];d.push(this.beginAnimation(t,e,s,n,r,h,o,a,l,void 0,u));for(const t of f)d.push(this.beginAnimation(t,e,s,n,r,h,o,a,l,void 0,u));return d},ke.prototype.beginDirectAnimation=function(t,i,e,s,n,r,h,o,a=!1){if(void 0===r&&(r=1),e>s&&r>0)r*=-1;else if(s>e&&r<0){const t=s;s=e,e=t}return new He(this,t,e,s,n,r,h,i,o,a)},ke.prototype.beginDirectHierarchyAnimation=function(t,i,e,s,n,r,h,o,a,l=!1){const c=t.getDescendants(i),u=[];u.push(this.beginDirectAnimation(t,e,s,n,r,h,o,a,l));for(const t of c)u.push(this.beginDirectAnimation(t,e,s,n,r,h,o,a,l));return u},ke.prototype.getAnimatableByTarget=function(t){for(let i=0;i<this.Lv.length;i++)if(this.Lv[i].target===t)return this.Lv[i];return null},ke.prototype.getAllAnimatablesByTarget=function(t){const i=[];for(let e=0;e<this.Lv.length;e++)this.Lv[e].target===t&&i.push(this.Lv[e]);return i},ke.prototype.stopAnimation=function(t,i,e){const s=this.getAllAnimatablesByTarget(t);for(const t of s)t.stop(i,e)},ke.prototype.stopAllAnimations=function(){if(this.Lv){for(let t=0;t<this.Lv.length;t++)this.Lv[t].stop();this.Lv.length=0}for(const t of this.animationGroups)t.stop()},ke.prototype.Ve=function(t,i){const e=t.target;this.tv.pushNoDuplicate(e),e.RE||(e.RE={}),e.RE[t.targetPath]||(e.RE[t.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:i}),t.isAdditive?(e.RE[t.targetPath].additiveAnimations.push(t),e.RE[t.targetPath].totalAdditiveWeight+=t.weight):(e.RE[t.targetPath].animations.push(t),e.RE[t.targetPath].totalWeight+=t.weight)},ke.prototype.IE=function(t){if(0===t.totalWeight&&0===t.totalAdditiveWeight)return t.originalValue;let i=1;const e=M.Vector3[0],s=M.Vector3[1],n=M.Quaternion[0];let r=0;const h=t.animations[0],o=t.originalValue;let a=1,l=!1;if(t.totalWeight<1)a=1-t.totalWeight,o.decompose(s,n,e);else{if(r=1,i=t.totalWeight,a=h.weight/i,1==a){if(!t.totalAdditiveWeight)return h.currentValue;l=!0}h.currentValue.decompose(s,n,e)}if(!l){s.scaleInPlace(a),e.scaleInPlace(a),n.scaleInPlace(a);for(let h=r;h<t.animations.length;h++){const r=t.animations[h];if(0===r.weight)continue;a=r.weight/i;const o=M.Vector3[2],l=M.Vector3[3],c=M.Quaternion[1];r.currentValue.decompose(l,c,o),l.scaleAndAddToRef(a,s),c.scaleAndAddToRef(T.Dot(n,c)>0?a:-a,n),o.scaleAndAddToRef(a,e)}n.normalize()}for(let i=0;i<t.additiveAnimations.length;i++){const r=t.additiveAnimations[i];if(0===r.weight)continue;const h=M.Vector3[2],o=M.Vector3[3],a=M.Quaternion[1];r.currentValue.decompose(o,a,h),o.multiplyToRef(s,o),w.LerpToRef(s,o,r.weight,s),n.multiplyToRef(a,a),T.SlerpToRef(n,a,r.weight,n),h.scaleAndAddToRef(r.weight,e)}const c=h?h.be.workValue:M.Matrix[0].clone();return R.ComposeToRef(s,n,e,c),c},ke.prototype.ME=function(t,i){if(0===t.totalWeight&&0===t.totalAdditiveWeight)return i;const e=t.animations[0],s=t.originalValue;let n=i;if(0===t.totalWeight&&t.totalAdditiveWeight>0)n.copyFrom(s);else if(1===t.animations.length){if(T.SlerpToRef(s,e.currentValue,Math.min(1,t.totalWeight),n),0===t.totalAdditiveWeight)return n}else if(t.animations.length>1){let e,r,h=1;if(t.totalWeight<1){const i=1-t.totalWeight;e=[],r=[],e.push(s),r.push(i)}else{if(2===t.animations.length&&(T.SlerpToRef(t.animations[0].currentValue,t.animations[1].currentValue,t.animations[1].weight/t.totalWeight,i),0===t.totalAdditiveWeight))return i;e=[],r=[],h=t.totalWeight}for(let i=0;i<t.animations.length;i++){const s=t.animations[i];e.push(s.currentValue),r.push(s.weight/h)}let o=0;for(let t=0;t<e.length;)t?(o+=r[t],T.SlerpToRef(n,e[t],r[t]/o,n),t++):(T.SlerpToRef(e[t],e[t+1],r[t+1]/(r[t]+r[t+1]),i),n=i,o=r[t]+r[t+1],t+=2)}for(let i=0;i<t.additiveAnimations.length;i++){const e=t.additiveAnimations[i];0!==e.weight&&(n.multiplyToRef(e.currentValue,M.Quaternion[0]),T.SlerpToRef(n,M.Quaternion[0],e.weight,n))}return n},ke.prototype.TE=function(){if(this.tv.length){for(let t=0;t<this.tv.length;t++){const i=this.tv.data[t];for(const t in i.RE){const e=i.RE[t],s=e.animations[0],n=e.originalValue;if(null==n)continue;const r=vt.AllowMatrixDecomposeForInterpolation&&n.m;let h=i[t];if(r)h=this.IE(e);else{if(void 0!==n.w)h=this.ME(e,h||T.Identity());else{let t=0,i=1;if(e.totalWeight<1)h=s&&n.scale?n.scale(1-e.totalWeight):s?n*(1-e.totalWeight):n.clone?n.clone():n;else if(s){i=e.totalWeight;const n=s.weight/i;h=1!==n?s.currentValue.scale?s.currentValue.scale(n):s.currentValue*n:s.currentValue,t=1}for(let s=t;s<e.animations.length;s++){const t=e.animations[s],n=t.weight/i;n&&(t.currentValue.scaleAndAddToRef?t.currentValue.scaleAndAddToRef(n,h):h+=t.currentValue*n)}for(let t=0;t<e.additiveAnimations.length;t++){const i=e.additiveAnimations[t],s=i.weight;s&&(i.currentValue.scaleAndAddToRef?i.currentValue.scaleAndAddToRef(s,h):h+=i.currentValue*s)}}}i[t]=h}i.RE={}}this.tv.reset()}},ze.prototype.copyAnimationRange=function(t,i,e,s=!1,n=null){0===this.animations.length&&(this.animations.push(new vt(this.name,"_matrix",t.animations[0].framePerSecond,vt.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const r=t.animations[0].getRange(i);if(!r)return!1;const h=r.from,o=r.to,a=t.animations[0].getKeys(),l=t.length,c=t.getParent(),u=this.getParent(),f=s&&c&&l&&this.length&&l!==this.length,d=f&&u&&c?u.length/c.length:1,p=s&&!u&&n&&(1!==n.x||1!==n.y||1!==n.z),m=this.animations[0].getKeys();let v,g,S;for(let t=0,i=a.length;t<i;t++)v=a[t],v.frame>=h&&v.frame<=o&&(s?(S=v.value.clone(),f?(g=S.getTranslation(),S.setTranslation(g.scaleInPlace(d))):p&&n?(g=S.getTranslation(),S.setTranslation(g.multiplyInPlace(n))):S=v.value):S=v.value,m.push({frame:v.frame+e,value:S}));return this.animations[0].createRange(i,h+e,o+e),!0};!function(t){t[t.CW=0]="CW",t[t.CCW=1]="CCW"}(Ve||(Ve={}));class Xe{constructor(t){this.bE=t,this.bE<0&&(this.bE+=2*Math.PI)}degrees(){return 180*this.bE/Math.PI}radians(){return this.bE}static BetweenTwoPoints(t,i){const e=i.subtract(t),s=Math.atan2(e.y,e.x);return new Xe(s)}static FromRadians(t){return new Xe(t)}static FromDegrees(t){return new Xe(t*Math.PI/180)}}class We{constructor(t,i,e){this.startPoint=t,this.midPoint=i,this.endPoint=e;const s=Math.pow(i.x,2)+Math.pow(i.y,2),n=(Math.pow(t.x,2)+Math.pow(t.y,2)-s)/2,r=(s-Math.pow(e.x,2)-Math.pow(e.y,2))/2,h=(t.x-i.x)*(i.y-e.y)-(i.x-e.x)*(t.y-i.y);this.centerPoint=new C((n*(i.y-e.y)-r*(t.y-i.y))/h,((t.x-i.x)*r-(i.x-e.x)*n)/h),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=Xe.BetweenTwoPoints(this.centerPoint,this.startPoint);const o=this.startAngle.degrees();let a=Xe.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),l=Xe.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();a-o>180&&(a-=360),a-o<-180&&(a+=360),l-a>180&&(l-=360),l-a<-180&&(l+=360),this.orientation=a-o<0?Ve.CW:Ve.CCW,this.angle=Xe.FromDegrees(this.orientation===Ve.CW?o-l:l-o)}}class $e{constructor(t,i){this._E=new Array,this.yE=0,this.closed=!1,this._E.push(new C(t,i))}addLineTo(t,i){if(this.closed)return this;const e=new C(t,i),s=this._E[this._E.length-1];return this._E.push(e),this.yE+=e.subtract(s).length(),this}addArcTo(t,i,e,s,n=36){if(this.closed)return this;const r=this._E[this._E.length-1],h=new C(t,i),o=new C(e,s),a=new We(r,h,o);let l=a.angle.radians()/n;a.orientation===Ve.CW&&(l*=-1);let c=a.startAngle.radians()+l;for(let t=0;t<n;t++){const t=Math.cos(c)*a.radius+a.centerPoint.x,i=Math.sin(c)*a.radius+a.centerPoint.y;this.addLineTo(t,i),c+=l}return this}close(){return this.closed=!0,this}length(){let t=this.yE;if(this.closed){const i=this._E[this._E.length-1];t+=this._E[0].subtract(i).length()}return t}getPoints(){return this._E}getPointAtLengthPosition(t){if(t<0||t>1)return C.Zero();const i=t*this.length();let e=0;for(let t=0;t<this._E.length;t++){const s=(t+1)%this._E.length,n=this._E[t],r=this._E[s].subtract(n),h=r.length()+e;if(i>=e&&i<=h){const t=r.normalize(),s=i-e;return new C(n.x+t.x*s,n.y+t.y*s)}e=h}return C.Zero()}static StartingAt(t,i){return new $e(t,i)}}class Ye{constructor(t,i=null,e,s=!1){this.path=t,this.NE=new Array,this.PE=new Array,this.DE=new Array,this.Ll=new Array,this.LE=new Array,this.OE={id:0,point:w.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:R.Identity()};for(let i=0;i<t.length;i++)this.NE[i]=t[i].clone();this.FE=e||!1,this.BE=s,this.UE(i,s)}getCurve(){return this.NE}getPoints(){return this.NE}length(){return this.PE[this.PE.length-1]}getTangents(){return this.DE}getNormals(){return this.Ll}getBinormals(){return this.LE}getDistances(){return this.PE}getPointAt(t){return this.VE(t).point}getTangentAt(t,i=!1){return this.VE(t,i),i?w.TransformCoordinates(w.Forward(),this.OE.interpolationMatrix):this.DE[this.OE.previousPointArrayIndex]}getNormalAt(t,i=!1){return this.VE(t,i),i?w.TransformCoordinates(w.Right(),this.OE.interpolationMatrix):this.Ll[this.OE.previousPointArrayIndex]}getBinormalAt(t,i=!1){return this.VE(t,i),i?w.TransformCoordinates(w.UpReadOnly,this.OE.interpolationMatrix):this.LE[this.OE.previousPointArrayIndex]}getDistanceAt(t){return this.length()*t}getPreviousPointIndexAt(t){return this.VE(t),this.OE.previousPointArrayIndex}getSubPositionAt(t){return this.VE(t),this.OE.subPosition}getClosestPositionTo(t){let i=Number.MAX_VALUE,e=0;for(let s=0;s<this.NE.length-1;s++){const n=this.NE[s+0],r=this.NE[s+1].subtract(n).normalize(),h=this.PE[s+1]-this.PE[s+0],o=Math.min(Math.max(w.Dot(r,t.subtract(n).normalize()),0)*w.Distance(n,t)/h,1),a=w.Distance(n.add(r.scale(o*h)),t);a<i&&(i=a,e=(this.PE[s+0]+h*o)/this.length())}return e}slice(t=0,i=1){if(t<0&&(t=1- -1*t%1),i<0&&(i=1- -1*i%1),t>i){const e=t;t=i,i=e}const e=this.getCurve(),s=this.getPointAt(t);let n=this.getPreviousPointIndexAt(t);const r=this.getPointAt(i),h=this.getPreviousPointIndexAt(i)+1,o=[];return 0!==t&&(n++,o.push(s)),o.push(...e.slice(n,h)),1===i&&1!==t||o.push(r),new Ye(o,this.getNormalAt(t),this.FE,this.BE)}update(t,i=null,e=!1){for(let i=0;i<t.length;i++)this.NE[i].x=t[i].x,this.NE[i].y=t[i].y,this.NE[i].z=t[i].z;return this.UE(i,e),this}UE(t,i=!1){const e=this.NE.length;if(e<2)return;this.DE[0]=this.kE(0),this.FE||this.DE[0].normalize(),this.DE[e-1]=this.NE[e-1].subtract(this.NE[e-2]),this.FE||this.DE[e-1].normalize();const s=this.DE[0],n=this.GE(s,t);let r,h,o,a,l;this.Ll[0]=n,this.FE||this.Ll[0].normalize(),this.LE[0]=w.Cross(s,this.Ll[0]),this.FE||this.LE[0].normalize(),this.PE[0]=0;for(let t=1;t<e;t++)r=this.zE(t),t<e-1&&(h=this.kE(t),this.DE[t]=i?h:r.add(h),this.DE[t].normalize()),this.PE[t]=this.PE[t-1]+this.NE[t].subtract(this.NE[t-1]).length(),o=this.DE[t],l=this.LE[t-1],this.Ll[t]=w.Cross(l,o),this.FE||(0===this.Ll[t].length()?(a=this.Ll[t-1],this.Ll[t]=a.clone()):this.Ll[t].normalize()),this.LE[t]=w.Cross(o,this.Ll[t]),this.FE||this.LE[t].normalize();this.OE.id=NaN}kE(t){let i=1,e=this.NE[t+i].subtract(this.NE[t]);for(;0===e.length()&&t+i+1<this.NE.length;)i++,e=this.NE[t+i].subtract(this.NE[t]);return e}zE(t){let i=1,e=this.NE[t].subtract(this.NE[t-i]);for(;0===e.length()&&t>i+1;)i++,e=this.NE[t].subtract(this.NE[t-i]);return e}GE(t,i){let e,s=t.length();if(0===s&&(s=1),null==i){let i;i=o.WithinEpsilon(Math.abs(t.y)/s,1,u)?o.WithinEpsilon(Math.abs(t.x)/s,1,u)?o.WithinEpsilon(Math.abs(t.z)/s,1,u)?w.Zero():new w(0,0,1):new w(1,0,0):new w(0,-1,0),e=w.Cross(t,i)}else e=w.Cross(t,i),w.CrossToRef(e,t,e);return e.normalize(),e}VE(t,i=!1){if(this.OE.id===t)return this.OE.interpolateReady||this.HE(),this.OE;this.OE.id=t;const e=this.getPoints();if(t<=0)return this.XE(0,0,e[0],0,i);if(t>=1)return this.XE(1,1,e[e.length-1],e.length-1,i);let s,n=e[0],r=0;const h=t*this.length();for(let o=1;o<e.length;o++){s=e[o];const a=w.Distance(n,s);if(r+=a,r===h)return this.XE(t,1,s,o,i);if(r>h){const e=(r-h)/a,l=n.subtract(s),c=s.add(l.scaleInPlace(e));return this.XE(t,1-e,c,o-1,i)}n=s}return this.OE}XE(t,i,e,s,n){return this.OE.point=e,this.OE.position=t,this.OE.subPosition=i,this.OE.previousPointArrayIndex=s,this.OE.interpolateReady=n,n&&this.HE(),this.OE}HE(){this.OE.interpolationMatrix=R.Identity();const t=this.OE.previousPointArrayIndex;if(t!==this.DE.length-1){const i=t+1,e=this.DE[t].clone(),s=this.Ll[t].clone(),n=this.LE[t].clone(),r=this.DE[i].clone(),h=this.Ll[i].clone(),o=this.LE[i].clone(),a=T.RotationQuaternionFromAxis(s,n,e),l=T.RotationQuaternionFromAxis(h,o,r);T.Slerp(a,l,this.OE.subPosition).toRotationMatrix(this.OE.interpolationMatrix)}}}class je{constructor(t){this.yE=0,this._E=t,this.yE=this.WE(t)}static CreateQuadraticBezier(t,i,e,s){s=s>2?s:3;const n=new Array,r=(t,i,e,s)=>(1-t)*(1-t)*i+2*t*(1-t)*e+t*t*s;for(let h=0;h<=s;h++)n.push(new w(r(h/s,t.x,i.x,e.x),r(h/s,t.y,i.y,e.y),r(h/s,t.z,i.z,e.z)));return new je(n)}static CreateCubicBezier(t,i,e,s,n){n=n>3?n:4;const r=new Array,h=(t,i,e,s,n)=>(1-t)*(1-t)*(1-t)*i+3*t*(1-t)*(1-t)*e+3*t*t*(1-t)*s+t*t*t*n;for(let o=0;o<=n;o++)r.push(new w(h(o/n,t.x,i.x,e.x,s.x),h(o/n,t.y,i.y,e.y,s.y),h(o/n,t.z,i.z,e.z,s.z)));return new je(r)}static CreateHermiteSpline(t,i,e,s,n){const r=new Array,h=1/n;for(let o=0;o<=n;o++)r.push(w.Hermite(t,i,e,s,o*h));return new je(r)}static CreateCatmullRomSpline(t,i,e){const s=new Array,n=1/i;let r=0;if(e){const e=t.length;for(let h=0;h<e;h++){r=0;for(let o=0;o<i;o++)s.push(w.CatmullRom(t[h%e],t[(h+1)%e],t[(h+2)%e],t[(h+3)%e],r)),r+=n}s.push(s[0])}else{const e=new Array;e.push(t[0].clone()),Array.prototype.push.apply(e,t),e.push(t[t.length-1].clone());let h=0;for(;h<e.length-3;h++){r=0;for(let t=0;t<i;t++)s.push(w.CatmullRom(e[h],e[h+1],e[h+2],e[h+3],r)),r+=n}h--,s.push(w.CatmullRom(e[h],e[h+1],e[h+2],e[h+3],r))}return new je(s)}static ArcThru3Points(t,i,e,s=32,n=!1,r=!1){const h=new Array,o=i.subtract(t),a=e.subtract(i),l=t.subtract(e),c=w.Cross(o,a),u=c.length();if(u<Math.pow(10,-8))return new je(h);const f=o.lengthSquared(),d=a.lengthSquared(),p=l.lengthSquared(),m=c.lengthSquared(),v=.5*o.length()*a.length()*l.length()/u,g=-.5*d*w.Dot(o,l)/m,S=-.5*p*w.Dot(o,a)/m,E=-.5*f*w.Dot(a,l)/m,A=t.scale(g).add(i.scale(S)).add(e.scale(E)),C=t.subtract(A).normalize(),x=w.Cross(c,C).normalize();if(r){const i=2*Math.PI/s;for(let t=0;t<=2*Math.PI;t+=i)h.push(A.add(C.scale(v*Math.cos(t)).add(x.scale(v*Math.sin(t)))));h.push(t)}else{const i=1/s;let r=0,o=w.Zero();do{o=A.add(C.scale(v*Math.cos(r)).add(x.scale(v*Math.sin(r)))),h.push(o),r+=i}while(!o.equalsWithEpsilon(e,v*i*1.1));h.push(e),n&&h.push(t)}return new je(h)}getPoints(){return this._E}length(){return this.yE}continue(t){const i=this._E[this._E.length-1],e=this._E.slice(),s=t.getPoints();for(let t=1;t<s.length;t++)e.push(s[t].subtract(s[0]).add(i));return new je(e)}WE(t){let i=0;for(let e=1;e<t.length;e++)i+=t[e].subtract(t[e-1]).length();return i}}class Ke{constructor(){this.$E=Ke.EASINGMODE_EASEIN}setEasingMode(t){const i=Math.min(Math.max(t,0),2);this.$E=i}getEasingMode(){return this.$E}easeInCore(t){throw new Error("You must implement this method")}ease(t){switch(this.$E){case Ke.EASINGMODE_EASEIN:return this.easeInCore(t);case Ke.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-t)}return t>=.5?.5*(1-this.easeInCore(2*(1-t)))+.5:.5*this.easeInCore(2*t)}}Ke.EASINGMODE_EASEIN=0,Ke.EASINGMODE_EASEOUT=1,Ke.EASINGMODE_EASEINOUT=2;class qe extends Ke{easeInCore(t){return t=Math.max(0,Math.min(1,t)),1-Math.sqrt(1-t*t)}}class Qe extends Ke{easeInCore(t){return t*t}}class Ze extends Ke{easeInCore(t){return 1-Math.sin(1.5707963267948966*(1-t))}}class Je{getClassName(){return"TargetedAnimation"}serialize(){const t={};return t.animation=this.animation.serialize(),t.targetId=this.target.id,t}}class ts{constructor(t,i=null){this.name=t,this.YE=new Array,this.jE=new Array,this.KE=Number.MAX_VALUE,this.qE=-Number.MAX_VALUE,this.EE=1,this.QE=!1,this.ZE=!1,this.Si=null,this.onAnimationEndObservable=new h,this.onAnimationLoopObservable=new h,this.onAnimationGroupLoopObservable=new h,this.onAnimationGroupEndObservable=new h,this.onAnimationGroupPauseObservable=new h,this.onAnimationGroupPlayObservable=new h,this.metadata=null,this.JE=[],this.Kt=i||E.LastCreatedScene,this.uniqueId=this.Kt.getUniqueId(),this.Kt.addAnimationGroup(this)}get from(){return this.KE}get to(){return this.qE}get isStarted(){return this.tA}get isPlaying(){return this.tA&&!this.iA}get speedRatio(){return this.EE}set speedRatio(t){if(this.EE!==t){this.EE=t;for(let t=0;t<this.jE.length;t++){this.jE[t].speedRatio=this.EE}}}get loopAnimation(){return this.QE}set loopAnimation(t){if(this.QE!==t){this.QE=t;for(let t=0;t<this.jE.length;t++){this.jE[t].loopAnimation=this.QE}}}get isAdditive(){return this.ZE}set isAdditive(t){if(this.ZE!==t){this.ZE=t;for(let t=0;t<this.jE.length;t++){this.jE[t].isAdditive=this.ZE}}}get targetedAnimations(){return this.YE}get animatables(){return this.jE}get children(){return this.YE}addTargetedAnimation(t,i){const e=new Je;e.animation=t,e.target=i;const s=t.getKeys();return this.KE>s[0].frame&&(this.KE=s[0].frame),this.qE<s[s.length-1].frame&&(this.qE=s[s.length-1].frame),this.YE.push(e),e}normalize(t=null,i=null){null==t&&(t=this.KE),null==i&&(i=this.qE);for(let e=0;e<this.YE.length;e++){const s=this.YE[e].animation.getKeys(),n=s[0],r=s[s.length-1];if(n.frame>t){const i={frame:t,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};s.splice(0,0,i)}if(r.frame<i){const t={frame:i,value:r.value,inTangent:r.inTangent,outTangent:r.outTangent,interpolation:r.interpolation};s.push(t)}}return this.KE=t,this.qE=i,this}eA(t,i,e){t.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(i),this.JE[e]||(this.JE[e]=!0,this.sA++,this.sA===this.YE.length&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this.sA=0,this.JE.length=0))}}start(t=!1,i=1,e,s,n){if(this.tA||0===this.YE.length)return this;this.QE=t,this.sA=0,this.JE.length=0;for(let r=0;r<this.YE.length;r++){const h=this.YE[r],o=this.Kt.beginDirectAnimation(h.target,[h.animation],void 0!==e?e:this.KE,void 0!==s?s:this.qE,t,i,void 0,void 0,void 0!==n?n:this.ZE);o.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(h),this.nA(o)},this.eA(o,h,r),this.jE.push(o)}return this.EE=i,this.tA=!0,this.iA=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this.tA)return this;this.iA=!0;for(let t=0;t<this.jE.length;t++){this.jE[t].pause()}return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(t){return this.isStarted&&this.jE.length===this.YE.length?(void 0!==t&&(this.loopAnimation=t),this.restart()):(this.stop(),this.start(t,this.EE)),this.iA=!1,this}reset(){if(!this.tA)return this.play(),this.goToFrame(0),this.stop(),this;for(let t=0;t<this.jE.length;t++){this.jE[t].reset()}return this}restart(){if(!this.tA)return this;for(let t=0;t<this.jE.length;t++){this.jE[t].restart()}return this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this.tA)return this;const t=this.jE.slice();for(let i=0;i<t.length;i++)t[i].stop();return this.tA=!1,this}setWeightForAllAnimatables(t){for(let i=0;i<this.jE.length;i++){this.jE[i].weight=t}return this}syncAllAnimationsWith(t){for(let i=0;i<this.jE.length;i++){this.jE[i].syncWith(t)}return this}goToFrame(t){if(!this.tA)return this;for(let i=0;i<this.jE.length;i++){this.jE[i].goToFrame(t)}return this}dispose(){this.YE.length=0,this.jE.length=0;const t=this.Kt.animationGroups.indexOf(this);if(t>-1&&this.Kt.animationGroups.splice(t,1),this.Si){const t=this.Si.animationGroups.indexOf(this);t>-1&&this.Si.animationGroups.splice(t,1),this.Si=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}nA(t){const i=this.jE.indexOf(t);i>-1&&this.jE.splice(i,1),0===this.jE.length&&(this.tA=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(t,i,e=!1){const s=new ts(t||this.name,this.Kt);for(const t of this.YE)s.addTargetedAnimation(e?t.animation.clone():t.animation,i?i(t.target):t.target);return s}serialize(){const t={};t.name=this.name,t.from=this.from,t.to=this.to,t.targetedAnimations=[];for(let i=0;i<this.targetedAnimations.length;i++){const e=this.targetedAnimations[i];t.targetedAnimations[i]=e.serialize()}return H&&H.HasTags(this)&&(t.tags=H.GetTags(this)),this.metadata&&(t.metadata=this.metadata),t}static Parse(t,i){const e=new ts(t.name,i);for(let s=0;s<t.targetedAnimations.length;s++){const n=t.targetedAnimations[s],r=vt.Parse(n.animation),h=n.targetId;if("influence"===n.animation.property){const t=i.getMorphTargetById(h);t&&e.addTargetedAnimation(r,t)}else{const t=i.getNodeById(h);null!=t&&e.addTargetedAnimation(r,t)}}return null!==t.from&&null!==t.to&&e.normalize(t.from,t.to),H&&H.AddTagsTo(e,t.tags),void 0!==t.metadata&&(e.metadata=t.metadata),e}static MakeAnimationAdditive(t,i=0,e,s=!1,n){let r=t;s&&(r=t.clone(n||r.name));const h=r.targetedAnimations;for(let t=0;t<h.length;t++){const s=h[t];vt.MakeAnimationAdditive(s.animation,i,e)}return r.isAdditive=!0,r}getClassName(){return"AnimationGroup"}toString(t){let i="Name: "+this.name;return i+=", type: "+this.getClassName(),t&&(i+=", from: "+this.KE,i+=", to: "+this.qE,i+=", isStarted: "+this.tA,i+=", speedRatio: "+this.EE,i+=", targetedAnimations length: "+this.YE.length,i+=", animatables length: "+this.jE),i}}function is(t,i,e){try{const s=t.next();s.done?i(s):s.value?s.value.then((()=>{s.value=void 0,i(s)}),e):i(s)}catch(t){e(t)}}function es(t,i,e,s,n){const r=()=>{let h;const o=t=>{t.done?e(t.value):void 0===h?h=!0:r()};do{h=void 0,n&&n.aborted?s(new Error("Aborted")):i(t,o,s),void 0===h&&(h=!1)}while(h)};r()}function ss(t,i){let e;return es(t,is,(t=>e=t),(t=>{throw t}),i),e}function ns(t,i,e){return new Promise(((s,n)=>{es(t,i,s,n,e)}))}class rs{constructor(t,i,e,s){this.x=t,this.y=i,this.width=e,this.height=s}toGlobal(t,i){return new rs(this.x*t,this.y*i,this.width*t,this.height*i)}toGlobalToRef(t,i,e){return e.x=this.x*t,e.y=this.y*i,e.width=this.width*t,e.height=this.height*i,this}clone(){return new rs(this.x,this.y,this.width,this.height)}}class hs extends dt{constructor(t,i,e,s=!0){super(t,e),this.rA=w.Zero(),this.hA=w.Up(),this.oA=null,this.aA=null,this.lA=null,this.cA=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this.uA=hs.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new rs(0,0,1,1),this.layerMask=268435455,this.fovMode=hs.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=hs.RIG_MODE_NONE,this.customRenderTargets=new Array,this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new h,this.onProjectionMatrixChangedObservable=new h,this.onAfterCheckInputsObservable=new h,this.onRestoreStateObservable=new h,this.isRigCamera=!1,this.uS=new Array,this.fA=R.Identity(),this.SS=!1,this.Ug=new R,this.vf=new Array,this.Iv=new zi(256),this.dA=w.Zero(),this.pA=R.Identity(),this.mA=!1,this.Ov=R.Zero(),this.vA=!0,this.gA=T.Identity(),this._t=!0,this.SA=!1,this.EA=!1,this.getScene().addCamera(this),s&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=i,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${t}`)}get position(){return this.rA}set position(t){this.rA=t}set upVector(t){this.hA=t}get upVector(){return this.hA}get screenArea(){var t,i,e,s;let n=0,r=0;if(this.mode===hs.PERSPECTIVE_CAMERA)this.fovMode===hs.FOVMODE_VERTICAL_FIXED?(r=2*this.minZ*Math.tan(this.fov/2),n=this.getEngine().getAspectRatio(this)*r):(n=2*this.minZ*Math.tan(this.fov/2),r=n/this.getEngine().getAspectRatio(this));else{const h=this.getEngine().getRenderWidth()/2,o=this.getEngine().getRenderHeight()/2;n=(null!==(t=this.orthoRight)&&void 0!==t?t:h)-(null!==(i=this.orthoLeft)&&void 0!==i?i:-h),r=(null!==(e=this.orthoTop)&&void 0!==e?e:o)-(null!==(s=this.orthoBottom)&&void 0!==s?s:-o)}return n*r}set orthoLeft(t){this.oA=t;for(const i of this.uS)i.orthoLeft=t}get orthoLeft(){return this.oA}set orthoRight(t){this.aA=t;for(const i of this.uS)i.orthoRight=t}get orthoRight(){return this.aA}set orthoBottom(t){this.lA=t;for(const i of this.uS)i.orthoBottom=t}get orthoBottom(){return this.lA}set orthoTop(t){this.cA=t;for(const i of this.uS)i.orthoTop=t}get orthoTop(){return this.cA}set mode(t){this.uA=t;for(const i of this.uS)i.mode=t}get mode(){return this.uA}storeState(){return this.AA=!0,this.CA=this.fov,this}wA(){return!!this.AA&&(this.fov=this.CA,!0)}restoreState(){return!!this.wA()&&(this.onRestoreStateObservable.notifyObservers(this),!0)}getClassName(){return"Camera"}toString(t){let i="Name: "+this.name;if(i+=", type: "+this.getClassName(),this.animations)for(let e=0;e<this.animations.length;e++)i+=", animation[0]: "+this.animations[e].toString(t);return i}applyVerticalCorrection(){const t=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this.Kt.useRightHandedSystem?-t.x:t.x}get globalPosition(){return this.dA}getActiveMeshes(){return this.Iv}isActiveMesh(t){return-1!==this.Iv.indexOf(t)}isReady(t=!1){if(t)for(const t of this.vf)if(t&&!t.isReady())return!1;return super.isReady(t)}Fi(){super.Fi(),this.Ii.position=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.Ii.upVector=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.Ii.mode=void 0,this.Ii.minZ=void 0,this.Ii.maxZ=void 0,this.Ii.fov=void 0,this.Ii.fovMode=void 0,this.Ii.aspectRatio=void 0,this.Ii.orthoLeft=void 0,this.Ii.orthoRight=void 0,this.Ii.orthoBottom=void 0,this.Ii.orthoTop=void 0,this.Ii.renderWidth=void 0,this.Ii.renderHeight=void 0}Hi(t){t||super.Hi(),this.Ii.position.copyFrom(this.position),this.Ii.upVector.copyFrom(this.upVector)}Wi(){return this.xA()&&this.TA()}xA(){return!!super.Wi()&&(this.Ii.position.equals(this.position)&&this.Ii.upVector.equals(this.upVector)&&this.isSynchronizedWithParent())}TA(){let t=this.Ii.mode===this.mode&&this.Ii.minZ===this.minZ&&this.Ii.maxZ===this.maxZ;if(!t)return!1;const i=this.getEngine();return t=this.mode===hs.PERSPECTIVE_CAMERA?this.Ii.fov===this.fov&&this.Ii.fovMode===this.fovMode&&this.Ii.aspectRatio===i.getAspectRatio(this)&&this.Ii.projectionPlaneTilt===this.projectionPlaneTilt:this.Ii.orthoLeft===this.orthoLeft&&this.Ii.orthoRight===this.orthoRight&&this.Ii.orthoBottom===this.orthoBottom&&this.Ii.orthoTop===this.orthoTop&&this.Ii.renderWidth===i.getRenderWidth()&&this.Ii.renderHeight===i.getRenderHeight(),t}attachControl(t,i){}detachControl(t){}update(){this.RA(),this.cameraRigMode!==hs.RIG_MODE_NONE&&this.IA()}RA(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this.uS}get rigPostProcess(){return this.MA}bA(){for(let t=0;t<this.vf.length;t++)if(null!==this.vf[t])return this.vf[t];return null}_A(){const t=this.bA();t&&t.markTextureDirty();for(let t=0,i=this.uS.length;t<i;t++){const i=this.uS[t],e=i.MA;if(e){"pass"===e.getEffectName()&&(i.isIntermediate=0===this.vf.length),i.vf=this.vf.slice(0).concat(e),e.markTextureDirty()}else i.vf=this.vf.slice(0)}}attachPostProcess(t,i=null){return!t.isReusable()&&this.vf.indexOf(t)>-1?(F.Error("You're trying to reuse a post process not defined as reusable."),0):(null==i||i<0?this.vf.push(t):null===this.vf[i]?this.vf[i]=t:this.vf.splice(i,0,t),this._A(),this.Kt.prePassRenderer&&this.Kt.prePassRenderer.markAsDirty(),this.vf.indexOf(t))}detachPostProcess(t){const i=this.vf.indexOf(t);-1!==i&&(this.vf[i]=null),this.Kt.prePassRenderer&&this.Kt.prePassRenderer.markAsDirty(),this._A()}getWorldMatrix(){return this.xA()||this.getViewMatrix(),this._i}yA(){return R.Identity()}getViewMatrix(t){return!t&&this.xA()||(this.updateCache(),this.pA=this.yA(),this.Ai=this.getScene().getRenderId(),this.wi++,this.vA=!0,this.NA&&this.NA.vrPreViewMatrix&&this.pA.multiplyToRef(this.NA.vrPreViewMatrix,this.pA),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this.pA.invertToRef(this._i)),this.pA}freezeProjectionMatrix(t){this.mA=!0,void 0!==t&&(this.Ug=t)}unfreezeProjectionMatrix(){this.mA=!1}getProjectionMatrix(t){var i,e,s,n,r,h,o,a;if(this.mA||!t&&this.TA())return this.Ug;this.Ii.mode=this.mode,this.Ii.minZ=this.minZ,this.Ii.maxZ=this.maxZ,this.vA=!0;const l=this.getEngine(),c=this.getScene(),u=l.useReverseDepthBuffer;if(this.mode===hs.PERSPECTIVE_CAMERA){let t;this.Ii.fov=this.fov,this.Ii.fovMode=this.fovMode,this.Ii.aspectRatio=l.getAspectRatio(this),this.Ii.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1),t=c.useRightHandedSystem?R.PerspectiveFovRHToRef:R.PerspectiveFovLHToRef,t(this.fov,l.getAspectRatio(this),u?this.maxZ:this.minZ,u?this.minZ:this.maxZ,this.Ug,this.fovMode===hs.FOVMODE_VERTICAL_FIXED,l.isNDCHalfZRange,this.projectionPlaneTilt,u)}else{const t=l.getRenderWidth()/2,f=l.getRenderHeight()/2;c.useRightHandedSystem?R.OrthoOffCenterRHToRef(null!==(i=this.orthoLeft)&&void 0!==i?i:-t,null!==(e=this.orthoRight)&&void 0!==e?e:t,null!==(s=this.orthoBottom)&&void 0!==s?s:-f,null!==(n=this.orthoTop)&&void 0!==n?n:f,u?this.maxZ:this.minZ,u?this.minZ:this.maxZ,this.Ug,l.isNDCHalfZRange):R.OrthoOffCenterLHToRef(null!==(r=this.orthoLeft)&&void 0!==r?r:-t,null!==(h=this.orthoRight)&&void 0!==h?h:t,null!==(o=this.orthoBottom)&&void 0!==o?o:-f,null!==(a=this.orthoTop)&&void 0!==a?a:f,u?this.maxZ:this.minZ,u?this.minZ:this.maxZ,this.Ug,l.isNDCHalfZRange),this.Ii.orthoLeft=this.orthoLeft,this.Ii.orthoRight=this.orthoRight,this.Ii.orthoBottom=this.orthoBottom,this.Ii.orthoTop=this.orthoTop,this.Ii.renderWidth=l.getRenderWidth(),this.Ii.renderHeight=l.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this.Ug}getTransformationMatrix(){return this.pA.multiplyToRef(this.Ug,this.Ov),this.Ov}PA(){this.vA&&(this.getTransformationMatrix(),this.Xf?De.GetPlanesToRef(this.Ov,this.Xf):this.Xf=De.GetPlanes(this.Ov),this.vA=!1)}isInFrustum(t,i=!1){if(this.PA(),i&&this.rigCameras.length>0){let i=!1;return this.rigCameras.forEach((e=>{e.PA(),i=i||t.isInFrustum(e.Xf)})),i}return t.isInFrustum(this.Xf)}isCompletelyInFrustum(t){return this.PA(),t.isCompletelyInFrustum(this.Xf)}getForwardRay(t=100,i,e){throw X("Ray")}getForwardRayToRef(t,i=100,e,s){throw X("Ray")}dispose(t,i=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this.uS.length>0;){const t=this.uS.pop();t&&t.dispose()}if(this.Si){const t=this.Si.cameras.indexOf(this);t>-1&&this.Si.cameras.splice(t,1),this.Si=null}if(this.MA)this.MA.dispose(this),this.MA=null,this.vf.length=0;else if(this.cameraRigMode!==hs.RIG_MODE_NONE)this.MA=null,this.vf.length=0;else{let t=this.vf.length;for(;--t>=0;){const i=this.vf[t];i&&i.dispose(this)}}let e=this.customRenderTargets.length;for(;--e>=0;)this.customRenderTargets[e].dispose();this.customRenderTargets.length=0,this.Iv.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(t,i)}get isLeftCamera(){return this.SA}get isRightCamera(){return this.EA}get leftCamera(){return this.uS.length<1?null:this.uS[0]}get rightCamera(){return this.uS.length<2?null:this.uS[1]}getLeftTarget(){return this.uS.length<1?null:this.uS[0].getTarget()}getRightTarget(){return this.uS.length<2?null:this.uS[1].getTarget()}setCameraRigMode(t,i){if(this.cameraRigMode!==t){for(;this.uS.length>0;){const t=this.uS.pop();t&&t.dispose()}if(this.cameraRigMode=t,this.NA={},this.NA.interaxialDistance=i.interaxialDistance||.0637,this.NA.stereoHalfAngle=ki.ToRadians(this.NA.interaxialDistance/.0637),this.cameraRigMode!==hs.RIG_MODE_NONE){const t=this.createRigCamera(this.name+"_L",0);t&&(t.SA=!0);const i=this.createRigCamera(this.name+"_R",1);i&&(i.EA=!0),t&&i&&(this.uS.push(t),this.uS.push(i))}this.DA(i),this._A(),this.update()}}DA(t){}LA(){return R.PerspectiveFovLHToRef(this.NA.vrMetrics.aspectRatioFov,this.NA.vrMetrics.aspectRatio,this.minZ,this.maxZ,this.NA.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this.NA.vrWorkMatrix.multiplyToRef(this.NA.vrHMatrix,this.Ug),this.Ug}OA(){}FA(){}BA(){return R.Identity()}UA(){return R.Identity()}setCameraRigParameter(t,i){this.NA||(this.NA={}),this.NA[t]=i,"interaxialDistance"===t&&(this.NA.stereoHalfAngle=ki.ToRadians(i/.0637))}createRigCamera(t,i){return null}IA(){for(let t=0;t<this.uS.length;t++)this.uS[t].minZ=this.minZ,this.uS[t].maxZ=this.maxZ,this.uS[t].fov=this.fov,this.uS[t].upVector.copyFrom(this.upVector);this.cameraRigMode===hs.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this.uS[0].viewport=this.uS[1].viewport=this.viewport)}VA(){}serialize(){const t=ot.Serialize(this);return t.uniqueId=this.uniqueId,t.type=this.getClassName(),this.parent&&this.parent.Gi(t),this.inputs&&this.inputs.serialize(t),ot.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.isEnabled=this.isEnabled(),t}clone(t,i=null){const e=ot.Clone(hs.GetConstructorFromName(this.getClassName(),t,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return e.name=t,e.parent=i,this.onClonedObservable.notifyObservers(e),e}getDirection(t){const i=w.Zero();return this.getDirectionToRef(t,i),i}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this.gA),this.gA}getDirectionToRef(t,i){w.TransformNormalToRef(t,this.getWorldMatrix(),i)}static GetConstructorFromName(t,i,e,s=0,n=!0){const r=dt.Construct(t,i,e,{interaxial_distance:s,isStereoscopicSideBySide:n});return r||(()=>hs.kA(i,e))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(t,i){const e=t.type,s=hs.GetConstructorFromName(e,t.name,i,t.interaxial_distance,t.isStereoscopicSideBySide),n=ot.Parse(s,t,i);if(void 0!==t.parentId&&(n.xi=t.parentId),void 0!==t.parentInstanceIndex&&(n.Ti=t.parentInstanceIndex),n.inputs&&(n.inputs.parse(t),n.VA()),t.upVector&&(n.upVector=w.FromArray(t.upVector)),n.setPosition&&(n.position.copyFromFloats(0,0,0),n.setPosition(w.FromArray(t.position))),t.target&&n.setTarget&&n.setTarget(w.FromArray(t.target)),t.cameraRigMode){const i=t.interaxial_distance?{interaxialDistance:t.interaxial_distance}:{};n.setCameraRigMode(t.cameraRigMode,i)}if(t.animations){for(let i=0;i<t.animations.length;i++){const e=t.animations[i],s=g("BABYLON.Animation");s&&n.animations.push(s.Parse(e))}dt.ParseAnimationRanges(n,t,i)}return t.autoAnimate&&i.beginAnimation(n,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),void 0!==t.isEnabled&&n.setEnabled(t.isEnabled),n}}hs.kA=(t,i)=>{throw X("UniversalCamera")},hs.PERSPECTIVE_CAMERA=0,hs.ORTHOGRAPHIC_CAMERA=1,hs.FOVMODE_VERTICAL_FIXED=0,hs.FOVMODE_HORIZONTAL_FIXED=1,hs.RIG_MODE_NONE=0,hs.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,hs.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,hs.RIG_MODE_STEREOSCOPIC_INTERLACED=14,hs.RIG_MODE_VR=20,hs.RIG_MODE_WEBVR=21,hs.RIG_MODE_CUSTOM=22,hs.ForceAttachControlToAlwaysPreventDefault=!1,ut([et("position")],hs.prototype,"_position",void 0),ut([et("upVector")],hs.prototype,"_upVector",void 0),ut([Q()],hs.prototype,"orthoLeft",null),ut([Q()],hs.prototype,"orthoRight",null),ut([Q()],hs.prototype,"orthoBottom",null),ut([Q()],hs.prototype,"orthoTop",null),ut([Q()],hs.prototype,"fov",void 0),ut([Q()],hs.prototype,"projectionPlaneTilt",void 0),ut([Q()],hs.prototype,"minZ",void 0),ut([Q()],hs.prototype,"maxZ",void 0),ut([Q()],hs.prototype,"inertia",void 0),ut([Q()],hs.prototype,"mode",null),ut([Q()],hs.prototype,"layerMask",void 0),ut([Q()],hs.prototype,"fovMode",void 0),ut([Q()],hs.prototype,"cameraRigMode",void 0),ut([Q()],hs.prototype,"interaxialDistance",void 0),ut([Q()],hs.prototype,"isStereoscopicSideBySide",void 0);class os{constructor(){var t,i;this.GA=(t=this.zA.bind(this),(...e)=>ss(t(...e),i))}set(t,i){switch(t.length||F.Warn(`Setting vertex data kind '${i}' with an empty array`),i){case he.PositionKind:this.positions=t;break;case he.NormalKind:this.normals=t;break;case he.TangentKind:this.tangents=t;break;case he.UVKind:this.uvs=t;break;case he.UV2Kind:this.uvs2=t;break;case he.UV3Kind:this.uvs3=t;break;case he.UV4Kind:this.uvs4=t;break;case he.UV5Kind:this.uvs5=t;break;case he.UV6Kind:this.uvs6=t;break;case he.ColorKind:this.colors=t;break;case he.MatricesIndicesKind:this.matricesIndices=t;break;case he.MatricesWeightsKind:this.matricesWeights=t;break;case he.MatricesIndicesExtraKind:this.matricesIndicesExtra=t;break;case he.MatricesWeightsExtraKind:this.matricesWeightsExtra=t}}applyToMesh(t,i){return this.GA(t,i,!1),this}applyToGeometry(t,i){return this.GA(t,i,!1),this}updateMesh(t){return this.HA(t),this}updateGeometry(t){return this.HA(t),this}*zA(t,i=!1,e){return this.positions&&(t.setVerticesData(he.PositionKind,this.positions,i),e&&(yield)),this.normals&&(t.setVerticesData(he.NormalKind,this.normals,i),e&&(yield)),this.tangents&&(t.setVerticesData(he.TangentKind,this.tangents,i),e&&(yield)),this.uvs&&(t.setVerticesData(he.UVKind,this.uvs,i),e&&(yield)),this.uvs2&&(t.setVerticesData(he.UV2Kind,this.uvs2,i),e&&(yield)),this.uvs3&&(t.setVerticesData(he.UV3Kind,this.uvs3,i),e&&(yield)),this.uvs4&&(t.setVerticesData(he.UV4Kind,this.uvs4,i),e&&(yield)),this.uvs5&&(t.setVerticesData(he.UV5Kind,this.uvs5,i),e&&(yield)),this.uvs6&&(t.setVerticesData(he.UV6Kind,this.uvs6,i),e&&(yield)),this.colors&&(t.setVerticesData(he.ColorKind,this.colors,i),e&&(yield)),this.matricesIndices&&(t.setVerticesData(he.MatricesIndicesKind,this.matricesIndices,i),e&&(yield)),this.matricesWeights&&(t.setVerticesData(he.MatricesWeightsKind,this.matricesWeights,i),e&&(yield)),this.matricesIndicesExtra&&(t.setVerticesData(he.MatricesIndicesExtraKind,this.matricesIndicesExtra,i),e&&(yield)),this.matricesWeightsExtra&&(t.setVerticesData(he.MatricesWeightsExtraKind,this.matricesWeightsExtra,i),e&&(yield)),this.indices?(t.setIndices(this.indices,null,i),e&&(yield)):t.setIndices([],null),this}HA(t,i,e){return this.positions&&t.updateVerticesData(he.PositionKind,this.positions,i,e),this.normals&&t.updateVerticesData(he.NormalKind,this.normals,i,e),this.tangents&&t.updateVerticesData(he.TangentKind,this.tangents,i,e),this.uvs&&t.updateVerticesData(he.UVKind,this.uvs,i,e),this.uvs2&&t.updateVerticesData(he.UV2Kind,this.uvs2,i,e),this.uvs3&&t.updateVerticesData(he.UV3Kind,this.uvs3,i,e),this.uvs4&&t.updateVerticesData(he.UV4Kind,this.uvs4,i,e),this.uvs5&&t.updateVerticesData(he.UV5Kind,this.uvs5,i,e),this.uvs6&&t.updateVerticesData(he.UV6Kind,this.uvs6,i,e),this.colors&&t.updateVerticesData(he.ColorKind,this.colors,i,e),this.matricesIndices&&t.updateVerticesData(he.MatricesIndicesKind,this.matricesIndices,i,e),this.matricesWeights&&t.updateVerticesData(he.MatricesWeightsKind,this.matricesWeights,i,e),this.matricesIndicesExtra&&t.updateVerticesData(he.MatricesIndicesExtraKind,this.matricesIndicesExtra,i,e),this.matricesWeightsExtra&&t.updateVerticesData(he.MatricesWeightsExtraKind,this.matricesWeightsExtra,i,e),this.indices&&t.setIndices(this.indices,null),this}static XA(t,i,e=0,s=t.length){const n=M.Vector3[0],r=M.Vector3[1];for(let h=e;h<e+s;h+=3)w.FromArrayToRef(t,h,n),w.TransformCoordinatesToRef(n,i,r),t[h]=r.x,t[h+1]=r.y,t[h+2]=r.z}static WA(t,i,e=0,s=t.length){const n=M.Vector3[0],r=M.Vector3[1];for(let h=e;h<e+s;h+=3)w.FromArrayToRef(t,h,n),w.TransformNormalToRef(n,i,r),t[h]=r.x,t[h+1]=r.y,t[h+2]=r.z}static $A(t,i,e=0,s=t.length){const n=M.Vector4[0],r=M.Vector4[1];for(let h=e;h<e+s;h+=4)x.FromArrayToRef(t,h,n),x.TransformNormalToRef(n,i,r),t[h]=r.x,t[h+1]=r.y,t[h+2]=r.z,t[h+3]=r.w}static YA(t,i=0,e=t.length){for(let s=i;s<i+e;s+=3){const i=t[s+1];t[s+1]=t[s+2],t[s+2]=i}}transform(t){const i=t.determinant()<0;return this.positions&&os.XA(this.positions,t),this.normals&&os.WA(this.normals,t),this.tangents&&os.$A(this.tangents,t),i&&this.indices&&os.YA(this.indices),this}merge(t,i=!1,e=!1){const s=Array.isArray(t)?t.map((t=>[t,void 0])):[[t,void 0]];return ss(this.jA(void 0,s,i,!1,e))}*jA(t,i,e=!1,s,n){var r,h,o,a;this.KA();const l=i.map((t=>t[0]));for(const t of l)if(t.KA(),!this.normals!=!t.normals||!this.tangents!=!t.tangents||!this.uvs!=!t.uvs||!this.uvs2!=!t.uvs2||!this.uvs3!=!t.uvs3||!this.uvs4!=!t.uvs4||!this.uvs5!=!t.uvs5||!this.uvs6!=!t.uvs6||!this.colors!=!t.colors||!this.matricesIndices!=!t.matricesIndices||!this.matricesWeights!=!t.matricesWeights||!this.matricesIndicesExtra!=!t.matricesIndicesExtra||!this.matricesWeightsExtra!=!t.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");const c=l.reduce(((t,i)=>{var e,s;return t+(null!==(s=null===(e=i.indices)||void 0===e?void 0:e.length)&&void 0!==s?s:0)}),null!==(h=null===(r=this.indices)||void 0===r?void 0:r.length)&&void 0!==h?h:0);let u=n||l.some((t=>t.indices===this.indices))?null===(o=this.indices)||void 0===o?void 0:o.slice():this.indices;if(c>0){let n=null!==(a=null==u?void 0:u.length)&&void 0!==a?a:0;if(u||(u=new Array(c)),u.length!==c){if(Array.isArray(u))u.length=c;else{const t=e||u instanceof Uint32Array?new Uint32Array(c):new Uint16Array(c);t.set(u),u=t}t&&t.determinant()<0&&os.YA(u,0,n)}let r=this.positions?this.positions.length/3:0;for(const[t,e]of i)if(t.indices){for(let i=0;i<t.indices.length;i++)u[n+i]=t.indices[i]+r;e&&e.determinant()<0&&os.YA(u,n,t.indices.length),r+=t.positions.length/3,n+=t.indices.length,s&&(yield)}}return this.indices=u,this.positions=os.qA(he.PositionKind,this.positions,t,i.map((t=>[t[0].positions,t[1]]))),s&&(yield),this.normals=os.qA(he.NormalKind,this.normals,t,i.map((t=>[t[0].normals,t[1]]))),s&&(yield),this.tangents=os.qA(he.TangentKind,this.tangents,t,i.map((t=>[t[0].tangents,t[1]]))),s&&(yield),this.uvs=os.qA(he.UVKind,this.uvs,t,i.map((t=>[t[0].uvs,t[1]]))),s&&(yield),this.uvs2=os.qA(he.UV2Kind,this.uvs2,t,i.map((t=>[t[0].uvs2,t[1]]))),s&&(yield),this.uvs3=os.qA(he.UV3Kind,this.uvs3,t,i.map((t=>[t[0].uvs3,t[1]]))),s&&(yield),this.uvs4=os.qA(he.UV4Kind,this.uvs4,t,i.map((t=>[t[0].uvs4,t[1]]))),s&&(yield),this.uvs5=os.qA(he.UV5Kind,this.uvs5,t,i.map((t=>[t[0].uvs5,t[1]]))),s&&(yield),this.uvs6=os.qA(he.UV6Kind,this.uvs6,t,i.map((t=>[t[0].uvs6,t[1]]))),s&&(yield),this.colors=os.qA(he.ColorKind,this.colors,t,i.map((t=>[t[0].colors,t[1]]))),s&&(yield),this.matricesIndices=os.qA(he.MatricesIndicesKind,this.matricesIndices,t,i.map((t=>[t[0].matricesIndices,t[1]]))),s&&(yield),this.matricesWeights=os.qA(he.MatricesWeightsKind,this.matricesWeights,t,i.map((t=>[t[0].matricesWeights,t[1]]))),s&&(yield),this.matricesIndicesExtra=os.qA(he.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i.map((t=>[t[0].matricesIndicesExtra,t[1]]))),s&&(yield),this.matricesWeightsExtra=os.qA(he.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i.map((t=>[t[0].matricesWeightsExtra,t[1]]))),this}static qA(t,i,e,s){const n=s.filter((t=>null!==t[0]&&void 0!==t[0]));if(!i&&0==n.length)return i;if(!i)return this.qA(t,n[0][0],n[0][1],n.slice(1));const r=n.reduce(((t,i)=>t+i[0].length),i.length),h=t===he.PositionKind?os.XA:t===he.NormalKind?os.WA:t===he.TangentKind?os.$A:()=>{};if(i instanceof Float32Array){const t=new Float32Array(r);t.set(i),e&&h(t,e,0,i.length);let s=i.length;for(const[i,e]of n)t.set(i,s),e&&h(t,e,s,i.length),s+=i.length;return t}{const t=new Array(r);for(let e=0;e<i.length;e++)t[e]=i[e];e&&h(t,e,0,i.length);let s=i.length;for(const[i,e]of n){for(let e=0;e<i.length;e++)t[s+e]=i[e];e&&h(t,e,s,i.length),s+=i.length}return t}}KA(){if(!this.positions)throw new Bt("Positions are required",Nt);const t=(t,i)=>{const e=he.DeduceStride(t);if(i.length%e!=0)throw new Error("The "+t+"s array count must be a multiple of "+e);return i.length/e},i=t(he.PositionKind,this.positions),e=(e,s)=>{const n=t(e,s);if(n!==i)throw new Error("The "+e+"s element count ("+n+") does not match the positions count ("+i+")")};this.normals&&e(he.NormalKind,this.normals),this.tangents&&e(he.TangentKind,this.tangents),this.uvs&&e(he.UVKind,this.uvs),this.uvs2&&e(he.UV2Kind,this.uvs2),this.uvs3&&e(he.UV3Kind,this.uvs3),this.uvs4&&e(he.UV4Kind,this.uvs4),this.uvs5&&e(he.UV5Kind,this.uvs5),this.uvs6&&e(he.UV6Kind,this.uvs6),this.colors&&e(he.ColorKind,this.colors),this.matricesIndices&&e(he.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&e(he.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&e(he.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&e(he.MatricesWeightsExtraKind,this.matricesWeightsExtra)}serialize(){const t={};return this.positions&&(t.positions=this.positions),this.normals&&(t.normals=this.normals),this.tangents&&(t.tangents=this.tangents),this.uvs&&(t.uvs=this.uvs),this.uvs2&&(t.uvs2=this.uvs2),this.uvs3&&(t.uvs3=this.uvs3),this.uvs4&&(t.uvs4=this.uvs4),this.uvs5&&(t.uvs5=this.uvs5),this.uvs6&&(t.uvs6=this.uvs6),this.colors&&(t.colors=this.colors),this.matricesIndices&&(t.matricesIndices=this.matricesIndices,t.matricesIndices.QA=!0),this.matricesWeights&&(t.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(t.matricesIndicesExtra=this.matricesIndicesExtra,t.matricesIndicesExtra.QA=!0),this.matricesWeightsExtra&&(t.matricesWeightsExtra=this.matricesWeightsExtra),t.indices=this.indices,t}static ExtractFromMesh(t,i,e){return os.ZA(t,i,e)}static ExtractFromGeometry(t,i,e){return os.ZA(t,i,e)}static ZA(t,i,e){const s=new os;return t.isVerticesDataPresent(he.PositionKind)&&(s.positions=t.getVerticesData(he.PositionKind,i,e)),t.isVerticesDataPresent(he.NormalKind)&&(s.normals=t.getVerticesData(he.NormalKind,i,e)),t.isVerticesDataPresent(he.TangentKind)&&(s.tangents=t.getVerticesData(he.TangentKind,i,e)),t.isVerticesDataPresent(he.UVKind)&&(s.uvs=t.getVerticesData(he.UVKind,i,e)),t.isVerticesDataPresent(he.UV2Kind)&&(s.uvs2=t.getVerticesData(he.UV2Kind,i,e)),t.isVerticesDataPresent(he.UV3Kind)&&(s.uvs3=t.getVerticesData(he.UV3Kind,i,e)),t.isVerticesDataPresent(he.UV4Kind)&&(s.uvs4=t.getVerticesData(he.UV4Kind,i,e)),t.isVerticesDataPresent(he.UV5Kind)&&(s.uvs5=t.getVerticesData(he.UV5Kind,i,e)),t.isVerticesDataPresent(he.UV6Kind)&&(s.uvs6=t.getVerticesData(he.UV6Kind,i,e)),t.isVerticesDataPresent(he.ColorKind)&&(s.colors=t.getVerticesData(he.ColorKind,i,e)),t.isVerticesDataPresent(he.MatricesIndicesKind)&&(s.matricesIndices=t.getVerticesData(he.MatricesIndicesKind,i,e)),t.isVerticesDataPresent(he.MatricesWeightsKind)&&(s.matricesWeights=t.getVerticesData(he.MatricesWeightsKind,i,e)),t.isVerticesDataPresent(he.MatricesIndicesExtraKind)&&(s.matricesIndicesExtra=t.getVerticesData(he.MatricesIndicesExtraKind,i,e)),t.isVerticesDataPresent(he.MatricesWeightsExtraKind)&&(s.matricesWeightsExtra=t.getVerticesData(he.MatricesWeightsExtraKind,i,e)),s.indices=t.getIndices(i,e),s}static CreateRibbon(t){throw X("ribbonBuilder")}static CreateBox(t){throw X("boxBuilder")}static CreateTiledBox(t){throw X("tiledBoxBuilder")}static CreateTiledPlane(t){throw X("tiledPlaneBuilder")}static CreateSphere(t){throw X("sphereBuilder")}static CreateCylinder(t){throw X("cylinderBuilder")}static CreateTorus(t){throw X("torusBuilder")}static CreateLineSystem(t){throw X("linesBuilder")}static CreateDashedLines(t){throw X("linesBuilder")}static CreateGround(t){throw X("groundBuilder")}static CreateTiledGround(t){throw X("groundBuilder")}static CreateGroundFromHeightMap(t){throw X("groundBuilder")}static CreatePlane(t){throw X("planeBuilder")}static CreateDisc(t){throw X("discBuilder")}static CreatePolygon(t,i,e,s,n,r,h){throw X("polygonBuilder")}static CreateIcoSphere(t){throw X("icoSphereBuilder")}static CreatePolyhedron(t){throw X("polyhedronBuilder")}static CreateCapsule(t={orientation:w.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw X("capsuleBuilder")}static CreateTorusKnot(t){throw X("torusKnotBuilder")}static ComputeNormals(t,i,e,s){let n=0,r=0,h=0,o=0,a=0,l=0,c=0,u=0,f=0,d=0,p=0,m=0,v=0,g=0,S=0,E=0,A=0,C=0,x=0,T=0,R=!1,I=!1,M=!1,b=!1,_=1,y=0,N=null;s&&(R=!!s.facetNormals,I=!!s.facetPositions,M=!!s.facetPartitioning,_=!0===s.useRightHandedSystem?-1:1,y=s.ratio||0,b=!!s.depthSort,N=s.distanceTo,b&&void 0===N&&(N=w.Zero()));let P=0,D=0,L=0,O=0;for(M&&s&&s.bbSize&&(P=s.subDiv.X*y/s.bbSize.x,D=s.subDiv.Y*y/s.bbSize.y,L=s.subDiv.Z*y/s.bbSize.z,O=s.subDiv.max*s.subDiv.max,s.facetPartitioning.length=0),n=0;n<t.length;n++)e[n]=0;const F=i.length/3|0;for(n=0;n<F;n++){if(m=3*i[3*n],v=m+1,g=m+2,S=3*i[3*n+1],E=S+1,A=S+2,C=3*i[3*n+2],x=C+1,T=C+2,r=t[m]-t[S],h=t[v]-t[E],o=t[g]-t[A],a=t[C]-t[S],l=t[x]-t[E],c=t[T]-t[A],u=_*(h*c-o*l),f=_*(o*a-r*c),d=_*(r*l-h*a),p=Math.sqrt(u*u+f*f+d*d),p=0===p?1:p,u/=p,f/=p,d/=p,R&&s&&(s.facetNormals[n].x=u,s.facetNormals[n].y=f,s.facetNormals[n].z=d),I&&s&&(s.facetPositions[n].x=(t[m]+t[S]+t[C])/3,s.facetPositions[n].y=(t[v]+t[E]+t[x])/3,s.facetPositions[n].z=(t[g]+t[A]+t[T])/3),M&&s){const i=Math.floor((s.facetPositions[n].x-s.bInfo.minimum.x*y)*P),e=Math.floor((s.facetPositions[n].y-s.bInfo.minimum.y*y)*D),r=Math.floor((s.facetPositions[n].z-s.bInfo.minimum.z*y)*L),h=Math.floor((t[m]-s.bInfo.minimum.x*y)*P),o=Math.floor((t[v]-s.bInfo.minimum.y*y)*D),a=Math.floor((t[g]-s.bInfo.minimum.z*y)*L),l=Math.floor((t[S]-s.bInfo.minimum.x*y)*P),c=Math.floor((t[E]-s.bInfo.minimum.y*y)*D),u=Math.floor((t[A]-s.bInfo.minimum.z*y)*L),f=Math.floor((t[C]-s.bInfo.minimum.x*y)*P),d=Math.floor((t[x]-s.bInfo.minimum.y*y)*D),p=Math.floor((t[T]-s.bInfo.minimum.z*y)*L),w=h+s.subDiv.max*o+O*a,R=l+s.subDiv.max*c+O*u,I=f+s.subDiv.max*d+O*p,M=i+s.subDiv.max*e+O*r;s.facetPartitioning[M]=s.facetPartitioning[M]?s.facetPartitioning[M]:new Array,s.facetPartitioning[w]=s.facetPartitioning[w]?s.facetPartitioning[w]:new Array,s.facetPartitioning[R]=s.facetPartitioning[R]?s.facetPartitioning[R]:new Array,s.facetPartitioning[I]=s.facetPartitioning[I]?s.facetPartitioning[I]:new Array,s.facetPartitioning[w].push(n),R!=w&&s.facetPartitioning[R].push(n),I!=R&&I!=w&&s.facetPartitioning[I].push(n),M!=w&&M!=R&&M!=I&&s.facetPartitioning[M].push(n)}if(b&&s&&s.facetPositions){const t=s.depthSortedFacets[n];t.ind=3*n,t.sqDistance=w.DistanceSquared(s.facetPositions[n],N)}e[m]+=u,e[v]+=f,e[g]+=d,e[S]+=u,e[E]+=f,e[A]+=d,e[C]+=u,e[x]+=f,e[T]+=d}for(n=0;n<e.length/3;n++)u=e[3*n],f=e[3*n+1],d=e[3*n+2],p=Math.sqrt(u*u+f*f+d*d),p=0===p?1:p,u/=p,f/=p,d/=p,e[3*n]=u,e[3*n+1]=f,e[3*n+2]=d}static JA(t,i,e,s,n,r,h){const o=e.length,a=s.length;let l,c;switch(t=t||os.DEFAULTSIDE){case os.FRONTSIDE:break;case os.BACKSIDE:for(l=0;l<o;l+=3){const t=e[l];e[l]=e[l+2],e[l+2]=t}for(c=0;c<a;c++)s[c]=-s[c];break;case os.DOUBLESIDE:{const t=i.length,u=t/3;for(let e=0;e<t;e++)i[t+e]=i[e];for(l=0;l<o;l+=3)e[l+o]=e[l+2]+u,e[l+1+o]=e[l+1]+u,e[l+2+o]=e[l]+u;for(c=0;c<a;c++)s[a+c]=-s[c];const f=n.length;let d=0;for(d=0;d<f;d++)n[d+f]=n[d];for(r=r||new x(0,0,1,1),h=h||new x(0,0,1,1),d=0,l=0;l<f/2;l++)n[d]=r.x+(r.z-r.x)*n[d],n[d+1]=r.y+(r.w-r.y)*n[d+1],n[d+f]=h.x+(h.z-h.x)*n[d+f],n[d+f+1]=h.y+(h.w-h.y)*n[d+f+1],d+=2;break}}}static ImportVertexData(t,i){const e=new os,s=t.positions;s&&e.set(s,he.PositionKind);const n=t.normals;n&&e.set(n,he.NormalKind);const r=t.tangents;r&&e.set(r,he.TangentKind);const h=t.uvs;h&&e.set(h,he.UVKind);const o=t.uv2s;o&&e.set(o,he.UV2Kind);const a=t.uv3s;a&&e.set(a,he.UV3Kind);const l=t.uv4s;l&&e.set(l,he.UV4Kind);const c=t.uv5s;c&&e.set(c,he.UV5Kind);const u=t.uv6s;u&&e.set(u,he.UV6Kind);const f=t.colors;f&&e.set(y.CheckColors4(f,s.length/3),he.ColorKind);const d=t.matricesIndices;d&&e.set(d,he.MatricesIndicesKind);const p=t.matricesWeights;p&&e.set(p,he.MatricesWeightsKind);const m=t.indices;m&&(e.indices=m),i.setAllVerticesData(e,t.updatable)}}os.FRONTSIDE=0,os.BACKSIDE=1,os.DOUBLESIDE=2,os.DEFAULTSIDE=0,ut([at.filter(((...[t])=>!Array.isArray(t)))],os,"_TransformVector3Coordinates",null),ut([at.filter(((...[t])=>!Array.isArray(t)))],os,"_TransformVector3Normals",null),ut([at.filter(((...[t])=>!Array.isArray(t)))],os,"_TransformVector4Normals",null),ut([at.filter(((...[t])=>!Array.isArray(t)))],os,"_FlipFaces",null);class as{constructor(t,i,e){this.bu=t,this.bv=i,this.distance=e,this.faceId=0,this.subMeshId=0}}class ls{constructor(t,i,e){this.vectors=f.BuildArray(8,w.Zero),this.center=w.Zero(),this.centerWorld=w.Zero(),this.extendSize=w.Zero(),this.extendSizeWorld=w.Zero(),this.directions=f.BuildArray(3,w.Zero),this.vectorsWorld=f.BuildArray(8,w.Zero),this.minimumWorld=w.Zero(),this.maximumWorld=w.Zero(),this.minimum=w.Zero(),this.maximum=w.Zero(),this.tC=null,this.iC=null,this.reConstruct(t,i,e)}reConstruct(t,i,e){const s=t.x,n=t.y,r=t.z,h=i.x,o=i.y,a=i.z,l=this.vectors;this.minimum.copyFromFloats(s,n,r),this.maximum.copyFromFloats(h,o,a),l[0].copyFromFloats(s,n,r),l[1].copyFromFloats(h,o,a),l[2].copyFromFloats(h,n,r),l[3].copyFromFloats(s,o,r),l[4].copyFromFloats(s,n,a),l[5].copyFromFloats(h,o,r),l[6].copyFromFloats(s,o,a),l[7].copyFromFloats(h,n,a),i.addToRef(t,this.center).scaleInPlace(.5),i.subtractToRef(t,this.extendSize).scaleInPlace(.5),this._i=e||R.IdentityReadOnly,this.HA(this._i)}scale(t){const i=ls.eC,e=this.maximum.subtractToRef(this.minimum,i[0]),s=e.length();e.normalizeFromLength(s);const n=s*t,r=e.scaleInPlace(.5*n),h=this.center.subtractToRef(r,i[1]),o=this.center.addToRef(r,i[2]);return this.reConstruct(h,o,this._i),this}getWorldMatrix(){return this._i}HA(t){const i=this.minimumWorld,e=this.maximumWorld,s=this.directions,n=this.vectorsWorld,r=this.vectors;if(t.isIdentity()){i.copyFrom(this.minimum),e.copyFrom(this.maximum);for(let t=0;t<8;++t)n[t].copyFrom(r[t]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{i.setAll(Number.MAX_VALUE),e.setAll(-Number.MAX_VALUE);for(let s=0;s<8;++s){const h=n[s];w.TransformCoordinatesToRef(r[s],t,h),i.minimizeInPlace(h),e.maximizeInPlace(h)}e.subtractToRef(i,this.extendSizeWorld).scaleInPlace(.5),e.addToRef(i,this.centerWorld).scaleInPlace(.5)}w.FromArrayToRef(t.m,0,s[0]),w.FromArrayToRef(t.m,4,s[1]),w.FromArrayToRef(t.m,8,s[2]),this._i=t}isInFrustum(t){return ls.IsInFrustum(this.vectorsWorld,t)}isCompletelyInFrustum(t){return ls.IsCompletelyInFrustum(this.vectorsWorld,t)}intersectsPoint(t){const i=this.minimumWorld,e=this.maximumWorld,s=i.x,n=i.y,r=i.z,h=e.x,o=e.y,a=e.z,l=t.x,c=t.y,u=t.z,f=-.001;return!(h-l<f||f>l-s)&&(!(o-c<f||f>c-n)&&!(a-u<f||f>u-r))}intersectsSphere(t){return ls.IntersectsSphere(this.minimumWorld,this.maximumWorld,t.centerWorld,t.radiusWorld)}intersectsMinMax(t,i){const e=this.minimumWorld,s=this.maximumWorld,n=e.x,r=e.y,h=e.z,o=s.x,a=s.y,l=s.z,c=t.x,u=t.y,f=t.z,d=i.x,p=i.y,m=i.z;return!(o<c||n>d)&&(!(a<u||r>p)&&!(l<f||h>m))}dispose(){var t,i;null===(t=this.tC)||void 0===t||t.dispose(),null===(i=this.iC)||void 0===i||i.dispose()}static Intersects(t,i){return t.intersectsMinMax(i.minimumWorld,i.maximumWorld)}static IntersectsSphere(t,i,e,s){const n=ls.eC[0];w.ClampToRef(e,t,i,n);return w.DistanceSquared(e,n)<=s*s}static IsCompletelyInFrustum(t,i){for(let e=0;e<6;++e){const s=i[e];for(let i=0;i<8;++i)if(s.dotCoordinate(t[i])<0)return!1}return!0}static IsInFrustum(t,i){for(let e=0;e<6;++e){let s=!0;const n=i[e];for(let i=0;i<8;++i)if(n.dotCoordinate(t[i])>=0){s=!1;break}if(s)return!1}return!0}}ls.eC=f.BuildArray(3,w.Zero);class cs{constructor(t,i,e){this.center=w.Zero(),this.centerWorld=w.Zero(),this.minimum=w.Zero(),this.maximum=w.Zero(),this.reConstruct(t,i,e)}reConstruct(t,i,e){this.minimum.copyFrom(t),this.maximum.copyFrom(i);const s=w.Distance(t,i);i.addToRef(t,this.center).scaleInPlace(.5),this.radius=.5*s,this.HA(e||R.IdentityReadOnly)}scale(t){const i=this.radius*t,e=cs.eC,s=e[0].setAll(i),n=this.center.subtractToRef(s,e[1]),r=this.center.addToRef(s,e[2]);return this.reConstruct(n,r,this._i),this}getWorldMatrix(){return this._i}HA(t){if(t.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{w.TransformCoordinatesToRef(this.center,t,this.centerWorld);const i=cs.eC[0];w.TransformNormalFromFloatsToRef(1,1,1,t,i),this.radiusWorld=Math.max(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z))*this.radius}}isInFrustum(t){const i=this.centerWorld,e=this.radiusWorld;for(let s=0;s<6;s++)if(t[s].dotCoordinate(i)<=-e)return!1;return!0}isCenterInFrustum(t){const i=this.centerWorld;for(let e=0;e<6;e++)if(t[e].dotCoordinate(i)<0)return!1;return!0}intersectsPoint(t){const i=w.DistanceSquared(this.centerWorld,t);return!(this.radiusWorld*this.radiusWorld<i)}static Intersects(t,i){const e=w.DistanceSquared(t.centerWorld,i.centerWorld),s=t.radiusWorld+i.radiusWorld;return!(s*s<e)}static CreateFromCenterAndRadius(t,i,e){this.eC[0].copyFrom(t),this.eC[1].copyFromFloats(0,0,i),this.eC[2].copyFrom(t),this.eC[0].addInPlace(this.eC[1]),this.eC[2].subtractInPlace(this.eC[1]);const s=new cs(this.eC[0],this.eC[2]);return s._i=e||R.Identity(),s}}cs.eC=f.BuildArray(3,w.Zero);const us={min:0,max:0},fs={min:0,max:0},ds=(t,i,e)=>{const s=w.Dot(i.centerWorld,t),n=Math.abs(w.Dot(i.directions[0],t))*i.extendSize.x+Math.abs(w.Dot(i.directions[1],t))*i.extendSize.y+Math.abs(w.Dot(i.directions[2],t))*i.extendSize.z;e.min=s-n,e.max=s+n},ps=(t,i,e)=>(ds(t,i,us),ds(t,e,fs),!(us.min>fs.max||fs.min>us.max));class ms{constructor(t,i,e){this.sC=!1,this.boundingBox=new ls(t,i,e),this.boundingSphere=new cs(t,i,e)}reConstruct(t,i,e){this.boundingBox.reConstruct(t,i,e),this.boundingSphere.reConstruct(t,i,e)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this.sC}set isLocked(t){this.sC=t}update(t){this.sC||(this.boundingBox.HA(t),this.boundingSphere.HA(t))}centerOn(t,i){const e=ms.eC[0].copyFrom(t).subtractInPlace(i),s=ms.eC[1].copyFrom(t).addInPlace(i);return this.boundingBox.reConstruct(e,s,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(e,s,this.boundingBox.getWorldMatrix()),this}encapsulate(t){const i=w.Minimize(this.minimum,t),e=w.Maximize(this.maximum,t);return this.reConstruct(i,e,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(t){return this.encapsulate(t.boundingBox.centerWorld.subtract(t.boundingBox.extendSizeWorld)),this.encapsulate(t.boundingBox.centerWorld.add(t.boundingBox.extendSizeWorld)),this}scale(t){return this.boundingBox.scale(t),this.boundingSphere.scale(t),this}isInFrustum(t,i=0){if((2===i||3===i)&&this.boundingSphere.isCenterInFrustum(t))return!0;if(!this.boundingSphere.isInFrustum(t))return!1;return!(1!==i&&3!==i)||this.boundingBox.isInFrustum(t)}get diagonalLength(){const t=this.boundingBox;return t.maximumWorld.subtractToRef(t.minimumWorld,ms.eC[0]).length()}isCompletelyInFrustum(t){return this.boundingBox.isCompletelyInFrustum(t)}nC(t){return t.rC(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(t){return!!this.boundingSphere.centerWorld&&(!!this.boundingSphere.intersectsPoint(t)&&!!this.boundingBox.intersectsPoint(t))}intersects(t,i){if(!cs.Intersects(this.boundingSphere,t.boundingSphere))return!1;if(!ls.Intersects(this.boundingBox,t.boundingBox))return!1;if(!i)return!0;const e=this.boundingBox,s=t.boundingBox;return!!ps(e.directions[0],e,s)&&(!!ps(e.directions[1],e,s)&&(!!ps(e.directions[2],e,s)&&(!!ps(s.directions[0],e,s)&&(!!ps(s.directions[1],e,s)&&(!!ps(s.directions[2],e,s)&&(!!ps(w.Cross(e.directions[0],s.directions[0]),e,s)&&(!!ps(w.Cross(e.directions[0],s.directions[1]),e,s)&&(!!ps(w.Cross(e.directions[0],s.directions[2]),e,s)&&(!!ps(w.Cross(e.directions[1],s.directions[0]),e,s)&&(!!ps(w.Cross(e.directions[1],s.directions[1]),e,s)&&(!!ps(w.Cross(e.directions[1],s.directions[2]),e,s)&&(!!ps(w.Cross(e.directions[2],s.directions[0]),e,s)&&(!!ps(w.Cross(e.directions[2],s.directions[1]),e,s)&&!!ps(w.Cross(e.directions[2],s.directions[2]),e,s))))))))))))))}}ms.eC=f.BuildArray(2,w.Zero);class vs{static extractMinAndMaxIndexed(t,i,e,s,n,r){for(let h=e;h<e+s;h++){const e=3*i[h],s=t[e],o=t[e+1],a=t[e+2];n.minimizeInPlaceFromFloats(s,o,a),r.maximizeInPlaceFromFloats(s,o,a)}}static extractMinAndMax(t,i,e,s,n,r){for(let h=i,o=i*s;h<i+e;h++,o+=s){const i=t[o],e=t[o+1],s=t[o+2];n.minimizeInPlaceFromFloats(i,e,s),r.maximizeInPlaceFromFloats(i,e,s)}}}function gs(t,i,e,s=null,n){const r=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),h=new w(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return n||(n=3),vs.extractMinAndMax(t,i,e,n,r,h),s&&(r.x-=r.x*s.x+s.y,r.y-=r.y*s.x+s.y,r.z-=r.z*s.x+s.y,h.x+=h.x*s.x+s.y,h.y+=h.y*s.x+s.y,h.z+=h.z*s.x+s.y),{minimum:r,maximum:h}}ut([at.filter(((...[t,i])=>!Array.isArray(t)&&!Array.isArray(i)))],vs,"extractMinAndMaxIndexed",null),ut([at.filter(((...[t])=>!Array.isArray(t)))],vs,"extractMinAndMax",null);class Ss{constructor(t,i,e,s,n,r,h,o=!0,a=!0){this.materialIndex=t,this.verticesStart=i,this.verticesCount=e,this.indexStart=s,this.indexCount=n,this.hC=null,this.oC=0,this.aC=null,this.lC=null,this.cC=null,this.sd=!1,this.Sv=0,this.Gf=0,this.zf=0,this.uC=null,this.fC=r,this.dC=h||r,a&&r.subMeshes.push(this),this.Ls=this.fC.getScene().getEngine(),this.resetDrawCache(),this.pC=[],this.Al=r.subMeshes.length-1,o&&(this.refreshBoundingInfo(),r.computeWorldMatrix(!0))}get materialDefines(){var t;return this.hC?this.hC.defines:null===(t=this.mC())||void 0===t?void 0:t.defines}set materialDefines(t){var i;(null!==(i=this.hC)&&void 0!==i?i:this.mC(void 0,!0)).defines=t}mC(t,i=!1){t=null!=t?t:this.Ls.currentRenderPassId;let e=this.vC[t];return!e&&i&&(this.vC[t]=e=new vi(this.fC.getScene().getEngine())),e}gC(t,i=!0){var e;i&&(null===(e=this.vC[t])||void 0===e||e.dispose()),this.vC[t]=void 0}get effect(){var t,i;return this.hC?this.hC.effect:null!==(i=null===(t=this.mC())||void 0===t?void 0:t.effect)&&void 0!==i?i:null}get SC(){var t;return null!==(t=this.hC)&&void 0!==t?t:this.mC(void 0,!0)}get EC(){return this.hC}AC(t){this.hC=t}setEffect(t,i=null,e,s=!0){const n=this.SC;n.setEffect(t,i,s),void 0!==e&&(n.materialContext=e),t||(n.defines=null,n.materialContext=void 0)}resetDrawCache(t){if(this.vC){if(void 0!==t)return void this.gC(t);for(const t of this.vC)null==t||t.dispose()}this.vC=[]}static AddToMesh(t,i,e,s,n,r,h,o=!0){return new Ss(t,i,e,s,n,r,h,o)}get IsGlobal(){return 0===this.verticesStart&&this.verticesCount===this.fC.getTotalVertices()&&0===this.indexStart&&this.indexCount===this.fC.getTotalIndices()}getBoundingInfo(){return this.IsGlobal?this.fC.getBoundingInfo():this.CC}setBoundingInfo(t){return this.CC=t,this}getMesh(){return this.fC}getRenderingMesh(){return this.dC}getReplacementMesh(){return this.fC._m.hS?this.fC:null}getEffectiveMesh(){const t=this.fC._m.hS?this.fC:null;return t||this.dC}getMaterial(t=!0){var i;const e=null!==(i=this.dC.getMaterialForRenderPass(this.Ls.currentRenderPassId))&&void 0!==i?i:this.dC.material;if(!e)return t?this.fC.getScene().defaultMaterial:null;if(this.wC(e)){const t=e.getSubMaterial(this.materialIndex);return this.uC!==t&&(this.uC=t,this.resetDrawCache()),t}return e}wC(t){return void 0!==t.getSubMaterial}refreshBoundingInfo(t=null){if(this.lC=null,this.IsGlobal||!this.dC||!this.dC.geometry)return this;if(t||(t=this.dC.getVerticesData(he.PositionKind)),!t)return this.CC=this.fC.getBoundingInfo(),this;const i=this.dC.getIndices();let e;if(0===this.indexStart&&this.indexCount===i.length){const t=this.dC.getBoundingInfo();e={minimum:t.minimum.clone(),maximum:t.maximum.clone()}}else e=function(t,i,e,s,n=null){const r=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),h=new w(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return vs.extractMinAndMaxIndexed(t,i,e,s,r,h),n&&(r.x-=r.x*n.x+n.y,r.y-=r.y*n.x+n.y,r.z-=r.z*n.x+n.y,h.x+=h.x*n.x+n.y,h.y+=h.y*n.x+n.y,h.z+=h.z*n.x+n.y),{minimum:r,maximum:h}}(t,i,this.indexStart,this.indexCount,this.dC.geometry.boundingBias);return this.CC?this.CC.reConstruct(e.minimum,e.maximum):this.CC=new ms(e.minimum,e.maximum),this}nC(t){return this.getBoundingInfo().nC(t)}updateBoundingInfo(t){let i=this.getBoundingInfo();return i||(this.refreshBoundingInfo(),i=this.getBoundingInfo()),i&&i.update(t),this}isInFrustum(t){const i=this.getBoundingInfo();return!!i&&i.isInFrustum(t,this.fC.cullingStrategy)}isCompletelyInFrustum(t){const i=this.getBoundingInfo();return!!i&&i.isCompletelyInFrustum(t)}render(t){return this.dC.render(this,t,this.fC._m.hS?this.fC:void 0),this}xC(t,i){if(!this.aC){const e=[];for(let i=this.indexStart;i<this.indexStart+this.indexCount;i+=3)e.push(t[i],t[i+1],t[i+1],t[i+2],t[i+2],t[i]);this.aC=i.createIndexBuffer(e),this.oC=e.length}return this.aC}canIntersects(t){const i=this.getBoundingInfo();return!!i&&t.intersectsBox(i.boundingBox)}intersects(t,i,e,s,n){const r=this.getMaterial();if(!r)return null;let h=3,o=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return null;case 7:h=1,o=!0}return 4===r.fillMode?e.length?this.TC(t,i,e,this.fC.intersectionThreshold,s):this.RC(t,i,e,this.fC.intersectionThreshold,s):!e.length&&this.fC.IC?this.MC(t,i,e,s,n):this.bC(t,i,e,h,o,s,n)}TC(t,i,e,s,n){let r=null;for(let h=this.indexStart;h<this.indexStart+this.indexCount;h+=2){const o=i[e[h]],a=i[e[h+1]],l=t.intersectionSegment(o,a,s);if(!(l<0)&&((n||!r||l<r.distance)&&(r=new as(null,null,l),r.faceId=h/2,n)))break}return r}RC(t,i,e,s,n){let r=null;for(let e=this.verticesStart;e<this.verticesStart+this.verticesCount;e+=2){const h=i[e],o=i[e+1],a=t.intersectionSegment(h,o,s);if(!(a<0)&&((n||!r||a<r.distance)&&(r=new as(null,null,a),r.faceId=e/2,n)))break}return r}bC(t,i,e,s,n,r,h){let o=null,a=-1;for(let l=this.indexStart;l<this.indexStart+this.indexCount-(3-s);l+=s){a++;const s=e[l],c=e[l+1],u=e[l+2];if(n&&4294967295===u){l+=2;continue}const f=i[s],d=i[c],p=i[u];if(!f||!d||!p)continue;if(h&&!h(f,d,p,t,s,c,u))continue;const m=t.intersectsTriangle(f,d,p);if(m){if(m.distance<0)continue;if((r||!o||m.distance<o.distance)&&(o=m,o.faceId=a,r))break}}return o}MC(t,i,e,s,n){let r=null;for(let e=this.verticesStart;e<this.verticesStart+this.verticesCount;e+=3){const h=i[e],o=i[e+1],a=i[e+2];if(n&&!n(h,o,a,t,-1,-1,-1))continue;const l=t.intersectsTriangle(h,o,a);if(l){if(l.distance<0)continue;if((s||!r||l.distance<r.distance)&&(r=l,r.faceId=e/3,s))break}}return r}br(){this.aC&&(this.aC=null)}clone(t,i){const e=new Ss(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,t,i,!1);if(!this.IsGlobal){const t=this.getBoundingInfo();if(!t)return e;e.CC=new ms(t.minimum,t.maximum)}return e}dispose(){this.aC&&(this.fC.getScene().getEngine().ca(this.aC),this.aC=null);const t=this.fC.subMeshes.indexOf(this);this.fC.subMeshes.splice(t,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(t,i,e,s,n,r=!0){let h=Number.MAX_VALUE,o=-Number.MAX_VALUE;const a=(n||s).getIndices();for(let t=i;t<i+e;t++){const i=a[t];i<h&&(h=i),i>o&&(o=i)}return new Ss(t,h,o-h+1,i,e,s,n,r)}}class Es{static get ForceFullSceneLoadingForIncremental(){return Es._C}static set ForceFullSceneLoadingForIncremental(t){Es._C=t}static get ShowLoadingScreen(){return Es.yC}static set ShowLoadingScreen(t){Es.yC=t}static get loggingLevel(){return Es.NC}static set loggingLevel(t){Es.NC=t}static get CleanBoneMatrixWeights(){return Es.PC}static set CleanBoneMatrixWeights(t){Es.PC=t}}Es._C=!1,Es.yC=!0,Es.PC=!1,Es.NC=0;class As{}As.UseOpenGLOrientationForUV=!1;class Cs{constructor(t,i,e,s=!1,n=null){this.delayLoadState=0,this.pv=0,this.li=!1,this.DC=!1,this.LC=[],this.Si=null,this.useBoundingInfoFromGeometry=!1,this.Kt=i||E.LastCreatedScene,this.Kt&&(this.id=t,this.uniqueId=this.Kt.getUniqueId(),this.Ls=this.Kt.getEngine(),this.OC=[],this.ff={},this.FC=[],this.ef=s,e?this.setAllVerticesData(e,s):this.pv=0,this.Ls.getCaps().vertexArrayObject&&(this.BC={}),n&&(this.applyToMesh(n),n.computeWorldMatrix(!0)))}get boundingBias(){return this.UC}set boundingBias(t){this.UC?this.UC.copyFrom(t):this.UC=t.clone(),this.VC(!0,null)}static CreateGeometryForMesh(t){const i=new Cs(Cs.RandomId(),t.getScene());return i.applyToMesh(t),i}get meshes(){return this.OC}get extend(){return this.kC}getScene(){return this.Kt}getEngine(){return this.Ls}isReady(){return 1===this.delayLoadState||0===this.delayLoadState}get doNotSerialize(){for(let t=0;t<this.OC.length;t++)if(!this.OC[t].doNotSerialize)return!1;return!0}br(){this.BC&&(this.BC={}),0!==this.OC.length&&this.FC&&(this.Xu=this.Ls.createIndexBuffer(this.FC,this.ef));for(const t in this.ff){this.ff[t].br()}}setAllVerticesData(t,i){t.applyToGeometry(this,i),this.GC()}setVerticesData(t,i,e=!1,s){e&&Array.isArray(i)&&(i=new Float32Array(i));const n=new he(this.Ls,i,t,e,0===this.OC.length,s);this.setVerticesBuffer(n)}removeVerticesData(t){this.ff[t]&&(this.ff[t].dispose(),delete this.ff[t]),this.BC&&this.zC()}setVerticesBuffer(t,i=null,e=!0){const s=t.getKind();this.ff[s]&&e&&this.ff[s].dispose(),t.Yn&&t.Yn.rf(),this.ff[s]=t;const n=this.OC,r=n.length;if(s===he.PositionKind){const e=t.getData();null!=i?this.pv=i:null!=e&&(this.pv=e.length/(t.type===he.BYTE?t.byteStride:t.byteStride/4)),this.HC(e),this.XC();for(let t=0;t<r;t++){const i=n[t];i.buildBoundingInfo(this.kC.minimum,this.kC.maximum),i.WC(i.isUnIndexed),i.computeWorldMatrix(!0),i.synchronizeInstances()}}this.GC(s)}updateVerticesDataDirectly(t,i,e,s=!1){const n=this.getVertexBuffer(t);n&&(n.updateDirectly(i,e,s),this.GC(t))}updateVerticesData(t,i,e=!1){const s=this.getVertexBuffer(t);s&&(s.update(i),t===he.PositionKind&&this.VC(e,i),this.GC(t))}VC(t,i){if(t&&this.HC(i),this.XC(),t){const t=this.OC;for(const i of t){i.hasBoundingInfo?i.getBoundingInfo().reConstruct(this.kC.minimum,this.kC.maximum):i.buildBoundingInfo(this.kC.minimum,this.kC.maximum);const t=i.subMeshes;for(const i of t)i.refreshBoundingInfo()}}}$C(t,i,e,s){if(!t)return;void 0===i&&(i=this.Xu);const n=this.getVertexBuffers();if(!n)return;if(i!=this.Xu||!this.BC&&!s)return void this.Ls.bindBuffers(n,i,t,e);const r=s||this.BC;r[t.key]||(r[t.key]=this.Ls.recordVertexArrayObject(n,i,t,e)),this.Ls.bindVertexArrayObject(r[t.key],i)}getTotalVertices(){return this.isReady()?this.pv:0}getVerticesData(t,i,e){const s=this.getVertexBuffer(t);return s?s.getFloatData(this.pv,e||i&&1!==this.OC.length):null}isVertexBufferUpdatable(t){const i=this.ff[t];return!!i&&i.isUpdatable()}getVertexBuffer(t){return this.isReady()?this.ff[t]:null}getVertexBuffers(){return this.isReady()?this.ff:null}isVerticesDataPresent(t){return this.ff?void 0!==this.ff[t]:!!this.YC&&-1!==this.YC.indexOf(t)}getVerticesDataKinds(){const t=[];let i;if(!this.ff&&this.YC)for(i in this.YC)t.push(i);else for(i in this.ff)t.push(i);return t}updateIndices(t,i,e=!1){if(this.Xu)if(this.DC){const s=t.length!==this.FC.length;if(e||(this.FC=t.slice()),this.Ls.updateDynamicIndexBuffer(this.Xu,t,i),s)for(const t of this.OC)t.WC(!0)}else this.setIndices(t,null,!0)}setIndices(t,i=null,e=!1){this.Xu&&this.Ls.ca(this.Xu),this.FC=t,this.DC=e,0!==this.OC.length&&this.FC&&(this.Xu=this.Ls.createIndexBuffer(this.FC,e)),null!=i&&(this.pv=i);for(const t of this.OC)t.WC(!0),t.synchronizeInstances();this.GC()}getTotalIndices(){return this.isReady()?this.FC.length:0}getIndices(t,i){if(!this.isReady())return null;const e=this.FC;return i||t&&1!==this.OC.length?e.slice():e}getIndexBuffer(){return this.isReady()?this.Xu:null}jC(t=null){t&&this.BC&&this.BC[t.key]&&(this.Ls.releaseVertexArrayObject(this.BC[t.key]),delete this.BC[t.key])}releaseForMesh(t,i){const e=this.OC,s=e.indexOf(t);-1!==s&&(e.splice(s,1),this.BC&&t.KC(),t.qC=null,0===e.length&&i&&this.dispose())}applyToMesh(t){if(t.qC===this)return;const i=t.qC;i&&i.releaseForMesh(t),this.BC&&t.KC();const e=this.OC;t.qC=this,t._m.QC=null,this.Kt.pushGeometry(this),e.push(t),this.isReady()?this.ZC(t):this.CC&&t.setBoundingInfo(this.CC)}HC(t=null){if(this.useBoundingInfoFromGeometry&&this.CC)this.kC={minimum:this.CC.minimum.clone(),maximum:this.CC.maximum.clone()};else{if(!t&&!(t=this.getVerticesData(he.PositionKind)))return;this.kC=gs(t,0,this.pv,this.boundingBias,3)}}ZC(t){const i=this.OC.length;for(const e in this.ff)1===i&&this.ff[e].create(),e===he.PositionKind&&(this.kC||this.HC(),t.buildBoundingInfo(this.kC.minimum,this.kC.maximum),t.WC(t.isUnIndexed),t.VC());1===i&&this.FC&&this.FC.length>0&&(this.Xu=this.Ls.createIndexBuffer(this.FC,this.ef)),t.JC(),t.synchronizeInstances()}GC(t){this.onGeometryUpdated&&this.onGeometryUpdated(this,t),this.BC&&this.zC();for(const t of this.OC)t.tw()}load(t,i){2!==this.delayLoadState&&(this.isReady()?i&&i():(this.delayLoadState=2,this.iw(t,i)))}iw(t,i){this.delayLoadingFile&&(t.addPendingData(this),t.tn(this.delayLoadingFile,(e=>{if(!this.ew)return;this.ew(JSON.parse(e),this),this.delayLoadState=1,this.YC=[],t.removePendingData(this);const s=this.OC,n=s.length;for(let t=0;t<n;t++)this.ZC(s[t]);i&&i()}),void 0,!0))}toLeftHanded(){const t=this.getIndices(!1);if(null!=t&&t.length>0){for(let i=0;i<t.length;i+=3){const e=t[i+0];t[i+0]=t[i+2],t[i+2]=e}this.setIndices(t)}const i=this.getVerticesData(he.PositionKind,!1);if(null!=i&&i.length>0){for(let t=0;t<i.length;t+=3)i[t+2]=-i[t+2];this.setVerticesData(he.PositionKind,i,!1)}const e=this.getVerticesData(he.NormalKind,!1);if(null!=e&&e.length>0){for(let t=0;t<e.length;t+=3)e[t+2]=-e[t+2];this.setVerticesData(he.NormalKind,e,!1)}}XC(){this.QC=null}sw(){if(this.QC)return!0;const t=this.getVerticesData(he.PositionKind);if(!t||0===t.length)return!1;for(let i=3*this.LC.length,e=this.LC.length;i<t.length;i+=3,++e)this.LC[e]=w.FromArray(t,i);for(let i=0,e=0;i<t.length;i+=3,++e)this.LC[e].set(t[0+i],t[1+i],t[2+i]);return this.LC.length=t.length/3,this.QC=this.LC,!0}isDisposed(){return this.li}zC(){if(this.BC){for(const t in this.BC)this.Ls.releaseVertexArrayObject(this.BC[t]);this.BC={};const t=this.OC,i=t.length;for(let e=0;e<i;e++)t[e].KC()}}dispose(){const t=this.OC,i=t.length;let e;for(e=0;e<i;e++)this.releaseForMesh(t[e]);this.OC.length=0,this.zC();for(const t in this.ff)this.ff[t].dispose();if(this.ff={},this.pv=0,this.Xu&&this.Ls.ca(this.Xu),this.Xu=null,this.FC=[],this.delayLoadState=0,this.delayLoadingFile=null,this.ew=null,this.YC=[],this.CC=null,this.Kt.removeGeometry(this),this.Si){const t=this.Si.geometries.indexOf(this);t>-1&&this.Si.geometries.splice(t,1),this.Si=null}this.li=!0}copy(t){const i=new os;i.indices=[];const e=this.getIndices();if(e)for(let t=0;t<e.length;t++)i.indices.push(e[t]);let s,n=!1,r=!1;for(s in this.ff){const t=this.getVerticesData(s);if(t&&(t instanceof Float32Array?i.set(new Float32Array(t),s):i.set(t.slice(0),s),!r)){const t=this.getVertexBuffer(s);t&&(n=t.isUpdatable(),r=!n)}}const h=new Cs(t,this.Kt,i,n);for(s in h.delayLoadState=this.delayLoadState,h.delayLoadingFile=this.delayLoadingFile,h.ew=this.ew,this.YC)h.YC=h.YC||[],h.YC.push(s);return h.CC=new ms(this.kC.minimum,this.kC.maximum),h}serialize(){const t={};return t.id=this.id,t.uniqueId=this.uniqueId,t.updatable=this.ef,H&&H.HasTags(this)&&(t.tags=H.GetTags(this)),t}nw(t){return Array.isArray(t)?t:Array.prototype.slice.call(t)}clearCachedData(){this.FC=[],this.XC();for(const t in this.ff)Object.prototype.hasOwnProperty.call(this.ff,t)&&(this.ff[t].Yn.Rl=null)}serializeVerticeData(){const t=this.serialize();return this.isVerticesDataPresent(he.PositionKind)&&(t.positions=this.nw(this.getVerticesData(he.PositionKind)),this.isVertexBufferUpdatable(he.PositionKind)&&(t.positions.ef=!0)),this.isVerticesDataPresent(he.NormalKind)&&(t.normals=this.nw(this.getVerticesData(he.NormalKind)),this.isVertexBufferUpdatable(he.NormalKind)&&(t.normals.ef=!0)),this.isVerticesDataPresent(he.TangentKind)&&(t.tangents=this.nw(this.getVerticesData(he.TangentKind)),this.isVertexBufferUpdatable(he.TangentKind)&&(t.tangents.ef=!0)),this.isVerticesDataPresent(he.UVKind)&&(t.uvs=this.nw(this.getVerticesData(he.UVKind)),this.isVertexBufferUpdatable(he.UVKind)&&(t.uvs.ef=!0)),this.isVerticesDataPresent(he.UV2Kind)&&(t.uv2s=this.nw(this.getVerticesData(he.UV2Kind)),this.isVertexBufferUpdatable(he.UV2Kind)&&(t.uv2s.ef=!0)),this.isVerticesDataPresent(he.UV3Kind)&&(t.uv3s=this.nw(this.getVerticesData(he.UV3Kind)),this.isVertexBufferUpdatable(he.UV3Kind)&&(t.uv3s.ef=!0)),this.isVerticesDataPresent(he.UV4Kind)&&(t.uv4s=this.nw(this.getVerticesData(he.UV4Kind)),this.isVertexBufferUpdatable(he.UV4Kind)&&(t.uv4s.ef=!0)),this.isVerticesDataPresent(he.UV5Kind)&&(t.uv5s=this.nw(this.getVerticesData(he.UV5Kind)),this.isVertexBufferUpdatable(he.UV5Kind)&&(t.uv5s.ef=!0)),this.isVerticesDataPresent(he.UV6Kind)&&(t.uv6s=this.nw(this.getVerticesData(he.UV6Kind)),this.isVertexBufferUpdatable(he.UV6Kind)&&(t.uv6s.ef=!0)),this.isVerticesDataPresent(he.ColorKind)&&(t.colors=this.nw(this.getVerticesData(he.ColorKind)),this.isVertexBufferUpdatable(he.ColorKind)&&(t.colors.ef=!0)),this.isVerticesDataPresent(he.MatricesIndicesKind)&&(t.matricesIndices=this.nw(this.getVerticesData(he.MatricesIndicesKind)),t.matricesIndices.QA=!0,this.isVertexBufferUpdatable(he.MatricesIndicesKind)&&(t.matricesIndices.ef=!0)),this.isVerticesDataPresent(he.MatricesWeightsKind)&&(t.matricesWeights=this.nw(this.getVerticesData(he.MatricesWeightsKind)),this.isVertexBufferUpdatable(he.MatricesWeightsKind)&&(t.matricesWeights.ef=!0)),t.indices=this.nw(this.getIndices()),t}static ExtractFromMesh(t,i){const e=t.qC;return e?e.copy(i):null}static RandomId(){return ki.RandomId()}static rw(t,i){for(let e=0;e<i.geometries.length;e++)if(i.geometries[e].hw===t)return i.geometries[e];return null}static ow(t,i){const e=i.getScene(),s=t.geometryUniqueId,n=t.geometryId;if(s||n){const t=s?this.rw(s,e):e.getGeometryById(n);t&&t.applyToMesh(i)}else if(t instanceof ArrayBuffer){const e=i.aw;if(e.positionsAttrDesc&&e.positionsAttrDesc.count>0){const s=new Float32Array(t,e.positionsAttrDesc.offset,e.positionsAttrDesc.count);i.setVerticesData(he.PositionKind,s,!1)}if(e.normalsAttrDesc&&e.normalsAttrDesc.count>0){const s=new Float32Array(t,e.normalsAttrDesc.offset,e.normalsAttrDesc.count);i.setVerticesData(he.NormalKind,s,!1)}if(e.tangetsAttrDesc&&e.tangetsAttrDesc.count>0){const s=new Float32Array(t,e.tangetsAttrDesc.offset,e.tangetsAttrDesc.count);i.setVerticesData(he.TangentKind,s,!1)}if(e.uvsAttrDesc&&e.uvsAttrDesc.count>0){const s=new Float32Array(t,e.uvsAttrDesc.offset,e.uvsAttrDesc.count);if(As.UseOpenGLOrientationForUV)for(let t=1;t<s.length;t+=2)s[t]=1-s[t];i.setVerticesData(he.UVKind,s,!1)}if(e.uvs2AttrDesc&&e.uvs2AttrDesc.count>0){const s=new Float32Array(t,e.uvs2AttrDesc.offset,e.uvs2AttrDesc.count);if(As.UseOpenGLOrientationForUV)for(let t=1;t<s.length;t+=2)s[t]=1-s[t];i.setVerticesData(he.UV2Kind,s,!1)}if(e.uvs3AttrDesc&&e.uvs3AttrDesc.count>0){const s=new Float32Array(t,e.uvs3AttrDesc.offset,e.uvs3AttrDesc.count);if(As.UseOpenGLOrientationForUV)for(let t=1;t<s.length;t+=2)s[t]=1-s[t];i.setVerticesData(he.UV3Kind,s,!1)}if(e.uvs4AttrDesc&&e.uvs4AttrDesc.count>0){const s=new Float32Array(t,e.uvs4AttrDesc.offset,e.uvs4AttrDesc.count);if(As.UseOpenGLOrientationForUV)for(let t=1;t<s.length;t+=2)s[t]=1-s[t];i.setVerticesData(he.UV4Kind,s,!1)}if(e.uvs5AttrDesc&&e.uvs5AttrDesc.count>0){const s=new Float32Array(t,e.uvs5AttrDesc.offset,e.uvs5AttrDesc.count);if(As.UseOpenGLOrientationForUV)for(let t=1;t<s.length;t+=2)s[t]=1-s[t];i.setVerticesData(he.UV5Kind,s,!1)}if(e.uvs6AttrDesc&&e.uvs6AttrDesc.count>0){const s=new Float32Array(t,e.uvs6AttrDesc.offset,e.uvs6AttrDesc.count);if(As.UseOpenGLOrientationForUV)for(let t=1;t<s.length;t+=2)s[t]=1-s[t];i.setVerticesData(he.UV6Kind,s,!1)}if(e.colorsAttrDesc&&e.colorsAttrDesc.count>0){const s=new Float32Array(t,e.colorsAttrDesc.offset,e.colorsAttrDesc.count);i.setVerticesData(he.ColorKind,s,!1,e.colorsAttrDesc.stride)}if(e.matricesIndicesAttrDesc&&e.matricesIndicesAttrDesc.count>0){const s=new Int32Array(t,e.matricesIndicesAttrDesc.offset,e.matricesIndicesAttrDesc.count),n=[];for(let t=0;t<s.length;t++){const i=s[t];n.push(255&i),n.push((65280&i)>>8),n.push((16711680&i)>>16),n.push(i>>24&255)}i.setVerticesData(he.MatricesIndicesKind,n,!1)}if(e.matricesIndicesExtraAttrDesc&&e.matricesIndicesExtraAttrDesc.count>0){const s=new Int32Array(t,e.matricesIndicesExtraAttrDesc.offset,e.matricesIndicesExtraAttrDesc.count),n=[];for(let t=0;t<s.length;t++){const i=s[t];n.push(255&i),n.push((65280&i)>>8),n.push((16711680&i)>>16),n.push(i>>24&255)}i.setVerticesData(he.MatricesIndicesExtraKind,n,!1)}if(e.matricesWeightsAttrDesc&&e.matricesWeightsAttrDesc.count>0){const s=new Float32Array(t,e.matricesWeightsAttrDesc.offset,e.matricesWeightsAttrDesc.count);i.setVerticesData(he.MatricesWeightsKind,s,!1)}if(e.indicesAttrDesc&&e.indicesAttrDesc.count>0){const s=new Int32Array(t,e.indicesAttrDesc.offset,e.indicesAttrDesc.count);i.setIndices(s,null)}if(e.subMeshesAttrDesc&&e.subMeshesAttrDesc.count>0){const s=new Int32Array(t,e.subMeshesAttrDesc.offset,5*e.subMeshesAttrDesc.count);i.subMeshes=[];for(let t=0;t<e.subMeshesAttrDesc.count;t++){const e=s[5*t+0],n=s[5*t+1],r=s[5*t+2],h=s[5*t+3],o=s[5*t+4];Ss.AddToMesh(e,n,r,h,o,i)}}}else if(t.positions&&t.normals&&t.indices){if(i.setVerticesData(he.PositionKind,t.positions,t.positions.ef),i.setVerticesData(he.NormalKind,t.normals,t.normals.ef),t.tangents&&i.setVerticesData(he.TangentKind,t.tangents,t.tangents.ef),t.uvs&&i.setVerticesData(he.UVKind,t.uvs,t.uvs.ef),t.uvs2&&i.setVerticesData(he.UV2Kind,t.uvs2,t.uvs2.ef),t.uvs3&&i.setVerticesData(he.UV3Kind,t.uvs3,t.uvs3.ef),t.uvs4&&i.setVerticesData(he.UV4Kind,t.uvs4,t.uvs4.ef),t.uvs5&&i.setVerticesData(he.UV5Kind,t.uvs5,t.uvs5.ef),t.uvs6&&i.setVerticesData(he.UV6Kind,t.uvs6,t.uvs6.ef),t.colors&&i.setVerticesData(he.ColorKind,y.CheckColors4(t.colors,t.positions.length/3),t.colors.ef),t.matricesIndices)if(t.matricesIndices.QA)delete t.matricesIndices.QA,i.setVerticesData(he.MatricesIndicesKind,t.matricesIndices,t.matricesIndices.ef);else{const e=[];for(let i=0;i<t.matricesIndices.length;i++){const s=t.matricesIndices[i];e.push(255&s),e.push((65280&s)>>8),e.push((16711680&s)>>16),e.push(s>>24&255)}i.setVerticesData(he.MatricesIndicesKind,e,t.matricesIndices.ef)}if(t.matricesIndicesExtra)if(t.matricesIndicesExtra.QA)delete t.matricesIndices.QA,i.setVerticesData(he.MatricesIndicesExtraKind,t.matricesIndicesExtra,t.matricesIndicesExtra.ef);else{const e=[];for(let i=0;i<t.matricesIndicesExtra.length;i++){const s=t.matricesIndicesExtra[i];e.push(255&s),e.push((65280&s)>>8),e.push((16711680&s)>>16),e.push(s>>24&255)}i.setVerticesData(he.MatricesIndicesExtraKind,e,t.matricesIndicesExtra.ef)}t.matricesWeights&&(Cs.lw(t,i),i.setVerticesData(he.MatricesWeightsKind,t.matricesWeights,t.matricesWeights.ef)),t.matricesWeightsExtra&&i.setVerticesData(he.MatricesWeightsExtraKind,t.matricesWeightsExtra,t.matricesWeights.ef),i.setIndices(t.indices,null)}if(t.subMeshes){i.subMeshes=[];for(let e=0;e<t.subMeshes.length;e++){const s=t.subMeshes[e];Ss.AddToMesh(s.materialIndex,s.verticesStart,s.verticesCount,s.indexStart,s.indexCount,i)}}i.cw&&(i.convertToFlatShadedMesh(),i.cw=!1),i.computeWorldMatrix(!0),e.onMeshImportedObservable.notifyObservers(i)}static lw(t,i){const e=.001;if(!Es.CleanBoneMatrixWeights)return;let s=0;if(!(t.skeletonId>-1))return;{const e=i.getScene().getLastSkeletonById(t.skeletonId);if(!e)return;s=e.bones.length}const n=i.getVerticesData(he.MatricesIndicesKind),r=i.getVerticesData(he.MatricesIndicesExtraKind),h=t.matricesWeights,o=t.matricesWeightsExtra,a=t.numBoneInfluencer,l=h.length;for(let t=0;t<l;t+=4){let i=0,l=-1;for(let s=0;s<4;s++){const n=h[t+s];i+=n,n<e&&l<0&&(l=s)}if(o)for(let s=0;s<4;s++){const n=o[t+s];i+=n,n<e&&l<0&&(l=s+4)}if((l<0||l>a-1)&&(l=a-1),i>e){const e=1/i;for(let i=0;i<4;i++)h[t+i]*=e;if(o)for(let i=0;i<4;i++)o[t+i]*=e}else l>=4?(o[t+l-4]=1-i,r[t+l-4]=s):(h[t+l]=1-i,n[t+l]=s)}i.setVerticesData(he.MatricesIndicesKind,n),t.matricesWeightsExtra&&i.setVerticesData(he.MatricesIndicesExtraKind,r)}static Parse(t,i,e){const s=new Cs(t.id,i,void 0,t.updatable);return s.hw=t.uniqueId,H&&H.AddTagsTo(s,t.tags),t.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=e+t.delayLoadingFile,s.CC=new ms(w.FromArray(t.boundingBoxMinimum),w.FromArray(t.boundingBoxMaximum)),s.YC=[],t.hasUVs&&s.YC.push(he.UVKind),t.hasUVs2&&s.YC.push(he.UV2Kind),t.hasUVs3&&s.YC.push(he.UV3Kind),t.hasUVs4&&s.YC.push(he.UV4Kind),t.hasUVs5&&s.YC.push(he.UV5Kind),t.hasUVs6&&s.YC.push(he.UV6Kind),t.hasColors&&s.YC.push(he.ColorKind),t.hasMatricesIndices&&s.YC.push(he.MatricesIndicesKind),t.hasMatricesWeights&&s.YC.push(he.MatricesWeightsKind),s.ew=os.ImportVertexData):os.ImportVertexData(t,s),i.pushGeometry(s,!0),s}}class ws{constructor(t=30){this.ih=!0,this.uw=new xs(t)}sampleFrame(t=bt.Now){if(this.ih){if(null!=this.fw){const i=t-this.fw;this.uw.add(i)}this.fw=t}}get averageFrameTime(){return this.uw.average}get averageFrameTimeVariance(){return this.uw.variance}get instantaneousFrameTime(){return this.uw.history(0)}get averageFPS(){return 1e3/this.uw.average}get instantaneousFPS(){const t=this.uw.history(0);return 0===t?0:1e3/t}get isSaturated(){return this.uw.isSaturated()}enable(){this.ih=!0}disable(){this.ih=!1,this.fw=null}get isEnabled(){return this.ih}reset(){this.fw=null,this.uw.reset()}}class xs{constructor(t){this.dw=new Array(t),this.reset()}add(t){let i;if(this.isSaturated()){const t=this.dw[this.pw];i=t-this.average,this.average-=i/(this.mw-1),this.gw-=i*(t-this.average)}else this.mw++;i=t-this.average,this.average+=i/this.mw,this.gw+=i*(t-this.average),this.variance=this.gw/(this.mw-1),this.dw[this.pw]=t,this.pw++,this.pw%=this.dw.length}history(t){if(t>=this.mw||t>=this.dw.length)return 0;const i=this.Sw(this.pw-1);return this.dw[this.Sw(i-t)]}isSaturated(){return this.mw>=this.dw.length}reset(){this.average=0,this.variance=0,this.mw=0,this.pw=0,this.gw=0}Sw(t){const i=this.dw.length;return(t%i+i)%i}}function Ts(t,i,e=!1,s){switch(t){case 3:{const t=(ArrayBuffer,new Int8Array(i));return s&&t.set(new Int8Array(s)),t}case 0:{const t=(ArrayBuffer,new Uint8Array(i));return s&&t.set(new Uint8Array(s)),t}case 4:{const t=i instanceof ArrayBuffer?new Int16Array(i):new Int16Array(e?i/2:i);return s&&t.set(new Int16Array(s)),t}case 5:case 8:case 9:case 10:case 2:{const t=i instanceof ArrayBuffer?new Uint16Array(i):new Uint16Array(e?i/2:i);return s&&t.set(new Uint16Array(s)),t}case 6:{const t=i instanceof ArrayBuffer?new Int32Array(i):new Int32Array(e?i/4:i);return s&&t.set(new Int32Array(s)),t}case 7:case 11:case 12:case 13:case 14:case 15:{const t=i instanceof ArrayBuffer?new Uint32Array(i):new Uint32Array(e?i/4:i);return s&&t.set(new Uint32Array(s)),t}case 1:{const t=i instanceof ArrayBuffer?new Float32Array(i):new Float32Array(e?i/4:i);return s&&t.set(new Float32Array(s)),t}}const n=(ArrayBuffer,new Uint8Array(i));return s&&n.set(new Uint8Array(s)),n}Ei.prototype.setAlphaConstants=function(t,i,e,s){this.wh.setAlphaBlendConstants(t,i,e,s)},Ei.prototype.setAlphaMode=function(t,i=!1){if(this.xh!==t){switch(t){case 0:this.wh.alphaBlend=!1;break;case 7:this.wh.setAlphaBlendFunctionParameters(this.lo.ONE,this.lo.ONE_MINUS_SRC_ALPHA,this.lo.ONE,this.lo.ONE),this.wh.alphaBlend=!0;break;case 8:case 14:this.wh.setAlphaBlendFunctionParameters(this.lo.ONE,this.lo.ONE_MINUS_SRC_ALPHA,this.lo.ONE,this.lo.ONE_MINUS_SRC_ALPHA),this.wh.alphaBlend=!0;break;case 2:this.wh.setAlphaBlendFunctionParameters(this.lo.SRC_ALPHA,this.lo.ONE_MINUS_SRC_ALPHA,this.lo.ONE,this.lo.ONE),this.wh.alphaBlend=!0;break;case 6:this.wh.setAlphaBlendFunctionParameters(this.lo.ONE,this.lo.ONE,this.lo.ZERO,this.lo.ONE),this.wh.alphaBlend=!0;break;case 1:this.wh.setAlphaBlendFunctionParameters(this.lo.SRC_ALPHA,this.lo.ONE,this.lo.ZERO,this.lo.ONE),this.wh.alphaBlend=!0;break;case 3:this.wh.setAlphaBlendFunctionParameters(this.lo.ZERO,this.lo.ONE_MINUS_SRC_COLOR,this.lo.ONE,this.lo.ONE),this.wh.alphaBlend=!0;break;case 4:this.wh.setAlphaBlendFunctionParameters(this.lo.DST_COLOR,this.lo.ZERO,this.lo.ONE,this.lo.ONE),this.wh.alphaBlend=!0;break;case 5:this.wh.setAlphaBlendFunctionParameters(this.lo.SRC_ALPHA,this.lo.ONE_MINUS_SRC_COLOR,this.lo.ONE,this.lo.ONE),this.wh.alphaBlend=!0;break;case 9:this.wh.setAlphaBlendFunctionParameters(this.lo.CONSTANT_COLOR,this.lo.ONE_MINUS_CONSTANT_COLOR,this.lo.CONSTANT_ALPHA,this.lo.ONE_MINUS_CONSTANT_ALPHA),this.wh.alphaBlend=!0;break;case 10:this.wh.setAlphaBlendFunctionParameters(this.lo.ONE,this.lo.ONE_MINUS_SRC_COLOR,this.lo.ONE,this.lo.ONE_MINUS_SRC_ALPHA),this.wh.alphaBlend=!0;break;case 11:this.wh.setAlphaBlendFunctionParameters(this.lo.ONE,this.lo.ONE,this.lo.ONE,this.lo.ONE),this.wh.alphaBlend=!0;break;case 12:this.wh.setAlphaBlendFunctionParameters(this.lo.DST_ALPHA,this.lo.ONE,this.lo.ZERO,this.lo.ZERO),this.wh.alphaBlend=!0;break;case 13:this.wh.setAlphaBlendFunctionParameters(this.lo.ONE_MINUS_DST_COLOR,this.lo.ONE_MINUS_SRC_COLOR,this.lo.ONE_MINUS_DST_ALPHA,this.lo.ONE_MINUS_SRC_ALPHA),this.wh.alphaBlend=!0;break;case 15:this.wh.setAlphaBlendFunctionParameters(this.lo.ONE,this.lo.ONE,this.lo.ONE,this.lo.ZERO),this.wh.alphaBlend=!0;break;case 16:this.wh.setAlphaBlendFunctionParameters(this.lo.ONE_MINUS_DST_COLOR,this.lo.ONE_MINUS_SRC_COLOR,this.lo.ZERO,this.lo.ONE),this.wh.alphaBlend=!0;break;case 17:this.wh.setAlphaBlendFunctionParameters(this.lo.SRC_ALPHA,this.lo.ONE_MINUS_SRC_ALPHA,this.lo.ONE,this.lo.ONE_MINUS_SRC_ALPHA),this.wh.alphaBlend=!0}i||(this.depthCullingState.depthMask=0===t),this.xh=t}},Ei.prototype.getAlphaMode=function(){return this.xh},Ei.prototype.setAlphaEquation=function(t){if(this.Th!==t){switch(t){case 0:this.wh.setAlphaEquationParameters(32774,32774);break;case 1:this.wh.setAlphaEquationParameters(32778,32778);break;case 2:this.wh.setAlphaEquationParameters(32779,32779);break;case 3:this.wh.setAlphaEquationParameters(32776,32776);break;case 4:this.wh.setAlphaEquationParameters(32775,32775);break;case 5:this.wh.setAlphaEquationParameters(32775,32774)}this.Th=t}},Ei.prototype.getAlphaEquation=function(){return this.Th},Ei.prototype.Ew=function(t,i,e,s=-1,n=0,r=null,h=!0,o=!1,a=0,l=0){var c,u;const f=this.lo;if(!f)throw new Error("Engine does not have gl rendering context.");if(!this.Oh){const t=f.createFramebuffer();if(!t)throw new Error("Unable to create dummy framebuffer");this.Oh=t}f.bindFramebuffer(f.FRAMEBUFFER,this.Oh),s>-1?f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_CUBE_MAP_POSITIVE_X+s,null===(c=t.Er)||void 0===c?void 0:c.underlyingResource,n):f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,null===(u=t.Er)||void 0===u?void 0:u.underlyingResource,n);let d=void 0!==t.type?this.Ma(t.type):f.UNSIGNED_BYTE;if(o)r||(r=Ts(t.type,4*i*e));else if(d===f.UNSIGNED_BYTE)r||(r=new Uint8Array(4*i*e)),d=f.UNSIGNED_BYTE;else r||(r=new Float32Array(4*i*e)),d=f.FLOAT;return h&&this.flushFramebuffer(),f.readPixels(a,l,i,e,f.RGBA,d,r),f.bindFramebuffer(f.FRAMEBUFFER,this.Lh),r},Ei.prototype.Aw=function(t,i,e,s=-1,n=0,r=null,h=!0,o=!1,a=0,l=0){return Promise.resolve(this.Ew(t,i,e,s,n,r,h,o,a,l))},Ei.prototype.updateDynamicIndexBuffer=function(t,i,e=0){let s;this.Dh[this.lo.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(t),s=t.is32Bits?i instanceof Uint32Array?i:new Uint32Array(i):i instanceof Uint16Array?i:new Uint16Array(i),this.lo.bufferData(this.lo.ELEMENT_ARRAY_BUFFER,s,this.lo.DYNAMIC_DRAW),this.ta()},Ei.prototype.updateDynamicVertexBuffer=function(t,i,e,s){this.bindArrayBuffer(t),void 0===e&&(e=0);const n=i.byteLength||i.length;void 0===s||s>=n&&0===e?i instanceof Array?this.lo.bufferSubData(this.lo.ARRAY_BUFFER,e,new Float32Array(i)):this.lo.bufferSubData(this.lo.ARRAY_BUFFER,e,i):i instanceof Array?this.lo.bufferSubData(this.lo.ARRAY_BUFFER,0,new Float32Array(i).subarray(e,e+s)):(i=i instanceof ArrayBuffer?new Uint8Array(i,e,s):new Uint8Array(i.buffer,i.byteOffset+e,s),this.lo.bufferSubData(this.lo.ARRAY_BUFFER,0,i)),this.Qo()};class Rs extends Ei{constructor(t,i,e,s=!1){if(super(t,i,e,s),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=new Array,this.pg=new Array,this.onNewSceneAddedObservable=new h,this.postProcesses=new Array,this.isPointerLock=!1,this.onResizeObservable=new h,this.onCanvasBlurObservable=new h,this.onCanvasFocusObservable=new h,this.onCanvasPointerOutObservable=new h,this.onBeginFrameObservable=new h,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new h,this.onBeforeShaderCompilationObservable=new h,this.onAfterShaderCompilationObservable=new h,this.Cw=!1,this.ww=4,this.xw=1/60,this.Tw=60,this.Rw=0,this.Iw=new Ne,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this.Mw=new ws,this.bw=!0,this.currentRenderPassId=0,this._w=["main"],Rs.Instances.push(this),t){if(this.hs.supportRenderPasses=!0,e=this.Jh,t.getContext){const i=t;this.yo(i,!!e.doNotHandleTouchAction,e.audioEngine),Rt()&&(this.yw=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this.Nw&&i&&Rs.Pw(i)},document.addEventListener("fullscreenchange",this.yw,!1),document.addEventListener("webkitfullscreenchange",this.yw,!1),this.Dw=()=>{this.isPointerLock=document.pointerLockElement===i},document.addEventListener("pointerlockchange",this.Dw,!1),document.addEventListener("webkitpointerlockchange",this.Dw,!1),!Rs.audioEngine&&e.audioEngine&&Rs.AudioEngineFactory&&(Rs.audioEngine=Rs.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))),this.Lw(),this.enableOfflineSupport=void 0!==Rs.OfflineProviderFactory,this.Cw=!!e.deterministicLockstep,this.ww=e.lockstepMaxSteps||0,this.xw=e.timeStep||1/60}this.Ow(),e.autoEnableWebVR&&this.initWebVR()}}static get NpmPackage(){return Ei.NpmPackage}static get Version(){return Ei.Version}static get Instances(){return E.Instances}static get LastCreatedEngine(){return E.LastCreatedEngine}static get LastCreatedScene(){return E.LastCreatedScene}Fw(t,i){return new Promise(((e,s)=>{const n=new Image;n.onload=()=>{n.decode().then((()=>{this.createImageBitmap(n,i).then((t=>{e(t)}))}))},n.onerror=()=>{s(`Error loading image ${n.src}`)},n.src=t}))}createImageBitmap(t,i){return createImageBitmap(t,i)}resizeImageBitmap(t,i,e){const s=this.createCanvas(i,e).getContext("2d");if(!s)throw new Error("Unable to get 2d context for resizeImageBitmap");s.drawImage(t,0,0);return s.getImageData(0,0,i,e).data}static MarkAllMaterialsAsDirty(t,i){for(let e=0;e<Rs.Instances.length;e++){const s=Rs.Instances[e];for(let e=0;e<s.scenes.length;e++)s.scenes[e].markAllMaterialsAsDirty(t,i)}}static DefaultLoadingScreenFactory(t){throw X("LoadingScreen")}get vo(){return!!Rs.Bw}get performanceMonitor(){return this.Mw}get compatibilityMode(){return this.bw}set compatibilityMode(t){this.bw=!0}getInputElement(){return this.io}ao(){super.ao(),this.Uw=null}yo(t,i,e){super.yo(t,i,e),this.Vw=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this.kw=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this.Gw=t=>{this.disableContextMenu&&t.preventDefault()},t.addEventListener("focus",this.Vw),t.addEventListener("blur",this.kw),t.addEventListener("contextmenu",this.Gw),this.Hw=()=>{this.disablePerformanceMonitorInBackground&&this.Mw.disable(),this.oh=!0},this.Xw=()=>{this.disablePerformanceMonitorInBackground&&this.Mw.enable(),this.oh=!1},this.Ww=i=>{document.elementFromPoint(i.clientX,i.clientY)!==t&&this.onCanvasPointerOutObservable.notifyObservers(i)};const s=this.getHostWindow();s&&"function"==typeof s.addEventListener&&(s.addEventListener("blur",this.Hw),s.addEventListener("focus",this.Xw)),t.addEventListener("pointerout",this.Ww),i||this.$w(),!Rs.audioEngine&&e&&Rs.AudioEngineFactory&&(Rs.audioEngine=Rs.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))}getAspectRatio(t,i=!1){const e=t.viewport;return this.getRenderWidth(i)*e.width/(this.getRenderHeight(i)*e.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this.io?this.io.getBoundingClientRect():null}getInputElementClientRect(){return this.io?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this.Cw}getLockstepMaxSteps(){return this.ww}getTimeStep(){return 1e3*this.xw}generateMipMapsForCubemap(t,i=!0){if(t.generateMipMaps){const e=this.lo;this.qo(e.TEXTURE_CUBE_MAP,t,!0),e.generateMipmap(e.TEXTURE_CUBE_MAP),i&&this.qo(e.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this.Eh.depthMask}setDepthWrite(t){this.Eh.depthMask=t}getStencilBuffer(){return this.Ch.stencilTest}setStencilBuffer(t){this.Ch.stencilTest=t}getStencilMask(){return this.Ch.stencilMask}setStencilMask(t){this.Ch.stencilMask=t}getStencilFunction(){return this.Ch.stencilFunc}getStencilFunctionReference(){return this.Ch.stencilFuncRef}getStencilFunctionMask(){return this.Ch.stencilFuncMask}setStencilFunction(t){this.Ch.stencilFunc=t}setStencilFunctionReference(t){this.Ch.stencilFuncRef=t}setStencilFunctionMask(t){this.Ch.stencilFuncMask=t}getStencilOperationFail(){return this.Ch.stencilOpStencilFail}getStencilOperationDepthFail(){return this.Ch.stencilOpDepthFail}getStencilOperationPass(){return this.Ch.stencilOpStencilDepthPass}setStencilOperationFail(t){this.Ch.stencilOpStencilFail=t}setStencilOperationDepthFail(t){this.Ch.stencilOpDepthFail=t}setStencilOperationPass(t){this.Ch.stencilOpStencilDepthPass=t}setDitheringState(t){t?this.lo.enable(this.lo.DITHER):this.lo.disable(this.lo.DITHER)}setRasterizerState(t){t?this.lo.disable(this.lo.RASTERIZER_DISCARD):this.lo.enable(this.lo.RASTERIZER_DISCARD)}getDepthFunction(){return this.Eh.depthFunc}setDepthFunction(t){this.Eh.depthFunc=t}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this.Yw=this.getStencilBuffer(),this.jw=this.getStencilFunction(),this.Kw=this.getStencilMask(),this.qw=this.getStencilOperationPass(),this.Qw=this.getStencilOperationFail(),this.Zw=this.getStencilOperationDepthFail(),this.Jw=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this.jw),this.setStencilMask(this.Kw),this.setStencilBuffer(this.Yw),this.setStencilOperationPass(this.qw),this.setStencilOperationFail(this.Qw),this.setStencilOperationDepthFail(this.Zw),this.setStencilFunctionReference(this.Jw)}setDirectViewport(t,i,e,s){const n=this.Eo;return this.Eo=null,this.Ho(t,i,e,s),n}scissorClear(t,i,e,s,n){this.enableScissor(t,i,e,s),this.clear(n,!0,!0,!0),this.disableScissor()}enableScissor(t,i,e,s){const n=this.lo;n.enable(n.SCISSOR_TEST),n.scissor(t,i,e,s)}disableScissor(){const t=this.lo;t.disable(t.SCISSOR_TEST)}da(t=1){this.Iw.addCount(t,!1)}initWebVR(){throw X("WebVRCamera")}Ow(){}Lw(t,i){}tx(){}disableVR(){}isVRPresenting(){return!1}ix(){}OS(t,i,e){return new Promise(((s,n)=>{this.tn(t,(t=>{s(t)}),void 0,i,e,((t,i)=>{n(i)}))}))}getVertexShaderSource(t){const i=this.lo.getAttachedShaders(t);return i?this.lo.getShaderSource(i[0]):null}getFragmentShaderSource(t){const i=this.lo.getAttachedShaders(t);return i?this.lo.getShaderSource(i[1]):null}setDepthStencilTexture(t,i,e,s){void 0!==t&&(i&&(this.Zh[t]=i),e&&e.depthStencilTexture?this.Za(t,e,!1,!0,s):this.Za(t,null,void 0,void 0,s))}setTextureFromPostProcess(t,i,e){var s;let n=null;i&&(i.sx.data[i.nx]?n=i.sx.data[i.nx]:i.hx&&(n=i.hx)),this.fn(t,null!==(s=null==n?void 0:n.texture)&&void 0!==s?s:null,e)}setTextureFromPostProcessOutput(t,i,e){var s,n;this.fn(t,null!==(n=null===(s=null==i?void 0:i.Ef)||void 0===s?void 0:s.texture)&&void 0!==n?n:null,e)}Mo(){for(const t of this.scenes)t.resetCachedMaterial(),t.NS(),t.PS();for(const t of this.pg)t.resetCachedMaterial(),t.NS(),t.PS();super.Mo()}ox(){for(let t=0;t<this.dh.length;t++){(0,this.dh[t])()}}Uo(){if(!this.ph){let t=!0;!this.renderEvenInBackground&&this.oh&&(t=!1),t&&(this.beginFrame(),this.lx()||this.ox(),this.endFrame())}this.dh.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this.ko(this.customAnimationFrameRequester.renderFunction||this.Go,this.customAnimationFrameRequester),this.Vo=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this.ix():this.Vo=this.ko(this.Go,this.getHostWindow()):this.fh=!1}lx(){return!1}switchFullscreen(t){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(t)}enterFullscreen(t){this.isFullscreen||(this.Nw=t,this.io&&Rs.ux(this.io))}exitFullscreen(){this.isFullscreen&&Rs.mx()}enterPointerlock(){this.io&&Rs.Pw(this.io)}exitPointerlock(){Rs.vx()}beginFrame(){this.gx(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this.tx(),this.onEndFrameObservable.notifyObservers(this)}resize(t=!1){this.isVRPresenting()||super.resize(t)}setSize(t,i,e=!1){if(!this.io)return!1;if(!super.setSize(t,i,e))return!1;if(this.scenes){for(let t=0;t<this.scenes.length;t++){const i=this.scenes[t];for(let t=0;t<i.cameras.length;t++){i.cameras[t].Ai=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}cn(t){const i=t;i&&i.program&&i.transformFeedback&&(this.deleteTransformFeedback(i.transformFeedback),i.transformFeedback=null),super.cn(t)}createShaderProgram(t,i,e,s,n,r=null){n=n||this.lo,this.onBeforeShaderCompilationObservable.notifyObservers(this);const h=super.createShaderProgram(t,i,e,s,n,r);return this.onAfterShaderCompilationObservable.notifyObservers(this),h}Ea(t,i,e,s,n=null){const r=s.createProgram();if(t.program=r,!r)throw new Error("Unable to create program");if(s.attachShader(r,i),s.attachShader(r,e),this.webGLVersion>1&&n){const i=this.createTransformFeedback();this.bindTransformFeedback(i),this.setTranformFeedbackVaryings(r,n),t.transformFeedback=i}return s.linkProgram(r),this.webGLVersion>1&&n&&this.bindTransformFeedback(null),t.context=s,t.vertexShader=i,t.fragmentShader=e,t.isParallelCompiled||this.Aa(t),r}Nr(t){super.Nr(t)}ja(t){super.ja(t),this.scenes.forEach((i=>{i.postProcesses.forEach((i=>{i.Ef===t&&(i.Ef=null)})),i.cameras.forEach((i=>{i.vf.forEach((i=>{i&&i.Ef===t&&(i.Ef=null)}))}))}))}getRenderPassNames(){return this._w}getCurrentRenderPassName(){return this._w[this.currentRenderPassId]}createRenderPassId(t){const i=++Rs.Sx;return this._w[i]=null!=t?t:"NONAME",i}releaseRenderPassId(t){this._w[t]=void 0;for(let i=0;i<this.scenes.length;++i){const e=this.scenes[i];for(let i=0;i<e.meshes.length;++i){const s=e.meshes[i];if(s.subMeshes)for(let i=0;i<s.subMeshes.length;++i){s.subMeshes[i].gC(t)}}}}Da(t,i,e,s,n){this.lo.texParameteri(this.lo.TEXTURE_2D,this.lo.TEXTURE_MAG_FILTER,this.lo.LINEAR),this.lo.texParameteri(this.lo.TEXTURE_2D,this.lo.TEXTURE_MIN_FILTER,this.lo.LINEAR),this.lo.texParameteri(this.lo.TEXTURE_2D,this.lo.TEXTURE_WRAP_S,this.lo.CLAMP_TO_EDGE),this.lo.texParameteri(this.lo.TEXTURE_2D,this.lo.TEXTURE_WRAP_T,this.lo.CLAMP_TO_EDGE);const r=this.createRenderTargetTexture({width:i.width,height:i.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this.Uw&&Rs.Bw&&(this.Uw=Rs.Bw(this)),this.Uw&&(this.Uw.externalTextureSamplerBinding=!0,this.Uw.getEffect().executeWhenCompiled((()=>{this.Uw.onApply=function(i){i.fn("textureSampler",t)};let h=e;h||(h=this.scenes[this.scenes.length-1]),h.postProcessManager.directRender([this.Uw],r,!0),this.qo(this.lo.TEXTURE_2D,i,!0),this.lo.copyTexImage2D(this.lo.TEXTURE_2D,0,s,0,0,i.width,i.height,0),this.unBindFramebuffer(r),r.dispose(),n&&n()})))}getFps(){return this.Tw}getDeltaTime(){return this.Rw}gx(){this.Mw.sampleFrame(),this.Tw=this.Mw.averageFPS,this.Rw=this.Mw.instantaneousFrameTime||0}wrapWebGLTexture(t){const i=new mi(t,this.lo),e=new ai(this,oi.Unknown,!0);return e.Er=i,e.isReady=!0,e}Ex(t,i,e=0,s=0){const n=this.lo,r=this.Ma(t.type),h=this.Ia(t.format),o=this.Ra(t.type,h),a=t.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this.qo(a,t,!0),this.La(t.invertY);let l=n.TEXTURE_2D;t.isCube&&(l=n.TEXTURE_CUBE_MAP_POSITIVE_X+e),n.texImage2D(l,s,o,h,r,i),this.qo(a,null,!0)}updateTextureComparisonFunction(t,i){if(1===this.webGLVersion)return void F.Error("WebGL 1 does not support texture comparison.");const e=this.lo;t.isCube?(this.qo(this.lo.TEXTURE_CUBE_MAP,t,!0),0===i?(e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_COMPARE_FUNC,515),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_COMPARE_MODE,e.NONE)):(e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_COMPARE_FUNC,i),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE)),this.qo(this.lo.TEXTURE_CUBE_MAP,null)):(this.qo(this.lo.TEXTURE_2D,t,!0),0===i?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_COMPARE_FUNC,515),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_COMPARE_MODE,e.NONE)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_COMPARE_FUNC,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE)),this.qo(this.lo.TEXTURE_2D,null)),t.Hn=i}createInstancesBuffer(t){const i=this.lo.createBuffer();if(!i)throw new Error("Unable to create instance buffer");const e=new fi(i);return e.capacity=t,this.bindArrayBuffer(e),this.lo.bufferData(this.lo.ARRAY_BUFFER,t,this.lo.DYNAMIC_DRAW),e.references=1,e}deleteInstancesBuffer(t){this.lo.deleteBuffer(t)}Ax(t,i=0,e=10){const s=this.lo;return new Promise(((n,r)=>{const h=()=>{const o=s.clientWaitSync(t,i,0);o!=s.WAIT_FAILED?o!=s.TIMEOUT_EXPIRED?n():setTimeout(h,e):r()};h()}))}Cx(t,i,e,s,n,r,h){if(this.hh<2)throw new Error("_readPixelsAsync only work on WebGL2+");const o=this.lo,a=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,a),o.bufferData(o.PIXEL_PACK_BUFFER,h.byteLength,o.STREAM_READ),o.readPixels(t,i,e,s,n,r,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null);const l=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);return l?(o.flush(),this.Ax(l,0,10).then((()=>(o.deleteSync(l),o.bindBuffer(o.PIXEL_PACK_BUFFER,a),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,h),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),o.deleteBuffer(a),h)))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this.Uw&&this.Uw.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this.pg.length;)this.pg[0].dispose();1===Rs.Instances.length&&Rs.audioEngine&&(Rs.audioEngine.dispose(),Rs.audioEngine=null),this.disableVR();const t=this.getHostWindow();t&&"function"==typeof t.removeEventListener&&(t.removeEventListener("blur",this.Hw),t.removeEventListener("focus",this.Xw)),this.io&&(this.io.removeEventListener("focus",this.Vw),this.io.removeEventListener("blur",this.kw),this.io.removeEventListener("pointerout",this.Ww),this.io.removeEventListener("contextmenu",this.Gw)),Rt()&&(document.removeEventListener("fullscreenchange",this.yw),document.removeEventListener("mozfullscreenchange",this.yw),document.removeEventListener("webkitfullscreenchange",this.yw),document.removeEventListener("msfullscreenchange",this.yw),document.removeEventListener("pointerlockchange",this.Dw),document.removeEventListener("mspointerlockchange",this.Dw),document.removeEventListener("mozpointerlockchange",this.Dw),document.removeEventListener("webkitpointerlockchange",this.Dw)),super.dispose();const i=Rs.Instances.indexOf(this);i>=0&&Rs.Instances.splice(i,1),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}$w(){this.io&&this.io.setAttribute&&(this.io.setAttribute("touch-action","none"),this.io.style.touchAction="none",this.io.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!xt())return;const t=this.loadingScreen;t&&t.displayLoadingUI()}hideLoadingUI(){if(!xt())return;const t=this.wx;t&&t.hideLoadingUI()}get loadingScreen(){return!this.wx&&this.io&&(this.wx=Rs.DefaultLoadingScreenFactory(this.io)),this.wx}set loadingScreen(t){this.wx=t}set loadingUIText(t){this.loadingScreen.loadingUIText=t}set loadingUIBackgroundColor(t){this.loadingScreen.loadingUIBackgroundColor=t}createVideoElement(t){return document.createElement("video")}static Pw(t){t.requestPointerLock&&(t.requestPointerLock(),t.focus())}static vx(){document.exitPointerLock&&document.exitPointerLock()}static ux(t){const i=t.requestFullscreen||t.webkitRequestFullscreen;i&&i.call(t)}static mx(){const t=document;document.exitFullscreen?document.exitFullscreen():t.webkitCancelFullScreen&&t.webkitCancelFullScreen()}getFontOffset(t){const i=document.createElement("span");i.innerHTML="Hg",i.setAttribute("style",`font: ${t} !important`);const e=document.createElement("div");e.style.display="inline-block",e.style.width="1px",e.style.height="0px",e.style.verticalAlign="bottom";const s=document.createElement("div");s.style.whiteSpace="nowrap",s.appendChild(i),s.appendChild(e),document.body.appendChild(s);let n=0,r=0;try{r=e.getBoundingClientRect().top-i.getBoundingClientRect().top,e.style.verticalAlign="baseline",n=e.getBoundingClientRect().top-i.getBoundingClientRect().top}finally{document.body.removeChild(s)}return{ascent:n,height:r,descent:r-n}}}Rs.ALPHA_DISABLE=0,Rs.ALPHA_ADD=1,Rs.ALPHA_COMBINE=2,Rs.ALPHA_SUBTRACT=3,Rs.ALPHA_MULTIPLY=4,Rs.ALPHA_MAXIMIZED=5,Rs.ALPHA_ONEONE=6,Rs.ALPHA_PREMULTIPLIED=7,Rs.ALPHA_PREMULTIPLIED_PORTERDUFF=8,Rs.ALPHA_INTERPOLATE=9,Rs.ALPHA_SCREENMODE=10,Rs.DELAYLOADSTATE_NONE=0,Rs.DELAYLOADSTATE_LOADED=1,Rs.DELAYLOADSTATE_LOADING=2,Rs.DELAYLOADSTATE_NOTLOADED=4,Rs.NEVER=512,Rs.ALWAYS=519,Rs.LESS=513,Rs.EQUAL=514,Rs.LEQUAL=515,Rs.GREATER=516,Rs.GEQUAL=518,Rs.NOTEQUAL=517,Rs.KEEP=7680,Rs.REPLACE=7681,Rs.INCR=7682,Rs.DECR=7683,Rs.INVERT=5386,Rs.INCR_WRAP=34055,Rs.DECR_WRAP=34056,Rs.TEXTURE_CLAMP_ADDRESSMODE=0,Rs.TEXTURE_WRAP_ADDRESSMODE=1,Rs.TEXTURE_MIRROR_ADDRESSMODE=2,Rs.TEXTUREFORMAT_ALPHA=0,Rs.TEXTUREFORMAT_LUMINANCE=1,Rs.TEXTUREFORMAT_LUMINANCE_ALPHA=2,Rs.TEXTUREFORMAT_RGB=4,Rs.TEXTUREFORMAT_RGBA=5,Rs.TEXTUREFORMAT_RED=6,Rs.TEXTUREFORMAT_R=6,Rs.TEXTUREFORMAT_RG=7,Rs.TEXTUREFORMAT_RED_INTEGER=8,Rs.TEXTUREFORMAT_R_INTEGER=8,Rs.TEXTUREFORMAT_RG_INTEGER=9,Rs.TEXTUREFORMAT_RGB_INTEGER=10,Rs.TEXTUREFORMAT_RGBA_INTEGER=11,Rs.TEXTURETYPE_UNSIGNED_BYTE=0,Rs.TEXTURETYPE_UNSIGNED_INT=0,Rs.TEXTURETYPE_FLOAT=1,Rs.TEXTURETYPE_HALF_FLOAT=2,Rs.TEXTURETYPE_BYTE=3,Rs.TEXTURETYPE_SHORT=4,Rs.TEXTURETYPE_UNSIGNED_SHORT=5,Rs.TEXTURETYPE_INT=6,Rs.TEXTURETYPE_UNSIGNED_INTEGER=7,Rs.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,Rs.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,Rs.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,Rs.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,Rs.TEXTURETYPE_UNSIGNED_INT_24_8=12,Rs.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,Rs.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,Rs.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,Rs.TEXTURE_NEAREST_SAMPLINGMODE=1,Rs.TEXTURE_BILINEAR_SAMPLINGMODE=2,Rs.TEXTURE_TRILINEAR_SAMPLINGMODE=3,Rs.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,Rs.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,Rs.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,Rs.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,Rs.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,Rs.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,Rs.TEXTURE_NEAREST_LINEAR=7,Rs.TEXTURE_NEAREST_NEAREST=1,Rs.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,Rs.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,Rs.TEXTURE_LINEAR_LINEAR=2,Rs.TEXTURE_LINEAR_NEAREST=12,Rs.TEXTURE_EXPLICIT_MODE=0,Rs.TEXTURE_SPHERICAL_MODE=1,Rs.TEXTURE_PLANAR_MODE=2,Rs.TEXTURE_CUBIC_MODE=3,Rs.TEXTURE_PROJECTION_MODE=4,Rs.TEXTURE_SKYBOX_MODE=5,Rs.TEXTURE_INVCUBIC_MODE=6,Rs.TEXTURE_EQUIRECTANGULAR_MODE=7,Rs.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,Rs.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,Rs.SCALEMODE_FLOOR=1,Rs.SCALEMODE_NEAREST=2,Rs.SCALEMODE_CEILING=3,Rs.Bw=null,Rs.Sx=0;class Is extends dt{constructor(t,i=null,e=!0){super(t,i),this.Tx=new w(0,0,1),this.Rx=new w(0,1,0),this.Ix=new w(1,0,0),this.rA=w.Zero(),this.Mx=w.Zero(),this.bx=null,this._x=w.One(),this.yx=null,this.Nx=!1,this.Px=Is.BILLBOARDMODE_NONE,this.Dx=!1,this.scalingDeterminant=1,this.Lx=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this.Ox=null,this.qS=R.Zero(),this.Fx=!1,this.Bx=w.Zero(),this.Ux=w.Zero(),this.Vx=T.Identity(),this.kx=R.Identity(),this.Gx=!1,this.Hx=!1,this.Hg=-1,this.onAfterWorldMatrixUpdateObservable=new h,this.Xx=!1,e&&this.getScene().addTransformNode(this)}get billboardMode(){return this.Px}set billboardMode(t){this.Px!==t&&(this.Px=t)}get preserveParentRotationForBillboard(){return this.Dx}set preserveParentRotationForBillboard(t){t!==this.Dx&&(this.Dx=t)}get infiniteDistance(){return this.Lx}set infiniteDistance(t){this.Lx!==t&&(this.Lx=t)}getClassName(){return"TransformNode"}get position(){return this.rA}set position(t){this.rA=t,this.F=!0}isUsingPivotMatrix(){return this.Fx}get rotation(){return this.Mx}set rotation(t){this.Mx=t,this.bx=null,this.F=!0}get scaling(){return this._x}set scaling(t){this._x=t,this.F=!0}get rotationQuaternion(){return this.bx}set rotationQuaternion(t){this.bx=t,t&&this.Mx.setAll(0),this.F=!0}get forward(){return w.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this.Tx),this.Tx.normalize()}get up(){return w.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this.Rx),this.Rx.normalize()}get right(){return w.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this.Ix),this.Ix.normalize()}updatePoseMatrix(t){return this.Ox?(this.Ox.copyFrom(t),this):(this.Ox=t.clone(),this)}getPoseMatrix(){return this.Ox||(this.Ox=R.Identity()),this.Ox}Wi(){const t=this.Ii;return this.Px===t.billboardMode&&this.Px===Is.BILLBOARDMODE_NONE&&(!t.pivotMatrixUpdated&&(!this.Lx&&(!this.rA.F&&(!this._x.F&&!(this.bx&&this.bx.F||this.Mx.F)))))}Fi(){super.Fi();const t=this.Ii;t.localMatrixUpdated=!1,t.billboardMode=-1,t.infiniteDistance=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this.Wx(),this.Ux}get absoluteRotationQuaternion(){return this.Wx(),this.Vx}setPreTransformMatrix(t){return this.setPivotMatrix(t,!1)}setPivotMatrix(t,i=!0){return this.kx.copyFrom(t),this.Fx=!this.kx.isIdentity(),this.Ii.pivotMatrixUpdated=!0,this.Gx=i,this.Gx&&(this.$x?this.kx.invertToRef(this.$x):this.$x=R.Invert(this.kx)),this}getPivotMatrix(){return this.kx}instantiateHierarchy(t=null,i,e){const s=this.clone("Clone of "+(this.name||this.id),t||this.parent,!0);s&&e&&e(this,s);for(const t of this.getChildTransformNodes(!0))t.instantiateHierarchy(s,i,e);return s}freezeWorldMatrix(t=null,i=!1){return t?i?(this.Mx.setAll(0),this.bx=this.bx||T.Identity(),t.decompose(this._x,this.bx,this.rA),this.computeWorldMatrix(!0)):(this._i=t,this.Bx.copyFromFloats(this._i.m[12],this._i.m[13],this._i.m[14]),this.Yx()):(this.Hx=!1,this.computeWorldMatrix(!0)),this.F=!1,this.Hx=!0,this}unfreezeWorldMatrix(){return this.Hx=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this.Hx}getAbsolutePosition(){return this.computeWorldMatrix(),this.Bx}setAbsolutePosition(t){if(!t)return this;let i,e,s;if(void 0===t.x){if(arguments.length<3)return this;i=arguments[0],e=arguments[1],s=arguments[2]}else i=t.x,e=t.y,s=t.z;if(this.parent){const t=M.Matrix[0];this.parent.getWorldMatrix().invertToRef(t),w.TransformCoordinatesFromFloatsToRef(i,e,s,t,this.position)}else this.position.x=i,this.position.y=e,this.position.z=s;return this.Bx.copyFrom(t),this}setPositionWithLocalVector(t){return this.computeWorldMatrix(),this.position=w.TransformNormal(t,this.qS),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const t=M.Matrix[0];return this.qS.invertToRef(t),w.TransformNormal(this.position,t)}locallyTranslate(t){return this.computeWorldMatrix(!0),this.position=w.TransformCoordinates(t,this.qS),this}lookAt(t,i=0,e=0,s=0,n=Be.LOCAL){const r=Is.jx,h=n===Be.LOCAL?this.position:this.getAbsolutePosition();if(t.subtractToRef(h,r),this.setDirection(r,i,e,s),n===Be.WORLD&&this.parent)if(this.rotationQuaternion){const t=M.Matrix[0];this.rotationQuaternion.toRotationMatrix(t);const i=M.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(i),i.invert(),t.multiplyToRef(i,t),this.rotationQuaternion.fromRotationMatrix(t)}else{const t=M.Quaternion[0];T.FromEulerVectorToRef(this.rotation,t);const i=M.Matrix[0];t.toRotationMatrix(i);const e=M.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(e),e.invert(),i.multiplyToRef(e,i),t.fromRotationMatrix(i),t.toEulerAnglesToRef(this.rotation)}return this}getDirection(t){const i=w.Zero();return this.getDirectionToRef(t,i),i}getDirectionToRef(t,i){return w.TransformNormalToRef(t,this.getWorldMatrix(),i),this}setDirection(t,i=0,e=0,s=0){const n=-Math.atan2(t.z,t.x)+Math.PI/2,r=Math.sqrt(t.x*t.x+t.z*t.z),h=-Math.atan2(t.y,r);return this.rotationQuaternion?T.RotationYawPitchRollToRef(n+i,h+e,s,this.rotationQuaternion):(this.rotation.x=h+e,this.rotation.y=n+i,this.rotation.z=s),this}setPivotPoint(t,i=Be.LOCAL){0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);const e=this.getWorldMatrix();if(i==Be.WORLD){const i=M.Matrix[0];e.invertToRef(i),t=w.TransformCoordinates(t,i)}return this.setPivotMatrix(R.Translation(-t.x,-t.y,-t.z),!0)}getPivotPoint(){const t=w.Zero();return this.getPivotPointToRef(t),t}getPivotPointToRef(t){return t.x=-this.kx.m[12],t.y=-this.kx.m[13],t.z=-this.kx.m[14],this}getAbsolutePivotPoint(){const t=w.Zero();return this.getAbsolutePivotPointToRef(t),t}getAbsolutePivotPointToRef(t){return this.getPivotPointToRef(t),w.TransformCoordinatesToRef(t,this.getWorldMatrix(),t),this}markAsDirty(t){if(this.F)return this;if(this.bi)for(const i of this.bi)i.markAsDirty(t);return super.markAsDirty(t)}setParent(t,i=!1,e=!1){if(!t&&!this.parent)return this;const s=M.Quaternion[0],n=M.Vector3[0],r=M.Vector3[1],h=M.Matrix[1];R.IdentityToRef(h);const o=M.Matrix[0];this.computeWorldMatrix(!0);let a=this.rotationQuaternion;return a||(a=Is.Kx,T.RotationYawPitchRollToRef(this.Mx.y,this.Mx.x,this.Mx.z,a)),R.ComposeToRef(this.scaling,a,this.position,o),this.parent&&o.multiplyToRef(this.parent.computeWorldMatrix(!0),o),t&&(t.computeWorldMatrix(!0).invertToRef(h),o.multiplyToRef(h,o)),o.decompose(r,s,n,i?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(r),this.position.copyFrom(n),this.parent=t,e&&this.setPivotMatrix(R.Identity()),this}get nonUniformScaling(){return this.Xx}qx(t){return this.Xx!==t&&(this.Xx=t,!0)}attachToBone(t,i){return this.Qx=this.parent,this.yx=i,this.parent=t,t.getSkeleton().prepare(),t.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(t=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this.yx=null,this.parent=t?this.Qx:null,this):(t&&(this.parent=this.Qx),this)}rotate(t,i,e){let s;if(t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0)),e&&e!==Be.LOCAL){if(this.parent){const i=M.Matrix[0];this.parent.getWorldMatrix().invertToRef(i),t=w.TransformNormal(t,i)}s=T.RotationAxisToRef(t,i,Is.Zx),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else s=T.RotationAxisToRef(t,i,Is.Zx),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion);return this}rotateAround(t,i,e){i.normalize(),this.rotationQuaternion||(this.rotationQuaternion=T.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const s=M.Vector3[0],n=M.Vector3[1],r=M.Vector3[2],h=M.Quaternion[0],o=M.Matrix[0],a=M.Matrix[1],l=M.Matrix[2],c=M.Matrix[3];return t.subtractToRef(this.position,s),R.TranslationToRef(s.x,s.y,s.z,o),R.TranslationToRef(-s.x,-s.y,-s.z,a),R.RotationAxisToRef(i,e,l),a.multiplyToRef(l,c),c.multiplyToRef(o,c),c.decompose(n,h,r),this.position.addInPlace(r),h.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(t,i,e){const s=t.scale(i);if(e&&e!==Be.LOCAL)this.setAbsolutePosition(this.getAbsolutePosition().add(s));else{const t=this.getPositionExpressedInLocalSpace().add(s);this.setPositionWithLocalVector(t)}return this}addRotation(t,i,e){let s;this.rotationQuaternion?s=this.rotationQuaternion:(s=M.Quaternion[1],T.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,s));const n=M.Quaternion[0];return T.RotationYawPitchRollToRef(i,t,e,n),s.multiplyInPlace(n),this.rotationQuaternion||s.toEulerAnglesToRef(this.rotation),this}Jx(){return this.parent}computeWorldMatrix(t){if(this.Hx&&!this.F)return this._i;const i=this.getScene().getRenderId();if(!this.F&&!t&&(this.Ai===i||this.isSynchronized()))return this.Ai=i,this._i;const e=this.getScene().activeCamera,s=0!=(this.Px&Is.BILLBOARDMODE_USE_POSITION),n=this.Px!==Is.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard;this.Hi();const r=this.Ii;r.pivotMatrixUpdated=!1,r.billboardMode=this.billboardMode,r.infiniteDistance=this.infiniteDistance,r.parent=this.Mi,this.Ai=i,this.wi+=1,this.F=!1,this.rA.F=!1,this.Mx.F=!1,this._x.F=!1;const h=this.Jx(),o=Is.tT;let a,l=this.rA;if(this.Lx&&!this.parent&&e){const t=e.getWorldMatrix(),i=new w(t.m[12],t.m[13],t.m[14]);l=Is.iT,l.copyFromFloats(this.rA.x+i.x,this.rA.y+i.y,this.rA.z+i.z)}if(o.copyFromFloats(this._x.x*this.scalingDeterminant,this._x.y*this.scalingDeterminant,this._x.z*this.scalingDeterminant),this.bx){if(this.bx.F=!1,a=this.bx,this.reIntegrateRotationIntoRotationQuaternion){this.rotation.lengthSquared()&&(this.bx.multiplyInPlace(T.RotationYawPitchRoll(this.Mx.y,this.Mx.x,this.Mx.z)),this.Mx.copyFromFloats(0,0,0))}}else a=Is.Kx,T.RotationYawPitchRollToRef(this.Mx.y,this.Mx.x,this.Mx.z,a);if(this.Fx){const t=M.Matrix[1];R.ScalingToRef(o.x,o.y,o.z,t);const i=M.Matrix[0];a.toRotationMatrix(i),this.kx.multiplyToRef(t,M.Matrix[4]),M.Matrix[4].multiplyToRef(i,this.qS),this.Gx&&this.qS.multiplyToRef(this.$x,this.qS),this.qS.addTranslationFromFloats(l.x,l.y,l.z)}else R.ComposeToRef(o,a,l,this.qS);if(h&&h.getWorldMatrix){if(t&&h.computeWorldMatrix(t),n){this.yx?h.getWorldMatrix().multiplyToRef(this.yx.getWorldMatrix(),M.Matrix[7]):M.Matrix[7].copyFrom(h.getWorldMatrix());const t=M.Vector3[5],i=M.Vector3[6],e=M.Quaternion[0];M.Matrix[7].decompose(i,e,t),R.ScalingToRef(i.x,i.y,i.z,M.Matrix[7]),M.Matrix[7].setTranslation(t),Is.BillboardUseParentOrientation&&(this.rA.applyRotationQuaternionToRef(e,t),this.qS.setTranslation(t)),this.qS.multiplyToRef(M.Matrix[7],this._i)}else this.yx?(this.qS.multiplyToRef(h.getWorldMatrix(),M.Matrix[6]),M.Matrix[6].multiplyToRef(this.yx.getWorldMatrix(),this._i)):this.qS.multiplyToRef(h.getWorldMatrix(),this._i);this.$i()}else this._i.copyFrom(this.qS);if(n&&e&&this.billboardMode&&!s){const t=M.Vector3[0];if(this._i.getTranslationToRef(t),M.Matrix[1].copyFrom(e.getViewMatrix()),M.Matrix[1].setTranslationFromFloats(0,0,0),M.Matrix[1].invertToRef(M.Matrix[0]),(this.billboardMode&Is.BILLBOARDMODE_ALL)!==Is.BILLBOARDMODE_ALL){M.Matrix[0].decompose(void 0,M.Quaternion[0],void 0);const t=M.Vector3[1];M.Quaternion[0].toEulerAnglesToRef(t),(this.billboardMode&Is.BILLBOARDMODE_X)!==Is.BILLBOARDMODE_X&&(t.x=0),(this.billboardMode&Is.BILLBOARDMODE_Y)!==Is.BILLBOARDMODE_Y&&(t.y=0),(this.billboardMode&Is.BILLBOARDMODE_Z)!==Is.BILLBOARDMODE_Z&&(t.z=0),R.RotationYawPitchRollToRef(t.y,t.x,t.z,M.Matrix[0])}this._i.setTranslationFromFloats(0,0,0),this._i.multiplyToRef(M.Matrix[0],this._i),this._i.setTranslation(M.Vector3[0])}else if(n&&e&&this.billboardMode&&s){const t=M.Vector3[0];this._i.getTranslationToRef(t);const i=e.globalPosition;this._i.invertToRef(M.Matrix[1]);const s=M.Vector3[1];w.TransformCoordinatesToRef(i,M.Matrix[1],s),s.normalize();const n=-Math.atan2(s.z,s.x)+Math.PI/2,r=Math.sqrt(s.x*s.x+s.z*s.z),h=-Math.atan2(s.y,r);if(T.RotationYawPitchRollToRef(n,h,0,M.Quaternion[0]),(this.billboardMode&Is.BILLBOARDMODE_ALL)!==Is.BILLBOARDMODE_ALL){const t=M.Vector3[1];M.Quaternion[0].toEulerAnglesToRef(t),(this.billboardMode&Is.BILLBOARDMODE_X)!==Is.BILLBOARDMODE_X&&(t.x=0),(this.billboardMode&Is.BILLBOARDMODE_Y)!==Is.BILLBOARDMODE_Y&&(t.y=0),(this.billboardMode&Is.BILLBOARDMODE_Z)!==Is.BILLBOARDMODE_Z&&(t.z=0),R.RotationYawPitchRollToRef(t.y,t.x,t.z,M.Matrix[0])}else R.FromQuaternionToRef(M.Quaternion[0],M.Matrix[0]);this._i.setTranslationFromFloats(0,0,0),this._i.multiplyToRef(M.Matrix[0],this._i),this._i.setTranslation(M.Vector3[0])}return this.ignoreNonUniformScaling?this.qx(!1):this._x.isNonUniformWithinEpsilon(1e-6)?this.qx(!0):h&&h.Xx?this.qx(h.Xx):this.qx(!1),this.Yx(),this.Bx.copyFromFloats(this._i.m[12],this._i.m[13],this._i.m[14]),this.Nx=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this.Ox||(this.Ox=R.Invert(this._i)),this.Ni=!0,this._i}resetLocalMatrix(t=!0){if(this.computeWorldMatrix(),t){const t=this.getChildren();for(let i=0;i<t.length;++i){const e=t[i];if(e){e.computeWorldMatrix();const t=M.Matrix[0];e.qS.multiplyToRef(this.qS,t);const i=M.Quaternion[0];t.decompose(e.scaling,i,e.position),e.rotationQuaternion?e.rotationQuaternion.copyFrom(i):i.toEulerAnglesToRef(e.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=T.Identity()),this._i=R.Identity()}Yx(){}registerAfterWorldMatrixUpdate(t){return this.onAfterWorldMatrixUpdateObservable.add(t),this}unregisterAfterWorldMatrixUpdate(t){return this.onAfterWorldMatrixUpdateObservable.removeCallback(t),this}getPositionInCameraSpace(t=null){return t||(t=this.getScene().activeCamera),w.TransformCoordinates(this.getAbsolutePosition(),t.getViewMatrix())}getDistanceToCamera(t=null){return t||(t=this.getScene().activeCamera),this.getAbsolutePosition().subtract(t.globalPosition).length()}clone(t,i,e){const s=ot.Clone((()=>new Is(t,this.getScene())),this);if(s.name=t,s.id=t,i&&(s.parent=i),!e){const i=this.getDescendants(!0);for(let e=0;e<i.length;e++){const n=i[e];n.clone&&n.clone(t+"."+n.name,s)}}return s}serialize(t){const i=ot.Serialize(this,t);return i.type=this.getClassName(),i.uniqueId=this.uniqueId,this.parent&&this.parent.Gi(i),i.localMatrix=this.getPivotMatrix().asArray(),i.isEnabled=this.isEnabled(),i}static Parse(t,i,e){const s=ot.Parse((()=>new Is(t.name,i)),t,i,e);return t.localMatrix?s.setPreTransformMatrix(R.FromArray(t.localMatrix)):t.pivotMatrix&&s.setPivotMatrix(R.FromArray(t.pivotMatrix)),s.setEnabled(t.isEnabled),s.Ri=t.uniqueId,void 0!==t.parentId&&(s.xi=t.parentId),void 0!==t.parentInstanceIndex&&(s.Ti=t.parentInstanceIndex),s}getChildTransformNodes(t,i){const e=[];return this.Yi(e,t,(t=>(!i||i(t))&&t instanceof Is)),e}dispose(t,i=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this.Si){const t=this.Si.transformNodes.indexOf(this);t>-1&&this.Si.transformNodes.splice(t,1),this.Si=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),t){const t=this.getChildTransformNodes(!0);for(const i of t)i.parent=null,i.computeWorldMatrix(!0)}super.dispose(t,i)}normalizeToUnitCube(t=!0,i=!1,e){let s=null,n=null;i&&(this.rotationQuaternion?(n=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(s=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const r=this.getHierarchyBoundingVectors(t,e),h=r.max.subtract(r.min),o=Math.max(h.x,h.y,h.z);if(0===o)return this;const a=1/o;return this.scaling.scaleInPlace(a),i&&(this.rotationQuaternion&&n?this.rotationQuaternion.copyFrom(n):this.rotation&&s&&this.rotation.copyFrom(s)),this}Wx(){this.Nx||(this._i.decompose(this.Ux,this.Vx),this.Nx=!0)}}Is.BILLBOARDMODE_NONE=0,Is.BILLBOARDMODE_X=1,Is.BILLBOARDMODE_Y=2,Is.BILLBOARDMODE_Z=4,Is.BILLBOARDMODE_ALL=7,Is.BILLBOARDMODE_USE_POSITION=128,Is.BillboardUseParentOrientation=!1,Is.Kx=T.Zero(),Is.tT=w.Zero(),Is.iT=w.Zero(),Is.jx=new w(0,0,0),Is.Zx=new T,ut([et("position")],Is.prototype,"_position",void 0),ut([et("rotation")],Is.prototype,"_rotation",void 0),ut([function(t){return K(10,t)}("rotationQuaternion")],Is.prototype,"_rotationQuaternion",void 0),ut([et("scaling")],Is.prototype,"_scaling",void 0),ut([Q("billboardMode")],Is.prototype,"_billboardMode",void 0),ut([Q()],Is.prototype,"scalingDeterminant",void 0),ut([Q("infiniteDistance")],Is.prototype,"_infiniteDistance",void 0),ut([Q()],Is.prototype,"ignoreNonUniformScaling",void 0),ut([Q()],Is.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);class Ms{constructor(){this.eT=!1,this.sT=-1,this.nT=-1,this.rT=null,this.hT=null,this.oT=new w(0,0,0),this.aT=new w(0,0,0),this.lT=!0}}class bs{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=w.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class _s{constructor(){this.cT=!1,this.uT=!0,this.fT=4,this.dT=!0,this.pT=!1,this.mT=new bs,this.vT=1,this.KS=null,this.gT=268435455,this.ST=!0,this.tS=!1,this.oS=!1,this.ET=!1,this.AT=!1,this.hS=!1,this.sS=null,this.eS=!1,this.CT=3,this.wT=null,this.xT=0,this.TT=null,this.IT=null,this.QC=null,this.bm=!1,this.MT=new Ms,this.bT=!1}}class ys extends Is{constructor(t,i=null){switch(super(t,i,!1),this._m=new _s,this._T=null,this.cullingStrategy=ys.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new h,this.onCollisionPositionChangeObservable=new h,this.onMaterialChangedObservable=new h,this.definedFacingForward=!0,this.yT=null,this.Wf=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=_.Red(),this.outlineWidth=.02,this.overlayColor=_.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new w(.5,1,.5),this.ellipsoidOffset=new w(0,0,0),this.edgesWidth=1,this.edgesColor=new y(1,0,0,1),this.$f=null,this.NT=null,this.CC=null,this.PT=!0,this.Sv=0,this.IS=new Array,this.IC=!1,this.DT=new Array,this.OT={lods:null,actions:null,freezeWorldMatrix:null},this.FT=null,this.BT=null,this.onRebuildObservable=new h,this.UT=(t,i,e=null)=>{i.subtractToRef(this._m.MT.oT,this._m.MT.aT),this._m.MT.aT.length()>Rs.CollisionsEpsilon&&this.position.addInPlace(this._m.MT.aT),e&&this.onCollideObservable.notifyObservers(e),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},(i=this.getScene()).addMesh(this),this.zg(),this.VT=new ne(this.getScene().getEngine(),void 0,void 0,t,!this.getScene().getEngine().isWebGPU),this.kT(),i.performancePriority){case Fe.Aggressive:this.doNotSyncBoundingInfo=!0;case Fe.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1}}static get BILLBOARDMODE_NONE(){return Is.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return Is.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return Is.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return Is.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return Is.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return Is.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._m.mT.facetNb}get partitioningSubdivisions(){return this._m.mT.partitioningSubdivisions}set partitioningSubdivisions(t){this._m.mT.partitioningSubdivisions=t}get partitioningBBoxRatio(){return this._m.mT.partitioningBBoxRatio}set partitioningBBoxRatio(t){this._m.mT.partitioningBBoxRatio=t}get mustDepthSortFacets(){return this._m.mT.facetDepthSort}set mustDepthSortFacets(t){this._m.mT.facetDepthSort=t}get facetDepthSortFrom(){return this._m.mT.facetDepthSortFrom}set facetDepthSortFrom(t){this._m.mT.facetDepthSortFrom=t}get collisionRetryCount(){return this._m.CT}set collisionRetryCount(t){this._m.CT=t}get isFacetDataEnabled(){return this._m.mT.facetDataEnabled}get morphTargetManager(){return this._m.wT}set morphTargetManager(t){this._m.wT!==t&&(this._m.wT=t,this.JC())}get bakedVertexAnimationManager(){return this._m.TT}set bakedVertexAnimationManager(t){this._m.TT!==t&&(this._m.TT=t,this.tw())}JC(){}qx(t){return!!super.qx(t)&&(this.GT(),!0)}set onCollide(t){this._m.MT.zT&&this.onCollideObservable.remove(this._m.MT.zT),this._m.MT.zT=this.onCollideObservable.add(t)}set onCollisionPositionChange(t){this._m.MT.HT&&this.onCollisionPositionChangeObservable.remove(this._m.MT.HT),this._m.MT.HT=this.onCollisionPositionChangeObservable.add(t)}get visibility(){return this._m.vT}set visibility(t){if(this._m.vT===t)return;const i=this._m.vT;this._m.vT=t,(1===i&&1!==t||1!==i&&1===t)&&this.GT()}get pointerOverDisableMeshTesting(){return this._m.bm}set pointerOverDisableMeshTesting(t){this._m.bm=t}get renderingGroupId(){return this._m.xT}set renderingGroupId(t){this._m.xT=t}get material(){return this._m.IT}set material(t){this._m.IT!==t&&(this._m.IT&&this._m.IT.meshMap&&(this._m.IT.meshMap[this.uniqueId]=void 0),this._m.IT=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this.XT()))}getMaterialForRenderPass(t){var i;return null===(i=this._m.WT)||void 0===i?void 0:i[t]}setMaterialForRenderPass(t,i){this.resetDrawCache(t),this._m.WT||(this._m.WT=[]),this._m.WT[t]=i}get receiveShadows(){return this._m.pT}set receiveShadows(t){this._m.pT!==t&&(this._m.pT=t,this.$T())}get hasVertexAlpha(){return this._m.cT}set hasVertexAlpha(t){this._m.cT!==t&&(this._m.cT=t,this.tw(),this.GT())}get useVertexColors(){return this._m.uT}set useVertexColors(t){this._m.uT!==t&&(this._m.uT=t,this.tw())}get computeBonesUsingShaders(){return this._m.ST}set computeBonesUsingShaders(t){this._m.ST!==t&&(this._m.ST=t,this.tw())}get numBoneInfluencers(){return this._m.fT}set numBoneInfluencers(t){this._m.fT!==t&&(this._m.fT=t,this.tw())}get applyFog(){return this._m.dT}set applyFog(t){this._m.dT!==t&&(this._m.dT=t,this.GT())}get enableDistantPicking(){return this._m.bT}set enableDistantPicking(t){this._m.bT=t}get layerMask(){return this._m.gT}set layerMask(t){t!==this._m.gT&&(this._m.gT=t,this.zg())}get collisionMask(){return this._m.MT.sT}set collisionMask(t){this._m.MT.sT=isNaN(t)?-1:t}get collisionResponse(){return this._m.MT.lT}set collisionResponse(t){this._m.MT.lT=t}get collisionGroup(){return this._m.MT.nT}set collisionGroup(t){this._m.MT.nT=isNaN(t)?-1:t}get surroundingMeshes(){return this._m.MT.rT}set surroundingMeshes(t){this._m.MT.rT=t}get lightSources(){return this.DT}get QC(){return null}set skeleton(t){const i=this._m.KS;i&&i.needInitialSkinMatrix&&i.YT(this),t&&t.needInitialSkinMatrix&&t.jT(this),this._m.KS=t,this._m.KS||(this.FT=null),this.tw()}get skeleton(){return this._m.KS}kT(){this.VT.addUniform("world",16),this.VT.addUniform("visibility",1),this.VT.create()}transferToEffect(t){const i=this.VT;i.updateMatrix("world",t),i.updateFloat("visibility",this._m.vT),i.update()}getMeshUniformBuffer(){return this.VT}getClassName(){return"AbstractMesh"}toString(t){let i="Name: "+this.name+", isInstance: "+("InstancedMesh"!==this.getClassName()?"YES":"NO");i+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const e=this._m.KS;return e&&(i+=", skeleton: "+e.name),t&&(i+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],i+=", freeze wrld mat: "+(this.Hx||this.OT.freezeWorldMatrix?"YES":"NO")),i}Jx(){return this.NT&&this.billboardMode!==Is.BILLBOARDMODE_NONE?this.NT:super.Jx()}Xi(t,i=!0){if(this.actionManager&&(i||this.actionManager.isRecursive)){if(!t)return this.actionManager;if(this.actionManager.hasSpecificTrigger(t))return this.actionManager}return this.parent?this.parent.Xi(t,!1):null}br(t=!1){if(this.onRebuildObservable.notifyObservers(this),null!==this.yT&&(this.yT=null),this.subMeshes)for(const t of this.subMeshes)t.br()}zg(){this.DT.length=0;for(const t of this.getScene().lights)t.isEnabled()&&t.canAffectMesh(this)&&this.DT.push(t);this.$T()}KT(t){const i=t.isEnabled()&&t.canAffectMesh(this),e=this.DT.indexOf(t);let s=!1;if(-1===e){if(!i)return;this.DT.push(t)}else{if(i)return;s=!0,this.DT.splice(e,1)}this.$T(s)}XT(){for(const t of this.subMeshes)t.setEffect(null)}Wg(t,i){const e=this.DT.indexOf(t);-1!==e&&(this.DT.splice(e,1),this.$T(i))}qT(t){if(this.subMeshes)for(const i of this.subMeshes)for(let e=0;e<i.vC.length;++e){const s=i.vC[e];s&&s.defines&&s.defines.markAllAsDirty&&t(s.defines)}}$T(t=!1){this.qT((i=>i.markAsLightDirty(t)))}tw(){this.qT((t=>t.markAsAttributesDirty()))}GT(){this.qT((t=>t.markAsMiscDirty()))}markAsDirty(t){return this.Ai=Number.MAX_VALUE,this.F=!0,this}resetDrawCache(t){if(this.subMeshes)for(const i of this.subMeshes)i.resetDrawCache(t)}get isBlocked(){return!1}getLOD(t){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(t){return null}setVerticesData(t,i,e,s){return this}updateVerticesData(t,i,e,s){return this}setIndices(t,i){return this}isVerticesDataPresent(t){return!1}getBoundingInfo(){return this.NT?this.NT.getBoundingInfo():(this.PT&&(this.PT=!1,this.VC()),this.CC)}setBoundingInfo(t){return this.CC=t,this}get hasBoundingInfo(){return null!==this.CC}buildBoundingInfo(t,i,e){return this.CC=new ms(t,i,e),this.CC}normalizeToUnitCube(t=!0,i=!1,e){return super.normalizeToUnitCube(t,i,e)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(he.MatricesIndicesKind)&&this.isVerticesDataPresent(he.MatricesWeightsKind)}nS(){}QT(t){}rS(t,i){return this.Sv=t,!0}lS(){}Jg(){}iS(){}getWorldMatrix(){return this.NT&&this.billboardMode===Is.BILLBOARDMODE_NONE?this.NT.getWorldMatrix():super.getWorldMatrix()}zi(){return this.NT?this.NT.zi():super.zi()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(t,i,e){return this.position.addInPlace(this.calcMovePOV(t,i,e)),this}calcMovePOV(t,i,e){const s=new R;(this.rotationQuaternion?this.rotationQuaternion:T.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(s);const n=w.Zero(),r=this.definedFacingForward?-1:1;return w.TransformCoordinatesFromFloatsToRef(t*r,i,e*r,s,n),n}rotatePOV(t,i,e){return this.rotation.addInPlace(this.calcRotatePOV(t,i,e)),this}calcRotatePOV(t,i,e){const s=this.definedFacingForward?1:-1;return new w(t*s,i,e*s)}refreshBoundingInfo(t=!1,i=!1){return this.CC&&this.CC.isLocked||this.ZT(this.JT(t,i),null),this}ZT(t,i){if(t){const e=gs(t,0,this.getTotalVertices(),i);this.CC?this.CC.reConstruct(e.minimum,e.maximum):this.CC=new ms(e.minimum,e.maximum)}if(this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(t);this.VC()}tR(t=!1,i=!1,e,s=he.PositionKind){if((e=null!=e?e:this.getVerticesData(s).slice())&&i&&this.morphTargetManager){let t=0,i=0;for(let n=0;n<e.length;n++){for(let t=0;t<this.morphTargetManager.numTargets;t++){const i=this.morphTargetManager.getTarget(t),s=i.influence;if(s>0){const t=i.getPositions();t&&(e[n]+=(t[n]-e[n])*s)}}if(t++,s===he.PositionKind&&this.QC&&3===t){t=0;const s=3*i;this.QC[i++].copyFromFloats(e[s],e[s+1],e[s+2])}}}if(e&&t&&this.skeleton){const t=this.getVerticesData(he.MatricesIndicesKind),i=this.getVerticesData(he.MatricesWeightsKind);if(i&&t){const n=this.numBoneInfluencers>4,r=n?this.getVerticesData(he.MatricesIndicesExtraKind):null,h=n?this.getVerticesData(he.MatricesWeightsExtraKind):null,o=this.skeleton.getTransformMatrices(this),a=M.Vector3[0],l=M.Matrix[0],c=M.Matrix[1];let u=0;for(let f=0;f<e.length;f+=3,u+=4){let d,p;for(l.reset(),d=0;d<4;d++)p=i[u+d],p>0&&(R.FromFloat32ArrayToRefScaled(o,Math.floor(16*t[u+d]),p,c),l.addToSelf(c));if(n)for(d=0;d<4;d++)p=h[u+d],p>0&&(R.FromFloat32ArrayToRefScaled(o,Math.floor(16*r[u+d]),p,c),l.addToSelf(c));s===he.NormalKind?w.TransformNormalFromFloatsToRef(e[f],e[f+1],e[f+2],l,a):w.TransformCoordinatesFromFloatsToRef(e[f],e[f+1],e[f+2],l,a),a.toArray(e,f),s===he.PositionKind&&this.QC&&this.QC[f/3].copyFrom(a)}}}return e}getNormalsData(t=!1,i=!1){return this.tR(t,i,null,he.NormalKind)}getPositionData(t=!1,i=!1,e){return this.tR(t,i,e,he.PositionKind)}JT(t,i){var e;let s=this.getVerticesData(he.PositionKind);if(this._m.QC&&(this._m.QC=null),s&&(t&&this.skeleton||i&&this.morphTargetManager)){if(s=s.slice(),this.sw(),this.QC){const t=this.QC;this._m.QC=new Array(t.length);for(let i=0;i<t.length;i++)this._m.QC[i]=(null===(e=t[i])||void 0===e?void 0:e.clone())||new w}return this.getPositionData(t,i,s)}return s}VC(){return this.CC?this.CC.update(this.worldMatrixFromCache):this.CC=new ms(w.Zero(),w.Zero(),this.worldMatrixFromCache),this.iR(this.worldMatrixFromCache),this}iR(t){if(!this.subMeshes)return this;const i=this.subMeshes.length;for(let e=0;e<i;e++){const s=this.subMeshes[e];(i>1||!s.IsGlobal)&&s.updateBoundingInfo(t)}return this}Yx(){this.doNotSyncBoundingInfo||(this.PT=!0)}isInFrustum(t){return this.getBoundingInfo().isInFrustum(t,this.cullingStrategy)}isCompletelyInFrustum(t){return this.getBoundingInfo().isCompletelyInFrustum(t)}intersectsMesh(t,i=!1,e){const s=this.getBoundingInfo(),n=t.getBoundingInfo();if(s.intersects(n,i))return!0;if(e)for(const e of this.getChildMeshes())if(e.intersectsMesh(t,i,!0))return!0;return!1}intersectsPoint(t){return this.getBoundingInfo().intersectsPoint(t)}get checkCollisions(){return this._m.MT.eT}set checkCollisions(t){this._m.MT.eT=t}get collider(){return this._m.MT.hT}moveWithCollisions(t){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._m.MT.oT);const i=this.getScene().collisionCoordinator;return this._m.MT.hT||(this._m.MT.hT=i.createCollider()),this._m.MT.hT.eR=this.ellipsoid,i.getNewPosition(this._m.MT.oT,t,this._m.MT.hT,this.collisionRetryCount,this,this.UT,this.uniqueId),this}sR(t,i,e){var s;if(this.sw(),!this.QC)return this;if(!t.lC||!t.cC.equals(i)){t.cC=i.clone(),t.lC=[],t.pC=[];const e=t.verticesStart,s=t.verticesStart+t.verticesCount;for(let n=e;n<s;n++)t.lC.push(w.TransformCoordinates(this.QC[n],i))}return e.nR(t.pC,t.lC,this.getIndices(),t.indexStart,t.indexStart+t.indexCount,t.verticesStart,!!t.getMaterial(),this,this.rR(),7===(null===(s=t.getMaterial())||void 0===s?void 0:s.fillMode)),this}hR(t,i){const e=this.Kt.getCollidingSubMeshCandidates(this,t),s=e.length;for(let n=0;n<s;n++){const r=e.data[n];s>1&&!r.nC(t)||this.sR(r,i,t)}return this}rR(){return!1}nC(t){if(!this.getBoundingInfo().nC(t))return this;const i=M.Matrix[0],e=M.Matrix[1];return R.ScalingToRef(1/t.eR.x,1/t.eR.y,1/t.eR.z,i),this.worldMatrixFromCache.multiplyToRef(i,e),this.hR(t,e),this}sw(){return!1}intersects(t,i,e,s=!1,n,r=!1){const h=new oe,o="InstancedLinesMesh"===this.getClassName()||"LinesMesh"===this.getClassName()?this.intersectionThreshold:0,a=this.getBoundingInfo();if(!this.subMeshes)return h;if(!(r||t.intersectsSphere(a.boundingSphere,o)&&t.intersectsBox(a.boundingBox,o)))return h;if(s)return h.hit=!r,h.pickedMesh=r?null:this,h.distance=r?0:w.Distance(t.origin,a.boundingSphere.center),h.subMeshId=0,h;if(!this.sw())return h;let l=null;const c=this.Kt.getIntersectingSubMeshCandidates(this,t),u=c.length;let f=!1;for(let t=0;t<u;t++){const i=c.data[t].getMaterial();if(i&&(7==i.fillMode||0==i.fillMode||1==i.fillMode||2==i.fillMode||4==i.fillMode)){f=!0;break}}if(!f)return h.hit=!0,h.pickedMesh=this,h.distance=w.Distance(t.origin,a.boundingSphere.center),h.subMeshId=-1,h;for(let s=0;s<u;s++){const n=c.data[s];if(u>1&&!n.canIntersects(t))continue;const r=n.intersects(t,this.QC,this.getIndices(),i,e);if(r&&(i||!l||r.distance<l.distance)&&(l=r,l.subMeshId=s,i))break}if(l){const i=null!=n?n:this.getWorldMatrix(),e=M.Vector3[0],s=M.Vector3[1];w.TransformCoordinatesToRef(t.origin,i,e),t.direction.scaleToRef(l.distance,s);const r=w.TransformNormal(s,i).addInPlace(e);return h.hit=!0,h.distance=w.Distance(e,r),h.pickedPoint=r,h.pickedMesh=this,h.bu=l.bu||0,h.bv=l.bv||0,h.subMeshFaceId=l.faceId,h.faceId=l.faceId+c.data[l.subMeshId].indexStart/(-1!==this.getClassName().indexOf("LinesMesh")?2:3),h.subMeshId=l.subMeshId,h}return h}clone(t,i,e){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this}dispose(t,i=!1){let e;for(this.Kt.useMaterialMeshMap&&this._m.IT&&this._m.IT.meshMap&&(this._m.IT.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),void 0!==this.actionManager&&null!==this.actionManager&&(this.actionManager.dispose(),this.actionManager=null),this._m.KS=null,this.BT&&(this.BT.dispose(),this.BT=null),e=0;e<this.IS.length;e++){const t=this.IS[e],i=t.IS.indexOf(this);t.IS.splice(i,1)}this.IS.length=0;this.getScene().lights.forEach((t=>{let i=t.includedOnlyMeshes.indexOf(this);-1!==i&&t.includedOnlyMeshes.splice(i,1),i=t.excludedMeshes.indexOf(this),-1!==i&&t.excludedMeshes.splice(i,1);const e=t.getShadowGenerators();if(e){const t=e.values();for(let e=t.next();!0!==e.done;e=t.next()){const t=e.value.getShadowMap();t&&t.renderList&&(i=t.renderList.indexOf(this),-1!==i&&t.renderList.splice(i,1))}}})),"InstancedMesh"===this.getClassName()&&"InstancedLinesMesh"===this.getClassName()||this.releaseSubMeshes();const s=this.getScene().getEngine();if(null!==this.yT&&(this.isOcclusionQueryInProgress=!1,s.deleteQuery(this.yT),this.yT=null),s.wipeCaches(),this.getScene().removeMesh(this),this.Si){const t=this.Si.meshes.indexOf(this);t>-1&&this.Si.meshes.splice(t,1),this.Si=null}if(i&&this.material&&("MultiMaterial"===this.material.getClassName()?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!t)for(e=0;e<this.getScene().particleSystems.length;e++)this.getScene().particleSystems[e].emitter===this&&(this.getScene().particleSystems[e].dispose(),e--);this._m.mT.facetDataEnabled&&this.disableFacetData(),this.VT.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(t,i)}addChild(t,i=!1){return t.setParent(this,i),this}removeChild(t,i=!1){return t.setParent(null,i),this}oR(){const t=this._m.mT;t.facetNormals||(t.facetNormals=new Array),t.facetPositions||(t.facetPositions=new Array),t.facetPartitioning||(t.facetPartitioning=new Array),t.facetNb=this.getIndices().length/3|0,t.partitioningSubdivisions=t.partitioningSubdivisions?t.partitioningSubdivisions:10,t.partitioningBBoxRatio=t.partitioningBBoxRatio?t.partitioningBBoxRatio:1.01;for(let i=0;i<t.facetNb;i++)t.facetNormals[i]=w.Zero(),t.facetPositions[i]=w.Zero();return t.facetDataEnabled=!0,this}updateFacetData(){const t=this._m.mT;t.facetDataEnabled||this.oR();const i=this.getVerticesData(he.PositionKind),e=this.getIndices(),s=this.getVerticesData(he.NormalKind),n=this.getBoundingInfo();if(t.facetDepthSort&&!t.facetDepthSortEnabled){if(t.facetDepthSortEnabled=!0,e instanceof Uint16Array)t.depthSortedIndices=new Uint16Array(e);else if(e instanceof Uint32Array)t.depthSortedIndices=new Uint32Array(e);else{let i=!1;for(let t=0;t<e.length;t++)if(e[t]>65535){i=!0;break}t.depthSortedIndices=i?new Uint32Array(e):new Uint16Array(e)}if(t.facetDepthSortFunction=function(t,i){return i.sqDistance-t.sqDistance},!t.facetDepthSortFrom){const i=this.getScene().activeCamera;t.facetDepthSortFrom=i?i.position:w.Zero()}t.depthSortedFacets=[];for(let i=0;i<t.facetNb;i++){const e={ind:3*i,sqDistance:0};t.depthSortedFacets.push(e)}t.invertedMatrix=R.Identity(),t.facetDepthSortOrigin=w.Zero()}t.bbSize.x=n.maximum.x-n.minimum.x>u?n.maximum.x-n.minimum.x:u,t.bbSize.y=n.maximum.y-n.minimum.y>u?n.maximum.y-n.minimum.y:u,t.bbSize.z=n.maximum.z-n.minimum.z>u?n.maximum.z-n.minimum.z:u;let r=t.bbSize.x>t.bbSize.y?t.bbSize.x:t.bbSize.y;if(r=r>t.bbSize.z?r:t.bbSize.z,t.subDiv.max=t.partitioningSubdivisions,t.subDiv.X=Math.floor(t.subDiv.max*t.bbSize.x/r),t.subDiv.Y=Math.floor(t.subDiv.max*t.bbSize.y/r),t.subDiv.Z=Math.floor(t.subDiv.max*t.bbSize.z/r),t.subDiv.X=t.subDiv.X<1?1:t.subDiv.X,t.subDiv.Y=t.subDiv.Y<1?1:t.subDiv.Y,t.subDiv.Z=t.subDiv.Z<1?1:t.subDiv.Z,t.facetParameters.facetNormals=this.getFacetLocalNormals(),t.facetParameters.facetPositions=this.getFacetLocalPositions(),t.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),t.facetParameters.bInfo=n,t.facetParameters.bbSize=t.bbSize,t.facetParameters.subDiv=t.subDiv,t.facetParameters.ratio=this.partitioningBBoxRatio,t.facetParameters.depthSort=t.facetDepthSort,t.facetDepthSort&&t.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._i.invertToRef(t.invertedMatrix),w.TransformCoordinatesToRef(t.facetDepthSortFrom,t.invertedMatrix,t.facetDepthSortOrigin),t.facetParameters.distanceTo=t.facetDepthSortOrigin),t.facetParameters.depthSortedFacets=t.depthSortedFacets,s&&os.ComputeNormals(i,e,s,t.facetParameters),t.facetDepthSort&&t.facetDepthSortEnabled){t.depthSortedFacets.sort(t.facetDepthSortFunction);const i=t.depthSortedIndices.length/3|0;for(let s=0;s<i;s++){const i=t.depthSortedFacets[s].ind;t.depthSortedIndices[3*s]=e[i],t.depthSortedIndices[3*s+1]=e[i+1],t.depthSortedIndices[3*s+2]=e[i+2]}this.updateIndices(t.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const t=this._m.mT;return t.facetNormals||this.updateFacetData(),t.facetNormals}getFacetLocalPositions(){const t=this._m.mT;return t.facetPositions||this.updateFacetData(),t.facetPositions}getFacetLocalPartitioning(){const t=this._m.mT;return t.facetPartitioning||this.updateFacetData(),t.facetPartitioning}getFacetPosition(t){const i=w.Zero();return this.getFacetPositionToRef(t,i),i}getFacetPositionToRef(t,i){const e=this.getFacetLocalPositions()[t],s=this.getWorldMatrix();return w.TransformCoordinatesToRef(e,s,i),this}getFacetNormal(t){const i=w.Zero();return this.getFacetNormalToRef(t,i),i}getFacetNormalToRef(t,i){const e=this.getFacetLocalNormals()[t];return w.TransformNormalToRef(e,this.getWorldMatrix(),i),this}getFacetsAtLocalCoordinates(t,i,e){const s=this.getBoundingInfo(),n=this._m.mT,r=Math.floor((t-s.minimum.x*n.partitioningBBoxRatio)*n.subDiv.X*n.partitioningBBoxRatio/n.bbSize.x),h=Math.floor((i-s.minimum.y*n.partitioningBBoxRatio)*n.subDiv.Y*n.partitioningBBoxRatio/n.bbSize.y),o=Math.floor((e-s.minimum.z*n.partitioningBBoxRatio)*n.subDiv.Z*n.partitioningBBoxRatio/n.bbSize.z);return r<0||r>n.subDiv.max||h<0||h>n.subDiv.max||o<0||o>n.subDiv.max?null:n.facetPartitioning[r+n.subDiv.max*h+n.subDiv.max*n.subDiv.max*o]}getClosestFacetAtCoordinates(t,i,e,s,n=!1,r=!0){const h=this.getWorldMatrix(),o=M.Matrix[5];h.invertToRef(o);const a=M.Vector3[8];w.TransformCoordinatesFromFloatsToRef(t,i,e,o,a);const l=this.getClosestFacetAtLocalCoordinates(a.x,a.y,a.z,s,n,r);return s&&w.TransformCoordinatesFromFloatsToRef(s.x,s.y,s.z,h,s),l}getClosestFacetAtLocalCoordinates(t,i,e,s,n=!1,r=!0){let h=null,o=0,a=0,l=0,c=0,u=0,f=0,d=0,p=0;const m=this.getFacetLocalPositions(),v=this.getFacetLocalNormals(),g=this.getFacetsAtLocalCoordinates(t,i,e);if(!g)return null;let S,E,A,C=Number.MAX_VALUE,w=C;for(let x=0;x<g.length;x++)S=g[x],E=v[S],A=m[S],c=(t-A.x)*E.x+(i-A.y)*E.y+(e-A.z)*E.z,(!n||n&&r&&c>=0||n&&!r&&c<=0)&&(c=E.x*A.x+E.y*A.y+E.z*A.z,u=-(E.x*t+E.y*i+E.z*e-c)/(E.x*E.x+E.y*E.y+E.z*E.z),f=t+E.x*u,d=i+E.y*u,p=e+E.z*u,o=f-t,a=d-i,l=p-e,w=o*o+a*a+l*l,w<C&&(C=w,h=S,s&&(s.x=f,s.y=d,s.z=p)));return h}getFacetDataParameters(){return this._m.mT.facetParameters}disableFacetData(){const t=this._m.mT;return t.facetDataEnabled&&(t.facetDataEnabled=!1,t.facetPositions=new Array,t.facetNormals=new Array,t.facetPartitioning=new Array,t.facetParameters=null,t.depthSortedIndices=new Uint32Array(0)),this}updateIndices(t,i,e=!1){return this}createNormals(t){const i=this.getVerticesData(he.PositionKind),e=this.getIndices();let s;return s=this.isVerticesDataPresent(he.NormalKind)?this.getVerticesData(he.NormalKind):[],os.ComputeNormals(i,e,s,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(he.NormalKind,s,t),this}alignWithNormal(t,i){i||(i=Ge.Y);const e=M.Vector3[0],s=M.Vector3[1];return w.CrossToRef(i,t,s),w.CrossToRef(t,s,e),this.rotationQuaternion?T.RotationQuaternionFromAxisToRef(e,t,s,this.rotationQuaternion):w.RotationFromAxisToRef(e,t,s,this.rotation),this}aR(){return!1}disableEdgesRendering(){throw X("EdgesRenderer")}enableEdgesRendering(t,i,e){throw X("EdgesRenderer")}getConnectedParticleSystems(){return this.Kt.particleSystems.filter((t=>t.emitter===this))}}function Ns(t){-1===t.indexOf("vClipPlane")&&t.push("vClipPlane"),-1===t.indexOf("vClipPlane2")&&t.push("vClipPlane2"),-1===t.indexOf("vClipPlane3")&&t.push("vClipPlane3"),-1===t.indexOf("vClipPlane4")&&t.push("vClipPlane4"),-1===t.indexOf("vClipPlane5")&&t.push("vClipPlane5"),-1===t.indexOf("vClipPlane6")&&t.push("vClipPlane6")}function Ps(t,i,e){var s,n,r,h,o,a;let l=!1,c=null!==(s=t.clipPlane)&&void 0!==s?s:i.clipPlane;return l=Os(c,e,"CLIPPLANE")||l,c=null!==(n=t.clipPlane2)&&void 0!==n?n:i.clipPlane2,l=Os(c,e,"CLIPPLANE2")||l,c=null!==(r=t.clipPlane3)&&void 0!==r?r:i.clipPlane3,l=Os(c,e,"CLIPPLANE3")||l,c=null!==(h=t.clipPlane4)&&void 0!==h?h:i.clipPlane4,l=Os(c,e,"CLIPPLANE4")||l,c=null!==(o=t.clipPlane5)&&void 0!==o?o:i.clipPlane5,l=Os(c,e,"CLIPPLANE5")||l,c=null!==(a=t.clipPlane6)&&void 0!==a?a:i.clipPlane6,l=Os(c,e,"CLIPPLANE6")||l,l}function Ds(t,i,e){var s,n,r,h,o,a;let l=null!==(s=i.clipPlane)&&void 0!==s?s:e.clipPlane;Ls(t,"vClipPlane",l),l=null!==(n=i.clipPlane2)&&void 0!==n?n:e.clipPlane2,Ls(t,"vClipPlane2",l),l=null!==(r=i.clipPlane3)&&void 0!==r?r:e.clipPlane3,Ls(t,"vClipPlane3",l),l=null!==(h=i.clipPlane4)&&void 0!==h?h:e.clipPlane4,Ls(t,"vClipPlane4",l),l=null!==(o=i.clipPlane5)&&void 0!==o?o:e.clipPlane5,Ls(t,"vClipPlane5",l),l=null!==(a=i.clipPlane6)&&void 0!==a?a:e.clipPlane6,Ls(t,"vClipPlane6",l)}function Ls(t,i,e){e&&t.setFloat4(i,e.normal.x,e.normal.y,e.normal.z,e.d)}function Os(t,i,e){let s=!0;if(t)if(Array.isArray(i)){const t="#define "+e;s=-1!==i.indexOf(t),s||i.push(t)}else s=i[e],i[e]=!0;return!s}ys.OCCLUSION_TYPE_NONE=0,ys.OCCLUSION_TYPE_OPTIMISTIC=1,ys.OCCLUSION_TYPE_STRICT=2,ys.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,ys.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,ys.CULLINGSTRATEGY_STANDARD=0,ys.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,ys.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,ys.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,v("BABYLON.AbstractMesh",ys);class Fs{static BindSceneUniformBuffer(t,i){i.bindToEffect(t,"Scene")}static PrepareDefinesForMergedUV(t,i,e){i.Bl=!0,i[e]=!0,t.optimizeUVAllocation&&t.getTextureMatrix().isIdentityAs3x2()?(i[e+"DIRECTUV"]=t.coordinatesIndex+1,i["MAINUV"+(t.coordinatesIndex+1)]=!0):i[e+"DIRECTUV"]=0}static BindTextureMatrix(t,i,e){const s=t.getTextureMatrix();i.updateMatrix(e+"Matrix",s)}static GetFogState(t,i){return i.fogEnabled&&t.applyFog&&i.fogMode!==ke.FOGMODE_NONE}static PrepareDefinesForMisc(t,i,e,s,n,r,h){h.Nl&&(h.LOGARITHMICDEPTH=e,h.POINTSIZE=s,h.FOG=n&&this.GetFogState(t,i),h.NONUNIFORMSCALING=t.nonUniformScaling,h.ALPHATEST=r)}static PrepareDefinesForCamera(t,i){let e=!1;if(t.activeCamera){const s=i.CAMERA_ORTHOGRAPHIC?1:0,n=i.CAMERA_PERSPECTIVE?1:0,r=t.activeCamera.mode===hs.ORTHOGRAPHIC_CAMERA?1:0,h=t.activeCamera.mode===hs.PERSPECTIVE_CAMERA?1:0;(s^r||n^h)&&(i.CAMERA_ORTHOGRAPHIC=1===r,i.CAMERA_PERSPECTIVE=1===h,e=!0)}return e}static PrepareDefinesForFrameBoundValues(t,i,e,s,n,r=null,h=!1){let o=Fs.PrepareDefinesForCamera(t,s);!1!==r&&(o=Ps(e,t,s)),s.DEPTHPREPASS!==!i.getColorWrite()&&(s.DEPTHPREPASS=!s.DEPTHPREPASS,o=!0),s.INSTANCES!==n&&(s.INSTANCES=n,o=!0),s.THIN_INSTANCES!==h&&(s.THIN_INSTANCES=h,o=!0),o&&s.markAsUnprocessed()}static PrepareDefinesForBones(t,i){if(t.useBones&&t.computeBonesUsingShaders&&t.skeleton){i.NUM_BONE_INFLUENCERS=t.numBoneInfluencers;const e=void 0!==i.BONETEXTURE;if(t.skeleton.isUsingTextureForMatrices&&e)i.BONETEXTURE=!0;else{i.BonesPerMesh=t.skeleton.bones.length+1,i.BONETEXTURE=!e&&void 0;const s=t.getScene().prePassRenderer;if(s&&s.enabled){const e=-1===s.excludedSkinnedMesh.indexOf(t);i.BONES_VELOCITY_ENABLED=e}}}else i.NUM_BONE_INFLUENCERS=0,i.BonesPerMesh=0,void 0!==i.BONETEXTURE&&(i.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(t,i){const e=t.morphTargetManager;e?(i.MORPHTARGETS_UV=e.supportsUVs&&i.UV1,i.MORPHTARGETS_TANGENT=e.supportsTangents&&i.TANGENT,i.MORPHTARGETS_NORMAL=e.supportsNormals&&i.NORMAL,i.MORPHTARGETS=e.numInfluencers>0,i.NUM_MORPH_INFLUENCERS=e.numInfluencers,i.MORPHTARGETS_TEXTURE=e.isUsingTextureForTargets):(i.MORPHTARGETS_UV=!1,i.MORPHTARGETS_TANGENT=!1,i.MORPHTARGETS_NORMAL=!1,i.MORPHTARGETS=!1,i.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(t,i){const e=t.bakedVertexAnimationManager;i.BAKED_VERTEX_ANIMATION_TEXTURE=!(!e||!e.isEnabled)}static PrepareDefinesForAttributes(t,i,e,s,n=!1,r=!0,h=!0){if(!i.bl&&i.Fl===i.Ll&&i.Bl===i.Ol)return!1;i.Ll=i.Fl,i.Ol=i.Bl,i.NORMAL=i.Fl&&t.isVerticesDataPresent(he.NormalKind),i.Fl&&t.isVerticesDataPresent(he.TangentKind)&&(i.TANGENT=!0);for(let e=1;e<=6;++e)i["UV"+e]=!!i.Bl&&t.isVerticesDataPresent(`uv${1===e?"":e}`);if(e){const e=t.useVertexColors&&t.isVerticesDataPresent(he.ColorKind);i.VERTEXCOLOR=e,i.VERTEXALPHA=t.hasVertexAlpha&&e&&r}return t.isVerticesDataPresent(he.ColorInstanceKind)&&(t.hasInstances||t.hasThinInstances)&&(i.INSTANCESCOLOR=!0),s&&this.PrepareDefinesForBones(t,i),n&&this.PrepareDefinesForMorphTargets(t,i),h&&this.PrepareDefinesForBakedVertexAnimation(t,i),!0}static PrepareDefinesForMultiview(t,i){if(t.activeCamera){const e=i.MULTIVIEW;i.MULTIVIEW=null!==t.activeCamera.outputRenderTarget&&t.activeCamera.outputRenderTarget.getViewCount()>1,i.MULTIVIEW!=e&&i.markAsUnprocessed()}}static PrepareDefinesForOIT(t,i,e){const s=i.ORDER_INDEPENDENT_TRANSPARENCY,n=i.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;i.ORDER_INDEPENDENT_TRANSPARENCY=t.useOrderIndependentTransparency&&e,i.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!t.getEngine().getCaps().textureFloatLinearFiltering,s===i.ORDER_INDEPENDENT_TRANSPARENCY&&n===i.ORDER_INDEPENDENT_TRANSPARENCY_16BITS||i.markAsUnprocessed()}static PrepareDefinesForPrePass(t,i,e){const s=i.PREPASS;if(!i.Pl)return;const n=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(t.prePassRenderer&&t.prePassRenderer.enabled&&e){i.PREPASS=!0,i.SCENE_MRT_COUNT=t.prePassRenderer.mrtCount;for(let e=0;e<n.length;e++){const s=t.prePassRenderer.getIndex(n[e].type);-1!==s?(i[n[e].define]=!0,i[n[e].index]=s):i[n[e].define]=!1}}else{i.PREPASS=!1;for(let t=0;t<n.length;t++)i[n[t].define]=!1}i.PREPASS!=s&&(i.markAsUnprocessed(),i.markAsImageProcessingDirty())}static PrepareDefinesForLight(t,i,e,s,n,r,h){var o;switch(h.needNormals=!0,void 0===n["LIGHT"+s]&&(h.needRebuild=!0),n["LIGHT"+s]=!0,n["SPOTLIGHT"+s]=!1,n["HEMILIGHT"+s]=!1,n["POINTLIGHT"+s]=!1,n["DIRLIGHT"+s]=!1,e.prepareLightSpecificDefines(n,s),n["LIGHT_FALLOFF_PHYSICAL"+s]=!1,n["LIGHT_FALLOFF_GLTF"+s]=!1,n["LIGHT_FALLOFF_STANDARD"+s]=!1,e.falloffType){case Oe.FALLOFF_GLTF:n["LIGHT_FALLOFF_GLTF"+s]=!0;break;case Oe.FALLOFF_PHYSICAL:n["LIGHT_FALLOFF_PHYSICAL"+s]=!0;break;case Oe.FALLOFF_STANDARD:n["LIGHT_FALLOFF_STANDARD"+s]=!0}if(r&&!e.specular.equalsFloats(0,0,0)&&(h.specularEnabled=!0),n["SHADOW"+s]=!1,n["SHADOWCSM"+s]=!1,n["SHADOWCSMDEBUG"+s]=!1,n["SHADOWCSMNUM_CASCADES"+s]=!1,n["SHADOWCSMUSESHADOWMAXZ"+s]=!1,n["SHADOWCSMNOBLEND"+s]=!1,n["SHADOWCSM_RIGHTHANDED"+s]=!1,n["SHADOWPCF"+s]=!1,n["SHADOWPCSS"+s]=!1,n["SHADOWPOISSON"+s]=!1,n["SHADOWESM"+s]=!1,n["SHADOWCLOSEESM"+s]=!1,n["SHADOWCUBE"+s]=!1,n["SHADOWLOWQUALITY"+s]=!1,n["SHADOWMEDIUMQUALITY"+s]=!1,i&&i.receiveShadows&&t.shadowsEnabled&&e.shadowEnabled){const i=null!==(o=e.getShadowGenerator(t.activeCamera))&&void 0!==o?o:e.getShadowGenerator();if(i){const t=i.getShadowMap();t&&t.renderList&&t.renderList.length>0&&(h.shadowEnabled=!0,i.prepareDefines(n,s))}}e.lightmapMode!=Oe.LIGHTMAP_DEFAULT?(h.lightmapMode=!0,n["LIGHTMAPEXCLUDED"+s]=!0,n["LIGHTMAPNOSPECULAR"+s]=e.lightmapMode==Oe.LIGHTMAP_SHADOWSONLY):(n["LIGHTMAPEXCLUDED"+s]=!1,n["LIGHTMAPNOSPECULAR"+s]=!1)}static PrepareDefinesForLights(t,i,e,s,n=4,r=!1){if(!e.Il)return e.Fl;let h=0;const o={needNormals:e.Fl,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(t.lightsEnabled&&!r)for(const r of i.lightSources)if(this.PrepareDefinesForLight(t,i,r,h,e,s,o),h++,h===n)break;e.SPECULARTERM=o.specularEnabled,e.SHADOWS=o.shadowEnabled;for(let t=h;t<n;t++)void 0!==e["LIGHT"+t]&&(e["LIGHT"+t]=!1,e["HEMILIGHT"+t]=!1,e["POINTLIGHT"+t]=!1,e["DIRLIGHT"+t]=!1,e["SPOTLIGHT"+t]=!1,e["SHADOW"+t]=!1,e["SHADOWCSM"+t]=!1,e["SHADOWCSMDEBUG"+t]=!1,e["SHADOWCSMNUM_CASCADES"+t]=!1,e["SHADOWCSMUSESHADOWMAXZ"+t]=!1,e["SHADOWCSMNOBLEND"+t]=!1,e["SHADOWCSM_RIGHTHANDED"+t]=!1,e["SHADOWPCF"+t]=!1,e["SHADOWPCSS"+t]=!1,e["SHADOWPOISSON"+t]=!1,e["SHADOWESM"+t]=!1,e["SHADOWCLOSEESM"+t]=!1,e["SHADOWCUBE"+t]=!1,e["SHADOWLOWQUALITY"+t]=!1,e["SHADOWMEDIUMQUALITY"+t]=!1);const a=t.getEngine().getCaps();return void 0===e.SHADOWFLOAT&&(o.needRebuild=!0),e.SHADOWFLOAT=o.shadowEnabled&&(a.textureFloatRender&&a.textureFloatLinearFiltering||a.textureHalfFloatRender&&a.textureHalfFloatLinearFiltering),e.LIGHTMAPEXCLUDED=o.lightmapMode,o.needRebuild&&e.rebuild(),o.needNormals}static PrepareUniformsAndSamplersForLight(t,i,e,s,n=null,r=!1){n&&n.push("Light"+t),r||(i.push("vLightData"+t,"vLightDiffuse"+t,"vLightSpecular"+t,"vLightDirection"+t,"vLightFalloff"+t,"vLightGround"+t,"lightMatrix"+t,"shadowsInfo"+t,"depthValues"+t),e.push("shadowSampler"+t),e.push("depthSampler"+t),i.push("viewFrustumZ"+t,"cascadeBlendFactor"+t,"lightSizeUVCorrection"+t,"depthCorrection"+t,"penumbraDarkness"+t,"frustumLengths"+t),s&&(e.push("projectionLightSampler"+t),i.push("textureProjectionMatrix"+t)))}static PrepareUniformsAndSamplersList(t,i,e,s=4){let n,r=null;if(t.uniformsNames){const h=t;n=h.uniformsNames,r=h.uniformBuffersNames,i=h.samplers,e=h.defines,s=h.maxSimultaneousLights||0}else n=t,i||(i=[]);for(let t=0;t<s&&e["LIGHT"+t];t++)this.PrepareUniformsAndSamplersForLight(t,n,i,e["PROJECTEDLIGHTTEXTURE"+t],r);e.NUM_MORPH_INFLUENCERS&&n.push("morphTargetInfluences"),e.BAKED_VERTEX_ANIMATION_TEXTURE&&(n.push("bakedVertexAnimationSettings"),n.push("bakedVertexAnimationTextureSizeInverted"),n.push("bakedVertexAnimationTime"),i.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(t,i,e=4,s=0){let n=0;for(let r=0;r<e&&t["LIGHT"+r];r++)r>0&&(n=s+r,i.addFallback(n,"LIGHT"+r)),t.SHADOWS||(t["SHADOW"+r]&&i.addFallback(s,"SHADOW"+r),t["SHADOWPCF"+r]&&i.addFallback(s,"SHADOWPCF"+r),t["SHADOWPCSS"+r]&&i.addFallback(s,"SHADOWPCSS"+r),t["SHADOWPOISSON"+r]&&i.addFallback(s,"SHADOWPOISSON"+r),t["SHADOWESM"+r]&&i.addFallback(s,"SHADOWESM"+r),t["SHADOWCLOSEESM"+r]&&i.addFallback(s,"SHADOWCLOSEESM"+r));return n++}static PrepareAttributesForMorphTargetsInfluencers(t,i,e){this.lR.NUM_MORPH_INFLUENCERS=e,this.PrepareAttributesForMorphTargets(t,i,this.lR)}static PrepareAttributesForMorphTargets(t,i,e){const s=e.NUM_MORPH_INFLUENCERS;if(s>0&&E.LastCreatedEngine){const n=E.LastCreatedEngine.getCaps().maxVertexAttribs,r=i.morphTargetManager;if(null==r?void 0:r.isUsingTextureForTargets)return;const h=r&&r.supportsNormals&&e.NORMAL,o=r&&r.supportsTangents&&e.TANGENT,a=r&&r.supportsUVs&&e.UV1;for(let e=0;e<s;e++)t.push(he.PositionKind+e),h&&t.push(he.NormalKind+e),o&&t.push(he.TangentKind+e),a&&t.push(he.UVKind+"_"+e),t.length>n&&F.Error("Cannot add more vertex attributes for mesh "+i.name)}}static PrepareAttributesForBakedVertexAnimation(t,i,e){e.BAKED_VERTEX_ANIMATION_TEXTURE&&e.INSTANCES&&t.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(t,i,e,s){e.NUM_BONE_INFLUENCERS>0&&(s.addCPUSkinningFallback(0,i),t.push(he.MatricesIndicesKind),t.push(he.MatricesWeightsKind),e.NUM_BONE_INFLUENCERS>4&&(t.push(he.MatricesIndicesExtraKind),t.push(he.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(t,i){(i.INSTANCES||i.THIN_INSTANCES)&&this.PushAttributesForInstances(t,!!i.PREPASS_VELOCITY),i.INSTANCESCOLOR&&t.push(he.ColorInstanceKind)}static PushAttributesForInstances(t,i=!1){t.push("world0"),t.push("world1"),t.push("world2"),t.push("world3"),i&&(t.push("previousWorld0"),t.push("previousWorld1"),t.push("previousWorld2"),t.push("previousWorld3"))}static BindLightProperties(t,i,e){t.transferToEffect(i,e+"")}static BindLight(t,i,e,s,n,r=!0){t.cR(i,e,s,n,r)}static BindLights(t,i,e,s,n=4){const r=Math.min(i.lightSources.length,n);for(let n=0;n<r;n++){const r=i.lightSources[n];this.BindLight(r,n,t,e,"boolean"==typeof s?s:s.SPECULARTERM,i.receiveShadows)}}static BindFogParameters(t,i,e,s=!1){t.fogEnabled&&i.applyFog&&t.fogMode!==ke.FOGMODE_NONE&&(e.setFloat4("vFogInfos",t.fogMode,t.fogStart,t.fogEnd,t.fogDensity),s?(t.fogColor.toLinearSpaceToRef(this.uR),e.setColor3("vFogColor",this.uR)):e.setColor3("vFogColor",t.fogColor))}static BindBonesParameters(t,i,e){if(i&&t&&(t.computeBonesUsingShaders&&i.ps&&(t.computeBonesUsingShaders=!1),t.useBones&&t.computeBonesUsingShaders&&t.skeleton)){const s=t.skeleton;if(s.isUsingTextureForMatrices&&i.getUniformIndex("boneTextureWidth")>-1){const e=s.getTransformMatrixTexture(t);i.setTexture("boneSampler",e),i.setFloat("boneTextureWidth",4*(s.bones.length+1))}else{const n=s.getTransformMatrices(t);n&&(i.setMatrices("mBones",n),e&&t.getScene().prePassRenderer&&t.getScene().prePassRenderer.getIndex(2)&&(e.previousBones[t.uniqueId]||(e.previousBones[t.uniqueId]=n.slice()),i.setMatrices("mPreviousBones",e.previousBones[t.uniqueId]),Fs.fR(n,e.previousBones[t.uniqueId])))}}}static fR(t,i){return i.set(t),i}static BindMorphTargetParameters(t,i){const e=t.morphTargetManager;t&&e&&i.setFloatArray("morphTargetInfluences",e.influences)}static BindLogDepth(t,i,e){if(!t||t.LOGARITHMICDEPTH||t.indexOf&&t.indexOf("LOGARITHMICDEPTH")>=0){const t=e.activeCamera;t.mode===hs.ORTHOGRAPHIC_CAMERA&&F.Error("Logarithmic depth is not compatible with orthographic cameras!",20),i.setFloat("logarithmicDepthConstant",2/(Math.log(t.maxZ+1)/Math.LN2))}}}Fs.lR={NUM_MORPH_INFLUENCERS:0},Fs.uR=_.Black();class Bs{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this.jr}set func(t){this.jr=t}get funcRef(){return this.Kr}set funcRef(t){this.Kr=t}get funcMask(){return this.qr}set funcMask(t){this.qr=t}get opStencilFail(){return this.Qr}set opStencilFail(t){this.Qr=t}get opDepthFail(){return this.Zr}set opDepthFail(t){this.Zr=t}get opStencilDepthPass(){return this.Jr}set opStencilDepthPass(t){this.Jr=t}get mask(){return this.th}set mask(t){this.th=t}get enabled(){return this.ih}set enabled(t){this.ih=t}getClassName(){return"MaterialStencilState"}copyTo(t){ot.Clone((()=>t),this)}serialize(){return ot.Serialize(this)}parse(t,i,e){ot.Parse((()=>this),t,i,e)}}var Us;ut([Q()],Bs.prototype,"func",null),ut([Q()],Bs.prototype,"funcRef",null),ut([Q()],Bs.prototype,"funcMask",null),ut([Q()],Bs.prototype,"opStencilFail",null),ut([Q()],Bs.prototype,"opDepthFail",null),ut([Q()],Bs.prototype,"opStencilDepthPass",null),ut([Q()],Bs.prototype,"mask",null),ut([Q()],Bs.prototype,"enabled",null),function(t){t[t.Created=1]="Created",t[t.Disposed=2]="Disposed",t[t.GetDefineNames=4]="GetDefineNames",t[t.PrepareUniformBuffer=8]="PrepareUniformBuffer",t[t.IsReadyForSubMesh=16]="IsReadyForSubMesh",t[t.PrepareDefines=32]="PrepareDefines",t[t.BindForSubMesh=64]="BindForSubMesh",t[t.PrepareEffect=128]="PrepareEffect",t[t.GetAnimatables=256]="GetAnimatables",t[t.GetActiveTextures=512]="GetActiveTextures",t[t.HasTexture=1024]="HasTexture",t[t.FillRenderTargetTextures=2048]="FillRenderTargetTextures",t[t.HasRenderTargetTextures=4096]="HasRenderTargetTextures",t[t.HardBindForSubMesh=8192]="HardBindForSubMesh"}(Us||(Us={}));class Vs{constructor(t,i,e){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this.dR=1,this.pR=!0,this.mR=!0,this.vR=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this.Lg=!1,this.animations=null,this.onDisposeObservable=new h,this.Li=null,this.gR=null,this.SR=null,this.xh=2,this.ER=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this.rv=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new Bs,this.AR=!1,this.CR=Vs.TriangleFillMode,this.wR=!1,this.xR=!1,this.TR=0,this.$g=-1,this.meshMap=null,this.Si=null,this.RR=!1,this.IR={},this.MR=()=>{},this.bR=()=>{},this._R=()=>{},this.yR=()=>{},this.NR=()=>{},this.PR=()=>{},this.DR=()=>{},this.LR=()=>{},this.OR=!1,this.FR=null,this.name=t;const s=i||E.LastCreatedScene;s&&(this.Kt=s,this.BR={},this.BR[1]=this.UR.bind(this),this.BR[2]=this.VR.bind(this),this.BR[4]=this.kR.bind(this),this.BR[8]=this.GR.bind(this),this.BR[16]=this.zR.bind(this),this.BR[32]=this.HR.bind(this),this.BR[63]=this.XR.bind(this),this.id=t||ki.RandomId(),this.uniqueId=this.Kt.getUniqueId(),this.WR=this.Kt.getEngine().createMaterialContext(),this.SC=new vi(this.Kt.getEngine(),!1),this.SC.materialContext=this.WR,this.Kt.useRightHandedSystem?this.sideOrientation=Vs.ClockWiseSideOrientation:this.sideOrientation=Vs.CounterClockWiseSideOrientation,this.VT=new ne(this.Kt.getEngine(),void 0,void 0,t),this.AR=this.getScene().getEngine().supportsUniformBuffers,e||this.Kt.addMaterial(this),this.Kt.useMaterialMeshMap&&(this.meshMap={}),Vs.OnEventObservable.notifyObservers(this,Us.Created))}get canRenderToMRT(){return!1}set alpha(t){if(this.dR===t)return;const i=this.dR;this.dR=t,1!==i&&1!==t||this.markAsDirty(Vs.MiscDirtyFlag)}get alpha(){return this.dR}set backFaceCulling(t){this.pR!==t&&(this.pR=t,this.markAsDirty(Vs.TextureDirtyFlag))}get backFaceCulling(){return this.pR}set cullBackFaces(t){this.mR!==t&&(this.mR=t,this.markAsDirty(Vs.TextureDirtyFlag))}get cullBackFaces(){return this.mR}get blockDirtyMechanism(){return this.vR}set blockDirtyMechanism(t){this.vR!==t&&(this.vR=t,t||this.markDirty())}atomicMaterialsUpdate(t){this.blockDirtyMechanism=!0;try{t(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this.IR.hasRenderTargetTextures=!1,this.DR(this.IR),this.IR.hasRenderTargetTextures}set onDispose(t){this.Li&&this.onDisposeObservable.remove(this.Li),this.Li=this.onDisposeObservable.add(t)}get onBindObservable(){return this.ls||(this.ls=new h),this.ls}set onBind(t){this.SR&&this.onBindObservable.remove(this.SR),this.SR=this.onBindObservable.add(t)}get onUnBindObservable(){return this.gR||(this.gR=new h),this.gR}get onEffectCreatedObservable(){return this.$R||(this.$R=new h),this.$R}set alphaMode(t){this.xh!==t&&(this.xh=t,this.markAsDirty(Vs.TextureDirtyFlag))}get alphaMode(){return this.xh}set needDepthPrePass(t){this.ER!==t&&(this.ER=t,this.ER&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this.ER}get isPrePassCapable(){return!1}set fogEnabled(t){this.rv!==t&&(this.rv=t,this.markAsDirty(Vs.MiscDirtyFlag))}get fogEnabled(){return this.rv}get wireframe(){switch(this.CR){case Vs.WireFrameFillMode:case Vs.LineListDrawMode:case Vs.LineLoopDrawMode:case Vs.LineStripDrawMode:return!0}return this.Kt.forceWireframe}set wireframe(t){this.fillMode=t?Vs.WireFrameFillMode:Vs.TriangleFillMode}get pointsCloud(){switch(this.CR){case Vs.PointFillMode:case Vs.PointListDrawMode:return!0}return this.Kt.forcePointsCloud}set pointsCloud(t){this.fillMode=t?Vs.PointFillMode:Vs.TriangleFillMode}get fillMode(){return this.CR}set fillMode(t){this.CR!==t&&(this.CR=t,this.markAsDirty(Vs.MiscDirtyFlag))}mC(){return this.SC}YR(t){this.SC=t}toString(t){return"Name: "+this.name}getClassName(){return"Material"}get yt(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(t,i){return!0}isReadyForSubMesh(t,i,e){const s=i.materialDefines;return!!s&&(this.IR.isReadyForSubMesh=!0,this.IR.defines=s,this.bR(this.IR),this.IR.isReadyForSubMesh)}getEffect(){return this.SC.effect}getScene(){return this.Kt}get transparencyMode(){return this.FR}set transparencyMode(t){this.FR!==t&&(this.FR=t,this.OR=t===Vs.MATERIAL_ALPHATESTANDBLEND,this.jR())}get KR(){return this.FR===Vs.MATERIAL_OPAQUE||this.FR===Vs.MATERIAL_ALPHATEST}needAlphaBlending(){return!this.KR&&this.alpha<1}needAlphaBlendingForMesh(t){return t.visibility<1||!this.KR&&(t.hasVertexAlpha||this.needAlphaBlending())}needAlphaTesting(){return!!this.OR}qR(t){return!this.needAlphaBlendingForMesh(t)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(t=!1){const i=this.getScene().meshes;for(const e of i)if(e.subMeshes)for(const i of e.subMeshes)i.getMaterial()===this&&i.effect&&(i.effect.cs=!1,i.effect.fs=null,i.effect.us=t);t&&this.markAsDirty(Vs.AllDirtyFlag)}QR(t,i=null){const e=this.Kt.getEngine(),s=(null==i?this.sideOrientation:i)===Vs.ClockWiseSideOrientation;return e.enableEffect(t||this.mC()),e.setState(this.backFaceCulling,this.zOffset,!1,s,this.Kt.Ag?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),s}bind(t,i){}buildUniformLayout(){const t=this.VT;this.IR.ubo=t,this.MR(Us.PrepareUniformBuffer,this.IR),t.create(),this.RR=!0}bindForSubMesh(t,i,e){const s=e.effect;s&&(this.IR.subMesh=e,this.PR(this.IR),s.us=!1)}bindOnlyWorldMatrix(t){}bindView(t){this.AR?this.JR=!0:t.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(t){this.AR?this.JR=!0:(t.setMatrix("viewProjection",this.getScene().getTransformMatrix()),t.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(t,i){this.AR?this.JR=!0:this.Kt.bindEyePosition(t,i)}tI(t,i=null){if(this.Kt.yg=this,this.JR&&i&&(this.JR=!1,Fs.BindSceneUniformBuffer(i,this.getScene().getSceneUniformBuffer()),this.Kt.finalizeSceneUbo()),this.Kt.Pg=t?t.visibility:1,this.ls&&t&&this.ls.notifyObservers(t),this.disableDepthWrite){const t=this.Kt.getEngine();this.wR=t.getDepthWrite(),t.setDepthWrite(!1)}if(this.disableColorWrite){const t=this.Kt.getEngine();this.xR=t.getColorWrite(),t.setColorWrite(!1)}if(0!==this.depthFunction){const t=this.Kt.getEngine();this.TR=t.getDepthFunction()||0,t.setDepthFunction(this.depthFunction)}}unbind(){if(this.gR&&this.gR.notifyObservers(this),0!==this.depthFunction){this.Kt.getEngine().setDepthFunction(this.TR)}if(this.disableDepthWrite){this.Kt.getEngine().setDepthWrite(this.wR)}if(this.disableColorWrite){this.Kt.getEngine().setColorWrite(this.xR)}}getAnimatables(){return this.IR.animatables=[],this.MR(Us.GetAnimatables,this.IR),this.IR.animatables}getActiveTextures(){return this.IR.activeTextures=[],this.MR(Us.GetActiveTextures,this.IR),this.IR.activeTextures}hasTexture(t){return this.IR.hasTexture=!1,this.IR.texture=t,this.MR(Us.HasTexture,this.IR),this.IR.hasTexture}clone(t){return null}getBindedMeshes(){if(this.meshMap){const t=new Array;for(const i in this.meshMap){const e=this.meshMap[i];e&&t.push(e)}return t}return this.Kt.meshes.filter((t=>t.material===this))}forceCompilation(t,i,e,s){const n={clipPlane:!1,useInstances:!1,...e},r=this.getScene(),h=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const o=()=>{if(!this.Kt||!this.Kt.getEngine())return;const e=r.clipPlane;if(n.clipPlane&&(r.clipPlane=new Pe(0,0,0,1)),this.Lg){let e=!0,r=null;if(t.subMeshes){const i=new Ss(0,0,0,0,0,t,void 0,!1,!1);i.materialDefines&&(i.materialDefines.Sv=-1),this.isReadyForSubMesh(t,i,n.useInstances)||(i.effect&&i.effect.getCompilationError()&&i.effect.allFallbacksProcessed()?r=i.effect.getCompilationError():(e=!1,setTimeout(o,16)))}e&&(this.allowShaderHotSwapping=h,r&&s&&s(r),i&&i(this))}else this.isReady()?(this.allowShaderHotSwapping=h,i&&i(this)):setTimeout(o,16);n.clipPlane&&(r.clipPlane=e)};o()}forceCompilationAsync(t,i){return new Promise(((e,s)=>{this.forceCompilation(t,(()=>{e()}),i,(t=>{s(t)}))}))}markAsDirty(t){this.getScene().blockMaterialDirtyMechanism||this.vR||(Vs.iI.length=0,t&Vs.TextureDirtyFlag&&Vs.iI.push(Vs.eI),t&Vs.LightDirtyFlag&&Vs.iI.push(Vs.sI),t&Vs.FresnelDirtyFlag&&Vs.iI.push(Vs.nI),t&Vs.AttributesDirtyFlag&&Vs.iI.push(Vs.rI),t&Vs.MiscDirtyFlag&&Vs.iI.push(Vs.hI),t&Vs.PrePassDirtyFlag&&Vs.iI.push(Vs.oI),Vs.iI.length&&this.aI(Vs.lI),this.getScene().resetCachedMaterial())}resetDrawCache(){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const t of i.subMeshes)t.getMaterial()===this&&t.resetDrawCache()}aI(t){if(this.getScene().blockMaterialDirtyMechanism||this.vR)return;const i=this.getScene().meshes;for(const e of i)if(e.subMeshes)for(const i of e.subMeshes)if(i.getMaterial(!1)===this)for(const e of i.vC)e&&e.defines&&e.defines.markAllAsDirty&&this.WR===e.materialContext&&t(e.defines)}cI(){if(this.getScene().blockMaterialDirtyMechanism||this.vR)return;const t=this.getScene().enablePrePassRenderer();t&&t.markAsDirty()}XR(){this.aI(Vs.uI)}fI(){this.aI(Vs.dI)}UR(){this.aI(Vs.eI)}kR(){this.aI(Vs.nI)}pI(){this.aI(Vs.mI)}VR(){this.aI(Vs.sI)}GR(){this.aI(Vs.rI)}zR(){this.aI(Vs.hI)}HR(){this.aI(Vs.hI)}jR(){this.aI(Vs.vI)}setPrePassRenderer(t){return!1}dispose(t,i,e){const s=this.getScene();if(s.stopAnimation(this),s.freeProcessedMaterials(),s.removeMaterial(this),this.IR.forceDisposeTextures=i,this.MR(Us.Disposed,this.IR),this.Si){const t=this.Si.materials.indexOf(this);t>-1&&this.Si.materials.splice(t,1),this.Si=null}if(!0!==e)if(this.meshMap)for(const i in this.meshMap){const e=this.meshMap[i];e&&(e.material=null,this.releaseVertexArrayObject(e,t))}else{const i=s.meshes;for(const e of i)e.material!==this||e.sourceMesh||(e.material=null,this.releaseVertexArrayObject(e,t))}this.VT.dispose(),t&&this.SC.effect&&(this.Lg||this.SC.effect.dispose(),this.SC.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.ls&&this.ls.clear(),this.gR&&this.gR.clear(),this.$R&&this.$R.clear(),this.IR&&(this.IR={})}releaseVertexArrayObject(t,i){if(t.geometry){const e=t.geometry;if(this.Lg)for(const s of t.subMeshes)e.jC(s.effect),i&&s.effect&&s.effect.dispose();else e.jC(this.SC.effect)}}serialize(){const t=ot.Serialize(this);return t.stencil=this.stencil.serialize(),t.uniqueId=this.uniqueId,t}static Parse(t,i,e){if(t.customType){if("BABYLON.PBRMaterial"===t.customType&&t.overloadedAlbedo&&(t.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return F.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null}else t.customType="BABYLON.StandardMaterial";const s=ki.Instantiate(t.customType).Parse(t,i,e);return s.hw=t.uniqueId,s}}Vs.TriangleFillMode=0,Vs.WireFrameFillMode=1,Vs.PointFillMode=2,Vs.PointListDrawMode=3,Vs.LineListDrawMode=4,Vs.LineLoopDrawMode=5,Vs.LineStripDrawMode=6,Vs.TriangleStripDrawMode=7,Vs.TriangleFanDrawMode=8,Vs.ClockWiseSideOrientation=0,Vs.CounterClockWiseSideOrientation=1,Vs.TextureDirtyFlag=1,Vs.LightDirtyFlag=2,Vs.FresnelDirtyFlag=4,Vs.AttributesDirtyFlag=8,Vs.MiscDirtyFlag=16,Vs.PrePassDirtyFlag=32,Vs.AllDirtyFlag=63,Vs.MATERIAL_OPAQUE=0,Vs.MATERIAL_ALPHATEST=1,Vs.MATERIAL_ALPHABLEND=2,Vs.MATERIAL_ALPHATESTANDBLEND=3,Vs.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,Vs.MATERIAL_NORMALBLENDMETHOD_RNM=1,Vs.OnEventObservable=new h,Vs.uI=t=>t.markAllAsDirty(),Vs.dI=t=>t.markAsImageProcessingDirty(),Vs.eI=t=>t.markAsTexturesDirty(),Vs.nI=t=>t.markAsFresnelDirty(),Vs.hI=t=>t.markAsMiscDirty(),Vs.oI=t=>t.markAsPrePassDirty(),Vs.sI=t=>t.markAsLightDirty(),Vs.rI=t=>t.markAsAttributesDirty(),Vs.mI=t=>{Vs.nI(t),Vs.hI(t)},Vs.vI=t=>{Vs.eI(t),Vs.hI(t)},Vs.iI=[],Vs.lI=t=>{for(const i of Vs.iI)i(t)},ut([Q()],Vs.prototype,"id",void 0),ut([Q()],Vs.prototype,"uniqueId",void 0),ut([Q()],Vs.prototype,"name",void 0),ut([Q()],Vs.prototype,"metadata",void 0),ut([Q()],Vs.prototype,"checkReadyOnEveryCall",void 0),ut([Q()],Vs.prototype,"checkReadyOnlyOnce",void 0),ut([Q()],Vs.prototype,"state",void 0),ut([Q("alpha")],Vs.prototype,"_alpha",void 0),ut([Q("backFaceCulling")],Vs.prototype,"_backFaceCulling",void 0),ut([Q("cullBackFaces")],Vs.prototype,"_cullBackFaces",void 0),ut([Q()],Vs.prototype,"sideOrientation",void 0),ut([Q("alphaMode")],Vs.prototype,"_alphaMode",void 0),ut([Q()],Vs.prototype,"_needDepthPrePass",void 0),ut([Q()],Vs.prototype,"disableDepthWrite",void 0),ut([Q()],Vs.prototype,"disableColorWrite",void 0),ut([Q()],Vs.prototype,"forceDepthWrite",void 0),ut([Q()],Vs.prototype,"depthFunction",void 0),ut([Q()],Vs.prototype,"separateCullingPass",void 0),ut([Q("fogEnabled")],Vs.prototype,"_fogEnabled",void 0),ut([Q()],Vs.prototype,"pointSize",void 0),ut([Q()],Vs.prototype,"zOffset",void 0),ut([Q()],Vs.prototype,"zOffsetUnits",void 0),ut([Q()],Vs.prototype,"pointsCloud",null),ut([Q()],Vs.prototype,"fillMode",null),ut([Q()],Vs.prototype,"transparencyMode",null);class ks extends Vs{constructor(t,i){super(t,i,!0),this.gI=[],this.getScene().multiMaterials.push(this),this.subMaterials=new Array,this.Lg=!0}get subMaterials(){return this.SI}set subMaterials(t){this.SI=t,this.EI(t)}getChildren(){return this.subMaterials}EI(t){const i=t.push;t.push=(...e)=>{const s=i.apply(t,e);return this.UR(),s};const e=t.splice;t.splice=(i,s)=>{const n=e.apply(t,[i,s]);return this.UR(),n}}getSubMaterial(t){return t<0||t>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[t]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map((t=>t?t.getActiveTextures():[])))}hasTexture(t){var i;if(super.hasTexture(t))return!0;for(let e=0;e<this.subMaterials.length;e++)if(null===(i=this.subMaterials[e])||void 0===i?void 0:i.hasTexture(t))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(t,i,e){for(let s=0;s<this.subMaterials.length;s++){const n=this.subMaterials[s];if(n){if(n.Lg){if(!n.isReadyForSubMesh(t,i,e))return!1;continue}if(!n.isReady(t))return!1}}return!0}clone(t,i){const e=new ks(t,this.getScene());for(let s=0;s<this.subMaterials.length;s++){let n=null;const r=this.subMaterials[s];n=i&&r?r.clone(t+"-"+r.name):this.subMaterials[s],e.subMaterials.push(n)}return e}serialize(){const t={};t.name=this.name,t.id=this.id,t.uniqueId=this.uniqueId,H&&(t.tags=H.GetTags(this)),t.materialsUniqueIds=[],t.materials=[];for(let i=0;i<this.subMaterials.length;i++){const e=this.subMaterials[i];e?(t.materialsUniqueIds.push(e.uniqueId),t.materials.push(e.id)):(t.materialsUniqueIds.push(null),t.materials.push(null))}return t}dispose(t,i,e){const s=this.getScene();if(!s)return;if(e)for(let e=0;e<this.subMaterials.length;e++){const s=this.subMaterials[e];s&&s.dispose(t,i)}const n=s.multiMaterials.indexOf(this);n>=0&&s.multiMaterials.splice(n,1),super.dispose(t,i)}static ParseMultiMaterial(t,i){const e=new ks(t.name,i);return e.id=t.id,e.hw=t.uniqueId,H&&H.AddTagsTo(e,t.tags),t.materialsUniqueIds?e.gI=t.materialsUniqueIds:t.materials.forEach((t=>e.subMaterials.push(i.getLastMaterialById(t)))),e}}v("BABYLON.MultiMaterial",ks);class Gs{constructor(t,i){this.distanceOrScreenCoverage=t,this.mesh=i}}class zs{}class Hs{constructor(){this.visibleInstances={},this.batchCache=new Xs,this.batchCacheReplacementModeInFrozenMode=new Xs,this.instancesBufferSize=2048}}class Xs{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}}class Ws{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class $s{constructor(){this.AI=!1,this.$n=null,this.meshMap=null,this.CI=-1,this.wI=new Array,this.xI=!1,this.TI=null,this.RI=0}}class Ys extends ys{constructor(t,i=null,e=null,s=null,n,r=!0){if(super(t,i),this.II=new $s,this.delayLoadState=0,this.instances=new Array,this.MI=null,this.qC=null,this.bI=new Hs,this._I=new Ws,this.cw=!1,this.yI=Ys.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,i=this.getScene(),this.NI=(t,i,e)=>{t&&e&&(this.VT?this.transferToEffect(i):e.bindOnlyWorldMatrix(i))},s){if(s.qC&&s.qC.applyToMesh(this),k.DeepCopy(s,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),this.II.$n=s,i.useClonedMeshMap&&(s.II.meshMap||(s.II.meshMap={}),s.II.meshMap[this.uniqueId]=this),this.yI=s.yI,this.MI=s.MI,s.Ei){const t=s.Ei;for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&t[i]&&this.createAnimationRange(i,t[i].from,t[i].to)}if(s.metadata&&s.metadata.clone?this.metadata=s.metadata.clone():this.metadata=s.metadata,H&&H.HasTags(s)&&H.AddTagsTo(this,H.GetTags(s,!0)),this.setEnabled(s.isEnabled(!1)),this.parent=s.parent,this.setPivotMatrix(s.getPivotMatrix()),this.id=t+"."+s.id,this.material=s.material,!n){const i=s.getDescendants(!0);for(let e=0;e<i.length;e++){const s=i[e];s.clone&&s.clone(t+"."+s.name,this)}}if(s.morphTargetManager&&(this.morphTargetManager=s.morphTargetManager),i.getPhysicsEngine){const t=i.getPhysicsEngine();if(r&&t&&1===t.getPluginVersion()){const i=t.getImpostorForPhysicsObject(s);i&&(this.physicsImpostor=i.clone(this))}}for(let t=0;t<i.particleSystems.length;t++){const e=i.particleSystems[t];e.emitter===s&&e.clone(e.name,this)}this.skeleton=s.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}null!==e&&(this.parent=e),this.bI.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this.II.DI=t=>{t.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this.II.LI||(this.II.LI=this.Kt.onBeforeRenderObservable.add((()=>{this.isReady(!0)&&(this.Kt.onBeforeRenderObservable.remove(this.II.LI),this.II.LI=null,this.onMeshReadyObservable.notifyObservers(this))})))},this.onMeshReadyObservable=new h(this.II.DI),s&&s.onClonedObservable.notifyObservers(this)}static OI(t){return t||Ys.FRONTSIDE}get useLODScreenCoverage(){return this.II.xI}set useLODScreenCoverage(t){this.II.xI=t,this.FI()}get computeBonesUsingShaders(){return this._m.ST}set computeBonesUsingShaders(t){this._m.ST!==t&&(t&&this.II.BI&&(this.setVerticesData(he.PositionKind,this.II.BI,!0),this.II.UI&&this.setVerticesData(he.NormalKind,this.II.UI,!0),this.II.BI=null,this.II.UI=null),this._m.ST=t,this.tw())}get onBeforeRenderObservable(){return this.II.VI||(this.II.VI=new h),this.II.VI}get onBeforeBindObservable(){return this.II.kI||(this.II.kI=new h),this.II.kI}get onAfterRenderObservable(){return this.II.GI||(this.II.GI=new h),this.II.GI}get onBetweenPassObservable(){return this.II.zI||(this.II.zI=new h),this.II.zI}get onBeforeDrawObservable(){return this.II.HI||(this.II.HI=new h),this.II.HI}set onBeforeDraw(t){this.XI&&this.onBeforeDrawObservable.remove(this.XI),this.XI=this.onBeforeDrawObservable.add(t)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){var t;return(null!==(t=this._I.instancesCount)&&void 0!==t?t:0)>0}get forcedInstanceCount(){return this.II.RI}set forcedInstanceCount(t){this.II.RI=t}get source(){return this.II.$n}get cloneMeshMap(){return this.II.meshMap}get isUnIndexed(){return this.IC}set isUnIndexed(t){this.IC!==t&&(this.IC=t,this.tw())}get worldMatrixInstancedBuffer(){return this.bI.instancesData}get previousWorldMatrixInstancedBuffer(){return this.bI.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this.bI.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(t){this.bI.manualUpdate=t}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this.bI.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(t){this.bI.previousManualUpdate=t}get forceWorldMatrixInstancedBufferUpdate(){return this.bI.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(t){this.bI.forceMatrixUpdates=t}instantiateHierarchy(t=null,i,e){const s=0===this.getTotalVertices()||i&&i.doNotInstantiate&&(!0===i.doNotInstantiate||i.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),t||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));s.parent=t||this.parent,s.position=this.position.clone(),s.scaling=this.scaling.clone(),this.rotationQuaternion?s.rotationQuaternion=this.rotationQuaternion.clone():s.rotation=this.rotation.clone(),e&&e(this,s);for(const t of this.getChildTransformNodes(!0))"InstancedMesh"===t.getClassName()&&"Mesh"===s.getClassName()?t.instantiateHierarchy(s,{doNotInstantiate:i&&i.doNotInstantiate||!1,newSourcedMesh:s},e):t.instantiateHierarchy(s,i,e);return s}getClassName(){return"Mesh"}get Mt(){return!0}toString(t){let i=super.toString(t);if(i+=", n vertices: "+this.getTotalVertices(),i+=", parent: "+(this.xi?this.xi:this.parent?this.parent.name:"NONE"),this.animations)for(let e=0;e<this.animations.length;e++)i+=", animation[0]: "+this.animations[e].toString(t);if(t)if(this.qC){const t=this.getIndices(),e=this.getVerticesData(he.PositionKind);e&&t&&(i+=", flat shading: "+(e.length/3===t.length?"YES":"NO"))}else i+=", flat shading: UNKNOWN";return i}XT(){super.XT();for(const t of this.instances)t.XT()}get hasLODLevels(){return this.II.wI.length>0}getLODLevels(){return this.II.wI}FI(){const t=this.II.xI?-1:1;this.II.wI.sort(((i,e)=>i.distanceOrScreenCoverage<e.distanceOrScreenCoverage?t:i.distanceOrScreenCoverage>e.distanceOrScreenCoverage?-t:0))}addLODLevel(t,i){if(i&&i.NT)return F.Warn("You cannot use a mesh as LOD level twice"),this;const e=new Gs(t,i);return this.II.wI.push(e),i&&(i.NT=this),this.FI(),this}getLODLevelAtDistance(t){const i=this.II;for(let e=0;e<i.wI.length;e++){const s=i.wI[e];if(s.distanceOrScreenCoverage===t)return s.mesh}return null}removeLODLevel(t){const i=this.II;for(let e=0;e<i.wI.length;e++)i.wI[e].mesh===t&&(i.wI.splice(e,1),t&&(t.NT=null));return this.FI(),this}getLOD(t,i){const e=this.II;if(!e.wI||0===e.wI.length)return this;const s=i||this.getBoundingInfo().boundingSphere,n=t.mode===hs.ORTHOGRAPHIC_CAMERA?t.minZ:s.centerWorld.subtract(t.globalPosition).length();let r=n,h=1;if(e.xI){const i=t.screenArea;let e=s.radiusWorld*t.minZ/n;e=e*e*Math.PI,r=e/i,h=-1}if(h*e.wI[e.wI.length-1].distanceOrScreenCoverage>h*r)return this.onLODLevelSelection&&this.onLODLevelSelection(r,this,this),this;for(let t=0;t<e.wI.length;t++){const i=e.wI[t];if(h*i.distanceOrScreenCoverage<h*r){if(i.mesh){if(4===i.mesh.delayLoadState)return i.mesh.WI(),this;if(2===i.mesh.delayLoadState)return this;i.mesh.nS(),i.mesh.iR(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(r,this,i.mesh),i.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(r,this,this),this}get geometry(){return this.qC}getTotalVertices(){return null===this.qC||void 0===this.qC?0:this.qC.getTotalVertices()}getVerticesData(t,i,e){var s,n;if(!this.qC)return null;let r=null===(n=null===(s=this.$I)||void 0===s?void 0:s.vertexBuffers[t])||void 0===n?void 0:n.getFloatData(this.qC.getTotalVertices(),e||i&&1!==this.qC.meshes.length);return r||(r=this.qC.getVerticesData(t,i,e)),r}getVertexBuffer(t){var i,e;return this.qC?null!==(e=null===(i=this.$I)||void 0===i?void 0:i.vertexBuffers[t])&&void 0!==e?e:this.qC.getVertexBuffer(t):null}isVerticesDataPresent(t){var i;return this.qC?void 0!==(null===(i=this.$I)||void 0===i?void 0:i.vertexBuffers[t])||this.qC.isVerticesDataPresent(t):!!this.YC&&-1!==this.YC.indexOf(t)}isVertexBufferUpdatable(t){var i,e;return this.qC?(null===(e=null===(i=this.$I)||void 0===i?void 0:i.vertexBuffers[t])||void 0===e?void 0:e.isUpdatable())||this.qC.isVertexBufferUpdatable(t):!!this.YC&&-1!==this.YC.indexOf(t)}getVerticesDataKinds(){if(!this.qC){const t=new Array;return this.YC&&this.YC.forEach((function(i){t.push(i)})),t}const t=this.qC.getVerticesDataKinds();if(this.$I)for(const i in this.$I.vertexBuffers)t.push(i);return t}getTotalIndices(){return this.qC?this.qC.getTotalIndices():0}getIndices(t,i){return this.qC?this.qC.getIndices(t,i):[]}get isBlocked(){return null!==this.NT&&void 0!==this.NT}isReady(t=!1,i=!1){var e,s,n,r,h,o;if(2===this.delayLoadState)return!1;if(!super.isReady(t))return!1;if(!this.subMeshes||0===this.subMeshes.length)return!0;if(!t)return!0;const a=this.getEngine(),l=this.getScene(),c=i||a.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const u=this.material||l.defaultMaterial;if(u)if(u.Lg)for(const t of this.subMeshes){const i=t.getMaterial();if(i)if(i.Lg){if(!i.isReadyForSubMesh(this,t,c))return!1}else if(!i.isReady(this,c))return!1}else if(!u.isReady(this,c))return!1;const f=a.currentRenderPassId;for(const t of this.lightSources){const i=t.getShadowGenerators();if(!i)continue;const l=i.values();for(let t=l.next();!0!==t.done;t=l.next()){const i=t.value;if(i&&(!(null===(e=i.getShadowMap())||void 0===e?void 0:e.renderList)||(null===(s=i.getShadowMap())||void 0===s?void 0:s.renderList)&&-1!==(null===(r=null===(n=i.getShadowMap())||void 0===n?void 0:n.renderList)||void 0===r?void 0:r.indexOf(this)))){i.getShadowMap()&&(a.currentRenderPassId=i.getShadowMap().renderPassId);for(const t of this.subMeshes)if(!i.isReady(t,c,null!==(o=null===(h=t.getMaterial())||void 0===h?void 0:h.needAlphaBlendingForMesh(this))&&void 0!==o&&o))return a.currentRenderPassId=f,!1;a.currentRenderPassId=f}}}for(const t of this.II.wI)if(t.mesh&&!t.mesh.isReady(c))return!1;return!0}get areNormalsFrozen(){return this.II.AI}freezeNormals(){return this.II.AI=!0,this}unfreezeNormals(){return this.II.AI=!1,this}set overridenInstanceCount(t){this.bI.overridenInstanceCount=t}nS(){const t=this.II,i=this.getScene().getRenderId();return t.CI===i||(t.CI=i,this.bI.visibleInstances=null),this}QT(t){return this.bI.visibleInstances&&(this.bI.visibleInstances.intermediateDefaultRenderId=t),this}YI(t,i){return this.bI.visibleInstances||(this.bI.visibleInstances={defaultRenderId:i,selfDefaultRenderId:this.Sv}),this.bI.visibleInstances[i]||(void 0!==this.bI.previousRenderId&&this.bI.isFrozen&&(this.bI.visibleInstances[this.bI.previousRenderId]=null),this.bI.previousRenderId=i,this.bI.visibleInstances[i]=new Array),this.bI.visibleInstances[i].push(t),this}Yx(){super.Yx(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}lS(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this.Wf&&(this.Wf.Mf.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(t=!1,i=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const e=this.geometry?this.geometry.boundingBias:null;return this.ZT(this.JT(t,i),e),this}WC(t){const i=this.getTotalVertices();if(!i||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const e=this.getIndices();if(!e)return null;const s=e.length;let n=!1;if(t)n=!0;else for(const t of this.subMeshes){if(t.indexStart+t.indexCount>s){n=!0;break}if(t.verticesStart+t.verticesCount>i){n=!0;break}}if(!n)return this.subMeshes[0]}return this.releaseSubMeshes(),new Ss(0,0,i,0,this.getTotalIndices(),this)}subdivide(t){if(t<1)return;const i=this.getTotalIndices();let e=i/t|0,s=0;for(;e%3!=0;)e++;this.releaseSubMeshes();for(let n=0;n<t&&!(s>=i);n++)Ss.CreateFromIndices(0,s,n===t-1?i-s:e,this),s+=e;this.synchronizeInstances()}setVerticesData(t,i,e=!1,s){if(this.qC)this.qC.setVerticesData(t,i,e,s);else{const s=new os;s.set(i,t);const n=this.getScene();new Cs(Cs.RandomId(),n,s,e,this)}return this}removeVerticesData(t){this.qC&&this.qC.removeVerticesData(t)}markVerticesDataAsUpdatable(t,i=!0){const e=this.getVertexBuffer(t);e&&e.isUpdatable()!==i&&this.setVerticesData(t,this.getVerticesData(t),i)}setVerticesBuffer(t,i=!0){return this.qC||(this.qC=Cs.CreateGeometryForMesh(this)),this.qC.setVerticesBuffer(t,null,i),this}updateVerticesData(t,i,e,s){return this.qC?(s?(this.makeGeometryUnique(),this.updateVerticesData(t,i,e,!1)):this.qC.updateVerticesData(t,i,e),this):this}updateMeshPositions(t,i=!0){const e=this.getVerticesData(he.PositionKind);if(!e)return this;if(t(e),this.updateVerticesData(he.PositionKind,e,!1,!1),i){const t=this.getIndices(),i=this.getVerticesData(he.NormalKind);if(!i)return this;os.ComputeNormals(e,t,i),this.updateVerticesData(he.NormalKind,i,!1,!1)}return this}makeGeometryUnique(){if(!this.qC)return this;if(1===this.qC.meshes.length)return this;const t=this.qC,i=this.qC.copy(Cs.RandomId());return t.releaseForMesh(this,!0),i.applyToMesh(this),this}setIndices(t,i=null,e=!1){if(this.qC)this.qC.setIndices(t,i,e);else{const i=new os;i.indices=t;const s=this.getScene();new Cs(Cs.RandomId(),s,i,e,this)}return this}updateIndices(t,i,e=!1){return this.qC?(this.qC.updateIndices(t,i,e),this):this}toLeftHanded(){return this.qC?(this.qC.toLeftHanded(),this):this}$C(t,i,e){if(!this.qC)return this;const s=this.getScene().getEngine();let n;if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager.$C(i),this.IC)n=null;else switch(e){case Vs.PointFillMode:n=null;break;case Vs.WireFrameFillMode:n=t.xC(this.getIndices(),s);break;default:case Vs.TriangleFillMode:n=this.qC.getIndexBuffer()}return!this.$I||this.hasThinInstances?this.qC.$C(i,n):this.qC.$C(i,n,this.$I.vertexBuffers,this.$I.vertexArrayObjects),this}jI(t,i,e){if(!this.qC||!this.qC.getVertexBuffers()||!this.IC&&!this.qC.getIndexBuffer())return this;this.II.HI&&this.II.HI.notifyObservers(this);const s=this.getScene().getEngine();return this.IC||i==Vs.PointFillMode?s.drawArraysType(i,t.verticesStart,t.verticesCount,this.forcedInstanceCount||e):i==Vs.WireFrameFillMode?s.drawElementsType(i,0,t.oC,this.forcedInstanceCount||e):s.drawElementsType(i,t.indexStart,t.indexCount,this.forcedInstanceCount||e),this}registerBeforeRender(t){return this.onBeforeRenderObservable.add(t),this}unregisterBeforeRender(t){return this.onBeforeRenderObservable.removeCallback(t),this}registerAfterRender(t){return this.onAfterRenderObservable.add(t),this}unregisterAfterRender(t){return this.onAfterRenderObservable.removeCallback(t),this}KI(t,i=!1){if(this.bI.isFrozen){if(i)return this.bI.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[t]=!1,this.bI.batchCacheReplacementModeInFrozenMode.renderSelf[t]=!0,this.bI.batchCacheReplacementModeInFrozenMode;if(this.bI.previousBatch)return this.bI.previousBatch}const e=this.getScene(),s=e.Qg(),n=s?this._m.AT:this._m.oS,r=this.bI.batchCache;if(r.mustReturn=!1,r.renderSelf[t]=i||!n&&this.isEnabled()&&this.isVisible,r.visibleInstances[t]=null,this.bI.visibleInstances&&!i){const i=this.bI.visibleInstances,n=e.getRenderId(),h=s?i.intermediateDefaultRenderId:i.defaultRenderId;r.visibleInstances[t]=i[n],!r.visibleInstances[t]&&h&&(r.visibleInstances[t]=i[h])}return r.hardwareInstancedRendering[t]=!i&&this.bI.hardwareInstancedRendering&&null!==r.visibleInstances[t]&&void 0!==r.visibleInstances[t],this.bI.previousBatch=r,r}qI(t,i,e,s,n){var r;const h=e.visibleInstances[t.Al],o=h?h.length:0,a=this.bI,l=a.instancesBufferSize;let c=a.instancesBuffer,u=a.instancesPreviousBuffer;const f=16*(o+1)*4;for(;a.instancesBufferSize<f;)a.instancesBufferSize*=2;a.instancesData&&l==a.instancesBufferSize||(a.instancesData=new Float32Array(a.instancesBufferSize/4)),(this.Kt.needsPreviousWorldMatrices&&!a.instancesPreviousData||l!=a.instancesBufferSize)&&(a.instancesPreviousData=new Float32Array(a.instancesBufferSize/4));let d=0,p=0;const m=e.renderSelf[t.Al],v=!c||l!==a.instancesBufferSize||this.Kt.needsPreviousWorldMatrices&&!a.instancesPreviousBuffer;if(this.bI.manualUpdate||a.isFrozen&&!v)p=(m?1:0)+o;else{const i=this.getWorldMatrix();if(m&&(this.Kt.needsPreviousWorldMatrices&&(a.masterMeshPreviousWorldMatrix?(a.masterMeshPreviousWorldMatrix.copyToArray(a.instancesPreviousData,d),a.masterMeshPreviousWorldMatrix.copyFrom(i)):(a.masterMeshPreviousWorldMatrix=i.clone(),a.masterMeshPreviousWorldMatrix.copyToArray(a.instancesPreviousData,d))),i.copyToArray(a.instancesData,d),d+=16,p++),h){if(Ys.INSTANCEDMESH_SORT_TRANSPARENT&&this.Kt.activeCamera&&(null===(r=t.getMaterial())||void 0===r?void 0:r.needAlphaBlendingForMesh(t.getRenderingMesh()))){const t=this.Kt.activeCamera.globalPosition;for(let i=0;i<h.length;i++){const e=h[i];e.zf=w.Distance(e.getBoundingInfo().boundingSphere.centerWorld,t)}h.sort(((t,i)=>t.zf>i.zf?-1:t.zf<i.zf?1:0))}for(let t=0;t<h.length;t++){const i=h[t],e=i.getWorldMatrix();e.copyToArray(a.instancesData,d),this.Kt.needsPreviousWorldMatrices&&(i.QI?(i.QI.copyToArray(a.instancesPreviousData,d),i.QI.copyFrom(e)):(i.QI=e.clone(),i.QI.copyToArray(a.instancesPreviousData,d))),d+=16,p++}}}return v?(c&&c.dispose(),u&&u.dispose(),c=new re(n,a.instancesData,!0,16,!1,!0),a.instancesBuffer=c,this.$I||(this.$I={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.$I.vertexBuffers.world0=c.createVertexBuffer("world0",0,4),this.$I.vertexBuffers.world1=c.createVertexBuffer("world1",4,4),this.$I.vertexBuffers.world2=c.createVertexBuffer("world2",8,4),this.$I.vertexBuffers.world3=c.createVertexBuffer("world3",12,4),this.Kt.needsPreviousWorldMatrices&&(u=new re(n,a.instancesPreviousData,!0,16,!1,!0),a.instancesPreviousBuffer=u,this.$I.vertexBuffers.previousWorld0=u.createVertexBuffer("previousWorld0",0,4),this.$I.vertexBuffers.previousWorld1=u.createVertexBuffer("previousWorld1",4,4),this.$I.vertexBuffers.previousWorld2=u.createVertexBuffer("previousWorld2",8,4),this.$I.vertexBuffers.previousWorld3=u.createVertexBuffer("previousWorld3",12,4)),this.KC()):this.bI.isFrozen&&!this.bI.forceMatrixUpdates||(c.updateDirectly(a.instancesData,0,p),!this.Kt.needsPreviousWorldMatrices||this.bI.manualUpdate&&!this.bI.previousManualUpdate||u.updateDirectly(a.instancesPreviousData,0,p)),this.ZI(h,m),this.getScene().mv.addCount(t.indexCount*p,!1),n.JI&&(n.JI.useInstancing=!0),this.$C(t,s,i),this.jI(t,i,p),!this.Kt.needsPreviousWorldMatrices||v||!this.bI.manualUpdate||this.bI.isFrozen&&!this.bI.forceMatrixUpdates||this.bI.previousManualUpdate||u.updateDirectly(a.instancesData,0,p),n.unbindInstanceAttributes(),this}tM(t,i,e,s){var n,r;const h=null!==(r=null===(n=this._I)||void 0===n?void 0:n.instancesCount)&&void 0!==r?r:0;this.getScene().mv.addCount(t.indexCount*h,!1),s.JI&&(s.JI.useInstancing=!0),this.$C(t,e,i),this.jI(t,i,h),this.Kt.needsPreviousWorldMatrices&&!this._I.previousMatrixData&&this._I.matrixData&&(this._I.previousMatrixBuffer?this._I.previousMatrixBuffer.updateDirectly(this._I.matrixData,0,h):this._I.previousMatrixBuffer=this.iM("previousWorld",this._I.matrixData,!1)),s.unbindInstanceAttributes()}ZI(t,i){}eM(t,i,e,s,n,r,h,o){const a=this.getScene(),l=a.getEngine();if(r&&i.getRenderingMesh().hasThinInstances)return this.tM(i,s,e,l),this;if(r)this.qI(i,s,n,e,l);else{l.JI&&(l.JI.useInstancing=!1);let e=0;n.renderSelf[i.Al]&&(h&&h(!1,t.getWorldMatrix(),o),e++,this.jI(i,s,this.bI.overridenInstanceCount));const r=n.visibleInstances[i.Al];if(r){const t=r.length;e+=t;for(let e=0;e<t;e++){const t=r[e].getWorldMatrix();h&&h(!0,t,o),this.jI(i,s)}}a.mv.addCount(i.indexCount*e,!1)}return this}br(t=!1){if(this.bI.instancesBuffer&&(t&&this.bI.instancesBuffer.dispose(),this.bI.instancesBuffer=null),this.$I){for(const i in this.$I.vertexBuffers){const e=this.$I.vertexBuffers[i];e&&(t&&e.dispose(),this.$I.vertexBuffers[i]=null)}this.$I.vertexArrayObjects&&(this.$I.vertexArrayObjects={})}this.II.TI=null,super.br(t)}Jg(){if(this.subMeshes){for(let t=0;t<this.subMeshes.length;t++)this.KI(t);this.II.TI=null,this.bI.isFrozen=!0}}iS(){this.bI.isFrozen=!1,this.bI.previousBatch=null}render(t,i,e){var s,n,r;const h=this.getScene();if(this._m.ET?this._m.ET=!1:this._m.tS=!1,this.aR()&&!this.sM.forceRenderingWhenOccluded)return this;const o=this.KI(t.Al,!!e);if(o.mustReturn)return this;if(!this.qC||!this.qC.getVertexBuffers()||!this.IC&&!this.qC.getIndexBuffer())return this;const a=h.getEngine();let l=0,c=null;this.ignoreCameraMaxZ&&h.activeCamera&&!h.Qg()&&(l=h.activeCamera.maxZ,c=h.activeCamera,h.activeCamera.maxZ=0,h.updateTransformMatrix(!0)),this.II.VI&&this.II.VI.notifyObservers(this);const u=t.getRenderingMesh(),f=o.hardwareInstancedRendering[t.Al]||u.hasThinInstances||!!this.$I&&!t.getMesh()._m.hS,d=this.bI,p=t.getMaterial();if(!p)return c&&(c.maxZ=l,h.updateTransformMatrix(!0)),this;if(d.isFrozen&&this.II.TI&&this.II.TI===p){if(p.Lg&&!(null===(s=t.effect)||void 0===s?void 0:s.cs)||!p.Lg&&!(null===(n=p.getEffect())||void 0===n?void 0:n.cs))return c&&(c.maxZ=l,h.updateTransformMatrix(!0)),this}else{if(p.Lg){if(!p.isReadyForSubMesh(this,t,f))return c&&(c.maxZ=l,h.updateTransformMatrix(!0)),this}else if(!p.isReady(this,f))return c&&(c.maxZ=l,h.updateTransformMatrix(!0)),this;this.II.TI=p}let m;i&&a.setAlphaMode(this.II.TI.alphaMode),m=this.II.TI.Lg?t.SC:this.II.TI.mC();const v=null!==(r=null==m?void 0:m.effect)&&void 0!==r?r:null;for(const i of h.Qv)i.action(this,t,o,v);if(!m||!v)return c&&(c.maxZ=l,h.updateTransformMatrix(!0)),this;const g=e||this;let S;if(d.isFrozen||!this.II.TI.backFaceCulling&&null===this.overrideMaterialSideOrientation)S=d.sideOrientation;else{const t=g.zi();S=this.overrideMaterialSideOrientation,null==S&&(S=this.II.TI.sideOrientation),t<0&&(S=S===Vs.ClockWiseSideOrientation?Vs.CounterClockWiseSideOrientation:Vs.ClockWiseSideOrientation),d.sideOrientation=S}const E=this.II.TI.QR(m,S);this.II.TI.forceDepthWrite&&a.setDepthWrite(!0);const A=h.forcePointsCloud?Vs.PointFillMode:h.forceWireframe?Vs.WireFrameFillMode:this.II.TI.fillMode;this.II.kI&&this.II.kI.notifyObservers(this),f||this.$C(t,v,A);const C=this.II.TI,w=g.getWorldMatrix();C.Lg?C.bindForSubMesh(w,this,t):C.bind(w,this),!C.backFaceCulling&&C.separateCullingPass&&(a.setState(!0,C.zOffset,!1,!E,C.cullBackFaces,C.stencil,C.zOffsetUnits),this.eM(this,t,v,A,o,f,this.NI,this.II.TI),a.setState(!0,C.zOffset,!1,E,C.cullBackFaces,C.stencil,C.zOffsetUnits),this.II.zI&&this.II.zI.notifyObservers(t)),this.eM(this,t,v,A,o,f,this.NI,this.II.TI),this.II.TI.unbind();for(const i of h.Zv)i.action(this,t,o,v);return this.II.GI&&this.II.GI.notifyObservers(this),c&&(c.maxZ=l,h.updateTransformMatrix(!0)),h.performancePriority!==Fe.Aggressive||d.isFrozen||this.Jg(),this}cleanMatrixWeights(){this.isVerticesDataPresent(he.MatricesWeightsKind)&&(this.isVerticesDataPresent(he.MatricesWeightsExtraKind)?this.nM():this.rM())}rM(){const t=this.getVerticesData(he.MatricesWeightsKind),i=t.length;for(let e=0;e<i;e+=4){const i=t[e]+t[e+1]+t[e+2]+t[e+3];if(0===i)t[e]=1;else{const s=1/i;t[e]*=s,t[e+1]*=s,t[e+2]*=s,t[e+3]*=s}}this.setVerticesData(he.MatricesWeightsKind,t)}nM(){const t=this.getVerticesData(he.MatricesWeightsExtraKind),i=this.getVerticesData(he.MatricesWeightsKind),e=i.length;for(let s=0;s<e;s+=4){let e=i[s]+i[s+1]+i[s+2]+i[s+3];if(e+=t[s]+t[s+1]+t[s+2]+t[s+3],0===e)i[s]=1;else{const n=1/e;i[s]*=n,i[s+1]*=n,i[s+2]*=n,i[s+3]*=n,t[s]*=n,t[s+1]*=n,t[s+2]*=n,t[s+3]*=n}}this.setVerticesData(he.MatricesWeightsKind,i),this.setVerticesData(he.MatricesWeightsKind,t)}validateSkinning(){const t=this.getVerticesData(he.MatricesWeightsExtraKind),i=this.getVerticesData(he.MatricesWeightsKind);if(null===i||null==this.skeleton)return{skinned:!1,valid:!0,report:"not skinned"};const e=i.length;let s=0,n=0,r=0,h=0;const o=null===t?4:8,a=new Array;for(let t=0;t<=o;t++)a[t]=0;for(let l=0;l<e;l+=4){let e=i[l],c=e,u=0===c?0:1;for(let n=1;n<o;n++){const r=n<4?i[l+n]:t[l+n-4];r>e&&s++,0!==r&&u++,c+=r,e=r}if(a[u]++,u>r&&(r=u),0===c)n++;else{const e=1/c;let s=0;for(let n=0;n<o;n++)s+=n<4?Math.abs(i[l+n]-i[l+n]*e):Math.abs(t[l+n-4]-t[l+n-4]*e);s>.001&&h++}}const l=this.skeleton.bones.length,c=this.getVerticesData(he.MatricesIndicesKind),u=this.getVerticesData(he.MatricesIndicesExtraKind);let f=0;for(let t=0;t<e;t+=4)for(let i=0;i<o;i++){const e=i<4?c[t+i]:u[t+i-4];(e>=l||e<0)&&f++}return{skinned:!0,valid:0===n&&0===h&&0===f,report:"Number of Weights = "+e/4+"\nMaximum influences = "+r+"\nMissing Weights = "+n+"\nNot Sorted = "+s+"\nNot Normalized = "+h+"\nWeightCounts = ["+a+"]\nNumber of bones = "+l+"\nBad Bone Indices = "+f}}WI(){const t=this.getScene();return this.qC?this.qC.load(t):4===this.delayLoadState&&(this.delayLoadState=2,this.iw(t)),this}iw(t){t.addPendingData(this);const i=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return ki.LoadFile(this.delayLoadingFile,(i=>{i instanceof ArrayBuffer?this.ew(i,this):this.ew(JSON.parse(i),this),this.instances.forEach((t=>{t.refreshBoundingInfo(),t.hM()})),this.delayLoadState=1,t.removePendingData(this)}),(()=>{}),t.offlineProvider,i),this}isInFrustum(t){return 2!==this.delayLoadState&&(!!super.isInFrustum(t)&&(this.WI(),!0))}setMaterialById(t){const i=this.getScene().materials;let e;for(e=i.length-1;e>-1;e--)if(i[e].id===t)return this.material=i[e],this;const s=this.getScene().multiMaterials;for(e=s.length-1;e>-1;e--)if(s[e].id===t)return this.material=s[e],this;return this}getAnimatables(){const t=new Array;return this.material&&t.push(this.material),this.skeleton&&t.push(this.skeleton),t}bakeTransformIntoVertices(t){if(!this.isVerticesDataPresent(he.PositionKind))return this;const i=this.subMeshes.splice(0);this.XC();let e=this.getVerticesData(he.PositionKind);const s=w.Zero();let n;for(n=0;n<e.length;n+=3)w.TransformCoordinatesFromFloatsToRef(e[n],e[n+1],e[n+2],t,s).toArray(e,n);if(this.setVerticesData(he.PositionKind,e,this.getVertexBuffer(he.PositionKind).isUpdatable()),this.isVerticesDataPresent(he.NormalKind)){for(e=this.getVerticesData(he.NormalKind),n=0;n<e.length;n+=3)w.TransformNormalFromFloatsToRef(e[n],e[n+1],e[n+2],t,s).normalize().toArray(e,n);this.setVerticesData(he.NormalKind,e,this.getVertexBuffer(he.NormalKind).isUpdatable())}return t.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=i,this}bakeCurrentTransformIntoVertices(t=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(t),this}get QC(){return this._m.QC?this._m.QC:this.qC?this.qC.QC:null}XC(){return this.qC&&this.qC.XC(),this}sw(){return!!this.qC&&this.qC.sw()}clone(t="",i=null,e,s=!0){return new Ys(t,this.getScene(),i,this,e,s)}dispose(t,i=!1){this.morphTargetManager=null,this.qC&&this.qC.releaseForMesh(this,!0);const e=this.II;if(e.HI&&e.HI.clear(),e.kI&&e.kI.clear(),e.VI&&e.VI.clear(),e.GI&&e.GI.clear(),e.zI&&e.zI.clear(),this.Kt.useClonedMeshMap){if(e.meshMap)for(const t in e.meshMap){const i=e.meshMap[t];i&&(i.II.$n=null,e.meshMap[t]=void 0)}e.$n&&e.$n.II.meshMap&&(e.$n.II.meshMap[this.uniqueId]=void 0)}else{const t=this.getScene().meshes;for(const i of t){const t=i;t.II&&t.II.$n&&t.II.$n===this&&(t.II.$n=null)}}e.$n=null,this.oM(),this.aM(),this.II.LI&&this.Kt.onBeforeRenderObservable.remove(this.II.LI),super.dispose(t,i)}oM(){}aM(){}KC(){}applyDisplacementMap(t,i,e,s,n,r,h=!1){const o=this.getScene();return ki.LoadImage(t,(t=>{const o=t.width,a=t.height,l=this.getEngine().createCanvas(o,a).getContext("2d");l.drawImage(t,0,0);const c=l.getImageData(0,0,o,a).data;this.applyDisplacementMapFromBuffer(c,o,a,i,e,n,r,h),s&&s(this)}),(()=>{}),o.offlineProvider),this}applyDisplacementMapFromBuffer(t,i,e,s,n,r,h,o=!1){if(!this.isVerticesDataPresent(he.PositionKind)||!this.isVerticesDataPresent(he.NormalKind)||!this.isVerticesDataPresent(he.UVKind))return F.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const a=this.getVerticesData(he.PositionKind,!0,!0),l=this.getVerticesData(he.NormalKind),c=this.getVerticesData(he.UVKind);let u=w.Zero();const f=w.Zero(),d=C.Zero();r=r||C.Zero(),h=h||new C(1,1);for(let o=0;o<a.length;o+=3){w.FromArrayToRef(a,o,u),w.FromArrayToRef(l,o,f),C.FromArrayToRef(c,o/3*2,d);const p=4*((Math.abs(d.x*h.x+r.x%1)*(i-1)%i|0)+(Math.abs(d.y*h.y+r.y%1)*(e-1)%e|0)*i),m=.3*(t[p]/255)+.59*(t[p+1]/255)+.11*(t[p+2]/255);f.normalize(),f.scaleInPlace(s+(n-s)*m),u=u.add(f),u.toArray(a,o)}return os.ComputeNormals(a,this.getIndices(),l),o?(this.setVerticesData(he.PositionKind,a),this.setVerticesData(he.NormalKind,l),this.setVerticesData(he.UVKind,c)):(this.updateVerticesData(he.PositionKind,a),this.updateVerticesData(he.NormalKind,l)),this}convertToFlatShadedMesh(){const t=this.getVerticesDataKinds(),i={},e={},s={};let n,r,h=!1;for(n=0;n<t.length;n++){r=t[n];const o=this.getVertexBuffer(r),a=o.getData();(a instanceof Array||a instanceof Float32Array)&&0===a.length||(r!==he.NormalKind?(i[r]=o,e[r]=this.getVerticesData(r),s[r]=[]):(h=o.isUpdatable(),t.splice(n,1),n--))}const o=this.subMeshes.slice(0),a=this.getIndices(),l=this.getTotalIndices();let c;for(c=0;c<l;c++){const h=a[c];for(n=0;n<t.length;n++){if(r=t[n],!i[r])continue;const o=i[r].getStrideSize();for(let t=0;t<o;t++)s[r].push(e[r][h*o+t])}}const u=[],f=s[he.PositionKind];let d;for(d=this.getScene().useRightHandedSystem?1===this.overrideMaterialSideOrientation:0===this.overrideMaterialSideOrientation,c=0;c<l;c+=3){a[c]=c,a[c+1]=c+1,a[c+2]=c+2;const t=w.FromArray(f,3*c),i=w.FromArray(f,3*(c+1)),e=w.FromArray(f,3*(c+2)),s=t.subtract(i),n=e.subtract(i),r=w.Normalize(w.Cross(s,n));d&&r.scaleInPlace(-1);for(let t=0;t<3;t++)u.push(r.x),u.push(r.y),u.push(r.z)}for(this.setIndices(a),this.setVerticesData(he.NormalKind,u,h),n=0;n<t.length;n++)r=t[n],s[r]&&this.setVerticesData(r,s[r],i[r].isUpdatable());this.releaseSubMeshes();for(let t=0;t<o.length;t++){const i=o[t];Ss.AddToMesh(i.materialIndex,i.indexStart,i.indexCount,i.indexStart,i.indexCount,this)}return this.synchronizeInstances(),this}convertToUnIndexedMesh(){const t=this.getVerticesDataKinds(),i={},e={},s={};let n,r;for(n=0;n<t.length;n++){r=t[n];const h=this.getVertexBuffer(r);i[r]=h,e[r]=i[r].getData(),s[r]=[]}const h=this.subMeshes.slice(0),o=this.getIndices(),a=this.getTotalIndices();let l;for(l=0;l<a;l++){const h=o[l];for(n=0;n<t.length;n++){r=t[n];const o=i[r].getStrideSize();for(let t=0;t<o;t++)s[r].push(e[r][h*o+t])}}for(l=0;l<a;l+=3)o[l]=l,o[l+1]=l+1,o[l+2]=l+2;for(this.setIndices(o),n=0;n<t.length;n++)r=t[n],this.setVerticesData(r,s[r],i[r].isUpdatable(),i[r].getStrideSize());this.releaseSubMeshes();for(let t=0;t<h.length;t++){const i=h[t];Ss.AddToMesh(i.materialIndex,i.indexStart,i.indexCount,i.indexStart,i.indexCount,this)}return this.IC=!0,this.synchronizeInstances(),this}flipFaces(t=!1){const i=os.ExtractFromMesh(this);let e;if(t&&this.isVerticesDataPresent(he.NormalKind)&&i.normals)for(e=0;e<i.normals.length;e++)i.normals[e]*=-1;if(i.indices){let t;for(e=0;e<i.indices.length;e+=3)t=i.indices[e+1],i.indices[e+1]=i.indices[e+2],i.indices[e+2]=t}return i.applyToMesh(this,this.isVertexBufferUpdatable(he.PositionKind)),this}increaseVertices(t=1){const i=os.ExtractFromMesh(this),e=i.indices&&!Array.isArray(i.indices)&&Array.from?Array.from(i.indices):i.indices,s=i.positions&&!Array.isArray(i.positions)&&Array.from?Array.from(i.positions):i.positions,n=i.uvs&&!Array.isArray(i.uvs)&&Array.from?Array.from(i.uvs):i.uvs,r=i.normals&&!Array.isArray(i.normals)&&Array.from?Array.from(i.normals):i.normals;if(e&&s){i.indices=e,i.positions=s,n&&(i.uvs=n),r&&(i.normals=r);const h=t+1,o=new Array;for(let t=0;t<h+1;t++)o[t]=new Array;let a,l;const c=new w(0,0,0),u=new w(0,0,0),f=new C(0,0),d=new Array,p=new Array,m=new Array;let v,g,S,E=s.length;n&&(g=n.length),r&&(S=r.length);for(let t=0;t<e.length;t+=3){p[0]=e[t],p[1]=e[t+1],p[2]=e[t+2];for(let t=0;t<3;t++)if(a=p[t],l=p[(t+1)%3],void 0===m[a]&&void 0===m[l]?(m[a]=new Array,m[l]=new Array):(void 0===m[a]&&(m[a]=new Array),void 0===m[l]&&(m[l]=new Array)),void 0===m[a][l]&&void 0===m[l][a]){m[a][l]=[],c.x=(s[3*l]-s[3*a])/h,c.y=(s[3*l+1]-s[3*a+1])/h,c.z=(s[3*l+2]-s[3*a+2])/h,r&&(u.x=(r[3*l]-r[3*a])/h,u.y=(r[3*l+1]-r[3*a+1])/h,u.z=(r[3*l+2]-r[3*a+2])/h),n&&(f.x=(n[2*l]-n[2*a])/h,f.y=(n[2*l+1]-n[2*a+1])/h),m[a][l].push(a);for(let t=1;t<h;t++)m[a][l].push(s.length/3),s[E++]=s[3*a]+t*c.x,s[E++]=s[3*a+1]+t*c.y,s[E++]=s[3*a+2]+t*c.z,r&&(r[S++]=r[3*a]+t*u.x,r[S++]=r[3*a+1]+t*u.y,r[S++]=r[3*a+2]+t*u.z),n&&(n[g++]=n[2*a]+t*f.x,n[g++]=n[2*a+1]+t*f.y);m[a][l].push(l),m[l][a]=new Array,v=m[a][l].length;for(let t=0;t<v;t++)m[l][a][t]=m[a][l][v-1-t]}o[0][0]=e[t],o[1][0]=m[e[t]][e[t+1]][1],o[1][1]=m[e[t]][e[t+2]][1];for(let i=2;i<h;i++){o[i][0]=m[e[t]][e[t+1]][i],o[i][i]=m[e[t]][e[t+2]][i],c.x=(s[3*o[i][i]]-s[3*o[i][0]])/i,c.y=(s[3*o[i][i]+1]-s[3*o[i][0]+1])/i,c.z=(s[3*o[i][i]+2]-s[3*o[i][0]+2])/i,r&&(u.x=(r[3*o[i][i]]-r[3*o[i][0]])/i,u.y=(r[3*o[i][i]+1]-r[3*o[i][0]+1])/i,u.z=(r[3*o[i][i]+2]-r[3*o[i][0]+2])/i),n&&(f.x=(n[2*o[i][i]]-n[2*o[i][0]])/i,f.y=(n[2*o[i][i]+1]-n[2*o[i][0]+1])/i);for(let t=1;t<i;t++)o[i][t]=s.length/3,s[E++]=s[3*o[i][0]]+t*c.x,s[E++]=s[3*o[i][0]+1]+t*c.y,s[E++]=s[3*o[i][0]+2]+t*c.z,r&&(r[S++]=r[3*o[i][0]]+t*u.x,r[S++]=r[3*o[i][0]+1]+t*u.y,r[S++]=r[3*o[i][0]+2]+t*u.z),n&&(n[g++]=n[2*o[i][0]]+t*f.x,n[g++]=n[2*o[i][0]+1]+t*f.y)}o[h]=m[e[t+1]][e[t+2]],d.push(o[0][0],o[1][0],o[1][1]);for(let t=1;t<h;t++){let i;for(i=0;i<t;i++)d.push(o[t][i],o[t+1][i],o[t+1][i+1]),d.push(o[t][i],o[t+1][i+1],o[t][i+1]);d.push(o[t][i],o[t+1][i],o[t+1][i+1])}}i.indices=d,i.applyToMesh(this,this.isVertexBufferUpdatable(he.PositionKind))}else F.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions")}forceSharedVertices(){const t=os.ExtractFromMesh(this),i=t.uvs,e=t.indices,s=t.positions,n=t.colors,r=t.matricesIndices,h=t.matricesWeights,o=t.matricesIndicesExtra,a=t.matricesWeightsExtra;if(void 0===e||void 0===s||null===e||null===s)F.Warn("VertexData contains empty entries");else{const l=new Array,c=new Array,u=new Array,f=new Array,d=new Array,p=new Array,m=new Array,v=new Array;let g=new Array,S=0;const E={};let A,C;for(let t=0;t<e.length;t+=3){C=[e[t],e[t+1],e[t+2]],g=new Array;for(let t=0;t<3;t++){g[t]="";for(let i=0;i<3;i++)Math.abs(s[3*C[t]+i])<1e-8&&(s[3*C[t]+i]=0),g[t]+=s[3*C[t]+i]+"|"}if(g[0]!=g[1]&&g[0]!=g[2]&&g[1]!=g[2])for(let t=0;t<3;t++){if(A=E[g[t]],void 0===A){E[g[t]]=S,A=S++;for(let i=0;i<3;i++)l.push(s[3*C[t]+i]);if(null!=n)for(let i=0;i<4;i++)f.push(n[4*C[t]+i]);if(null!=i)for(let e=0;e<2;e++)u.push(i[2*C[t]+e]);if(null!=r)for(let i=0;i<4;i++)d.push(r[4*C[t]+i]);if(null!=h)for(let i=0;i<4;i++)p.push(h[4*C[t]+i]);if(null!=o)for(let i=0;i<4;i++)m.push(o[4*C[t]+i]);if(null!=a)for(let i=0;i<4;i++)v.push(a[4*C[t]+i])}c.push(A)}}const w=new Array;os.ComputeNormals(l,c,w),t.positions=l,t.indices=c,t.normals=w,null!=i&&(t.uvs=u),null!=n&&(t.colors=f),null!=r&&(t.matricesIndices=d),null!=h&&(t.matricesWeights=p),null!=o&&(t.matricesIndicesExtra=m),null!=h&&(t.matricesWeightsExtra=v),t.applyToMesh(this,this.isVertexBufferUpdatable(he.PositionKind))}}static lM(t,i){throw X("InstancedMesh")}static cM(t,i,e){throw X("PhysicsImpostor")}createInstance(t){return Ys.lM(t,this)}synchronizeInstances(){for(let t=0;t<this.instances.length;t++){this.instances[t].hM()}return this}optimizeIndices(t){const i=this.getIndices(),e=this.getVerticesData(he.PositionKind);if(!e||!i)return this;const s=new Array;for(let t=0;t<e.length;t+=3)s.push(w.FromArray(e,t));const n=new Array;return Gi.SyncAsyncForLoop(s.length,40,(t=>{const i=s.length-1-t,e=s[i];for(let t=0;t<i;++t){const r=s[t];if(e.equals(r)){n[i]=t;break}}}),(()=>{for(let t=0;t<i.length;++t)i[t]=n[i[t]]||i[t];const e=this.subMeshes.slice(0);this.setIndices(i),this.subMeshes=e,t&&t(this)})),this}serialize(t={}){t.name=this.name,t.id=this.id,t.uniqueId=this.uniqueId,t.type=this.getClassName(),H&&H.HasTags(this)&&(t.tags=H.GetTags(this)),t.position=this.position.asArray(),this.rotationQuaternion?t.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(t.rotation=this.rotation.asArray()),t.scaling=this.scaling.asArray(),this.Gx?t.pivotMatrix=this.getPivotMatrix().asArray():t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(!1),t.isVisible=this.isVisible,t.infiniteDistance=this.infiniteDistance,t.pickable=this.isPickable,t.receiveShadows=this.receiveShadows,t.billboardMode=this.billboardMode,t.visibility=this.visibility,t.checkCollisions=this.checkCollisions,t.isBlocker=this.isBlocker,t.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent.Gi(t),t.isUnIndexed=this.isUnIndexed;const i=this.qC;if(i&&this.subMeshes){t.geometryUniqueId=i.uniqueId,t.geometryId=i.id,t.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){const e=this.subMeshes[i];t.subMeshes.push({materialIndex:e.materialIndex,verticesStart:e.verticesStart,verticesCount:e.verticesCount,indexStart:e.indexStart,indexCount:e.indexCount})}}if(this.material?this.material.doNotSerialize||(t.materialUniqueId=this.material.uniqueId,t.materialId=this.material.id):(this.material=null,t.materialUniqueId=this.Kt.defaultMaterial.uniqueId,t.materialId=this.Kt.defaultMaterial.id),this.morphTargetManager&&(t.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(t.skeletonId=this.skeleton.id,t.numBoneInfluencers=this.numBoneInfluencers),this.getScene().Mg(fe.NAME_PHYSICSENGINE)){const i=this.getPhysicsImpostor();i&&(t.physicsMass=i.getParam("mass"),t.physicsFriction=i.getParam("friction"),t.physicsRestitution=i.getParam("mass"),t.physicsImpostor=i.type)}this.metadata&&(t.metadata=this.metadata),t.instances=[];for(let i=0;i<this.instances.length;i++){const e=this.instances[i];if(e.doNotSerialize)continue;const s={name:e.name,id:e.id,isEnabled:e.isEnabled(!1),isVisible:e.isVisible,isPickable:e.isPickable,checkCollisions:e.checkCollisions,position:e.position.asArray(),scaling:e.scaling.asArray()};if(e.parent&&e.parent.Gi(s),e.rotationQuaternion?s.rotationQuaternion=e.rotationQuaternion.asArray():e.rotation&&(s.rotation=e.rotation.asArray()),this.getScene().Mg(fe.NAME_PHYSICSENGINE)){const t=e.getPhysicsImpostor();t&&(s.physicsMass=t.getParam("mass"),s.physicsFriction=t.getParam("friction"),s.physicsRestitution=t.getParam("mass"),s.physicsImpostor=t.type)}e.metadata&&(s.metadata=e.metadata),t.instances.push(s),ot.AppendSerializedAnimations(e,s),s.ranges=e.serializeAnimationRanges()}if(this._I.instancesCount&&this._I.matrixData&&(t.thinInstances={instancesCount:this._I.instancesCount,matrixData:Array.from(this._I.matrixData),matrixBufferSize:this._I.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this.uM)){const i={data:{},sizes:{},strides:{}};for(const t in this.uM.data)i.data[t]=Array.from(this.uM.data[t]),i.sizes[t]=this.uM.sizes[t],i.strides[t]=this.uM.strides[t];t.thinInstances.userThinInstance=i}return ot.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.layerMask=this.layerMask,t.alphaIndex=this.alphaIndex,t.hasVertexAlpha=this.hasVertexAlpha,t.overlayAlpha=this.overlayAlpha,t.overlayColor=this.overlayColor.asArray(),t.renderOverlay=this.renderOverlay,t.applyFog=this.applyFog,this.actionManager&&(t.actions=this.actionManager.serialize(this.name)),t}JC(){if(!this.geometry)return;this.tw();const t=this._m.wT;if(t&&t.vertexCount){if(t.vertexCount!==this.getTotalVertices())return F.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);if(t.isUsingTextureForTargets)return;for(let i=0;i<t.numInfluencers;i++){const e=t.getActiveTarget(i),s=e.getPositions();if(!s)return void F.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(he.PositionKind+i,s,!1,3);const n=e.getNormals();n&&this.geometry.setVerticesData(he.NormalKind+i,n,!1,3);const r=e.getTangents();r&&this.geometry.setVerticesData(he.TangentKind+i,r,!1,3);const h=e.getUVs();h&&this.geometry.setVerticesData(he.UVKind+"_"+i,h,!1,2)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(he.PositionKind+t);)this.geometry.removeVerticesData(he.PositionKind+t),this.geometry.isVerticesDataPresent(he.NormalKind+t)&&this.geometry.removeVerticesData(he.NormalKind+t),this.geometry.isVerticesDataPresent(he.TangentKind+t)&&this.geometry.removeVerticesData(he.TangentKind+t),this.geometry.isVerticesDataPresent(he.UVKind+t)&&this.geometry.removeVerticesData(he.UVKind+"_"+t),t++}}static Parse(t,i,e){let s;if(s=t.type&&"LinesMesh"===t.type?Ys.fM(t,i):t.type&&"GroundMesh"===t.type?Ys.dM(t,i):t.type&&"GoldbergMesh"===t.type?Ys.pM(t,i):new Ys(t.name,i),s.id=t.id,s.Ri=t.uniqueId,H&&H.AddTagsTo(s,t.tags),s.position=w.FromArray(t.position),void 0!==t.metadata&&(s.metadata=t.metadata),t.rotationQuaternion?s.rotationQuaternion=T.FromArray(t.rotationQuaternion):t.rotation&&(s.rotation=w.FromArray(t.rotation)),s.scaling=w.FromArray(t.scaling),t.localMatrix?s.setPreTransformMatrix(R.FromArray(t.localMatrix)):t.pivotMatrix&&s.setPivotMatrix(R.FromArray(t.pivotMatrix)),s.setEnabled(t.isEnabled),s.isVisible=t.isVisible,s.infiniteDistance=t.infiniteDistance,s.showBoundingBox=t.showBoundingBox,s.showSubMeshesBoundingBox=t.showSubMeshesBoundingBox,void 0!==t.applyFog&&(s.applyFog=t.applyFog),void 0!==t.pickable&&(s.isPickable=t.pickable),void 0!==t.alphaIndex&&(s.alphaIndex=t.alphaIndex),s.receiveShadows=t.receiveShadows,void 0!==t.billboardMode&&(s.billboardMode=t.billboardMode),void 0!==t.visibility&&(s.visibility=t.visibility),s.checkCollisions=t.checkCollisions,s.overrideMaterialSideOrientation=t.overrideMaterialSideOrientation,void 0!==t.isBlocker&&(s.isBlocker=t.isBlocker),s.cw=t.useFlatShading,t.freezeWorldMatrix&&(s.OT.freezeWorldMatrix=t.freezeWorldMatrix),void 0!==t.parentId&&(s.xi=t.parentId),void 0!==t.parentInstanceIndex&&(s.Ti=t.parentInstanceIndex),void 0!==t.actions&&(s.OT.actions=t.actions),void 0!==t.overlayAlpha&&(s.overlayAlpha=t.overlayAlpha),void 0!==t.overlayColor&&(s.overlayColor=_.FromArray(t.overlayColor)),void 0!==t.renderOverlay&&(s.renderOverlay=t.renderOverlay),s.isUnIndexed=!!t.isUnIndexed,s.hasVertexAlpha=t.hasVertexAlpha,t.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=e+t.delayLoadingFile,s.buildBoundingInfo(w.FromArray(t.boundingBoxMinimum),w.FromArray(t.boundingBoxMaximum)),t.aw&&(s.aw=t.aw),s.YC=[],t.hasUVs&&s.YC.push(he.UVKind),t.hasUVs2&&s.YC.push(he.UV2Kind),t.hasUVs3&&s.YC.push(he.UV3Kind),t.hasUVs4&&s.YC.push(he.UV4Kind),t.hasUVs5&&s.YC.push(he.UV5Kind),t.hasUVs6&&s.YC.push(he.UV6Kind),t.hasColors&&s.YC.push(he.ColorKind),t.hasMatricesIndices&&s.YC.push(he.MatricesIndicesKind),t.hasMatricesWeights&&s.YC.push(he.MatricesWeightsKind),s.ew=Cs.ow,Es.ForceFullSceneLoadingForIncremental&&s.WI()):Cs.ow(t,s),t.materialUniqueId?s._T=t.materialUniqueId:t.materialId&&(s._T=t.materialId),t.morphTargetManagerId>-1&&(s.morphTargetManager=i.getMorphTargetManagerById(t.morphTargetManagerId)),void 0!==t.skeletonId&&null!==t.skeletonId&&(s.skeleton=i.getLastSkeletonById(t.skeletonId),t.numBoneInfluencers&&(s.numBoneInfluencers=t.numBoneInfluencers)),t.animations){for(let i=0;i<t.animations.length;i++){const e=t.animations[i],n=g("BABYLON.Animation");n&&s.animations.push(n.Parse(e))}dt.ParseAnimationRanges(s,t,i)}if(t.autoAnimate&&i.beginAnimation(s,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.layerMask&&!isNaN(t.layerMask)?s.layerMask=Math.abs(parseInt(t.layerMask)):s.layerMask=268435455,t.physicsImpostor&&Ys.cM(i,s,t),t.lodMeshIds&&(s.OT.lods={ids:t.lodMeshIds,distances:t.lodDistances?t.lodDistances:null,coverages:t.lodCoverages?t.lodCoverages:null}),t.instances)for(let e=0;e<t.instances.length;e++){const n=t.instances[e],r=s.createInstance(n.name);if(n.id&&(r.id=n.id),H&&(n.tags?H.AddTagsTo(r,n.tags):H.AddTagsTo(r,t.tags)),r.position=w.FromArray(n.position),void 0!==n.metadata&&(r.metadata=n.metadata),void 0!==n.parentId&&(r.xi=n.parentId),void 0!==n.parentInstanceIndex&&(r.Ti=n.parentInstanceIndex),void 0!==n.isEnabled&&null!==n.isEnabled&&r.setEnabled(n.isEnabled),void 0!==n.isVisible&&null!==n.isVisible&&(r.isVisible=n.isVisible),void 0!==n.isPickable&&null!==n.isPickable&&(r.isPickable=n.isPickable),n.rotationQuaternion?r.rotationQuaternion=T.FromArray(n.rotationQuaternion):n.rotation&&(r.rotation=w.FromArray(n.rotation)),r.scaling=w.FromArray(n.scaling),null!=n.checkCollisions&&null!=n.checkCollisions&&(r.checkCollisions=n.checkCollisions),null!=n.pickable&&null!=n.pickable&&(r.isPickable=n.pickable),null!=n.showBoundingBox&&null!=n.showBoundingBox&&(r.showBoundingBox=n.showBoundingBox),null!=n.showSubMeshesBoundingBox&&null!=n.showSubMeshesBoundingBox&&(r.showSubMeshesBoundingBox=n.showSubMeshesBoundingBox),null!=n.alphaIndex&&null!=n.showSubMeshesBoundingBox&&(r.alphaIndex=n.alphaIndex),n.physicsImpostor&&Ys.cM(i,r,n),n.animations){for(let t=0;t<n.animations.length;t++){const i=n.animations[t],e=g("BABYLON.Animation");e&&r.animations.push(e.Parse(i))}dt.ParseAnimationRanges(r,n,i),n.autoAnimate&&i.beginAnimation(r,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1)}}if(t.thinInstances){const i=t.thinInstances;if(s.thinInstanceEnablePicking=!!i.enablePicking,i.matrixData?(s.thinInstanceSetBuffer("matrix",new Float32Array(i.matrixData),16,!1),s._I.matrixBufferSize=i.matrixBufferSize,s._I.instancesCount=i.instancesCount):s._I.matrixBufferSize=i.matrixBufferSize,t.thinInstances.userThinInstance){const i=t.thinInstances.userThinInstance;for(const t in i.data)s.thinInstanceSetBuffer(t,new Float32Array(i.data[t]),i.strides[t],!1),s.uM.sizes[t]=i.sizes[t]}}return s}setPositionsForCPUSkinning(){const t=this.II;if(!t.BI){const i=this.getVerticesData(he.PositionKind);if(!i)return t.BI;t.BI=new Float32Array(i),this.isVertexBufferUpdatable(he.PositionKind)||this.setVerticesData(he.PositionKind,i,!0)}return t.BI}setNormalsForCPUSkinning(){const t=this.II;if(!t.UI){const i=this.getVerticesData(he.NormalKind);if(!i)return t.UI;t.UI=new Float32Array(i),this.isVertexBufferUpdatable(he.NormalKind)||this.setVerticesData(he.NormalKind,i,!0)}return t.UI}applySkeleton(t){if(!this.geometry)return this;if(this.geometry.mM==this.getScene().getFrameId())return this;if(this.geometry.mM=this.getScene().getFrameId(),!this.isVerticesDataPresent(he.PositionKind))return this;if(!this.isVerticesDataPresent(he.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(he.MatricesWeightsKind))return this;const i=this.isVerticesDataPresent(he.NormalKind),e=this.II;if(!e.BI){const t=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=t}i&&!e.UI&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(he.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let n=this.getVerticesData(he.NormalKind);if(i){if(!n)return this;n instanceof Float32Array||(n=new Float32Array(n))}const r=this.getVerticesData(he.MatricesIndicesKind),h=this.getVerticesData(he.MatricesWeightsKind);if(!h||!r)return this;const o=this.numBoneInfluencers>4,a=o?this.getVerticesData(he.MatricesIndicesExtraKind):null,l=o?this.getVerticesData(he.MatricesWeightsExtraKind):null,c=t.getTransformMatrices(this),u=w.Zero(),f=new R,d=new R;let p,m=0;for(let t=0;t<s.length;t+=3,m+=4){let v;for(p=0;p<4;p++)v=h[m+p],v>0&&(R.FromFloat32ArrayToRefScaled(c,Math.floor(16*r[m+p]),v,d),f.addToSelf(d));if(o)for(p=0;p<4;p++)v=l[m+p],v>0&&(R.FromFloat32ArrayToRefScaled(c,Math.floor(16*a[m+p]),v,d),f.addToSelf(d));w.TransformCoordinatesFromFloatsToRef(e.BI[t],e.BI[t+1],e.BI[t+2],f,u),u.toArray(s,t),i&&(w.TransformNormalFromFloatsToRef(e.UI[t],e.UI[t+1],e.UI[t+2],f,u),u.toArray(n,t)),f.reset()}return this.updateVerticesData(he.PositionKind,s),i&&this.updateVerticesData(he.NormalKind,n),this}static MinMax(t){let i=null,e=null;return t.forEach((function(t){const s=t.getBoundingInfo().boundingBox;i&&e?(i.minimizeInPlace(s.minimumWorld),e.maximizeInPlace(s.maximumWorld)):(i=s.minimumWorld,e=s.maximumWorld)})),i&&e?{min:i,max:e}:{min:w.Zero(),max:w.Zero()}}static Center(t){const i=t instanceof Array?Ys.MinMax(t):t;return w.Center(i.min,i.max)}static MergeMeshes(t,i=!0,e,s,n,r){return ss(Ys.vM(t,i,e,s,n,r,!1))}static MergeMeshesAsync(t,i=!0,e,s,n,r){return ns(Ys.vM(t,i,e,s,n,r,!0),function(t=25){let i;return(e,s,n)=>{const r=performance.now();void 0===i||r-i>t?(i=r,setTimeout((()=>{is(e,s,n)}),0)):is(e,s,n)}}())}static*vM(t,i=!0,e,s,n,r,h){if(0===(t=t.filter(Boolean)).length)return null;let o;if(!e){let i=0;for(o=0;o<t.length;o++)if(i+=t[o].getTotalVertices(),i>=65536)return F.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}r&&(n=!1);const a=new Array,l=new Array,c=new Array,u=t[0].overrideMaterialSideOrientation;for(o=0;o<t.length;o++){const i=t[o];if(i.isAnInstance)return F.Warn("Cannot merge instance meshes."),null;if(u!==i.overrideMaterialSideOrientation)return F.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(n&&c.push(i.getTotalIndices()),r)if(i.material){const t=i.material;if(t instanceof ks){for(let i=0;i<t.subMaterials.length;i++)a.indexOf(t.subMaterials[i])<0&&a.push(t.subMaterials[i]);for(let e=0;e<i.subMeshes.length;e++)l.push(a.indexOf(t.subMaterials[i.subMeshes[e].materialIndex])),c.push(i.subMeshes[e].indexCount)}else{a.indexOf(t)<0&&a.push(t);for(let e=0;e<i.subMeshes.length;e++)l.push(a.indexOf(t)),c.push(i.subMeshes[e].indexCount)}}else for(let t=0;t<i.subMeshes.length;t++)l.push(0),c.push(i.subMeshes[t].indexCount)}const f=t[0],d=t=>{const i=t.computeWorldMatrix(!0);return[os.ExtractFromMesh(t,!1,!1),i]},[p,m]=d(f);h&&(yield);const v=new Array(t.length-1);for(let i=1;i<t.length;i++)v[i-1]=d(t[i]),h&&(yield);const g=p.jA(m,v,e,h,!i);let S=g.next();for(;!S.done;)h&&(yield),S=g.next();const E=S.value;s||(s=new Ys(f.name+"_merged",f.getScene()));const A=E.zA(s,void 0,h);let C=A.next();for(;!C.done;)h&&(yield),C=A.next();if(s.checkCollisions=f.checkCollisions,s.overrideMaterialSideOrientation=f.overrideMaterialSideOrientation,i)for(o=0;o<t.length;o++)t[o].dispose();if(n||r){s.releaseSubMeshes(),o=0;let t=0;for(;o<c.length;)Ss.CreateFromIndices(0,t,c[o],s,void 0,!1),t+=c[o],o++;for(const t of s.subMeshes)t.refreshBoundingInfo();s.computeWorldMatrix(!0)}if(r){const t=new ks(f.name+"_merged",f.getScene());t.subMaterials=a;for(let t=0;t<s.subMeshes.length;t++)s.subMeshes[t].materialIndex=l[t];s.material=t}else s.material=f.material;return s}addInstance(t){t.gM=this.instances.length,this.instances.push(t)}removeInstance(t){const i=t.gM;if(-1!=i){if(i!==this.instances.length-1){const t=this.instances[this.instances.length-1];this.instances[i]=t,t.gM=i}t.gM=-1,this.instances.pop()}}rR(){return this.overrideMaterialSideOrientation===Vs.CounterClockWiseSideOrientation}}Ys.FRONTSIDE=os.FRONTSIDE,Ys.BACKSIDE=os.BACKSIDE,Ys.DOUBLESIDE=os.DOUBLESIDE,Ys.DEFAULTSIDE=os.DEFAULTSIDE,Ys.NO_CAP=0,Ys.CAP_START=1,Ys.CAP_END=2,Ys.CAP_ALL=3,Ys.NO_FLIP=0,Ys.FLIP_TILE=1,Ys.ROTATE_TILE=2,Ys.FLIP_ROW=3,Ys.ROTATE_ROW=4,Ys.FLIP_N_ROTATE_TILE=5,Ys.FLIP_N_ROTATE_ROW=6,Ys.CENTER=0,Ys.LEFT=1,Ys.RIGHT=2,Ys.TOP=3,Ys.BOTTOM=4,Ys.INSTANCEDMESH_SORT_TRANSPARENT=!1,Ys.dM=(t,i)=>{throw X("GroundMesh")},Ys.pM=(t,i)=>{throw X("GoldbergMesh")},Ys.fM=(t,i)=>{throw X("LinesMesh")},v("BABYLON.Mesh",Ys),Ys.prototype.setMaterialByID=function(t){return this.setMaterialById(t)},Ys.CreateDisc=Ys.CreateDisc||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateBox=Ys.CreateBox||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateSphere=Ys.CreateSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateCylinder=Ys.CreateCylinder||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateTorusKnot=Ys.CreateTorusKnot||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateTorus=Ys.CreateTorus||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreatePlane=Ys.CreatePlane||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateGround=Ys.CreateGround||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateTiledGround=Ys.CreateTiledGround||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateGroundFromHeightMap=Ys.CreateGroundFromHeightMap||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateTube=Ys.CreateTube||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreatePolyhedron=Ys.CreatePolyhedron||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateIcoSphere=Ys.CreateIcoSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateDecal=Ys.CreateDecal||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.CreateCapsule=Ys.CreateCapsule||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Ys.ExtendToGoldberg=Ys.ExtendToGoldberg||(()=>{throw new Error("Import MeshBuilder to populate this function")});class js extends e{}class Ks{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach((t=>{t.dispose()})),this.rootNodes.length=0,this.skeletons.slice(0).forEach((t=>{t.dispose()})),this.skeletons.length=0,this.animationGroups.slice(0).forEach((t=>{t.dispose()})),this.animationGroups.length=0}}class qs extends e{constructor(t){super(),this.SM=!1,(t=t||E.LastCreatedScene)&&(this.scene=t,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],t.onDisposeObservable.add((()=>{this.SM||this.dispose()})),this.EM=t.getEngine().onContextRestoredObservable.add((()=>{for(const t of this.geometries)t.br();for(const t of this.meshes)t.br();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t.br()})))}instantiateModelsToScene(t,i=!1,e){const s={},n={},r=new Ks,h=[],o=[],a={doNotInstantiate:!0,...e};a.doNotInstantiate||(a.doNotInstantiate=t=>!!t.skeleton);const l=(i,e)=>{if(s[i.uniqueId]=e.uniqueId,n[e.uniqueId]=e,t&&(e.name=t(i.name)),e instanceof Ys){const t=e;if(t.morphTargetManager){const e=i.morphTargetManager;t.morphTargetManager=e.clone();for(let i=0;i<e.numTargets;i++){const r=e.getTarget(i),h=t.morphTargetManager.getTarget(i);s[r.uniqueId]=h.uniqueId,n[h.uniqueId]=h}}}};this.transformNodes.forEach((t=>{if((!a.predicate||a.predicate(t))&&!t.parent){const i=t.instantiateHierarchy(null,a,((t,i)=>{l(t,i)}));i&&r.rootNodes.push(i)}}));const c=this.meshes.some((t=>"InstancedMesh"===t.getClassName())),u=[],f=(e,r)=>{if(l(e,r),r.material){const h=r;if(h.material)if(i){const i=e.material;if(-1===o.indexOf(i)){let e=i.clone(t?t(i.name):"Clone of "+i.name);if(o.push(i),s[i.uniqueId]=e.uniqueId,n[e.uniqueId]=e,"MultiMaterial"===i.getClassName()){const r=i;for(const i of r.subMaterials)i&&(e=i.clone(t?t(i.name):"Clone of "+i.name),o.push(i),s[i.uniqueId]=e.uniqueId,n[e.uniqueId]=e);r.subMaterials=r.subMaterials.map((t=>t&&n[s[t.uniqueId]]))}}"InstancedMesh"!==h.getClassName()&&(h.material=n[s[i.uniqueId]])}else"MultiMaterial"===h.material.getClassName()?-1===this.scene.multiMaterials.indexOf(h.material)&&this.scene.addMultiMaterial(h.material):-1===this.scene.materials.indexOf(h.material)&&this.scene.addMaterial(h.material)}};return this.meshes.forEach(((t,i)=>{if((!a.predicate||a.predicate(t))&&!t.parent){const e="InstancedMesh"===t.getClassName();let s;if(e){const i=t.sourceMesh,e=this.meshes.indexOf(i);-1!==e&&u[e]&&(s=u[e])}const n=e?t.instantiateHierarchy(null,{...a,newSourcedMesh:s},f):t.instantiateHierarchy(null,a,f);n&&(c&&"InstancedMesh"!==n.getClassName()&&(u[i]=n),r.rootNodes.push(n))}})),this.skeletons.forEach((i=>{if(a.predicate&&!a.predicate(i))return;const e=i.clone(t?t(i.name):"Clone of "+i.name);for(const t of this.meshes)if(t.skeleton===i&&!t.isAnInstance){const i=n[s[t.uniqueId]];if(i.isAnInstance)continue;if(i.skeleton=e,-1!==h.indexOf(e))continue;h.push(e);for(const t of e.bones)t.YS&&(t.YS=n[s[t.YS.uniqueId]])}r.skeletons.push(e)})),this.animationGroups.forEach((i=>{if(a.predicate&&!a.predicate(i))return;const e=i.clone(t?t(i.name):"Clone of "+i.name,(t=>n[s[t.uniqueId]]||t));r.animationGroups.push(e)})),r}addAllToScene(){if(!this.SM){this.SM=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const t of this.scene.Bv)t.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this.EM),this.EM=null}}addToScene(t=null){this.cameras.forEach((i=>{t&&!t(i)||this.scene.addCamera(i)})),this.lights.forEach((i=>{t&&!t(i)||this.scene.addLight(i)})),this.meshes.forEach((i=>{t&&!t(i)||this.scene.addMesh(i)})),this.skeletons.forEach((i=>{t&&!t(i)||this.scene.addSkeleton(i)})),this.animations.forEach((i=>{t&&!t(i)||this.scene.addAnimation(i)})),this.animationGroups.forEach((i=>{t&&!t(i)||this.scene.addAnimationGroup(i)})),this.multiMaterials.forEach((i=>{t&&!t(i)||this.scene.addMultiMaterial(i)})),this.materials.forEach((i=>{t&&!t(i)||this.scene.addMaterial(i)})),this.morphTargetManagers.forEach((i=>{t&&!t(i)||this.scene.addMorphTargetManager(i)})),this.geometries.forEach((i=>{t&&!t(i)||this.scene.addGeometry(i)})),this.transformNodes.forEach((i=>{t&&!t(i)||this.scene.addTransformNode(i)})),this.actionManagers.forEach((i=>{t&&!t(i)||this.scene.addActionManager(i)})),this.textures.forEach((i=>{t&&!t(i)||this.scene.addTexture(i)})),this.reflectionProbes.forEach((i=>{t&&!t(i)||this.scene.addReflectionProbe(i)}))}removeAllFromScene(){this.SM=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const t of this.scene.Bv)t.removeFromContainer(this)}removeFromScene(t=null){this.cameras.forEach((i=>{t&&!t(i)||this.scene.removeCamera(i)})),this.lights.forEach((i=>{t&&!t(i)||this.scene.removeLight(i)})),this.meshes.forEach((i=>{t&&!t(i)||this.scene.removeMesh(i)})),this.skeletons.forEach((i=>{t&&!t(i)||this.scene.removeSkeleton(i)})),this.animations.forEach((i=>{t&&!t(i)||this.scene.removeAnimation(i)})),this.animationGroups.forEach((i=>{t&&!t(i)||this.scene.removeAnimationGroup(i)})),this.multiMaterials.forEach((i=>{t&&!t(i)||this.scene.removeMultiMaterial(i)})),this.materials.forEach((i=>{t&&!t(i)||this.scene.removeMaterial(i)})),this.morphTargetManagers.forEach((i=>{t&&!t(i)||this.scene.removeMorphTargetManager(i)})),this.geometries.forEach((i=>{t&&!t(i)||this.scene.removeGeometry(i)})),this.transformNodes.forEach((i=>{t&&!t(i)||this.scene.removeTransformNode(i)})),this.actionManagers.forEach((i=>{t&&!t(i)||this.scene.removeActionManager(i)})),this.textures.forEach((i=>{t&&!t(i)||this.scene.removeTexture(i)})),this.reflectionProbes.forEach((i=>{t&&!t(i)||this.scene.removeReflectionProbe(i)}))}dispose(){this.cameras.slice(0).forEach((t=>{t.dispose()})),this.cameras.length=0,this.lights.slice(0).forEach((t=>{t.dispose()})),this.lights.length=0,this.meshes.slice(0).forEach((t=>{t.dispose()})),this.meshes.length=0,this.skeletons.slice(0).forEach((t=>{t.dispose()})),this.skeletons.length=0,this.animationGroups.slice(0).forEach((t=>{t.dispose()})),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach((t=>{t.dispose()})),this.multiMaterials.length=0,this.materials.slice(0).forEach((t=>{t.dispose()})),this.materials.length=0,this.geometries.slice(0).forEach((t=>{t.dispose()})),this.geometries.length=0,this.transformNodes.slice(0).forEach((t=>{t.dispose()})),this.transformNodes.length=0,this.actionManagers.slice(0).forEach((t=>{t.dispose()})),this.actionManagers.length=0,this.textures.slice(0).forEach((t=>{t.dispose()})),this.textures.length=0,this.reflectionProbes.slice(0).forEach((t=>{t.dispose()})),this.reflectionProbes.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const t of this.scene.Bv)t.removeFromContainer(this,!0);this.EM&&(this.scene.getEngine().onContextRestoredObservable.remove(this.EM),this.EM=null)}AM(t,i,e){if(t&&i)for(const s of t){let t=!0;if(e)for(const i of e)if(s===i){t=!1;break}t&&(i.push(s),s.Si=this)}}moveAllFromScene(t){this.SM=!1,void 0===t&&(t=new js);for(const i in this)Object.prototype.hasOwnProperty.call(this,i)&&(this[i]=this[i]||("_environmentTexture"===i?null:[]),this.AM(this.scene[i],this[i],t[i]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const t=new Ys("assetContainerRootMesh",this.scene);return this.meshes.forEach((i=>{i.parent||t.addChild(i)})),this.meshes.unshift(t),t}mergeAnimationsTo(t=E.LastCreatedScene,i,e=null){if(!t)return F.Error("No scene available to merge animations to"),[];const s=e||(i=>{let e=null;const s=i.animations.length?i.animations[0].targetProperty:"",n=i.name.split(".").join("").split("_primitive")[0];switch(s){case"position":case"rotationQuaternion":e=t.getTransformNodeByName(i.name)||t.getTransformNodeByName(n);break;case"influence":e=t.getMorphTargetByName(i.name)||t.getMorphTargetByName(n);break;default:e=t.getNodeByName(i.name)||t.getNodeByName(n)}return e});this.getNodes().forEach((t=>{const i=s(t);if(null!==i){for(const e of t.animations){const t=i.animations.filter((t=>t.targetProperty===e.targetProperty));for(const e of t){const t=i.animations.indexOf(e,0);t>-1&&i.animations.splice(t,1)}}i.animations=i.animations.concat(t.animations)}}));const n=new Array;return this.animationGroups.slice().forEach((t=>{n.push(t.clone(t.name,s)),t.animatables.forEach((t=>{t.stop()}))})),i.forEach((i=>{const e=s(i.target);e&&(t.beginAnimation(e,i.fromFrame,i.toFrame,i.loopAnimation,i.speedRatio,i.onAnimationEnd?i.onAnimationEnd:void 0,void 0,!0,void 0,i.onAnimationLoop?i.onAnimationLoop:void 0),t.stopAnimation(i.target))})),n}}Rs.AudioEngineFactory=(t,i,e)=>new Qs(t,i,e);class Qs{constructor(t=null,i=null,e=null){if(this.eo=null,this.CM=!1,this.wM=null,this.so=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!0,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new h,this.onAudioLockedObservable=new h,this.xM=!1,this.TM=()=>{this.RM()},!xt())return;void 0!==window.AudioContext&&(this.canUseWebAudio=!0);const s=document.createElement("audio");this.IM=t,this.eo=i,this.so=e;try{s&&s.canPlayType&&(s.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||s.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch(t){}try{s&&s.canPlayType&&s.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch(t){}}get audioContext(){return this.CM?this.unlocked||this.wM||this.MM():this.bM(),this.eo}lock(){this._M()}unlock(){this.yM()}NM(){let t;return void 0!==this.eo.resume&&(t=this.eo.resume()),t||Promise.resolve()}bM(){try{this.canUseWebAudio&&(this.eo||(this.eo=new AudioContext),this.masterGain=this.eo.createGain(),this.masterGain.gain.value=1,this.so||(this.so=this.eo.destination),this.masterGain.connect(this.so),this.CM=!0,"running"===this.eo.state&&this.yM())}catch(t){this.canUseWebAudio=!1,F.Error("Web Audio: "+t.message)}}yM(){this.xM||(this.xM=!0,this.NM().then((()=>{this.xM=!1,this.wM&&this.PM(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)})).catch((()=>{this.xM=!1,this.unlocked=!1})))}_M(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this.MM()}MM(){if(this.useCustomUnlockedButton||this.wM)return;this.wM=document.createElement("BUTTON"),this.wM.className="babylonUnmuteIcon",this.wM.id="babylonUnmuteIconBtn",this.wM.title="Unmute";const t=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png")+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",i=document.createElement("style");i.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(i),document.body.appendChild(this.wM),this.RM(),this.wM.addEventListener("touchend",(()=>{this.yM()}),!0),this.wM.addEventListener("click",(()=>{this.yM()}),!0),window.addEventListener("resize",this.TM)}RM(){this.IM&&this.wM&&(this.wM.style.top=this.IM.offsetTop+20+"px",this.wM.style.left=this.IM.offsetLeft+20+"px")}PM(){this.wM&&(document.body.removeChild(this.wM),this.wM=null)}dispose(){this.canUseWebAudio&&this.CM&&(this.DM&&this.eo&&(this.DM.stopDebugCanvas(),this.DM.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this.eo.destination),this.DM=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this.PM(),window.removeEventListener("resize",this.TM),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this.CM?this.masterGain.gain.value:-1}setGlobalVolume(t){this.canUseWebAudio&&this.CM&&(this.masterGain.gain.value=t)}connectToAnalyser(t){this.DM&&this.DM.stopDebugCanvas(),this.canUseWebAudio&&this.CM&&this.eo&&(this.DM=t,this.masterGain.disconnect(),this.DM.connectAudioNodes(this.masterGain,this.eo.destination))}}class Zs{constructor(t,i,e,s=null,n){var r,o,a,l,c;if(this.autoplay=!1,this.LM=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new h,this.OM=!1,this.FM="equalpower",this.BM=1,this.UM=!1,this.VM=0,this.kM=0,this.rA=w.Zero(),this.GM=new w(1,0,0),this.zM=1,this.HM=!1,this.XM=!1,this.WM=360,this.$M=360,this.YM=0,this.jM=!1,this.KM="Unknown",this.name=t,e=e||E.LastCreatedScene)if(this.Kt=e,Zs.qM(e),this.QM=s,this.ZM=(t,i,e,s,n)=>i<e?t*(1-i/e):0,n&&(this.autoplay=n.autoplay||!1,this.LM=n.loop||!1,void 0!==n.volume&&(this.zM=n.volume),this.OM=null!==(r=n.spatialSound)&&void 0!==r&&r,this.maxDistance=null!==(o=n.maxDistance)&&void 0!==o?o:100,this.useCustomAttenuation=null!==(a=n.useCustomAttenuation)&&void 0!==a&&a,this.rolloffFactor=n.rolloffFactor||1,this.refDistance=n.refDistance||1,this.distanceModel=n.distanceModel||"linear",this.BM=n.playbackRate||1,this.UM=null!==(l=n.streaming)&&void 0!==l&&l,this.yE=n.length,this.JM=n.offset),(null===(c=Rs.audioEngine)||void 0===c?void 0:c.canUseWebAudio)&&Rs.audioEngine.audioContext){this.tb=Rs.audioEngine.audioContext.createGain(),this.tb.gain.value=this.zM,this.ib=this.tb,this.eb=this.tb,this.OM&&this.sb(),this.Kt.mainSoundTrack.addSound(this);let t=!0;if(i)try{"string"==typeof i?this.KM="String":i instanceof ArrayBuffer?this.KM="ArrayBuffer":i instanceof HTMLMediaElement?this.KM="MediaElement":i instanceof MediaStream?this.KM="MediaStream":i instanceof AudioBuffer?this.KM="AudioBuffer":Array.isArray(i)&&(this.KM="Array");let e=[],s=!1;switch(this.KM){case"MediaElement":this.UM=!0,this.HM=!0,this.nb=Rs.audioEngine.audioContext.createMediaElementSource(i),this.autoplay&&this.play(0,this.JM,this.yE),this.QM&&this.QM();break;case"MediaStream":this.UM=!0,this.HM=!0,this.nb=Rs.audioEngine.audioContext.createMediaStreamSource(i),this.autoplay&&this.play(0,this.JM,this.yE),this.QM&&this.QM();break;case"ArrayBuffer":i.byteLength>0&&(s=!0,this.rb(i));break;case"AudioBuffer":this.hb(i);break;case"String":e.push(i);case"Array":0===e.length&&(e=i);for(let t=0;t<e.length;t++){const i=e[t];if(s=n&&n.skipCodecCheck||-1!==i.indexOf(".mp3",i.length-4)&&Rs.audioEngine.isMP3supported||-1!==i.indexOf(".ogg",i.length-4)&&Rs.audioEngine.isOGGsupported||-1!==i.indexOf(".wav",i.length-4)||-1!==i.indexOf(".m4a",i.length-4)||-1!==i.indexOf(".mp4",i.length-4)||-1!==i.indexOf("blob:"),s){this.UM?(this.ob=new Audio(i),this.ob.controls=!1,this.ob.loop=this.loop,ki.SetCorsBehavior(i,this.ob),this.ob.preload="auto",this.ob.addEventListener("canplaythrough",(()=>{this.HM=!0,this.autoplay&&this.play(0,this.JM,this.yE),this.QM&&this.QM()})),document.body.appendChild(this.ob),this.ob.load()):this.Kt.tn(i,(t=>{this.rb(t)}),void 0,!0,!0,(t=>{t&&F.Error("XHR "+t.status+" error on: "+i+"."),F.Error("Sound creation aborted."),this.Kt.mainSoundTrack.removeSound(this)}));break}}break;default:t=!1}t?s||(this.HM=!0,this.QM&&setTimeout((()=>{this.QM&&this.QM()}),1e3)):F.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch(t){F.Error("Unexpected error. Sound creation aborted."),this.Kt.mainSoundTrack.removeSound(this)}}else this.Kt.mainSoundTrack.addSound(this),Rs.audioEngine&&!Rs.audioEngine.WarnedWebAudioUnsupported&&(F.Error("Web Audio is not supported by your browser."),Rs.audioEngine.WarnedWebAudioUnsupported=!0),this.QM&&setTimeout((()=>{this.QM&&this.QM()}),1e3)}get loop(){return this.LM}set loop(t){t!==this.LM&&(this.LM=t,this.updateOptions({loop:t}))}get currentTime(){var t;if(this.ob)return this.ob.currentTime;if((null===(t=Rs.audioEngine)||void 0===t?void 0:t.audioContext)&&(this.isPlaying||this.isPaused)){const t=this.isPaused?0:Rs.audioEngine.audioContext.currentTime-this.VM;return this.kM+t}return 0}get spatialSound(){return this.OM}set spatialSound(t){var i;this.OM=t,this.OM&&(null===(i=Rs.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&Rs.audioEngine.audioContext&&this.sb()}dispose(){var t;(null===(t=Rs.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&(this.isPlaying&&this.stop(),this.HM=!1,-1===this.soundTrackId?this.Kt.mainSoundTrack.removeSound(this):this.Kt.soundTracks&&this.Kt.soundTracks[this.soundTrackId].removeSound(this),this.tb&&(this.tb.disconnect(),this.tb=null),this.ab&&(this.ab.disconnect(),this.ab=null),this.lb&&(this.lb.disconnect(),this.lb=null),this.cb=null,this.ob&&(this.ob.pause(),this.ob.src="",document.body.removeChild(this.ob)),this.nb&&this.nb.disconnect(),this.ub&&this.fb&&(this.ub.unregisterAfterWorldMatrixUpdate(this.fb),this.ub=null))}isReady(){return this.HM}getClassName(){return"Sound"}hb(t){var i;(null===(i=Rs.audioEngine)||void 0===i?void 0:i.audioContext)&&(this.cb=t,this.HM=!0,this.autoplay&&this.play(0,this.JM,this.yE),this.QM&&this.QM())}rb(t){var i;(null===(i=Rs.audioEngine)||void 0===i?void 0:i.audioContext)&&Rs.audioEngine.audioContext.decodeAudioData(t,(t=>{this.hb(t)}),(t=>{F.Error("Error while decoding audio data for: "+this.name+" / Error: "+t)}))}setAudioBuffer(t){var i;(null===(i=Rs.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&(this.cb=t,this.HM=!0)}updateOptions(t){var i,e,s,n,r,h,o,a,l,c;t&&(this.loop=null!==(i=t.loop)&&void 0!==i?i:this.loop,this.maxDistance=null!==(e=t.maxDistance)&&void 0!==e?e:this.maxDistance,this.useCustomAttenuation=null!==(s=t.useCustomAttenuation)&&void 0!==s?s:this.useCustomAttenuation,this.rolloffFactor=null!==(n=t.rolloffFactor)&&void 0!==n?n:this.rolloffFactor,this.refDistance=null!==(r=t.refDistance)&&void 0!==r?r:this.refDistance,this.distanceModel=null!==(h=t.distanceModel)&&void 0!==h?h:this.distanceModel,this.BM=null!==(o=t.playbackRate)&&void 0!==o?o:this.BM,this.yE=null!==(a=t.length)&&void 0!==a?a:void 0,this.pb(null!==(l=t.offset)&&void 0!==l?l:void 0),this.setVolume(null!==(c=t.volume)&&void 0!==c?c:this.zM),this.mb(),this.isPlaying&&(this.UM&&this.ob?(this.ob.playbackRate=this.BM,this.ob.loop!==this.loop&&(this.ob.loop=this.loop)):this.lb&&(this.lb.playbackRate.value=this.BM,this.lb.loop!==this.loop&&(this.lb.loop=this.loop),void 0!==this.JM&&this.lb.loopStart!==this.JM&&(this.lb.loopStart=this.JM),void 0!==this.yE&&this.yE!==this.lb.loopEnd&&(this.lb.loopEnd=(0|this.JM)+this.yE))))}sb(){var t,i;(null===(t=Rs.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&Rs.audioEngine.audioContext&&(this.Kt.headphone&&(this.FM="HRTF"),this.ab=null!==(i=this.ab)&&void 0!==i?i:Rs.audioEngine.audioContext.createPanner(),this.ab&&this.eb&&(this.mb(),this.ab.connect(this.eb),this.ib=this.ab))}mb(){this.OM&&this.ab&&(this.useCustomAttenuation?(this.ab.distanceModel="linear",this.ab.maxDistance=Number.MAX_VALUE,this.ab.refDistance=1,this.ab.rolloffFactor=1,this.ab.panningModel=this.FM):(this.ab.distanceModel=this.distanceModel,this.ab.maxDistance=this.maxDistance,this.ab.refDistance=this.refDistance,this.ab.rolloffFactor=this.rolloffFactor,this.ab.panningModel=this.FM))}switchPanningModelToHRTF(){this.FM="HRTF",this.vb()}switchPanningModelToEqualPower(){this.FM="equalpower",this.vb()}vb(){var t;(null===(t=Rs.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this.OM&&this.ab&&(this.ab.panningModel=this.FM)}connectToSoundTrackAudioNode(t){var i;(null===(i=Rs.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this.eb&&(this.jM&&this.eb.disconnect(),this.eb.connect(t),this.jM=!0)}setDirectionalCone(t,i,e){i<t?F.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle."):(this.WM=t,this.$M=i,this.YM=e,this.XM=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this.JM,this.yE)))}get directionalConeInnerAngle(){return this.WM}set directionalConeInnerAngle(t){var i;if(t!=this.WM){if(this.$M<t)return void F.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this.WM=t,(null===(i=Rs.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this.OM&&this.ab&&(this.ab.coneInnerAngle=this.WM)}}get directionalConeOuterAngle(){return this.$M}set directionalConeOuterAngle(t){var i;if(t!=this.$M){if(t<this.WM)return void F.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this.$M=t,(null===(i=Rs.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this.OM&&this.ab&&(this.ab.coneOuterAngle=this.$M)}}setPosition(t){var i;t.equals(this.rA)||(this.rA.copyFrom(t),(null===(i=Rs.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this.OM&&this.ab&&!isNaN(this.rA.x)&&!isNaN(this.rA.y)&&!isNaN(this.rA.z)&&(this.ab.positionX.value=this.rA.x,this.ab.positionY.value=this.rA.y,this.ab.positionZ.value=this.rA.z))}setLocalDirectionToMesh(t){var i;this.GM=t,(null===(i=Rs.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this.ub&&this.isPlaying&&this.gb()}gb(){if(!this.ub||!this.ab)return;const t=this.ub.getWorldMatrix(),i=w.TransformNormal(this.GM,t);i.normalize(),this.ab.orientationX.value=i.x,this.ab.orientationY.value=i.y,this.ab.orientationZ.value=i.z}updateDistanceFromListener(){var t;if((null===(t=Rs.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this.ub&&this.useCustomAttenuation&&this.tb&&this.Kt.activeCamera){const t=this.ub.getDistanceToCamera(this.Kt.activeCamera);this.tb.gain.value=this.ZM(this.zM,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(t){this.ZM=t}play(t,i,e){var s,n,r,h;if(this.HM&&this.Kt.audioEnabled&&(null===(s=Rs.audioEngine)||void 0===s?void 0:s.audioContext))try{let s=t?(null===(n=Rs.audioEngine)||void 0===n?void 0:n.audioContext.currentTime)+t:null===(r=Rs.audioEngine)||void 0===r?void 0:r.audioContext.currentTime;if(this.lb&&this.nb||this.OM&&this.ab&&(isNaN(this.rA.x)||isNaN(this.rA.y)||isNaN(this.rA.z)||(this.ab.positionX.value=this.rA.x,this.ab.positionY.value=this.rA.y,this.ab.positionZ.value=this.rA.z),this.XM&&(this.ab.coneInnerAngle=this.WM,this.ab.coneOuterAngle=this.$M,this.ab.coneOuterGain=this.YM,this.ub?this.gb():this.ab.setOrientation(this.GM.x,this.GM.y,this.GM.z))),this.UM){if(this.nb||(this.nb=Rs.audioEngine.audioContext.createMediaElementSource(this.ob),this.ob.onended=()=>{this.Sb()},this.ob.playbackRate=this.BM),this.nb.disconnect(),this.ib&&this.nb.connect(this.ib),this.ob){const t=()=>{var i,e;if(null===(i=Rs.audioEngine)||void 0===i?void 0:i.unlocked){const i=this.ob.play();void 0!==i&&i.catch((()=>{var i,e;null===(i=Rs.audioEngine)||void 0===i||i.lock(),(this.loop||this.autoplay)&&(null===(e=Rs.audioEngine)||void 0===e||e.onAudioUnlockedObservable.addOnce((()=>{t()})))}))}else(this.loop||this.autoplay)&&(null===(e=Rs.audioEngine)||void 0===e||e.onAudioUnlockedObservable.addOnce((()=>{t()})))};t()}}else{const n=()=>{var n,r,h,o;if(null===(n=Rs.audioEngine)||void 0===n?void 0:n.audioContext){if(e=e||this.yE,void 0!==i&&this.pb(i),this.lb){const t=this.lb;t.onended=()=>{t.disconnect()}}if(this.lb=null===(r=Rs.audioEngine)||void 0===r?void 0:r.audioContext.createBufferSource(),this.lb&&this.ib){this.lb.buffer=this.cb,this.lb.connect(this.ib),this.lb.loop=this.loop,void 0!==i&&(this.lb.loopStart=i),void 0!==e&&(this.lb.loopEnd=(0|i)+e),this.lb.playbackRate.value=this.BM,this.lb.onended=()=>{this.Sb()},s=t?(null===(h=Rs.audioEngine)||void 0===h?void 0:h.audioContext.currentTime)+t:Rs.audioEngine.audioContext.currentTime;const n=((this.isPaused?this.currentTime:0)+(null!==(o=this.JM)&&void 0!==o?o:0))%this.lb.buffer.duration;this.lb.start(s,n,this.loop?void 0:e)}}};"suspended"===(null===(h=Rs.audioEngine)||void 0===h?void 0:h.audioContext.state)?setTimeout((()=>{var t;"suspended"===(null===(t=Rs.audioEngine)||void 0===t?void 0:t.audioContext.state)?(Rs.audioEngine.lock(),(this.loop||this.autoplay)&&Rs.audioEngine.onAudioUnlockedObservable.addOnce((()=>{n()}))):n()}),500):n()}this.VM=s,this.isPlaying=!0,this.isPaused=!1}catch(t){F.Error("Error while trying to play audio: "+this.name+", "+t.message)}}Sb(){this.isPlaying=!1,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(t){var i;if(this.isPlaying){if(this.UM)this.ob?(this.ob.pause(),this.ob.currentTime>0&&(this.ob.currentTime=0)):this.nb.disconnect(),this.isPlaying=!1;else if((null===(i=Rs.audioEngine)||void 0===i?void 0:i.audioContext)&&this.lb){const i=t?Rs.audioEngine.audioContext.currentTime+t:void 0;this.lb.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this.VM=0,this.kM=0,this.lb.onended=()=>{}},this.Eb(i)}}else this.isPaused&&(this.isPaused=!1,this.VM=0,this.kM=0)}pause(){var t;this.isPlaying&&(this.UM?(this.ob?this.ob.pause():this.nb.disconnect(),this.isPlaying=!1,this.isPaused=!0):(null===(t=Rs.audioEngine)||void 0===t?void 0:t.audioContext)&&(this.Eb(),this.isPlaying=!1,this.isPaused=!0,this.kM+=Rs.audioEngine.audioContext.currentTime-this.VM))}setVolume(t,i){var e;(null===(e=Rs.audioEngine)||void 0===e?void 0:e.canUseWebAudio)&&this.tb&&(i&&Rs.audioEngine.audioContext?(this.tb.gain.cancelScheduledValues(Rs.audioEngine.audioContext.currentTime),this.tb.gain.setValueAtTime(this.tb.gain.value,Rs.audioEngine.audioContext.currentTime),this.tb.gain.linearRampToValueAtTime(t,Rs.audioEngine.audioContext.currentTime+i)):this.tb.gain.value=t),this.zM=t}setPlaybackRate(t){this.BM=t,this.isPlaying&&(this.UM&&this.ob?this.ob.playbackRate=this.BM:this.lb&&(this.lb.playbackRate.value=this.BM))}getPlaybackRate(){return this.BM}getVolume(){return this.zM}attachToMesh(t){this.ub&&this.fb&&(this.ub.unregisterAfterWorldMatrixUpdate(this.fb),this.fb=null),this.ub=t,this.OM||(this.OM=!0,this.sb(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this.JM,this.yE))),this.Ab(this.ub),this.fb=t=>this.Ab(t),this.ub.registerAfterWorldMatrixUpdate(this.fb)}detachFromMesh(){this.ub&&this.fb&&(this.ub.unregisterAfterWorldMatrixUpdate(this.fb),this.fb=null,this.ub=null)}Ab(t){var i;if(t.getBoundingInfo){const i=t.getBoundingInfo();this.setPosition(i.boundingSphere.centerWorld)}else this.setPosition(t.absolutePosition);(null===(i=Rs.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this.XM&&this.isPlaying&&this.gb()}clone(){if(this.UM)return null;{const t=()=>{this.HM?(e.cb=this.getAudioBuffer(),e.HM=!0,e.autoplay&&e.play(0,this.JM,this.yE)):setTimeout(t,300)},i={autoplay:this.autoplay,loop:this.loop,volume:this.zM,spatialSound:this.OM,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},e=new Zs(this.name+"_cloned",new ArrayBuffer(0),this.Kt,null,i);return this.useCustomAttenuation&&e.setAttenuationFunction(this.ZM),e.setPosition(this.rA),e.setPlaybackRate(this.BM),t(),e}}getAudioBuffer(){return this.cb}getSoundSource(){return this.lb}getSoundGain(){return this.tb}serialize(){const t={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this.zM,spatialSound:this.OM,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this.BM,panningModel:this.FM,soundTrackId:this.soundTrackId,metadata:this.metadata};return this.OM&&(this.ub&&(t.connectedMeshId=this.ub.id),t.position=this.rA.asArray(),t.refDistance=this.refDistance,t.distanceModel=this.distanceModel,t.isDirectional=this.XM,t.localDirectionToMesh=this.GM.asArray(),t.coneInnerAngle=this.WM,t.coneOuterAngle=this.$M,t.coneOuterGain=this.YM),t}static Parse(t,i,e,s){const n=t.name;let r;r=t.url?e+t.url:e+n;const h={autoplay:t.autoplay,loop:t.loop,volume:t.volume,spatialSound:t.spatialSound,maxDistance:t.maxDistance,rolloffFactor:t.rolloffFactor,refDistance:t.refDistance,distanceModel:t.distanceModel,playbackRate:t.playbackRate};let o;if(s){const t=()=>{s.HM?(o.cb=s.getAudioBuffer(),o.HM=!0,o.autoplay&&o.play(0,o.JM,o.yE)):setTimeout(t,300)};o=new Zs(n,new ArrayBuffer(0),i,null,h),t()}else o=new Zs(n,r,i,(()=>{i.removePendingData(o)}),h),i.addPendingData(o);if(t.position){const i=w.FromArray(t.position);o.setPosition(i)}if(t.isDirectional&&(o.setDirectionalCone(t.coneInnerAngle||360,t.coneOuterAngle||360,t.coneOuterGain||0),t.localDirectionToMesh)){const i=w.FromArray(t.localDirectionToMesh);o.setLocalDirectionToMesh(i)}if(t.connectedMeshId){const e=i.getMeshById(t.connectedMeshId);e&&o.attachToMesh(e)}return t.metadata&&(o.metadata=t.metadata),o}pb(t){this.JM!==t&&(this.isPaused&&(this.stop(),this.isPaused=!1),this.JM=t)}Eb(t){this.lb&&(this.lb.stop(t),this.lb.disconnect())}}Zs.qM=t=>{throw X("AudioSceneComponent")};class Js{constructor(t,i={}){this.id=-1,this.Cb=!1,(t=t||E.LastCreatedScene)&&(this.Kt=t,this.soundCollection=new Array,this.wb=i,!this.wb.mainTrack&&this.Kt.soundTracks&&(this.Kt.soundTracks.push(this),this.id=this.Kt.soundTracks.length-1))}xb(){var t;(null===(t=Rs.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&Rs.audioEngine.audioContext&&(this.eb=Rs.audioEngine.audioContext.createGain(),this.eb.connect(Rs.audioEngine.masterGain),this.wb&&this.wb.volume&&(this.eb.gain.value=this.wb.volume),this.Cb=!0)}dispose(){if(Rs.audioEngine&&Rs.audioEngine.canUseWebAudio){for(this.DM&&this.DM.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this.eb&&this.eb.disconnect(),this.eb=null}}addSound(t){var i;this.Cb||this.xb(),(null===(i=Rs.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this.eb&&t.connectToSoundTrackAudioNode(this.eb),t.soundTrackId&&(-1===t.soundTrackId?this.Kt.mainSoundTrack.removeSound(t):this.Kt.soundTracks&&this.Kt.soundTracks[t.soundTrackId].removeSound(t)),this.soundCollection.push(t),t.soundTrackId=this.id}removeSound(t){const i=this.soundCollection.indexOf(t);-1!==i&&this.soundCollection.splice(i,1)}setVolume(t){var i;(null===(i=Rs.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this.eb&&(this.eb.gain.value=t)}switchPanningModelToHRTF(){var t;if(null===(t=Rs.audioEngine)||void 0===t?void 0:t.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){var t;if(null===(t=Rs.audioEngine)||void 0===t?void 0:t.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()}connectToAnalyser(t){var i;this.DM&&this.DM.stopDebugCanvas(),this.DM=t,(null===(i=Rs.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this.eb&&(this.eb.disconnect(),this.DM.connectAudioNodes(this.eb,Rs.audioEngine.masterGain))}}e.AddParser(fe.NAME_AUDIO,((t,i,e,s)=>{var n;let r,h=[];if(e.sounds=e.sounds||[],void 0!==t.sounds&&null!==t.sounds)for(let o=0,a=t.sounds.length;o<a;o++){const a=t.sounds[o];(null===(n=Rs.audioEngine)||void 0===n?void 0:n.canUseWebAudio)?(a.url||(a.url=a.name),h[a.url]?e.sounds.push(Zs.Parse(a,i,s,h[a.url])):(r=Zs.Parse(a,i,s),h[a.url]=r,e.sounds.push(r))):e.sounds.push(new Zs(a.name,null,i))}h=[]})),Object.defineProperty(ke.prototype,"mainSoundTrack",{get:function(){let t=this.Mg(fe.NAME_AUDIO);return t||(t=new tn(this),this.Ig(t)),this.Tb||(this.Tb=new Js(this,{mainTrack:!0})),this.Tb},enumerable:!0,configurable:!0}),ke.prototype.getSoundByName=function(t){let i;for(i=0;i<this.mainSoundTrack.soundCollection.length;i++)if(this.mainSoundTrack.soundCollection[i].name===t)return this.mainSoundTrack.soundCollection[i];if(this.soundTracks)for(let e=0;e<this.soundTracks.length;e++)for(i=0;i<this.soundTracks[e].soundCollection.length;i++)if(this.soundTracks[e].soundCollection[i].name===t)return this.soundTracks[e].soundCollection[i];return null},Object.defineProperty(ke.prototype,"audioEnabled",{get:function(){let t=this.Mg(fe.NAME_AUDIO);return t||(t=new tn(this),this.Ig(t)),t.audioEnabled},set:function(t){let i=this.Mg(fe.NAME_AUDIO);i||(i=new tn(this),this.Ig(i)),t?i.enableAudio():i.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(ke.prototype,"headphone",{get:function(){let t=this.Mg(fe.NAME_AUDIO);return t||(t=new tn(this),this.Ig(t)),t.headphone},set:function(t){let i=this.Mg(fe.NAME_AUDIO);i||(i=new tn(this),this.Ig(i)),t?i.switchAudioModeForHeadphones():i.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(ke.prototype,"audioListenerPositionProvider",{get:function(){let t=this.Mg(fe.NAME_AUDIO);return t||(t=new tn(this),this.Ig(t)),t.audioListenerPositionProvider},set:function(t){let i=this.Mg(fe.NAME_AUDIO);if(i||(i=new tn(this),this.Ig(i)),"function"!=typeof t)throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");i.audioListenerPositionProvider=t},enumerable:!0,configurable:!0}),Object.defineProperty(ke.prototype,"audioListenerRotationProvider",{get:function(){let t=this.Mg(fe.NAME_AUDIO);return t||(t=new tn(this),this.Ig(t)),t.audioListenerRotationProvider},set:function(t){let i=this.Mg(fe.NAME_AUDIO);if(i||(i=new tn(this),this.Ig(i)),"function"!=typeof t)throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");i.audioListenerRotationProvider=t},enumerable:!0,configurable:!0}),Object.defineProperty(ke.prototype,"audioPositioningRefreshRate",{get:function(){let t=this.Mg(fe.NAME_AUDIO);return t||(t=new tn(this),this.Ig(t)),t.audioPositioningRefreshRate},set:function(t){let i=this.Mg(fe.NAME_AUDIO);i||(i=new tn(this),this.Ig(i)),i.audioPositioningRefreshRate=t},enumerable:!0,configurable:!0});class tn{constructor(t){this.name=fe.NAME_AUDIO,this.Rb=!0,this.Ib=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this.Mb=new w,this.bb=new w,this._b=0,this.yb=new R,this.Nb=new w,(t=t||E.LastCreatedScene)&&(this.scene=t,t.soundTracks=new Array,t.sounds=new Array)}get audioEnabled(){return this.Rb}get headphone(){return this.Ib}register(){this.scene.sg.registerStep(fe.STEP_AFTERRENDER_AUDIO,this,this.Pb)}rebuild(){}serialize(t){if(t.sounds=[],this.scene.soundTracks)for(let i=0;i<this.scene.soundTracks.length;i++){const e=this.scene.soundTracks[i];for(let i=0;i<e.soundCollection.length;i++)t.sounds.push(e.soundCollection[i].serialize())}}addFromContainer(t){t.sounds&&t.sounds.forEach((t=>{t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)}))}removeFromContainer(t,i=!1){t.sounds&&t.sounds.forEach((t=>{t.stop(),t.autoplay=!1,this.scene.mainSoundTrack.removeSound(t),i&&t.dispose()}))}dispose(){const t=this.scene;if(t.Tb&&t.mainSoundTrack.dispose(),t.soundTracks)for(let i=0;i<t.soundTracks.length;i++)t.soundTracks[i].dispose()}disableAudio(){const t=this.scene;let i;for(this.Rb=!1,Rs.audioEngine&&Rs.audioEngine.audioContext&&Rs.audioEngine.audioContext.suspend(),i=0;i<t.mainSoundTrack.soundCollection.length;i++)t.mainSoundTrack.soundCollection[i].pause();if(t.soundTracks)for(i=0;i<t.soundTracks.length;i++)for(let e=0;e<t.soundTracks[i].soundCollection.length;e++)t.soundTracks[i].soundCollection[e].pause()}enableAudio(){const t=this.scene;let i;for(this.Rb=!0,Rs.audioEngine&&Rs.audioEngine.audioContext&&Rs.audioEngine.audioContext.resume(),i=0;i<t.mainSoundTrack.soundCollection.length;i++)t.mainSoundTrack.soundCollection[i].isPaused&&t.mainSoundTrack.soundCollection[i].play();if(t.soundTracks)for(i=0;i<t.soundTracks.length;i++)for(let e=0;e<t.soundTracks[i].soundCollection.length;e++)t.soundTracks[i].soundCollection[e].isPaused&&t.soundTracks[i].soundCollection[e].play()}switchAudioModeForHeadphones(){const t=this.scene;if(this.Ib=!0,t.mainSoundTrack.switchPanningModelToHRTF(),t.soundTracks)for(let i=0;i<t.soundTracks.length;i++)t.soundTracks[i].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const t=this.scene;if(this.Ib=!1,t.mainSoundTrack.switchPanningModelToEqualPower(),t.soundTracks)for(let i=0;i<t.soundTracks.length;i++)t.soundTracks[i].switchPanningModelToEqualPower()}Pb(){const t=bt.Now;if(this._b&&t-this._b<this.audioPositioningRefreshRate)return;this._b=t;const i=this.scene;if(!this.Rb||!i.Tb||!i.soundTracks||0===i.Tb.soundCollection.length&&1===i.soundTracks.length)return;const e=Rs.audioEngine;if(e&&e.audioContext){let t,s=i.activeCamera;if(i.activeCameras&&i.activeCameras.length>0&&(s=i.activeCameras[0]),this.audioListenerPositionProvider){const t=this.audioListenerPositionProvider();e.audioContext.listener.setPosition(t.x||0,t.y||0,t.z||0)}else s?this.bb.equals(s.globalPosition)||(this.bb.copyFrom(s.globalPosition),e.audioContext.listener.setPosition(s.globalPosition.x,s.globalPosition.y,s.globalPosition.z)):e.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const t=this.audioListenerRotationProvider();e.audioContext.listener.setOrientation(t.x||0,t.y||0,t.z||0,0,1,0)}else s?(s.rigCameras&&s.rigCameras.length>0&&(s=s.rigCameras[0]),s.getViewMatrix().invertToRef(this.yb),w.TransformNormalToRef(tn.Db,this.yb,this.Nb),this.Nb.normalize(),isNaN(this.Nb.x)||isNaN(this.Nb.y)||isNaN(this.Nb.z)||this.Mb.equals(this.Nb)||(this.Mb.copyFrom(this.Nb),e.audioContext.listener.setOrientation(this.Nb.x,this.Nb.y,this.Nb.z,0,1,0))):e.audioContext.listener.setOrientation(0,0,0,0,1,0);for(t=0;t<i.mainSoundTrack.soundCollection.length;t++){const e=i.mainSoundTrack.soundCollection[t];e.useCustomAttenuation&&e.updateDistanceFromListener()}if(i.soundTracks)for(t=0;t<i.soundTracks.length;t++)for(let e=0;e<i.soundTracks[t].soundCollection.length;e++){const s=i.soundTracks[t].soundCollection[e];s.useCustomAttenuation&&s.updateDistanceFromListener()}}}}tn.Db=new w(0,0,-1),Zs.qM=t=>{let i=t.Mg(fe.NAME_AUDIO);i||(i=new tn(t),t.Ig(i))};class en{constructor(t){this.Lb=null,this.ui=!0,this.isEnabled=!0,this.time=0,(t=t||E.LastCreatedScene)&&(this.Kt=t,this.animationParameters=new x(0,0,0,30))}tw(){for(const t of this.Kt.meshes)t.bakedVertexAnimationManager===this&&t.tw()}bind(t,i=!1){if(!this.Lb||!this.ui)return;const e=this.Lb.getSize();t.setFloat2("bakedVertexAnimationTextureSizeInverted",1/e.width,1/e.height),t.setFloat("bakedVertexAnimationTime",this.time),i||t.setVector4("bakedVertexAnimationSettings",this.animationParameters),t.setTexture("bakedVertexAnimationTexture",this.Lb)}clone(){const t=new en(this.Kt);return this.copyTo(t),t}setAnimationParameters(t,i,e=0,s=30){this.animationParameters=new x(t,i,e,s)}dispose(t){var i;t&&(null===(i=this.Lb)||void 0===i||i.dispose())}getClassName(){return"BakedVertexAnimationManager"}copyTo(t){ot.Clone((()=>t),this)}serialize(){return ot.Serialize(this)}parse(t,i,e){ot.Parse((()=>this),t,i,e)}}ut([Z(),q("_markSubMeshesAsAttributesDirty")],en.prototype,"texture",void 0),ut([Q(),q("_markSubMeshesAsAttributesDirty")],en.prototype,"isEnabled",void 0),ut([Q()],en.prototype,"animationParameters",void 0),ut([Q()],en.prototype,"time",void 0);class sn{constructor(t){this.Ob=1,this.Fb=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this.Lb=null,this.Ls=null,this.Bb=pt.Zero(),this.Ub=pt.Zero(),this.Vb=2,this.Lb=t,this.Lb&&(this.Ls=this.Lb.getEngine())}get wrapU(){return this.Ob}set wrapU(t){this.Ob=t}get wrapV(){return this.Fb}set wrapV(t){this.Fb=t}get coordinatesMode(){return 0}get isCube(){return!!this.Lb&&this.Lb.isCube}set isCube(t){this.Lb&&(this.Lb.isCube=t)}get is3D(){return!!this.Lb&&this.Lb.is3D}set is3D(t){this.Lb&&(this.Lb.is3D=t)}get is2DArray(){return!!this.Lb&&this.Lb.is2DArray}set is2DArray(t){this.Lb&&(this.Lb.is2DArray=t)}getClassName(){return"ThinTexture"}isReady(){return 4===this.delayLoadState?(this.delayLoad(),!1):!!this.Lb&&this.Lb.isReady}delayLoad(){}getInternalTexture(){return this.Lb}getSize(){if(this.Lb){if(this.Lb.width)return this.Bb.width=this.Lb.width,this.Bb.height=this.Lb.height,this.Bb;if(this.Lb.Qn)return this.Bb.width=this.Lb.Qn,this.Bb.height=this.Lb.Qn,this.Bb}return this.Bb}getBaseSize(){return this.isReady()&&this.Lb?this.Lb.Qn?(this.Ub.width=this.Lb.Qn,this.Ub.height=this.Lb.Qn,this.Ub):(this.Ub.width=this.Lb.baseWidth,this.Ub.height=this.Lb.baseHeight,this.Ub):(this.Ub.width=0,this.Ub.height=0,this.Ub)}get samplingMode(){return this.Lb?this.Lb.samplingMode:this.Vb}updateSamplingMode(t){this.Lb&&this.Ls&&this.Ls.updateTextureSamplingMode(t,this.Lb)}releaseInternalTexture(){this.Lb&&(this.Lb.dispose(),this.Lb=null)}dispose(){this.Lb&&(this.releaseInternalTexture(),this.Ls=null)}}class nn extends sn{constructor(t,i=null){super(null),this.metadata=null,this.reservedDataStore=null,this.kb=!1,this.Gb=!1,this.level=1,this.zb=0,this.optimizeUVAllocation=!0,this.Hb=0,this.wrapR=1,this.anisotropicFilteringLevel=nn.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this.Xb=!1,this.wr=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this.Wb=!1,this.$b=!1,this.animations=new Array,this.onDisposeObservable=new h,this.Li=null,this.Kt=null,this.mg=null,this.Si=null,this.Yb=!1,t?nn.jb(t)?this.Kt=t:this.Ls=t:this.Kt=E.LastCreatedScene,this.Kt&&(this.uniqueId=this.Kt.getUniqueId(),this.Kt.addTexture(this),this.Ls=this.Kt.getEngine()),this.Lb=i,this.mg=null}set hasAlpha(t){this.kb!==t&&(this.kb=t,this.Kt&&this.Kt.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this))))}get hasAlpha(){return this.kb}set getAlphaFromRGB(t){this.Gb!==t&&(this.Gb=t,this.Kt&&this.Kt.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this))))}get getAlphaFromRGB(){return this.Gb}set coordinatesIndex(t){this.zb!==t&&(this.zb=t,this.Kt&&this.Kt.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this))))}get coordinatesIndex(){return this.zb}set coordinatesMode(t){this.Hb!==t&&(this.Hb=t,this.Kt&&this.Kt.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this))))}get coordinatesMode(){return this.Hb}get wrapU(){return this.Ob}set wrapU(t){this.Ob=t}get wrapV(){return this.Fb}set wrapV(t){this.Fb=t}get isCube(){return this.Lb?this.Lb.isCube:this.Xb}set isCube(t){this.Lb?this.Lb.isCube=t:this.Xb=t}get is3D(){return!!this.Lb&&this.Lb.is3D}set is3D(t){this.Lb&&(this.Lb.is3D=t)}get is2DArray(){return!!this.Lb&&this.Lb.is2DArray}set is2DArray(t){this.Lb&&(this.Lb.is2DArray=t)}get gammaSpace(){return this.Lb?(null===this.Lb.wr&&(this.Lb.wr=this.wr),this.Lb.wr&&!this.Lb.ur):this.wr}set gammaSpace(t){if(this.Lb){if(this.Lb.wr===t)return;this.Lb.wr=t}else{if(this.wr===t)return;this.wr=t}this.UR()}get isRGBD(){return null!=this.Lb&&this.Lb.vr}set isRGBD(t){this.Lb&&(this.Lb.vr=t)}get noMipmap(){return!1}get lodGenerationOffset(){return this.Lb?this.Lb.cr:0}set lodGenerationOffset(t){this.Lb&&(this.Lb.cr=t)}get lodGenerationScale(){return this.Lb?this.Lb.lr:0}set lodGenerationScale(t){this.Lb&&(this.Lb.lr=t)}get linearSpecularLOD(){return!!this.Lb&&this.Lb.gr}set linearSpecularLOD(t){this.Lb&&(this.Lb.gr=t)}get irradianceTexture(){return this.Lb?this.Lb.Sr:null}set irradianceTexture(t){this.Lb&&(this.Lb.Sr=t)}get uid(){return this.mg||(this.mg=Vi()),this.mg}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(t){this.Li&&this.onDisposeObservable.remove(this.Li),this.Li=this.onDisposeObservable.add(t)}get isBlocking(){return!0}get loadingError(){return this.Yb}get errorObject(){return this.Kb}getScene(){return this.Kt}qb(){return this.Ls}checkTransformsAreIdentical(t){return null!==t}getTextureMatrix(){return R.IdentityReadOnly}getReflectionTextureMatrix(){return R.IdentityReadOnly}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(t){}get canRescale(){return!1}Qb(t,i,e,s,n,r){const h=this.qb();if(!h)return null;const o=h.ba(!!n,i),a=h.getLoadedTexturesCache();for(let h=0;h<a.length;h++){const l=a[h];if(!(void 0!==n&&o!==l.ur||void 0!==s&&s!==l.invertY||l.url!==t||l.generateMipMaps!==!i||e&&e!==l.samplingMode||void 0!==r&&r!==l.isCube))return l.incrementReferences(),l}return null}br(){}clone(){return null}get textureType(){return this.Lb&&void 0!==this.Lb.type?this.Lb.type:0}get textureFormat(){return this.Lb&&void 0!==this.Lb.format?this.Lb.format:5}UR(){const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}readPixels(t=0,i=0,e=null,s=!0,n=!1,r=0,h=0,o=Number.MAX_VALUE,a=Number.MAX_VALUE){if(!this.Lb)return null;const l=this.qb();if(!l)return null;const c=this.getSize();let u=c.width,f=c.height;0!==i&&(u/=Math.pow(2,i),f/=Math.pow(2,i),u=Math.round(u),f=Math.round(f)),o=Math.min(u,o),a=Math.min(f,a);try{return this.Lb.isCube?l.Aw(this.Lb,o,a,t,i,e,s,n,r,h):l.Aw(this.Lb,o,a,-1,i,e,s,n,r,h)}catch(t){return null}}Zb(t=0,i=0,e=null,s=!0,n=!1){if(!this.Lb)return null;const r=this.getSize();let h=r.width,o=r.height;const a=this.qb();if(!a)return null;0!=i&&(h/=Math.pow(2,i),o/=Math.pow(2,i),h=Math.round(h),o=Math.round(o));try{return this.Lb.isCube?a.Ew(this.Lb,h,o,t,i,e,s,n):a.Ew(this.Lb,h,o,-1,i,e,s,n)}catch(t){return null}}get dr(){return this.Lb?this.Lb.dr:null}get pr(){return this.Lb?this.Lb.pr:null}get mr(){return this.Lb?this.Lb.mr:null}dispose(){if(this.Kt){this.Kt.stopAnimation&&this.Kt.stopAnimation(this),this.Kt.removePendingData(this);const t=this.Kt.textures.indexOf(this);if(t>=0&&this.Kt.textures.splice(t,1),this.Kt.onTextureRemovedObservable.notifyObservers(this),this.Kt=null,this.Si){const t=this.Si.textures.indexOf(this);t>-1&&this.Si.textures.splice(t,1),this.Si=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(t=!1){if(!this.name&&!t)return null;const i=ot.Serialize(this);return ot.AppendSerializedAnimations(this,i),i}static WhenAllReady(t,i){let e=t.length;if(0!==e)for(let s=0;s<t.length;s++){const n=t[s];if(n.isReady())0==--e&&i();else{const t=n.onLoadObservable;t?t.addOnce((()=>{0==--e&&i()})):0==--e&&i()}}else i()}static jb(t){return"Scene"===t.getClassName()}}function rn(t,i,e=!1){const s=i.width,n=i.height;if(t instanceof Float32Array){let i=t.byteLength/t.BYTES_PER_ELEMENT;const e=new Uint8Array(i);for(;--i>=0;){let s=t[i];s<0?s=0:s>1&&(s=1),e[i]=255*s}t=e}const r=document.createElement("canvas");r.width=s,r.height=n;const h=r.getContext("2d");if(!h)return null;const o=h.createImageData(s,n);if(o.data.set(t),h.putImageData(o,0,0),e){const t=document.createElement("canvas");t.width=s,t.height=n;const i=t.getContext("2d");return i?(i.translate(0,n),i.scale(1,-1),i.drawImage(r,0,0),t.toDataURL("image/png")):null}return r.toDataURL("image/png")}function hn(t,i=0,e=0){const s=t.getInternalTexture();if(!s)return null;const n=t.Zb(i,e);return n?rn(n,t.getSize(),s.invertY):null}async function on(t,i=0,e=0){const s=t.getInternalTexture();if(!s)return null;const n=await t.readPixels(i,e);return n?rn(n,t.getSize(),s.invertY):null}nn.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,ut([Q()],nn.prototype,"uniqueId",void 0),ut([Q()],nn.prototype,"name",void 0),ut([Q()],nn.prototype,"metadata",void 0),ut([Q("hasAlpha")],nn.prototype,"_hasAlpha",void 0),ut([Q("getAlphaFromRGB")],nn.prototype,"_getAlphaFromRGB",void 0),ut([Q()],nn.prototype,"level",void 0),ut([Q("coordinatesIndex")],nn.prototype,"_coordinatesIndex",void 0),ut([Q()],nn.prototype,"optimizeUVAllocation",void 0),ut([Q("coordinatesMode")],nn.prototype,"_coordinatesMode",void 0),ut([Q()],nn.prototype,"wrapU",null),ut([Q()],nn.prototype,"wrapV",null),ut([Q()],nn.prototype,"wrapR",void 0),ut([Q()],nn.prototype,"anisotropicFilteringLevel",void 0),ut([Q()],nn.prototype,"isCube",null),ut([Q()],nn.prototype,"is3D",null),ut([Q()],nn.prototype,"is2DArray",null),ut([Q()],nn.prototype,"gammaSpace",null),ut([Q()],nn.prototype,"invertZ",void 0),ut([Q()],nn.prototype,"lodLevelInAlpha",void 0),ut([Q()],nn.prototype,"lodGenerationOffset",null),ut([Q()],nn.prototype,"lodGenerationScale",null),ut([Q()],nn.prototype,"linearSpecularLOD",null),ut([Z()],nn.prototype,"irradianceTexture",null),ut([Q()],nn.prototype,"isRenderTarget",void 0);class an extends nn{constructor(t,i,e,s,n=an.TRILINEAR_SAMPLINGMODE,r=null,o=null,a=null,l=!1,c,u,f,d,p){var m,v,g,S,E,A,C,w,x;let T;super(i),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this.Jb=!1,this.t_=!1,this.i_=null,this.e_=null,this.s_=null,this.n_=null,this.r_=null,this.h_=null,this.o_=-1,this.a_=-1,this.l_=0,this.c_=0,this.u_=-1,this.f_=-1,this.d_=-1,this.p_=-1,this.m_=-1,this.v_=-1,this.g_=-1,this.S_=!1,this.E_=null,this.A_=-1,this.C_=-1,this.w_=0,this.x_=0,this.T_=-1,this.Yn=null,this.ua=!1,this.R_=null,this.I_=null,this.M_=null,this.onLoadObservable=new h,this.b_=!0,this.name=t||"",this.url=t;let R=!1,I=null;"object"==typeof e&&null!==e?(T=null!==(m=e.noMipmap)&&void 0!==m&&m,s=null!==(v=e.invertY)&&void 0!==v?v:!As.UseOpenGLOrientationForUV,n=null!==(g=e.samplingMode)&&void 0!==g?g:an.TRILINEAR_SAMPLINGMODE,r=null!==(S=e.onLoad)&&void 0!==S?S:null,o=null!==(E=e.onError)&&void 0!==E?E:null,a=null!==(A=e.buffer)&&void 0!==A?A:null,l=null!==(C=e.deleteBuffer)&&void 0!==C&&C,c=e.format,u=e.mimeType,f=e.loaderOptions,d=e.creationFlags,R=null!==(w=e.useSRGBBuffer)&&void 0!==w&&w,I=null!==(x=e.internalTexture)&&void 0!==x?x:null):T=!!e,this.Jb=T,this.t_=void 0===s?!As.UseOpenGLOrientationForUV:s,this.Vb=n,this.Yn=a,this.ua=l,this.__=u,this.y_=f,this.N_=d,this.ur=R,this.P_=p,c&&(this.R_=c);const M=this.getScene(),b=this.qb();if(!b)return;b.onBeforeTextureInitObservable.notifyObservers(this);const _=()=>{this.Lb&&(this.Lb.Xn&&(this.vScale*=-1,this.vOffset+=1),null!==this.Lb.Vn&&(this.wrapU=this.Lb.Vn,this.Lb.Vn=null),null!==this.Lb.kn&&(this.wrapV=this.Lb.kn,this.Lb.kn=null),null!==this.Lb.Gn&&(this.wrapR=this.Lb.Gn,this.Lb.Gn=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),r&&r(),!this.isBlocking&&M&&M.resetCachedMaterial()},y=(t,i)=>{this.Yb=!0,this.Kb={message:t,exception:i},o&&o(t,i),an.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!I)return this.I_=_,void(this.M_=y);if(this.Lb=null!=I?I:this.Qb(this.url,T,n,this.t_,R),this.Lb)if(this.Lb.isReady)Ai.SetImmediate((()=>_()));else{const t=this.Lb.onLoadedObservable.add(_);this.Lb.onErrorObservable.add((i=>{var e;y(i.message,i.exception),null===(e=this.Lb)||void 0===e||e.onLoadedObservable.remove(t)}))}else if(M&&M.useDelayedTextureLoading)this.delayLoadState=4,this.I_=_,this.M_=y;else{try{this.Lb=b.createTexture(this.url,T,this.t_,M,n,_,y,this.Yn,void 0,this.R_,this.P_,u,f,d,R)}catch(t){throw y("error loading",t),t}l&&(this.Yn=null)}}get noMipmap(){return this.Jb}get mimeType(){return this.__}set isBlocking(t){this.b_=t}get isBlocking(){return this.b_}get invertY(){return this.t_}updateURL(t,i=null,e,s){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),this.name&&!this.name.startsWith("data:")||(this.name=t),this.url=t,this.Yn=i,this.P_=s,this.delayLoadState=4,e&&(this.I_=e),this.delayLoad()}delayLoad(){if(4!==this.delayLoadState)return;const t=this.getScene();t&&(this.delayLoadState=1,this.Lb=this.Qb(this.url,this.Jb,this.samplingMode,this.t_,this.ur),this.Lb?this.I_&&(this.Lb.isReady?Ai.SetImmediate(this.I_):this.Lb.onLoadedObservable.add(this.I_)):(this.Lb=t.getEngine().createTexture(this.url,this.Jb,this.t_,t,this.samplingMode,this.I_,this.M_,this.Yn,null,this.R_,this.P_,this.__,this.y_,this.N_,this.ur),this.ua&&(this.Yn=null)),this.I_=null,this.M_=null)}D_(t,i,e,s){t*=this.l_,i*=this.c_,t-=this.uRotationCenter*this.l_,i-=this.vRotationCenter*this.c_,e-=this.wRotationCenter,w.TransformCoordinatesFromFloatsToRef(t,i,e,this.i_,s),s.x+=this.uRotationCenter*this.l_+this.o_,s.y+=this.vRotationCenter*this.c_+this.a_,s.z+=this.wRotationCenter}checkTransformsAreIdentical(t){return null!==t&&this.uOffset===t.uOffset&&this.vOffset===t.vOffset&&this.uScale===t.uScale&&this.vScale===t.vScale&&this.uAng===t.uAng&&this.vAng===t.vAng&&this.wAng===t.wAng}getTextureMatrix(t=1){if(this.uOffset===this.o_&&this.vOffset===this.a_&&this.uScale*t===this.l_&&this.vScale===this.c_&&this.uAng===this.u_&&this.vAng===this.f_&&this.wAng===this.d_&&this.uRotationCenter===this.m_&&this.vRotationCenter===this.v_&&this.wRotationCenter===this.g_&&this.homogeneousRotationInUVTransform===this.S_)return this.e_;this.o_=this.uOffset,this.a_=this.vOffset,this.l_=this.uScale*t,this.c_=this.vScale,this.u_=this.uAng,this.f_=this.vAng,this.d_=this.wAng,this.m_=this.uRotationCenter,this.v_=this.vRotationCenter,this.g_=this.wRotationCenter,this.S_=this.homogeneousRotationInUVTransform,this.e_&&this.i_||(this.e_=R.Zero(),this.i_=new R,this.n_=w.Zero(),this.r_=w.Zero(),this.h_=w.Zero()),R.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this.i_),this.homogeneousRotationInUVTransform?(R.TranslationToRef(-this.m_,-this.v_,-this.g_,M.Matrix[0]),R.TranslationToRef(this.m_,this.v_,this.g_,M.Matrix[1]),R.ScalingToRef(this.l_,this.c_,0,M.Matrix[2]),R.TranslationToRef(this.o_,this.a_,0,M.Matrix[3]),M.Matrix[0].multiplyToRef(this.i_,this.e_),this.e_.multiplyToRef(M.Matrix[1],this.e_),this.e_.multiplyToRef(M.Matrix[2],this.e_),this.e_.multiplyToRef(M.Matrix[3],this.e_),this.e_.setRowFromFloats(2,this.e_.m[12],this.e_.m[13],this.e_.m[14],1)):(this.D_(0,0,0,this.n_),this.D_(1,0,0,this.r_),this.D_(0,1,0,this.h_),this.r_.subtractInPlace(this.n_),this.h_.subtractInPlace(this.n_),R.FromValuesToRef(this.r_.x,this.r_.y,this.r_.z,0,this.h_.x,this.h_.y,this.h_.z,0,this.n_.x,this.n_.y,this.n_.z,0,0,0,0,1,this.e_));const i=this.getScene();return i?(this.optimizeUVAllocation&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this))),this.e_):this.e_}getReflectionTextureMatrix(){const t=this.getScene();if(!t)return this.E_;if(this.uOffset===this.A_&&this.vOffset===this.C_&&this.uScale===this.w_&&this.vScale===this.x_&&this.coordinatesMode===this.T_){if(this.coordinatesMode!==an.PROJECTION_MODE)return this.E_;if(this.p_===t.getProjectionMatrix().updateFlag)return this.E_}this.E_||(this.E_=R.Zero()),this.s_||(this.s_=R.Zero());const i=this.T_!==this.coordinatesMode;switch(this.A_=this.uOffset,this.C_=this.vOffset,this.w_=this.uScale,this.x_=this.vScale,this.T_=this.coordinatesMode,this.coordinatesMode){case an.PLANAR_MODE:R.IdentityToRef(this.E_),this.E_[0]=this.uScale,this.E_[5]=this.vScale,this.E_[12]=this.uOffset,this.E_[13]=this.vOffset;break;case an.PROJECTION_MODE:{R.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this.s_);const i=t.getProjectionMatrix();this.p_=i.updateFlag,i.multiplyToRef(this.s_,this.E_);break}default:R.IdentityToRef(this.E_)}return i&&t.markAllMaterialsAsDirty(1,(t=>-1!==t.getActiveTextures().indexOf(this))),this.E_}clone(){const t={noMipmap:this.Jb,invertY:this.t_,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this.Lb?this.Lb.Yn:void 0,deleteBuffer:this.ua,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this.y_,creationFlags:this.N_,useSRGBBuffer:this.ur};return ot.Clone((()=>new an(this.Lb?this.Lb.url:null,this.getScene(),t)),this)}serialize(){var t,i;const e=this.name;an.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const s=super.serialize(an.L_);return s?((an.SerializeBuffers||an.ForceSerializeBuffers)&&("string"==typeof this.Yn&&"data:"===this.Yn.substr(0,5)?(s.base64String=this.Yn,s.name=s.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this.Yn instanceof Uint8Array?s.base64String="data:image/png;base64,"+Ut(this.Yn):(an.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this.$b)&&(s.base64String=!this.Ls||this.Ls.hs.supportSyncTextureRead?hn(this):on(this))),s.invertY=this.t_,s.samplingMode=this.samplingMode,s.N_=this.N_,s.ur=this.ur,an.L_&&(s.internalTextureUniqueId=null!==(i=null===(t=this.Lb)||void 0===t?void 0:t.uniqueId)&&void 0!==i?i:void 0),this.name=e,s):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this.I_=null,this.M_=null,this.Yn=null}static Parse(t,i,e){if(t.customType){const s=Ui.Instantiate(t.customType).Parse(t,i,e);return t.samplingMode&&s.updateSamplingMode&&s.O_&&s.O_!==t.samplingMode&&s.updateSamplingMode(t.samplingMode),s}if(t.isCube&&!t.isRenderTarget)return an.F_(t,i,e);const s=void 0!==t.internalTextureUniqueId;if(!t.name&&!t.isRenderTarget&&!s)return null;let n;if(s){const e=i.getEngine().getLoadedTexturesCache();for(const i of e)if(i.uniqueId===t.internalTextureUniqueId){n=i;break}}const r=i=>{var e;if(i&&i.Lb&&(i.Lb.Vn=null,i.Lb.kn=null,i.Lb.Gn=null),t.samplingMode){const e=t.samplingMode;i&&i.samplingMode!==e&&i.updateSamplingMode(e)}if(i&&t.animations)for(let e=0;e<t.animations.length;e++){const s=t.animations[e],n=g("BABYLON.Animation");n&&i.animations.push(n.Parse(s))}s&&!n&&(null===(e=null==i?void 0:i.Lb)||void 0===e||e.Mr(t.internalTextureUniqueId))};return ot.Parse((()=>{var s,h,o;let a=!0;if(t.noMipmap&&(a=!1),t.mirrorPlane){const e=an.B_(t.name,t.renderTargetSize,i,a);return e.U_=t.renderList,e.mirrorPlane=Pe.FromArray(t.mirrorPlane),r(e),e}if(t.isRenderTarget){let e=null;if(t.isCube){if(i.reflectionProbes)for(let e=0;e<i.reflectionProbes.length;e++){const s=i.reflectionProbes[e];if(s.name===t.name)return s.cubeTexture}}else e=an.V_(t.name,t.renderTargetSize,i,a,null!==(s=t.N_)&&void 0!==s?s:0),e.U_=t.renderList;return r(e),e}{let s;if(t.base64String&&!n)s=an.CreateFromBase64String(t.base64String,t.base64String,i,!a,t.invertY,t.samplingMode,(()=>{r(s)}),null!==(h=t.N_)&&void 0!==h?h:0,null!==(o=t.ur)&&void 0!==o&&o),s.name=t.name;else{let h;h=t.name&&t.name.indexOf("://")>0?t.name:e+t.name,t.url&&(t.url.startsWith("data:")||an.UseSerializedUrlIfAny)&&(h=t.url);const o={noMipmap:!a,invertY:t.invertY,samplingMode:t.samplingMode,onLoad:()=>{r(s)},internalTexture:n};s=new an(h,i,o)}return s}}),t,i)}static CreateFromBase64String(t,i,e,s,n,r=an.TRILINEAR_SAMPLINGMODE,h=null,o=null,a=5,l){return new an("data:"+i,e,s,n,r,h,o,t,!1,a,void 0,void 0,l)}static LoadFromDataString(t,i,e,s=!1,n,r=!0,h=an.TRILINEAR_SAMPLINGMODE,o=null,a=null,l=5,c){return"data:"!==t.substr(0,5)&&(t="data:"+t),new an(t,e,n,r,h,o,a,i,s,l,void 0,void 0,c)}}function ln(t,i,e,s){let n,r=1;1===s?n=new Float32Array(i*e*4):2===s?(n=new Uint16Array(i*e*4),r=15360):n=7===s?new Uint32Array(i*e*4):new Uint8Array(i*e*4);for(let s=0;s<i;s++)for(let h=0;h<e;h++){const e=3*(h*i+s),o=4*(h*i+s);n[o+0]=t[e+0],n[o+1]=t[e+1],n[o+2]=t[e+2],n[o+3]=r}return n}function cn(t){return function(i,e,s,n,r,h,o,a,l=null,c=0){const u=t?this.lo.TEXTURE_3D:this.lo.TEXTURE_2D_ARRAY,f=t?oi.Raw3D:oi.Raw2DArray,d=new ai(this,f);d.baseWidth=e,d.baseHeight=s,d.baseDepth=n,d.width=e,d.height=s,d.depth=n,d.format=r,d.type=c,d.generateMipMaps=h,d.samplingMode=a,t?d.is3D=!0:d.is2DArray=!0,this.mh||(d.jn=i),t?this.updateRawTexture3D(d,i,r,o,l,c):this.updateRawTexture2DArray(d,i,r,o,l,c),this.qo(u,d,!0);const p=this.wa(a,h);return this.lo.texParameteri(u,this.lo.TEXTURE_MAG_FILTER,p.mag),this.lo.texParameteri(u,this.lo.TEXTURE_MIN_FILTER,p.min),h&&this.lo.generateMipmap(u),this.qo(u,null),this.Rh.push(d),d}}function un(t){return function(i,e,s,n,r=null,h=0){const o=t?this.lo.TEXTURE_3D:this.lo.TEXTURE_2D_ARRAY,a=this.Ma(h),l=this.Ia(s),c=this.Ra(h,s);this.qo(o,i,!0),this.La(void 0===n||!!n),this.mh||(i.jn=e,i.format=s,i.invertY=n,i.nr=r),i.width%4!=0&&this.lo.pixelStorei(this.lo.UNPACK_ALIGNMENT,1),r&&e?this.lo.compressedTexImage3D(o,0,this.getCaps().s3tc[r],i.width,i.height,i.depth,0,e):this.lo.texImage3D(o,0,c,i.width,i.height,i.depth,0,l,a,e),i.generateMipMaps&&this.lo.generateMipmap(o),this.qo(o,null),i.isReady=!0}}an.SerializeBuffers=!0,an.ForceSerializeBuffers=!1,an.OnTextureLoadErrorObservable=new h,an.L_=!1,an.F_=(t,i,e)=>{throw X("CubeTexture")},an.B_=(t,i,e,s)=>{throw X("MirrorTexture")},an.V_=(t,i,e,s,n)=>{throw X("RenderTargetTexture")},an.NEAREST_SAMPLINGMODE=1,an.NEAREST_NEAREST_MIPLINEAR=8,an.BILINEAR_SAMPLINGMODE=2,an.LINEAR_LINEAR_MIPNEAREST=11,an.TRILINEAR_SAMPLINGMODE=3,an.LINEAR_LINEAR_MIPLINEAR=3,an.NEAREST_NEAREST_MIPNEAREST=4,an.NEAREST_LINEAR_MIPNEAREST=5,an.NEAREST_LINEAR_MIPLINEAR=6,an.NEAREST_LINEAR=7,an.NEAREST_NEAREST=1,an.LINEAR_NEAREST_MIPNEAREST=9,an.LINEAR_NEAREST_MIPLINEAR=10,an.LINEAR_LINEAR=2,an.LINEAR_NEAREST=12,an.EXPLICIT_MODE=0,an.SPHERICAL_MODE=1,an.PLANAR_MODE=2,an.CUBIC_MODE=3,an.PROJECTION_MODE=4,an.SKYBOX_MODE=5,an.INVCUBIC_MODE=6,an.EQUIRECTANGULAR_MODE=7,an.FIXED_EQUIRECTANGULAR_MODE=8,an.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,an.CLAMP_ADDRESSMODE=0,an.WRAP_ADDRESSMODE=1,an.MIRROR_ADDRESSMODE=2,an.UseSerializedUrlIfAny=!1,ut([Q()],an.prototype,"url",void 0),ut([Q()],an.prototype,"uOffset",void 0),ut([Q()],an.prototype,"vOffset",void 0),ut([Q()],an.prototype,"uScale",void 0),ut([Q()],an.prototype,"vScale",void 0),ut([Q()],an.prototype,"uAng",void 0),ut([Q()],an.prototype,"vAng",void 0),ut([Q()],an.prototype,"wAng",void 0),ut([Q()],an.prototype,"uRotationCenter",void 0),ut([Q()],an.prototype,"vRotationCenter",void 0),ut([Q()],an.prototype,"wRotationCenter",void 0),ut([Q()],an.prototype,"homogeneousRotationInUVTransform",void 0),ut([Q()],an.prototype,"isBlocking",null),v("BABYLON.Texture",an),ot.ni=an.Parse,Ei.prototype.updateRawTexture=function(t,i,e,s,n=null,r=0,h=!1){if(!t)return;const o=this.Ra(r,e,h),a=this.Ia(e),l=this.Ma(r);this.qo(this.lo.TEXTURE_2D,t,!0),this.La(void 0===s||!!s),this.mh||(t.jn=i,t.format=e,t.type=r,t.invertY=s,t.nr=n),t.width%4!=0&&this.lo.pixelStorei(this.lo.UNPACK_ALIGNMENT,1),n&&i?this.lo.compressedTexImage2D(this.lo.TEXTURE_2D,0,this.getCaps().s3tc[n],t.width,t.height,0,i):this.lo.texImage2D(this.lo.TEXTURE_2D,0,o,t.width,t.height,0,a,l,i),t.generateMipMaps&&this.lo.generateMipmap(this.lo.TEXTURE_2D),this.qo(this.lo.TEXTURE_2D,null),t.isReady=!0},Ei.prototype.createRawTexture=function(t,i,e,s,n,r,h,o=null,a=0,l=0,c=!1){const u=new ai(this,oi.Raw);u.baseWidth=i,u.baseHeight=e,u.width=i,u.height=e,u.format=s,u.generateMipMaps=n,u.samplingMode=h,u.invertY=r,u.nr=o,u.type=a,u.ur=this.ba(c,!n),this.mh||(u.jn=t),this.updateRawTexture(u,t,s,r,o,a,u.ur),this.qo(this.lo.TEXTURE_2D,u,!0);const f=this.wa(h,n);return this.lo.texParameteri(this.lo.TEXTURE_2D,this.lo.TEXTURE_MAG_FILTER,f.mag),this.lo.texParameteri(this.lo.TEXTURE_2D,this.lo.TEXTURE_MIN_FILTER,f.min),n&&this.lo.generateMipmap(this.lo.TEXTURE_2D),this.qo(this.lo.TEXTURE_2D,null),this.Rh.push(u),u},Ei.prototype.createRawCubeTexture=function(t,i,e,s,n,r,h,o=null){const a=this.lo,l=new ai(this,oi.CubeRaw);l.isCube=!0,l.format=e,l.type=s,this.mh||(l.Kn=t);const c=this.Ma(s);let u=this.Ia(e);u===a.RGB&&(u=a.RGBA),c!==a.FLOAT||this.po.textureFloatLinearFiltering?c!==this.lo.HALF_FLOAT_OES||this.po.textureHalfFloatLinearFiltering?c!==a.FLOAT||this.po.textureFloatRender?c!==a.HALF_FLOAT||this.po.colorBufferFloat||(n=!1,F.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(n=!1,F.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(n=!1,h=1,F.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(n=!1,h=1,F.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const f=i,d=f;l.width=f,l.height=d,l.invertY=r,l.nr=o;if(!this.needPOTTextures||ki.IsExponentOfTwo(l.width)&&ki.IsExponentOfTwo(l.height)||(n=!1),t)this.updateRawCubeTexture(l,t,e,s,r,o);else{const t=this.Ra(s),i=0;this.qo(a.TEXTURE_CUBE_MAP,l,!0);for(let e=0;e<6;e++)o?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+e,i,this.getCaps().s3tc[o],l.width,l.height,0,void 0):a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+e,i,t,l.width,l.height,0,u,c,null);this.qo(this.lo.TEXTURE_CUBE_MAP,null)}this.qo(this.lo.TEXTURE_CUBE_MAP,l,!0),t&&n&&this.lo.generateMipmap(this.lo.TEXTURE_CUBE_MAP);const p=this.wa(h,n);return a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,p.mag),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,p.min),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),this.qo(a.TEXTURE_CUBE_MAP,null),l.generateMipMaps=n,l.samplingMode=h,l.isReady=!0,l},Ei.prototype.updateRawCubeTexture=function(t,i,e,s,n,r=null,h=0){t.Kn=i,t.format=e,t.type=s,t.invertY=n,t.nr=r;const o=this.lo,a=this.Ma(s);let l=this.Ia(e);const c=this.Ra(s);let u=!1;l===o.RGB&&(l=o.RGBA,u=!0),this.qo(o.TEXTURE_CUBE_MAP,t,!0),this.La(void 0===n||!!n),t.width%4!=0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let e=0;e<6;e++){let n=i[e];r?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+e,h,this.getCaps().s3tc[r],t.width,t.height,0,n):(u&&(n=ln(n,t.width,t.height,s)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+e,h,c,t.width,t.height,0,l,a,n))}(!this.needPOTTextures||ki.IsExponentOfTwo(t.width)&&ki.IsExponentOfTwo(t.height))&&t.generateMipMaps&&0===h&&this.lo.generateMipmap(this.lo.TEXTURE_CUBE_MAP),this.qo(this.lo.TEXTURE_CUBE_MAP,null),t.isReady=!0},Ei.prototype.createRawCubeTextureFromUrl=function(t,i,e,s,n,r,h,o,a=null,l=null,c=3,u=!1){const f=this.lo,d=this.createRawCubeTexture(null,e,s,n,!r,u,c,null);null==i||i.addPendingData(d),d.url=t,this.Rh.push(d);const p=t=>{const e=d.width,r=h(t);if(r){if(o){const t=this.Ma(n);let i=this.Ia(s);const h=this.Ra(n);let a=!1;i===f.RGB&&(i=f.RGBA,a=!0),this.qo(f.TEXTURE_CUBE_MAP,d,!0),this.La(!1);const l=o(r);for(let s=0;s<l.length;s++){const r=e>>s;for(let e=0;e<6;e++){let o=l[s][e];a&&(o=ln(o,r,r,n)),f.texImage2D(e,s,h,r,r,0,i,t,o)}}this.qo(f.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(d,r,s,n,u);d.isReady=!0,null==i||i.removePendingData(d),d.onLoadedObservable.notifyObservers(d),d.onLoadedObservable.clear(),a&&a()}};return this.tn(t,(t=>{p(t)}),void 0,null==i?void 0:i.offlineProvider,!0,((t,e)=>{null==i||i.removePendingData(d),l&&t&&l(t.status+" "+t.statusText,e)})),d},Ei.prototype.createRawTexture2DArray=cn(!1),Ei.prototype.createRawTexture3D=cn(!0),Ei.prototype.updateRawTexture2DArray=un(!1),Ei.prototype.updateRawTexture3D=un(!0);class fn extends an{constructor(t,i,e,s,n,r=!0,h=!1,o=3,a=0,l,c){super(null,n,!r,h,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,l),this.format=s,this.Ls&&(this.Ls.po.textureFloatLinearFiltering||1!==a||(o=1),this.Ls.po.textureHalfFloatLinearFiltering||2!==a||(o=1),this.Lb=this.Ls.createRawTexture(t,i,e,s,r,h,o,null,a,null!=l?l:0,null!=c&&c),this.wrapU=an.CLAMP_ADDRESSMODE,this.wrapV=an.CLAMP_ADDRESSMODE)}update(t){this.qb().updateRawTexture(this.Lb,t,this.Lb.format,this.Lb.invertY,null,this.Lb.type,this.Lb.ur)}static CreateLuminanceTexture(t,i,e,s,n=!0,r=!1,h=3){return new fn(t,i,e,1,s,n,r,h)}static CreateLuminanceAlphaTexture(t,i,e,s,n=!0,r=!1,h=3){return new fn(t,i,e,2,s,n,r,h)}static CreateAlphaTexture(t,i,e,s,n=!0,r=!1,h=3){return new fn(t,i,e,0,s,n,r,h)}static CreateRGBTexture(t,i,e,s,n=!0,r=!1,h=3,o=0,a=0,l=!1){return new fn(t,i,e,4,s,n,r,h,o,a,l)}static CreateRGBATexture(t,i,e,s,n=!0,r=!1,h=3,o=0,a=0,l=!1){return new fn(t,i,e,5,s,n,r,h,o,a,l)}static CreateRGBAStorageTexture(t,i,e,s,n=!0,r=!1,h=3,o=0,a=!1){return new fn(t,i,e,5,s,n,r,h,o,1,a)}static CreateRTexture(t,i,e,s,n=!0,r=!1,h=an.TRILINEAR_SAMPLINGMODE,o=1){return new fn(t,i,e,6,s,n,r,h,o)}static CreateRStorageTexture(t,i,e,s,n=!0,r=!1,h=an.TRILINEAR_SAMPLINGMODE,o=1){return new fn(t,i,e,6,s,n,r,h,o,1)}}class dn{constructor(){this.k_=!1,this.G_=.05,this.z_=2e3,this.H_=2e3,this.targetAlpha=null,this.X_=!1,this.W_=null,this.Y_=-1/0,this.j_=0,this.K_=0}get name(){return"AutoRotation"}set zoomStopsAnimation(t){this.k_=t}get zoomStopsAnimation(){return this.k_}set idleRotationSpeed(t){this.G_=t}get idleRotationSpeed(){return this.G_}set idleRotationWaitTime(t){this.z_=t}get idleRotationWaitTime(){return this.z_}set idleRotationSpinupTime(t){this.H_=t}get idleRotationSpinupTime(){return this.H_}get rotationInProgress(){return Math.abs(this.j_)>0}init(){}attach(t){this.q_=t;const i=this.q_.getScene();this.Q_=i.onPrePointerObservable.add((t=>{t.type!==pe.POINTERDOWN?t.type===pe.POINTERUP&&(this.X_=!1):this.X_=!0})),this.Z_=t.onAfterCheckInputsObservable.add((()=>{if(this.J_())return;const t=bt.Now;let i=0;null!=this.W_&&(i=t-this.W_),this.W_=t,this.ty();const e=t-this.Y_-this.z_,s=Math.max(Math.min(e/this.H_,1),0);this.j_=this.G_*s,this.q_&&(this.q_.alpha-=this.j_*(i/1e3))}))}detach(){if(!this.q_)return;const t=this.q_.getScene();this.Q_&&t.onPrePointerObservable.remove(this.Q_),this.q_.onAfterCheckInputsObservable.remove(this.Z_),this.q_=null}resetLastInteractionTime(t){this.Y_=null!=t?t:bt.Now}J_(){return!(!this.q_||!this.targetAlpha)&&Math.abs(this.q_.alpha-this.targetAlpha)<u}iy(){return!!this.q_&&0!==this.q_.inertialRadiusOffset}ey(){if(!this.q_)return!1;let t=!1;return this.K_===this.q_.radius&&0!==this.q_.inertialRadiusOffset&&(t=!0),this.K_=this.q_.radius,this.k_?t:this.iy()}ty(){this.sy()&&!this.ey()&&(this.Y_=bt.Now)}sy(){return!!this.q_&&(0!==this.q_.inertialAlphaOffset||0!==this.q_.inertialBetaOffset||0!==this.q_.inertialRadiusOffset||0!==this.q_.inertialPanningX||0!==this.q_.inertialPanningY||this.X_)}}class pn{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this.ny=!1,this.hy=!1,this.oy=null,this.jE=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this.ny}set autoTransitionRange(t){if(this.ny===t)return;this.ny=t;const i=this.q_;i&&(t?this.ly=i.onMeshTargetChangedObservable.add((t=>{if(!t)return;t.computeWorldMatrix(!0);const i=t.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=.05*i,this.upperRadiusTransitionRange=.05*i})):this.ly&&i.onMeshTargetChangedObservable.remove(this.ly))}init(){}attach(t){this.q_=t,this.Z_=t.onAfterCheckInputsObservable.add((()=>{this.q_&&(this.uy(this.q_.lowerRadiusLimit)&&this.py(this.lowerRadiusTransitionRange),this.uy(this.q_.upperRadiusLimit)&&this.py(this.upperRadiusTransitionRange))}))}detach(){this.q_&&(this.Z_&&this.q_.onAfterCheckInputsObservable.remove(this.Z_),this.ly&&this.q_.onMeshTargetChangedObservable.remove(this.ly),this.q_=null)}uy(t){return!!this.q_&&(this.q_.radius===t&&!this.hy)}py(t){if(!this.q_)return;this.oy||(pn.EasingFunction.setEasingMode(pn.EasingMode),this.oy=vt.CreateAnimation("radius",vt.ANIMATIONTYPE_FLOAT,60,pn.EasingFunction)),this.my=this.q_.wheelPrecision,this.q_.wheelPrecision=1/0,this.q_.inertialRadiusOffset=0,this.stopAllAnimations(),this.hy=!0;const i=vt.TransitionTo("radius",this.q_.radius+t,this.q_,this.q_.getScene(),60,this.oy,this.transitionDuration,(()=>this.vy()));i&&this.jE.push(i)}vy(){this.hy=!1,this.q_&&(this.q_.wheelPrecision=this.my)}stopAllAnimations(){for(this.q_&&(this.q_.animations=[]);this.jE.length;)this.jE[0].onAnimationEnd=null,this.jE[0].stop(),this.jE.shift()}}pn.EasingFunction=new class extends Ke{constructor(t=1){super(),this.amplitude=t}easeInCore(t){const i=Math.max(0,this.amplitude);return Math.pow(t,3)-t*i*Math.sin(3.141592653589793*t)}}(.3),pn.EasingMode=Ke.EASINGMODE_EASEOUT;class mn{constructor(){this.onTargetFramingAnimationEndObservable=new h,this.uA=mn.FitFrustumSidesMode,this.gy=1,this.Sy=.5,this.Ey=.3,this.Ay=1500,this.Cy=1e3,this.k_=!1,this.wy=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this.X_=!1,this.Y_=-1/0,this.jE=new Array,this.Ty=!1}get name(){return"Framing"}set mode(t){this.uA=t}get mode(){return this.uA}set radiusScale(t){this.gy=t}get radiusScale(){return this.gy}set positionScale(t){this.Sy=t}get positionScale(){return this.Sy}set defaultElevation(t){this.Ey=t}get defaultElevation(){return this.Ey}set elevationReturnTime(t){this.Ay=t}get elevationReturnTime(){return this.Ay}set elevationReturnWaitTime(t){this.Cy=t}get elevationReturnWaitTime(){return this.Cy}set zoomStopsAnimation(t){this.k_=t}get zoomStopsAnimation(){return this.k_}set framingTime(t){this.wy=t}get framingTime(){return this.wy}init(){}attach(t){this.q_=t;const i=this.q_.getScene();mn.EasingFunction.setEasingMode(mn.EasingMode),this.Q_=i.onPrePointerObservable.add((t=>{t.type!==pe.POINTERDOWN?t.type===pe.POINTERUP&&(this.X_=!1):this.X_=!0})),this.ly=t.onMeshTargetChangedObservable.add((t=>{t&&this.zoomOnMesh(t,void 0,(()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()}))})),this.Z_=t.onAfterCheckInputsObservable.add((()=>{this.ty(),this.Ry()}))}detach(){if(!this.q_)return;const t=this.q_.getScene();this.Q_&&t.onPrePointerObservable.remove(this.Q_),this.Z_&&this.q_.onAfterCheckInputsObservable.remove(this.Z_),this.ly&&this.q_.onMeshTargetChangedObservable.remove(this.ly),this.q_=null}zoomOnMesh(t,i=!1,e=null){t.computeWorldMatrix(!0);const s=t.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(s.minimumWorld,s.maximumWorld,i,e)}zoomOnMeshHierarchy(t,i=!1,e=null){t.computeWorldMatrix(!0);const s=t.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(s.min,s.max,i,e)}zoomOnMeshesHierarchy(t,i=!1,e=null){const s=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new w(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let i=0;i<t.length;i++){const e=t[i].getHierarchyBoundingVectors(!0);w.CheckExtends(e.min,s,n),w.CheckExtends(e.max,s,n)}this.zoomOnBoundingInfo(s,n,i,e)}zoomOnBoundingInfo(t,i,e=!1,s=null){let n;if(!this.q_)return;const r=t.y,h=r+(i.y-r)*this.Sy,o=i.subtract(t).scale(.5);if(e)n=new w(0,h,0);else{const i=t.add(o);n=new w(i.x,h,i.z)}this.Iy||(this.Iy=vt.CreateAnimation("target",vt.ANIMATIONTYPE_VECTOR3,60,mn.EasingFunction)),this.Ty=!0;let a=vt.TransitionTo("target",n,this.q_,this.q_.getScene(),60,this.Iy,this.wy);a&&this.jE.push(a);let l=0;if(this.uA===mn.FitFrustumSidesMode){const e=this.My(t,i);this.autoCorrectCameraLimitsAndSensibility&&(this.q_.lowerRadiusLimit=o.length()+this.q_.minZ),l=e}else this.uA===mn.IgnoreBoundsSizeMode&&(l=this.My(t,i),this.autoCorrectCameraLimitsAndSensibility&&null===this.q_.lowerRadiusLimit&&(this.q_.lowerRadiusLimit=this.q_.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const e=i.subtract(t).length();this.q_.panningSensibility=5e3/e,this.q_.wheelPrecision=100/l}this.by||(this.by=vt.CreateAnimation("radius",vt.ANIMATIONTYPE_FLOAT,60,mn.EasingFunction)),a=vt.TransitionTo("radius",l,this.q_,this.q_.getScene(),60,this.by,this.wy,(()=>{this.stopAllAnimations(),s&&s(),this.q_&&this.q_.useInputToRestoreState&&this.q_.storeState()})),a&&this.jE.push(a)}My(t,i){const e=i.subtract(t).length(),s=this._y(),n=.5*e*this.gy,r=n*Math.sqrt(1+1/(s.x*s.x)),h=n*Math.sqrt(1+1/(s.y*s.y));let o=Math.max(r,h);const a=this.q_;return a?(a.lowerRadiusLimit&&this.uA===mn.IgnoreBoundsSizeMode&&(o=o<a.lowerRadiusLimit?a.lowerRadiusLimit:o),a.upperRadiusLimit&&(o=o>a.upperRadiusLimit?a.upperRadiusLimit:o),o):0}Ry(){if(this.Ay<0)return;const t=bt.Now-this.Y_,i=.5*Math.PI-this.Ey,e=.5*Math.PI;if(this.q_&&!this.Ty&&this.q_.beta>e&&t>=this.Cy){this.Ty=!0,this.stopAllAnimations(),this.Ny||(this.Ny=vt.CreateAnimation("beta",vt.ANIMATIONTYPE_FLOAT,60,mn.EasingFunction));const t=vt.TransitionTo("beta",i,this.q_,this.q_.getScene(),60,this.Ny,this.Ay,(()=>{this.vy(),this.stopAllAnimations()}));t&&this.jE.push(t)}}_y(){const t=this.q_;if(!t)return C.Zero();const i=t.getScene().getEngine().getAspectRatio(t),e=Math.tan(t.fov/2);return new C(e*i,e)}vy(){this.Ty=!1}ty(){this.isUserIsMoving&&(this.Y_=bt.Now,this.stopAllAnimations(),this.vy())}stopAllAnimations(){for(this.q_&&(this.q_.animations=[]);this.jE.length;)this.jE[0]&&(this.jE[0].onAnimationEnd=null,this.jE[0].stop()),this.jE.shift()}get isUserIsMoving(){return!!this.q_&&(0!==this.q_.inertialAlphaOffset||0!==this.q_.inertialBetaOffset||0!==this.q_.inertialRadiusOffset||0!==this.q_.inertialPanningX||0!==this.q_.inertialPanningY||this.X_)}}mn.EasingFunction=new class extends Ke{constructor(t=2){super(),this.exponent=t}easeInCore(t){return this.exponent<=0?t:(Math.exp(this.exponent*t)-1)/(Math.exp(this.exponent)-1)}},mn.EasingMode=Ke.EASINGMODE_EASEINOUT,mn.IgnoreBoundsSizeMode=0,mn.FitFrustumSidesMode=1;class vn{constructor(t,i,e=Number.MAX_VALUE){this.origin=t,this.direction=i,this.length=e}clone(){return new vn(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(t,i,e=0){const s=vn.eC[0].copyFromFloats(t.x-e,t.y-e,t.z-e),n=vn.eC[1].copyFromFloats(i.x+e,i.y+e,i.z+e);let r,h,o,a,l=0,c=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<s.x||this.origin.x>n.x)return!1}else if(r=1/this.direction.x,h=(s.x-this.origin.x)*r,o=(n.x-this.origin.x)*r,o===-1/0&&(o=1/0),h>o&&(a=h,h=o,o=a),l=Math.max(h,l),c=Math.min(o,c),l>c)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<s.y||this.origin.y>n.y)return!1}else if(r=1/this.direction.y,h=(s.y-this.origin.y)*r,o=(n.y-this.origin.y)*r,o===-1/0&&(o=1/0),h>o&&(a=h,h=o,o=a),l=Math.max(h,l),c=Math.min(o,c),l>c)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<s.z||this.origin.z>n.z)return!1}else if(r=1/this.direction.z,h=(s.z-this.origin.z)*r,o=(n.z-this.origin.z)*r,o===-1/0&&(o=1/0),h>o&&(a=h,h=o,o=a),l=Math.max(h,l),c=Math.min(o,c),l>c)return!1;return!0}intersectsBox(t,i=0){return this.intersectsBoxMinMax(t.minimum,t.maximum,i)}intersectsSphere(t,i=0){const e=t.center.x-this.origin.x,s=t.center.y-this.origin.y,n=t.center.z-this.origin.z,r=e*e+s*s+n*n,h=t.radius+i,o=h*h;if(r<=o)return!0;const a=e*this.direction.x+s*this.direction.y+n*this.direction.z;if(a<0)return!1;return r-a*a<=o}intersectsTriangle(t,i,e){const s=vn.eC[0],n=vn.eC[1],r=vn.eC[2],h=vn.eC[3],o=vn.eC[4];i.subtractToRef(t,s),e.subtractToRef(t,n),w.CrossToRef(this.direction,n,r);const a=w.Dot(s,r);if(0===a)return null;const l=1/a;this.origin.subtractToRef(t,h);const c=w.Dot(h,r)*l;if(c<0||c>1)return null;w.CrossToRef(h,s,o);const u=w.Dot(this.direction,o)*l;if(u<0||c+u>1)return null;const f=w.Dot(n,o)*l;return f>this.length?null:new as(1-c-u,c,f)}intersectsPlane(t){let i;const e=w.Dot(t.normal,this.direction);if(Math.abs(e)<9.99999997475243e-7)return null;{const s=w.Dot(t.normal,this.origin);return i=(-t.d-s)/e,i<0?i<-9.99999997475243e-7?null:0:i}}intersectsAxis(t,i=0){switch(t){case"y":{const t=(this.origin.y-i)/this.direction.y;return t>0?null:new w(this.origin.x+this.direction.x*-t,i,this.origin.z+this.direction.z*-t)}case"x":{const t=(this.origin.x-i)/this.direction.x;return t>0?null:new w(i,this.origin.y+this.direction.y*-t,this.origin.z+this.direction.z*-t)}case"z":{const t=(this.origin.z-i)/this.direction.z;return t>0?null:new w(this.origin.x+this.direction.x*-t,this.origin.y+this.direction.y*-t,i)}default:return null}}intersectsMesh(t,i){const e=M.Matrix[0];return t.getWorldMatrix().invertToRef(e),this.Py?vn.TransformToRef(this,e,this.Py):this.Py=vn.Transform(this,e),t.intersects(this.Py,i)}intersectsMeshes(t,i,e){e?e.length=0:e=[];for(let s=0;s<t.length;s++){const n=this.intersectsMesh(t[s],i);n.hit&&e.push(n)}return e.sort(this.Dy),e}Dy(t,i){return t.distance<i.distance?-1:t.distance>i.distance?1:0}intersectionSegment(t,i,e){const s=this.origin,n=M.Vector3[0],r=M.Vector3[1],h=M.Vector3[2],o=M.Vector3[3];i.subtractToRef(t,n),this.direction.scaleToRef(vn.Ly,h),s.addToRef(h,r),t.subtractToRef(s,o);const a=w.Dot(n,n),l=w.Dot(n,h),c=w.Dot(h,h),u=w.Dot(n,o),f=w.Dot(h,o),d=a*c-l*l;let p,m,v=d,g=d;d<vn.Oy?(p=0,v=1,m=f,g=c):(p=l*f-c*u,m=a*f-l*u,p<0?(p=0,m=f,g=c):p>v&&(p=v,m=f+l,g=c)),m<0?(m=0,-u<0?p=0:-u>a?p=v:(p=-u,v=a)):m>g&&(m=g,-u+l<0?p=0:-u+l>a?p=v:(p=-u+l,v=a));const S=Math.abs(p)<vn.Oy?0:p/v,E=Math.abs(m)<vn.Oy?0:m/g,A=M.Vector3[4];h.scaleToRef(E,A);const C=M.Vector3[5];n.scaleToRef(S,C),C.addInPlace(o);const x=M.Vector3[6];C.subtractToRef(A,x);return E>0&&E<=this.length&&x.lengthSquared()<e*e?C.length():-1}update(t,i,e,s,n,r,h,o=!1){if(o){vn.Fy||(vn.Fy=vn.Zero()),vn.Fy.unprojectRayToRef(t,i,e,s,R.IdentityReadOnly,r,h);const o=M.Matrix[0];n.invertToRef(o),vn.TransformToRef(vn.Fy,o,this)}else this.unprojectRayToRef(t,i,e,s,n,r,h);return this}static Zero(){return new vn(w.Zero(),w.Zero())}static CreateNew(t,i,e,s,n,r,h){return vn.Zero().update(t,i,e,s,n,r,h)}static CreateNewFromTo(t,i,e=R.IdentityReadOnly){const s=i.subtract(t),n=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return s.normalize(),vn.Transform(new vn(t,s,n),e)}static Transform(t,i){const e=new vn(new w(0,0,0),new w(0,0,0));return vn.TransformToRef(t,i,e),e}static TransformToRef(t,i,e){w.TransformCoordinatesToRef(t.origin,i,e.origin),w.TransformNormalToRef(t.direction,i,e.direction),e.length=t.length;const s=e.direction,n=s.length();if(0!==n&&1!==n){const t=1/n;s.x*=t,s.y*=t,s.z*=t,e.length*=n}}unprojectRayToRef(t,i,e,s,n,r,h){var o;const a=M.Matrix[0];n.multiplyToRef(r,a),a.multiplyToRef(h,a),a.invert();const l=M.Vector3[0];l.x=t/e*2-1,l.y=-(i/s*2-1),l.z=(null===(o=E.LastCreatedEngine)||void 0===o?void 0:o.isNDCHalfZRange)?0:-1;const c=M.Vector3[1].copyFromFloats(l.x,l.y,1-1e-8),u=M.Vector3[2],f=M.Vector3[3];w.J(l,a,u),w.J(c,a,f),this.origin.copyFrom(u),f.subtractToRef(u,this.direction),this.direction.normalize()}}vn.eC=f.BuildArray(6,w.Zero),vn.Fy=vn.Zero(),vn.Oy=1e-8,vn.Ly=1e9,ke.prototype.createPickingRay=function(t,i,e,s,n=!1){const r=vn.Zero();return this.createPickingRayToRef(t,i,e,r,s,n),r},ke.prototype.createPickingRayToRef=function(t,i,e,s,n,r=!1,h=!1){const o=this.getEngine();if(!n){if(!this.activeCamera)return this;n=this.activeCamera}const a=n.viewport.toGlobal(o.getRenderWidth(),o.getRenderHeight());return t=t/o.getHardwareScalingLevel()-a.x,i=i/o.getHardwareScalingLevel()-(o.getRenderHeight()-a.y-a.height),s.update(t,i,a.width,a.height,e||R.IdentityReadOnly,r?R.IdentityReadOnly:n.getViewMatrix(),n.getProjectionMatrix(),h),this},ke.prototype.createPickingRayInCameraSpace=function(t,i,e){const s=vn.Zero();return this.createPickingRayInCameraSpaceToRef(t,i,s,e),s},ke.prototype.createPickingRayInCameraSpaceToRef=function(t,i,e,s){if(!oe)return this;const n=this.getEngine();if(!s){if(!this.activeCamera)throw new Error("Active camera not set");s=this.activeCamera}const r=s.viewport.toGlobal(n.getRenderWidth(),n.getRenderHeight()),h=R.Identity();return t=t/n.getHardwareScalingLevel()-r.x,i=i/n.getHardwareScalingLevel()-(n.getRenderHeight()-r.y-r.height),e.update(t,i,r.width,r.height,h,h,s.getProjectionMatrix()),this},ke.prototype.By=function(t,i,e,s,n,r,h,o){const a=i(s,e.enableDistantPicking),l=e.intersects(a,n,h,r,s,o);return l&&l.hit?!n&&null!=t&&l.distance>=t.distance?null:l:null},ke.prototype.Uy=function(t,i,e,s,n){let r=null;for(let h=0;h<this.meshes.length;h++){const o=this.meshes[h];if(i){if(!i(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;const a=o.getWorldMatrix();if(o.hasThinInstances&&o.thinInstanceEnablePicking){const i=this.By(r,t,o,a,!0,!0,n);if(i){if(s)return i;const h=M.Matrix[1],l=o.thinInstanceGetWorldMatrices();for(let i=0;i<l.length;i++){l[i].multiplyToRef(a,h);const c=this.By(r,t,o,h,e,s,n,!0);if(c&&(r=c,r.thinInstanceIndex=i,e))return r}}}else{const i=this.By(r,t,o,a,e,s,n);if(i&&(r=i,e))return r}}return r||new oe},ke.prototype.Vy=function(t,i,e){if(!oe)return null;const s=new Array;for(let n=0;n<this.meshes.length;n++){const r=this.meshes[n];if(i){if(!i(r))continue}else if(!r.isEnabled()||!r.isVisible||!r.isPickable)continue;const h=r.getWorldMatrix();if(r.hasThinInstances&&r.thinInstanceEnablePicking){if(this.By(null,t,r,h,!0,!0,e)){const i=M.Matrix[1],n=r.thinInstanceGetWorldMatrices();for(let o=0;o<n.length;o++){n[o].multiplyToRef(h,i);const a=this.By(null,t,r,i,!1,!1,e,!0);a&&(a.thinInstanceIndex=o,s.push(a))}}}else{const i=this.By(null,t,r,h,!1,!1,e);i&&s.push(i)}}return s},ke.prototype.pickWithBoundingInfo=function(t,i,e,s,n){if(!oe)return null;const r=this.Uy((e=>(this.ky||(this.ky=vn.Zero()),this.createPickingRayToRef(t,i,e,this.ky,n||null),this.ky)),e,s,!0);return r&&(r.ray=this.createPickingRay(t,i,R.Identity(),n||null)),r},Object.defineProperty(ke.prototype,"im",{get:()=>!0,enumerable:!1,configurable:!1}),ke.prototype.pick=function(t,i,e,s,n,r,h=!1){const o=this.Uy(((e,s)=>(this.ky||(this.ky=vn.Zero()),this.createPickingRayToRef(t,i,e,this.ky,n||null,!1,s),this.ky)),e,s,!1,r);return o&&(o.ray=this.createPickingRay(t,i,R.Identity(),n||null)),o},ke.prototype.pickWithRay=function(t,i,e,s){const n=this.Uy((i=>(this.Gy||(this.Gy=R.Identity()),i.invertToRef(this.Gy),this.zy||(this.zy=vn.Zero()),vn.TransformToRef(t,this.Gy,this.zy),this.zy)),i,e,!1,s);return n&&(n.ray=t),n},ke.prototype.multiPick=function(t,i,e,s,n){return this.Vy((e=>this.createPickingRay(t,i,e,s||null)),e,n)},ke.prototype.multiPickWithRay=function(t,i,e){return this.Vy((i=>(this.Gy||(this.Gy=R.Identity()),i.invertToRef(this.Gy),this.zy||(this.zy=vn.Zero()),vn.TransformToRef(t,this.Gy,this.zy),this.zy)),i,e)},hs.prototype.getForwardRay=function(t=100,i,e){return this.getForwardRayToRef(new vn(w.Zero(),w.Zero(),t),t,i,e)},hs.prototype.getForwardRayToRef=function(t,i=100,e,s){return e||(e=this.getWorldMatrix()),t.length=i,s?t.origin.copyFrom(s):t.origin.copyFrom(this.position),M.Vector3[2].set(0,0,this.Kt.useRightHandedSystem?-1:1),w.TransformNormalToRef(M.Vector3[2],e,M.Vector3[3]),w.NormalizeToRef(M.Vector3[3],t.direction),t};class gn{static Hy(t){t&&0===gn.Xy&&(t.getPivotPointToRef(gn.Wy),gn.$y=t.Gx,gn.Wy.equalsToFloats(0,0,0)||(t.setPivotMatrix(R.IdentityReadOnly),gn.Wy.subtractToRef(t.getPivotPoint(),gn.Yy),gn.jy.copyFromFloats(1,1,1),gn.jy.subtractInPlace(t.scaling),gn.jy.multiplyInPlace(gn.Yy),t.position.addInPlace(gn.jy))),gn.Xy++}static Ky(t){t&&!gn.Wy.equalsToFloats(0,0,0)&&1===gn.Xy&&(t.setPivotPoint(gn.Wy),t.Gx=gn.$y,gn.jy.copyFromFloats(1,1,1),gn.jy.subtractInPlace(t.scaling),gn.jy.multiplyInPlace(gn.Yy),t.position.subtractInPlace(gn.jy)),this.Xy--}}function Sn(t){const i=[],e=[],s=[],n=[],r=t.width||t.size||1,h=t.height||t.size||1,o=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE,a=r/2,l=h/2;e.push(-a,-l,0),s.push(0,0,-1),n.push(0,As.UseOpenGLOrientationForUV?1:0),e.push(a,-l,0),s.push(0,0,-1),n.push(1,As.UseOpenGLOrientationForUV?1:0),e.push(a,l,0),s.push(0,0,-1),n.push(1,As.UseOpenGLOrientationForUV?0:1),e.push(-a,l,0),s.push(0,0,-1),n.push(0,As.UseOpenGLOrientationForUV?0:1),i.push(0),i.push(1),i.push(2),i.push(0),i.push(2),i.push(3),os.JA(o,e,i,s,n,t.frontUVs,t.backUVs);const c=new os;return c.indices=i,c.positions=e,c.normals=s,c.uvs=n,c}function En(t,i={},e=null){const s=new Ys(t,e);i.sideOrientation=Ys.OI(i.sideOrientation),s.yI=i.sideOrientation;return Sn(i).applyToMesh(s,i.updatable),i.sourcePlane&&(s.translate(i.sourcePlane.normal,-i.sourcePlane.d),s.setDirection(i.sourcePlane.normal.scale(-1))),s}gn.Xy=0,gn.Wy=new w,gn.Yy=new w,gn.jy=new w,gn.$y=!1;os.CreatePlane=Sn,Ys.CreatePlane=(t,i,e,s,n)=>En(t,{size:i,width:i,height:i,sideOrientation:n,updatable:s},e);class An{constructor(t){this.qy=-1.1,this.Qy=-1,this.maxDragAngle=0,this.dragButtons=[0,1,2],this.Zy=!1,this.currentDraggingPointerId=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this.Jy=!1,this.tN=!1,this.onDragObservable=new h,this.onDragStartObservable=new h,this.onDragEndObservable=new h,this.onEnabledObservable=new h,this.moveAttached=!0,this.ih=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=t=>!0,this.iN=new w(0,0,0),this.eN=new w(0,0,0),this.sN=new w(0,0,0),this.nN=new w(0,0,0),this.rN=!1,this.hN=new vn(new w,new w),this.oN={},this.aN=new w,this.lN=new w(0,0,0),this.cN=new w(0,0,0),this.uN=new w(0,0,0),this.fN=new w(0,0,0),this.wb=t||{};let i=0;if(this.wb.dragAxis&&i++,this.wb.dragPlaneNormal&&i++,i>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(t){this.currentDraggingPointerId=t}set enabled(t){t!=this.ih&&this.onEnabledObservable.notifyObservers(t),this.ih=t}get enabled(){return this.ih}get options(){return this.wb}set options(t){this.wb=t}get name(){return"PointerDrag"}init(){}attach(t,i){this.Kt=t.getScene(),t.isNearGrabbable=!0,this.attachedNode=t,An.dN||(this.Jy?An.dN=this.Kt:(An.dN=new ke(this.Kt.getEngine(),{virtual:!0}),An.dN.detachControl(),this.Kt.onDisposeObservable.addOnce((()=>{An.dN.dispose(),An.dN=null})))),this.pN=En("pointerDragPlane",{size:this.Jy?1:1e4,updatable:!1,sideOrientation:Ys.DOUBLESIDE},An.dN),this.lastDragPosition=new w(0,0,0);const e=i||(t=>this.attachedNode==t||t.isDescendantOf(this.attachedNode));this.mN=this.Kt.onPointerObservable.add((t=>{if(this.enabled){if(t.type==pe.POINTERDOWN)this.startAndReleaseDragOnPointerEvents&&!this.dragging&&t.pickInfo&&t.pickInfo.hit&&t.pickInfo.pickedMesh&&t.pickInfo.pickedPoint&&t.pickInfo.ray&&e(t.pickInfo.pickedMesh)&&-1===this.Qy&&-1!==this.dragButtons.indexOf(t.event.button)&&(this.Qy=t.event.button,this.vN=t,this.gN(t.event.pointerId,t.pickInfo.ray,t.pickInfo.pickedPoint));else if(t.type==pe.POINTERUP)this.startAndReleaseDragOnPointerEvents&&this.currentDraggingPointerId==t.event.pointerId&&this.Qy===t.event.button&&this.releaseDrag();else if(t.type==pe.POINTERMOVE){const i=t.event.pointerId;if(this.currentDraggingPointerId===An.SN&&i!==An.SN){const e=t.event;("mouse"===e.pointerType||!this.Kt.getEngine().hostInformation.isMobile&&e instanceof MouseEvent)&&(this.oN[this.currentDraggingPointerId]&&(this.oN[i]=this.oN[this.currentDraggingPointerId],delete this.oN[this.currentDraggingPointerId]),this.currentDraggingPointerId=i)}this.oN[i]||(this.oN[i]=new vn(new w,new w)),t.pickInfo&&t.pickInfo.ray&&(this.oN[i].origin.copyFrom(t.pickInfo.ray.origin),this.oN[i].direction.copyFrom(t.pickInfo.ray.direction),this.currentDraggingPointerId==i&&this.dragging&&this.EN(t.pickInfo.ray))}}else this.rN&&this.releaseDrag()})),this.AN=this.Kt.onBeforeRenderObservable.add((()=>{if(this.tN&&this.moveAttached){let t=!1;gn.Hy(this.attachedNode),this.nN.subtractToRef(this.attachedNode.absolutePosition,this.iN),this.iN.scaleInPlace(this.dragDeltaRatio),this.attachedNode.getAbsolutePosition().addToRef(this.iN,this.iN),this.validateDrag(this.iN)&&(this.attachedNode.setAbsolutePosition(this.iN),t=!0),gn.Ky(this.attachedNode),t&&this.attachedNode.computeWorldMatrix()}}))}releaseDrag(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerId,pointerInfo:this.vN})),this.currentDraggingPointerId=-1,this.Qy=-1,this.vN=null,this.tN=!1,this.detachCameraControls&&this.rN&&this.Kt.activeCamera&&!this.Kt.activeCamera.leftCamera){if("ArcRotateCamera"===this.Kt.activeCamera.getClassName()){const t=this.Kt.activeCamera;t.attachControl(!t.inputs||t.inputs.noPreventDefault,t.CN,t.wN)}else this.Kt.activeCamera.attachControl(!this.Kt.activeCamera.inputs||this.Kt.activeCamera.inputs.noPreventDefault);this.rN=!1}}startDrag(t=An.SN,i,e){this.gN(t,i,e);let s=this.oN[t];t===An.SN&&(s=this.oN[Object.keys(this.oN)[0]]),s&&this.EN(s)}gN(t,i,e){if(!this.Kt.activeCamera||this.dragging||!this.attachedNode)return;gn.Hy(this.attachedNode),i?(this.hN.direction.copyFrom(i.direction),this.hN.origin.copyFrom(i.origin)):(this.hN.origin.copyFrom(this.Kt.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this.iN),this.iN.subtractToRef(this.Kt.activeCamera.position,this.hN.direction)),this.xN(this.hN,e||this.iN);const s=this.TN(this.hN);s?(this.dragging=!0,this.currentDraggingPointerId=t,this.lastDragPosition.copyFrom(s),this.onDragStartObservable.notifyObservers({dragPlanePoint:s,pointerId:this.currentDraggingPointerId,pointerInfo:this.vN}),this.nN.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this.Kt.activeCamera&&this.Kt.activeCamera.inputs&&!this.Kt.activeCamera.leftCamera&&(this.Kt.activeCamera.inputs.attachedToElement?(this.Kt.activeCamera.detachControl(),this.rN=!0):this.rN=!1)):this.releaseDrag(),gn.Ky(this.attachedNode)}EN(t){this.tN=!0;const i=this.TN(t);if(i){gn.Hy(this.attachedNode),this.updateDragPlane&&this.xN(t,i);let e=0;this.wb.dragAxis?(this.useObjectOrientationForDragging?w.TransformCoordinatesToRef(this.wb.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this.sN):this.sN.copyFrom(this.wb.dragAxis),i.subtractToRef(this.lastDragPosition,this.iN),e=w.Dot(this.iN,this.sN),this.sN.scaleToRef(e,this.aN)):(e=this.aN.length(),i.subtractToRef(this.lastDragPosition,this.aN)),this.nN.addInPlace(this.aN),this.onDragObservable.notifyObservers({dragDistance:e,delta:this.aN,dragPlanePoint:i,dragPlaneNormal:this.pN.forward,pointerId:this.currentDraggingPointerId,pointerInfo:this.vN}),this.lastDragPosition.copyFrom(i),gn.Ky(this.attachedNode)}}TN(t){if(!t)return null;let i=Math.acos(w.Dot(this.pN.forward,t.direction));if(i>Math.PI/2&&(i=Math.PI-i),this.maxDragAngle>0&&i>this.maxDragAngle){if(this.Zy){this.iN.copyFrom(t.direction),this.attachedNode.absolutePosition.subtractToRef(t.origin,this.eN),this.eN.normalize(),this.eN.scaleInPlace(this.qy*w.Dot(this.eN,this.iN)),this.iN.addInPlace(this.eN);const i=w.Dot(this.pN.forward,this.iN);return this.pN.forward.scaleToRef(-i,this.eN),this.eN.addInPlace(this.iN),this.eN.addInPlace(this.attachedNode.absolutePosition),this.eN}return null}const e=An.dN.pickWithRay(t,(t=>t==this.pN));return e&&e.hit&&e.pickedMesh&&e.pickedPoint?e.pickedPoint:null}xN(t,i){this.lN.copyFrom(i),this.wb.dragAxis?(this.useObjectOrientationForDragging?w.TransformCoordinatesToRef(this.wb.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this.uN):this.uN.copyFrom(this.wb.dragAxis),t.origin.subtractToRef(this.lN,this.cN),this.cN.normalize(),Math.abs(w.Dot(this.uN,this.cN))>.999?Math.abs(w.Dot(w.UpReadOnly,this.cN))>.999?this.fN.copyFrom(w.Right()):this.fN.copyFrom(w.UpReadOnly):(w.CrossToRef(this.uN,this.cN,this.fN),w.CrossToRef(this.uN,this.fN,this.fN),this.fN.normalize()),this.pN.position.copyFrom(this.lN),this.lN.addToRef(this.fN,this.fN),this.pN.lookAt(this.fN)):this.wb.dragPlaneNormal?(this.useObjectOrientationForDragging?w.TransformCoordinatesToRef(this.wb.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this.uN):this.uN.copyFrom(this.wb.dragPlaneNormal),this.pN.position.copyFrom(this.lN),this.lN.addToRef(this.uN,this.fN),this.pN.lookAt(this.fN)):(this.pN.position.copyFrom(this.lN),this.pN.lookAt(t.origin)),this.pN.position.copyFrom(this.attachedNode.getAbsolutePosition()),this.pN.computeWorldMatrix(!0)}detach(){this.oN={},this.attachedNode&&(this.attachedNode.isNearGrabbable=!1),this.mN&&this.Kt.onPointerObservable.remove(this.mN),this.AN&&this.Kt.onBeforeRenderObservable.remove(this.AN),this.pN&&this.pN.dispose(),this.releaseDrag()}}An.SN=-2;class Cn{}Cn.ANCHOR_SYSTEM="xr-anchor-system",Cn.BACKGROUND_REMOVER="xr-background-remover",Cn.HIT_TEST="xr-hit-test",Cn.MESH_DETECTION="xr-mesh-detection",Cn.PHYSICS_CONTROLLERS="xr-physics-controller",Cn.PLANE_DETECTION="xr-plane-detection",Cn.POINTER_SELECTION="xr-controller-pointer-selection",Cn.TELEPORTATION="xr-controller-teleportation",Cn.FEATURE_POINTS="xr-feature-points",Cn.HAND_TRACKING="xr-hand-tracking",Cn.IMAGE_TRACKING="xr-image-tracking",Cn.NEAR_INTERACTION="xr-near-interaction",Cn.DOM_OVERLAY="xr-dom-overlay",Cn.MOVEMENT="xr-controller-movement",Cn.LIGHT_ESTIMATION="xr-light-estimation",Cn.EYE_TRACKING="xr-eye-tracking",Cn.WALKING_LOCOMOTION="xr-walking-locomotion",Cn.LAYERS="xr-layers";class wn{constructor(t){this.RN=t,this.hs={},this.RN.onXRSessionInit.add((()=>{this.getEnabledFeatures().forEach((t=>{const i=this.hs[t];!i.enabled||i.featureImplementation.attached||i.featureImplementation.disableAutoAttach||this.attachFeature(t)}))})),this.RN.onXRSessionEnded.add((()=>{this.getEnabledFeatures().forEach((t=>{const i=this.hs[t];i.enabled&&i.featureImplementation.attached&&this.detachFeature(t)}))}))}static AddWebXRFeature(t,i,e=1,s=!1){this.IN[t]=this.IN[t]||{latest:e},e>this.IN[t].latest&&(this.IN[t].latest=e),s&&(this.IN[t].stable=e),this.IN[t][e]=i}static ConstructFeature(t,i=1,e,s){const n=this.IN[t][i];if(!n)throw new Error("feature not found");return n(e,s)}static GetAvailableFeatures(){return Object.keys(this.IN)}static GetAvailableVersions(t){return Object.keys(this.IN[t])}static GetLatestVersionOfFeature(t){return this.IN[t]&&this.IN[t].latest||-1}static GetStableVersionOfFeature(t){return this.IN[t]&&this.IN[t].stable||-1}attachFeature(t){const i=this.hs[t];i&&i.enabled&&!i.featureImplementation.attached&&i.featureImplementation.attach()}detachFeature(t){const i=this.hs[t];i&&i.featureImplementation.attached&&i.featureImplementation.detach()}disableFeature(t){const i="string"==typeof t?t:t.Name,e=this.hs[i];return!(!e||!e.enabled)&&(e.enabled=!1,this.detachFeature(i),e.featureImplementation.dispose(),delete this.hs[i],!0)}dispose(){this.getEnabledFeatures().forEach((t=>{this.disableFeature(t)}))}enableFeature(t,i="latest",e={},s=!0,n=!0){const r="string"==typeof t?t:t.Name;let h=0;if("string"==typeof i){if(!i)throw new Error(`Error in provided version - ${r} (${i})`);if(h="stable"===i?wn.GetStableVersionOfFeature(r):"latest"===i?wn.GetLatestVersionOfFeature(r):+i,-1===h||isNaN(h))throw new Error(`feature not found - ${r} (${i})`)}else h=i;const o=wn.MN[r];if(void 0!==o&&-1!==this.getEnabledFeatures().indexOf(o))throw new Error(`Feature ${r} cannot be enabled while ${o} is enabled.`);const a=this.hs[r],l=wn.ConstructFeature(r,h,this.RN,e);if(!l)throw new Error(`feature not found - ${r}`);a&&this.disableFeature(r);const c=l();if(c.dependsOn){const t=c.dependsOn.every((t=>!!this.hs[t]));if(!t)throw new Error(`Dependant features missing. Make sure the following features are enabled - ${c.dependsOn.join(", ")}`)}if(c.isCompatible())return this.hs[r]={featureImplementation:c,enabled:!0,version:h,required:n},s?this.RN.session&&!this.hs[r].featureImplementation.attached&&this.attachFeature(r):this.hs[r].featureImplementation.disableAutoAttach=!0,this.hs[r].featureImplementation;if(n)throw new Error("required feature not compatible");return ki.Warn(`Feature ${r} not compatible with the current environment/browser and was not enabled.`),c}getEnabledFeature(t){return this.hs[t]&&this.hs[t].featureImplementation}getEnabledFeatures(){return Object.keys(this.hs)}async bN(t){const i=this.getEnabledFeatures();for(const e of i){const i=this.hs[e],s=i.featureImplementation.xrNativeFeatureName;if(s&&(i.required?(t.requiredFeatures=t.requiredFeatures||[],-1===t.requiredFeatures.indexOf(s)&&t.requiredFeatures.push(s)):(t.optionalFeatures=t.optionalFeatures||[],-1===t.optionalFeatures.indexOf(s)&&t.optionalFeatures.push(s))),i.featureImplementation.getXRSessionInitExtension){const e=await i.featureImplementation.getXRSessionInitExtension();t={...t,...e}}}return t}}wn.IN={},wn.MN={[Cn.TELEPORTATION]:Cn.MOVEMENT,[Cn.MOVEMENT]:Cn.TELEPORTATION};class xn{constructor(t){this.RN=t,this._N=!1,this.yN=[],this.isDisposed=!1,this.disableAutoAttach=!1,this.xrNativeFeatureName=""}get attached(){return this._N}attach(t){if(this.isDisposed)return!1;if(t)this.attached&&this.detach();else if(this.attached)return!1;return this._N=!0,this.NN(this.RN.onXRFrameObservable,(t=>this.PN(t))),!0}detach(){return this._N?(this._N=!1,this.yN.forEach((t=>{t.observable.remove(t.observer)})),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0}isCompatible(){return!0}NN(t,i){this.yN.push({observable:t,observer:t.add(i)})}}class Tn{constructor(t,i){this.type=t,this.jointData=i,i.nativeParams=i.nativeParams||{}}get physicsJoint(){return this.DN}set physicsJoint(t){this.DN,this.DN=t}set physicsPlugin(t){this.LN=t}executeNativeFunction(t){t(this.LN.world,this.DN)}}Tn.DistanceJoint=0,Tn.HingeJoint=1,Tn.BallAndSocketJoint=2,Tn.WheelJoint=3,Tn.SliderJoint=4,Tn.PrismaticJoint=5,Tn.UniversalJoint=6,Tn.Hinge2Joint=Tn.WheelJoint,Tn.PointToPointJoint=8,Tn.SpringJoint=9,Tn.LockJoint=10;Ys.cM=function(t,i,e){return new Rn(i,e.physicsImpostor,{mass:e.physicsMass,friction:e.physicsFriction,restitution:e.physicsRestitution},t)};class Rn{constructor(t,i,e={mass:0},s){this.object=t,this.type=i,this.wb=e,this.Kt=s,this.ON={},this.FN=!1,this.BN=new Array,this.UN=new Array,this.VN=[],this.kN=w.Zero(),this.li=!1,this.soft=!1,this.segments=0,this.GN=new T,this.zN=new T,this.beforeStep=()=>{this.HN&&(this.object.translate(this.kN,-1),this.XN&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this.XN,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this.GN.multiplyToRef(this.object.rotationQuaternion,this.GN)):this.GN.copyFrom(this.object.rotationQuaternion||new T),this.wb.disableBidirectionalTransformation||this.object.rotationQuaternion&&this.HN.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this.GN),this.BN.forEach((t=>{t(this)})))},this.afterStep=()=>{this.HN&&(this.UN.forEach((t=>{t(this)})),this.HN.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this.GN.conjugateInPlace(),this.GN.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this.WN?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this.WN,this.object.rotationQuaternion),this.kN.applyRotationQuaternionToRef(this.WN,Rn.uE[0]),this.object.translate(Rn.uE[0],1)):this.object.translate(this.kN,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=t=>{if(!this.VN.length&&!this.onCollideEvent)return;if(!this.HN)return;const i=this.HN.getImpostorWithPhysicsBody(t.body);i&&(this.onCollideEvent&&this.onCollideEvent(this,i),this.VN.filter((t=>-1!==t.otherImpostors.indexOf(i))).forEach((e=>{e.callback(this,i,t.point,t.distance,t.impulse,t.normal)})))},this.object?(this.object.parent&&0!==e.mass&&F.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this.Kt&&t.getScene&&(this.Kt=t.getScene()),this.Kt&&(this.type>100&&(this.soft=!0),this.HN=this.Kt.getPhysicsEngine(),this.HN?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=T.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new T),this.wb.mass=void 0===e.mass?0:e.mass,this.wb.friction=void 0===e.friction?.2:e.friction,this.wb.restitution=void 0===e.restitution?.2:e.restitution,this.soft&&(this.wb.mass=this.wb.mass>0?this.wb.mass:1,this.wb.pressure=void 0===e.pressure?200:e.pressure,this.wb.stiffness=void 0===e.stiffness?1:e.stiffness,this.wb.velocityIterations=void 0===e.velocityIterations?20:e.velocityIterations,this.wb.positionIterations=void 0===e.positionIterations?20:e.positionIterations,this.wb.fixedPoints=void 0===e.fixedPoints?0:e.fixedPoints,this.wb.margin=void 0===e.margin?0:e.margin,this.wb.damping=void 0===e.damping?0:e.damping,this.wb.path=void 0===e.path?null:e.path,this.wb.shape=void 0===e.shape?null:e.shape),this.$N=[],!this.object.parent||this.wb.ignoreParent?this.YN():this.object.parent.physicsImpostor&&F.Warn("You must affect impostors to children before affecting impostor to parent.")):F.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))):F.Error("No object was provided. A physics object is obligatory")}get isDisposed(){return this.li}get mass(){return this.HN?this.HN.getPhysicsPlugin().getBodyMass(this):0}set mass(t){this.setMass(t)}get friction(){return this.HN?this.HN.getPhysicsPlugin().getBodyFriction(this):0}set friction(t){this.HN&&this.HN.getPhysicsPlugin().setBodyFriction(this,t)}get restitution(){return this.HN?this.HN.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(t){this.HN&&this.HN.getPhysicsPlugin().setBodyRestitution(this,t)}get pressure(){if(!this.HN)return 0;const t=this.HN.getPhysicsPlugin();return t.setBodyPressure?t.getBodyPressure(this):0}set pressure(t){if(!this.HN)return;const i=this.HN.getPhysicsPlugin();i.setBodyPressure&&i.setBodyPressure(this,t)}get stiffness(){if(!this.HN)return 0;const t=this.HN.getPhysicsPlugin();return t.getBodyStiffness?t.getBodyStiffness(this):0}set stiffness(t){if(!this.HN)return;const i=this.HN.getPhysicsPlugin();i.setBodyStiffness&&i.setBodyStiffness(this,t)}get velocityIterations(){if(!this.HN)return 0;const t=this.HN.getPhysicsPlugin();return t.getBodyVelocityIterations?t.getBodyVelocityIterations(this):0}set velocityIterations(t){if(!this.HN)return;const i=this.HN.getPhysicsPlugin();i.setBodyVelocityIterations&&i.setBodyVelocityIterations(this,t)}get positionIterations(){if(!this.HN)return 0;const t=this.HN.getPhysicsPlugin();return t.getBodyPositionIterations?t.getBodyPositionIterations(this):0}set positionIterations(t){if(!this.HN)return;const i=this.HN.getPhysicsPlugin();i.setBodyPositionIterations&&i.setBodyPositionIterations(this,t)}YN(){this.HN&&(this.HN.removeImpostor(this),this.physicsBody=null,this.jt=this.jt||this.jN(),this.li||this.parent&&!this.wb.ignoreParent||this.HN.addImpostor(this))}jN(){if(this.object.parent instanceof ys){return this.object.parent.physicsImpostor}return null}isBodyInitRequired(){return this.FN||!this.KN&&(!this.jt||!!this.wb.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this.YN(),this.parent&&!this.wb.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this.jt&&!this.wb.ignoreParent?this.jt.physicsBody:this.KN}get parent(){return!this.wb.ignoreParent&&this.jt?this.jt:null}set parent(t){this.jt=t}set physicsBody(t){this.KN&&this.HN&&this.HN.getPhysicsPlugin().removePhysicsBody(this),this.KN=t,this.resetUpdateFlags()}resetUpdateFlags(){this.FN=!1}getObjectExtents(){if(this.object.getBoundingInfo){const t=this.object.rotationQuaternion,i=this.object.scaling.clone();this.object.rotationQuaternion=Rn.IDENTITY_QUATERNION;const e=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);e&&e.decompose(i,void 0,void 0);const s=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(i);return s.x=Math.abs(s.x),s.y=Math.abs(s.y),s.z=Math.abs(s.z),this.object.rotationQuaternion=t,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),s}return Rn.DEFAULT_OBJECT_SIZE}getObjectCenter(){if(this.object.getBoundingInfo){return this.object.getBoundingInfo().boundingBox.centerWorld}return this.object.position}getParam(t){return this.wb[t]}setParam(t,i){this.wb[t]=i,this.FN=!0}setMass(t){this.getParam("mass")!==t&&this.setParam("mass",t),this.HN&&this.HN.getPhysicsPlugin().setBodyMass(this,t)}getLinearVelocity(){return this.HN?this.HN.getPhysicsPlugin().getLinearVelocity(this):w.Zero()}setLinearVelocity(t){this.HN&&this.HN.getPhysicsPlugin().setLinearVelocity(this,t)}getAngularVelocity(){return this.HN?this.HN.getPhysicsPlugin().getAngularVelocity(this):w.Zero()}setAngularVelocity(t){this.HN&&this.HN.getPhysicsPlugin().setAngularVelocity(this,t)}executeNativeFunction(t){this.HN&&t(this.HN.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(t){this.BN.push(t)}unregisterBeforePhysicsStep(t){const i=this.BN.indexOf(t);i>-1?this.BN.splice(i,1):F.Warn("Function to remove was not found")}registerAfterPhysicsStep(t){this.UN.push(t)}unregisterAfterPhysicsStep(t){const i=this.UN.indexOf(t);i>-1?this.UN.splice(i,1):F.Warn("Function to remove was not found")}registerOnPhysicsCollide(t,i){const e=t instanceof Array?t:[t];this.VN.push({callback:i,otherImpostors:e})}unregisterOnPhysicsCollide(t,i){const e=t instanceof Array?t:[t];let s=-1;this.VN.some(((t,n)=>{if(t.callback===i&&t.otherImpostors.length===e.length){const i=t.otherImpostors.every((t=>e.indexOf(t)>-1));return i&&(s=n),i}return!1}))?this.VN.splice(s,1):F.Warn("Function to remove was not found")}getParentsRotation(){let t=this.object.parent;for(this.GN.copyFromFloats(0,0,0,1);t;)t.rotationQuaternion?this.zN.copyFrom(t.rotationQuaternion):T.RotationYawPitchRollToRef(t.rotation.y,t.rotation.x,t.rotation.z,this.zN),this.GN.multiplyToRef(this.zN,this.GN),t=t.parent;return this.GN}applyForce(t,i){return this.HN&&this.HN.getPhysicsPlugin().applyForce(this,t,i),this}applyImpulse(t,i){return this.HN&&this.HN.getPhysicsPlugin().applyImpulse(this,t,i),this}createJoint(t,i,e){const s=new Tn(i,e);return this.addJoint(t,s),this}addJoint(t,i){return this.$N.push({otherImpostor:t,joint:i}),this.HN&&this.HN.addJoint(this,t,i),this}addAnchor(t,i,e,s,n){if(!this.HN)return this;const r=this.HN.getPhysicsPlugin();return r.appendAnchor?(this.HN&&r.appendAnchor(this,t,i,e,s,n),this):this}addHook(t,i,e,s){if(!this.HN)return this;const n=this.HN.getPhysicsPlugin();return n.appendAnchor?(this.HN&&n.appendHook(this,t,i,e,s),this):this}sleep(){return this.HN&&this.HN.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this.HN&&this.HN.getPhysicsPlugin().wakeUpBody(this),this}clone(t){return t?new Rn(t,this.type,this.wb,this.Kt):null}dispose(){this.HN&&(this.$N.forEach((t=>{this.HN&&this.HN.removeJoint(this,t.otherImpostor,t.joint)})),this.HN.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this.li=!0)}setDeltaPosition(t){this.kN.copyFrom(t)}setDeltaRotation(t){this.WN||(this.WN=new T),this.WN.copyFrom(t),this.XN=this.WN.conjugate()}getBoxSizeToRef(t){return this.HN&&this.HN.getPhysicsPlugin().getBoxSizeToRef(this,t),this}getRadius(){return this.HN?this.HN.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(t,i,e,s,n){const r=Rn.uE[0],h=this.object;if(h.rotationQuaternion)if(n){const e=Rn.fE;h.rotationQuaternion.multiplyToRef(n,e),t.setRotationQuaternion(e,Be.WORLD,i)}else t.setRotationQuaternion(h.rotationQuaternion,Be.WORLD,i);r.x=0,r.y=0,r.z=0,e&&(r.x=e.x,r.y=e.y,r.z=e.z,t.getDirectionToRef(r,i,r),null==s&&(s=e.length()),r.x*=s,r.y*=s,r.z*=s),t.getParent()?(r.addInPlace(h.getAbsolutePosition()),t.setAbsolutePosition(r,i)):(i.setAbsolutePosition(h.getAbsolutePosition()),i.position.x-=r.x,i.position.y-=r.y,i.position.z-=r.z)}syncImpostorWithBone(t,i,e,s,n,r){const h=this.object;if(h.rotationQuaternion)if(n){const e=Rn.fE;t.getRotationQuaternionToRef(Be.WORLD,i,e),e.multiplyToRef(n,h.rotationQuaternion)}else t.getRotationQuaternionToRef(Be.WORLD,i,h.rotationQuaternion);const o=Rn.uE[0],a=Rn.uE[1];r||((r=Rn.uE[2]).x=0,r.y=1,r.z=0),t.getDirectionToRef(r,i,a),t.getAbsolutePositionToRef(i,o),null==s&&e&&(s=e.length()),null!=s&&(o.x+=a.x*s,o.y+=a.y*s,o.z+=a.z*s),h.setAbsolutePosition(o)}}var In,Mn,bn,_n,yn,Nn,Pn,Dn,Ln;Rn.DEFAULT_OBJECT_SIZE=new w(1,1,1),Rn.IDENTITY_QUATERNION=T.Identity(),Rn.uE=f.BuildArray(3,w.Zero),Rn.fE=T.Identity(),Rn.NoImpostor=0,Rn.SphereImpostor=1,Rn.BoxImpostor=2,Rn.PlaneImpostor=3,Rn.MeshImpostor=4,Rn.CapsuleImpostor=6,Rn.CylinderImpostor=7,Rn.ParticleImpostor=8,Rn.HeightmapImpostor=9,Rn.ConvexHullImpostor=10,Rn.CustomImpostor=100,Rn.RopeImpostor=101,Rn.ClothImpostor=102,Rn.SoftbodyImpostor=103,function(t){t[t.Clean=0]="Clean",t[t.Stop=1]="Stop",t[t.Sync=2]="Sync",t[t.NoSync=3]="NoSync"}(In||(In={}));class On{static get ForceFullSceneLoadingForIncremental(){return Es.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(t){Es.ForceFullSceneLoadingForIncremental=t}static get ShowLoadingScreen(){return Es.ShowLoadingScreen}static set ShowLoadingScreen(t){Es.ShowLoadingScreen=t}static get loggingLevel(){return Es.loggingLevel}static set loggingLevel(t){Es.loggingLevel=t}static get CleanBoneMatrixWeights(){return Es.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(t){Es.CleanBoneMatrixWeights=t}static GetDefaultPlugin(){return On.qN[".babylon"]}static QN(t){const i=On.qN[t];return i||(F.Warn("Unable to find a plugin to load "+t+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),On.GetDefaultPlugin())}static ZN(t){for(const i in On.qN){const e=On.qN[i].plugin;if(e.canDirectLoad&&e.canDirectLoad(t))return On.qN[i]}return On.GetDefaultPlugin()}static JN(t){const i=t.indexOf("?");-1!==i&&(t=t.substring(0,i));const e=t.lastIndexOf("."),s=t.substring(e,t.length).toLowerCase();return On.QN(s)}static tP(t){return"data:"===t.substr(0,5)?t.substr(5):null}static iP(t,i,e){let s="Unable to load from "+t.url;return i?s+=`: ${i}`:e&&(s+=`: ${e}`),s}static eP(t,i,e,s,n,r,h){const o=On.tP(t.url),a=h?On.QN(h):o?On.ZN(t.url):On.JN(t.url);let l;if(l=void 0!==a.plugin.createPlugin?a.plugin.createPlugin():a.plugin,!l)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(On.OnPluginActivatedObservable.notifyObservers(l),o&&(l.canDirectLoad&&l.canDirectLoad(t.url)||!Di(t.url))){if(l.directLoad){const t=l.directLoad(i,o);t.then?t.then((t=>{e(l,t)})).catch((t=>{n("Error in directLoad of _loadData: "+t,t)})):e(l,t)}else e(l,o);return l}const c=a.isBinary,u=(t,s)=>{i.isDisposed?n("Scene has been disposed"):e(l,t,s)};let f=null,d=!1;const p=l.onDisposeObservable;p&&p.add((()=>{d=!0,f&&(f.abort(),f=null),r()}));const m=()=>{if(d)return;const e=(t,i)=>{n(null==t?void 0:t.statusText,i)},r=t.file||t.url;f=l.loadFile?l.loadFile(i,r,u,s,c,e):i.tn(r,u,s,!0,c,e)},v=i.getEngine();let g=v.enableOfflineSupport;if(g){let e=!1;for(const s of i.disableOfflineSupportExceptionRules)if(s.test(t.url)){e=!0;break}g=!e}return g&&Rs.OfflineProviderFactory?i.offlineProvider=Rs.OfflineProviderFactory(t.url,m,v.disableManifestCheck):m(),l}static sP(t,i){let e,s,n=null;if(i)if(i.name){const t=i;e=`file:${t.name}`,s=t.name,n=t}else if("string"==typeof i&&i.startsWith("data:"))e=i,s="";else{const n=i;if("/"===n.substr(0,1))return ki.Error("Wrong sceneFilename parameter"),null;e=t+n,s=n}else e=t,s=ki.GetFilename(t),t=ki.GetFolderPath(t);return{url:e,rootUrl:t,name:s,file:n}}static GetPluginForExtension(t){return On.QN(t).plugin}static IsPluginForExtensionAvailable(t){return!!On.qN[t]}static RegisterPlugin(t){if("string"==typeof t.extensions){const i=t.extensions;On.qN[i.toLowerCase()]={plugin:t,isBinary:!1}}else{const i=t.extensions;Object.keys(i).forEach((e=>{On.qN[e.toLowerCase()]={plugin:t,isBinary:i[e].isBinary}}))}}static ImportMesh(t,i,e="",s=E.LastCreatedScene,n=null,r=null,h=null,o=null){if(!s)return F.Error("No scene available to import mesh to"),null;const a=On.sP(i,e);if(!a)return null;const l={};s.addPendingData(l);const c=()=>{s.removePendingData(l)},u=(t,i)=>{const e=On.iP(a,t,i);h?h(s,e,new Bt(e,Dt,i)):F.Error(e),c()},f=r?t=>{try{r(t)}catch(t){u("Error in onProgress callback: "+t,t)}}:void 0,d=(t,i,e,r,h,o,c)=>{if(s.importedMeshesFiles.push(a.url),n)try{n(t,i,e,r,h,o,c)}catch(t){u("Error in onSuccess callback: "+t,t)}s.removePendingData(l)};return On.eP(a,s,((i,e,n)=>{if(i.rewriteRootURL&&(a.rootUrl=i.rewriteRootURL(a.rootUrl,n)),i.importMesh){const n=i,r=new Array,h=new Array,o=new Array;if(!n.importMesh(t,s,e,a.rootUrl,r,h,o,u))return;s.loadingPluginName=i.name,d(r,h,o,[],[],[],[])}else{i.importMeshAsync(t,s,e,a.rootUrl,f,a.name).then((t=>{s.loadingPluginName=i.name,d(t.meshes,t.particleSystems,t.skeletons,t.animationGroups,t.transformNodes,t.geometries,t.lights)})).catch((t=>{u(t.message,t)}))}}),f,u,c,o)}static ImportMeshAsync(t,i,e="",s=E.LastCreatedScene,n=null,r=null){return new Promise(((h,o)=>{On.ImportMesh(t,i,e,s,((t,i,e,s,n,r,o)=>{h({meshes:t,particleSystems:i,skeletons:e,animationGroups:s,transformNodes:n,geometries:r,lights:o})}),n,((t,i,e)=>{o(e||new Error(i))}),r)}))}static Load(t,i="",e=E.LastCreatedEngine,s=null,n=null,r=null,h=null){return e?On.Append(t,i,new ke(e),s,n,r,h):(ki.Error("No engine available"),null)}static LoadAsync(t,i="",e=E.LastCreatedEngine,s=null,n=null){return new Promise(((r,h)=>{On.Load(t,i,e,(t=>{r(t)}),s,((t,i,e)=>{h(e||new Error(i))}),n)}))}static Append(t,i="",e=E.LastCreatedScene,s=null,n=null,r=null,h=null){if(!e)return F.Error("No scene available to append to"),null;const o=On.sP(t,i);if(!o)return null;const a={};e.addPendingData(a);const l=()=>{e.removePendingData(a)};On.ShowLoadingScreen&&!this.nP&&(this.nP=!0,e.getEngine().displayLoadingUI(),e.executeWhenReady((()=>{e.getEngine().hideLoadingUI(),this.nP=!1})));const c=(t,i)=>{const s=On.iP(o,t,i);r?r(e,s,new Bt(s,Dt,i)):F.Error(s),l()},u=n?t=>{try{n(t)}catch(t){c("Error in onProgress callback",t)}}:void 0,f=()=>{if(s)try{s(e)}catch(t){c("Error in onSuccess callback",t)}e.removePendingData(a)};return On.eP(o,e,((t,i)=>{if(t.load){if(!t.load(e,i,o.rootUrl,c))return;e.loadingPluginName=t.name,f()}else{t.loadAsync(e,i,o.rootUrl,u,o.name).then((()=>{e.loadingPluginName=t.name,f()})).catch((t=>{c(t.message,t)}))}}),u,c,l,h)}static AppendAsync(t,i="",e=E.LastCreatedScene,s=null,n=null){return new Promise(((r,h)=>{On.Append(t,i,e,(t=>{r(t)}),s,((t,i,e)=>{h(e||new Error(i))}),n)}))}static LoadAssetContainer(t,i="",e=E.LastCreatedScene,s=null,n=null,r=null,h=null){if(!e)return F.Error("No scene available to load asset container to"),null;const o=On.sP(t,i);if(!o)return null;const a={};e.addPendingData(a);const l=()=>{e.removePendingData(a)},c=(t,i)=>{const s=On.iP(o,t,i);r?r(e,s,new Bt(s,Dt,i)):F.Error(s),l()},u=n?t=>{try{n(t)}catch(t){c("Error in onProgress callback",t)}}:void 0,f=t=>{if(s)try{s(t)}catch(t){c("Error in onSuccess callback",t)}e.removePendingData(a)};return On.eP(o,e,((t,i)=>{if(t.loadAssetContainer){const s=t.loadAssetContainer(e,i,o.rootUrl,c);if(!s)return;e.loadingPluginName=t.name,f(s)}else if(t.loadAssetContainerAsync){t.loadAssetContainerAsync(e,i,o.rootUrl,u,o.name).then((i=>{e.loadingPluginName=t.name,f(i)})).catch((t=>{c(t.message,t)}))}else c("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")}),u,c,l,h)}static LoadAssetContainerAsync(t,i="",e=E.LastCreatedScene,s=null,n=null){return new Promise(((r,h)=>{On.LoadAssetContainer(t,i,e,(t=>{r(t)}),s,((t,i,e)=>{h(e||new Error(i))}),n)}))}static ImportAnimations(t,i="",e=E.LastCreatedScene,s=!0,n=In.Clean,r=null,h=null,o=null,a=null,l=null){if(!e)return void F.Error("No scene available to load animations to");if(s){for(const t of e.animatables)t.reset();e.stopAllAnimations(),e.animationGroups.slice().forEach((t=>{t.dispose()}));e.getNodes().forEach((t=>{t.animations&&(t.animations=[])}))}else switch(n){case In.Clean:e.animationGroups.slice().forEach((t=>{t.dispose()}));break;case In.Stop:e.animationGroups.forEach((t=>{t.stop()}));break;case In.Sync:e.animationGroups.forEach((t=>{t.reset(),t.restart()}));break;case In.NoSync:break;default:return void F.Error("Unknown animation group loading mode value '"+n+"'")}const c=e.animatables.length;this.LoadAssetContainer(t,i,e,(t=>{t.mergeAnimationsTo(e,e.animatables.slice(c),r),t.dispose(),e.onAnimationFileImportedObservable.notifyObservers(e),h&&h(e)}),o,a,l)}static ImportAnimationsAsync(t,i="",e=E.LastCreatedScene,s=!0,n=In.Clean,r=null,h=null,o=null,a=null,l=null){return new Promise(((h,a)=>{On.ImportAnimations(t,i,e,s,n,r,(t=>{h(t)}),o,((t,i,e)=>{a(e||new Error(i))}),l)}))}}On.NO_LOGGING=0,On.MINIMAL_LOGGING=1,On.SUMMARY_LOGGING=2,On.DETAILED_LOGGING=3,On.OnPluginActivatedObservable=new h,On.qN={},On.nP=!1;class Fn extends Vs{constructor(t,i,e=!0){super(t,i),this.rP=new R,this.Lg=e}getEffect(){return this.Lg?this.hP:super.getEffect()}isReady(t,i){return!!t&&(!this.Lg||(!t.subMeshes||0===t.subMeshes.length||this.isReadyForSubMesh(t,t.subMeshes[0],i)))}oP(t){const i=t.materialDefines;return!(this.checkReadyOnEveryCall||!t.effect||!i||i.Sv!==this.getScene().getRenderId())}bindOnlyWorldMatrix(t){this.hP.setMatrix("world",t)}bindOnlyNormalMatrix(t){this.hP.setMatrix("normalMatrix",t)}bind(t,i){i&&this.bindForSubMesh(t,i,i.subMeshes[0])}tI(t,i=null){super.tI(t,i),this.getScene().Ng=i,i&&(i.us=!1)}aP(t,i,e=1){return t.isCachedMaterialInvalid(this,i,e)}}!function(t){t[t.Float=1]="Float",t[t.Int=2]="Int",t[t.Vector2=4]="Vector2",t[t.Vector3=8]="Vector3",t[t.Vector4=16]="Vector4",t[t.Color3=32]="Color3",t[t.Color4=64]="Color4",t[t.Matrix=128]="Matrix",t[t.Object=256]="Object",t[t.AutoDetect=1024]="AutoDetect",t[t.BasedOnInput=2048]="BasedOnInput",t[t.All=4095]="All"}(Mn||(Mn={})),function(t){t[t.Vertex=1]="Vertex",t[t.Fragment=2]="Fragment",t[t.Neutral=4]="Neutral",t[t.VertexAndFragment=3]="VertexAndFragment"}(bn||(bn={}));class Bn{constructor(){this.supportUniformBuffers=!1,this.attributes=new Array,this.uniforms=new Array,this.constants=new Array,this.samplers=new Array,this.functions={},this.extensions={},this.counters={},this.lP="",this.cP="",this.uP="",this.fP="",this.dP="",this.pP="",this.mP=0,this.vP="",this.compilationString=""}finalize(t){const i=t.sharedData.emitComments,e=this.target===bn.Fragment;this.compilationString=`\r\n${i?"//Entry point\r\n":""}void main(void) {\r\n${this.compilationString}`,this.uP&&(this.compilationString=`\r\n${i?"//Constants\r\n":""}${this.uP}\r\n${this.compilationString}`);let s="";for(const t in this.functions)s+=this.functions[t]+"\r\n";this.compilationString=`\r\n${s}\r\n${this.compilationString}`,!e&&this.dP&&(this.compilationString=`${this.compilationString}\r\n${this.dP}`),this.pP&&(this.compilationString=`${this.compilationString}\r\n${this.pP}`),this.compilationString=`${this.compilationString}\r\n}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\r\n${i?"//Varyings\r\n":""}${this.sharedData.varyingDeclaration}\r\n${this.compilationString}`),this.fP&&(this.compilationString=`\r\n${i?"//Samplers\r\n":""}${this.fP}\r\n${this.compilationString}`),this.cP&&(this.compilationString=`\r\n${i?"//Uniforms\r\n":""}${this.cP}\r\n${this.compilationString}`),this.lP&&!e&&(this.compilationString=`\r\n${i?"//Attributes\r\n":""}${this.lP}\r\n${this.compilationString}`),this.compilationString="precision highp float;\r\n"+this.compilationString;for(const t in this.extensions){const i=this.extensions[t];this.compilationString=`\r\n${i}\r\n${this.compilationString}`}this.vP=this.compilationString}get gP(){return`###___ANCHOR${this.mP++}___###`}SP(t){return t=t.replace(/[^a-zA-Z_]+/g,""),void 0===this.sharedData.variableNames[t]?(this.sharedData.variableNames[t]=0,"output"===t||"texture"===t?t+this.sharedData.variableNames[t]:t):(this.sharedData.variableNames[t]++,t+this.sharedData.variableNames[t])}EP(t){return void 0===this.sharedData.defineNames[t]?this.sharedData.defineNames[t]=0:this.sharedData.defineNames[t]++,t+this.sharedData.defineNames[t]}AP(t){this.sharedData.variableNames[t]=0}CP(t){this.samplers.indexOf(t)<0&&(this.fP+=`uniform sampler2D ${t};\r\n`,this.samplers.push(t))}wP(t){switch(t){case Mn.Float:return"float";case Mn.Int:return"int";case Mn.Vector2:return"vec2";case Mn.Color3:case Mn.Vector3:return"vec3";case Mn.Color4:case Mn.Vector4:return"vec4";case Mn.Matrix:return"mat4"}return""}xP(t,i,e=""){this.extensions[t]||(e&&(i=`#if ${e}\r\n${i}\r\n#endif`),this.extensions[t]=i)}TP(t,i,e){this.functions[t]||(this.sharedData.emitComments&&(i=e+"\r\n"+i),this.functions[t]=i)}RP(t,i,e){if(e&&e.repeatKey)return`#include<${t}>${e.substitutionVars?"("+e.substitutionVars+")":""}[0..${e.repeatKey}]\r\n`;let s=ei.IncludesShadersStore[t]+"\r\n";if(this.sharedData.emitComments&&(s=i+"\r\n"+s),!e)return s;if(e.replaceStrings)for(let t=0;t<e.replaceStrings.length;t++){const i=e.replaceStrings[t];s=s.replace(i.search,i.replace)}return s}IP(t,i,e,s=""){const n=t+s;if(!this.functions[n]){if(!(e&&(e.removeAttributes||e.removeUniforms||e.removeVaryings||e.removeIfDef||e.replaceStrings)))return e&&e.repeatKey?this.functions[n]=`#include<${t}>${e.substitutionVars?"("+e.substitutionVars+")":""}[0..${e.repeatKey}]\r\n`:this.functions[n]=`#include<${t}>${(null==e?void 0:e.substitutionVars)?"("+(null==e?void 0:e.substitutionVars)+")":""}\r\n`,void(this.sharedData.emitComments&&(this.functions[n]=i+"\r\n"+this.functions[n]));if(this.functions[n]=ei.IncludesShadersStore[t],this.sharedData.emitComments&&(this.functions[n]=i+"\r\n"+this.functions[n]),e.removeIfDef&&(this.functions[n]=this.functions[n].replace(/^\s*?#ifdef.+$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#endif.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#else.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#elif.*$/gm,"")),e.removeAttributes&&(this.functions[n]=this.functions[n].replace(/^\s*?attribute.+$/gm,"")),e.removeUniforms&&(this.functions[n]=this.functions[n].replace(/^\s*?uniform.+$/gm,"")),e.removeVaryings&&(this.functions[n]=this.functions[n].replace(/^\s*?varying.+$/gm,"")),e.replaceStrings)for(let t=0;t<e.replaceStrings.length;t++){const i=e.replaceStrings[t];this.functions[n]=this.functions[n].replace(i.search,i.replace)}}}MP(t){return-1===this.sharedData.temps.indexOf(t)&&(this.sharedData.temps.push(t),!0)}bP(t,i,e="",s=!1){return-1===this.sharedData.varyings.indexOf(t)&&(this.sharedData.varyings.push(t),e&&(e.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${e}\r\n`:this.sharedData.varyingDeclaration+=`${s?"#ifndef":"#ifdef"} ${e}\r\n`),this.sharedData.varyingDeclaration+=`varying ${i} ${t};\r\n`,e&&(this.sharedData.varyingDeclaration+="#endif\r\n"),!0)}_P(t,i,e="",s=!1){-1===this.uniforms.indexOf(t)&&(this.uniforms.push(t),e&&(e.startsWith("defined(")?this.cP+=`#if ${e}\r\n`:this.cP+=`${s?"#ifndef":"#ifdef"} ${e}\r\n`),this.cP+=`uniform ${i} ${t};\r\n`,e&&(this.cP+="#endif\r\n"))}yP(t){return t.toString()===t.toFixed(0)?`${t}.0`:t.toString()}}class Un{constructor(){this.temps=new Array,this.varyings=new Array,this.varyingDeclaration="",this.inputBlocks=new Array,this.textureBlocks=new Array,this.bindableBlocks=new Array,this.forcedBindableBlocks=new Array,this.blocksWithFallbacks=new Array,this.blocksWithDefines=new Array,this.repeatableContentBlocks=new Array,this.dynamicUniformBlocks=new Array,this.blockingBlocks=new Array,this.animatedInputs=new Array,this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(){let t="";this.checks.emitVertex||this.allowEmptyVertexProgram||(t+="NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\r\n"),this.checks.emitFragment||(t+="NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\r\n");for(const i of this.checks.notConnectedNonOptionalInputs)t+=`input ${i.name} from block ${i.ownerBlock.name}[${i.ownerBlock.getClassName()}] is not connected and is not optional.\r\n`;if(t)throw"Build of NodeMaterial failed:\r\n"+t}}!function(t){t[t.Compatible=0]="Compatible",t[t.TypeIncompatible=1]="TypeIncompatible",t[t.TargetIncompatible=2]="TargetIncompatible",t[t.HierarchyIssue=3]="HierarchyIssue"}(_n||(_n={})),function(t){t[t.Input=0]="Input",t[t.Output=1]="Output"}(yn||(yn={}));class Vn{constructor(t,i,e){this.NP=null,this.PP=new Array,this.DP=null,this.LP=null,this.OP=null,this.FP=null,this.BP=Mn.Float,this.UP=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new h,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this.VP=!1,this.Pt=bn.VertexAndFragment,this.kP=i,this.name=t,this.GP=e}static AreEquivalentTypes(t,i){switch(t){case Mn.Vector3:if(i===Mn.Color3)return!0;break;case Mn.Vector4:if(i===Mn.Color4)return!0;break;case Mn.Color3:if(i===Mn.Vector3)return!0;break;case Mn.Color4:if(i===Mn.Vector4)return!0}return!1}get direction(){return this.GP}get associatedVariableName(){return this.kP.isInput?this.kP.associatedVariableName:this.UP&&this.zP||!this.NP?this.zP:this.NP.associatedVariableName}set associatedVariableName(t){this.zP=t}get innerType(){return this.OP&&this.OP.isConnected?this.type:this.BP}get type(){if(this.BP===Mn.AutoDetect){if(this.kP.isInput)return this.kP.type;if(this.NP)return this.NP.type;if(this.OP&&this.OP.isConnected)return this.OP.type}if(this.BP===Mn.BasedOnInput){if(this.DP)return!this.DP.isConnected&&this.LP?this.LP:this.DP.type;if(this.LP)return this.LP}return this.BP}set type(t){this.BP=t}get target(){return this.VP&&this.kP?this.Pt!==bn.VertexAndFragment?this.Pt:this.kP.target===bn.Fragment?bn.Fragment:bn.Vertex:this.Pt}set target(t){this.Pt=t}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get isConnectedToInputBlock(){return null!==this.connectedPoint&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this.NP}get ownerBlock(){return this.kP}get sourceBlock(){return this.NP?this.NP.ownerBlock:null}get connectedBlocks(){return 0===this.PP.length?[]:this.PP.map((t=>t.ownerBlock))}get endpoints(){return this.PP}get hasEndpoints(){return this.PP&&this.PP.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const t of this.PP){if(t.ownerBlock.target===bn.Vertex)return!0;if((t.ownerBlock.target===bn.Neutral||t.ownerBlock.target===bn.VertexAndFragment)&&t.ownerBlock.outputs.some((t=>t.isDirectlyConnectedToVertexOutput)))return!0}return!1}get isConnectedInVertexShader(){if(this.target===bn.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const t of this.PP){if(t.ownerBlock.target===bn.Vertex)return!0;if(t.target===bn.Vertex)return!0;if((t.ownerBlock.target===bn.Neutral||t.ownerBlock.target===bn.VertexAndFragment)&&t.ownerBlock.outputs.some((t=>t.isConnectedInVertexShader)))return!0}return!1}get isConnectedInFragmentShader(){if(this.target===bn.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const t of this.PP){if(t.ownerBlock.target===bn.Fragment)return!0;if((t.ownerBlock.target===bn.Neutral||t.ownerBlock.target===bn.VertexAndFragment)&&t.ownerBlock.outputs.some((t=>t.isConnectedInFragmentShader)))return!0}return!1}createCustomInputBlock(){return null}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(t){return this.checkCompatibilityState(t)===_n.Compatible}checkCompatibilityState(t){const i=this.kP,e=t.ownerBlock;if(i.target===bn.Fragment){if(e.target===bn.Vertex)return _n.TargetIncompatible;for(const t of e.outputs)if(t.ownerBlock.target!=bn.Neutral&&t.isConnectedInVertexShader)return _n.TargetIncompatible}if(this.type!==t.type&&t.innerType!==Mn.AutoDetect)return Vn.AreEquivalentTypes(this.type,t.type)||t.acceptedConnectionPointTypes&&-1!==t.acceptedConnectionPointTypes.indexOf(this.type)||t.FP&&Vn.AreEquivalentTypes(t.FP.type,this.type)?_n.Compatible:_n.TypeIncompatible;if(t.excludedConnectionPointTypes&&-1!==t.excludedConnectionPointTypes.indexOf(this.type))return _n.TypeIncompatible;let s=e,n=i;return this.direction===yn.Input&&(s=i,n=e),s.isAnAncestorOf(n)?_n.HierarchyIssue:_n.Compatible}connectTo(t,i=!1){if(!i&&!this.canConnectTo(t))throw"Cannot connect these two connectors.";return this.PP.push(t),t.NP=this,this.UP=!1,this.onConnectionObservable.notifyObservers(t),t.onConnectionObservable.notifyObservers(this),this}disconnectFrom(t){const i=this.PP.indexOf(t);return-1===i||(this.PP.splice(i,1),t.NP=null,this.UP=!1,t.UP=!1),this}addExcludedConnectionPointFromAllowedTypes(t){let i=1;for(;i<Mn.All;)t&i||this.excludedConnectionPointTypes.push(i),i<<=1}serialize(t=!0){const i={};return i.name=this.name,i.displayName=this.displayName,t&&this.connectedPoint&&(i.inputName=this.name,i.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,i.targetConnectionName=this.connectedPoint.name,i.isExposedOnFrame=!0,i.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(i.isExposedOnFrame=!0,i.exposedPortPosition=this.exposedPortPosition),i}dispose(){this.onConnectionObservable.clear()}}class kn{constructor(t,i=bn.Vertex,e=!1,s=!1){this.HP=!1,this.XP=!1,this.hn="",this.WP=!1,this.inputsAreExclusive=!1,this.$P="",this.xd=new Array,this.YP=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this.Pt=i,this.jP=i===bn.Neutral,this.HP=e,this.XP=s,this.hn=t,this.uniqueId=Le.UniqueId}get name(){return this.hn}set name(t){this.validateBlockName(t)&&(this.hn=t)}get isUnique(){return this.WP}get isFinalMerger(){return this.HP}get isInput(){return this.XP}get buildId(){return this.KP}set buildId(t){this.KP=t}get target(){return this.Pt}set target(t){0==(this.Pt&t)&&(this.Pt=t)}get inputs(){return this.xd}get outputs(){return this.YP}getInputByName(t){const i=this.xd.filter((i=>i.name===t));return i.length?i[0]:null}getOutputByName(t){const i=this.YP.filter((i=>i.name===t));return i.length?i[0]:null}qP(t){this.Pt=t,this.jP=t===bn.Neutral}initialize(t){}bind(t,i,e,s){}QP(t,i){return`${i.wP(t.type)} ${t.associatedVariableName}`}ZP(t){return t.connectedPoint?`${t.associatedVariableName}`:"0."}JP(t){let i=t.toString();return-1===i.indexOf(".")&&(i+=".0"),`${i}`}getClassName(){return"NodeMaterialBlock"}registerInput(t,i,e=!1,s,n){return(n=null!=n?n:new Vn(t,this,yn.Input)).type=i,n.isOptional=e,s&&(n.target=s),this.xd.push(n),this}registerOutput(t,i,e,s){return(s=null!=s?s:new Vn(t,this,yn.Output)).type=i,e&&(s.target=e),this.YP.push(s),this}getFirstAvailableInput(t=null){for(const i of this.xd)if(!(i.connectedPoint||t&&t.type!==i.type&&i.type!==Mn.AutoDetect))return i;return null}getFirstAvailableOutput(t=null){for(const i of this.YP)if(!t||!t.target||t.target===bn.Neutral||0!=(t.target&i.target))return i;return null}getSiblingOutput(t){const i=this.YP.indexOf(t);return-1===i||i>=this.YP.length?null:this.YP[i+1]}isAnAncestorOf(t){for(const i of this.YP)if(i.hasEndpoints)for(const e of i.endpoints){if(e.ownerBlock===t)return!0;if(e.ownerBlock.isAnAncestorOf(t))return!0}return!1}connectTo(t,i){if(0===this.YP.length)return;let e=i&&i.output?this.getOutputByName(i.output):this.getFirstAvailableOutput(t),s=!0;for(;s;){const n=i&&i.input?t.getInputByName(i.input):t.getFirstAvailableInput(e);if(e&&n&&e.canConnectTo(n))e.connectTo(n),s=!1;else{if(!e)throw"Unable to find a compatible match";e=this.getSiblingOutput(e)}}return this}tD(t){}updateUniformsAndSamples(t,i,e,s){}provideFallbacks(t,i){}initializeDefines(t,i,e,s=!1){}prepareDefines(t,i,e,s=!1,n){}autoConfigure(t){}replaceRepeatableContent(t,i,e,s){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return!this.isInput&&!this.isFinalMerger&&(!this.YP.some((t=>t.isDirectlyConnectedToVertexOutput))&&(this.target!==bn.Vertex&&!(this.target!==bn.VertexAndFragment&&this.target!==bn.Neutral||!this.YP.some((t=>t.isConnectedInVertexShader)))))}isReady(t,i,e,s=!1){return!0}iD(t,i,e=!1){e?this.xd[i].FP=this.xd[t]:this.xd[t].OP=this.xd[i],this.xd[i].OP=this.xd[t]}eD(t,i,e,s){t.build(i,s);const n=null!=i.sD,r=t.nD===bn.Vertex&&t.target!==bn.VertexAndFragment;if(n&&(0==(t.target&t.nD)||0==(t.target&e.target)||this.target!==bn.VertexAndFragment&&r)&&(!t.isInput&&i.target!==t.nD||t.isInput&&t.isAttribute&&!t.rD)){const t=e.connectedPoint;i.sD.bP("v_"+t.associatedVariableName,i.wP(t.type))&&(i.sD.compilationString+=`${"v_"+t.associatedVariableName} = ${t.associatedVariableName};\r\n`),e.associatedVariableName="v_"+t.associatedVariableName,e.UP=!0}}validateBlockName(t){const i=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const e of i)if(t===e)return!1;return!0}build(t,i){if(this.KP===t.sharedData.buildId)return!0;if(!this.isInput)for(const i of this.YP)i.associatedVariableName||(i.associatedVariableName=t.SP(i.name));for(const e of this.xd){if(!e.connectedPoint){e.isOptional||t.sharedData.checks.notConnectedNonOptionalInputs.push(e);continue}if(this.target!==bn.Neutral){if(0==(e.target&this.target))continue;if(0==(e.target&t.target))continue}const s=e.connectedPoint.ownerBlock;s&&s!==this&&this.eD(s,t,e,i)}if(this.KP===t.sharedData.buildId)return!0;if(t.sharedData.verbose&&console.log(`${t.target===bn.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(t.target){case bn.Vertex:t.sharedData.checks.emitVertex=!0;break;case bn.Fragment:t.sharedData.checks.emitFragment=!0}!this.isInput&&t.sharedData.emitComments&&(t.compilationString+=`\r\n//${this.name}\r\n`),this.tD(t),this.KP=t.sharedData.buildId,this.nD=t.target;for(const e of this.YP)if(0!=(e.target&t.target))for(const s of e.endpoints){const e=s.ownerBlock;e&&0!=(e.target&t.target)&&-1!==i.indexOf(e)&&this.eD(e,t,s,i)}return!1}hD(t){return t}oD(t){return t}aD(){const t=this.$P;return`${t}.visibleInInspector = ${this.visibleInInspector};\r\n${t}.visibleOnFrame = ${this.visibleOnFrame};\r\n${t}.target = ${this.target};\r\n`}lD(t,i){let e;i.push(this);const s=this.name.replace(/[^A-Za-z_]+/g,"");if(this.$P=s||`${this.getClassName()}_${this.uniqueId}`,-1!==t.indexOf(this.$P)){let i=0;do{i++,this.$P=s+i}while(-1!==t.indexOf(this.$P))}t.push(this.$P),e=`\r\n// ${this.getClassName()}\r\n`,this.comments&&(e+=`// ${this.comments}\r\n`),e+=`var ${this.$P} = new BABYLON.${this.getClassName()}("${this.name}");\r\n`,e+=this.aD();for(const s of this.inputs){if(!s.isConnected)continue;const n=s.connectedPoint.ownerBlock;-1===i.indexOf(n)&&(e+=n.lD(t,i))}for(const s of this.outputs)if(s.hasEndpoints)for(const n of s.endpoints){const s=n.ownerBlock;s&&-1===i.indexOf(s)&&(e+=s.lD(t,i))}return e}cD(t){let i="";if(-1!==t.indexOf(this))return i;t.push(this);for(const e of this.inputs){if(!e.isConnected)continue;const s=e.connectedPoint,n=s.ownerBlock;i+=n.cD(t),i+=`${n.$P}.${n.oD(s.name)}.connectTo(${this.$P}.${this.hD(e.name)});\r\n`}return i}clone(t,i=""){const e=this.serialize(),s=g(e.customType);if(s){const n=new s;return n.uD(e,t,i),n}return null}serialize(){const t={};t.customType="BABYLON."+this.getClassName(),t.id=this.uniqueId,t.name=this.name,t.comments=this.comments,t.visibleInInspector=this.visibleInInspector,t.visibleOnFrame=this.visibleOnFrame,t.target=this.target,t.inputs=[],t.outputs=[];for(const i of this.inputs)t.inputs.push(i.serialize());for(const i of this.outputs)t.outputs.push(i.serialize(!1));return t}uD(t,i,e){var s;this.name=t.name,this.comments=t.comments,this.visibleInInspector=!!t.visibleInInspector,this.visibleOnFrame=!!t.visibleOnFrame,this.Pt=null!==(s=t.target)&&void 0!==s?s:this.target,this.fD(t)}fD(t){const i=t.inputs,e=t.outputs;i&&i.forEach(((t,i)=>{t.displayName&&(this.inputs[i].displayName=t.displayName),t.isExposedOnFrame&&(this.inputs[i].isExposedOnFrame=t.isExposedOnFrame,this.inputs[i].exposedPortPosition=t.exposedPortPosition)})),e&&e.forEach(((t,i)=>{t.displayName&&(this.outputs[i].displayName=t.displayName),t.isExposedOnFrame&&(this.outputs[i].isExposedOnFrame=t.isExposedOnFrame,this.outputs[i].exposedPortPosition=t.exposedPortPosition)}))}dispose(){for(const t of this.inputs)t.dispose();for(const t of this.outputs)t.dispose()}}class Gn extends kn{constructor(t){super(t,bn.Neutral),this.complementW=1,this.complementZ=0,this.target=bn.Vertex,this.registerInput("vector",Mn.AutoDetect),this.registerInput("transform",Mn.Matrix),this.registerOutput("output",Mn.Vector4),this.registerOutput("xyz",Mn.Vector3),this.xd[0].onConnectionObservable.add((t=>{if(t.ownerBlock.isInput){const i=t.ownerBlock;"normal"!==i.name&&"tangent"!==i.name||(this.complementW=0)}}))}getClassName(){return"TransformBlock"}get vector(){return this.xd[0]}get output(){return this.YP[0]}get xyz(){return this.YP[1]}get transform(){return this.xd[1]}tD(t){super.tD(t);const i=this.vector,e=this.transform;if(i.connectedPoint){if(0===this.complementW){const s=`//${this.name}`;t.IP("helperFunctions",s),t.sharedData.blocksWithDefines.push(this);const n=t.SP(`${e.associatedVariableName}_NUS`);switch(t.compilationString+=`mat3 ${n} = mat3(${e.associatedVariableName});\r\n`,t.compilationString+="#ifdef NONUNIFORMSCALING\r\n",t.compilationString+=`${n} = transposeMat3(inverseMat3(${n}));\r\n`,t.compilationString+="#endif\r\n",i.connectedPoint.type){case Mn.Vector2:t.compilationString+=this.QP(this.output,t)+` = vec4(${n} * vec3(${i.associatedVariableName}, ${this.JP(this.complementZ)}), ${this.JP(this.complementW)});\r\n`;break;case Mn.Vector3:case Mn.Color3:t.compilationString+=this.QP(this.output,t)+` = vec4(${n} * ${i.associatedVariableName}, ${this.JP(this.complementW)});\r\n`;break;default:t.compilationString+=this.QP(this.output,t)+` = vec4(${n} * ${i.associatedVariableName}.xyz, ${this.JP(this.complementW)});\r\n`}}else{const s=e.associatedVariableName;switch(i.connectedPoint.type){case Mn.Vector2:t.compilationString+=this.QP(this.output,t)+` = ${s} * vec4(${i.associatedVariableName}, ${this.JP(this.complementZ)}, ${this.JP(this.complementW)});\r\n`;break;case Mn.Vector3:case Mn.Color3:t.compilationString+=this.QP(this.output,t)+` = ${s} * vec4(${i.associatedVariableName}, ${this.JP(this.complementW)});\r\n`;break;default:t.compilationString+=this.QP(this.output,t)+` = ${s} * ${i.associatedVariableName};\r\n`}}this.xyz.hasEndpoints&&(t.compilationString+=this.QP(this.xyz,t)+` = ${this.output.associatedVariableName}.xyz;\r\n`)}return this}prepareDefines(t,i,e){t.nonUniformScaling&&e.setValue("NONUNIFORMSCALING",!0)}serialize(){const t=super.serialize();return t.complementZ=this.complementZ,t.complementW=this.complementW,t}uD(t,i,e){super.uD(t,i,e),this.complementZ=void 0!==t.complementZ?t.complementZ:0,this.complementW=void 0!==t.complementW?t.complementW:1}aD(){let t=super.aD()+`${this.$P}.complementZ = ${this.complementZ};\r\n`;return t+=`${this.$P}.complementW = ${this.complementW};\r\n`,t}}v("BABYLON.TransformBlock",Gn);class zn extends kn{constructor(t){super(t,bn.Vertex,!0),this.registerInput("vector",Mn.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this.xd[0]}dD(t){for(const i of t)if(i.useLogarithmicDepth)return!0;return!1}tD(t){super.tD(t);const i=this.vector;return t.compilationString+=`gl_Position = ${i.associatedVariableName};\r\n`,this.dD(t.sharedData.fragmentOutputNodes)&&(t._P("logarithmicDepthConstant","float"),t.bP("vFragmentDepth","float"),t.compilationString+="vFragmentDepth = 1.0 + gl_Position.w;\r\n",t.compilationString+="gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;\r\n"),this}}function Hn(t,i=Nn.Boolean,e="PROPERTIES",s){return(n,r)=>{let h=n.pD;h||(h=[],n.pD=h),h.push({propertyName:r,displayName:t,type:i,groupName:e,options:null!=s?s:{}})}}v("BABYLON.VertexOutputBlock",zn),function(t){t[t.Boolean=0]="Boolean",t[t.Float=1]="Float",t[t.Int=2]="Int",t[t.Vector2=3]="Vector2",t[t.List=4]="List"}(Nn||(Nn={}));class Xn extends kn{constructor(t){super(t,bn.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",Mn.Color4,!0),this.registerInput("rgb",Mn.AutoDetect,!0),this.registerInput("a",Mn.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Vector3|Mn.Float)}getClassName(){return"FragmentOutputBlock"}initialize(t){t.AP("logarithmicDepthConstant"),t.AP("vFragmentDepth")}get rgba(){return this.xd[0]}get rgb(){return this.xd[1]}get a(){return this.xd[2]}prepareDefines(t,i,e){e.setValue(this.mD,this.convertToLinearSpace,!0),e.setValue(this.vD,this.convertToGammaSpace,!0)}bind(t,i,e){this.useLogarithmicDepth&&e&&Fs.BindLogDepth(void 0,t,e.getScene())}tD(t){super.tD(t);const i=this.rgba,e=this.rgb,s=this.a;t.sharedData.hints.needAlphaBlending=i.isConnected||s.isConnected,t.sharedData.blocksWithDefines.push(this),this.useLogarithmicDepth&&(t._P("logarithmicDepthConstant","float"),t.bP("vFragmentDepth","float"),t.sharedData.bindableBlocks.push(this)),this.mD=t.EP("CONVERTTOLINEAR"),this.vD=t.EP("CONVERTTOGAMMA");const n=`//${this.name}`;if(t.IP("helperFunctions",n),i.connectedPoint)s.isConnected?t.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}.rgb, ${s.associatedVariableName});\r\n`:t.compilationString+=`gl_FragColor = ${i.associatedVariableName};\r\n`;else if(e.connectedPoint){let i="1.0";s.connectedPoint&&(i=s.associatedVariableName),e.connectedPoint.type===Mn.Float?t.compilationString+=`gl_FragColor = vec4(${e.associatedVariableName}, ${e.associatedVariableName}, ${e.associatedVariableName}, ${i});\r\n`:t.compilationString+=`gl_FragColor = vec4(${e.associatedVariableName}, ${i});\r\n`}else t.sharedData.checks.notConnectedNonOptionalInputs.push(i);return t.compilationString+=`#ifdef ${this.mD}\r\n`,t.compilationString+="gl_FragColor = toLinearSpace(gl_FragColor);\r\n",t.compilationString+="#endif\r\n",t.compilationString+=`#ifdef ${this.vD}\r\n`,t.compilationString+="gl_FragColor = toGammaSpace(gl_FragColor);\r\n",t.compilationString+="#endif\r\n",this.useLogarithmicDepth&&(t.compilationString+="gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;\r\n"),this}aD(){let t=super.aD();return t+=`${this.$P}.convertToGammaSpace = ${this.convertToGammaSpace};\r\n`,t+=`${this.$P}.convertToLinearSpace = ${this.convertToLinearSpace};\r\n`,t+=`${this.$P}.useLogarithmicDepth = ${this.useLogarithmicDepth};\r\n`,t}serialize(){const t=super.serialize();return t.convertToGammaSpace=this.convertToGammaSpace,t.convertToLinearSpace=this.convertToLinearSpace,t.useLogarithmicDepth=this.useLogarithmicDepth,t}uD(t,i,e){var s;super.uD(t,i,e),this.convertToGammaSpace=t.convertToGammaSpace,this.convertToLinearSpace=t.convertToLinearSpace,this.useLogarithmicDepth=null!==(s=t.useLogarithmicDepth)&&void 0!==s&&s}}ut([Hn("Convert to gamma space",Nn.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Xn.prototype,"convertToGammaSpace",void 0),ut([Hn("Convert to linear space",Nn.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Xn.prototype,"convertToLinearSpace",void 0),ut([Hn("Use logarithmic depth",Nn.Boolean,"PROPERTIES")],Xn.prototype,"useLogarithmicDepth",void 0),v("BABYLON.FragmentOutputBlock",Xn),function(t){t[t.Uniform=0]="Uniform",t[t.Attribute=1]="Attribute",t[t.Varying=2]="Varying",t[t.Undefined=3]="Undefined"}(Pn||(Pn={})),function(t){t[t.World=1]="World",t[t.View=2]="View",t[t.Projection=3]="Projection",t[t.ViewProjection=4]="ViewProjection",t[t.WorldView=5]="WorldView",t[t.WorldViewProjection=6]="WorldViewProjection",t[t.CameraPosition=7]="CameraPosition",t[t.FogColor=8]="FogColor",t[t.DeltaTime=9]="DeltaTime",t[t.CameraParameters=10]="CameraParameters",t[t.MaterialAlpha=11]="MaterialAlpha"}(Dn||(Dn={}));!function(t){t[t.None=0]="None",t[t.Time=1]="Time",t[t.RealTime=2]="RealTime"}(Ln||(Ln={}));const Wn={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},$n={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},Yn={particle_texturemask:!0};class jn extends kn{constructor(t,i=bn.Vertex,e=Mn.AutoDetect){super(t,i,!1,!0),this.uA=Pn.Undefined,this.gD=Ln.None,this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this.SD=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new h,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.BP=e,this.setDefaultValue(),this.registerOutput("output",e)}get type(){if(this.BP===Mn.AutoDetect){if(this.isUniform&&null!=this.value){if(!isNaN(this.value))return this.BP=Mn.Float,this.BP;switch(this.value.getClassName()){case"Vector2":return this.BP=Mn.Vector2,this.BP;case"Vector3":return this.BP=Mn.Vector3,this.BP;case"Vector4":return this.BP=Mn.Vector4,this.BP;case"Color3":return this.BP=Mn.Color3,this.BP;case"Color4":return this.BP=Mn.Color4,this.BP;case"Matrix":return this.BP=Mn.Matrix,this.BP}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this.BP=Mn.Vector3,this.BP;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this.BP=Mn.Vector2,this.BP;case"matricesIndices":case"matricesWeights":case"world0":case"world1":case"world2":case"world3":case"tangent":return this.BP=Mn.Vector4,this.BP;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this.BP=Mn.Color4,this.BP}if(this.isSystemValue)switch(this.SD){case Dn.World:case Dn.WorldView:case Dn.WorldViewProjection:case Dn.View:case Dn.ViewProjection:case Dn.Projection:return this.BP=Mn.Matrix,this.BP;case Dn.CameraPosition:return this.BP=Mn.Vector3,this.BP;case Dn.FogColor:return this.BP=Mn.Color3,this.BP;case Dn.DeltaTime:case Dn.MaterialAlpha:return this.BP=Mn.Float,this.BP;case Dn.CameraParameters:return this.BP=Mn.Vector4,this.BP}}return this.BP}validateBlockName(t){return!!this.isAttribute||super.validateBlockName(t)}get output(){return this.YP[0]}setAsAttribute(t){return this.uA=Pn.Attribute,t&&(this.name=t),this}setAsSystemValue(t){return this.systemValue=t,this}get value(){return this.ED}set value(t){this.type===Mn.Float&&(this.isBoolean?t=t?1:0:this.min!==this.max&&(t=Math.max(this.min,t),t=Math.min(this.max,t))),this.ED=t,this.uA=Pn.Uniform,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this.AD}set valueCallback(t){this.AD=t,this.uA=Pn.Uniform}get associatedVariableName(){return this.zP}set associatedVariableName(t){this.zP=t}get animationType(){return this.gD}set animationType(t){this.gD=t}get isUndefined(){return this.uA===Pn.Undefined}get isUniform(){return this.uA===Pn.Uniform}set isUniform(t){this.uA=t?Pn.Uniform:Pn.Undefined,this.associatedVariableName=""}get isAttribute(){return this.uA===Pn.Attribute}set isAttribute(t){this.uA=t?Pn.Attribute:Pn.Undefined,this.associatedVariableName=""}get isVarying(){return this.uA===Pn.Varying}set isVarying(t){this.uA=t?Pn.Varying:Pn.Undefined,this.associatedVariableName=""}get isSystemValue(){return null!=this.SD}get systemValue(){return this.SD}set systemValue(t){this.uA=Pn.Uniform,this.associatedVariableName="",this.SD=t}getClassName(){return"InputBlock"}animate(t){switch(this.gD){case Ln.Time:this.type===Mn.Float&&(this.value+=.01*t.getAnimationRatio());break;case Ln.RealTime:this.type===Mn.Float&&(this.value=(bt.Now-t.getEngine().startTime)/1e3)}}CD(t){return"!"===t[0]?`#ifndef ${t.substring(1)}\r\n`:`#ifdef ${t}\r\n`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case Mn.Float:this.value=0;break;case Mn.Vector2:this.value=C.Zero();break;case Mn.Vector3:this.value=w.Zero();break;case Mn.Vector4:this.value=x.Zero();break;case Mn.Color3:this.value=_.White();break;case Mn.Color4:this.value=new y(1,1,1,1);break;case Mn.Matrix:this.value=R.Identity()}}wD(t){switch(this.type){case Mn.Float:return`${t.yP(this.value)}`;case Mn.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case Mn.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case Mn.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case Mn.Color3:return N.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&N.Color3[0].toGammaSpaceToRef(N.Color3[0]),this.convertToLinearSpace&&N.Color3[0].toLinearSpaceToRef(N.Color3[0]),`vec3(${N.Color3[0].r}, ${N.Color3[0].g}, ${N.Color3[0].b})`;case Mn.Color4:return N.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&N.Color4[0].toGammaSpaceToRef(N.Color4[0]),this.convertToLinearSpace&&N.Color4[0].toLinearSpaceToRef(N.Color4[0]),`vec4(${N.Color4[0].r}, ${N.Color4[0].g}, ${N.Color4[0].b}, ${N.Color4[0].a})`}return""}get rD(){return $n[this.name]}xD(t,i){var e;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=t.SP("u_"+this.name)),this.isConstant){if(-1!==t.constants.indexOf(this.associatedVariableName))return;return t.constants.push(this.associatedVariableName),void(t.uP+=this.QP(this.output,t)+` = ${this.wD(t)};\r\n`)}if(-1!==t.uniforms.indexOf(this.associatedVariableName))return;t.uniforms.push(this.associatedVariableName),i&&(t.cP+=this.CD(i)),t.cP+=`uniform ${t.wP(this.type)} ${this.associatedVariableName};\r\n`,i&&(t.cP+="#endif\r\n");const e=t.sharedData.hints;if(null!==this.SD&&void 0!==this.SD)switch(this.SD){case Dn.WorldView:e.needWorldViewMatrix=!0;break;case Dn.WorldViewProjection:e.needWorldViewProjectionMatrix=!0}else this.gD!==Ln.None&&t.sharedData.animatedInputs.push(this)}else if(this.isAttribute){if(this.associatedVariableName=null!==(e=Wn[this.name])&&void 0!==e?e:this.name,this.target===bn.Vertex&&t.sD)return void($n[this.name]?Yn[this.name]?t._P(this.associatedVariableName,t.wP(this.type),i):t.bP(this.associatedVariableName,t.wP(this.type),i):this.xD(t.sD,i));if(-1!==t.attributes.indexOf(this.associatedVariableName))return;t.attributes.push(this.associatedVariableName),$n[this.name]?Yn[this.name]?t._P(this.associatedVariableName,t.wP(this.type),i):t.bP(this.associatedVariableName,t.wP(this.type),i):(i&&(t.lP+=this.CD(i)),t.lP+=`attribute ${t.wP(this.type)} ${this.associatedVariableName};\r\n`,i&&(t.lP+="#endif\r\n"))}}TD(t,i,e,s){if(!this.SD)return;const n=this.associatedVariableName;switch(this.SD){case Dn.World:t.setMatrix(n,i);break;case Dn.WorldView:t.setMatrix(n,e);break;case Dn.WorldViewProjection:t.setMatrix(n,s)}}RD(t,i,e){if(this.isAttribute)return;const s=this.associatedVariableName;if(this.SD){switch(this.SD){case Dn.World:case Dn.WorldView:case Dn.WorldViewProjection:return;case Dn.View:t.setMatrix(s,i.getViewMatrix());break;case Dn.Projection:t.setMatrix(s,i.getProjectionMatrix());break;case Dn.ViewProjection:t.setMatrix(s,i.getTransformMatrix());break;case Dn.CameraPosition:i.bindEyePosition(t,s,!0);break;case Dn.FogColor:t.setColor3(s,i.fogColor);break;case Dn.DeltaTime:t.setFloat(s,i.deltaTime/1e3);break;case Dn.CameraParameters:i.activeCamera&&t.setFloat4(s,i.getEngine().hasOriginBottomLeft?-1:1,i.activeCamera.minZ,i.activeCamera.maxZ,1/i.activeCamera.maxZ);break;case Dn.MaterialAlpha:t.setFloat(s,e.alpha)}return}const n=this.AD?this.AD():this.ED;if(null!==n)switch(this.type){case Mn.Float:t.setFloat(s,n);break;case Mn.Int:t.setInt(s,n);break;case Mn.Color3:N.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&N.Color3[0].toGammaSpaceToRef(N.Color3[0]),this.convertToLinearSpace&&N.Color3[0].toLinearSpaceToRef(N.Color3[0]),t.setColor3(s,N.Color3[0]);break;case Mn.Color4:N.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&N.Color4[0].toGammaSpaceToRef(N.Color4[0]),this.convertToLinearSpace&&N.Color4[0].toLinearSpaceToRef(N.Color4[0]),t.setDirectColor4(s,N.Color4[0]);break;case Mn.Vector2:t.setVector2(s,n);break;case Mn.Vector3:t.setVector3(s,n);break;case Mn.Vector4:t.setVector4(s,n);break;case Mn.Matrix:t.setMatrix(s,n)}}tD(t){super.tD(t),(this.isUniform||this.isSystemValue)&&t.sharedData.inputBlocks.push(this),this.xD(t)}aD(){const t=this.$P;if(this.isAttribute)return super.aD()+`${t}.setAsAttribute("${this.name}");\r\n`;if(this.isSystemValue)return super.aD()+`${t}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${Dn[this.SD]});\r\n`;if(this.isUniform){const i=[];let e="";switch(this.type){case Mn.Float:e=`${this.value}`;break;case Mn.Vector2:e=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case Mn.Vector3:e=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case Mn.Vector4:e=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case Mn.Color3:e=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(e+=".toGammaSpace()"),this.convertToLinearSpace&&(e+=".toLinearSpace()");break;case Mn.Color4:e=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(e+=".toGammaSpace()"),this.convertToLinearSpace&&(e+=".toLinearSpace()");break;case Mn.Matrix:e=`BABYLON.Matrix.FromArray([${this.value.m}])`}return i.push(`${t}.value = ${e}`),this.type===Mn.Float&&i.push(`${t}.min = ${this.min}`,`${t}.max = ${this.max}`,`${t}.isBoolean = ${this.isBoolean}`,`${t}.matrixMode = ${this.matrixMode}`,`${t}.animationType = BABYLON.AnimatedInputBlockTypes.${Ln[this.animationType]}`),i.push(`${t}.isConstant = ${this.isConstant}`),i.push(""),super.aD()+i.join(";\r\n")}return super.aD()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const t=super.serialize();return t.type=this.type,t.mode=this.uA,t.systemValue=this.SD,t.animationType=this.gD,t.min=this.min,t.max=this.max,t.isBoolean=this.isBoolean,t.matrixMode=this.matrixMode,t.isConstant=this.isConstant,t.groupInInspector=this.groupInInspector,t.convertToGammaSpace=this.convertToGammaSpace,t.convertToLinearSpace=this.convertToLinearSpace,null!=this.ED&&this.uA===Pn.Uniform&&(this.ED.asArray?(t.valueType="BABYLON."+this.ED.getClassName(),t.value=this.ED.asArray()):(t.valueType="number",t.value=this.ED)),t}uD(t,i,e){if(this.uA=t.mode,super.uD(t,i,e),this.BP=t.type,this.SD=t.systemValue||t.wellKnownValue,this.gD=t.animationType,this.min=t.min||0,this.max=t.max||0,this.isBoolean=!!t.isBoolean,this.matrixMode=t.matrixMode||0,this.isConstant=!!t.isConstant,this.groupInInspector=t.groupInInspector||"",this.convertToGammaSpace=!!t.convertToGammaSpace,this.convertToLinearSpace=!!t.convertToLinearSpace,"tangent"===t.name&&t.mode===Pn.Attribute&&t.type===Mn.Vector3&&(this.BP=Mn.Vector4),t.valueType)if("number"===t.valueType)this.ED=t.value;else{const i=g(t.valueType);i&&(this.ED=i.FromArray(t.value))}}}v("BABYLON.InputBlock",jn);class Kn extends kn{constructor(t){super(t,bn.VertexAndFragment),this.ID="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.WP=!1,this.registerInput("uv",Mn.AutoDetect,!1,bn.VertexAndFragment),this.registerOutput("rgba",Mn.Color4,bn.Neutral),this.registerOutput("rgb",Mn.Color3,bn.Neutral),this.registerOutput("r",Mn.Float,bn.Neutral),this.registerOutput("g",Mn.Float,bn.Neutral),this.registerOutput("b",Mn.Float,bn.Neutral),this.registerOutput("a",Mn.Float,bn.Neutral),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Vector2|Mn.Vector3|Mn.Vector4),this.xd[0].VP=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this.xd[0]}get rgba(){return this.YP[0]}get rgb(){return this.YP[1]}get r(){return this.YP[2]}get g(){return this.YP[3]}get b(){return this.YP[4]}get a(){return this.YP[5]}initialize(t){t.AP("textureSampler")}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?bn.VertexAndFragment:bn.Fragment:bn.VertexAndFragment}prepareDefines(t,i,e){e.setValue(this.mD,this.convertToGammaSpace,!0),e.setValue(this.vD,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}MD(t){const i=this.uv;if(i.connectedPoint.ownerBlock.isInput){i.connectedPoint.ownerBlock.isAttribute||t._P(i.associatedVariableName,"vec2")}if(this.bD="vMain"+i.associatedVariableName,t.bP(this.bD,"vec2"),t.compilationString+=`${this.bD} = ${i.associatedVariableName}.xy;\r\n`,this.YP.some((t=>t.isConnectedInVertexShader))){this._D(t,!0);for(const i of this.YP)i.hasEndpoints&&this.yD(t,i,i.name,!0)}}_D(t,i=!1){const e=this.uv;if(i){if(t.target===bn.Fragment)return;t.compilationString+=`vec4 ${this.ND} = texture2D(${this.ID}, ${e.associatedVariableName});\r\n`}else this.uv.ownerBlock.target!==bn.Fragment?t.compilationString+=`vec4 ${this.ND} = texture2D(${this.ID}, ${this.bD});\r\n`:t.compilationString+=`vec4 ${this.ND} = texture2D(${this.ID}, ${e.associatedVariableName});\r\n`}yD(t,i,e,s=!1){if(s){if(t.target===bn.Fragment)return;t.compilationString+=`${this.QP(i,t)} = ${this.ND}.${e};\r\n`}else this.uv.ownerBlock.target!==bn.Fragment?(t.compilationString+=`${this.QP(i,t)} = ${this.ND}.${e};\r\n`,t.compilationString+=`#ifdef ${this.mD}\r\n`,t.compilationString+=`${i.associatedVariableName} = toGammaSpace(${i.associatedVariableName});\r\n`,t.compilationString+="#endif\r\n",t.compilationString+=`#ifdef ${this.vD}\r\n`,t.compilationString+=`${i.associatedVariableName} = toLinearSpace(${i.associatedVariableName});\r\n`,t.compilationString+="#endif\r\n"):t.compilationString+=`${this.QP(i,t)} = ${this.ND}.${e};\r\n`}tD(t){if(super.tD(t),this.ND=t.SP("tempTextureRead"),t.sharedData.blockingBlocks.indexOf(this)<0&&t.sharedData.blockingBlocks.push(this),t.sharedData.textureBlocks.indexOf(this)<0&&t.sharedData.textureBlocks.push(this),t.sharedData.blocksWithDefines.indexOf(this)<0&&t.sharedData.blocksWithDefines.push(this),t.target!==bn.Fragment)return t.CP(this.ID),void this.MD(t);if(!this.YP.some((t=>t.isConnectedInFragmentShader)))return;t.CP(this.ID),this.mD=t.EP("ISLINEAR"),this.vD=t.EP("ISGAMMA");const i=`//${this.name}`;t.IP("helperFunctions",i),this._D(t);for(const i of this.YP)i.hasEndpoints&&this.yD(t,i,i.name);return this}serialize(){const t=super.serialize();return t.convertToGammaSpace=this.convertToGammaSpace,t.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(t.texture=this.texture.serialize()),t}uD(t,i,e){super.uD(t,i,e),this.convertToGammaSpace=t.convertToGammaSpace,this.convertToLinearSpace=!!t.convertToLinearSpace,t.texture&&(e=0===t.texture.url.indexOf("data:")?"":e,this.texture=an.Parse(t.texture,i,e))}}v("BABYLON.CurrentScreenBlock",Kn);class qn extends kn{constructor(t){super(t,bn.Fragment),this.ID="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.WP=!1,this.registerInput("uv",Mn.AutoDetect,!1,bn.VertexAndFragment),this.registerOutput("rgba",Mn.Color4,bn.Neutral),this.registerOutput("rgb",Mn.Color3,bn.Neutral),this.registerOutput("r",Mn.Float,bn.Neutral),this.registerOutput("g",Mn.Float,bn.Neutral),this.registerOutput("b",Mn.Float,bn.Neutral),this.registerOutput("a",Mn.Float,bn.Neutral),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Vector2|Mn.Vector3|Mn.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this.xd[0]}get rgba(){return this.YP[0]}get rgb(){return this.YP[1]}get r(){return this.YP[2]}get g(){return this.YP[3]}get b(){return this.YP[4]}get a(){return this.YP[5]}initialize(t){t.AP("diffuseSampler")}autoConfigure(t){if(!this.uv.isConnected){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"particle_uv"===t.name));i||(i=new jn("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(t,i,e){e.setValue(this.mD,this.convertToGammaSpace,!0),e.setValue(this.vD,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}yD(t,i,e){t.compilationString+=`${this.QP(i,t)} = ${this.ND}.${e};\r\n`,t.compilationString+=`#ifdef ${this.mD}\r\n`,t.compilationString+=`${i.associatedVariableName} = toGammaSpace(${i.associatedVariableName});\r\n`,t.compilationString+="#endif\r\n",t.compilationString+=`#ifdef ${this.vD}\r\n`,t.compilationString+=`${i.associatedVariableName} = toLinearSpace(${i.associatedVariableName});\r\n`,t.compilationString+="#endif\r\n"}tD(t){if(super.tD(t),t.target===bn.Vertex)return;this.ND=t.SP("tempTextureRead"),t.CP(this.ID),t.sharedData.blockingBlocks.push(this),t.sharedData.textureBlocks.push(this),t.sharedData.blocksWithDefines.push(this),this.mD=t.EP("ISLINEAR"),this.vD=t.EP("ISGAMMA");const i=`//${this.name}`;t.IP("helperFunctions",i),t.compilationString+=`vec4 ${this.ND} = texture2D(${this.ID}, ${this.uv.associatedVariableName});\r\n`;for(const i of this.YP)i.hasEndpoints&&this.yD(t,i,i.name);return this}serialize(){const t=super.serialize();return t.convertToGammaSpace=this.convertToGammaSpace,t.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(t.texture=this.texture.serialize()),t}uD(t,i,e){super.uD(t,i,e),this.convertToGammaSpace=t.convertToGammaSpace,this.convertToLinearSpace=!!t.convertToLinearSpace,t.texture&&(e=0===t.texture.url.indexOf("data:")?"":e,this.texture=an.Parse(t.texture,i,e))}}v("BABYLON.ParticleTextureBlock",qn);class Qn extends kn{constructor(t){super(t,bn.Fragment),this.WP=!0,this.registerInput("color",Mn.Color4,!1,bn.Fragment),this.registerOutput("rampColor",Mn.Color4,bn.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this.xd[0]}get rampColor(){return this.YP[0]}initialize(t){t.AP("remapRanges"),t.AP("rampSampler"),t.AP("baseColor"),t.AP("alpha"),t.AP("remappedColorIndex"),t.AP("rampColor"),t.AP("finalAlpha")}tD(t){if(super.tD(t),t.target!==bn.Vertex)return t.CP("rampSampler"),t.bP("remapRanges","vec4","RAMPGRADIENT"),t.compilationString+=`\n            #ifdef RAMPGRADIENT\n                vec4 baseColor = ${this.color.associatedVariableName};\n                float alpha = ${this.color.associatedVariableName}.a;\n\n                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);\n\n                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));\n                baseColor.rgb *= rampColor.rgb;\n\n                // Remapped alpha\n                float finalAlpha = baseColor.a;\n                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);\n\n                ${this.QP(this.rampColor,t)} = baseColor;\n            #else\n                ${this.QP(this.rampColor,t)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}v("BABYLON.ParticleRampGradientBlock",Qn);class Zn extends kn{constructor(t){super(t,bn.Fragment),this.WP=!0,this.registerInput("color",Mn.Color4,!1,bn.Fragment),this.registerInput("alphaTexture",Mn.Float,!1,bn.Fragment),this.registerInput("alphaColor",Mn.Float,!1,bn.Fragment),this.registerOutput("blendColor",Mn.Color4,bn.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this.xd[0]}get alphaTexture(){return this.xd[1]}get alphaColor(){return this.xd[2]}get blendColor(){return this.YP[0]}initialize(t){t.AP("sourceAlpha")}tD(t){if(super.tD(t),t.target!==bn.Vertex)return t.compilationString+=`\n            #ifdef BLENDMULTIPLYMODE\n                ${this.QP(this.blendColor,t)};\n                float sourceAlpha = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};\n                ${this.blendColor.associatedVariableName}.rgb = ${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);\n                ${this.blendColor.associatedVariableName}.a = ${this.color.associatedVariableName}.a;\n            #else\n                ${this.QP(this.blendColor,t)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}v("BABYLON.ParticleBlendMultiplyBlock",Zn);class Jn{constructor(){this.PD={},this.DD=32,this.LD=-1,this.fC=null}unBindMesh(){this.fC=null}addFallback(t,i){this.PD[t]||(t<this.DD&&(this.DD=t),t>this.LD&&(this.LD=t),this.PD[t]=new Array),this.PD[t].push(i)}addCPUSkinningFallback(t,i){this.fC=i,t<this.DD&&(this.DD=t),t>this.LD&&(this.LD=t)}get hasMoreFallbacks(){return this.DD<=this.LD}reduce(t,i){if(this.fC&&this.fC.computeBonesUsingShaders&&this.fC.numBoneInfluencers>0){this.fC.computeBonesUsingShaders=!1,t=t.replace("#define NUM_BONE_INFLUENCERS "+this.fC.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),i.ps=!0;const e=this.fC.getScene();for(let t=0;t<e.meshes.length;t++){const s=e.meshes[t];if(s.material){if(s.computeBonesUsingShaders&&0!==s.numBoneInfluencers)if(s.material.getEffect()===i)s.computeBonesUsingShaders=!1;else if(s.subMeshes)for(const t of s.subMeshes){if(t.effect===i){s.computeBonesUsingShaders=!1;break}}}else!this.fC.material&&s.computeBonesUsingShaders&&s.numBoneInfluencers>0&&(s.computeBonesUsingShaders=!1)}}else{const i=this.PD[this.DD];if(i)for(let e=0;e<i.length;e++)t=t.replace("#define "+i[e],"");this.DD++}return t}}const tr="postprocessVertexShader",ir="attribute vec2 position;\nuniform vec2 scale;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[tr]=ir;class er{constructor(t,i,e,s){this.sx=null,this.dw=1,this.OD=null,this.FD=!1,this.BD=!1,this.jo=!1,this.UD=t,this.Xb=i,this.Qn=e,this.Ls=s,this.Yo=null}get depthStencilTexture(){return this.Yo}get depthStencilTextureWithStencil(){return this.jo}get isCube(){return this.Xb}get isMulti(){return this.UD}get is2DArray(){return this.layers>0}get size(){return this.width}get width(){return this.Qn.width||this.Qn}get height(){return this.Qn.height||this.Qn}get layers(){return this.Qn.layers||0}get texture(){var t,i;return null!==(i=null===(t=this.sx)||void 0===t?void 0:t[0])&&void 0!==i?i:null}get textures(){return this.sx}get samples(){return this.dw}setSamples(t,i=!0,e=!1){if(this.samples===t&&!e)return t;const s=this.UD?this.Ls.updateMultipleRenderTargetTextureSampleCount(this,t,i):this.Ls.updateRenderTargetTextureSampleCount(this,t);return this.dw=t,s}setTextures(t){Array.isArray(t)?this.sx=t:this.sx=t?[t]:null}setTexture(t,i=0,e=!0){this.sx||(this.sx=[]),this.sx[i]&&e&&this.sx[i].dispose(),this.sx[i]=t}createDepthStencilTexture(t=0,i=!0,e=!1,s=1,n=14){var r;return null===(r=this.Yo)||void 0===r||r.dispose(),this.jo=e,this.Yo=this.Ls.createDepthStencilTexture(this.Qn,{bilinearFiltering:i,comparisonFunction:t,generateStencil:e,isCube:this.Xb,samples:s,depthTextureFormat:n},this),this.Yo}VD(t){this.Yo&&(t.Yo&&t.Yo.dispose(),t.Yo=this.Yo,this.Yo.incrementReferences())}_r(t){this.texture&&this.texture._r(t),this.sx=null,this.dispose(!0)}kD(){var t,i,e,s,n,r;let h=null;if(this.UD){const t=this.textures;if(t&&t.length>0){let i=!1,e=t.length;const s=t[t.length-1].$n;s!==oi.Depth&&s!==oi.DepthStencil||(i=!0,e--);const n=[],r=[];for(let i=0;i<e;++i){const e=t[i];n.push(e.samplingMode),r.push(e.type)}const o={samplingModes:n,generateMipMaps:t[0].generateMipMaps,generateDepthBuffer:this.BD,generateStencilBuffer:this.FD,generateDepthTexture:i,types:r,textureCount:e},a={width:this.width,height:this.height};h=this.Ls.createMultipleRenderTarget(a,o)}}else{const o={};if(o.generateDepthBuffer=this.BD,o.generateMipMaps=null!==(i=null===(t=this.texture)||void 0===t?void 0:t.generateMipMaps)&&void 0!==i&&i,o.generateStencilBuffer=this.FD,o.samplingMode=null===(e=this.texture)||void 0===e?void 0:e.samplingMode,o.type=null===(s=this.texture)||void 0===s?void 0:s.type,o.format=null===(n=this.texture)||void 0===n?void 0:n.format,this.isCube)h=this.Ls.createRenderTargetCubeTexture(this.width,o);else{const t={width:this.width,height:this.height,layers:this.is2DArray?null===(r=this.texture)||void 0===r?void 0:r.depth:void 0};h=this.Ls.createRenderTargetTexture(t,o)}h.texture.isReady=!0}return h}GD(t){if(this.sx&&t.sx)for(let i=0;i<this.sx.length;++i)this.sx[i]._r(t.sx[i],!1),t.sx[i].isReady=!0;this.Yo&&t.Yo&&(this.Yo._r(t.Yo),t.Yo.isReady=!0),this.sx=null,this.Yo=null}br(){const t=this.kD();if(t){if(this.Yo){const i=this.Yo.samplingMode,e=2===i||3===i||11===i;t.createDepthStencilTexture(this.Yo.Hn,e,this.jo,this.Yo.samples)}this.samples>1&&t.setSamples(this.samples),t.GD(this),t.dispose()}}releaseTextures(){var t,i;if(this.sx)for(let e=0;null!==(i=e<(null===(t=this.sx)||void 0===t?void 0:t.length))&&void 0!==i&&i;++e)this.sx[e].dispose();this.sx=null}dispose(t=!1){var i;t||(null===(i=this.Yo)||void 0===i||i.dispose(),this.Yo=null,this.releaseTextures()),this.Ls.ja(this)}}class sr extends er{constructor(t,i,e,s,n){super(t,i,e,s),this.$o=null,this.zD=null,this.Wo=null,this.HD=null,this.XD=null,this.zr=n}kD(){let t=null;return this.HD&&this.XD?(t=this.Ls.createMultiviewRenderTargetTexture(this.width,this.height),t.texture.isReady=!0):t=super.kD(),t}GD(t){super.GD(t),t.$o=this.$o,t.zD=this.zD,t.Wo=this.Wo,t.HD=this.HD,t.XD=this.XD,this.$o=this.zD=this.Wo=this.HD=this.XD=null}VD(t){super.VD(t);const i=this.zr,e=this.zD,s=t.Wo||t.$o;t.zD&&i.deleteRenderbuffer(t.zD),t.zD=this.zD,this.Ls.Xo(s),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,e),this.Ls.Xo(null)}WD(t,i=0,e=-1,s=0){if(!t.Er)return;const n=this.zr,r=this.$o,h=this.Ls.Lh;this.Ls.Xo(r);const o=n[this.Ls.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],a=-1!==e?n.TEXTURE_CUBE_MAP_POSITIVE_X+e:n.TEXTURE_2D;n.framebufferTexture2D(n.FRAMEBUFFER,o,a,t.Er.underlyingResource,s),this.Ls.Xo(h)}setTexture(t,i=0,e=!0){super.setTexture(t,i,e),this.WD(t,i)}dispose(t=!1){const i=this.zr;t||(this.HD&&(this.zr.deleteTexture(this.HD),this.HD=null),this.XD&&(this.zr.deleteTexture(this.XD),this.XD=null)),this.$o&&(i.deleteFramebuffer(this.$o),this.$o=null),this.zD&&(i.deleteRenderbuffer(this.zD),this.zD=null),this.Wo&&(i.deleteFramebuffer(this.Wo),this.Wo=null),super.dispose(t)}}Ei.prototype.$D=function(t,i,e){const s=new sr(t,i,e,this,this.lo);return this.Ih.push(s),s},Ei.prototype.createRenderTargetTexture=function(t,i){var e,s;const n=this.$D(!1,!1,t);let r,h=!0,o=!1,a=!1,l=1;void 0!==i&&"object"==typeof i&&(h=null===(e=i.generateDepthBuffer)||void 0===e||e,o=!!i.generateStencilBuffer,a=!!i.noColorAttachment,r=i.colorAttachment,l=null!==(s=i.samples)&&void 0!==s?s:1);const c=r||(a?null:this.Ta(t,i,!0,oi.RenderTarget)),u=t.width||t,f=t.height||t,d=this.Lh,p=this.lo,m=p.createFramebuffer();return this.Xo(m),n.zD=this.Xa(o,h,u,f),c&&!c.is2DArray&&p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,c.Er.underlyingResource,0),this.Xo(d),n.$o=m,n.BD=h,n.FD=o,n.setTextures(c),this.updateRenderTargetTextureSampleCount(n,l),n},Ei.prototype.createDepthStencilTexture=function(t,i,e){if(i.isCube){const s=t.width||t;return this.YD(s,i,e)}return this.jD(t,i,e)},Ei.prototype.jD=function(t,i,e){const s=this.lo,n=t.layers||0,r=0!==n?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,h=new ai(this,oi.DepthStencil);if(!this.po.depthTextureExtension)return F.Error("Depth texture is not supported by your browser or hardware."),h;const o={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...i};if(this.qo(r,h,!0),this.Va(h,t,o.generateStencil,0!==o.comparisonFunction&&o.bilinearFiltering,o.comparisonFunction,o.samples),void 0!==o.depthTextureFormat){if(15!==o.depthTextureFormat&&16!==o.depthTextureFormat&&17!==o.depthTextureFormat&&13!==o.depthTextureFormat&&14!==o.depthTextureFormat&&18!==o.depthTextureFormat)return F.Error("Depth texture format is not supported."),h;h.format=o.depthTextureFormat}else h.format=o.generateStencil?13:16;const a=17===h.format||13===h.format||18===h.format;e.Yo=h,e.jo=a;let l=s.UNSIGNED_INT;15===h.format?l=s.UNSIGNED_SHORT:17===h.format||13===h.format?l=s.UNSIGNED_INT_24_8:14===h.format?l=s.FLOAT:18===h.format&&(l=s.FLOAT_32_UNSIGNED_INT_24_8_REV);const c=a?s.DEPTH_STENCIL:s.DEPTH_COMPONENT;let u=c;this.webGLVersion>1&&(15===h.format?u=s.DEPTH_COMPONENT16:16===h.format?u=s.DEPTH_COMPONENT24:17===h.format||13===h.format?u=s.DEPTH24_STENCIL8:14===h.format?u=s.DEPTH_COMPONENT32F:18===h.format&&(u=s.DEPTH32F_STENCIL8)),h.is2DArray?s.texImage3D(r,0,u,h.width,h.height,n,0,c,l,null):s.texImage2D(r,0,u,h.width,h.height,0,c,l,null),this.qo(r,null),this.Rh.push(h);const f=e;if(f.zD){const t=this.Lh;this.Xo(f.$o),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,null),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,null),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.STENCIL_ATTACHMENT,s.RENDERBUFFER,null),this.Xo(t),s.deleteRenderbuffer(f.zD),f.zD=null}return h},Ei.prototype.updateRenderTargetTextureSampleCount=function(t,i){if(this.webGLVersion<2||!t||!t.texture)return 1;if(t.samples===i)return i;const e=this.lo;i=Math.min(i,this.getCaps().maxMSAASamples),t.zD&&(e.deleteRenderbuffer(t.zD),t.zD=null),t.Wo&&(e.deleteFramebuffer(t.Wo),t.Wo=null);const s=t.texture.Er;if(s.Gr&&(e.deleteRenderbuffer(s.Gr),s.Gr=null),i>1&&e.renderbufferStorageMultisample){const n=e.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");t.Wo=n,this.Xo(t.Wo);const r=this.Wa(t.texture.width,t.texture.height,i,-1,this.nl(t.texture.type),e.COLOR_ATTACHMENT0,!1);if(!r)throw new Error("Unable to create multi sampled framebuffer");s.Gr=r}else this.Xo(t.$o);return t.texture.samples=i,t.dw=i,t.zD=this.Xa(t.FD,t.BD,t.texture.width,t.texture.height,i),this.Xo(null),i};class nr{constructor(t,i,e,s,n,r,o=1,a,l,c=null,u=0,f="postprocess",d,p=!1,m=5,v=qt.GLSL){this.Si=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this.Ef=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this.dw=1,this.adaptScaleToCurrentViewport=!1,this.KD=!1,this.Sv=0,this.externalTextureSamplerBinding=!1,this.sx=new zi(2),this.qD=[],this.nx=0,this.QD=new C(1,1),this.ZD=C.Zero(),this.onActivateObservable=new h,this.onSizeChangedObservable=new h,this.onApplyObservable=new h,this.onBeforeRenderObservable=new h,this.onAfterRenderObservable=new h,this.name=t,null!=r?(this.JD=r,this.Kt=r.getScene(),r.attachPostProcess(this),this.Ls=this.Kt.getEngine(),this.Kt.postProcesses.push(this),this.uniqueId=this.Kt.getUniqueId()):a&&(this.Ls=a,this.Ls.postProcesses.push(this)),this.wb=n,this.renderTargetSamplingMode=o||1,this.KD=l||!1,this.tL=u,this.iL=m,this.Vs=v,this.Ss=s||[],this.Ss.push("textureSampler"),this.eL=i,this.sL=f,this.nL=e||[],this.nL.push("scale"),this.Us=d,this.SC=new vi(this.Ls),p||this.updateEffect(c)}static RegisterShaderCodeProcessing(t,i){i?nr.rL[null!=t?t:""]=i:delete nr.rL[null!=t?t:""]}static hL(t){var i;return null!==(i=nr.rL[t])&&void 0!==i?i:nr.rL[""]}get samples(){return this.dw}set samples(t){this.dw=Math.min(t,this.Ls.getCaps().maxMSAASamples),this.sx.forEach((t=>{t.setSamples(this.dw)}))}getEffectName(){return this.eL}set onActivate(t){this.oL&&this.onActivateObservable.remove(this.oL),t&&(this.oL=this.onActivateObservable.add(t))}set onSizeChanged(t){this.aL&&this.onSizeChangedObservable.remove(this.aL),this.aL=this.onSizeChangedObservable.add(t)}set onApply(t){this.lL&&this.onApplyObservable.remove(this.lL),this.lL=this.onApplyObservable.add(t)}set onBeforeRender(t){this.qm&&this.onBeforeRenderObservable.remove(this.qm),this.qm=this.onBeforeRenderObservable.add(t)}set onAfterRender(t){this.Qm&&this.onAfterRenderObservable.remove(this.Qm),this.Qm=this.onAfterRenderObservable.add(t)}get inputTexture(){return this.sx.data[this.nx]}set inputTexture(t){this.hx=t}restoreDefaultInputTexture(){this.hx&&(this.hx=null,this.markTextureDirty())}getCamera(){return this.JD}get texelSize(){return this.cL?this.cL.texelSize:(this.hx&&this.ZD.copyFromFloats(1/this.hx.width,1/this.hx.height),this.ZD)}getClassName(){return"PostProcess"}getEngine(){return this.Ls}getEffect(){return this.SC.effect}shareOutputWith(t){return this.uL(),this.cL=t,this}useOwnOutput(){0==this.sx.length&&(this.sx=new zi(2)),this.cL=null}updateEffect(t=null,i=null,e=null,s,n,r,h,o){var a,l;const c=nr.hL(this.name);if(null==c?void 0:c.defineCustomBindings){const s=null!==(a=null==i?void 0:i.slice())&&void 0!==a?a:[];s.push(...this.nL);const n=null!==(l=null==e?void 0:e.slice())&&void 0!==l?l:[];n.push(...this.Ss),t=c.defineCustomBindings(this.name,t,s,n),i=s,e=n}this.fL=t,this.SC.effect=this.Ls.createEffect({vertex:null!=h?h:this.sL,fragment:null!=o?o:this.eL},{attributes:["position"],uniformsNames:i||this.nL,uniformBuffersNames:[],samplers:e||this.Ss,defines:null!==t?t:"",fallbacks:null,onCompiled:null!=n?n:null,onError:null!=r?r:null,indexParameters:s||this.Us,processCodeAfterIncludes:(null==c?void 0:c.processCodeAfterIncludes)?(t,i)=>c.processCodeAfterIncludes(this.name,t,i):null,processFinalCode:(null==c?void 0:c.processFinalCode)?(t,i)=>c.processFinalCode(this.name,t,i):null,shaderLanguage:this.Vs},this.Ls)}isReusable(){return this.KD}markTextureDirty(){this.width=-1}dL(t,i,e=0){for(let s=0;s<this.qD.length;s++)if(this.qD[s].texture.width===t.width&&this.qD[s].texture.height===t.height&&this.qD[s].postProcessChannel===e&&this.qD[s].texture.BD===i.generateDepthBuffer&&this.qD[s].texture.samples===i.samples)return this.qD[s].texture;const s=this.Ls.createRenderTargetTexture(t,i);return this.qD.push({texture:s,postProcessChannel:e,lastUsedRenderId:-1}),s}pL(){const t=this.Sv;for(let i=this.qD.length-1;i>=0;i--)if(t-this.qD[i].lastUsedRenderId>100){let t=!1;for(let e=0;e<this.sx.length;e++)if(this.sx.data[e]===this.qD[i].texture){t=!0;break}t||(this.qD[i].texture.dispose(),this.qD.splice(i,1))}}mL(t,i,e,s,n){this.sx.length>0&&this.sx.reset(),this.width=t,this.height=i;let r=null;for(let t=0;t<e.vf.length;t++)if(null!==e.vf[t]){r=e.vf[t];break}const h={width:this.width,height:this.height},o={generateMipMaps:s,generateDepthBuffer:n||r===this,generateStencilBuffer:(n||r===this)&&this.Ls.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this.tL,format:this.iL,samples:this.dw};this.sx.push(this.dL(h,o,0)),this.KD&&this.sx.push(this.dL(h,o,1)),this.ZD.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}activate(t,i=null,e){var s,n;const r=(t=t||this.JD).getScene(),h=r.getEngine(),o=h.getCaps().maxTextureSize;let a=(i?i.width:this.Ls.getRenderWidth(!0))*this.wb|0;const l=(i?i.height:this.Ls.getRenderHeight(!0))*this.wb|0,c=t.parent;!c||c.leftCamera!=t&&c.rightCamera!=t||(a/=2);let u=this.wb.width||a,f=this.wb.height||l;const d=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;if(!this.cL&&!this.hx){if(this.adaptScaleToCurrentViewport){const t=h.currentViewport;t&&(u*=t.width,f*=t.height)}(d||this.alwaysForcePOT)&&(this.wb.width||(u=h.needPOTTextures?Rs.GetExponentOfTwo(u,o,this.scaleMode):u),this.wb.height||(f=h.needPOTTextures?Rs.GetExponentOfTwo(f,o,this.scaleMode):f)),this.width===u&&this.height===f||this.mL(u,f,t,d,e),this.sx.forEach((t=>{t.samples!==this.samples&&this.Ls.updateRenderTargetTextureSampleCount(t,this.samples)})),this.pL(),this.Sv++}let p;if(this.cL)p=this.cL.inputTexture;else if(this.hx)p=this.hx,this.width=this.hx.width,this.height=this.hx.height;else{let t;p=this.inputTexture;for(let i=0;i<this.qD.length;i++)if(this.qD[i].texture===p){t=this.qD[i];break}t&&(t.lastUsedRenderId=this.Sv)}return this.enablePixelPerfectMode?(this.QD.copyFromFloats(a/u,l/f),this.Ls.bindFramebuffer(p,0,a,l,this.forceFullscreenViewport)):(this.QD.copyFromFloats(1,1),this.Ls.bindFramebuffer(p,0,void 0,void 0,this.forceFullscreenViewport)),null===(n=(s=this.Ls).gf)||void 0===n||n.call(s,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(t),this.autoClear&&0===this.alphaMode&&this.Ls.clear(this.clearColor?this.clearColor:r.clearColor,r.ug,!0,!0),this.KD&&(this.nx=(this.nx+1)%2),p}get isSupported(){return this.SC.effect.isSupported}get aspectRatio(){return this.cL?this.cL.aspectRatio:this.hx?this.hx.width/this.hx.height:this.width/this.height}isReady(){var t,i;return null!==(i=null===(t=this.SC.effect)||void 0===t?void 0:t.isReady())&&void 0!==i&&i}apply(){var t,i,e;if(!(null===(t=this.SC.effect)||void 0===t?void 0:t.isReady()))return null;let s;return this.Ls.enableEffect(this.SC),this.Ls.setState(!1),this.Ls.setDepthBuffer(!1),this.Ls.setDepthWrite(!1),this.Ls.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),s=this.cL?this.cL.inputTexture:this.hx?this.hx:this.inputTexture,this.externalTextureSamplerBinding||this.SC.effect.fn("textureSampler",null==s?void 0:s.texture),this.SC.effect.setVector2("scale",this.QD),this.onApplyObservable.notifyObservers(this.SC.effect),null===(e=null===(i=nr.hL(this.name))||void 0===i?void 0:i.bindCustomBindings)||void 0===e||e.call(i,this.name,this.SC.effect),this.SC.effect}uL(){this.cL||this.hx?this.vL():(this.vL(),this.sx.dispose())}vL(){for(let t=this.qD.length-1;t>=0;t--)this.qD[t].texture.dispose();this.qD.length=0}setPrePassRenderer(t){return!!this.gL&&(this.gL=t.addEffectConfiguration(this.gL),this.gL.enabled=!0,!0)}dispose(t){let i;if(t=t||this.JD,this.uL(),this.Kt&&(i=this.Kt.postProcesses.indexOf(this),-1!==i&&this.Kt.postProcesses.splice(i,1)),this.Si){const t=this.Si.postProcesses.indexOf(this);t>-1&&this.Si.postProcesses.splice(t,1),this.Si=null}if(i=this.Ls.postProcesses.indexOf(this),-1!==i&&this.Ls.postProcesses.splice(i,1),t){if(t.detachPostProcess(this),i=t.vf.indexOf(this),0===i&&t.vf.length>0){const t=this.JD.bA();t&&t.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){const t=ot.Serialize(this),i=this.getCamera()||this.Kt&&this.Kt.activeCamera;return t.customType="BABYLON."+this.getClassName(),t.cameraId=i?i.id:null,t.reusable=this.KD,t.textureType=this.tL,t.fragmentUrl=this.eL,t.parameters=this.nL,t.samplers=this.Ss,t.options=this.wb,t.defines=this.fL,t.textureFormat=this.iL,t.vertexUrl=this.sL,t.indexParameters=this.Us,t}clone(){const t=this.serialize();t.Ls=this.Ls,t.cameraId=null;const i=nr.Parse(t,this.Kt,"");return i?(i.onActivateObservable=this.onActivateObservable.clone(),i.onSizeChangedObservable=this.onSizeChangedObservable.clone(),i.onApplyObservable=this.onApplyObservable.clone(),i.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),i.onAfterRenderObservable=this.onAfterRenderObservable.clone(),i.gL=this.gL,i):null}static Parse(t,i,e){const s=g(t.customType);if(!s||!s.SL)return null;const n=i?i.getCameraById(t.cameraId):null;return s.SL(t,n,i,e)}static SL(t,i,e,s){return ot.Parse((()=>new nr(t.name,t.fragmentUrl,t.parameters,t.samplers,t.options,i,t.renderTargetSamplingMode,t.Ls,t.reusable,t.defines,t.textureType,t.vertexUrl,t.indexParameters,!1,t.textureFormat)),t,e,s)}}nr.rL={},ut([Q()],nr.prototype,"uniqueId",void 0),ut([Q()],nr.prototype,"name",void 0),ut([Q()],nr.prototype,"width",void 0),ut([Q()],nr.prototype,"height",void 0),ut([Q()],nr.prototype,"renderTargetSamplingMode",void 0),ut([nt()],nr.prototype,"clearColor",void 0),ut([Q()],nr.prototype,"autoClear",void 0),ut([Q()],nr.prototype,"alphaMode",void 0),ut([Q()],nr.prototype,"alphaConstants",void 0),ut([Q()],nr.prototype,"enablePixelPerfectMode",void 0),ut([Q()],nr.prototype,"forceFullscreenViewport",void 0),ut([Q()],nr.prototype,"scaleMode",void 0),ut([Q()],nr.prototype,"alwaysForcePOT",void 0),ut([Q("samples")],nr.prototype,"_samples",void 0),ut([Q()],nr.prototype,"adaptScaleToCurrentViewport",void 0),v("BABYLON.PostProcess",nr);class rr extends kn{constructor(t){super(t,bn.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",Mn.Vector4,!0),this.registerInput("xyz ",Mn.Vector3,!0),this.registerInput("xy ",Mn.Vector2,!0),this.registerInput("zw ",Mn.Vector2,!0),this.registerInput("x",Mn.Float,!0),this.registerInput("y",Mn.Float,!0),this.registerInput("z",Mn.Float,!0),this.registerInput("w",Mn.Float,!0),this.registerOutput("xyzw",Mn.Vector4),this.registerOutput("xyz",Mn.Vector3),this.registerOutput("xy",Mn.Vector2),this.registerOutput("zw",Mn.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this.xd[0]}get xyzIn(){return this.xd[1]}get xyIn(){return this.xd[2]}get zwIn(){return this.xd[3]}get x(){return this.xd[4]}get y(){return this.xd[5]}get z(){return this.xd[6]}get w(){return this.xd[7]}get xyzw(){return this.YP[0]}get xyzOut(){return this.YP[1]}get xyOut(){return this.YP[2]}get zwOut(){return this.YP[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}hD(t){return"xyzw "===t?"xyzwIn":"xyz "===t?"xyzIn":"xy "===t?"xyIn":"zw "===t?"zwIn":t}EL(t){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substr(0,t)}tD(t){super.tD(t);const i=this.x,e=this.y,s=this.z,n=this.w,r=this.xyIn,h=this.zwIn,o=this.xyzIn,a=this.xyzwIn,l=this.YP[0],c=this.YP[1],u=this.YP[2],f=this.YP[3];return a.isConnected?(l.hasEndpoints&&(t.compilationString+=this.QP(l,t)+` = ${a.associatedVariableName}${this.EL(4)};\r\n`),c.hasEndpoints&&(t.compilationString+=this.QP(c,t)+` = ${a.associatedVariableName}${this.EL(3)};\r\n`),u.hasEndpoints&&(t.compilationString+=this.QP(u,t)+` = ${a.associatedVariableName}${this.EL(2)};\r\n`)):o.isConnected?(l.hasEndpoints&&(t.compilationString+=this.QP(l,t)+` = vec4(${o.associatedVariableName}, ${n.isConnected?this.ZP(n):"0.0"})${this.EL(4)};\r\n`),c.hasEndpoints&&(t.compilationString+=this.QP(c,t)+` = ${o.associatedVariableName}${this.EL(3)};\r\n`),u.hasEndpoints&&(t.compilationString+=this.QP(u,t)+` = ${o.associatedVariableName}${this.EL(2)};\r\n`)):r.isConnected?(l.hasEndpoints&&(h.isConnected?t.compilationString+=this.QP(l,t)+` = vec4(${r.associatedVariableName}, ${h.associatedVariableName})${this.EL(4)};\r\n`:t.compilationString+=this.QP(l,t)+` = vec4(${r.associatedVariableName}, ${s.isConnected?this.ZP(s):"0.0"}, ${n.isConnected?this.ZP(n):"0.0"})${this.EL(4)};\r\n`),c.hasEndpoints&&(t.compilationString+=this.QP(c,t)+` = vec3(${r.associatedVariableName}, ${s.isConnected?this.ZP(s):"0.0"})${this.EL(3)};\r\n`),u.hasEndpoints&&(t.compilationString+=this.QP(u,t)+` = ${r.associatedVariableName}${this.EL(2)};\r\n`),f.hasEndpoints&&(h.isConnected?t.compilationString+=this.QP(f,t)+` = ${h.associatedVariableName}${this.EL(2)};\r\n`:t.compilationString+=this.QP(f,t)+` = vec2(${s.isConnected?this.ZP(s):"0.0"}, ${n.isConnected?this.ZP(n):"0.0"})${this.EL(2)};\r\n`)):(l.hasEndpoints&&(h.isConnected?t.compilationString+=this.QP(l,t)+` = vec4(${i.isConnected?this.ZP(i):"0.0"}, ${e.isConnected?this.ZP(e):"0.0"}, ${h.associatedVariableName})${this.EL(4)};\r\n`:t.compilationString+=this.QP(l,t)+` = vec4(${i.isConnected?this.ZP(i):"0.0"}, ${e.isConnected?this.ZP(e):"0.0"}, ${s.isConnected?this.ZP(s):"0.0"}, ${n.isConnected?this.ZP(n):"0.0"})${this.EL(4)};\r\n`),c.hasEndpoints&&(t.compilationString+=this.QP(c,t)+` = vec3(${i.isConnected?this.ZP(i):"0.0"}, ${e.isConnected?this.ZP(e):"0.0"}, ${s.isConnected?this.ZP(s):"0.0"})${this.EL(3)};\r\n`),u.hasEndpoints&&(t.compilationString+=this.QP(u,t)+` = vec2(${i.isConnected?this.ZP(i):"0.0"}, ${e.isConnected?this.ZP(e):"0.0"})${this.EL(2)};\r\n`),f.hasEndpoints&&(h.isConnected?t.compilationString+=this.QP(f,t)+` = ${h.associatedVariableName}${this.EL(2)};\r\n`:t.compilationString+=this.QP(f,t)+` = vec2(${s.isConnected?this.ZP(s):"0.0"}, ${n.isConnected?this.ZP(n):"0.0"})${this.EL(2)};\r\n`)),this}serialize(){const t=super.serialize();return t.xSwizzle=this.xSwizzle,t.ySwizzle=this.ySwizzle,t.zSwizzle=this.zSwizzle,t.wSwizzle=this.wSwizzle,t}uD(t,i,e){var s,n,r,h;super.uD(t,i,e),this.xSwizzle=null!==(s=t.xSwizzle)&&void 0!==s?s:"x",this.ySwizzle=null!==(n=t.ySwizzle)&&void 0!==n?n:"y",this.zSwizzle=null!==(r=t.zSwizzle)&&void 0!==r?r:"z",this.wSwizzle=null!==(h=t.wSwizzle)&&void 0!==h?h:"w"}aD(){let t=super.aD();return t+=`${this.$P}.xSwizzle = "${this.xSwizzle}";\r\n`,t+=`${this.$P}.ySwizzle = "${this.ySwizzle}";\r\n`,t+=`${this.$P}.zSwizzle = "${this.zSwizzle}";\r\n`,t+=`${this.$P}.wSwizzle = "${this.wSwizzle}";\r\n`,t}}v("BABYLON.VectorMergerBlock",rr);class hr extends kn{constructor(t){super(t,bn.Neutral),this.sourceRange=new C(-1,1),this.targetRange=new C(0,1),this.registerInput("input",Mn.AutoDetect),this.registerInput("sourceMin",Mn.Float,!0),this.registerInput("sourceMax",Mn.Float,!0),this.registerInput("targetMin",Mn.Float,!0),this.registerInput("targetMax",Mn.Float,!0),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0]}getClassName(){return"RemapBlock"}get input(){return this.xd[0]}get sourceMin(){return this.xd[1]}get sourceMax(){return this.xd[2]}get targetMin(){return this.xd[3]}get targetMax(){return this.xd[4]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0],e=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this.JP(this.sourceRange.x),s=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this.JP(this.sourceRange.y),n=this.targetMin.isConnected?this.targetMin.associatedVariableName:this.JP(this.targetRange.x),r=this.targetMax.isConnected?this.targetMax.associatedVariableName:this.JP(this.targetRange.y);return t.compilationString+=this.QP(i,t)+` = ${n} + (${this.xd[0].associatedVariableName} - ${e}) * (${r} - ${n}) / (${s} - ${e});\r\n`,this}aD(){let t=super.aD()+`${this.$P}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\r\n`;return t+=`${this.$P}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\r\n`,t}serialize(){const t=super.serialize();return t.sourceRange=this.sourceRange.asArray(),t.targetRange=this.targetRange.asArray(),t}uD(t,i,e){super.uD(t,i,e),this.sourceRange=C.FromArray(t.sourceRange),this.targetRange=C.FromArray(t.targetRange)}}ut([Hn("From",Nn.Vector2)],hr.prototype,"sourceRange",void 0),ut([Hn("To",Nn.Vector2)],hr.prototype,"targetRange",void 0),v("BABYLON.RemapBlock",hr);class or extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1)}getClassName(){return"MultiplyBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\r\n`,this}}var ar;v("BABYLON.MultiplyBlock",or),function(t){t[t.Material=0]="Material",t[t.PostProcess=1]="PostProcess",t[t.Particle=2]="Particle",t[t.ProceduralTexture=3]="ProceduralTexture"}(ar||(ar={}));class lr{constructor(){this.direction1=new w(0,1,0),this.direction2=new w(0,1,0),this.minEmitBox=new w(-.5,-.5,-.5),this.maxEmitBox=new w(.5,.5,.5)}startDirectionFunction(t,i,e,s){const n=o.RandomRange(this.direction1.x,this.direction2.x),r=o.RandomRange(this.direction1.y,this.direction2.y),h=o.RandomRange(this.direction1.z,this.direction2.z);if(s)return i.x=n,i.y=r,void(i.z=h);w.TransformNormalFromFloatsToRef(n,r,h,t,i)}startPositionFunction(t,i,e,s){const n=o.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),r=o.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),h=o.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(s)return i.x=n,i.y=r,void(i.z=h);w.TransformCoordinatesFromFloatsToRef(n,r,h,t,i)}clone(){const t=new lr;return k.DeepCopy(this,t),t}applyToShader(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2),t.setVector3("minEmitBox",this.minEmitBox),t.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(t){t.addUniform("direction1",3),t.addUniform("direction2",3),t.addUniform("minEmitBox",3),t.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.minEmitBox=this.minEmitBox.asArray(),t.maxEmitBox=this.maxEmitBox.asArray(),t}parse(t){w.FromArrayToRef(t.direction1,0,this.direction1),w.FromArrayToRef(t.direction2,0,this.direction2),w.FromArrayToRef(t.minEmitBox,0,this.minEmitBox),w.FromArrayToRef(t.maxEmitBox,0,this.maxEmitBox)}}class cr{constructor(t=1,i=Math.PI,e=0){this.directionRandomizer=e,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=i,this.radius=t}get radius(){return this.eR}set radius(t){this.eR=t,this.AL()}get angle(){return this.CL}set angle(t){this.CL=t,this.AL()}AL(){0!==this.CL?this.wL=this.eR/Math.tan(this.CL/2):this.wL=1}startDirectionFunction(t,i,e,s){s?M.Vector3[0].copyFrom(e.rE).normalize():e.position.subtractToRef(t.getTranslation(),M.Vector3[0]).normalize();const n=o.RandomRange(0,this.directionRandomizer),r=o.RandomRange(0,this.directionRandomizer),h=o.RandomRange(0,this.directionRandomizer);i.x=M.Vector3[0].x+n,i.y=M.Vector3[0].y+r,i.z=M.Vector3[0].z+h,i.normalize()}startPositionFunction(t,i,e,s){const n=o.RandomRange(0,2*Math.PI);let r;this.emitFromSpawnPointOnly?r=1e-4:(r=o.RandomRange(0,this.heightRange),r=1-r*r);let h=this.eR-o.RandomRange(0,this.eR*this.radiusRange);h*=r;const a=h*Math.sin(n),l=h*Math.cos(n),c=r*this.wL;if(s)return i.x=a,i.y=c,void(i.z=l);w.TransformCoordinatesFromFloatsToRef(a,c,l,t,i)}clone(){const t=new cr(this.eR,this.CL,this.directionRandomizer);return k.DeepCopy(this,t),t}applyToShader(t){t.setFloat2("radius",this.eR,this.radiusRange),t.setFloat("coneAngle",this.CL),t.setFloat2("height",this.wL,this.heightRange),t.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(t){t.addUniform("radius",2),t.addUniform("coneAngle",1),t.addUniform("height",2),t.addUniform("directionRandomizer",1)}getEffectDefines(){let t="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(t+="\n#define CONEEMITTERSPAWNPOINT"),t}getClassName(){return"ConeParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.radius=this.eR,t.angle=this.CL,t.directionRandomizer=this.directionRandomizer,t.radiusRange=this.radiusRange,t.heightRange=this.heightRange,t.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,t}parse(t){this.radius=t.radius,this.angle=t.angle,this.directionRandomizer=t.directionRandomizer,this.radiusRange=void 0!==t.radiusRange?t.radiusRange:1,this.heightRange=void 0!==t.radiusRange?t.heightRange:1,this.emitFromSpawnPointOnly=void 0!==t.emitFromSpawnPointOnly&&t.emitFromSpawnPointOnly}}class ur{constructor(t=1,i=1,e=1,s=0){this.radius=t,this.height=i,this.radiusRange=e,this.directionRandomizer=s,this.xL=w.Zero()}startDirectionFunction(t,i,e,s,n){e.position.subtractToRef(t.getTranslation(),this.xL),this.xL.normalize(),w.TransformNormalToRef(this.xL,n,this.xL);const r=o.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2);let h=Math.atan2(this.xL.x,this.xL.z);h+=o.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this.xL.y=r,this.xL.x=Math.sin(h),this.xL.z=Math.cos(h),this.xL.normalize(),s?i.copyFrom(this.xL):w.TransformNormalFromFloatsToRef(this.xL.x,this.xL.y,this.xL.z,t,i)}startPositionFunction(t,i,e,s){const n=o.RandomRange(-this.height/2,this.height/2),r=o.RandomRange(0,2*Math.PI),h=o.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),a=Math.sqrt(h)*this.radius,l=a*Math.cos(r),c=a*Math.sin(r);s?i.copyFromFloats(l,n,c):w.TransformCoordinatesFromFloatsToRef(l,n,c,t,i)}clone(){const t=new ur(this.radius,this.directionRandomizer);return k.DeepCopy(this,t),t}applyToShader(t){t.setFloat("radius",this.radius),t.setFloat("height",this.height),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(t){t.addUniform("radius",1),t.addUniform("height",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.radius=this.radius,t.height=this.height,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t}parse(t){this.radius=t.radius,this.height=t.height,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer}}class fr extends ur{constructor(t=1,i=1,e=1,s=new w(0,1,0),n=new w(0,1,0)){super(t,i,e),this.direction1=s,this.direction2=n}startDirectionFunction(t,i){const e=o.RandomRange(this.direction1.x,this.direction2.x),s=o.RandomRange(this.direction1.y,this.direction2.y),n=o.RandomRange(this.direction1.z,this.direction2.z);w.TransformNormalFromFloatsToRef(e,s,n,t,i)}clone(){const t=new fr(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return k.DeepCopy(this,t),t}applyToShader(t){t.setFloat("radius",this.radius),t.setFloat("height",this.height),t.setFloat("radiusRange",this.radiusRange),t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)}buildUniformLayout(t){t.addUniform("radius",1),t.addUniform("height",1),t.addUniform("radiusRange",1),t.addUniform("direction1",3),t.addUniform("direction2",3)}getEffectDefines(){return"#define CYLINDEREMITTER\n#define DIRECTEDCYLINDEREMITTER"}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const t=super.serialize();return t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t}parse(t){super.parse(t),this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2)}}class dr{constructor(t=1,i=1,e=0){this.radius=t,this.radiusRange=i,this.directionRandomizer=e}startDirectionFunction(t,i,e,s){const n=e.position.subtract(t.getTranslation()).normalize(),r=o.RandomRange(0,this.directionRandomizer),h=o.RandomRange(0,this.directionRandomizer),a=o.RandomRange(0,this.directionRandomizer);n.x+=r,n.y+=h,n.z+=a,n.normalize(),s?i.copyFrom(n):w.TransformNormalFromFloatsToRef(n.x,n.y,n.z,t,i)}startPositionFunction(t,i,e,s){const n=this.radius-o.RandomRange(0,this.radius*this.radiusRange),r=o.RandomRange(0,1),h=o.RandomRange(0,2*Math.PI),a=Math.acos(2*r-1),l=n*Math.cos(h)*Math.sin(a),c=n*Math.cos(a),u=n*Math.sin(h)*Math.sin(a);s?i.copyFromFloats(l,Math.abs(c),u):w.TransformCoordinatesFromFloatsToRef(l,Math.abs(c),u,t,i)}clone(){const t=new dr(this.radius,this.directionRandomizer);return k.DeepCopy(this,t),t}applyToShader(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t}parse(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer}}class pr{constructor(){this.direction1=new w(0,1,0),this.direction2=new w(0,1,0)}startDirectionFunction(t,i,e,s){const n=o.RandomRange(this.direction1.x,this.direction2.x),r=o.RandomRange(this.direction1.y,this.direction2.y),h=o.RandomRange(this.direction1.z,this.direction2.z);s?i.copyFromFloats(n,r,h):w.TransformNormalFromFloatsToRef(n,r,h,t,i)}startPositionFunction(t,i,e,s){s?i.copyFromFloats(0,0,0):w.TransformCoordinatesFromFloatsToRef(0,0,0,t,i)}clone(){const t=new pr;return k.DeepCopy(this,t),t}applyToShader(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)}buildUniformLayout(t){t.addUniform("direction1",3),t.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t}parse(t){w.FromArrayToRef(t.direction1,0,this.direction1),w.FromArrayToRef(t.direction2,0,this.direction2)}}class mr{constructor(t=1,i=1,e=0){this.radius=t,this.radiusRange=i,this.directionRandomizer=e}startDirectionFunction(t,i,e,s){const n=e.position.subtract(t.getTranslation()).normalize(),r=o.RandomRange(0,this.directionRandomizer),h=o.RandomRange(0,this.directionRandomizer),a=o.RandomRange(0,this.directionRandomizer);n.x+=r,n.y+=h,n.z+=a,n.normalize(),s?i.copyFrom(n):w.TransformNormalFromFloatsToRef(n.x,n.y,n.z,t,i)}startPositionFunction(t,i,e,s){const n=this.radius-o.RandomRange(0,this.radius*this.radiusRange),r=o.RandomRange(0,1),h=o.RandomRange(0,2*Math.PI),a=Math.acos(2*r-1),l=n*Math.cos(h)*Math.sin(a),c=n*Math.cos(a),u=n*Math.sin(h)*Math.sin(a);s?i.copyFromFloats(l,c,u):w.TransformCoordinatesFromFloatsToRef(l,c,u,t,i)}clone(){const t=new mr(this.radius,this.directionRandomizer);return k.DeepCopy(this,t),t}applyToShader(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t}parse(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer}}class vr extends mr{constructor(t=1,i=new w(0,1,0),e=new w(0,1,0)){super(t),this.direction1=i,this.direction2=e}startDirectionFunction(t,i){const e=o.RandomRange(this.direction1.x,this.direction2.x),s=o.RandomRange(this.direction1.y,this.direction2.y),n=o.RandomRange(this.direction1.z,this.direction2.z);w.TransformNormalFromFloatsToRef(e,s,n,t,i)}clone(){const t=new vr(this.radius,this.direction1,this.direction2);return k.DeepCopy(this,t),t}applyToShader(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)}buildUniformLayout(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("direction1",3),t.addUniform("direction2",3)}getEffectDefines(){return"#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER"}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const t=super.serialize();return t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t}parse(t){super.parse(t),this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2)}}class gr{constructor(){this.particlePositionGenerator=()=>{},this.particleDestinationGenerator=()=>{}}startDirectionFunction(t,i,e,s){const n=M.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,e,n);const t=M.Vector3[1];n.subtractToRef(e.position,t),t.scaleToRef(1/e.lifeTime,n)}else n.set(0,0,0);s?i.copyFrom(n):w.TransformNormalToRef(n,t,i)}startPositionFunction(t,i,e,s){const n=M.Vector3[0];this.particlePositionGenerator?this.particlePositionGenerator(-1,e,n):n.set(0,0,0),s?i.copyFrom(n):w.TransformCoordinatesToRef(n,t,i)}clone(){const t=new gr;return k.DeepCopy(this,t),t}applyToShader(t){}buildUniformLayout(t){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){const t={};return t.type=this.getClassName(),t}parse(t){}}class Sr{constructor(t=null){this.FC=null,this.QC=null,this.Ll=null,this.TL=w.Zero(),this.fC=null,this.direction1=new w(0,1,0),this.direction2=new w(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=t}get mesh(){return this.fC}set mesh(t){this.fC!==t&&(this.fC=t,t?(this.FC=t.getIndices(),this.QC=t.getVerticesData(he.PositionKind),this.Ll=t.getVerticesData(he.NormalKind)):(this.FC=null,this.QC=null,this.Ll=null))}startDirectionFunction(t,i,e,s){if(this.useMeshNormalsForDirection&&this.Ll)return void w.TransformNormalToRef(this.TL,t,i);const n=o.RandomRange(this.direction1.x,this.direction2.x),r=o.RandomRange(this.direction1.y,this.direction2.y),h=o.RandomRange(this.direction1.z,this.direction2.z);s?i.copyFromFloats(n,r,h):w.TransformNormalFromFloatsToRef(n,r,h,t,i)}startPositionFunction(t,i,e,s){if(!this.FC||!this.QC)return;const n=3*Math.random()*(this.FC.length/3)|0,r=Math.random(),h=Math.random()*(1-r),o=1-r-h,a=this.FC[n],l=this.FC[n+1],c=this.FC[n+2],u=M.Vector3[0],f=M.Vector3[1],d=M.Vector3[2],p=M.Vector3[3];w.FromArrayToRef(this.QC,3*a,u),w.FromArrayToRef(this.QC,3*l,f),w.FromArrayToRef(this.QC,3*c,d),p.x=r*u.x+h*f.x+o*d.x,p.y=r*u.y+h*f.y+o*d.y,p.z=r*u.z+h*f.z+o*d.z,s?i.copyFromFloats(p.x,p.y,p.z):w.TransformCoordinatesFromFloatsToRef(p.x,p.y,p.z,t,i),this.useMeshNormalsForDirection&&this.Ll&&(w.FromArrayToRef(this.Ll,3*a,u),w.FromArrayToRef(this.Ll,3*l,f),w.FromArrayToRef(this.Ll,3*c,d),this.TL.x=r*u.x+h*f.x+o*d.x,this.TL.y=r*u.y+h*f.y+o*d.y,this.TL.z=r*u.z+h*f.z+o*d.z)}clone(){const t=new Sr(this.mesh);return k.DeepCopy(this,t),t}applyToShader(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)}buildUniformLayout(t){t.addUniform("direction1",3),t.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){var t;const i={};return i.type=this.getClassName(),i.direction1=this.direction1.asArray(),i.direction2=this.direction2.asArray(),i.meshId=null===(t=this.mesh)||void 0===t?void 0:t.id,i.useMeshNormalsForDirection=this.useMeshNormalsForDirection,i}parse(t,i){w.FromArrayToRef(t.direction1,0,this.direction1),w.FromArrayToRef(t.direction2,0,this.direction2),t.meshId&&i&&(this.mesh=i.getLastMeshById(t.meshId)),this.useMeshNormalsForDirection=t.useMeshNormalsForDirection}}class Er{constructor(t){this.animations=[],this.renderingGroupId=0,this.emitter=w.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this.sd=!1,this.RL="",this.noiseStrength=new w(10,10,10),this.onAnimationEnd=null,this.blendMode=Er.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new C(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new w(0,0,0),this.IL=!1,this.gravity=w.Zero(),this.ML=null,this.bL=null,this._L=null,this.yL=null,this.NL=null,this.PL=null,this.DL=null,this.LL=null,this.OL=null,this.FL=null,this.BL=null,this.UL=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new y(1,1,1,1),this.color2=new y(1,1,1,1),this.colorDead=new y(0,0,0,1),this.textureMask=new y(1,1,1,1),this.VL=!1,this.Px=7,this.kL=!0,this.GL=new Yi,this.id=t,this.name=t}get noiseTexture(){return this.zL}set noiseTexture(t){this.zL!==t&&(this.zL=t,this.HL())}get isAnimationSheetEnabled(){return this.XL}set isAnimationSheetEnabled(t){this.XL!=t&&(this.XL=t,this.HL())}get useLogarithmicDepth(){return this.IL}set useLogarithmicDepth(t){this.IL=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this.Kt}WL(){return this.OL&&this.OL.length>0||this.LL&&this.LL.length>0||this._L&&this._L.length>0}getDragGradients(){return this.DL}getLimitVelocityGradients(){return this.PL}getColorGradients(){return this.ML}getSizeGradients(){return this.bL}getColorRemapGradients(){return this.BL}getAlphaRemapGradients(){return this.UL}getLifeTimeGradients(){return this._L}getAngularSpeedGradients(){return this.yL}getVelocityGradients(){return this.NL}getStartSizeGradients(){return this.OL}getEmitRateGradients(){return this.LL}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:w.Zero()}set direction1(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:w.Zero()}set direction2(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:w.Zero()}set minEmitBox(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:w.Zero()}set maxEmitBox(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)}get billboardMode(){return this.Px}set billboardMode(t){this.Px!==t&&(this.Px=t,this.HL())}get isBillboardBased(){return this.kL}set isBillboardBased(t){this.kL!==t&&(this.kL=t,this.HL())}get imageProcessingConfiguration(){return this.Sg}set imageProcessingConfiguration(t){this.$L(t)}$L(t){t!==this.Sg&&(!t&&this.Kt?this.Sg=this.Kt.imageProcessingConfiguration:this.Sg=t)}HL(){}YL(t,i,e){if(!i)return this;let s=0;for(const e of i){if(e.gradient===t){i.splice(s,1);break}s++}return e&&e.dispose(),this}createPointEmitter(t,i){const e=new pr;return e.direction1=t,e.direction2=i,this.particleEmitterType=e,e}createHemisphericEmitter(t=1,i=1){const e=new dr(t,i);return this.particleEmitterType=e,e}createSphereEmitter(t=1,i=1){const e=new mr(t,i);return this.particleEmitterType=e,e}createDirectedSphereEmitter(t=1,i=new w(0,1,0),e=new w(0,1,0)){const s=new vr(t,i,e);return this.particleEmitterType=s,s}createCylinderEmitter(t=1,i=1,e=1,s=0){const n=new ur(t,i,e,s);return this.particleEmitterType=n,n}createDirectedCylinderEmitter(t=1,i=1,e=1,s=new w(0,1,0),n=new w(0,1,0)){const r=new fr(t,i,e,s,n);return this.particleEmitterType=r,r}createConeEmitter(t=1,i=Math.PI/4){const e=new cr(t,i);return this.particleEmitterType=e,e}createBoxEmitter(t,i,e,s){const n=new lr;return this.particleEmitterType=n,this.direction1=t,this.direction2=i,this.minEmitBox=e,this.maxEmitBox=s,n}}Er.BLENDMODE_ONEONE=0,Er.BLENDMODE_STANDARD=1,Er.BLENDMODE_ADD=2,Er.BLENDMODE_MULTIPLY=3,Er.BLENDMODE_MULTIPLYADD=4;class Ar extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("rgba",Mn.Color4,!0),this.registerInput("rgb ",Mn.Color3,!0),this.registerOutput("rgb",Mn.Color3),this.registerOutput("r",Mn.Float),this.registerOutput("g",Mn.Float),this.registerOutput("b",Mn.Float),this.registerOutput("a",Mn.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this.xd[0]}get rgbIn(){return this.xd[1]}get rgbOut(){return this.YP[0]}get r(){return this.YP[1]}get g(){return this.YP[2]}get b(){return this.YP[3]}get a(){return this.YP[4]}hD(t){return"rgb "===t?"rgbIn":t}oD(t){return"rgb"===t?"rgbOut":t}tD(t){super.tD(t);const i=this.rgba.isConnected?this.rgba:this.rgbIn;if(!i.isConnected)return;const e=this.YP[0],s=this.YP[1],n=this.YP[2],r=this.YP[3],h=this.YP[4];return e.hasEndpoints&&(t.compilationString+=this.QP(e,t)+` = ${i.associatedVariableName}.rgb;\r\n`),s.hasEndpoints&&(t.compilationString+=this.QP(s,t)+` = ${i.associatedVariableName}.r;\r\n`),n.hasEndpoints&&(t.compilationString+=this.QP(n,t)+` = ${i.associatedVariableName}.g;\r\n`),r.hasEndpoints&&(t.compilationString+=this.QP(r,t)+` = ${i.associatedVariableName}.b;\r\n`),h.hasEndpoints&&(t.compilationString+=this.QP(h,t)+` = ${i.associatedVariableName}.a;\r\n`),this}}v("BABYLON.ColorSplitterBlock",Ar),Ei.prototype.createRenderTargetCubeTexture=function(t,i){const e=this.$D(!1,!0,t),s={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...i};s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer,(1!==s.type||this.po.textureFloatLinearFiltering)&&(2!==s.type||this.po.textureHalfFloatLinearFiltering)||(s.samplingMode=1);const n=this.lo,r=new ai(this,oi.RenderTarget);this.qo(n.TEXTURE_CUBE_MAP,r,!0);const h=this.wa(s.samplingMode,s.generateMipMaps);1!==s.type||this.po.textureFloat||(s.type=0,F.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,h.mag),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,h.min),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);for(let i=0;i<6;i++)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,this.Ra(s.type,s.format),t,t,0,this.Ia(s.format),this.Ma(s.type),null);const o=n.createFramebuffer();return this.Xo(o),e.zD=this.Xa(s.generateStencilBuffer,s.generateDepthBuffer,t,t),s.generateMipMaps&&n.generateMipmap(n.TEXTURE_CUBE_MAP),this.qo(n.TEXTURE_CUBE_MAP,null),this.Xo(null),e.$o=o,e.BD=s.generateDepthBuffer,e.FD=s.generateStencilBuffer,r.width=t,r.height=t,r.isReady=!0,r.isCube=!0,r.samples=1,r.generateMipMaps=s.generateMipMaps,r.samplingMode=s.samplingMode,r.type=s.type,r.format=s.format,this.Rh.push(r),e.setTextures(r),e};const Cr={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class wr{constructor(t,i=Cr){var e,s;this.jL=new rs(0,0,1,1);const n=null!==(e=i.positions)&&void 0!==e?e:Cr.positions,r=null!==(s=i.indices)&&void 0!==s?s:Cr.indices;this.engine=t,this.ff={[he.PositionKind]:new he(t,n,he.PositionKind,!1,!1,2)},this.Xu=t.createIndexBuffer(r),this.EM=t.onContextRestoredObservable.add((()=>{this.Xu=t.createIndexBuffer(r);for(const t in this.ff){this.ff[t].br()}}))}setViewport(t=this.jL){this.engine.setViewport(t)}bindBuffers(t){this.engine.bindBuffers(this.ff,this.Xu,t)}applyEffectWrapper(t){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(t.SC),this.bindBuffers(t.effect),t.onApplyObservable.notifyObservers({})}restoreStates(){this.engine.depthCullingState.depthTest=!0,this.engine.stencilState.stencilTest=!0}draw(){this.engine.drawElementsType(0,0,6)}KL(t){return void 0!==t.renderTarget}render(t,i=null){if(!t.effect.isReady())return;this.setViewport();const e=null===i?null:this.KL(i)?i.renderTarget:i;e&&this.engine.bindFramebuffer(e),this.applyEffectWrapper(t),this.draw(),e&&this.engine.unBindFramebuffer(e),this.restoreStates()}dispose(){const t=this.ff[he.PositionKind];t&&(t.dispose(),delete this.ff[he.PositionKind]),this.Xu&&this.engine.ca(this.Xu),this.EM&&(this.engine.onContextRestoredObservable.remove(this.EM),this.EM=null)}}class xr{constructor(t){let i;this.onApplyObservable=new h;const e=t.uniformNames||[];t.vertexShader?i={fragmentSource:t.fragmentShader,vertexSource:t.vertexShader,spectorName:t.name||"effectWrapper"}:(e.push("scale"),i={fragmentSource:t.fragmentShader,vertex:"postprocess",spectorName:t.name||"effectWrapper"},this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)})));const s=t.defines?t.defines.join("\n"):"";this.SC=new vi(t.engine),t.useShaderStore?(i.fragment=i.fragmentSource,i.vertex||(i.vertex=i.vertexSource),delete i.fragmentSource,delete i.vertexSource,this.effect=t.engine.createEffect(i,t.attributeNames||["position"],e,t.samplerNames,s,void 0,t.onCompiled,void 0,void 0,t.shaderLanguage)):(this.effect=new ei(i,t.attributeNames||["position"],e,t.samplerNames,t.engine,s,void 0,t.onCompiled,void 0,void 0,void 0,t.shaderLanguage),this.EM=t.engine.onContextRestoredObservable.add((()=>{this.effect.Ms=null,this.effect.cs=!1,this.effect.Ks()})))}get effect(){return this.SC.effect}set effect(t){this.SC.effect=t}dispose(){this.EM&&(this.effect.getEngine().onContextRestoredObservable.remove(this.EM),this.EM=null),this.effect.dispose()}}const Tr="passPixelShader",Rr="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\n}";ii.ShadersStore[Tr]=Rr;const Ir={name:Tr,shader:Rr};class Mr{static qL(){if(!Mr.QL){const t=document.createElement("canvas"),i=new Ei(t,!1,{preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1});i.getCaps().parallelShaderCompile=void 0;const e=new wr(i),s=new xr({engine:i,name:Ir.name,fragmentShader:Ir.shader,samplerNames:["textureSampler"]});Mr.QL={canvas:t,engine:i,renderer:e,wrapper:s}}return Mr.QL}static async DumpFramebuffer(t,i,e,s,n="image/png",r){const h=await e.readPixels(0,0,t,i),o=new Uint8Array(h.buffer);Mr.DumpData(t,i,o,s,n,r,!0)}static DumpDataAsync(t,i,e,s="image/png",n,r=!1,h=!1,o){return new Promise((a=>{Mr.DumpData(t,i,e,(t=>a(t)),s,n,r,h,o)}))}static DumpData(t,i,e,s,n="image/png",r,h=!1,o=!1,a){const l=Mr.qL();if(l.engine.setSize(t,i,!0),e instanceof Float32Array){const t=new Uint8Array(e.length);let i=e.length;for(;i--;){const s=e[i];t[i]=s<0?0:s>1?1:Math.round(255*s)}e=t}const c=l.engine.createRawTexture(e,t,i,5,!1,!h,1);l.renderer.setViewport(),l.renderer.applyEffectWrapper(l.wrapper),l.wrapper.effect.fn("textureSampler",c),l.renderer.draw(),o?ki.ToBlob(l.canvas,(t=>{const i=new FileReader;i.onload=t=>{const i=t.target.result;s&&s(i)},i.readAsArrayBuffer(t)}),n,a):ki.EncodeScreenshotCanvasData(l.canvas,s,n,r,a),c.dispose()}static Dispose(){Mr.QL&&(Mr.QL.wrapper.dispose(),Mr.QL.renderer.dispose(),Mr.QL.engine.dispose()),Mr.QL=null}}ki.DumpData=Mr.DumpData,ki.DumpDataAsync=Mr.DumpDataAsync,ki.DumpFramebuffer=Mr.DumpFramebuffer;class br extends an{constructor(t,i,e,s=!1,n=!0,r=0,o=!1,a=an.TRILINEAR_SAMPLINGMODE,l=!0,c=!1,u=!1,f=5,d=!1,p,m,v=!1,g=!1){var S,E,A,C,x,T;let I;if("object"==typeof s){const t=s;s=!!t.generateMipMaps,n=null===(S=t.doNotChangeAspectRatio)||void 0===S||S,r=null!==(E=t.type)&&void 0!==E?E:0,o=!!t.isCube,a=null!==(A=t.samplingMode)&&void 0!==A?A:an.TRILINEAR_SAMPLINGMODE,l=null===(C=t.generateDepthBuffer)||void 0===C||C,c=!!t.generateStencilBuffer,u=!!t.isMulti,f=null!==(x=t.format)&&void 0!==x?x:5,d=!!t.delayAllocation,p=t.samples,m=t.creationFlags,v=!!t.noColorAttachment,g=!!t.useSRGBBuffer,I=t.colorAttachment}if(super(null,e,!s,void 0,a,void 0,void 0,void 0,void 0,f),this.JL=null,this.tO=(t,i)=>{var e;const s=this.iO?this.iO.length:0;(0===i&&s>0||0===s)&&(null===(e=this.getScene())||void 0===e||e.meshes.forEach((t=>{t.$T()})))},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new h,this.onAfterUnbindObservable=new h,this.onBeforeRenderObservable=new h,this.onAfterRenderObservable=new h,this.onClearObservable=new h,this.onResizeObservable=new h,this.mS=!1,this.skipInitialClear=!1,this.eO=-1,this.sO=1,this.dw=1,this.nO=!0,this.rO=null,this.boundingBoxPosition=w.Zero(),!(e=this.getScene()))return;const M=this.getScene().getEngine();this.Hb=an.PROJECTION_MODE,this.renderList=new Array,this.name=t,this.isRenderTarget=!0,this.hO=i,this.oO=[],this.aO=o,this.lO(i),this.renderPassId=this.oO[0],this.cO=M.onResizeObservable.add((()=>{})),this.uO=!!s,this.fO=n,this.vg=new ue(e),this.vg.jf=!0,u||(this.dO={generateMipMaps:s,type:r,format:null!==(T=this.R_)&&void 0!==T?T:void 0,samplingMode:this.samplingMode,generateDepthBuffer:l,generateStencilBuffer:c,samples:p,creationFlags:m,noColorAttachment:v,useSRGBBuffer:g,colorAttachment:I},this.samplingMode===an.NEAREST_SAMPLINGMODE&&(this.wrapU=an.CLAMP_ADDRESSMODE,this.wrapV=an.CLAMP_ADDRESSMODE),d||(o?(this.rO=e.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this.dO),this.coordinatesMode=an.INVCUBIC_MODE,this.pO=R.Identity()):this.rO=e.getEngine().createRenderTargetTexture(this.Qn,this.dO),this.Lb=this.rO.texture,void 0!==p&&(this.samples=p)))}get renderList(){return this.iO}set renderList(t){this.JL&&(this.JL(),this.JL=null),t&&(this.JL=p(t,this.tO)),this.iO=t}get postProcesses(){return this.vf}get mO(){return!!this.vO&&this.vO.enabled}set onAfterUnbind(t){this.gO&&this.onAfterUnbindObservable.remove(this.gO),this.gO=this.onAfterUnbindObservable.add(t)}set onBeforeRender(t){this.qm&&this.onBeforeRenderObservable.remove(this.qm),this.qm=this.onBeforeRenderObservable.add(t)}set onAfterRender(t){this.Qm&&this.onAfterRenderObservable.remove(this.Qm),this.Qm=this.onAfterRenderObservable.add(t)}set onClear(t){this.SO&&this.onClearObservable.remove(this.SO),this.SO=this.onClearObservable.add(t)}get renderPassIds(){return this.oO}get currentRefreshId(){return this.eO}setMaterialForRendering(t,i){let e;e=Array.isArray(t)?t:[t];for(let t=0;t<e.length;++t)for(let s=0;s<this.oO.length;++s)e[t].setMaterialForRenderPass(this.oO[s],void 0!==i?Array.isArray(i)?i[s]:i:void 0)}get renderTargetOptions(){return this.dO}get renderTarget(){return this.rO}EO(){this.AO&&this.resize(this.hO)}set boundingBoxSize(t){if(this.CO&&this.CO.equals(t))return;this.CO=t;const i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this.CO}get depthStencilTexture(){var t,i;return null!==(i=null===(t=this.rO)||void 0===t?void 0:t.Yo)&&void 0!==i?i:null}createDepthStencilTexture(t=0,i=!0,e=!1,s=1,n=14){var r;null===(r=this.rO)||void 0===r||r.createDepthStencilTexture(t,i,e,s,n)}wO(){if(this.Kt){const t=this.Kt.getEngine();for(let i=0;i<this.oO.length;++i)t.releaseRenderPassId(this.oO[i])}this.oO=[]}xO(){this.wO();const t=this.Kt.getEngine(),i=this.aO?6:this.getRenderLayers()||1;for(let e=0;e<i;++e)this.oO[e]=t.createRenderPassId(`RenderTargetTexture - ${this.name}#${e}`)}lO(t){if(t.ratio){this.AO=t.ratio;const i=this.qb();this.Qn={width:this.TO(i.getRenderWidth(),this.AO),height:this.TO(i.getRenderHeight(),this.AO)}}else this.Qn=t;this.xO()}get samples(){var t,i;return null!==(i=null===(t=this.rO)||void 0===t?void 0:t.samples)&&void 0!==i?i:this.dw}set samples(t){this.rO&&(this.dw=this.rO.setSamples(t))}resetRefreshCounter(){this.eO=-1}get refreshRate(){return this.sO}set refreshRate(t){this.sO=t,this.resetRefreshCounter()}addPostProcess(t){if(!this.RO){const t=this.getScene();if(!t)return;this.RO=new ae(t),this.vf=new Array}this.vf.push(t),this.vf[0].autoClear=!1}clearPostProcesses(t=!1){if(this.vf){if(t)for(const t of this.vf)t.dispose();this.vf=[]}}removePostProcess(t){if(!this.vf)return;const i=this.vf.indexOf(t);-1!==i&&(this.vf.splice(i,1),this.vf.length>0&&(this.vf[0].autoClear=!1))}ES(){return-1===this.eO||this.refreshRate===this.eO?(this.eO=1,!0):(this.eO++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this.Qn.width?this.Qn.width:this.Qn}getRenderHeight(){return this.Qn.width?this.Qn.height:this.Qn}getRenderLayers(){const t=this.Qn.layers;return t||0}disableRescaling(){this.nO=!1}get canRescale(){return this.nO}scale(t){const i=Math.max(1,this.getRenderSize()*t);this.resize(i)}getReflectionTextureMatrix(){return this.isCube?this.pO:super.getReflectionTextureMatrix()}resize(t){var i;const e=this.isCube;null===(i=this.rO)||void 0===i||i.dispose(),this.rO=null;const s=this.getScene();s&&(this.lO(t),this.rO=e?s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this.dO):s.getEngine().createRenderTargetTexture(this.Qn,this.dO),this.Lb=this.rO.texture,void 0!==this.dO.samples&&(this.samples=this.dO.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(t=!1,i=!1){this.IO(t,i)}isReadyForRendering(){return this.IO(!1,!1,!0)}IO(t=!1,i=!1,e=!1){var s;const n=this.getScene();if(!n)return e;const r=n.getEngine();if(void 0!==this.useCameraPostProcesses&&(t=this.useCameraPostProcesses),this.U_){this.renderList=[];for(let t=0;t<this.U_.length;t++){const i=this.U_[t],e=n.getMeshById(i);e&&this.renderList.push(e)}this.U_=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const t=this.getScene();if(!t)return e;const i=t.meshes;for(let t=0;t<i.length;t++){const e=i[t];this.renderListPredicate(e)&&this.renderList.push(e)}}const h=r.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const o=null!==(s=this.activeCamera)&&void 0!==s?s:n.activeCamera,a=n.activeCamera;o&&(o!==n.activeCamera&&(n.setTransformMatrix(o.getViewMatrix(),o.getProjectionMatrix(!0)),n.activeCamera=o),r.setViewport(o.viewport,this.getRenderWidth(),this.getRenderHeight())),this.MO=!1;let l=e;if(e){n.getViewMatrix()||n.updateTransformMatrix();const t=this.is2DArray?this.getRenderLayers():this.isCube?6:1;for(let i=0;i<t&&l;i++){let t=null;const s=this.renderList?this.renderList:n.getActiveMeshes().data,h=this.renderList?this.renderList.length:n.getActiveMeshes().length;r.currentRenderPassId=this.oO[i],this.onBeforeRenderObservable.notifyObservers(i),this.getCustomRenderList&&(t=this.getCustomRenderList(i,s,h)),t||(t=s),this.fO||n.updateTransformMatrix(!0);for(let i=0;i<t.length&&l;++i){const s=t[i];if(s.isEnabled()&&!s.isBlocked&&s.isVisible&&s.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(s,this.refreshRate,e)){l=!1;continue}}else if(!s.isReady(!0)){l=!1;continue}}this.onAfterRenderObservable.notifyObservers(i),(this.is2DArray||this.isCube)&&(n.incrementRenderId(),n.resetCachedMaterial())}}else if(this.is2DArray)for(let e=0;e<this.getRenderLayers();e++)this.bO(0,t,i,e,o),n.incrementRenderId(),n.resetCachedMaterial();else if(this.isCube)for(let e=0;e<6;e++)this.bO(e,t,i,void 0,o),n.incrementRenderId(),n.resetCachedMaterial();else this.bO(0,t,i,void 0,o);return this.onAfterUnbindObservable.notifyObservers(this),r.currentRenderPassId=h,a&&(n.activeCamera=a,(n.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==n.activeCamera)&&n.setTransformMatrix(n.activeCamera.getViewMatrix(),n.activeCamera.getProjectionMatrix(!0)),r.setViewport(n.activeCamera.viewport)),n.resetCachedMaterial(),l}TO(t,i){const e=t*i,s=Rs.NearestPOT(e+16384/(128+e));return Math.min(Rs.FloorPOT(t),s)}_O(t,i,e,s){const n=this.getScene();if(!n)return;this.vg.reset();const r=n.getRenderId();for(let h=0;h<i;h++){const i=t[h];if(i&&!i.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(i,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!i.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}if(!i._m.eS&&n.activeCamera&&(i._m.sS=n.customLODSelector?n.customLODSelector(i,this.activeCamera||n.activeCamera):i.getLOD(this.activeCamera||n.activeCamera),i._m.eS=!0),!i._m.sS)continue;let t,h=i._m.sS;if(h.QT(r),t=!(!s||!e)&&0==(i.layerMask&e.layerMask),i.isEnabled()&&i.isVisible&&i.subMeshes&&!t&&(h!==i&&h.rS(r,!0),i.rS(r,!0)&&i.subMeshes.length)){i.isAnInstance?i._m.hS&&(h=i):h._m.AT=!1,h._m.ET=!0;for(let t=0;t<h.subMeshes.length;t++){const i=h.subMeshes[t];this.vg.dispatch(i,h)}}}}for(let i=0;i<n.particleSystems.length;i++){const e=n.particleSystems[i],s=e.emitter;e.isStarted()&&s&&s.position&&s.isEnabled()&&(t.indexOf(s)>=0&&this.vg.dispatchParticles(e))}}fS(t=0,i=0){const e=this.getScene();if(!e)return;const s=e.getEngine();this.rO&&s.bindFramebuffer(this.rO,this.isCube?t:void 0,void 0,void 0,this.ignoreCameraViewport,0,i)}yO(t,i){this.rO&&t.unBindFramebuffer(this.rO,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(i)}))}mf(t,i,e,s){this.RO?this.mO||this.RO.mf(this.Lb,this.vf):s&&t.postProcessManager.mf(this.Lb)||this.fS(i,e)}bO(t,i,e,s=0,n=null){var r,h,o,a,l,c;const u=this.getScene();if(!u)return;const f=u.getEngine();null===(r=f.NO)||void 0===r||r.call(f,`render to face #${t} layer #${s}`,1),this.mf(u,t,s,i),this.is2DArray?(f.currentRenderPassId=this.oO[s],this.onBeforeRenderObservable.notifyObservers(s)):(f.currentRenderPassId=this.oO[t],this.onBeforeRenderObservable.notifyObservers(t));if(f.snapshotRendering&&1===f.snapshotRenderingMode)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(f):this.skipInitialClear||f.clear(this.clearColor||u.clearColor,!0,!0,!0);else{let r=null;const c=this.renderList?this.renderList:u.getActiveMeshes().data,d=this.renderList?this.renderList.length:u.getActiveMeshes().length;this.getCustomRenderList&&(r=this.getCustomRenderList(this.is2DArray?s:t,c,d)),r?this._O(r,r.length,n,this.forceLayerMaskCheck):(this.MO||(this._O(c,d,n,!this.renderList||this.forceLayerMaskCheck),this.MO=!0),r=c);for(const i of u.Gv)i.action(this,t,s);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(f):this.skipInitialClear||f.clear(this.clearColor||u.clearColor,!0,!0,!0),this.fO||u.updateTransformMatrix(!0);for(const i of u.qv)i.action(this,t,s);this.vg.render(this.customRenderFunction,r,this.renderParticles,this.renderSprites);for(const i of u.ig)i.action(this,t,s);const p=null!==(o=null===(h=this.Lb)||void 0===h?void 0:h.generateMipMaps)&&void 0!==o&&o;this.Lb&&(this.Lb.generateMipMaps=!1),this.RO?this.RO.Sf(!1,null!==(a=this.rO)&&void 0!==a?a:void 0,t,this.vf,this.ignoreCameraViewport):i&&u.postProcessManager.Sf(!1,null!==(l=this.rO)&&void 0!==l?l:void 0,t);for(const i of u.eg)i.action(this,t,s);this.Lb&&(this.Lb.generateMipMaps=p),this.fO||u.updateTransformMatrix(!0),e&&Mr.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),f)}this.yO(f,t),this.Lb&&this.isCube&&5===t&&f.generateMipMapsForCubemap(this.Lb),null===(c=f.PO)||void 0===c||c.call(f,1)}setRenderingOrder(t,i=null,e=null,s=null){this.vg.setRenderingOrder(t,i,e,s)}setRenderingAutoClearDepthStencil(t,i){this.vg.setRenderingAutoClearDepthStencil(t,i),this.vg.jf=!1}clone(){const t=this.getSize(),i=new br(this.name,t,this.getScene(),this.dO.generateMipMaps,this.fO,this.dO.type,this.isCube,this.dO.samplingMode,this.dO.generateDepthBuffer,this.dO.generateStencilBuffer,void 0,this.dO.format,void 0,this.dO.samples);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const t=super.serialize();if(t.renderTargetSize=this.getRenderSize(),t.renderList=[],this.renderList)for(let i=0;i<this.renderList.length;i++)t.renderList.push(this.renderList[i].id);return t}disposeFramebufferObjects(){var t;null===(t=this.rO)||void 0===t||t.dispose(!0)}releaseInternalTexture(){var t;null===(t=this.rO)||void 0===t||t.releaseTextures(),this.Lb=null}dispose(){var t;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this.RO&&(this.RO.dispose(),this.RO=null),this.vO&&this.vO.dispose(),this.wO(),this.clearPostProcesses(!0),this.cO&&(this.getScene().getEngine().onResizeObservable.remove(this.cO),this.cO=null),this.renderList=null;const i=this.getScene();if(!i)return;let e=i.customRenderTargets.indexOf(this);e>=0&&i.customRenderTargets.splice(e,1);for(const t of i.cameras)e=t.customRenderTargets.indexOf(this),e>=0&&t.customRenderTargets.splice(e,1);null===(t=this.rO)||void 0===t||t.dispose(),this.rO=null,this.Lb=null,super.dispose()}br(){this.refreshRate===br.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=br.REFRESHRATE_RENDER_ONCE),this.RO&&this.RO.br()}freeRenderingGroups(){this.vg&&this.vg.freeRenderingGroups()}getViewCount(){return 1}}br.REFRESHRATE_RENDER_ONCE=0,br.REFRESHRATE_RENDER_ONEVERYFRAME=1,br.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,an.V_=(t,i,e,s,n)=>new br(t,i,e,s);class _r{constructor(t){this.name=fe.NAME_PROCEDURALTEXTURE,this.scene=t,this.scene.proceduralTextures=new Array}register(){this.scene.kv.registerStep(fe.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this.DO)}rebuild(){}dispose(){}DO(){if(this.scene.proceduralTexturesEnabled){ki.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let t=0;t<this.scene.proceduralTextures.length;t++){const i=this.scene.proceduralTextures[t];i.ES()&&i.render()}ki.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}const yr="proceduralVertexShader",Nr="attribute vec2 position;\nvarying vec2 vPosition;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvPosition=position;\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[yr]=Nr;class Pr extends an{constructor(t,i,e,s,n=null,r=!0,o=!1,a=0){super(null,s,!r),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new h,this.onBeforeGenerationObservable=new h,this.nodeMaterialSource=null,this.sx={},this.eO=-1,this.sh=-1,this.sO=1,this.ff={},this.Cs=new Array,this.Ss=new Array,this.LO={},this.OO={},this.FO={},this.BO={},this.UO={},this.VO={},this.kO={},this.GO={},this.zO=!1,this.HO=null,this.XO=-1,this.WO=null;let l=(s=this.getScene()||E.LastCreatedScene).Mg(fe.NAME_PROCEDURALTEXTURE);l||(l=new _r(s),s.Ig(l)),s.proceduralTextures.push(this),this.$O=s.getEngine(),this.name=t,this.isRenderTarget=!0,this.Qn=i,this.tL=a,this.uO=r,this.SC=new vi(this.$O),this.setFragment(e),this.YO=n;const c=this.jO(o,i,r,a);this.Lb=c.texture;const u=[];u.push(1,1),u.push(-1,1),u.push(-1,-1),u.push(1,-1),this.ff[he.PositionKind]=new he(this.$O,u,he.PositionKind,!1,!1,2),this.KO()}jO(t,i,e,s){return t?(this.WO=this.$O.createRenderTargetCubeTexture(i,{generateMipMaps:e,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s}),this.setFloat("face",0)):this.WO=this.$O.createRenderTargetTexture(i,{generateMipMaps:e,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s}),this.WO}getEffect(){return this.SC.effect}qO(t){this.SC.effect=t}getContent(){return this.QO&&this.sh===this.XO||(this.QO?this.QO.then((t=>{this.QO=this.readPixels(0,0,t),this.XO=this.sh})):(this.QO=this.readPixels(0,0),this.XO=this.sh)),this.QO}KO(){const t=this.$O,i=[];i.push(0),i.push(1),i.push(2),i.push(0),i.push(2),i.push(3),this.Xu=t.createIndexBuffer(i)}br(){const t=this.ff[he.PositionKind];t&&t.br(),this.KO(),this.refreshRate===br.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=br.REFRESHRATE_RENDER_ONCE)}reset(){var t;null===(t=this.SC.effect)||void 0===t||t.dispose()}ZO(){return""}isReady(){const t=this.$O;let i;if(this.nodeMaterialSource)return this.SC.effect.isReady();if(!this.JO)return!1;if(this.zO)return!0;if(!this.Lb)return!1;const e=this.ZO();return!(!this.SC.effect||e!==this.HO||!this.SC.effect.isReady())||(i=void 0!==this.JO.fragmentElement?{vertex:"procedural",fragmentElement:this.JO.fragmentElement}:{vertex:"procedural",fragment:this.JO},this.HO!==e&&(this.HO=e,this.SC.effect=t.createEffect(i,[he.PositionKind],this.Cs,this.Ss,e,void 0,void 0,(()=>{var t;null===(t=this.WO)||void 0===t||t.dispose(),this.WO=this.Lb=null,this.YO&&(this.Lb=this.YO.Lb,this.Lb&&this.Lb.incrementReferences()),this.zO=!0}))),this.SC.effect.isReady())}resetRefreshCounter(){this.eO=-1}setFragment(t){this.JO=t}get refreshRate(){return this.sO}set refreshRate(t){this.sO=t,this.resetRefreshCounter()}ES(){return this.isEnabled&&this.isReady()&&this.Lb?!this.zO&&(-1===this.eO||this.refreshRate===this.eO?(this.eO=1,this.sh++,!0):(this.eO++,!1)):(this.Lb&&(this.Lb.isReady=!1),!1)}getRenderSize(){return this.Qn}resize(t,i){if(this.zO||!this.WO||!this.Lb)return;const e=this.Lb.isCube;this.WO.dispose();const s=this.jO(e,t,i,this.tL);this.Lb=s.texture,this.Qn=t,this.uO=i}tF(t){-1===this.Cs.indexOf(t)&&this.Cs.push(t)}setTexture(t,i){return-1===this.Ss.indexOf(t)&&this.Ss.push(t),this.sx[t]=i,this}setFloat(t,i){return this.tF(t),this.LO[t]=i,this}setInt(t,i){return this.tF(t),this.OO[t]=i,this}setFloats(t,i){return this.tF(t),this.FO[t]=i,this}setColor3(t,i){return this.tF(t),this.BO[t]=i,this}setColor4(t,i){return this.tF(t),this.UO[t]=i,this}setVector2(t,i){return this.tF(t),this.VO[t]=i,this}setVector3(t,i){return this.tF(t),this.kO[t]=i,this}setMatrix(t,i){return this.tF(t),this.GO[t]=i,this}render(t){var i,e;const s=this.getScene();if(!s)return;const n=this.$O;if(n.enableEffect(this.SC),this.onBeforeGenerationObservable.notifyObservers(this),n.setState(!1),!this.nodeMaterialSource){for(const t in this.sx)this.SC.effect.setTexture(t,this.sx[t]);for(const t in this.OO)this.SC.effect.setInt(t,this.OO[t]);for(const t in this.LO)this.SC.effect.setFloat(t,this.LO[t]);for(const t in this.FO)this.SC.effect.setArray(t,this.FO[t]);for(const t in this.BO)this.SC.effect.setColor3(t,this.BO[t]);for(const t in this.UO){const i=this.UO[t];this.SC.effect.setFloat4(t,i.r,i.g,i.b,i.a)}for(const t in this.VO)this.SC.effect.setVector2(t,this.VO[t]);for(const t in this.kO)this.SC.effect.setVector3(t,this.kO[t]);for(const t in this.GO)this.SC.effect.setMatrix(t,this.GO[t])}if(!this.Lb||!this.WO)return;null===(i=n.NO)||void 0===i||i.call(n,`procedural texture generation for ${this.name}`,1);const r=n.currentViewport;if(this.isCube)for(let t=0;t<6;t++)n.bindFramebuffer(this.WO,t,void 0,void 0,!0),n.bindBuffers(this.ff,this.Xu,this.SC.effect),this.SC.effect.setFloat("face",t),this.autoClear&&n.clear(s.clearColor,!0,!1,!1),n.drawElementsType(Vs.TriangleFillMode,0,6);else n.bindFramebuffer(this.WO,0,void 0,void 0,!0),n.bindBuffers(this.ff,this.Xu,this.SC.effect),this.autoClear&&n.clear(s.clearColor,!0,!1,!1),n.drawElementsType(Vs.TriangleFillMode,0,6);n.unBindFramebuffer(this.WO,this.isCube),r&&n.setViewport(r),this.isCube&&n.generateMipMapsForCubemap(this.Lb),null===(e=n.PO)||void 0===e||e.call(n,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const t=this.getSize(),i=new Pr(this.name,t.width,this.JO,this.getScene(),this.YO,this.uO);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,i}dispose(){const t=this.getScene();if(!t)return;const i=t.proceduralTextures.indexOf(this);i>=0&&t.proceduralTextures.splice(i,1);const e=this.ff[he.PositionKind];e&&(e.dispose(),this.ff[he.PositionKind]=null),this.Xu&&this.$O.ca(this.Xu)&&(this.Xu=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}var Dr;ut([Q()],Pr.prototype,"isEnabled",void 0),ut([Q()],Pr.prototype,"autoClear",void 0),ut([Q()],Pr.prototype,"_generateMipMaps",void 0),ut([Q()],Pr.prototype,"_size",void 0),ut([Q()],Pr.prototype,"refreshRate",null),v("BABYLON.ProceduralTexture",Pr),function(t){t[t.Cos=0]="Cos",t[t.Sin=1]="Sin",t[t.Abs=2]="Abs",t[t.Exp=3]="Exp",t[t.Exp2=4]="Exp2",t[t.Round=5]="Round",t[t.Floor=6]="Floor",t[t.Ceiling=7]="Ceiling",t[t.Sqrt=8]="Sqrt",t[t.Log=9]="Log",t[t.Tan=10]="Tan",t[t.ArcTan=11]="ArcTan",t[t.ArcCos=12]="ArcCos",t[t.ArcSin=13]="ArcSin",t[t.Fract=14]="Fract",t[t.Sign=15]="Sign",t[t.Radians=16]="Radians",t[t.Degrees=17]="Degrees"}(Dr||(Dr={}));class Lr extends kn{constructor(t){super(t,bn.Neutral),this.operation=Dr.Cos,this.registerInput("input",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0]}getClassName(){return"TrigonometryBlock"}get input(){return this.xd[0]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];let e="";switch(this.operation){case Dr.Cos:e="cos";break;case Dr.Sin:e="sin";break;case Dr.Abs:e="abs";break;case Dr.Exp:e="exp";break;case Dr.Exp2:e="exp2";break;case Dr.Round:e="round";break;case Dr.Floor:e="floor";break;case Dr.Ceiling:e="ceil";break;case Dr.Sqrt:e="sqrt";break;case Dr.Log:e="log";break;case Dr.Tan:e="tan";break;case Dr.ArcTan:e="atan";break;case Dr.ArcCos:e="acos";break;case Dr.ArcSin:e="asin";break;case Dr.Fract:e="fract";break;case Dr.Sign:e="sign";break;case Dr.Radians:e="radians";break;case Dr.Degrees:e="degrees"}return t.compilationString+=this.QP(i,t)+` = ${e}(${this.input.associatedVariableName});\r\n`,this}serialize(){const t=super.serialize();return t.operation=this.operation,t}uD(t,i,e){super.uD(t,i,e),this.operation=t.operation}aD(){return super.aD()+`${this.$P}.operation = BABYLON.TrigonometryBlockOperations.${Dr[this.operation]};\r\n`}}v("BABYLON.TrigonometryBlock",Lr);const Or={effect:null,subMesh:null};class Fr extends Wi{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(t,i,e=!1){void 0===this[t]&&this.re.push(t),e&&this[t]!==i&&this.markAsUnprocessed(),this[t]=i}}class Br extends Fn{constructor(t,i,e={}){super(t,i||E.LastCreatedScene),this.KP=Br.iF++,this.eF=!1,this.sF=new R,this.nF=new R,this.rF=new Array,this.hF=-1,this.BJSNODEMATERIALEDITOR=this.oF(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new h,this.aF=new Array,this.lF=new Array,this.attachedBlocks=new Array,this.uA=ar.Material,this.forceAlphaBlending=!1,this.wb={emitComments:!1,...e},this.$L(null)}static cF(t){return"TextureBlock"===t.getClassName()||"ReflectionTextureBaseBlock"===t.getClassName()||"RefractionBlock"===t.getClassName()||"CurrentScreenBlock"===t.getClassName()||"ParticleTextureBlock"===t.getClassName()||"ImageSourceBlock"===t.getClassName()||"TriPlanarBlock"===t.getClassName()||"BiPlanarBlock"===t.getClassName()}oF(){return"undefined"!=typeof NODEEDITOR?NODEEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeEditor?BABYLON:void 0}get options(){return this.wb}set options(t){this.wb=t}get imageProcessingConfiguration(){return this.Sg}set imageProcessingConfiguration(t){this.$L(t),this.UR()}get mode(){return this.uA}set mode(t){this.uA=t}get buildId(){return this.KP}set buildId(t){this.KP=t}getClassName(){return"NodeMaterial"}$L(t){t!==this.Sg&&(this.Sg&&this.uF&&this.Sg.onUpdateParameters.remove(this.uF),this.Sg=t||this.getScene().imageProcessingConfiguration,this.Sg&&(this.uF=this.Sg.onUpdateParameters.add((()=>{this.fI()}))))}getBlockByName(t){let i=null;for(const e of this.attachedBlocks)if(e.name===t){if(i)return ki.Warn("More than one block was found with the name `"+t+"`"),i;i=e}return i}getBlockByPredicate(t){for(const i of this.attachedBlocks)if(t(i))return i;return null}getInputBlockByPredicate(t){for(const i of this.attachedBlocks)if(i.isInput&&t(i))return i;return null}getInputBlocks(){const t=[];for(const i of this.attachedBlocks)i.isInput&&t.push(i);return t}registerOptimizer(t){if(!(this.rF.indexOf(t)>-1))return this.rF.push(t),this}unregisterOptimizer(t){const i=this.rF.indexOf(t);if(-1!==i)return this.rF.splice(i,1),this}addOutputNode(t){if(null===t.target)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return 0!=(t.target&bn.Vertex)&&this.fF(t),0!=(t.target&bn.Fragment)&&this.dF(t),this}removeOutputNode(t){return null===t.target||(0!=(t.target&bn.Vertex)&&this.pF(t),0!=(t.target&bn.Fragment)&&this.mF(t)),this}fF(t){if(-1===this.aF.indexOf(t))return t.target=bn.Vertex,this.aF.push(t),this}pF(t){const i=this.aF.indexOf(t);if(-1!==i)return this.aF.splice(i,1),this}dF(t){if(-1===this.lF.indexOf(t))return t.target=bn.Fragment,this.lF.push(t),this}mF(t){const i=this.lF.indexOf(t);if(-1!==i)return this.lF.splice(i,1),this}needAlphaBlending(){return!this.ignoreAlpha&&(this.forceAlphaBlending||this.alpha<1||this.vF&&this.vF.hints.needAlphaBlending)}needAlphaTesting(){return this.vF&&this.vF.hints.needAlphaTesting}gF(t,i,e,s=!0){if(t.initialize(i),s&&t.autoConfigure(this),t.SF=this.KP,-1===this.attachedBlocks.indexOf(t)){if(t.isUnique){const i=t.getClassName();for(const t of this.attachedBlocks)if(t.getClassName()===i)throw`Cannot have multiple blocks of type ${i} in the same NodeMaterial`}this.attachedBlocks.push(t)}for(const n of t.inputs){n.associatedVariableName="";const r=n.connectedPoint;if(r){const n=r.ownerBlock;n!==t&&((n.target===bn.VertexAndFragment||i.target===bn.Fragment&&n.target===bn.Vertex&&n.SF!==this.KP)&&e.push(n),this.gF(n,i,e,s))}}for(const i of t.outputs)i.associatedVariableName=""}EF(t,i){t.target===bn.VertexAndFragment&&(t.buildId=i);for(const e of t.inputs){const s=e.connectedPoint;if(s){const e=s.ownerBlock;e!==t&&this.EF(e,i)}}}removeBlock(t){const i=this.attachedBlocks.indexOf(t);i>-1&&this.attachedBlocks.splice(i,1),t.isFinalMerger&&this.removeOutputNode(t)}build(t=!1,i=!0,e=!0){this.eF=!1;const s=this.getScene().getEngine(),n=this.uA===ar.Particle;if(0===this.aF.length&&!n)throw"You must define at least one vertexOutputNode";if(0===this.lF.length)throw"You must define at least one fragmentOutputNode";this.AF=new Bn,this.AF.supportUniformBuffers=s.supportsUniformBuffers,this.AF.target=bn.Vertex,this.CF=new Bn,this.CF.supportUniformBuffers=s.supportsUniformBuffers,this.CF.target=bn.Fragment,this.vF=new Un,this.vF.fragmentOutputNodes=this.lF,this.AF.sharedData=this.vF,this.CF.sharedData=this.vF,this.vF.buildId=this.KP,this.vF.emitComments=this.wb.emitComments,this.vF.verbose=t,this.vF.scene=this.getScene(),this.vF.allowEmptyVertexProgram=n;const r=[],h=[];for(const t of this.aF)r.push(t),this.gF(t,this.AF,h,e);for(const t of this.lF)h.push(t),this.gF(t,this.CF,r,e);this.optimize();for(const t of r)t.build(this.AF,r);this.CF.uniforms=this.AF.uniforms.slice(0),this.CF.cP=this.AF.cP,this.CF.uP=this.AF.uP,this.CF.sD=this.AF;for(const t of h)this.EF(t,this.KP-1);for(const t of h)t.build(this.CF,h);this.AF.finalize(this.AF),this.CF.finalize(this.CF),i&&(this.KP=Br.iF++),this.vF.emitErrors(),t&&(console.log("Vertex shader:"),console.log(this.AF.compilationString),console.log("Fragment shader:"),console.log(this.CF.compilationString)),this.eF=!0,this.onBuildObservable.notifyObservers(this);const o=this.getScene().meshes;for(const t of o)if(t.subMeshes)for(const i of t.subMeshes){if(i.getMaterial()!==this)continue;if(!i.materialDefines)continue;const t=i.materialDefines;t.markAllAsDirty(),t.reset()}}optimize(){for(const t of this.rF)t.optimize(this.aF,this.lF)}wF(t,i){const e=i.NORMAL,s=i.TANGENT;i.NORMAL=t.isVerticesDataPresent(he.NormalKind),i.TANGENT=t.isVerticesDataPresent(he.TangentKind);let n=!1;for(let e=1;e<=6;++e){const s=i["UV"+e];i["UV"+e]=t.isVerticesDataPresent(`uv${1===e?"":e}`),n=n||i["UV"+e]!==s}(e!==i.NORMAL||s!==i.TANGENT||n)&&i.markAsAttributesDirty()}createPostProcess(t,i=1,e=1,s,n,r=0,h=5){return this.mode!==ar.PostProcess?(console.log("Incompatible material mode"),null):this.xF(null,t,i,e,s,n,r,h)}createEffectForPostProcess(t){this.xF(t)}xF(t,i,e=1,s=1,n,r,h=0,o=5){let a=this.name+this.KP;const l=new Fr,c=new ys(a+"PostProcess",this.getScene());let u=this.KP;return this.TF(c,l),ei.RegisterShader(a,this.CF.vP,this.AF.vP),t?t.updateEffect(l.toString(),this.CF.uniforms,this.CF.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,a,a):t=new nr(this.name+"PostProcess",a,this.CF.uniforms,this.CF.samplers,e,i,s,n,r,l.toString(),h,a,{maxSimultaneousLights:this.maxSimultaneousLights},!1,o),t.nodeMaterialSource=this,t.onApplyObservable.add((i=>{u!==this.KP&&(delete ei.ShadersStore[a+"VertexShader"],delete ei.ShadersStore[a+"PixelShader"],a=this.name+this.KP,l.markAllAsDirty(),u=this.KP);this.TF(c,l)&&(ei.RegisterShader(a,this.CF.vP,this.AF.vP),Ai.SetImmediate((()=>t.updateEffect(l.toString(),this.CF.uniforms,this.CF.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,a,a)))),this.RF(i)})),t}createProceduralTexture(t,i){if(this.mode!==ar.ProceduralTexture)return console.log("Incompatible material mode"),null;let e=this.name+this.KP;const s=new Pr(e,t,null,i),n=new ys(e+"Procedural",this.getScene());n.reservedDataStore={hidden:!0};const r=new Fr,h=this.TF(n,r);ei.RegisterShader(e,this.CF.vP,this.AF.vP);let o=this.getScene().getEngine().createEffect({vertexElement:e,fragmentElement:e},[he.PositionKind],this.CF.uniforms,this.CF.samplers,r.toString(),null==h?void 0:h.fallbacks,void 0);s.nodeMaterialSource=this,s.qO(o);let a=this.KP;return s.onBeforeGenerationObservable.add((()=>{a!==this.KP&&(delete ei.ShadersStore[e+"VertexShader"],delete ei.ShadersStore[e+"PixelShader"],e=this.name+this.KP,r.markAllAsDirty(),a=this.KP);const t=this.TF(n,r);t&&(ei.RegisterShader(e,this.CF.vP,this.AF.vP),Ai.SetImmediate((()=>{o=this.getScene().getEngine().createEffect({vertexElement:e,fragmentElement:e},[he.PositionKind],this.CF.uniforms,this.CF.samplers,r.toString(),null==t?void 0:t.fallbacks,void 0),s.qO(o)}))),this.RF(o)})),s}IF(t,i,e,s,n,r,h,o=""){let a=this.name+this.KP+"_"+i;r||(r=new Fr),h||(h=this.getScene().getMeshByName(this.name+"Particle"))||((h=new ys(this.name+"Particle",this.getScene())).reservedDataStore={hidden:!0});let l=this.KP;const c=[];let u=o;if(!n){const o=this.TF(h,r);ei.RegisterShader(a,this.CF.vP),t.fillDefines(c,i),u=c.join("\n"),n=this.getScene().getEngine().createEffectForParticles(a,this.CF.uniforms,this.CF.samplers,r.toString()+"\n"+u,null==o?void 0:o.fallbacks,e,s,t),t.setCustomEffect(n,i)}n.onBindObservable.add((n=>{l!==this.KP&&(delete ei.ShadersStore[a+"PixelShader"],a=this.name+this.KP+"_"+i,r.markAllAsDirty(),l=this.KP),c.length=0,t.fillDefines(c,i);const f=c.join("\n");f!==u&&(r.markAllAsDirty(),u=f);const d=this.TF(h,r);if(d)return ei.RegisterShader(a,this.CF.vP),n=this.getScene().getEngine().createEffectForParticles(a,this.CF.uniforms,this.CF.samplers,r.toString()+"\n"+u,null==d?void 0:d.fallbacks,e,s,t),t.setCustomEffect(n,i),void this.IF(t,i,e,s,n,r,h,o);this.RF(n)}))}RF(t){if(this.vF.animatedInputs){const t=this.getScene(),i=t.getFrameId();if(this.hF!==i){for(const i of this.vF.animatedInputs)i.animate(t);this.hF=i}}for(const i of this.vF.bindableBlocks)i.bind(t,this);for(const i of this.vF.inputBlocks)i.RD(t,this.getScene(),this)}createEffectForParticles(t,i,e){this.mode===ar.Particle?(this.IF(t,Er.BLENDMODE_ONEONE,i,e),this.IF(t,Er.BLENDMODE_MULTIPLY,i,e)):console.log("Incompatible material mode")}createAsShadowDepthWrapper(t){this.mode===ar.Material?t.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene()):console.log("Incompatible material mode")}TF(t,i,e=!1,s){let n=null;const r=this.getScene();if(Fs.PrepareDefinesForCamera(r,i)&&i.markAsMiscDirty(),this.vF.blocksWithDefines.forEach((s=>{s.initializeDefines(t,this,i,e)})),this.vF.blocksWithDefines.forEach((n=>{n.prepareDefines(t,this,i,e,s)})),i.isDirty){const e=i.Ml;i.markAsProcessed(),this.AF.compilationString=this.AF.vP,this.CF.compilationString=this.CF.vP,this.vF.repeatableContentBlocks.forEach((e=>{e.replaceRepeatableContent(this.AF,this.CF,t,i)}));const s=[];this.vF.dynamicUniformBlocks.forEach((t=>{t.updateUniformsAndSamples(this.AF,this,i,s)}));const r=this.AF.uniforms;this.CF.uniforms.forEach((t=>{-1===r.indexOf(t)&&r.push(t)}));const h=this.AF.samplers;this.CF.samplers.forEach((t=>{-1===h.indexOf(t)&&h.push(t)}));const o=new Jn;this.vF.blocksWithFallbacks.forEach((i=>{i.provideFallbacks(t,o)})),n={lightDisposed:e,uniformBuffers:s,mergedUniforms:r,mergedSamplers:h,fallbacks:o}}return n}isReadyForSubMesh(t,i,e=!1){if(!this.eF)return!1;const s=this.getScene();if(this.vF.animatedInputs){const t=s.getFrameId();if(this.hF!==t){for(const t of this.vF.animatedInputs)t.animate(s);this.hF=t}}if(i.effect&&this.isFrozen&&i.effect.cs&&i.effect.fs===e)return!0;i.materialDefines||(i.materialDefines=new Fr);const n=i.materialDefines;if(this.oP(i))return!0;const r=s.getEngine();if(this.wF(t,n),this.vF.blockingBlocks.some((i=>!i.isReady(t,this,n,e))))return!1;const h=this.TF(t,n,e,i);if(h){const t=i.effect,e=n.toString();let o=r.createEffect({vertex:"nodeMaterial"+this.KP,fragment:"nodeMaterial"+this.KP,vertexSource:this.AF.compilationString,fragmentSource:this.CF.compilationString},{attributes:this.AF.attributes,uniformsNames:h.mergedUniforms,uniformBuffersNames:h.uniformBuffers,samplers:h.mergedSamplers,defines:e,fallbacks:h.fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS}},r);if(o)if(this.$R&&(Or.effect=o,Or.subMesh=i,this.$R.notifyObservers(Or)),this.allowShaderHotSwapping&&t&&!o.isReady()){if(o=t,n.markAsUnprocessed(),h.lightDisposed)return n.Ml=!0,!1}else s.resetCachedMaterial(),i.setEffect(o,n,this.WR)}return!(!i.effect||!i.effect.isReady())&&(n.Sv=s.getRenderId(),i.effect.cs=!0,i.effect.fs=e,s.performancePriority!==Fe.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}get compiledShaders(){return`// Vertex shader\r\n${this.AF.compilationString}\r\n\r\n// Fragment shader\r\n${this.CF.compilationString}`}bindOnlyWorldMatrix(t){const i=this.getScene();if(!this.hP)return;const e=this.vF.hints;e.needWorldViewMatrix&&t.multiplyToRef(i.getViewMatrix(),this.sF),e.needWorldViewProjectionMatrix&&t.multiplyToRef(i.getTransformMatrix(),this.nF);for(const i of this.vF.inputBlocks)i.TD(this.hP,t,this.sF,this.nF)}bindForSubMesh(t,i,e){const s=this.getScene(),n=e.effect;if(!n)return;this.hP=n,this.bindOnlyWorldMatrix(t);const r=this.aP(s,n,i.visibility),h=this.vF;if(r){for(const t of h.bindableBlocks)t.bind(n,this,i,e);for(const t of h.forcedBindableBlocks)t.bind(n,this,i,e);for(const t of h.inputBlocks)t.RD(n,s,this)}else if(!this.isFrozen)for(const t of h.forcedBindableBlocks)t.bind(n,this,i,e);this.tI(i,this.hP)}getActiveTextures(){const t=super.getActiveTextures();return this.vF&&t.push(...this.vF.textureBlocks.filter((t=>t.texture)).map((t=>t.texture))),t}getTextureBlocks(){return this.vF?this.vF.textureBlocks:[]}getAllTextureBlocks(){const t=[];for(const i of this.attachedBlocks)Br.cF(i)&&t.push(i);return t}hasTexture(t){if(super.hasTexture(t))return!0;if(!this.vF)return!1;for(const i of this.vF.textureBlocks)if(i.texture===t)return!0;return!1}dispose(t,i,e){if(i)for(const t of this.getTextureBlocks().filter((t=>t.texture)).map((t=>t.texture)))t.dispose();for(const t of this.attachedBlocks)t.dispose();this.attachedBlocks.length=0,this.vF=null,this.AF=null,this.CF=null,this.onBuildObservable.clear(),this.uF&&(this.Sg.onUpdateParameters.remove(this.uF),this.uF=null),super.dispose(t,i,e)}MF(){this.BJSNODEMATERIALEDITOR.NodeEditor.Show({nodeMaterial:this})}edit(t){return new Promise((i=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this.oF(),void 0===this.BJSNODEMATERIALEDITOR){const e=t&&t.editorURL?t.editorURL:Br.EditorURL;ki.LoadScript(e,(()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this.oF(),this.MF(),i()}))}else this.MF(),i()}))}clear(){this.aF.length=0,this.lF.length=0,this.attachedBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;const t=new jn("Position");t.setAsAttribute("position");const i=new jn("World");i.setAsSystemValue(Dn.World);const e=new Gn("WorldPos");t.connectTo(e),i.connectTo(e);const s=new jn("ViewProjection");s.setAsSystemValue(Dn.ViewProjection);const n=new Gn("WorldPos * ViewProjectionTransform");e.connectTo(n),s.connectTo(n);const r=new zn("VertexOutput");n.connectTo(r);const h=new jn("color");h.value=new y(.8,.8,.8,1);const o=new Xn("FragmentOutput");h.connectTo(o),this.addOutputNode(r),this.addOutputNode(o),this.uA=ar.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const t=new jn("Position");t.setAsAttribute("position2d");const i=new jn("Constant1");i.isConstant=!0,i.value=1;const e=new rr("Position3D");t.connectTo(e),i.connectTo(e,{input:"w"});const s=new zn("VertexOutput");e.connectTo(s);const n=new jn("Scale");n.visibleInInspector=!0,n.value=new C(1,1);const r=new hr("uv0");t.connectTo(r);const h=new or("UV scale");r.connectTo(h),n.connectTo(h);const o=new Kn("CurrentScreen");h.connectTo(o),o.texture=new an("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const a=new Xn("FragmentOutput");o.connectTo(a,{output:"rgba"}),this.addOutputNode(s),this.addOutputNode(a),this.uA=ar.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const t=new jn("Position");t.setAsAttribute("position2d");const i=new jn("Constant1");i.isConstant=!0,i.value=1;const e=new rr("Position3D");t.connectTo(e),i.connectTo(e,{input:"w"});const s=new zn("VertexOutput");e.connectTo(s);const n=new jn("Time");n.value=0,n.min=0,n.max=0,n.isBoolean=!1,n.matrixMode=0,n.animationType=Ln.Time,n.isConstant=!1;const r=new jn("Color3");r.value=new _(1,1,1),r.isConstant=!1;const h=new Xn("FragmentOutput"),o=new rr("VectorMerger");o.visibleInInspector=!1;const a=new Lr("Cos");a.operation=Dr.Cos,t.connectTo(o),n.output.connectTo(a.input),a.output.connectTo(o.z),o.xyzOut.connectTo(h.rgb),this.addOutputNode(s),this.addOutputNode(h),this.uA=ar.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const t=new jn("uv");t.setAsAttribute("particle_uv");const i=new qn("ParticleTexture");t.connectTo(i);const e=new jn("Color");e.setAsAttribute("particle_color");const s=new or("Texture * Color");i.connectTo(s),e.connectTo(s);const n=new Qn("ParticleRampGradient");s.connectTo(n);const r=new Ar("ColorSplitter");e.connectTo(r);const h=new Zn("ParticleBlendMultiply");n.connectTo(h),i.connectTo(h,{output:"a"}),r.connectTo(h,{output:"a"});const o=new Xn("FragmentOutput");h.connectTo(o),this.addOutputNode(o),this.uA=ar.Particle}async loadAsync(t,i=""){return Br.ParseFromFileAsync("",t,this.getScene(),i,!0,this)}bF(t,i){if(-1===i.indexOf(t)){i.push(t);for(const e of t.inputs){const s=e.connectedPoint;if(s){const e=s.ownerBlock;e!==t&&this.bF(e,i)}}}}generateCode(){let t=[];const i=[],e=["const","var","let"];for(const t of this.aF)this.bF(t,i);const s=[];for(const t of this.lF)this.bF(t,s);let n=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\r\n`;for(const s of i)s.isInput&&-1===t.indexOf(s)&&(n+=s.lD(e,t));for(const i of s)i.isInput&&-1===t.indexOf(i)&&(n+=i.lD(e,t));t=[],n+="\r\n// Connections\r\n";for(const i of this.aF)n+=i.cD(t);for(const i of this.lF)n+=i.cD(t);n+="\r\n// Output nodes\r\n";for(const t of this.aF)n+=`nodeMaterial.addOutputNode(${t.$P});\r\n`;for(const t of this.lF)n+=`nodeMaterial.addOutputNode(${t.$P});\r\n`;return n+="nodeMaterial.build();\r\n",n}serialize(t){const i=t?{}:ot.Serialize(this);i.editorData=JSON.parse(JSON.stringify(this.editorData));let e=[];if(t)e=t;else{i.customType="BABYLON.NodeMaterial",i.outputNodes=[];for(const t of this.aF)this.bF(t,e),i.outputNodes.push(t.uniqueId);for(const t of this.lF)this.bF(t,e),-1===i.outputNodes.indexOf(t.uniqueId)&&i.outputNodes.push(t.uniqueId)}i.blocks=[];for(const t of e)i.blocks.push(t.serialize());if(!t)for(const t of this.attachedBlocks)-1===e.indexOf(t)&&i.blocks.push(t.serialize());return i}_F(t,i,e){for(const s of t.outputs)for(const n of i.blocks){const r=e[n.id];if(r)for(const h of n.inputs)if(e[h.targetBlockId]!==t||h.targetConnectionName!==s.name);else{const t=r.getInputByName(h.inputName);if(!t||t.isConnected)continue;s.connectTo(t,!0),this._F(r,i,e)}}}parseSerializedObject(t,i="",e=!1){var s;e||this.clear();const n={};for(const e of t.blocks){const t=g(e.customType);if(t){const s=new t;s.uD(e,this.getScene(),i),n[e.id]=s,this.attachedBlocks.push(s)}}for(let i=0;i<t.blocks.length;i++){const s=n[t.blocks[i].id];s&&(s.inputs.length&&!e||this._F(s,t,n))}if(t.outputNodes)for(const i of t.outputNodes)this.addOutputNode(n[i]);if(t.locations||t.editorData&&t.editorData.locations){const i=t.locations||t.editorData.locations;for(const t of i)n[t.blockId]&&(t.blockId=n[t.blockId].uniqueId);e&&this.editorData&&this.editorData.locations&&i.concat(this.editorData.locations),t.locations?this.editorData={locations:i}:(this.editorData=t.editorData,this.editorData.locations=i);const s=[];for(const t in n)s[t]=n[t].uniqueId;this.editorData.map=s}this.comment=t.comment,void 0!==t.forceAlphaBlending&&(this.forceAlphaBlending=t.forceAlphaBlending),e||(this.uA=null!==(s=t.mode)&&void 0!==s?s:ar.Material)}loadFromSerialization(t,i="",e=!1){this.parseSerializedObject(t,i,e)}clone(t,i=!1){const e=this.serialize(),s=ot.Clone((()=>new Br(t,this.getScene(),this.options)),this);return s.id=t,s.name=t,s.parseSerializedObject(e),s.KP=this.KP,s.build(!1,!i),s}static Parse(t,i,e=""){const s=ot.Parse((()=>new Br(t.name,i)),t,i,e);return s.parseSerializedObject(t,e),s.build(),s}static async ParseFromFileAsync(t,i,e,s="",n=!1,r){const h=null!=r?r:new Br(t,e),o=await e.OS(i),a=JSON.parse(o);return h.parseSerializedObject(a,s),n||h.build(),h}static ParseFromSnippetAsync(t,i=E.LastCreatedScene,e="",s,n=!1){return"_BLANK"===t?Promise.resolve(Br.CreateDefault("blank",i)):new Promise(((r,h)=>{const o=new mt;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const a=JSON.parse(JSON.parse(o.responseText).jsonPayload),l=JSON.parse(a.nodeMaterial);s||((s=ot.Parse((()=>new Br(t,i)),l,i,e)).uniqueId=i.getUniqueId()),s.parseSerializedObject(l),s.snippetId=t;try{n||s.build(),r(s)}catch(t){h(t)}}else h("Unable to load the snippet "+t)})),o.open("GET",this.SnippetUrl+"/"+t.replace(/#/g,"/")),o.send()}))}static CreateDefault(t,i){const e=new Br(t,i);return e.setToDefault(),e.build(),e}}function Ur(t){const i=t.sideOrientation||os.DEFAULTSIDE,e=t.radius||1,s=void 0===t.flat||t.flat,n=t.subdivisions||4,r=t.radiusX||e,h=t.radiusY||e,o=t.radiusZ||e,a=(1+Math.sqrt(5))/2,l=[-1,a,-0,1,a,0,-1,-a,0,1,-a,0,0,-1,-a,0,1,-a,0,-1,a,0,1,a,a,0,1,a,0,-1,-a,0,1,-a,0,-1],c=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],u=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],f=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],d=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],p=new Array,m=new Array,v=new Array,g=new Array;let S=0;const E=new Array(3),A=new Array(3);let x;for(x=0;x<3;x++)E[x]=w.Zero(),A[x]=C.Zero();for(let t=0;t<20;t++){for(x=0;x<3;x++){const i=c[3*t+x];E[x].copyFromFloats(l[3*u[i]],l[3*u[i]+1],l[3*u[i]+2]),E[x].normalize(),A[x].copyFromFloats(.134765625*f[2*i]+.05859375+-.0390625*d[t],.2333984375*f[2*i+1]+.025390625+.01953125*d[t])}const i=(t,i,e,a)=>{const l=w.Lerp(E[0],E[2],i/n),c=w.Lerp(E[1],E[2],i/n),u=n===i?E[2]:w.Lerp(l,c,t/(n-i));let f;if(u.normalize(),s){const t=w.Lerp(E[0],E[2],a/n),i=w.Lerp(E[1],E[2],a/n);f=w.Lerp(t,i,e/(n-a))}else f=new w(u.x,u.y,u.z);f.x/=r,f.y/=h,f.z/=o,f.normalize();const d=C.Lerp(A[0],A[2],i/n),x=C.Lerp(A[1],A[2],i/n),T=n===i?A[2]:C.Lerp(d,x,t/(n-i));m.push(u.x*r,u.y*h,u.z*o),v.push(f.x,f.y,f.z),g.push(T.x,As.UseOpenGLOrientationForUV?1-T.y:T.y),p.push(S),S++};for(let t=0;t<n;t++)for(let e=0;e+t<n;e++)i(e,t,e+1/3,t+1/3),i(e+1,t,e+1/3,t+1/3),i(e,t+1,e+1/3,t+1/3),e+t+1<n&&(i(e+1,t,e+2/3,t+2/3),i(e+1,t+1,e+2/3,t+2/3),i(e,t+1,e+2/3,t+2/3))}os.JA(i,m,p,v,g,t.frontUVs,t.backUVs);const T=new os;return T.indices=p,T.positions=m,T.normals=v,T.uvs=g,T}function Vr(t,i={},e=null){const s=new Ys(t,e);i.sideOrientation=Ys.OI(i.sideOrientation),s.yI=i.sideOrientation;return Ur(i).applyToMesh(s,i.updatable),s}Br.iF=0,Br.EditorURL=`https://unpkg.com/babylonjs-node-editor@${Rs.Version}/babylon.nodeEditor.js`,Br.SnippetUrl="https://snippet.babylonjs.com",Br.IgnoreTexturesAtLoadTime=!1,ut([Q()],Br.prototype,"ignoreAlpha",void 0),ut([Q()],Br.prototype,"maxSimultaneousLights",void 0),ut([Q("mode")],Br.prototype,"_mode",void 0),ut([Q("comment")],Br.prototype,"comment",void 0),ut([Q()],Br.prototype,"forceAlphaBlending",void 0),v("BABYLON.NodeMaterial",Br);var kr,Gr;os.CreateIcoSphere=Ur,Ys.CreateIcoSphere=(t,i,e)=>Vr(t,i,e),function(t){t.WRIST="wrist",t.THUMB="thumb",t.INDEX="index",t.MIDDLE="middle",t.RING="ring",t.LITTLE="little"}(kr||(kr={})),function(t){t.WRIST="wrist",t.THUMB_METACARPAL="thumb-metacarpal",t.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",t.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",t.THUMB_TIP="thumb-tip",t.INDEX_FINGER_METACARPAL="index-finger-metacarpal",t.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",t.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",t.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",t.INDEX_FINGER_TIP="index-finger-tip",t.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",t.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",t.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",t.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",t.MIDDLE_FINGER_TIP="middle-finger-tip",t.RING_FINGER_METACARPAL="ring-finger-metacarpal",t.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",t.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",t.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",t.RING_FINGER_TIP="ring-finger-tip",t.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",t.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",t.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",t.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",t.PINKY_FINGER_TIP="pinky-finger-tip"}(Gr||(Gr={}));const zr=[Gr.WRIST,Gr.THUMB_METACARPAL,Gr.THUMB_PHALANX_PROXIMAL,Gr.THUMB_PHALANX_DISTAL,Gr.THUMB_TIP,Gr.INDEX_FINGER_METACARPAL,Gr.INDEX_FINGER_PHALANX_PROXIMAL,Gr.INDEX_FINGER_PHALANX_INTERMEDIATE,Gr.INDEX_FINGER_PHALANX_DISTAL,Gr.INDEX_FINGER_TIP,Gr.MIDDLE_FINGER_METACARPAL,Gr.MIDDLE_FINGER_PHALANX_PROXIMAL,Gr.MIDDLE_FINGER_PHALANX_INTERMEDIATE,Gr.MIDDLE_FINGER_PHALANX_DISTAL,Gr.MIDDLE_FINGER_TIP,Gr.RING_FINGER_METACARPAL,Gr.RING_FINGER_PHALANX_PROXIMAL,Gr.RING_FINGER_PHALANX_INTERMEDIATE,Gr.RING_FINGER_PHALANX_DISTAL,Gr.RING_FINGER_TIP,Gr.PINKY_FINGER_METACARPAL,Gr.PINKY_FINGER_PHALANX_PROXIMAL,Gr.PINKY_FINGER_PHALANX_INTERMEDIATE,Gr.PINKY_FINGER_PHALANX_DISTAL,Gr.PINKY_FINGER_TIP],Hr={[kr.WRIST]:[Gr.WRIST],[kr.THUMB]:[Gr.THUMB_METACARPAL,Gr.THUMB_PHALANX_PROXIMAL,Gr.THUMB_PHALANX_DISTAL,Gr.THUMB_TIP],[kr.INDEX]:[Gr.INDEX_FINGER_METACARPAL,Gr.INDEX_FINGER_PHALANX_PROXIMAL,Gr.INDEX_FINGER_PHALANX_INTERMEDIATE,Gr.INDEX_FINGER_PHALANX_DISTAL,Gr.INDEX_FINGER_TIP],[kr.MIDDLE]:[Gr.MIDDLE_FINGER_METACARPAL,Gr.MIDDLE_FINGER_PHALANX_PROXIMAL,Gr.MIDDLE_FINGER_PHALANX_INTERMEDIATE,Gr.MIDDLE_FINGER_PHALANX_DISTAL,Gr.MIDDLE_FINGER_TIP],[kr.RING]:[Gr.RING_FINGER_METACARPAL,Gr.RING_FINGER_PHALANX_PROXIMAL,Gr.RING_FINGER_PHALANX_INTERMEDIATE,Gr.RING_FINGER_PHALANX_DISTAL,Gr.RING_FINGER_TIP],[kr.LITTLE]:[Gr.PINKY_FINGER_METACARPAL,Gr.PINKY_FINGER_PHALANX_PROXIMAL,Gr.PINKY_FINGER_PHALANX_INTERMEDIATE,Gr.PINKY_FINGER_PHALANX_DISTAL,Gr.PINKY_FINGER_TIP]};class Xr{constructor(t,i,e,s,n=!1,r=!1,h=1){this.xrController=t,this.yF=i,this.NF=e,this.rigMapping=s,this.PF=n,this.DF=r,this.LF=h,this.OF=new Array(zr.length),this.FF=new Float32Array(16*zr.length),this.BF=new R,this.UF=new Float32Array(zr.length),this.Kt=i[0].getScene();for(let t=0;t<this.OF.length;t++){(this.OF[t]=new Is(zr[t],this.Kt)).rotationQuaternion=new T,i[t].rotationQuaternion=new T}e&&this.setHandMesh(e,s),this.xrController.motionController&&(this.xrController.motionController.rootMesh?this.xrController.motionController.rootMesh.setEnabled(!1):this.xrController.motionController.onModelLoadedObservable.add((t=>{t.rootMesh&&t.rootMesh.setEnabled(!1)}))),this.xrController.onMotionControllerInitObservable.add((t=>{t.onModelLoadedObservable.add((t=>{t.rootMesh&&t.rootMesh.setEnabled(!1)})),t.rootMesh&&t.rootMesh.setEnabled(!1)}))}get handMesh(){return this.NF}getHandPartMeshes(t){return Hr[t].map((t=>this.yF[zr.indexOf(t)]))}getJointMesh(t){return this.yF[zr.indexOf(t)]}setHandMesh(t,i){if(this.NF=t,t.alwaysSelectAsActiveMesh=!0,t.getChildMeshes().forEach((t=>t.alwaysSelectAsActiveMesh=!0)),this.NF.skeleton){const t=this.NF.skeleton;zr.forEach(((e,s)=>{const n=t.getBoneIndexByName(i?i[e]:e);-1!==n&&t.bones[n].linkTransformNode(this.OF[s])}))}}updateFromXRFrame(t,i){const e=this.xrController.inputSource.hand;if(!e)return;const s=e,n=zr.map((t=>s[t]||e.get(t)));let r=!1;if(t.fillPoses&&t.fillJointRadii)r=t.fillPoses(n,i,this.FF)&&t.fillJointRadii(n,this.UF);else if(t.getJointPose){r=!0;for(let e=0;e<n.length;e++){const s=t.getJointPose(n[e],i);if(!s){r=!1;break}this.FF.set(s.transform.matrix,16*e),this.UF[e]=s.radius||.008}}r&&(zr.forEach(((t,i)=>{const e=this.OF[i];R.FromArrayToRef(this.FF,16*i,this.BF),this.BF.decompose(void 0,e.rotationQuaternion,e.position);const s=this.UF[i]*this.LF,n=this.yF[i];n.isVisible=!this.NF&&!this.DF,n.position.copyFrom(e.position),n.rotationQuaternion.copyFrom(e.rotationQuaternion),n.scaling.setAll(s),this.Kt.useRightHandedSystem||(n.position.z*=-1,n.rotationQuaternion.z*=-1,n.rotationQuaternion.w*=-1,this.PF&&this.NF&&(e.position.z*=-1,e.rotationQuaternion.z*=-1,e.rotationQuaternion.w*=-1))})),this.NF&&(this.NF.isVisible=!0))}dispose(){this.NF&&(this.NF.isVisible=!1)}}class Wr extends xn{constructor(t,i){super(t),this.options=i,this.VF={},this.kF={left:null,right:null},this.GF={jointMeshes:null,handMeshes:null,rigMappings:null},this.onHandAddedObservable=new h,this.onHandRemovedObservable=new h,this.zF=t=>{var i,e,s;if(!t.inputSource.hand||"none"==t.inputSource.handedness||!this.GF.jointMeshes)return;const n=t.inputSource.handedness,r=new Xr(t,this.GF.jointMeshes[n],this.GF.handMeshes&&this.GF.handMeshes[n],this.GF.rigMappings&&this.GF.rigMappings[n],null===(i=this.options.handMeshes)||void 0===i?void 0:i.meshesUseLeftHandedCoordinates,null===(e=this.options.jointMeshes)||void 0===e?void 0:e.invisible,null===(s=this.options.jointMeshes)||void 0===s?void 0:s.scaleFactor);this.VF[t.uniqueId]=r,this.kF[n]=r,this.onHandAddedObservable.notifyObservers(r)},this.HF=t=>{this.XF(t.uniqueId)},this.xrNativeFeatureName="hand-tracking";const e=i.jointMeshes;if(e&&(void 0!==e.disableDefaultHandMesh&&(i.handMeshes=i.handMeshes||{},i.handMeshes.disableDefaultMeshes=e.disableDefaultHandMesh),void 0!==e.handMeshes&&(i.handMeshes=i.handMeshes||{},i.handMeshes.customMeshes=e.handMeshes),void 0!==e.leftHandedSystemMeshes&&(i.handMeshes=i.handMeshes||{},i.handMeshes.meshesUseLeftHandedCoordinates=e.leftHandedSystemMeshes),void 0!==e.rigMapping)){i.handMeshes=i.handMeshes||{};const t={},s={};[[e.rigMapping.left,t],[e.rigMapping.right,s]].forEach((t=>{const i=t[0],e=t[1];i.forEach(((t,i)=>{e[zr[i]]=t}))})),i.handMeshes.customRigMappings={left:t,right:s}}}static WF(t){const i={};return["left","right"].map((e=>{var s,n,r,h,o;const a=[],l=(null===(s=t.jointMeshes)||void 0===s?void 0:s.sourceMesh)||Vr("jointParent",Wr.$F);l.isVisible=!!(null===(n=t.jointMeshes)||void 0===n?void 0:n.keepOriginalVisible);for(let i=0;i<zr.length;++i){let s=l.createInstance(`${e}-handJoint-${i}`);if(null===(r=t.jointMeshes)||void 0===r?void 0:r.onHandJointMeshGenerated){const n=t.jointMeshes.onHandJointMeshGenerated(s,i,e);n&&n!==s&&(s.dispose(),s=n)}if(s.isPickable=!1,null===(h=t.jointMeshes)||void 0===h?void 0:h.enablePhysics){const i=(null===(o=t.jointMeshes)||void 0===o?void 0:o.physicsProps)||{};s.scaling.setAll(.02);const e=void 0!==i.impostorType?i.impostorType:Rn.SphereImpostor;s.physicsImpostor=new Rn(s,e,{mass:0,...i})}s.rotationQuaternion=new T,s.isVisible=!1,a.push(s)}i[e]=a})),{left:i.left,right:i.right}}static YF(t,i){return new Promise((async e=>{var s,n,r,h,o;const a={};(null===(n=null===(s=Wr.jF)||void 0===s?void 0:s.meshes[1])||void 0===n?void 0:n.isDisposed())&&(Wr.jF=null),(null===(h=null===(r=Wr.KF)||void 0===r?void 0:r.meshes[1])||void 0===h?void 0:h.isDisposed())&&(Wr.KF=null);const l=!(!Wr.jF||!Wr.KF),c=await Promise.all([Wr.jF||On.ImportMeshAsync("",Wr.DEFAULT_HAND_MODEL_BASE_URL,Wr.DEFAULT_HAND_MODEL_RIGHT_FILENAME,t),Wr.KF||On.ImportMeshAsync("",Wr.DEFAULT_HAND_MODEL_BASE_URL,Wr.DEFAULT_HAND_MODEL_LEFT_FILENAME,t)]);Wr.jF=c[0],Wr.KF=c[1];const u=new Br("handShader",t,{emitComments:!1});await u.loadAsync(Wr.DEFAULT_HAND_MODEL_SHADER_URL),u.needDepthPrePass=!0,u.transparencyMode=Vs.MATERIAL_ALPHABLEND,u.alphaMode=2,u.build(!1);const f={base:_.FromInts(116,63,203),fresnel:_.FromInts(149,102,229),fingerColor:_.FromInts(177,130,255),tipFresnel:_.FromInts(220,200,255),...null===(o=null==i?void 0:i.handMeshes)||void 0===o?void 0:o.customColors},d={base:u.getBlockByName("baseColor"),fresnel:u.getBlockByName("fresnelColor"),fingerColor:u.getBlockByName("fingerColor"),tipFresnel:u.getBlockByName("tipFresnelColor")};d.base.value=f.base,d.fresnel.value=f.fresnel,d.fingerColor.value=f.fingerColor,d.tipFresnel.value=f.tipFresnel,["left","right"].forEach((i=>{const e="left"==i?Wr.KF:Wr.jF;if(!e)throw new Error("Could not load hand model");const s=e.meshes[1];s._m.ST=!0,s.material=u.clone(`${i}HandShaderClone`,!0),s.isVisible=!1,a[i]=s,l||t.useRightHandedSystem||e.meshes[1].rotate(Ge.Y,Math.PI)})),u.dispose(),e({left:a.left,right:a.right})}))}static qF(t){const i="right"==t?"R":"L";return{[Gr.WRIST]:`wrist_${i}`,[Gr.THUMB_METACARPAL]:`thumb_metacarpal_${i}`,[Gr.THUMB_PHALANX_PROXIMAL]:`thumb_proxPhalanx_${i}`,[Gr.THUMB_PHALANX_DISTAL]:`thumb_distPhalanx_${i}`,[Gr.THUMB_TIP]:`thumb_tip_${i}`,[Gr.INDEX_FINGER_METACARPAL]:`index_metacarpal_${i}`,[Gr.INDEX_FINGER_PHALANX_PROXIMAL]:`index_proxPhalanx_${i}`,[Gr.INDEX_FINGER_PHALANX_INTERMEDIATE]:`index_intPhalanx_${i}`,[Gr.INDEX_FINGER_PHALANX_DISTAL]:`index_distPhalanx_${i}`,[Gr.INDEX_FINGER_TIP]:`index_tip_${i}`,[Gr.MIDDLE_FINGER_METACARPAL]:`middle_metacarpal_${i}`,[Gr.MIDDLE_FINGER_PHALANX_PROXIMAL]:`middle_proxPhalanx_${i}`,[Gr.MIDDLE_FINGER_PHALANX_INTERMEDIATE]:`middle_intPhalanx_${i}`,[Gr.MIDDLE_FINGER_PHALANX_DISTAL]:`middle_distPhalanx_${i}`,[Gr.MIDDLE_FINGER_TIP]:`middle_tip_${i}`,[Gr.RING_FINGER_METACARPAL]:`ring_metacarpal_${i}`,[Gr.RING_FINGER_PHALANX_PROXIMAL]:`ring_proxPhalanx_${i}`,[Gr.RING_FINGER_PHALANX_INTERMEDIATE]:`ring_intPhalanx_${i}`,[Gr.RING_FINGER_PHALANX_DISTAL]:`ring_distPhalanx_${i}`,[Gr.RING_FINGER_TIP]:`ring_tip_${i}`,[Gr.PINKY_FINGER_METACARPAL]:`little_metacarpal_${i}`,[Gr.PINKY_FINGER_PHALANX_PROXIMAL]:`little_proxPhalanx_${i}`,[Gr.PINKY_FINGER_PHALANX_INTERMEDIATE]:`little_intPhalanx_${i}`,[Gr.PINKY_FINGER_PHALANX_DISTAL]:`little_distPhalanx_${i}`,[Gr.PINKY_FINGER_TIP]:`little_tip_${i}`}}isCompatible(){return"undefined"!=typeof XRHand}getHandByControllerId(t){return this.VF[t]}getHandByHandedness(t){return"none"==t?null:this.kF[t]}attach(){var t,i,e,s;return!!super.attach()&&(this.GF={jointMeshes:Wr.WF(this.options),handMeshes:(null===(t=this.options.handMeshes)||void 0===t?void 0:t.customMeshes)||null,rigMappings:(null===(i=this.options.handMeshes)||void 0===i?void 0:i.customRigMappings)||null},(null===(e=this.options.handMeshes)||void 0===e?void 0:e.customMeshes)||(null===(s=this.options.handMeshes)||void 0===s?void 0:s.disableDefaultMeshes)||Wr.YF(E.LastCreatedScene,this.options).then((t=>{var i,e;this.GF.handMeshes=t,this.GF.rigMappings={left:Wr.qF("left"),right:Wr.qF("right")},null===(i=this.kF.left)||void 0===i||i.setHandMesh(this.GF.handMeshes.left,this.GF.rigMappings.left),null===(e=this.kF.right)||void 0===e||e.setHandMesh(this.GF.handMeshes.right,this.GF.rigMappings.right)})),this.options.xrInput.controllers.forEach(this.zF),this.NN(this.options.xrInput.onControllerAddedObservable,this.zF),this.NN(this.options.xrInput.onControllerRemovedObservable,this.HF),!0)}PN(t){var i,e;null===(i=this.kF.left)||void 0===i||i.updateFromXRFrame(t,this.RN.referenceSpace),null===(e=this.kF.right)||void 0===e||e.updateFromXRFrame(t,this.RN.referenceSpace)}XF(t){var i;const e=this.getHandByControllerId(t);if(e){const s="left"==e.xrController.inputSource.handedness?"left":"right";(null===(i=this.kF[s])||void 0===i?void 0:i.xrController.uniqueId)===t&&(this.kF[s]=null),this.onHandRemovedObservable.notifyObservers(e),e.dispose(),delete this.VF[t]}}detach(){return!!super.detach()&&(Object.keys(this.VF).forEach((t=>this.XF(t))),!0)}dispose(){var t;super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this.GF.handMeshes&&!(null===(t=this.options.handMeshes)||void 0===t?void 0:t.customMeshes)&&(this.GF.handMeshes.left.dispose(),this.GF.handMeshes.right.dispose(),Wr.jF=null,Wr.KF=null),this.GF.jointMeshes&&(this.GF.jointMeshes.left.forEach((t=>t.dispose())),this.GF.jointMeshes.right.forEach((t=>t.dispose())))}}var $r,Yr,jr;Wr.Name=Cn.HAND_TRACKING,Wr.Version=1,Wr.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/meshes/HandMeshes/",Wr.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb",Wr.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb",Wr.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json",Wr.$F={radius:.5,flat:!1,subdivisions:2},Wr.jF=null,Wr.KF=null,wn.AddWebXRFeature(Wr.Name,((t,i)=>()=>new Wr(t,i)),Wr.Version,!1),function(t){t[t.ABOVE_FINGER_TIPS=0]="ABOVE_FINGER_TIPS",t[t.RADIAL_SIDE=1]="RADIAL_SIDE",t[t.ULNAR_SIDE=2]="ULNAR_SIDE",t[t.BELOW_WRIST=3]="BELOW_WRIST"}($r||($r={})),function(t){t[t.LOOK_AT_CAMERA=0]="LOOK_AT_CAMERA",t[t.HAND_ROTATION=1]="HAND_ROTATION"}(Yr||(Yr={})),function(t){t[t.ALWAYS_VISIBLE=0]="ALWAYS_VISIBLE",t[t.PALM_UP=1]="PALM_UP",t[t.GAZE_FOCUS=2]="GAZE_FOCUS",t[t.PALM_AND_GAZE=3]="PALM_AND_GAZE"}(jr||(jr={}));class Kr{constructor(t,i,e){this.targetPosition=w.Zero(),this.poleTargetPosition=w.Zero(),this.poleTargetLocalOffset=w.Zero(),this.poleAngle=0,this.slerpAmount=1,this.QF=T.Identity(),this.ZF=R.Identity(),this.JF=Math.PI,this.tB=Math.PI,this.iB=!1,this.eB=w.Right(),this.sB=!1,this.nB=0,this.rB=!1,this.hB=i;const s=i.getParent();if(!s)return this.rB=!0,void F.Error("BoneIKController: bone must have a parent for IK to work.");if(this.oB=s,0===this.hB.children.length&&!this.hB.length)return this.rB=!0,void F.Error("BoneIKController: bone must not be a leaf or it should have a length for IK to work.");this.mesh=t;const n=i.getPosition();if(i.getAbsoluteTransform().determinant()>0&&(this.iB=!0,this.eB.x=0,this.eB.y=0,this.eB.z=-1,n.x>n.y&&n.x>n.z&&(this.nB=.5*Math.PI,this.eB.z=1)),this.oB.length&&this.hB.length){const t=this.oB.getScale(),i=this.hB.getScale();this.aB=this.oB.length*t.y*this.mesh.scaling.y,this.lB=this.hB.length*i.y*this.mesh.scaling.y}else if(this.hB.children[0]){t.computeWorldMatrix(!0);const i=this.hB.children[0].getAbsolutePosition(t),e=this.hB.getAbsolutePosition(t),s=this.oB.getAbsolutePosition(t);this.lB=w.Distance(i,e),this.aB=w.Distance(e,s)}else{t.computeWorldMatrix(!0);const i=this.hB.getScale();this.lB=this.hB.length*i.y*this.mesh.scaling.y;const e=this.hB.getAbsolutePosition(t),s=this.oB.getAbsolutePosition(t);this.aB=w.Distance(e,s)}this.oB.getRotationMatrixToRef(Be.WORLD,t,this.ZF),this.maxAngle=Math.PI,e&&(e.targetMesh&&(this.targetMesh=e.targetMesh,this.targetMesh.computeWorldMatrix(!0)),e.poleTargetMesh?(this.poleTargetMesh=e.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):e.poleTargetBone?this.poleTargetBone=e.poleTargetBone:this.oB.getParent()&&(this.poleTargetBone=this.oB.getParent()),e.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(e.poleTargetLocalOffset),e.poleAngle&&(this.poleAngle=e.poleAngle),e.bendAxis&&this.eB.copyFrom(e.bendAxis),e.maxAngle&&(this.maxAngle=e.maxAngle),e.slerpAmount&&(this.slerpAmount=e.slerpAmount))}get maxAngle(){return this.tB}set maxAngle(t){this.cB(t)}cB(t){t<0&&(t=0),(t>Math.PI||null==t)&&(t=Math.PI),this.tB=t;const i=this.aB,e=this.lB;this.uB=Math.sqrt(i*i+e*e-2*i*e*Math.cos(t))}update(){if(this.rB)return;const t=this.targetPosition,i=this.poleTargetPosition,e=Kr.cE[0],s=Kr.cE[1];this.targetMesh&&t.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,i):this.poleTargetMesh&&w.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),i);const n=Kr.uE[0],r=Kr.uE[1],h=Kr.uE[2],o=Kr.uE[3],a=Kr.uE[4],l=Kr.fE;this.oB.getAbsolutePositionToRef(this.mesh,n),i.subtractToRef(n,a),0==a.x&&0==a.y&&0==a.z?a.y=1:a.normalize(),t.subtractToRef(n,o),o.normalize(),w.CrossToRef(o,a,r),r.normalize(),w.CrossToRef(o,r,h),h.normalize(),R.FromXYZAxesToRef(h,o,r,e);const c=this.aB,u=this.lB;let f=w.Distance(n,t);this.uB>0&&(f=Math.min(this.uB,f));let d=(u*u+f*f-c*c)/(2*u*f),p=(f*f+c*c-u*u)/(2*f*c);d>1&&(d=1),p>1&&(p=1),d<-1&&(d=-1),p<-1&&(p=-1);const m=Math.acos(d),v=Math.acos(p);let g=-m-v;if(this.iB)R.RotationYawPitchRollToRef(0,0,this.nB,s),s.multiplyToRef(e,e),R.RotationAxisToRef(this.eB,v,s),s.multiplyToRef(e,e);else{const t=Kr.uE[5];t.copyFrom(this.eB),t.x*=-1,R.RotationAxisToRef(t,-v,s),s.multiplyToRef(e,e)}this.poleAngle&&(R.RotationAxisToRef(o,this.poleAngle,s),e.multiplyToRef(s,e)),this.oB&&(this.slerpAmount<1?(this.sB||T.FromRotationMatrixToRef(this.ZF,this.QF),T.FromRotationMatrixToRef(e,l),T.SlerpToRef(this.QF,l,this.slerpAmount,this.QF),g=this.JF*(1-this.slerpAmount)+g*this.slerpAmount,this.oB.setRotationQuaternion(this.QF,Be.WORLD,this.mesh),this.sB=!0):(this.oB.setRotationMatrix(e,Be.WORLD,this.mesh),this.ZF.copyFrom(e),this.sB=!1),this.fB(this.oB)),this.hB.setAxisAngle(this.eB,g,Be.LOCAL),this.fB(this.hB),this.JF=g}fB(t){t.YS&&(t.YS.rotationQuaternion||(t.YS.rotationQuaternion=new T),t.getRotationQuaternionToRef(Be.LOCAL,null,t.YS.rotationQuaternion))}}Kr.uE=[w.Zero(),w.Zero(),w.Zero(),w.Zero(),w.Zero(),w.Zero()],Kr.fE=T.Identity(),Kr.cE=[R.Identity(),R.Identity()];class qr{constructor(t,i,e,s){if(this.upAxis=w.Up(),this.upAxisSpace=Be.LOCAL,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this.dB=T.Identity(),this.sB=!1,this.pB=!1,this.mB=w.Forward(),this.mesh=t,this.bone=i,this.target=e,s&&(s.adjustYaw&&(this.adjustYaw=s.adjustYaw),s.adjustPitch&&(this.adjustPitch=s.adjustPitch),s.adjustRoll&&(this.adjustRoll=s.adjustRoll),null!=s.maxYaw?this.maxYaw=s.maxYaw:this.maxYaw=Math.PI,null!=s.minYaw?this.minYaw=s.minYaw:this.minYaw=-Math.PI,null!=s.maxPitch?this.maxPitch=s.maxPitch:this.maxPitch=Math.PI,null!=s.minPitch?this.minPitch=s.minPitch:this.minPitch=-Math.PI,null!=s.slerpAmount&&(this.slerpAmount=s.slerpAmount),null!=s.upAxis&&(this.upAxis=s.upAxis),null!=s.upAxisSpace&&(this.upAxisSpace=s.upAxisSpace),null!=s.yawAxis||null!=s.pitchAxis)){let t=Ge.Y,i=Ge.X;null!=s.yawAxis&&(t=s.yawAxis.clone(),t.normalize()),null!=s.pitchAxis&&(i=s.pitchAxis.clone(),i.normalize());const e=w.Cross(i,t);this.vB=R.Identity(),R.FromXYZAxesToRef(i,t,e,this.vB),this.gB=this.vB.clone(),this.vB.invert()}i.getParent()||this.upAxisSpace!=Be.BONE||(this.upAxisSpace=Be.LOCAL)}get minYaw(){return this.SB}set minYaw(t){this.SB=t,this.EB=Math.sin(t),this.AB=Math.cos(t),null!=this.CB&&(this.wB=.5*this.xB(this.SB,this.CB)+this.SB,this.TB=this.CB-this.SB)}get maxYaw(){return this.CB}set maxYaw(t){this.CB=t,this.IB=Math.sin(t),this.MB=Math.cos(t),null!=this.SB&&(this.wB=.5*this.xB(this.SB,this.CB)+this.SB,this.TB=this.CB-this.SB)}get minPitch(){return this.bB}set minPitch(t){this.bB=t,this._B=Math.tan(t)}get maxPitch(){return this.yB}set maxPitch(t){this.yB=t,this.NB=Math.tan(t)}update(){if(this.slerpAmount<1&&!this.pB)return void(this.pB=!0);const t=this.bone,i=qr.uE[0];t.getAbsolutePositionToRef(this.mesh,i);let e=this.target;const s=qr.cE[0],n=qr.cE[1],r=this.mesh,h=t.getParent(),o=qr.uE[1];o.copyFrom(this.upAxis),this.upAxisSpace==Be.BONE&&h?(this.vB&&w.TransformCoordinatesToRef(o,this.gB,o),h.getDirectionToRef(o,this.mesh,o)):this.upAxisSpace==Be.LOCAL&&(r.getDirectionToRef(o,o),1==r.scaling.x&&1==r.scaling.y&&1==r.scaling.z||o.normalize());let a=!1,l=!1;if(this.CB==Math.PI&&this.SB==-Math.PI||(a=!0),this.yB==Math.PI&&this.bB==-Math.PI||(l=!0),a||l){const t=qr.cE[2],s=qr.cE[3];if(this.upAxisSpace==Be.BONE&&1==o.y&&h)h.getRotationMatrixToRef(Be.WORLD,this.mesh,t);else if(this.upAxisSpace!=Be.LOCAL||1!=o.y||h){let i=qr.uE[2];i.copyFrom(this.mB),this.vB&&w.TransformCoordinatesToRef(i,this.gB,i),h?h.getDirectionToRef(i,this.mesh,i):r.getDirectionToRef(i,i);const e=w.Cross(o,i);e.normalize(),i=w.Cross(e,o),R.FromXYZAxesToRef(e,o,i,t)}else t.copyFrom(r.getWorldMatrix());t.invertToRef(s);let n=null;if(l){const r=qr.uE[3];e.subtractToRef(i,r),w.TransformCoordinatesToRef(r,s,r),n=Math.sqrt(r.x*r.x+r.z*r.z);const h=Math.atan2(r.y,n);let o=h;h>this.yB?(r.y=this.NB*n,o=this.yB):h<this.bB&&(r.y=this._B*n,o=this.bB),h!=o&&(w.TransformCoordinatesToRef(r,t,r),r.addInPlace(i),e=r)}if(a){const r=qr.uE[4];e.subtractToRef(i,r),w.TransformCoordinatesToRef(r,s,r);const h=Math.atan2(r.x,r.z);let o=h;if((h>this.CB||h<this.SB)&&(null==n&&(n=Math.sqrt(r.x*r.x+r.z*r.z)),this.TB>Math.PI?this.PB(h,this.CB,this.wB)?(r.z=this.MB*n,r.x=this.IB*n,o=this.CB):this.PB(h,this.wB,this.SB)&&(r.z=this.AB*n,r.x=this.EB*n,o=this.SB):h>this.CB?(r.z=this.MB*n,r.x=this.IB*n,o=this.CB):h<this.SB&&(r.z=this.AB*n,r.x=this.EB*n,o=this.SB)),this.sB&&this.TB>Math.PI){const t=qr.uE[8];t.copyFrom(Ge.Z),this.vB&&w.TransformCoordinatesToRef(t,this.gB,t);const i=qr.cE[4];this.dB.toRotationMatrix(i),this.mesh.getWorldMatrix().multiplyToRef(i,i),w.TransformCoordinatesToRef(t,i,t),w.TransformCoordinatesToRef(t,s,t);const e=Math.atan2(t.x,t.z);if(this.DB(e,h)>this.DB(e,this.wB)){null==n&&(n=Math.sqrt(r.x*r.x+r.z*r.z));const t=this.DB(e,this.CB);this.DB(e,this.SB)<t?(o=e+.75*Math.PI,r.z=Math.cos(o)*n,r.x=Math.sin(o)*n):(o=e-.75*Math.PI,r.z=Math.cos(o)*n,r.x=Math.sin(o)*n)}}h!=o&&(w.TransformCoordinatesToRef(r,t,r),r.addInPlace(i),e=r)}}const c=qr.uE[5],u=qr.uE[6],f=qr.uE[7],d=qr.fE;e.subtractToRef(i,c),c.normalize(),w.CrossToRef(o,c,u),u.normalize(),w.CrossToRef(c,u,f),f.normalize(),R.FromXYZAxesToRef(u,f,c,s),0===u.x&&0===u.y&&0===u.z||0===f.x&&0===f.y&&0===f.z||0===c.x&&0===c.y&&0===c.z||((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(R.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,n),n.multiplyToRef(s,s)),this.slerpAmount<1?(this.sB||this.bone.getRotationQuaternionToRef(Be.WORLD,this.mesh,this.dB),this.vB&&this.vB.multiplyToRef(s,s),T.FromRotationMatrixToRef(s,d),T.SlerpToRef(this.dB,d,this.slerpAmount,this.dB),this.bone.setRotationQuaternion(this.dB,Be.WORLD,this.mesh),this.sB=!0):(this.vB&&this.vB.multiplyToRef(s,s),this.bone.setRotationMatrix(s,Be.WORLD,this.mesh),this.sB=!1),this.fB())}xB(t,i){let e=i-t;return e%=2*Math.PI,e>Math.PI?e-=2*Math.PI:e<-Math.PI&&(e+=2*Math.PI),e}DB(t,i){let e=0;return e=(t=(t%=2*Math.PI)<0?t+2*Math.PI:t)<(i=(i%=2*Math.PI)<0?i+2*Math.PI:i)?i-t:t-i,e>Math.PI&&(e=2*Math.PI-e),e}PB(t,i,e){if(t=(t%=2*Math.PI)<0?t+2*Math.PI:t,(i=(i%=2*Math.PI)<0?i+2*Math.PI:i)<(e=(e%=2*Math.PI)<0?e+2*Math.PI:e)){if(t>i&&t<e)return!0}else if(t>e&&t<i)return!0;return!1}fB(){const t=this.bone;t.YS&&(t.YS.rotationQuaternion||(t.YS.rotationQuaternion=new T),t.getRotationQuaternionToRef(Be.LOCAL,null,t.YS.rotationQuaternion))}}qr.uE=f.BuildArray(10,w.Zero),qr.fE=T.Identity(),qr.cE=f.BuildArray(5,R.Identity);class Qr{constructor(t,i,e){this.name=t,this.id=i,this.bones=new Array,this.needInitialSkinMatrix=!1,this.F=!0,this.OB=new Array,this.FB=R.Identity(),this.Ei={},this.BB=!0,this.UB=!1,this.Tr=0,this.sE=0,this.VB=null,this.Si=null,this.doNotSerialize=!1,this.kB=!0,this.Pi=null,this.onBeforeComputeObservable=new h,this.bones=[],this.Kt=e||E.LastCreatedScene,this.Tr=this.Kt.getUniqueId(),this.Kt.addSkeleton(this),this.F=!0;const s=this.Kt.getEngine().getCaps();this.UB=s.textureFloat&&s.maxVertexTextureImageUnits>0}get useTextureToStoreBoneMatrices(){return this.kB}set useTextureToStoreBoneMatrices(t){this.kB=t,this.lE()}get animationPropertiesOverride(){return this.Pi?this.Pi:this.Kt.animationPropertiesOverride}set animationPropertiesOverride(t){this.Pi=t}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this.UB}get uniqueId(){return this.Tr}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter((t=>!t.getParent()))}getTransformMatrices(t){return this.needInitialSkinMatrix?(t.FT||this.prepare(),t.FT):(this.GB||this.prepare(),this.GB)}getTransformMatrixTexture(t){return this.needInitialSkinMatrix&&t.BT?t.BT:this.BT}getScene(){return this.Kt}toString(t){let i=`Name: ${this.name}, nBones: ${this.bones.length}`;if(i+=`, nAnimationRanges: ${this.Ei?Object.keys(this.Ei).length:"none"}`,t){i+=", Ranges: {";let t=!0;for(const e in this.Ei)t&&(i+=", ",t=!1),i+=e;i+="}"}return i}getBoneIndexByName(t){for(let i=0,e=this.bones.length;i<e;i++)if(this.bones[i].name===t)return i;return-1}createAnimationRange(t,i,e){if(!this.Ei[t]){this.Ei[t]=new ct(t,i,e);for(let s=0,n=this.bones.length;s<n;s++)this.bones[s].animations[0]&&this.bones[s].animations[0].createRange(t,i,e)}}deleteAnimationRange(t,i=!0){for(let e=0,s=this.bones.length;e<s;e++)this.bones[e].animations[0]&&this.bones[e].animations[0].deleteRange(t,i);this.Ei[t]=null}getAnimationRange(t){return this.Ei[t]||null}getAnimationRanges(){const t=[];let i;for(i in this.Ei)t.push(this.Ei[i]);return t}copyAnimationRange(t,i,e=!1){if(this.Ei[i]||!t.getAnimationRange(i))return!1;let s=!0;const n=this.zB()+1,r={},h=t.bones;let o,a;for(a=0,o=h.length;a<o;a++)r[h[a].name]=h[a];this.bones.length!==h.length&&(F.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${h.length}`),s=!1);const l=e&&this.dimensionsAtRest&&t.dimensionsAtRest?this.dimensionsAtRest.divide(t.dimensionsAtRest):null;for(a=0,o=this.bones.length;a<o;a++){const t=this.bones[a].name,h=r[t];h?s=s&&this.bones[a].copyAnimationRange(h,i,n,e,l):(F.Warn("copyAnimationRange: not same rig, missing source bone "+t),s=!1)}const c=t.getAnimationRange(i);return c&&(this.Ei[i]=new ct(i,c.from+n,c.to+n)),s}returnToRest(){for(const t of this.bones)-1!==t.kS&&t.returnToRest()}zB(){let t=0;for(let i=0,e=this.bones.length;i<e;i++)if(this.bones[i].animations[0]){const e=this.bones[i].animations[0].getHighestFrame();t<e&&(t=e)}return t}beginAnimation(t,i,e,s){const n=this.getAnimationRange(t);return n?this.Kt.beginAnimation(this,n.from,n.to,i,e,s):null}static MakeAnimationAdditive(t,i=0,e){const s=t.getAnimationRange(e);if(!s)return null;const n=t.Kt.getAllAnimatablesByTarget(t);let r=null;for(let t=0;t<n.length;t++){const i=n[t];if(i.fromFrame===(null==s?void 0:s.from)&&i.toFrame===(null==s?void 0:s.to)){r=i;break}}const h=t.getAnimatables();for(let t=0;t<h.length;t++){const s=h[t].animations;if(s)for(let t=0;t<s.length;t++)vt.MakeAnimationAdditive(s[t],i,e)}return r&&(r.isAdditive=!0),t}lE(){this.F=!0,this.BB=!0}jT(t){this.OB.push(t)}YT(t){const i=this.OB.indexOf(t);i>-1&&this.OB.splice(i,1)}HB(t,i){this.onBeforeComputeObservable.notifyObservers(this);for(let e=0;e<this.bones.length;e++){const s=this.bones[e];s.wi++;const n=s.getParent();if(n?s.getLocalMatrix().multiplyToRef(n.getWorldMatrix(),s.getWorldMatrix()):i?s.getLocalMatrix().multiplyToRef(i,s.getWorldMatrix()):s.getWorldMatrix().copyFrom(s.getLocalMatrix()),-1!==s.kS){const i=null===s.kS?e:s.kS;s.getInvertedAbsoluteTransform().multiplyToArray(s.getWorldMatrix(),t,16*i)}}this.FB.copyToArray(t,16*this.bones.length)}prepare(){if(this.sE>0)for(const t of this.bones)if(t.YS){const i=t.YS;t.position=i.position,i.rotationQuaternion?t.rotationQuaternion=i.rotationQuaternion:t.rotation=i.rotation,t.scaling=i.scaling}if(this.needInitialSkinMatrix)for(const t of this.OB){const i=t.getPoseMatrix();let e=this.F;if(t.FT&&t.FT.length===16*(this.bones.length+1)||(t.FT=new Float32Array(16*(this.bones.length+1)),e=!0),e){if(this.XB!==t){this.XB=t;for(const t of this.bones)if(!t.getParent()){t.getBaseMatrix().multiplyToRef(i,M.Matrix[1]),t.JS(M.Matrix[1])}if(this.isUsingTextureForMatrices){const i=4*(this.bones.length+1);t.BT&&t.BT.getSize().width===i||(t.BT&&t.BT.dispose(),t.BT=fn.CreateRGBATexture(t.FT,4*(this.bones.length+1),1,this.Kt,!1,!1,1,1))}}this.HB(t.FT,i),this.isUsingTextureForMatrices&&t.BT&&t.BT.update(t.FT)}}else{if(!this.F)return;this.GB&&this.GB.length===16*(this.bones.length+1)||(this.GB=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this.BT&&this.BT.dispose(),this.BT=fn.CreateRGBATexture(this.GB,4*(this.bones.length+1),1,this.Kt,!1,!1,1,1))),this.HB(this.GB,null),this.isUsingTextureForMatrices&&this.BT&&this.BT.update(this.GB)}this.F=!1}getAnimatables(){if(!this.jE||this.jE.length!==this.bones.length){this.jE=[];for(let t=0;t<this.bones.length;t++)this.jE.push(this.bones[t])}return this.jE}clone(t,i){const e=new Qr(t,i||t,this.Kt);e.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let t=0;t<this.bones.length;t++){const i=this.bones[t];let s=null;const n=i.getParent();if(n){const t=this.bones.indexOf(n);s=e.bones[t]}const r=new ze(i.name,e,s,i.getBaseMatrix().clone(),i.getRestPose().clone());r.kS=i.kS,i.YS&&r.linkTransformNode(i.YS),k.DeepCopy(i.animations,r.animations)}if(this.Ei){e.Ei={};for(const t in this.Ei){const i=this.Ei[t];i&&(e.Ei[t]=i.clone())}}return this.F=!0,e}enableBlending(t=.01){this.bones.forEach((i=>{i.animations.forEach((i=>{i.enableBlending=!0,i.blendingSpeed=t}))}))}dispose(){if(this.OB.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this.Si){const t=this.Si.skeletons.indexOf(this);t>-1&&this.Si.skeletons.splice(t,1),this.Si=null}this.BT&&(this.BT.dispose(),this.BT=null)}serialize(){var t;const i={};i.name=this.name,i.id=this.id,this.dimensionsAtRest&&(i.dimensionsAtRest=this.dimensionsAtRest.asArray()),i.bones=[],i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let e=0;e<this.bones.length;e++){const s=this.bones[e],n=s.getParent(),r={parentBoneIndex:n?this.bones.indexOf(n):-1,index:s.getIndex(),name:s.name,id:s.id,matrix:s.getBaseMatrix().toArray(),rest:s.getRestPose().toArray(),linkedTransformNodeId:null===(t=s.getTransformNode())||void 0===t?void 0:t.id};i.bones.push(r),s.length&&(r.length=s.length),s.metadata&&(r.metadata=s.metadata),s.animations&&s.animations.length>0&&(r.animation=s.animations[0].serialize()),i.ranges=[];for(const t in this.Ei){const e=this.Ei[t];if(!e)continue;const s={};s.name=t,s.from=e.from,s.to=e.to,i.ranges.push(s)}}return i}static Parse(t,i){const e=new Qr(t.name,t.id,i);let s;for(t.dimensionsAtRest&&(e.dimensionsAtRest=w.FromArray(t.dimensionsAtRest)),e.needInitialSkinMatrix=t.needInitialSkinMatrix,s=0;s<t.bones.length;s++){const i=t.bones[s],n=t.bones[s].index;let r=null;i.parentBoneIndex>-1&&(r=e.bones[i.parentBoneIndex]);const h=i.rest?R.FromArray(i.rest):null,o=new ze(i.name,e,r,R.FromArray(i.matrix),h,null,n);void 0!==i.id&&null!==i.id&&(o.id=i.id),i.length&&(o.length=i.length),i.metadata&&(o.metadata=i.metadata),i.animation&&o.animations.push(vt.Parse(i.animation)),void 0!==i.linkedTransformNodeId&&null!==i.linkedTransformNodeId&&(e.VB=!0,o.jS=i.linkedTransformNodeId)}if(t.ranges)for(s=0;s<t.ranges.length;s++){const i=t.ranges[s];e.createAnimationRange(i.name,i.from,i.to)}return e}computeAbsoluteTransforms(t=!1){(this.BB||t)&&(this.bones[0].computeAbsoluteTransforms(),this.BB=!1)}getPoseMatrix(){let t=null;return this.OB.length>0&&(t=this.OB[0].getPoseMatrix()),t}sortBones(){const t=new Array,i=new Array(this.bones.length);for(let e=0;e<this.bones.length;e++)this.WB(e,t,i);this.bones=t}WB(t,i,e){if(e[t])return;e[t]=!0;const s=this.bones[t];if(!s)return;void 0===s.kS&&(s.kS=t);const n=s.getParent();n&&this.WB(this.bones.indexOf(n),i,e),i.push(s)}setCurrentPoseAsRest(){this.bones.forEach((t=>{t.setCurrentPoseAsRest()}))}}class Zr{constructor(t,i,e=3){this.Ls=t,this.Ls.rh.push(this),this.$B(i,e)}$B(t,i){this.YB=t,this.N_=i,this.Yn=this.Ls.createStorageBuffer(t,i)}br(){this.$B(this.YB,this.N_)}getBuffer(){return this.Yn}update(t,i,e){this.Yn&&this.Ls.updateStorageBuffer(this.Yn,t,i,e)}read(t,i,e){return this.Ls.readFromStorageBuffer(this.Yn,t,i,e)}dispose(){const t=this.Ls.rh,i=t.indexOf(this);-1!==i&&(t[i]=t[t.length-1],t.pop()),this.Ls.ca(this.Yn),this.Yn=null}}class Jr{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new h,this.jB=0,this.KB=0,this.qB=0,this.QB=12,this.ZB=120}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments),this.JB=i=>{if(i.type!==pe.POINTERWHEEL)return;const e=i.event,s=e.deltaMode===Ce.DOM_DELTA_LINE?this.QB:1;this.jB+=this.wheelPrecisionX*s*e.deltaX/this.ZB,this.KB-=this.wheelPrecisionY*s*e.deltaY/this.ZB,this.qB+=this.wheelPrecisionZ*s*e.deltaZ/this.ZB,e.preventDefault&&(t||e.preventDefault())},this.tU=this.camera.getScene().ud.sm(this.JB,pe.POINTERWHEEL)}detachControl(){this.tU&&(this.camera.getScene().ud.nm(this.tU),this.tU=null,this.JB=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this.jB,wheelDeltaY:this.KB,wheelDeltaZ:this.qB}),this.jB=0,this.KB=0,this.qB=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}ut([Q()],Jr.prototype,"wheelPrecisionX",void 0),ut([Q()],Jr.prototype,"wheelPrecisionY",void 0),ut([Q()],Jr.prototype,"wheelPrecisionZ",void 0);class th{constructor(){this.iU=-1,this.buttons=[0,1,2]}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments);const i=this.camera.getEngine(),e=i.getInputElement();let s=0,n=null;this.lN=null,this.eU=null,this.sU=!1,this.nU=!1,this.rU=!1,this.hU=!1,this.oU=0,this.aU=r=>{var h,o;const a=r.event,l="touch"===a.pointerType;if(i.isInVRExclusivePointerMode)return;if(r.type!==pe.POINTERMOVE&&-1===this.buttons.indexOf(a.button))return;const c=a.target;if(this.sU=a.altKey,this.nU=a.ctrlKey,this.rU=a.metaKey,this.hU=a.shiftKey,this.oU=a.buttons,i.isPointerLock){const t=a.movementX,i=a.movementY;this.onTouch(null,t,i),this.lN=null,this.eU=null}else{if(r.type!==pe.POINTERDOWN&&l&&(null===(h=this.lN)||void 0===h?void 0:h.pointerId)!==a.pointerId&&(null===(o=this.eU)||void 0===o?void 0:o.pointerId)!==a.pointerId)return;if(r.type!==pe.POINTERDOWN||-1!==this.iU&&!l)if(r.type===pe.POINTERDOUBLETAP)this.onDoubleTap(a.pointerType);else if(r.type!==pe.POINTERUP||this.iU!==a.button&&!l){if(r.type===pe.POINTERMOVE)if(t||a.preventDefault(),this.lN&&null===this.eU){const t=a.clientX-this.lN.x,i=a.clientY-this.lN.y;this.onTouch(this.lN,t,i),this.lN.x=a.clientX,this.lN.y=a.clientY}else if(this.lN&&this.eU){const t=this.lN.pointerId===a.pointerId?this.lN:this.eU;t.x=a.clientX,t.y=a.clientY;const i=this.lN.x-this.eU.x,e=this.lN.y-this.eU.y,h=i*i+e*e,o={x:(this.lN.x+this.eU.x)/2,y:(this.lN.y+this.eU.y)/2,pointerId:a.pointerId,type:r.type};this.onMultiTouch(this.lN,this.eU,s,h,n,o),n=o,s=h}}else{try{null==c||c.releasePointerCapture(a.pointerId)}catch(t){}l||(this.eU=null),i.lh?this.lN=this.eU=null:this.eU&&this.lN&&this.lN.pointerId==a.pointerId?(this.lN=this.eU,this.eU=null):this.lN&&this.eU&&this.eU.pointerId==a.pointerId?this.eU=null:this.lN=this.eU=null,(0!==s||n)&&(this.onMultiTouch(this.lN,this.eU,s,0,n,null),s=0,n=null),this.iU=-1,this.onButtonUp(a),t||a.preventDefault()}else{try{null==c||c.setPointerCapture(a.pointerId)}catch(t){}if(null===this.lN)this.lN={x:a.clientX,y:a.clientY,pointerId:a.pointerId,type:a.pointerType};else{if(null!==this.eU)return;this.eU={x:a.clientX,y:a.clientY,pointerId:a.pointerId,type:a.pointerType}}-1!==this.iU||l||(this.iU=a.button),this.onButtonDown(a),t||(a.preventDefault(),e&&e.focus())}}},this.tU=this.camera.getScene().ud.sm(this.aU,pe.POINTERDOWN|pe.POINTERUP|pe.POINTERMOVE|pe.POINTERDOUBLETAP),this.lU=()=>{this.lN=this.eU=null,s=0,n=null,this.onLostFocus()},this.cU=this.onContextMenu.bind(this),e&&e.addEventListener("contextmenu",this.cU,!1);const r=this.camera.getScene().getEngine().getHostWindow();r&&ki.RegisterTopRootEvents(r,[{name:"blur",handler:this.lU}])}detachControl(){if(this.lU){const t=this.camera.getScene().getEngine().getHostWindow();t&&ki.UnregisterTopRootEvents(t,[{name:"blur",handler:this.lU}])}if(this.tU){if(this.camera.getScene().ud.nm(this.tU),this.tU=null,this.cU){const t=this.camera.getScene().getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this.cU)}this.lU=null}this.sU=!1,this.nU=!1,this.rU=!1,this.hU=!1,this.oU=0,this.iU=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(t){}onTouch(t,i,e){}onMultiTouch(t,i,e,s,n,r){}onContextMenu(t){t.preventDefault()}onButtonDown(t){}onButtonUp(t){}onLostFocus(){}}ut([Q()],th.prototype,"buttons",void 0);var ih={};class eh{constructor(t){this.attachedToElement=!1,this.attached={},this.camera=t,this.checkInputs=()=>{}}add(t){const i=t.getSimpleName();this.attached[i]?F.Warn("camera input of type "+i+" already exists on camera"):(this.attached[i]=t,t.camera=this.camera,t.checkInputs&&(this.checkInputs=this.uU(t.checkInputs.bind(t))),this.attachedToElement&&t.attachControl(this.noPreventDefault))}remove(t){for(const i in this.attached){const e=this.attached[i];if(e===t)return e.detachControl(),e.camera=null,delete this.attached[i],void this.rebuildInputCheck()}}removeByType(t){for(const i in this.attached){const e=this.attached[i];e.getClassName()===t&&(e.detachControl(),e.camera=null,delete this.attached[i],this.rebuildInputCheck())}}uU(t){const i=this.checkInputs;return()=>{i(),t()}}attachInput(t){this.attachedToElement&&t.attachControl(this.noPreventDefault)}attachElement(t=!1){if(!this.attachedToElement){t=!hs.ForceAttachControlToAlwaysPreventDefault&&t,this.attachedToElement=!0,this.noPreventDefault=t;for(const i in this.attached)this.attached[i].attachControl(t)}}detachElement(t=!1){for(const i in this.attached)this.attached[i].detachControl(),t&&(this.attached[i].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const t in this.attached){const i=this.attached[t];i.checkInputs&&(this.checkInputs=this.uU(i.checkInputs.bind(i)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(t){const i={};for(const t in this.attached){const e=this.attached[t],s=ot.Serialize(e);i[e.getClassName()]=s}t.inputsmgr=i}parse(t){const i=t.inputsmgr;if(i){this.clear();for(const t in i){const e=ih[t];if(e){const s=i[t],n=ot.Parse((()=>new e),s,null);this.add(n)}}}else for(const i in this.attached){const e=ih[this.attached[i].getClassName()];if(e){const s=ot.Parse((()=>new e),t,null);this.remove(this.attached[i]),this.add(s)}}}}class sh{constructor(t,i,e,s=0,n=1,r=2,h=3){this.id=t,this.index=i,this.browserGamepad=e,this.fU={x:0,y:0},this.dU={x:0,y:0},this.pU=!0,this.mU=!1,this.type=sh.GAMEPAD,this.vU=s,this.gU=n,this.SU=r,this.EU=h,this.browserGamepad.axes.length>=2&&(this.fU={x:this.browserGamepad.axes[this.vU],y:this.browserGamepad.axes[this.gU]}),this.browserGamepad.axes.length>=4&&(this.dU={x:this.browserGamepad.axes[this.SU],y:this.browserGamepad.axes[this.EU]})}get isConnected(){return this.pU}onleftstickchanged(t){this.AU=t}onrightstickchanged(t){this.CU=t}get leftStick(){return this.fU}set leftStick(t){!this.AU||this.fU.x===t.x&&this.fU.y===t.y||this.AU(t),this.fU=t}get rightStick(){return this.dU}set rightStick(t){!this.CU||this.dU.x===t.x&&this.dU.y===t.y||this.CU(t),this.dU=t}update(){this.fU&&(this.leftStick={x:this.browserGamepad.axes[this.vU],y:this.browserGamepad.axes[this.gU]},this.mU&&(this.leftStick.y*=-1)),this.dU&&(this.rightStick={x:this.browserGamepad.axes[this.SU],y:this.browserGamepad.axes[this.EU]})}dispose(){}}sh.GAMEPAD=0,sh.GENERIC=1,sh.XBOX=2,sh.POSE_ENABLED=3,sh.DUALSHOCK=4;class nh extends sh{constructor(t,i,e){super(t,i,e),this.onButtonDownObservable=new h,this.onButtonUpObservable=new h,this.type=sh.GENERIC,this.wU=new Array(e.buttons.length)}onbuttondown(t){this.xU=t}onbuttonup(t){this.TU=t}RU(t,i,e){return t!==i&&(1===t&&(this.xU&&this.xU(e),this.onButtonDownObservable.notifyObservers(e)),0===t&&(this.TU&&this.TU(e),this.onButtonUpObservable.notifyObservers(e))),t}update(){super.update();for(let t=0;t<this.wU.length;t++)this.wU[t]=this.RU(this.browserGamepad.buttons[t].value,this.wU[t],t)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}class rh{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this.IU=1}get invertYAxis(){return 1!==this.IU}set invertYAxis(t){this.IU=t?-1:1}attachControl(){const t=this.camera.getScene().gamepadManager;this.MU=t.onGamepadConnectedObservable.add((t=>{t.type!==sh.POSE_ENABLED&&(this.gamepad&&t.type!==sh.XBOX||(this.gamepad=t))})),this.bU=t.onGamepadDisconnectedObservable.add((t=>{this.gamepad===t&&(this.gamepad=null)})),this.gamepad=t.getGamepadByType(sh.XBOX)}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this.MU),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this.bU),this.gamepad=null}checkInputs(){if(this.gamepad){const t=this.camera,i=this.gamepad.rightStick;if(i){if(0!=i.x){const e=i.x/this.gamepadRotationSensibility;0!=e&&Math.abs(e)>.005&&(t.inertialAlphaOffset+=e)}if(0!=i.y){const e=i.y/this.gamepadRotationSensibility*this.IU;0!=e&&Math.abs(e)>.005&&(t.inertialBetaOffset+=e)}}const e=this.gamepad.leftStick;if(e&&0!=e.y){const t=e.y/this.gamepadMoveSensibility;0!=t&&Math.abs(t)>.005&&(this.camera.inertialRadiusOffset-=t)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}ut([Q()],rh.prototype,"gamepadRotationSensibility",void 0),ut([Q()],rh.prototype,"gamepadMoveSensibility",void 0),ih.ArcRotateCameraGamepadInput=rh;class hh{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this.re=new Array}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments),this._U||(this.Kt=this.camera.getScene(),this.Ls=this.Kt.getEngine(),this._U=this.Ls.onCanvasBlurObservable.add((()=>{this.re.length=0})),this.yU=this.Kt.onKeyboardObservable.add((i=>{const e=i.event;if(!e.metaKey)if(i.type===Se.KEYDOWN){if(this.NU=e.ctrlKey,this.PU=e.altKey,-1!==this.keysUp.indexOf(e.keyCode)||-1!==this.keysDown.indexOf(e.keyCode)||-1!==this.keysLeft.indexOf(e.keyCode)||-1!==this.keysRight.indexOf(e.keyCode)||-1!==this.keysReset.indexOf(e.keyCode)){-1===this.re.indexOf(e.keyCode)&&this.re.push(e.keyCode),e.preventDefault&&(t||e.preventDefault())}}else if(-1!==this.keysUp.indexOf(e.keyCode)||-1!==this.keysDown.indexOf(e.keyCode)||-1!==this.keysLeft.indexOf(e.keyCode)||-1!==this.keysRight.indexOf(e.keyCode)||-1!==this.keysReset.indexOf(e.keyCode)){const i=this.re.indexOf(e.keyCode);i>=0&&this.re.splice(i,1),e.preventDefault&&(t||e.preventDefault())}})))}detachControl(){this.Kt&&(this.yU&&this.Kt.onKeyboardObservable.remove(this.yU),this._U&&this.Ls.onCanvasBlurObservable.remove(this._U),this.yU=null,this._U=null),this.re.length=0}checkInputs(){if(this.yU){const t=this.camera;for(let i=0;i<this.re.length;i++){const e=this.re[i];-1!==this.keysLeft.indexOf(e)?this.NU&&this.camera.CN?t.inertialPanningX-=1/this.panningSensibility:t.inertialAlphaOffset-=this.angularSpeed:-1!==this.keysUp.indexOf(e)?this.NU&&this.camera.CN?t.inertialPanningY+=1/this.panningSensibility:this.PU&&this.useAltToZoom?t.inertialRadiusOffset+=1/this.zoomingSensibility:t.inertialBetaOffset-=this.angularSpeed:-1!==this.keysRight.indexOf(e)?this.NU&&this.camera.CN?t.inertialPanningX+=1/this.panningSensibility:t.inertialAlphaOffset+=this.angularSpeed:-1!==this.keysDown.indexOf(e)?this.NU&&this.camera.CN?t.inertialPanningY-=1/this.panningSensibility:this.PU&&this.useAltToZoom?t.inertialRadiusOffset-=1/this.zoomingSensibility:t.inertialBetaOffset+=this.angularSpeed:-1!==this.keysReset.indexOf(e)&&t.useInputToRestoreState&&t.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}ut([Q()],hh.prototype,"keysUp",void 0),ut([Q()],hh.prototype,"keysDown",void 0),ut([Q()],hh.prototype,"keysLeft",void 0),ut([Q()],hh.prototype,"keysRight",void 0),ut([Q()],hh.prototype,"keysReset",void 0),ut([Q()],hh.prototype,"panningSensibility",void 0),ut([Q()],hh.prototype,"zoomingSensibility",void 0),ut([Q()],hh.prototype,"useAltToZoom",void 0),ut([Q()],hh.prototype,"angularSpeed",void 0),ih.ArcRotateCameraKeyboardMoveInput=hh;class oh{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this.DU=w.Zero()}LU(t,i){let e=0;const s=.01*t*this.wheelDeltaPercentage*i;return e=t>0?s/(1+this.wheelDeltaPercentage):s*(1+this.wheelDeltaPercentage),e}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments),this.JB=i=>{if(i.type!==pe.POINTERWHEEL)return;const e=i.event;let s=0;const n=e.deltaMode===Ce.DOM_DELTA_LINE?40:1,r=-e.deltaY*n;if(this.customComputeDeltaFromMouseWheel)s=this.customComputeDeltaFromMouseWheel(r,this,e);else if(this.wheelDeltaPercentage){if(s=this.LU(r,this.camera.radius),s>0){let t=this.camera.radius,i=this.camera.inertialRadiusOffset+s;for(let e=0;e<20&&Math.abs(i)>.001;e++)t-=i,i*=this.camera.inertia;t=o.Clamp(t,0,Number.MAX_VALUE),s=this.LU(r,t)}}else s=r/(40*this.wheelPrecision);s&&(this.zoomToMouseLocation&&this.OU?this.FU(s):this.camera.inertialRadiusOffset+=s),e.preventDefault&&(t||e.preventDefault())},this.tU=this.camera.getScene().ud.sm(this.JB,pe.POINTERWHEEL),this.zoomToMouseLocation&&this.DU.setAll(0)}detachControl(){this.tU&&(this.camera.getScene().ud.nm(this.tU),this.tU=null,this.JB=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const t=this.camera;0+t.inertialAlphaOffset+t.inertialBetaOffset+t.inertialRadiusOffset&&(this.BU(),t.target.addInPlace(this.DU),this.DU.scaleInPlace(t.inertia),this.UU(this.DU))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}BU(){const t=this.camera,i=t.target.subtract(t.position);this.OU=Pe.FromPositionAndNormal(t.target,i)}VU(){var t;const i=this.camera,e=i.getScene(),s=e.createPickingRay(e.pointerX,e.pointerY,R.Identity(),i,!1);let n=0;return this.OU&&(n=null!==(t=s.intersectsPlane(this.OU))&&void 0!==t?t:0),s.origin.addInPlace(s.direction.scaleInPlace(n))}FU(t){var i,e;const s=this.camera,n=1-s.inertia;if(s.lowerRadiusLimit){const e=null!==(i=s.lowerRadiusLimit)&&void 0!==i?i:0;s.radius-(s.inertialRadiusOffset+t)/n<e&&(t=(s.radius-e)*n-s.inertialRadiusOffset)}if(s.upperRadiusLimit){const i=null!==(e=s.upperRadiusLimit)&&void 0!==e?e:0;s.radius-(s.inertialRadiusOffset+t)/n>i&&(t=(s.radius-i)*n-s.inertialRadiusOffset)}const r=t/n/s.radius,h=this.VU(),o=M.Vector3[6];h.subtractToRef(s.target,o),o.scaleInPlace(r),o.scaleInPlace(n),this.DU.addInPlace(o),s.inertialRadiusOffset+=t}UU(t){Math.abs(t.x)<u&&(t.x=0),Math.abs(t.y)<u&&(t.y=0),Math.abs(t.z)<u&&(t.z=0)}}ut([Q()],oh.prototype,"wheelPrecision",void 0),ut([Q()],oh.prototype,"zoomToMouseLocation",void 0),ut([Q()],oh.prototype,"wheelDeltaPercentage",void 0),ih.ArcRotateCameraMouseWheelInput=oh;class ah extends th{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this.kU=!1,this.GU=0,this.zU=!1}getClassName(){return"ArcRotateCameraPointersInput"}HU(t,i){if(0!==this.panningSensibility&&t&&i){const e=i.x-t.x,s=i.y-t.y;this.camera.inertialPanningX+=-e/this.panningSensibility,this.camera.inertialPanningY+=s/this.panningSensibility}}XU(t,i){const e=this.camera.radius||ah.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=e*Math.sqrt(t)/Math.sqrt(i):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=.001*(i-t)*e*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(i-t)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(t,i,e){0!==this.panningSensibility&&(this.nU&&this.camera.CN||this.kU)?(this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=e/this.panningSensibility):(this.camera.inertialAlphaOffset-=i/this.angularSensibilityX,this.camera.inertialBetaOffset-=e/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(t,i,e,s,n,r){0===e&&null===n||0===s&&null===r||(this.multiTouchPanAndZoom?(this.XU(e,s),this.HU(n,r)):this.multiTouchPanning&&this.pinchZoom?(this.GU++,this.zU||this.GU<20&&Math.abs(Math.sqrt(s)-Math.sqrt(e))>this.camera.pinchToPanMaxDistance?(this.XU(e,s),this.zU=!0):this.HU(n,r)):this.multiTouchPanning?this.HU(n,r):this.pinchZoom&&this.XU(e,s))}onButtonDown(t){this.kU=t.button===this.camera.wN}onButtonUp(){this.GU=0,this.zU=!1}onLostFocus(){this.kU=!1,this.GU=0,this.zU=!1}}ah.MinimumRadiusForPinch=.001,ut([Q()],ah.prototype,"buttons",void 0),ut([Q()],ah.prototype,"angularSensibilityX",void 0),ut([Q()],ah.prototype,"angularSensibilityY",void 0),ut([Q()],ah.prototype,"pinchPrecision",void 0),ut([Q()],ah.prototype,"pinchDeltaPercentage",void 0),ut([Q()],ah.prototype,"useNaturalPinchZoom",void 0),ut([Q()],ah.prototype,"pinchZoom",void 0),ut([Q()],ah.prototype,"panningSensibility",void 0),ut([Q()],ah.prototype,"multiTouchPanning",void 0),ut([Q()],ah.prototype,"multiTouchPanAndZoom",void 0),ih.ArcRotateCameraPointersInput=ah;class lh extends eh{constructor(t){super(t)}addMouseWheel(){return this.add(new oh),this}addPointers(){return this.add(new ah),this}addKeyboard(){return this.add(new hh),this}}lh.prototype.addVRDeviceOrientation=function(){return this.add(new ch),this};class ch{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this.dR=0,this.WU=0,this.kl=!1,this.$U=this.YU.bind(this)}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(t);const i=this.camera.getScene().getEngine().getHostWindow();i&&("undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((t=>{"granted"===t?i.addEventListener("deviceorientation",this.$U):ki.Warn("Permission not granted.")})).catch((t=>{ki.Error(t)})):i.addEventListener("deviceorientation",this.$U))}YU(t){null!==t.alpha&&(this.dR=(0|+t.alpha)*this.alphaCorrection),null!==t.gamma&&(this.WU=(0|+t.gamma)*this.gammaCorrection),this.kl=!0}checkInputs(){this.kl&&(this.kl=!1,this.WU<0&&(this.WU=180+this.WU),this.camera.alpha=-this.dR/180*Math.PI%Math.PI*2,this.camera.beta=this.WU/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this.$U)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}ih.ArcRotateCameraVRDeviceOrientationInput=ch;class uh{constructor(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this.re=new Array}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments),this._U||(this.Kt=this.camera.getScene(),this.Ls=this.Kt.getEngine(),this._U=this.Ls.onCanvasBlurObservable.add((()=>{this.re.length=0})),this.yU=this.Kt.onKeyboardObservable.add((i=>{const e=i.event;if(i.type===Se.KEYDOWN){if(-1!==this.keysForward.indexOf(e.keyCode)||-1!==this.keysBackward.indexOf(e.keyCode)||-1!==this.keysUp.indexOf(e.keyCode)||-1!==this.keysDown.indexOf(e.keyCode)||-1!==this.keysLeft.indexOf(e.keyCode)||-1!==this.keysRight.indexOf(e.keyCode)){-1===this.re.indexOf(e.keyCode)&&this.re.push(e.keyCode),t||e.preventDefault()}}else if(-1!==this.keysForward.indexOf(e.keyCode)||-1!==this.keysBackward.indexOf(e.keyCode)||-1!==this.keysUp.indexOf(e.keyCode)||-1!==this.keysDown.indexOf(e.keyCode)||-1!==this.keysLeft.indexOf(e.keyCode)||-1!==this.keysRight.indexOf(e.keyCode)){const i=this.re.indexOf(e.keyCode);i>=0&&this.re.splice(i,1),t||e.preventDefault()}})))}detachControl(){this.Kt&&(this.yU&&this.Kt.onKeyboardObservable.remove(this.yU),this._U&&this.Ls.onCanvasBlurObservable.remove(this._U),this.yU=null,this._U=null),this.re.length=0}getClassName(){return"FlyCameraKeyboardInput"}lU(){this.re.length=0}getSimpleName(){return"keyboard"}checkInputs(){if(this.yU){const t=this.camera;for(let i=0;i<this.re.length;i++){const e=this.re[i],s=t.jU();-1!==this.keysForward.indexOf(e)?t.GM.copyFromFloats(0,0,s):-1!==this.keysBackward.indexOf(e)?t.GM.copyFromFloats(0,0,-s):-1!==this.keysUp.indexOf(e)?t.GM.copyFromFloats(0,s,0):-1!==this.keysDown.indexOf(e)?t.GM.copyFromFloats(0,-s,0):-1!==this.keysRight.indexOf(e)?t.GM.copyFromFloats(s,0,0):-1!==this.keysLeft.indexOf(e)&&t.GM.copyFromFloats(-s,0,0),t.getScene().useRightHandedSystem&&(t.GM.z*=-1),t.getViewMatrix().invertToRef(t.KU),w.TransformNormalToRef(t.GM,t.KU,t.qU),t.cameraDirection.addInPlace(t.qU)}}}}ut([Q()],uh.prototype,"keysForward",void 0),ut([Q()],uh.prototype,"keysBackward",void 0),ut([Q()],uh.prototype,"keysUp",void 0),ut([Q()],uh.prototype,"keysDown",void 0),ut([Q()],uh.prototype,"keysRight",void 0),ut([Q()],uh.prototype,"keysLeft",void 0),ih.FlyCameraKeyboardInput=uh;class fh{constructor(){this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this.QU=null}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments),this.ZU=t,this.tU=this.camera.getScene().ud.sm((t=>{this.aU(t)}),pe.POINTERDOWN|pe.POINTERUP|pe.POINTERMOVE),this.JU=this.camera.getScene().onBeforeRenderObservable.add((()=>{this.camera.rollCorrect&&this.camera.restoreRoll(this.camera.rollCorrect)}))}detachControl(){this.tU&&(this.camera.getScene().ud.nm(this.tU),this.camera.getScene().onBeforeRenderObservable.remove(this.JU),this.tU=null,this.JU=null,this.QU=null,this.ZU=void 0)}getClassName(){return"FlyCameraMouseInput"}getSimpleName(){return"mouse"}aU(t){const i=t.event,e=this.camera.getEngine();if(e.isInVRExclusivePointerMode)return;if(!this.touchEnabled&&"touch"===i.pointerType)return;if(t.type!==pe.POINTERMOVE&&-1===this.buttons.indexOf(i.button))return;const s=i.target;if(t.type===pe.POINTERDOWN){try{null==s||s.setPointerCapture(i.pointerId)}catch(i){}this.QU={x:i.clientX,y:i.clientY},this.activeButton=i.button,this.ZU||(i.preventDefault(),this.tV.focus()),e.isPointerLock&&this.iV(t.event)}else if(t.type===pe.POINTERUP){try{null==s||s.releasePointerCapture(i.pointerId)}catch(i){}this.activeButton=-1,this.QU=null,this.ZU||i.preventDefault()}else if(t.type===pe.POINTERMOVE){if(!this.QU)return void(e.isPointerLock&&this.iV(t.event));const s=i.clientX-this.QU.x,n=i.clientY-this.QU.y;this.eV(s,n),this.QU={x:i.clientX,y:i.clientY},this.ZU||i.preventDefault()}}iV(t){const i=this.camera.getEngine();if(!i.isPointerLock||i.isInVRExclusivePointerMode)return;const e=t.movementX,s=t.movementY;this.eV(e,s),this.QU=null,this.ZU||t.preventDefault()}eV(t,i){const e=this.camera;this.camera.getScene().useRightHandedSystem&&(t*=-1),e.parent&&e.parent.zi()<0&&(t*=-1);const s=t/this.angularSensibility,n=i/this.angularSensibility,r=T.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z);let h;if(this.buttonsPitch.some((t=>t===this.activeButton))&&(h=T.RotationAxis(Ge.X,n),r.multiplyInPlace(h)),this.buttonsYaw.some((t=>t===this.activeButton))){h=T.RotationAxis(Ge.Y,s),r.multiplyInPlace(h);const t=e.bankedTurnLimit+e.sV;if(e.bankedTurn&&-t<e.rotation.z&&e.rotation.z<t){const t=e.bankedTurnMultiplier*-s;h=T.RotationAxis(Ge.Z,t),r.multiplyInPlace(h)}}this.buttonsRoll.some((t=>t===this.activeButton))&&(h=T.RotationAxis(Ge.Z,-s),e.sV-=s,r.multiplyInPlace(h)),r.toEulerAnglesToRef(e.rotation)}}ut([Q()],fh.prototype,"buttons",void 0),ut([Q()],fh.prototype,"angularSensibility",void 0),ih.FlyCameraMouseInput=fh;class dh{constructor(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this.re=new Array}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments),this._U||(this.Kt=this.camera.getScene(),this.Ls=this.Kt.getEngine(),this._U=this.Ls.onCanvasBlurObservable.add((()=>{this.re.length=0})),this.yU=this.Kt.onKeyboardObservable.add((i=>{const e=i.event;if(!e.metaKey)if(i.type===Se.KEYDOWN){if(this.NU=e.ctrlKey,this.PU=e.altKey,this.nV=e.shiftKey,-1!==this.keysHeightOffsetIncr.indexOf(e.keyCode)||-1!==this.keysHeightOffsetDecr.indexOf(e.keyCode)||-1!==this.keysRotationOffsetIncr.indexOf(e.keyCode)||-1!==this.keysRotationOffsetDecr.indexOf(e.keyCode)||-1!==this.keysRadiusIncr.indexOf(e.keyCode)||-1!==this.keysRadiusDecr.indexOf(e.keyCode)){-1===this.re.indexOf(e.keyCode)&&this.re.push(e.keyCode),e.preventDefault&&(t||e.preventDefault())}}else if(-1!==this.keysHeightOffsetIncr.indexOf(e.keyCode)||-1!==this.keysHeightOffsetDecr.indexOf(e.keyCode)||-1!==this.keysRotationOffsetIncr.indexOf(e.keyCode)||-1!==this.keysRotationOffsetDecr.indexOf(e.keyCode)||-1!==this.keysRadiusIncr.indexOf(e.keyCode)||-1!==this.keysRadiusDecr.indexOf(e.keyCode)){const i=this.re.indexOf(e.keyCode);i>=0&&this.re.splice(i,1),e.preventDefault&&(t||e.preventDefault())}})))}detachControl(){this.Kt&&(this.yU&&this.Kt.onKeyboardObservable.remove(this.yU),this._U&&this.Ls.onCanvasBlurObservable.remove(this._U),this.yU=null,this._U=null),this.re.length=0}checkInputs(){this.yU&&this.re.forEach((t=>{-1!==this.keysHeightOffsetIncr.indexOf(t)&&this.rV()?this.camera.heightOffset+=this.heightSensibility:-1!==this.keysHeightOffsetDecr.indexOf(t)&&this.rV()?this.camera.heightOffset-=this.heightSensibility:-1!==this.keysRotationOffsetIncr.indexOf(t)&&this.hV()?(this.camera.rotationOffset+=this.rotationSensibility,this.camera.rotationOffset%=360):-1!==this.keysRotationOffsetDecr.indexOf(t)&&this.hV()?(this.camera.rotationOffset-=this.rotationSensibility,this.camera.rotationOffset%=360):-1!==this.keysRadiusIncr.indexOf(t)&&this.oV()?this.camera.radius+=this.radiusSensibility:-1!==this.keysRadiusDecr.indexOf(t)&&this.oV()&&(this.camera.radius-=this.radiusSensibility)}))}getClassName(){return"FollowCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}rV(){return this.keysHeightOffsetModifierAlt===this.PU&&this.keysHeightOffsetModifierCtrl===this.NU&&this.keysHeightOffsetModifierShift===this.nV}hV(){return this.keysRotationOffsetModifierAlt===this.PU&&this.keysRotationOffsetModifierCtrl===this.NU&&this.keysRotationOffsetModifierShift===this.nV}oV(){return this.keysRadiusModifierAlt===this.PU&&this.keysRadiusModifierCtrl===this.NU&&this.keysRadiusModifierShift===this.nV}}ut([Q()],dh.prototype,"keysHeightOffsetIncr",void 0),ut([Q()],dh.prototype,"keysHeightOffsetDecr",void 0),ut([Q()],dh.prototype,"keysHeightOffsetModifierAlt",void 0),ut([Q()],dh.prototype,"keysHeightOffsetModifierCtrl",void 0),ut([Q()],dh.prototype,"keysHeightOffsetModifierShift",void 0),ut([Q()],dh.prototype,"keysRotationOffsetIncr",void 0),ut([Q()],dh.prototype,"keysRotationOffsetDecr",void 0),ut([Q()],dh.prototype,"keysRotationOffsetModifierAlt",void 0),ut([Q()],dh.prototype,"keysRotationOffsetModifierCtrl",void 0),ut([Q()],dh.prototype,"keysRotationOffsetModifierShift",void 0),ut([Q()],dh.prototype,"keysRadiusIncr",void 0),ut([Q()],dh.prototype,"keysRadiusDecr",void 0),ut([Q()],dh.prototype,"keysRadiusModifierAlt",void 0),ut([Q()],dh.prototype,"keysRadiusModifierCtrl",void 0),ut([Q()],dh.prototype,"keysRadiusModifierShift",void 0),ut([Q()],dh.prototype,"heightSensibility",void 0),ut([Q()],dh.prototype,"rotationSensibility",void 0),ut([Q()],dh.prototype,"radiusSensibility",void 0),ih.FollowCameraKeyboardMoveInput=dh;class ph{constructor(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments),this.JB=i=>{if(i.type!==pe.POINTERWHEEL)return;const e=i.event;let s=0;const n=Math.max(-1,Math.min(1,e.deltaY));this.wheelDeltaPercentage?(console.assert(this.axisControlRadius+this.axisControlHeight+this.axisControlRotation<=1,"wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+this.axisControlRadius+", axisControlHeightOffset: "+this.axisControlHeight+", axisControlRotationOffset: "+this.axisControlRotation),this.axisControlRadius?s=.01*n*this.wheelDeltaPercentage*this.camera.radius:this.axisControlHeight?s=.01*n*this.wheelDeltaPercentage*this.camera.heightOffset:this.axisControlRotation&&(s=.01*n*this.wheelDeltaPercentage*this.camera.rotationOffset)):s=n*this.wheelPrecision,s&&(this.axisControlRadius?this.camera.radius+=s:this.axisControlHeight?this.camera.heightOffset-=s:this.axisControlRotation&&(this.camera.rotationOffset-=s)),e.preventDefault&&(t||e.preventDefault())},this.tU=this.camera.getScene().ud.sm(this.JB,pe.POINTERWHEEL)}detachControl(){this.tU&&(this.camera.getScene().ud.nm(this.tU),this.tU=null,this.JB=null)}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}ut([Q()],ph.prototype,"axisControlRadius",void 0),ut([Q()],ph.prototype,"axisControlHeight",void 0),ut([Q()],ph.prototype,"axisControlRotation",void 0),ut([Q()],ph.prototype,"wheelPrecision",void 0),ut([Q()],ph.prototype,"wheelDeltaPercentage",void 0),ih.FollowCameraMouseWheelInput=ph;class mh extends th{constructor(){super(...arguments),this.angularSensibilityX=1,this.angularSensibilityY=1,this.pinchPrecision=1e4,this.pinchDeltaPercentage=0,this.axisXControlRadius=!1,this.axisXControlHeight=!1,this.axisXControlRotation=!0,this.axisYControlRadius=!1,this.axisYControlHeight=!0,this.axisYControlRotation=!1,this.axisPinchControlRadius=!0,this.axisPinchControlHeight=!1,this.axisPinchControlRotation=!1,this.warningEnable=!0,this.aV=0}getClassName(){return"FollowCameraPointersInput"}onTouch(t,i,e){this.lV(),this.axisXControlRotation?this.camera.rotationOffset+=i/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=e/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=i/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=e/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=i/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=e/this.angularSensibilityY)}onMultiTouch(t,i,e,s,n,r){if(0===e&&null===n)return;if(0===s&&null===r)return;let h=(s-e)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(h*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=h*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=h*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=h*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=h),this.axisPinchControlHeight&&(this.camera.heightOffset+=h),this.axisPinchControlRadius&&(this.camera.radius-=h))}lV(){if(!this.warningEnable||this.aV++%100!=0)return;const t="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";console.assert(this.axisXControlRotation+this.axisXControlHeight+this.axisXControlRadius<=1,t+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),console.assert(this.axisYControlRotation+this.axisYControlHeight+this.axisYControlRadius<=1,t+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),console.assert(this.axisPinchControlRotation+this.axisPinchControlHeight+this.axisPinchControlRadius<=1,t+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}}ut([Q()],mh.prototype,"angularSensibilityX",void 0),ut([Q()],mh.prototype,"angularSensibilityY",void 0),ut([Q()],mh.prototype,"pinchPrecision",void 0),ut([Q()],mh.prototype,"pinchDeltaPercentage",void 0),ut([Q()],mh.prototype,"axisXControlRadius",void 0),ut([Q()],mh.prototype,"axisXControlHeight",void 0),ut([Q()],mh.prototype,"axisXControlRotation",void 0),ut([Q()],mh.prototype,"axisYControlRadius",void 0),ut([Q()],mh.prototype,"axisYControlHeight",void 0),ut([Q()],mh.prototype,"axisYControlRotation",void 0),ut([Q()],mh.prototype,"axisPinchControlRadius",void 0),ut([Q()],mh.prototype,"axisPinchControlHeight",void 0),ut([Q()],mh.prototype,"axisPinchControlRotation",void 0),ih.FollowCameraPointersInput=mh;class vh{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.re=new Array}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments),this._U||(this.Kt=this.camera.getScene(),this.Ls=this.Kt.getEngine(),this._U=this.Ls.onCanvasBlurObservable.add((()=>{this.re.length=0})),this.yU=this.Kt.onKeyboardObservable.add((i=>{const e=i.event;if(!e.metaKey)if(i.type===Se.KEYDOWN){if(-1!==this.keysUp.indexOf(e.keyCode)||-1!==this.keysDown.indexOf(e.keyCode)||-1!==this.keysLeft.indexOf(e.keyCode)||-1!==this.keysRight.indexOf(e.keyCode)||-1!==this.keysUpward.indexOf(e.keyCode)||-1!==this.keysDownward.indexOf(e.keyCode)||-1!==this.keysRotateLeft.indexOf(e.keyCode)||-1!==this.keysRotateRight.indexOf(e.keyCode)){-1===this.re.indexOf(e.keyCode)&&this.re.push(e.keyCode),t||e.preventDefault()}}else if(-1!==this.keysUp.indexOf(e.keyCode)||-1!==this.keysDown.indexOf(e.keyCode)||-1!==this.keysLeft.indexOf(e.keyCode)||-1!==this.keysRight.indexOf(e.keyCode)||-1!==this.keysUpward.indexOf(e.keyCode)||-1!==this.keysDownward.indexOf(e.keyCode)||-1!==this.keysRotateLeft.indexOf(e.keyCode)||-1!==this.keysRotateRight.indexOf(e.keyCode)){const i=this.re.indexOf(e.keyCode);i>=0&&this.re.splice(i,1),t||e.preventDefault()}})))}detachControl(){this.Kt&&(this.yU&&this.Kt.onKeyboardObservable.remove(this.yU),this._U&&this.Ls.onCanvasBlurObservable.remove(this._U),this.yU=null,this._U=null),this.re.length=0}checkInputs(){if(this.yU){const t=this.camera;for(let i=0;i<this.re.length;i++){const e=this.re[i],s=t.jU();-1!==this.keysLeft.indexOf(e)?t.GM.copyFromFloats(-s,0,0):-1!==this.keysUp.indexOf(e)?t.GM.copyFromFloats(0,0,s):-1!==this.keysRight.indexOf(e)?t.GM.copyFromFloats(s,0,0):-1!==this.keysDown.indexOf(e)?t.GM.copyFromFloats(0,0,-s):-1!==this.keysUpward.indexOf(e)?t.GM.copyFromFloats(0,s,0):-1!==this.keysDownward.indexOf(e)?t.GM.copyFromFloats(0,-s,0):-1!==this.keysRotateLeft.indexOf(e)?(t.GM.copyFromFloats(0,0,0),t.cameraRotation.y-=this.cV()):-1!==this.keysRotateRight.indexOf(e)&&(t.GM.copyFromFloats(0,0,0),t.cameraRotation.y+=this.cV()),t.getScene().useRightHandedSystem&&(t.GM.z*=-1),t.getViewMatrix().invertToRef(t.KU),w.TransformNormalToRef(t.GM,t.KU,t.qU),t.cameraDirection.addInPlace(t.qU)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}lU(){this.re.length=0}getSimpleName(){return"keyboard"}cV(){let t=this.rotationSpeed*this.Ls.getDeltaTime()/1e3;return this.camera.getScene().useRightHandedSystem&&(t*=-1),this.camera.parent&&this.camera.parent.zi()<0&&(t*=-1),t}}ut([Q()],vh.prototype,"keysUp",void 0),ut([Q()],vh.prototype,"keysUpward",void 0),ut([Q()],vh.prototype,"keysDown",void 0),ut([Q()],vh.prototype,"keysDownward",void 0),ut([Q()],vh.prototype,"keysLeft",void 0),ut([Q()],vh.prototype,"keysRight",void 0),ut([Q()],vh.prototype,"rotationSpeed",void 0),ut([Q()],vh.prototype,"keysRotateLeft",void 0),ut([Q()],vh.prototype,"keysRotateRight",void 0),ih.FreeCameraKeyboardMoveInput=vh;class gh{constructor(t=!0){this.touchEnabled=t,this.buttons=[0,1,2],this.angularSensibility=2e3,this.QU=null,this.onPointerMovedObservable=new h,this.uV=!0,this.iU=-1,this.fV=-1}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments);const i=this.camera.getEngine(),e=i.getInputElement();this.aU||(this.aU=s=>{const n=s.event,r="touch"===n.pointerType;if(i.isInVRExclusivePointerMode)return;if(!this.touchEnabled&&r)return;if(s.type!==pe.POINTERMOVE&&-1===this.buttons.indexOf(n.button))return;const h=n.target;if(s.type===pe.POINTERDOWN){if(r&&-1!==this.fV||!r&&-1!==this.iU)return;this.fV=n.pointerId;try{null==h||h.setPointerCapture(n.pointerId)}catch(t){}-1===this.iU&&(this.iU=n.button),this.QU={x:n.clientX,y:n.clientY},t||(n.preventDefault(),e&&e.focus()),i.isPointerLock&&this.iV&&this.iV(s.event)}else if(s.type===pe.POINTERUP){if(r&&this.fV!==n.pointerId||!r&&this.iU!==n.button)return;try{null==h||h.releasePointerCapture(n.pointerId)}catch(t){}this.iU=-1,this.QU=null,t||n.preventDefault(),this.fV=-1}else if(s.type===pe.POINTERMOVE&&(this.fV===n.pointerId||!r))if(i.isPointerLock&&this.iV)this.iV(s.event);else if(this.QU){let i=n.clientX-this.QU.x;const e=n.clientY-this.QU.y;this.camera.getScene().useRightHandedSystem&&(i*=-1),this.camera.parent&&this.camera.parent.zi()<0&&(i*=-1),this.uV&&(this.camera.cameraRotation.y+=i/this.angularSensibility,this.camera.cameraRotation.x+=e/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:i,offsetY:e}),this.QU={x:n.clientX,y:n.clientY},t||n.preventDefault()}}),this.iV=e=>{if(!i.isPointerLock)return;if(i.isInVRExclusivePointerMode)return;let s=e.movementX;this.camera.getScene().useRightHandedSystem&&(s*=-1),this.camera.parent&&this.camera.parent.zi()<0&&(s*=-1),this.camera.cameraRotation.y+=s/this.angularSensibility;const n=e.movementY;this.camera.cameraRotation.x+=n/this.angularSensibility,this.QU=null,t||e.preventDefault()},this.tU=this.camera.getScene().ud.sm(this.aU,pe.POINTERDOWN|pe.POINTERUP|pe.POINTERMOVE),e&&(this.cU=this.onContextMenu.bind(this),e.addEventListener("contextmenu",this.cU,!1))}onContextMenu(t){t.preventDefault()}detachControl(){if(this.tU){if(this.camera.getScene().ud.nm(this.tU),this.cU){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this.cU)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this.tU=null,this.iV=null,this.QU=null}this.iU=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}var Sh,Eh,Ah,Ch,wh,xh,Th;ut([Q()],gh.prototype,"buttons",void 0),ut([Q()],gh.prototype,"angularSensibility",void 0),ih.FreeCameraMouseInput=gh,function(t){t[t.MoveRelative=0]="MoveRelative",t[t.RotateRelative=1]="RotateRelative",t[t.MoveScene=2]="MoveScene"}(Sh||(Sh={}));class Rh extends Jr{constructor(){super(...arguments),this.dV=w.Zero(),this.pV=w.Zero(),this.mV=w.Zero(),this.vV=Sh.MoveRelative,this.gV=Ue.X,this.SV=Sh.MoveRelative,this.EV=Ue.Z,this.AV=null,this.CV=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(t){null===t&&this.vV!==Sh.MoveRelative||(this.vV=Sh.MoveRelative,this.gV=t)}get wheelXMoveRelative(){return this.vV!==Sh.MoveRelative?null:this.gV}set wheelYMoveRelative(t){null===t&&this.SV!==Sh.MoveRelative||(this.SV=Sh.MoveRelative,this.EV=t)}get wheelYMoveRelative(){return this.SV!==Sh.MoveRelative?null:this.EV}set wheelZMoveRelative(t){null===t&&this.AV!==Sh.MoveRelative||(this.AV=Sh.MoveRelative,this.CV=t)}get wheelZMoveRelative(){return this.AV!==Sh.MoveRelative?null:this.CV}set wheelXRotateRelative(t){null===t&&this.vV!==Sh.RotateRelative||(this.vV=Sh.RotateRelative,this.gV=t)}get wheelXRotateRelative(){return this.vV!==Sh.RotateRelative?null:this.gV}set wheelYRotateRelative(t){null===t&&this.SV!==Sh.RotateRelative||(this.SV=Sh.RotateRelative,this.EV=t)}get wheelYRotateRelative(){return this.SV!==Sh.RotateRelative?null:this.EV}set wheelZRotateRelative(t){null===t&&this.AV!==Sh.RotateRelative||(this.AV=Sh.RotateRelative,this.CV=t)}get wheelZRotateRelative(){return this.AV!==Sh.RotateRelative?null:this.CV}set wheelXMoveScene(t){null===t&&this.vV!==Sh.MoveScene||(this.vV=Sh.MoveScene,this.gV=t)}get wheelXMoveScene(){return this.vV!==Sh.MoveScene?null:this.gV}set wheelYMoveScene(t){null===t&&this.SV!==Sh.MoveScene||(this.SV=Sh.MoveScene,this.EV=t)}get wheelYMoveScene(){return this.SV!==Sh.MoveScene?null:this.EV}set wheelZMoveScene(t){null===t&&this.AV!==Sh.MoveScene||(this.AV=Sh.MoveScene,this.CV=t)}get wheelZMoveScene(){return this.AV!==Sh.MoveScene?null:this.CV}checkInputs(){if(0===this.jB&&0===this.KB&&0==this.qB)return;this.dV.setAll(0),this.pV.setAll(0),this.mV.setAll(0),this.wV(),this.camera.getScene().useRightHandedSystem&&(this.dV.z*=-1);const t=R.Zero();this.camera.getViewMatrix().invertToRef(t);const i=w.Zero();w.TransformNormalToRef(this.dV,t,i),this.camera.cameraRotation.x+=this.pV.x/200,this.camera.cameraRotation.y+=this.pV.y/200,this.camera.cameraDirection.addInPlace(i),this.camera.cameraDirection.addInPlace(this.mV),super.checkInputs()}wV(){this.xV(this.jB,this.vV,this.gV),this.xV(this.KB,this.SV,this.EV),this.xV(this.qB,this.AV,this.CV)}xV(t,i,e){if(0===t)return;if(null===i||null===e)return;let s=null;switch(i){case Sh.MoveRelative:s=this.dV;break;case Sh.RotateRelative:s=this.pV;break;case Sh.MoveScene:s=this.mV}switch(e){case Ue.X:s.set(t,0,0);break;case Ue.Y:s.set(0,t,0);break;case Ue.Z:s.set(0,0,t)}}}ut([Q()],Rh.prototype,"wheelXMoveRelative",null),ut([Q()],Rh.prototype,"wheelYMoveRelative",null),ut([Q()],Rh.prototype,"wheelZMoveRelative",null),ut([Q()],Rh.prototype,"wheelXRotateRelative",null),ut([Q()],Rh.prototype,"wheelYRotateRelative",null),ut([Q()],Rh.prototype,"wheelZRotateRelative",null),ut([Q()],Rh.prototype,"wheelXMoveScene",null),ut([Q()],Rh.prototype,"wheelYMoveScene",null),ut([Q()],Rh.prototype,"wheelZMoveScene",null),ih.FreeCameraMouseWheelInput=Rh;class Ih{constructor(t=!1){this.allowMouse=t,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this.TV=null,this.RV=null,this.IV=new Array,this.MV=ki.IsSafari()}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments);let i=null;if(void 0===this.aU&&(this.lU=()=>{this.TV=null,this.RV=null},this.aU=e=>{const s=e.event,n="mouse"===s.pointerType||this.MV&&void 0===s.pointerType;if(this.allowMouse||!n)if(e.type===pe.POINTERDOWN){if(t||s.preventDefault(),this.IV.push(s.pointerId),1!==this.IV.length)return;i={x:s.clientX,y:s.clientY}}else if(e.type===pe.POINTERUP){t||s.preventDefault();const e=this.IV.indexOf(s.pointerId);if(-1===e)return;if(this.IV.splice(e,1),0!=e)return;i=null,this.TV=null,this.RV=null}else if(e.type===pe.POINTERMOVE){if(t||s.preventDefault(),!i)return;if(0!=this.IV.indexOf(s.pointerId))return;this.TV=s.clientX-i.x,this.RV=-(s.clientY-i.y)}}),this.tU=this.camera.getScene().ud.sm(this.aU,pe.POINTERDOWN|pe.POINTERUP|pe.POINTERMOVE),this.lU){const t=this.camera.getEngine().getInputElement();t&&t.addEventListener("blur",this.lU)}}detachControl(){if(this.aU){if(this.tU&&(this.camera.getScene().ud.nm(this.tU),this.tU=null),this.lU){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this.lU),this.lU=null}this.IV.length=0,this.TV=null,this.RV=null}}checkInputs(){if(null===this.TV||null===this.RV)return;if(0===this.TV&&0===this.RV)return;const t=this.camera;t.cameraRotation.y=this.TV/this.touchAngularSensibility;if(this.singleFingerRotate&&1===this.IV.length||!this.singleFingerRotate&&this.IV.length>1)t.cameraRotation.x=-this.RV/this.touchAngularSensibility;else{const i=t.jU(),e=new w(0,0,0!==this.touchMoveSensibility?i*this.RV/this.touchMoveSensibility:0);R.RotationYawPitchRollToRef(t.rotation.y,t.rotation.x,0,t.bV),t.cameraDirection.addInPlace(w.TransformCoordinates(e,t.bV))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}ut([Q()],Ih.prototype,"touchAngularSensibility",void 0),ut([Q()],Ih.prototype,"touchMoveSensibility",void 0),ih.FreeCameraTouchInput=Ih;class Mh extends eh{constructor(t){super(t),this._V=null,this.yV=null}addKeyboard(){return this.add(new vh),this}addMouse(t=!0){return this._V||(this._V=new gh(t),this.add(this._V)),this}removeMouse(){return this._V&&this.remove(this._V),this}addMouseWheel(){return this.yV||(this.yV=new Rh,this.add(this.yV)),this}removeMouseWheel(){return this.yV&&this.remove(this.yV),this}addTouch(){return this.add(new Ih),this}clear(){super.clear(),this._V=null}}Mh.prototype.addDeviceOrientation=function(t){return this.NV||(this.NV=new bh,t&&(this.NV.smoothFactor=t),this.add(this.NV)),this};class bh{constructor(){this.PV=0,this.DV=new T,this.dR=0,this.LV=0,this.WU=0,this.smoothFactor=0,this.OV=new h,this.FV=()=>{this.PV=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this.PV=-ki.ToRadians(this.PV/2),this.DV.copyFromFloats(0,Math.sin(this.PV),0,Math.cos(this.PV))},this.BV=t=>{this.smoothFactor?(this.dR=null!==t.alpha?ki.SmoothAngleChange(this.dR,t.alpha,this.smoothFactor):0,this.LV=null!==t.beta?ki.SmoothAngleChange(this.LV,t.beta,this.smoothFactor):0,this.WU=null!==t.gamma?ki.SmoothAngleChange(this.WU,t.gamma,this.smoothFactor):0):(this.dR=null!==t.alpha?t.alpha:0,this.LV=null!==t.beta?t.beta:0,this.WU=null!==t.gamma?t.gamma:0),null!==t.alpha&&this.OV.notifyObservers()},this.VV=new T(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this.FV()}static WaitForOrientationChangeAsync(t){return new Promise(((i,e)=>{let s=!1;const n=()=>{window.removeEventListener("deviceorientation",n),s=!0,i()};t&&setTimeout((()=>{s||(window.removeEventListener("deviceorientation",n),e("WaitForOrientationChangeAsync timed out"))}),t),"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((t=>{"granted"==t?window.addEventListener("deviceorientation",n):ki.Warn("Permission not granted.")})).catch((t=>{ki.Error(t)})):window.addEventListener("deviceorientation",n)}))}get camera(){return this.JD}set camera(t){this.JD=t,null==this.JD||this.JD.rotationQuaternion||(this.JD.rotationQuaternion=new T),this.JD&&this.JD.onDisposeObservable.add((()=>{this.OV.clear()}))}attachControl(){const t=this.camera.getScene().getEngine().getHostWindow();if(t){const i=()=>{t.addEventListener("orientationchange",this.FV),t.addEventListener("deviceorientation",this.BV),this.FV()};"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((t=>{"granted"===t?i():ki.Warn("Permission not granted.")})).catch((t=>{ki.Error(t)})):i()}}detachControl(){window.removeEventListener("orientationchange",this.FV),window.removeEventListener("deviceorientation",this.BV),this.dR=0}checkInputs(){this.dR&&(T.RotationYawPitchRollToRef(ki.ToRadians(this.dR),ki.ToRadians(this.LV),-ki.ToRadians(this.WU),this.camera.rotationQuaternion),this.JD.rotationQuaternion.multiplyInPlace(this.DV),this.JD.rotationQuaternion.multiplyInPlace(this.VV),this.JD.rotationQuaternion.z*=-1,this.JD.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}ih.FreeCameraDeviceOrientationInput=bh;class _h{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this.IU=1,this.kV=R.Identity(),this.GV=w.Zero(),this.zV=w.Zero(),this.HV=C.Zero()}get invertYAxis(){return 1!==this.IU}set invertYAxis(t){this.IU=t?-1:1}attachControl(){const t=this.camera.getScene().gamepadManager;this.MU=t.onGamepadConnectedObservable.add((t=>{t.type!==sh.POSE_ENABLED&&(this.gamepad&&t.type!==sh.XBOX||(this.gamepad=t))})),this.bU=t.onGamepadDisconnectedObservable.add((t=>{this.gamepad===t&&(this.gamepad=null)})),this.gamepad=t.getGamepadByType(sh.XBOX),!this.gamepad&&t.gamepads.length&&(this.gamepad=t.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this.MU),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this.bU),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const t=this.camera,i=this.gamepad.leftStick;0!==this.gamepadMoveSensibility&&(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadMoveSensibility:0,i.y=Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadMoveSensibility:0);let e=this.gamepad.rightStick;e&&0!==this.gamepadAngularSensibility?(e.x=Math.abs(e.x)>this.deadzoneDelta?e.x/this.gamepadAngularSensibility:0,e.y=(Math.abs(e.y)>this.deadzoneDelta?e.y/this.gamepadAngularSensibility:0)*this.IU):e={x:0,y:0},t.rotationQuaternion?t.rotationQuaternion.toRotationMatrix(this.kV):R.RotationYawPitchRollToRef(t.rotation.y,t.rotation.x,0,this.kV);const s=50*t.jU();this.zV.copyFromFloats(i.x*s,0,-i.y*s),w.TransformCoordinatesToRef(this.zV,this.kV,this.GV),t.cameraDirection.addInPlace(this.GV),this.HV.copyFromFloats(e.y,e.x),t.cameraRotation.addInPlace(this.HV)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}ut([Q()],_h.prototype,"gamepadAngularSensibility",void 0),ut([Q()],_h.prototype,"gamepadMoveSensibility",void 0),ih.FreeCameraGamepadInput=_h,function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.Z=2]="Z"}(Eh||(Eh={}));class yh{constructor(t,i){this.XV=!1;const e={...yh.WV(),...i};if(this.$V=!!t,yh.YV++,this.jV=Eh.X,this.KV=Eh.Y,this.reverseLeftRight=!1,this.reverseUpDown=!1,this.qV=new Xi,this.deltaPosition=w.Zero(),this.QV=25,this.ZV=1/(this.QV/1e3),this.TM=()=>{yh.JV=window.innerWidth,yh.tk=window.innerHeight,yh.Canvas&&(yh.Canvas.width=yh.JV,yh.Canvas.height=yh.tk),yh.ik=yh.JV/2},!yh.Canvas){window.addEventListener("resize",this.TM,!1),yh.Canvas=document.createElement("canvas"),yh.JV=window.innerWidth,yh.tk=window.innerHeight,yh.Canvas.width=window.innerWidth,yh.Canvas.height=window.innerHeight,yh.Canvas.style.width="100%",yh.Canvas.style.height="100%",yh.Canvas.style.position="absolute",yh.Canvas.style.backgroundColor="transparent",yh.Canvas.style.top="0px",yh.Canvas.style.left="0px",yh.Canvas.style.zIndex="5",yh.Canvas.style.touchAction="none",yh.Canvas.setAttribute("touch-action","none");const t=yh.Canvas.getContext("2d");if(!t)throw new Error("Unable to create canvas for virtual joystick");yh.ek=t,yh.ek.strokeStyle="#ffffff",yh.ek.lineWidth=2,document.body.appendChild(yh.Canvas)}yh.ik=yh.Canvas.width/2,this.pressed=!1,this.limitToContainer=e.limitToContainer,this.sk=e.color,this.containerSize=e.containerSize,this.puckSize=e.puckSize,e.position&&this.setPosition(e.position.x,e.position.y),e.puckImage&&this.setPuckImage(e.puckImage),e.containerImage&&this.setContainerImage(e.containerImage),e.alwaysVisible&&yh.nk++,this.alwaysVisible=e.alwaysVisible,this.rk=-1,this.hk=new C(0,0),this.ak=new C(0,0),this.lk=new C(0,0),this.ck=new C(0,0),this.uk=t=>{this.Tm(t)},this.fk=t=>{this.xm(t)},this.pk=t=>{this.Rm(t)},yh.Canvas.addEventListener("pointerdown",this.uk,!1),yh.Canvas.addEventListener("pointermove",this.fk,!1),yh.Canvas.addEventListener("pointerup",this.pk,!1),yh.Canvas.addEventListener("pointerout",this.pk,!1),yh.Canvas.addEventListener("contextmenu",(t=>{t.preventDefault()}),!1),requestAnimationFrame((()=>{this.mk()}))}static WV(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}}setJoystickSensibility(t){this.QV=t,this.ZV=1/(this.QV/1e3)}Tm(t){let i;t.preventDefault(),i=!0===this.$V?t.clientX<yh.ik:t.clientX>yh.ik,i&&this.rk<0?(this.rk=t.pointerId,this.vk?(this.lk=this.vk.clone(),this.hk=this.vk.clone(),this.ak=this.vk.clone(),this.xm(t)):(this.lk.x=t.clientX,this.lk.y=t.clientY,this.hk=this.lk.clone(),this.ak=this.lk.clone()),this.ck.x=0,this.ck.y=0,this.pressed=!0,this.qV.add(t.pointerId.toString(),t)):yh.YV<2&&this.gk&&(this.gk(),this.qV.add(t.pointerId.toString(),{x:t.clientX,y:t.clientY,prevX:t.clientX,prevY:t.clientY}))}xm(t){if(this.rk==t.pointerId){if(this.limitToContainer){const i=new C(t.clientX-this.lk.x,t.clientY-this.lk.y),e=i.length();e>this.containerSize&&i.scaleInPlace(this.containerSize/e),this.hk.x=this.lk.x+i.x,this.hk.y=this.lk.y+i.y}else this.hk.x=t.clientX,this.hk.y=t.clientY;this.ck=this.hk.clone(),this.ck=this.ck.subtract(this.lk),0<yh.nk&&(this.$V?this.hk.x=Math.min(yh.ik,this.hk.x):this.hk.x=Math.max(yh.ik,this.hk.x));const i=(this.reverseLeftRight?-1:1)*this.ck.x/this.ZV;switch(this.jV){case Eh.X:this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case Eh.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case Eh.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,i))}const e=(this.reverseUpDown?1:-1)*this.ck.y/this.ZV;switch(this.KV){case Eh.X:this.deltaPosition.x=Math.min(1,Math.max(-1,e));break;case Eh.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,e));break;case Eh.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,e))}}else{const i=this.qV.get(t.pointerId.toString());i&&(i.x=t.clientX,i.y=t.clientY)}}Rm(t){if(this.rk==t.pointerId)this.Sk(),this.rk=-1,this.pressed=!1;else{const i=this.qV.get(t.pointerId.toString());i&&yh.ek.clearRect(i.prevX-44,i.prevY-44,88,88)}this.ck.x=0,this.ck.y=0,this.qV.remove(t.pointerId.toString())}setJoystickColor(t){this.sk=t}set containerSize(t){this.Ek=t,this.Ak=~~(2.1*this.Ek),this.Ck=~~(this.Ak/2)}get containerSize(){return this.Ek}set puckSize(t){this.wk=t,this.xk=~~(2.1*this.wk),this.Tk=~~(this.xk/2)}get puckSize(){return this.wk}clearPosition(){this.alwaysVisible=!1,this.vk=null}set alwaysVisible(t){this.Rk!==t&&(t&&this.vk?(yh.nk++,this.Rk=!0):(yh.nk--,this.Rk=!1))}get alwaysVisible(){return this.Rk}setPosition(t,i){this.lk&&this.Sk(),this.vk=new C(t,i)}setActionOnTouch(t){this.gk=t}setAxisForLeftRight(t){switch(t){case Eh.X:case Eh.Y:case Eh.Z:this.jV=t;break;default:this.jV=Eh.X}}setAxisForUpDown(t){switch(t){case Eh.X:case Eh.Y:case Eh.Z:this.KV=t;break;default:this.KV=Eh.Y}}Sk(){const t=this.vk||this.lk;yh.ek.clearRect(t.x-this.Ck,t.y-this.Ck,this.Ak,this.Ak),yh.ek.clearRect(this.ak.x-this.Tk,this.ak.y-this.Tk,this.xk,this.xk)}setContainerImage(t){const i=new Image;i.src=t,i.onload=()=>this.Ik=i}setPuckImage(t){const i=new Image;i.src=t,i.onload=()=>this.Mk=i}bk(){const t=this.vk||this.lk;this.Sk(),this.Ik?yh.ek.drawImage(this.Ik,t.x-this.containerSize,t.y-this.containerSize,2*this.containerSize,2*this.containerSize):(yh.ek.beginPath(),yh.ek.strokeStyle=this.sk,yh.ek.lineWidth=2,yh.ek.arc(t.x,t.y,this.containerSize,0,2*Math.PI,!0),yh.ek.stroke(),yh.ek.closePath(),yh.ek.beginPath(),yh.ek.lineWidth=6,yh.ek.strokeStyle=this.sk,yh.ek.arc(t.x,t.y,this.puckSize,0,2*Math.PI,!0),yh.ek.stroke(),yh.ek.closePath())}_k(){this.Mk?yh.ek.drawImage(this.Mk,this.hk.x-this.puckSize,this.hk.y-this.puckSize,2*this.puckSize,2*this.puckSize):(yh.ek.beginPath(),yh.ek.strokeStyle=this.sk,yh.ek.lineWidth=2,yh.ek.arc(this.hk.x,this.hk.y,this.puckSize,0,2*Math.PI,!0),yh.ek.stroke(),yh.ek.closePath())}mk(){this.XV||(this.alwaysVisible&&this.bk(),this.pressed&&this.qV.forEach(((t,i)=>{i.pointerId===this.rk?(this.alwaysVisible||this.bk(),this._k(),this.ak=this.hk.clone()):(yh.ek.clearRect(i.prevX-44,i.prevY-44,88,88),yh.ek.beginPath(),yh.ek.fillStyle="white",yh.ek.beginPath(),yh.ek.strokeStyle="red",yh.ek.lineWidth=6,yh.ek.arc(i.x,i.y,40,0,2*Math.PI,!0),yh.ek.stroke(),yh.ek.closePath(),i.prevX=i.x,i.prevY=i.y)})),requestAnimationFrame((()=>{this.mk()})))}releaseCanvas(){yh.Canvas&&(yh.Canvas.removeEventListener("pointerdown",this.uk),yh.Canvas.removeEventListener("pointermove",this.fk),yh.Canvas.removeEventListener("pointerup",this.pk),yh.Canvas.removeEventListener("pointerout",this.pk),window.removeEventListener("resize",this.TM),document.body.removeChild(yh.Canvas),yh.Canvas=null),this.XV=!0}}yh.YV=0,yh.nk=0,Mh.prototype.addVirtualJoystick=function(){return this.add(new Nh),this};class Nh{getLeftJoystick(){return this.yk}getRightJoystick(){return this.Nk}checkInputs(){if(this.yk){const t=this.camera,i=50*t.jU(),e=R.RotationYawPitchRoll(t.rotation.y,t.rotation.x,0),s=w.TransformCoordinates(new w(this.yk.deltaPosition.x*i,this.yk.deltaPosition.y*i,this.yk.deltaPosition.z*i),e);t.cameraDirection=t.cameraDirection.add(s),t.cameraRotation=t.cameraRotation.addVector3(this.Nk.deltaPosition),this.yk.pressed||(this.yk.deltaPosition=this.yk.deltaPosition.scale(.9)),this.Nk.pressed||(this.Nk.deltaPosition=this.Nk.deltaPosition.scale(.9))}}attachControl(){this.yk=new yh(!0),this.yk.setAxisForUpDown(Eh.Z),this.yk.setAxisForLeftRight(Eh.X),this.yk.setJoystickSensibility(.15),this.Nk=new yh(!1),this.Nk.setAxisForUpDown(Eh.X),this.Nk.setAxisForLeftRight(Eh.Y),this.Nk.reverseUpDown=!0,this.Nk.setJoystickSensibility(.05),this.Nk.setJoystickColor("yellow")}detachControl(){this.yk.releaseCanvas(),this.Nk.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}ih.FreeCameraVirtualJoystickInput=Nh;class Ph extends hs{constructor(t,i,e,s=!0){super(t,i,e,s),this.Pk=w.Zero(),this.Dk=w.Zero(),this.cameraDirection=new w(0,0,0),this.cameraRotation=new C(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this.Lk=new T,this.rotation=new w(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this.Ok=w.Zero(),this.Fk=1,this.Bg=R.Zero(),this.Bk=R.Zero(),this.KU=R.Zero(),this.bV=R.Zero(),this.Uk=new w(0,0,1),this.Vk=w.Zero(),this.kk=w.Up(),this.Gk=0,this.zk=0}getFrontPosition(t){this.getWorldMatrix();const i=this.getTarget().subtract(this.position);return i.normalize(),i.scaleInPlace(t),this.globalPosition.add(i)}Hk(){return this.lockedTarget?(this.lockedTarget.absolutePosition&&this.lockedTarget.computeWorldMatrix(),this.lockedTarget.absolutePosition||this.lockedTarget):null}storeState(){return this.Xk=this.position.clone(),this.Wk=this.rotation.clone(),this.rotationQuaternion&&(this.$k=this.rotationQuaternion.clone()),super.storeState()}wA(){return!!super.wA()&&(this.position=this.Xk.clone(),this.rotation=this.Wk.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this.$k.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0)}Fi(){super.Fi(),this.Ii.lockedTarget=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.Ii.rotation=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.Ii.rotationQuaternion=new T(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}Hi(t){t||super.Hi();const i=this.Hk();i?this.Ii.lockedTarget?this.Ii.lockedTarget.copyFrom(i):this.Ii.lockedTarget=i.clone():this.Ii.lockedTarget=null,this.Ii.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this.Ii.rotationQuaternion.copyFrom(this.rotationQuaternion)}xA(){if(!super.xA())return!1;const t=this.Hk();return(this.Ii.lockedTarget?this.Ii.lockedTarget.equals(t):!t)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this.Ii.rotationQuaternion):this.Ii.rotation.equals(this.rotation))}jU(){const t=this.getEngine();return this.speed*Math.sqrt(t.getDeltaTime()/(100*t.getFps()))}setTarget(t){this.upVector.normalize(),this.Fk=t.subtract(this.position).length(),this.position.z===t.z&&(this.position.z+=u),this.Uk.normalize().scaleInPlace(this.Fk),R.LookAtLHToRef(this.position,t,this.kk,this.Bk),this.Bk.invert(),this.rotation.x=Math.atan(this.Bk.m[6]/this.Bk.m[10]);const i=t.subtract(this.position);i.x>=0?this.rotation.y=-Math.atan(i.z/i.x)+Math.PI/2:this.rotation.y=-Math.atan(i.z/i.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&T.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(t){this.setTarget(t)}getTarget(){return this.Ok}Yk(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}jk(){if(this.parent)return this.parent.getWorldMatrix().invertToRef(M.Matrix[0]),w.TransformNormalToRef(this.cameraDirection,M.Matrix[0],M.Vector3[0]),void this.position.addInPlace(M.Vector3[0]);this.position.addInPlace(this.cameraDirection)}RA(){const t=this.invertRotation?-this.inverseRotationSpeed:1,i=this.Yk(),e=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;if(i&&this.jk(),e){if(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this.rotation),this.rotation.x+=this.cameraRotation.x*t,this.rotation.y+=this.cameraRotation.y*t,!this.noRotationConstraint){const t=1.570796;this.rotation.x>t&&(this.rotation.x=t),this.rotation.x<-t&&(this.rotation.x=-t)}if(this.rotationQuaternion){this.rotation.lengthSquared()&&T.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}}i&&(Math.abs(this.cameraDirection.x)<this.speed*u&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*u&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*u&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),e&&(Math.abs(this.cameraRotation.x)<this.speed*u&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*u&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super.RA()}OA(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this.bV):R.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.bV)}Kk(){return w.TransformNormalToRef(this.kk,this.bV,this.upVector),this}yA(){return this.lockedTarget&&this.setTarget(this.Hk()),this.OA(),this.rotationQuaternion&&this.zk!=this.rotationQuaternion.z?(this.Kk(),this.zk=this.rotationQuaternion.z):this.Gk!==this.rotation.z&&(this.Kk(),this.Gk=this.rotation.z),w.TransformCoordinatesToRef(this.Uk,this.bV,this.Vk),this.position.addToRef(this.Vk,this.Ok),this.updateUpVectorFromRotation&&(this.rotationQuaternion?Ge.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(T.FromEulerVectorToRef(this.rotation,this.Lk),Ge.Y.rotateByQuaternionToRef(this.Lk,this.upVector))),this.qk(this.position,this.Ok,this.upVector),this.Bg}qk(t,i,e){if(this.ignoreParentScaling){if(this.parent){const s=this.parent.getWorldMatrix();w.TransformCoordinatesToRef(t,s,this.dA),w.TransformCoordinatesToRef(i,s,this.Dk),w.TransformNormalToRef(e,s,this.Pk),this.$i()}else this.dA.copyFrom(t),this.Dk.copyFrom(i),this.Pk.copyFrom(e);this.getScene().useRightHandedSystem?R.LookAtRHToRef(this.dA,this.Dk,this.Pk,this.Bg):R.LookAtLHToRef(this.dA,this.Dk,this.Pk,this.Bg)}else if(this.getScene().useRightHandedSystem?R.LookAtRHToRef(t,i,e,this.Bg):R.LookAtLHToRef(t,i,e,this.Bg),this.parent){const t=this.parent.getWorldMatrix();this.Bg.invert(),this.Bg.multiplyToRef(t,this.Bg),this.Bg.getTranslationToRef(this.dA),this.Bg.invert(),this.$i()}else this.dA.copyFrom(t)}createRigCamera(t,i){if(this.cameraRigMode!==hs.RIG_MODE_NONE){const i=new Ph(t,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,this.cameraRigMode!==hs.RIG_MODE_VR&&this.cameraRigMode!==hs.RIG_MODE_WEBVR||(this.rotationQuaternion||(this.rotationQuaternion=new T),i.NA={},i.rotationQuaternion=new T),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}IA(){const t=this.uS[0],i=this.uS[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case hs.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case hs.RIG_MODE_STEREOSCOPIC_OVERUNDER:case hs.RIG_MODE_STEREOSCOPIC_INTERLACED:{const e=this.cameraRigMode===hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,s=this.cameraRigMode===hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this.Qk(this.NA.stereoHalfAngle*e,t),this.Qk(this.NA.stereoHalfAngle*s,i);break}case hs.RIG_MODE_VR:t.rotationQuaternion?(t.rotationQuaternion.copyFrom(this.rotationQuaternion),i.rotationQuaternion.copyFrom(this.rotationQuaternion)):(t.rotation.copyFrom(this.rotation),i.rotation.copyFrom(this.rotation)),t.position.copyFrom(this.position),i.position.copyFrom(this.position)}super.IA()}Qk(t,i){this.getTarget().subtractToRef(this.position,Ph.Zk),Ph.Zk.normalize().scaleInPlace(this.Fk);const e=Ph.Zk.addInPlace(this.position);R.TranslationToRef(-e.x,-e.y,-e.z,Ph.Jk),Ph.Jk.multiplyToRef(R.RotationAxis(i.upVector,t),Ph.tG),R.TranslationToRef(e.x,e.y,e.z,Ph.Jk),Ph.tG.multiplyToRef(Ph.Jk,Ph.tG),w.TransformCoordinatesToRef(this.position,Ph.tG,i.position),i.setTarget(e)}getClassName(){return"TargetCamera"}}Ph.tG=new R,Ph.Jk=new R,Ph.Zk=new w,ut([et()],Ph.prototype,"rotation",void 0),ut([Q()],Ph.prototype,"speed",void 0),ut([st("lockedTargetId")],Ph.prototype,"lockedTarget",void 0);class Dh extends Ph{constructor(t,i,e,s=!0){super(t,i,e,s),this.ellipsoid=new w(.5,1,.5),this.ellipsoidOffset=new w(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.iG=!1,this.eG=w.Zero(),this.sG=w.Zero(),this.nG=w.Zero(),this.sT=-1,this.UT=(t,i,e=null)=>{(t=>{this.nG.copyFrom(t),this.nG.subtractToRef(this.eG,this.sG),this.sG.length()>Rs.CollisionsEpsilon&&(this.position.addInPlace(this.sG),this.onCollide&&e&&this.onCollide(e))})(i)},this.inputs=new Mh(this),this.inputs.addKeyboard().addMouse()}get angularSensibility(){const t=this.inputs.attached.mouse;return t?t.angularSensibility:0}set angularSensibility(t){const i=this.inputs.attached.mouse;i&&(i.angularSensibility=t)}get keysUp(){const t=this.inputs.attached.keyboard;return t?t.keysUp:[]}set keysUp(t){const i=this.inputs.attached.keyboard;i&&(i.keysUp=t)}get keysUpward(){const t=this.inputs.attached.keyboard;return t?t.keysUpward:[]}set keysUpward(t){const i=this.inputs.attached.keyboard;i&&(i.keysUpward=t)}get keysDown(){const t=this.inputs.attached.keyboard;return t?t.keysDown:[]}set keysDown(t){const i=this.inputs.attached.keyboard;i&&(i.keysDown=t)}get keysDownward(){const t=this.inputs.attached.keyboard;return t?t.keysDownward:[]}set keysDownward(t){const i=this.inputs.attached.keyboard;i&&(i.keysDownward=t)}get keysLeft(){const t=this.inputs.attached.keyboard;return t?t.keysLeft:[]}set keysLeft(t){const i=this.inputs.attached.keyboard;i&&(i.keysLeft=t)}get keysRight(){const t=this.inputs.attached.keyboard;return t?t.keysRight:[]}set keysRight(t){const i=this.inputs.attached.keyboard;i&&(i.keysRight=t)}get keysRotateLeft(){const t=this.inputs.attached.keyboard;return t?t.keysRotateLeft:[]}set keysRotateLeft(t){const i=this.inputs.attached.keyboard;i&&(i.keysRotateLeft=t)}get keysRotateRight(){const t=this.inputs.attached.keyboard;return t?t.keysRotateRight:[]}set keysRotateRight(t){const i=this.inputs.attached.keyboard;i&&(i.keysRotateRight=t)}attachControl(t,i){i=ki.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(i)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new w(0,0,0),this.cameraRotation=new C(0,0)}get collisionMask(){return this.sT}set collisionMask(t){this.sT=isNaN(t)?-1:t}rG(t){let i;i=this.parent?w.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,i.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this.eG),this.eG.addInPlace(this.ellipsoidOffset);const e=this.getScene().collisionCoordinator;this.hT||(this.hT=e.createCollider()),this.hT.eR=this.ellipsoid,this.hT.collisionMask=this.sT;let s=t;this.applyGravity&&(s=t.add(this.getScene().gravity)),e.getNewPosition(this.eG,s,this.hT,3,null,this.UT,this.uniqueId)}RA(){this.GM||(this.GM=w.Zero(),this.qU=w.Zero()),this.inputs.checkInputs(),super.RA()}Yk(){return this.iG||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}jk(){this.checkCollisions&&this.getScene().collisionsEnabled?this.rG(this.cameraDirection):super.jk()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}ut([et()],Dh.prototype,"ellipsoid",void 0),ut([et()],Dh.prototype,"ellipsoidOffset",void 0),ut([Q()],Dh.prototype,"checkCollisions",void 0),ut([Q()],Dh.prototype,"applyGravity",void 0),dt.AddNodeConstructor("TouchCamera",((t,i)=>()=>new Lh(t,w.Zero(),i)));class Lh extends Dh{get touchAngularSensibility(){const t=this.inputs.attached.touch;return t?t.touchAngularSensibility:0}set touchAngularSensibility(t){const i=this.inputs.attached.touch;i&&(i.touchAngularSensibility=t)}get touchMoveSensibility(){const t=this.inputs.attached.touch;return t?t.touchMoveSensibility:0}set touchMoveSensibility(t){const i=this.inputs.attached.touch;i&&(i.touchMoveSensibility=t)}constructor(t,i,e){super(t,i,e),this.inputs.addTouch(),this.VA()}getClassName(){return"TouchCamera"}VA(){const t=this.inputs.attached.touch,i=this.inputs.attached.mouse;i?i.touchEnabled=!1:t.allowMouse=!0}}dt.AddNodeConstructor("ArcRotateCamera",((t,i)=>()=>new Oh(t,0,0,1,w.Zero(),i)));class Oh extends Ph{constructor(t,i,e,s,n,r,o=!0){super(t,w.Zero(),r,o),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=w.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=C.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this.Bg=new R,this.panningAxis=new w(1,1,0),this.qU=new w,this.mapPanning=!1,this.onMeshTargetChangedObservable=new h,this.checkCollisions=!1,this.collisionRadius=new w(.5,.5,.5),this.QU=w.Zero(),this.hG=w.Zero(),this.nG=w.Zero(),this.oG=w.Zero(),this.UT=(t,i,e=null)=>{e?(this.setPosition(i),this.onCollide&&this.onCollide(e)):this.QU.copyFrom(this.rA);const s=Math.cos(this.alpha),n=Math.sin(this.alpha),r=Math.cos(this.beta);let h=Math.sin(this.beta);0===h&&(h=1e-4);const o=this.aG();this.oG.copyFromFloats(this.radius*s*h,this.radius*r,this.radius*n*h),o.addToRef(this.oG,this.nG),this.rA.copyFrom(this.nG);let a=this.upVector;this.allowUpsideDown&&this.beta<0&&(a=a.clone(),a=a.negate()),this.qk(this.rA,o,a),this.Bg.addAtIndex(12,this.targetScreenOffset.x),this.Bg.addAtIndex(13,this.targetScreenOffset.y),this.lG=!1},this.Pt=w.Zero(),n&&this.setTarget(n),this.alpha=i,this.beta=e,this.radius=s,this.getViewMatrix(),this.inputs=new lh(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}get target(){return this.Pt}set target(t){this.setTarget(t)}get targetHost(){return this.cG}set targetHost(t){t&&this.setTarget(t)}getTarget(){return this.target}get position(){return this.rA}set position(t){this.setPosition(t)}set upVector(t){this.uG||(this.fG=new R,this.uG=new R,this.hA=w.Zero()),t.normalize(),this.hA.copyFrom(t),this.setMatUp()}get upVector(){return this.hA}setMatUp(){R.RotationAlignToRef(w.UpReadOnly,this.hA,this.fG),R.RotationAlignToRef(this.hA,w.UpReadOnly,this.uG)}get angularSensibilityX(){const t=this.inputs.attached.pointers;return t?t.angularSensibilityX:0}set angularSensibilityX(t){const i=this.inputs.attached.pointers;i&&(i.angularSensibilityX=t)}get angularSensibilityY(){const t=this.inputs.attached.pointers;return t?t.angularSensibilityY:0}set angularSensibilityY(t){const i=this.inputs.attached.pointers;i&&(i.angularSensibilityY=t)}get pinchPrecision(){const t=this.inputs.attached.pointers;return t?t.pinchPrecision:0}set pinchPrecision(t){const i=this.inputs.attached.pointers;i&&(i.pinchPrecision=t)}get pinchDeltaPercentage(){const t=this.inputs.attached.pointers;return t?t.pinchDeltaPercentage:0}set pinchDeltaPercentage(t){const i=this.inputs.attached.pointers;i&&(i.pinchDeltaPercentage=t)}get useNaturalPinchZoom(){const t=this.inputs.attached.pointers;return!!t&&t.useNaturalPinchZoom}set useNaturalPinchZoom(t){const i=this.inputs.attached.pointers;i&&(i.useNaturalPinchZoom=t)}get panningSensibility(){const t=this.inputs.attached.pointers;return t?t.panningSensibility:0}set panningSensibility(t){const i=this.inputs.attached.pointers;i&&(i.panningSensibility=t)}get keysUp(){const t=this.inputs.attached.keyboard;return t?t.keysUp:[]}set keysUp(t){const i=this.inputs.attached.keyboard;i&&(i.keysUp=t)}get keysDown(){const t=this.inputs.attached.keyboard;return t?t.keysDown:[]}set keysDown(t){const i=this.inputs.attached.keyboard;i&&(i.keysDown=t)}get keysLeft(){const t=this.inputs.attached.keyboard;return t?t.keysLeft:[]}set keysLeft(t){const i=this.inputs.attached.keyboard;i&&(i.keysLeft=t)}get keysRight(){const t=this.inputs.attached.keyboard;return t?t.keysRight:[]}set keysRight(t){const i=this.inputs.attached.keyboard;i&&(i.keysRight=t)}get wheelPrecision(){const t=this.inputs.attached.mousewheel;return t?t.wheelPrecision:0}set wheelPrecision(t){const i=this.inputs.attached.mousewheel;i&&(i.wheelPrecision=t)}get zoomToMouseLocation(){const t=this.inputs.attached.mousewheel;return!!t&&t.zoomToMouseLocation}set zoomToMouseLocation(t){const i=this.inputs.attached.mousewheel;i&&(i.zoomToMouseLocation=t)}get wheelDeltaPercentage(){const t=this.inputs.attached.mousewheel;return t?t.wheelDeltaPercentage:0}set wheelDeltaPercentage(t){const i=this.inputs.attached.mousewheel;i&&(i.wheelDeltaPercentage=t)}get bouncingBehavior(){return this.dG}get useBouncingBehavior(){return null!=this.dG}set useBouncingBehavior(t){t!==this.useBouncingBehavior&&(t?(this.dG=new pn,this.addBehavior(this.dG)):this.dG&&(this.removeBehavior(this.dG),this.dG=null))}get framingBehavior(){return this.pG}get useFramingBehavior(){return null!=this.pG}set useFramingBehavior(t){t!==this.useFramingBehavior&&(t?(this.pG=new mn,this.addBehavior(this.pG)):this.pG&&(this.removeBehavior(this.pG),this.pG=null))}get autoRotationBehavior(){return this.mG}get useAutoRotationBehavior(){return null!=this.mG}set useAutoRotationBehavior(t){t!==this.useAutoRotationBehavior&&(t?(this.mG=new dn,this.addBehavior(this.mG)):this.mG&&(this.removeBehavior(this.mG),this.mG=null))}Fi(){super.Fi(),this.Ii.Pt=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.Ii.alpha=void 0,this.Ii.beta=void 0,this.Ii.radius=void 0,this.Ii.targetScreenOffset=C.Zero()}Hi(t){t||super.Hi(),this.Ii.Pt.copyFrom(this.aG()),this.Ii.alpha=this.alpha,this.Ii.beta=this.beta,this.Ii.radius=this.radius,this.Ii.targetScreenOffset.copyFrom(this.targetScreenOffset)}aG(){if(this.cG&&this.cG.getAbsolutePosition){const t=this.cG.getAbsolutePosition();this.vG?t.addToRef(this.vG,this.Pt):this.Pt.copyFrom(t)}const t=this.Hk();return t||this.Pt}storeState(){return this.gG=this.alpha,this.SG=this.beta,this.EG=this.radius,this.AG=this.aG().clone(),this.CG=this.targetScreenOffset.clone(),super.storeState()}wA(){return!!super.wA()&&(this.setTarget(this.AG.clone()),this.alpha=this.gG,this.beta=this.SG,this.radius=this.EG,this.targetScreenOffset=this.CG.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0)}xA(){return!!super.xA()&&(this.Ii.Pt.equals(this.aG())&&this.Ii.alpha===this.alpha&&this.Ii.beta===this.beta&&this.Ii.radius===this.radius&&this.Ii.targetScreenOffset.equals(this.targetScreenOffset))}attachControl(t,i,e=!0,s=2){const n=arguments;i=ki.BackCompatCameraNoPreventDefault(n),this.CN=e,this.wN=s,"boolean"==typeof n[0]&&(n.length>1&&(this.CN=n[1]),n.length>2&&(this.wN=n[2])),this.inputs.attachElement(i),this.HL=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this.HL&&this.HL()}RA(){if(!this.lG){if(this.inputs.checkInputs(),0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset){const t=this.invertRotation?-1:1;let i=this.inertialAlphaOffset;this.beta<=0&&(i*=-1),this.getScene().useRightHandedSystem&&(i*=-1),this.parent&&this.parent.zi()<0&&(i*=-1),this.alpha+=i*t,this.beta+=this.inertialBetaOffset*t,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<u&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<u&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*u&&(this.inertialRadiusOffset=0)}if(0!==this.inertialPanningX||0!==this.inertialPanningY){const t=new w(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this.Bg.invertToRef(this.KU),t.multiplyInPlace(this.panningAxis),w.TransformNormalToRef(t,this.KU,this.qU),!this.mapPanning&&this.panningAxis.y||(this.qU.y=0),!this.cG)if(this.panningDistanceLimit){this.qU.addInPlace(this.Pt);w.DistanceSquared(this.qU,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this.Pt.copyFrom(this.qU)}else this.Pt.addInPlace(this.qU);this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*u&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*u&&(this.inertialPanningY=0)}this.wG(),super.RA()}}wG(){null===this.lowerBetaLimit||void 0===this.lowerBetaLimit?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),null===this.upperBetaLimit||void 0===this.upperBetaLimit?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),null!==this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),null!==this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this.rA.subtractToRef(this.aG(),this.oG),0===this.hA.x&&1===this.hA.y&&0===this.hA.z||w.TransformCoordinatesToRef(this.oG,this.uG,this.oG),this.radius=this.oG.length(),0===this.radius&&(this.radius=1e-4);const t=this.alpha;0===this.oG.x&&0===this.oG.z?this.alpha=Math.PI/2:this.alpha=Math.acos(this.oG.x/Math.sqrt(Math.pow(this.oG.x,2)+Math.pow(this.oG.z,2))),this.oG.z<0&&(this.alpha=2*Math.PI-this.alpha);const i=Math.round((t-this.alpha)/(2*Math.PI));this.alpha+=2*i*Math.PI,this.beta=Math.acos(this.oG.y/this.radius),this.wG()}setPosition(t){this.rA.equals(t)||(this.rA.copyFrom(t),this.rebuildAnglesAndRadius())}setTarget(t,i=!1,e=!1,s=!1){var n;if(s=null!==(n=this.overrideCloneAlphaBetaRadius)&&void 0!==n?n:s,t.getBoundingInfo)this.vG=i?t.getBoundingInfo().boundingBox.centerWorld.clone():null,t.computeWorldMatrix(),this.cG=t,this.Pt=this.aG(),this.onMeshTargetChangedObservable.notifyObservers(this.cG);else{const i=t,s=this.aG();if(s&&!e&&s.equals(i))return;this.cG=null,this.Pt=i,this.vG=null,this.onMeshTargetChangedObservable.notifyObservers(null)}s||this.rebuildAnglesAndRadius()}yA(){const t=Math.cos(this.alpha),i=Math.sin(this.alpha),e=Math.cos(this.beta);let s=Math.sin(this.beta);0===s&&(s=1e-4),0===this.radius&&(this.radius=1e-4);const n=this.aG();if(this.oG.copyFromFloats(this.radius*t*s,this.radius*e,this.radius*i*s),0===this.hA.x&&1===this.hA.y&&0===this.hA.z||w.TransformCoordinatesToRef(this.oG,this.fG,this.oG),n.addToRef(this.oG,this.nG),this.getScene().collisionsEnabled&&this.checkCollisions){const t=this.getScene().collisionCoordinator;this.hT||(this.hT=t.createCollider()),this.hT.eR=this.collisionRadius,this.nG.subtractToRef(this.rA,this.hG),this.lG=!0,t.getNewPosition(this.rA,this.hG,this.hT,3,null,this.UT,this.uniqueId)}else{this.rA.copyFrom(this.nG);let t=this.upVector;this.allowUpsideDown&&s<0&&(t=t.negate()),this.qk(this.rA,n,t),this.Bg.addAtIndex(12,this.targetScreenOffset.x),this.Bg.addAtIndex(13,this.targetScreenOffset.y)}return this.Ok=n,this.Bg}zoomOn(t,i=!1){t=t||this.getScene().meshes;const e=Ys.MinMax(t),s=w.Distance(e.min,e.max);this.radius=s*this.zoomOnFactor,this.focusOn({min:e.min,max:e.max,distance:s},i)}focusOn(t,i=!1){let e,s;if(void 0===t.min){const i=t||this.getScene().meshes;e=Ys.MinMax(i),s=w.Distance(e.min,e.max)}else{e=t,s=t.distance}this.Pt=Ys.Center(e),i||(this.maxZ=2*s)}createRigCamera(t,i){let e=0;switch(this.cameraRigMode){case hs.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case hs.RIG_MODE_STEREOSCOPIC_OVERUNDER:case hs.RIG_MODE_STEREOSCOPIC_INTERLACED:case hs.RIG_MODE_VR:e=this.NA.stereoHalfAngle*(0===i?1:-1);break;case hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e=this.NA.stereoHalfAngle*(0===i?-1:1)}const s=new Oh(t,this.alpha+e,this.beta,this.radius,this.Pt,this.getScene());return s.NA={},s.isRigCamera=!0,s.rigParent=this,s.upVector=this.upVector,s.mode=this.mode,s.orthoLeft=this.orthoLeft,s.orthoRight=this.orthoRight,s.orthoBottom=this.orthoBottom,s.orthoTop=this.orthoTop,s}IA(){const t=this.uS[0],i=this.uS[1];switch(t.beta=i.beta=this.beta,this.cameraRigMode){case hs.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case hs.RIG_MODE_STEREOSCOPIC_OVERUNDER:case hs.RIG_MODE_STEREOSCOPIC_INTERLACED:case hs.RIG_MODE_VR:t.alpha=this.alpha-this.NA.stereoHalfAngle,i.alpha=this.alpha+this.NA.stereoHalfAngle;break;case hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:t.alpha=this.alpha+this.NA.stereoHalfAngle,i.alpha=this.alpha-this.NA.stereoHalfAngle}super.IA()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}ut([Q()],Oh.prototype,"alpha",void 0),ut([Q()],Oh.prototype,"beta",void 0),ut([Q()],Oh.prototype,"radius",void 0),ut([Q()],Oh.prototype,"overrideCloneAlphaBetaRadius",void 0),ut([et("target")],Oh.prototype,"_target",void 0),ut([st("targetHost")],Oh.prototype,"_targetHost",void 0),ut([Q()],Oh.prototype,"inertialAlphaOffset",void 0),ut([Q()],Oh.prototype,"inertialBetaOffset",void 0),ut([Q()],Oh.prototype,"inertialRadiusOffset",void 0),ut([Q()],Oh.prototype,"lowerAlphaLimit",void 0),ut([Q()],Oh.prototype,"upperAlphaLimit",void 0),ut([Q()],Oh.prototype,"lowerBetaLimit",void 0),ut([Q()],Oh.prototype,"upperBetaLimit",void 0),ut([Q()],Oh.prototype,"lowerRadiusLimit",void 0),ut([Q()],Oh.prototype,"upperRadiusLimit",void 0),ut([Q()],Oh.prototype,"inertialPanningX",void 0),ut([Q()],Oh.prototype,"inertialPanningY",void 0),ut([Q()],Oh.prototype,"pinchToPanMaxDistance",void 0),ut([Q()],Oh.prototype,"panningDistanceLimit",void 0),ut([et()],Oh.prototype,"panningOriginTarget",void 0),ut([Q()],Oh.prototype,"panningInertia",void 0),ut([Q()],Oh.prototype,"zoomToMouseLocation",null),ut([Q()],Oh.prototype,"zoomOnFactor",void 0),ut([it()],Oh.prototype,"targetScreenOffset",void 0),ut([Q()],Oh.prototype,"allowUpsideDown",void 0),ut([Q()],Oh.prototype,"useInputToRestoreState",void 0),dt.AddNodeConstructor("DeviceOrientationCamera",((t,i)=>()=>new Fh(t,w.Zero(),i)));class Fh extends Dh{constructor(t,i,e){super(t,i,e),this.xG=new T,this.TG=!0,this.IG=0,this.MG=new T,this.inputs.addDeviceOrientation(),this.inputs.NV&&this.inputs.NV.OV.addOnce((()=>{this.TG&&this.inputs._V&&(this.inputs._V.uV=!1,this.inputs._V.onPointerMovedObservable.add((t=>{0!=this.IG&&(this.bG||(this.bG=new T),T.FromEulerAnglesToRef(0,t.offsetX*this.IG,0,this.xG),this.bG.multiplyToRef(this.xG,this.bG))})))}))}get disablePointerInputWhenUsingDeviceOrientation(){return this.TG}set disablePointerInputWhenUsingDeviceOrientation(t){this.TG=t}enableHorizontalDragging(t=1/300){this.IG=t}getClassName(){return"DeviceOrientationCamera"}RA(){super.RA(),this.MG.copyFrom(this.rotationQuaternion),this.bG&&this.bG.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(t=Ge.Y){this.rotationQuaternion&&(this.bG||(this.bG=new T),this.bG.copyFrom(this.MG||this.rotationQuaternion),["x","y","z"].forEach((i=>{t[i]?this.bG[i]*=-1:this.bG[i]=0})),this.bG.normalize(),this.bG.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class Bh extends eh{constructor(t){super(t)}addKeyboard(){return this.add(new uh),this}addMouse(){return this.add(new fh),this}}class Uh extends Ph{constructor(t,i,e,s=!0){super(t,i,e,s),this.ellipsoid=new w(1,1,1),this.ellipsoidOffset=new w(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=w.Zero(),this.sV=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this.iG=!1,this.eG=w.Zero(),this.sG=w.Zero(),this.nG=w.Zero(),this.sT=-1,this.UT=(t,i,e=null)=>{(t=>{this.nG.copyFrom(t),this.nG.subtractToRef(this.eG,this.sG),this.sG.length()>Rs.CollisionsEpsilon&&(this.position.addInPlace(this.sG),this.onCollide&&e&&this.onCollide(e))})(i)},this.inputs=new Bh(this),this.inputs.addKeyboard().addMouse()}get angularSensibility(){const t=this.inputs.attached.mouse;return t?t.angularSensibility:0}set angularSensibility(t){const i=this.inputs.attached.mouse;i&&(i.angularSensibility=t)}get keysForward(){const t=this.inputs.attached.keyboard;return t?t.keysForward:[]}set keysForward(t){const i=this.inputs.attached.keyboard;i&&(i.keysForward=t)}get keysBackward(){const t=this.inputs.attached.keyboard;return t?t.keysBackward:[]}set keysBackward(t){const i=this.inputs.attached.keyboard;i&&(i.keysBackward=t)}get keysUp(){const t=this.inputs.attached.keyboard;return t?t.keysUp:[]}set keysUp(t){const i=this.inputs.attached.keyboard;i&&(i.keysUp=t)}get keysDown(){const t=this.inputs.attached.keyboard;return t?t.keysDown:[]}set keysDown(t){const i=this.inputs.attached.keyboard;i&&(i.keysDown=t)}get keysLeft(){const t=this.inputs.attached.keyboard;return t?t.keysLeft:[]}set keysLeft(t){const i=this.inputs.attached.keyboard;i&&(i.keysLeft=t)}get keysRight(){const t=this.inputs.attached.keyboard;return t?t.keysRight:[]}set keysRight(t){const i=this.inputs.attached.keyboard;i&&(i.keysRight=t)}attachControl(t,i){i=ki.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(i)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new w(0,0,0)}get collisionMask(){return this.sT}set collisionMask(t){this.sT=isNaN(t)?-1:t}rG(t){let i;i=this.parent?w.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,i.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this.eG),this.eG.addInPlace(this.ellipsoidOffset);const e=this.getScene().collisionCoordinator;this.hT||(this.hT=e.createCollider()),this.hT.eR=this.ellipsoid,this.hT.collisionMask=this.sT;let s=t;this.applyGravity&&(s=t.add(this.getScene().gravity)),e.getNewPosition(this.eG,s,this.hT,3,null,this.UT,this.uniqueId)}RA(){this.GM||(this.GM=w.Zero(),this.qU=w.Zero()),this.inputs.checkInputs(),super.RA()}Yk(){return this.iG||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}jk(){this.checkCollisions&&this.getScene().collisionsEnabled?this.rG(this.cameraDirection):super.jk()}restoreRoll(t){const i=this.sV,e=i-this.rotation.z;Math.abs(e)>=.001&&(this.rotation.z+=e/t,Math.abs(i-this.rotation.z)<=.001&&(this.rotation.z=i))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}}ut([et()],Uh.prototype,"ellipsoid",void 0),ut([et()],Uh.prototype,"ellipsoidOffset",void 0),ut([Q()],Uh.prototype,"checkCollisions",void 0),ut([Q()],Uh.prototype,"applyGravity",void 0);class Vh extends eh{constructor(t){super(t)}addKeyboard(){return this.add(new dh),this}addMouseWheel(){return this.add(new ph),this}addPointers(){return this.add(new mh),this}addVRDeviceOrientation(){return console.warn("DeviceOrientation support not yet implemented for FollowCamera."),this}}dt.AddNodeConstructor("FollowCamera",((t,i)=>()=>new kh(t,w.Zero(),i))),dt.AddNodeConstructor("ArcFollowCamera",((t,i)=>()=>new Gh(t,0,0,1,null,i)));class kh extends Ph{constructor(t,i,e,s=null){super(t,i,e),this.radius=12,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.rotationOffset=0,this.lowerRotationOffsetLimit=null,this.upperRotationOffsetLimit=null,this.heightOffset=4,this.lowerHeightOffsetLimit=null,this.upperHeightOffsetLimit=null,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=s,this.inputs=new Vh(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_G(t){if(!t)return;const i=M.Matrix[0];t.absoluteRotationQuaternion.toRotationMatrix(i);const e=Math.atan2(i.m[8],i.m[10]),s=ki.ToRadians(this.rotationOffset)+e,n=t.getAbsolutePosition(),r=n.x+Math.sin(s)*this.radius,h=n.z+Math.cos(s)*this.radius,o=r-this.position.x,a=n.y+this.heightOffset-this.position.y,l=h-this.position.z;let c=o*this.cameraAcceleration*2,u=a*this.cameraAcceleration,f=l*this.cameraAcceleration*2;(c>this.maxCameraSpeed||c<-this.maxCameraSpeed)&&(c=c<1?-this.maxCameraSpeed:this.maxCameraSpeed),(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=u<1?-this.maxCameraSpeed:this.maxCameraSpeed),(f>this.maxCameraSpeed||f<-this.maxCameraSpeed)&&(f=f<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new w(this.position.x+c,this.position.y+u,this.position.z+f),this.setTarget(n)}attachControl(t,i){i=ki.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(i),this.HL=()=>{}}detachControl(){this.inputs.detachElement(),this.HL&&this.HL()}RA(){this.inputs.checkInputs(),this.wG(),super.RA(),this.lockedTarget&&this._G(this.lockedTarget)}wG(){null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),null!==this.lowerHeightOffsetLimit&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),null!==this.upperHeightOffsetLimit&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),null!==this.lowerRotationOffsetLimit&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),null!==this.upperRotationOffsetLimit&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)}getClassName(){return"FollowCamera"}}ut([Q()],kh.prototype,"radius",void 0),ut([Q()],kh.prototype,"lowerRadiusLimit",void 0),ut([Q()],kh.prototype,"upperRadiusLimit",void 0),ut([Q()],kh.prototype,"rotationOffset",void 0),ut([Q()],kh.prototype,"lowerRotationOffsetLimit",void 0),ut([Q()],kh.prototype,"upperRotationOffsetLimit",void 0),ut([Q()],kh.prototype,"heightOffset",void 0),ut([Q()],kh.prototype,"lowerHeightOffsetLimit",void 0),ut([Q()],kh.prototype,"upperHeightOffsetLimit",void 0),ut([Q()],kh.prototype,"cameraAcceleration",void 0),ut([Q()],kh.prototype,"maxCameraSpeed",void 0),ut([st("lockedTargetId")],kh.prototype,"lockedTarget",void 0);class Gh extends Ph{constructor(t,i,e,s,n,r){super(t,w.Zero(),r),this.alpha=i,this.beta=e,this.radius=s,this.yG=w.Zero(),this.setMeshTarget(n)}setMeshTarget(t){this.NG=t,this._G()}_G(){if(!this.NG)return;this.yG.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this.yG.y=this.radius*Math.sin(this.beta),this.yG.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);const t=this.NG.getAbsolutePosition();this.position=t.add(this.yG),this.setTarget(t)}RA(){super.RA(),this._G()}getClassName(){return"ArcFollowCamera"}}!function(t){t[t.VIVE=0]="VIVE",t[t.OCULUS=1]="OCULUS",t[t.WINDOWS=2]="WINDOWS",t[t.GEAR_VR=3]="GEAR_VR",t[t.DAYDREAM=4]="DAYDREAM",t[t.GENERIC=5]="GENERIC"}(Ah||(Ah={}));class zh{static InitiateController(t){for(const i of this.PG)if(i.canCreate(t))return i.create(t);if(this.DG)return this.DG(t);throw"The type of gamepad you are trying to load needs to be imported first or is not supported."}}zh.PG=[],zh.DG=null;class Hh extends sh{constructor(t){super(t.id,t.index,t),this.isXR=!1,this.LG=w.Zero(),this.OG=new T,this.devicePosition=w.Zero(),this.deviceRotationQuaternion=new T,this.deviceScaleFactor=1,this.FG=!0,this.BG=Math.PI/5,this.UG=0,this.VG=new T,this.kG=R.Identity(),this.GG=null,this.zG=R.Identity(),this.HG=new h,this.type=sh.POSE_ENABLED,this.controllerType=Ah.GENERIC,this.position=w.Zero(),this.rotationQuaternion=new T,this.XG=w.Zero(),this.WG=new T,T.RotationYawPitchRollToRef(Math.PI,0,0,this.VG)}$G(t){this.FG&&(this.XG.copyFrom(t),this.FG=!1)}update(){super.update(),this.YG()}YG(){if(this.isXR)return;const t=this.browserGamepad.pose;if(this.updateFromDevice(t),!this.FG&&E.LastCreatedScene&&E.LastCreatedScene.activeCamera&&E.LastCreatedScene.activeCamera.devicePosition){const t=E.LastCreatedScene.activeCamera;if(t.jG(),this.kG.setTranslation(t.devicePosition),t.deviceRotationQuaternion){t.OG.toEulerAnglesToRef(M.Vector3[0]);const i=Math.atan2(Math.sin(M.Vector3[0].y-this.UG),Math.cos(M.Vector3[0].y-this.UG));if(Math.abs(i)>this.BG){const t=i-(i<0?-this.BG:this.BG);this.UG+=t;const e=Math.sin(-t),s=Math.cos(-t);this.XG.x=this.XG.x*s-this.XG.z*e,this.XG.z=this.XG.x*e+this.XG.z*s}}}w.TransformCoordinatesToRef(this.XG,this.kG,this.devicePosition),this.kG.getRotationMatrixToRef(this.zG),T.FromRotationMatrixToRef(this.zG,this.deviceRotationQuaternion),this.deviceRotationQuaternion.multiplyInPlace(this.WG),this.fC&&(this.fC.position.copyFrom(this.devicePosition),this.fC.rotationQuaternion&&this.fC.rotationQuaternion.copyFrom(this.deviceRotationQuaternion))}updateFromDevice(t){if(!this.isXR&&t){this.rawPose=t,t.position&&(this.LG.copyFromFloats(t.position[0],t.position[1],-t.position[2]),this.fC&&this.fC.getScene().useRightHandedSystem&&(this.LG.z*=-1),this.FG&&this.LG.scaleToRef(this.deviceScaleFactor,this.XG),this.XG.addInPlace(this.position));const i=this.rawPose;t.orientation&&i.orientation&&4===i.orientation.length&&(this.OG.copyFromFloats(i.orientation[0],i.orientation[1],-i.orientation[2],-i.orientation[3]),this.fC&&(this.fC.getScene().useRightHandedSystem?(this.OG.z*=-1,this.OG.w*=-1):this.OG.multiplyToRef(this.VG,this.OG)),this.OG.multiplyToRef(this.rotationQuaternion,this.WG))}}attachToMesh(t){if(this.fC&&(this.fC.parent=null),this.fC=t,this.KG&&(this.fC.parent=this.KG),this.fC.rotationQuaternion||(this.fC.rotationQuaternion=new T),!this.isXR&&(this.YG(),this.GG)){const t=[];let i=this.GG;for(;i.parent;)t.push(i.parent),i=i.parent;t.reverse().forEach((t=>{t.computeWorldMatrix(!0)}))}this.HG.notifyObservers(t)}attachToPoseControlledCamera(t){this.KG=t,this.fC&&(this.fC.parent=this.KG)}dispose(){this.fC&&this.fC.dispose(),this.fC=null,super.dispose()}get mesh(){return this.fC}getForwardRay(t=100){if(!this.mesh)return new vn(w.Zero(),new w(0,0,1),t);const i=this.GG?this.GG.getWorldMatrix():this.mesh.getWorldMatrix(),e=i.getTranslation(),s=new w(0,0,-1),n=w.TransformNormal(s,i),r=w.Normalize(n);return new vn(e,r,t)}}Hh.POINTING_POSE="POINTING_POSE",function(t){t[t.A=0]="A",t[t.B=1]="B",t[t.X=2]="X",t[t.Y=3]="Y",t[t.LB=4]="LB",t[t.RB=5]="RB",t[t.Back=8]="Back",t[t.Start=9]="Start",t[t.LeftStick=10]="LeftStick",t[t.RightStick=11]="RightStick"}(Ch||(Ch={})),function(t){t[t.Up=12]="Up",t[t.Down=13]="Down",t[t.Left=14]="Left",t[t.Right=15]="Right"}(wh||(wh={}));class Xh extends sh{constructor(t,i,e,s=!1){super(t,i,e,0,1,2,3),this.qG=0,this.QG=0,this.onButtonDownObservable=new h,this.onButtonUpObservable=new h,this.onPadDownObservable=new h,this.onPadUpObservable=new h,this.ZG=0,this.JG=0,this.tz=0,this.iz=0,this.ez=0,this.sz=0,this.nz=0,this.rz=0,this.hz=0,this.oz=0,this.az=0,this.lz=0,this.cz=0,this.uz=0,this.fz=!1,this.type=sh.XBOX,this.fz=s}onlefttriggerchanged(t){this.dz=t}onrighttriggerchanged(t){this.pz=t}get leftTrigger(){return this.qG}set leftTrigger(t){this.dz&&this.qG!==t&&this.dz(t),this.qG=t}get rightTrigger(){return this.QG}set rightTrigger(t){this.pz&&this.QG!==t&&this.pz(t),this.QG=t}onbuttondown(t){this.xU=t}onbuttonup(t){this.TU=t}ondpaddown(t){this.mz=t}ondpadup(t){this.vz=t}RU(t,i,e){return t!==i&&(1===t&&(this.xU&&this.xU(e),this.onButtonDownObservable.notifyObservers(e)),0===t&&(this.TU&&this.TU(e),this.onButtonUpObservable.notifyObservers(e))),t}gz(t,i,e){return t!==i&&(1===t&&(this.mz&&this.mz(e),this.onPadDownObservable.notifyObservers(e)),0===t&&(this.vz&&this.vz(e),this.onPadUpObservable.notifyObservers(e))),t}get buttonA(){return this.ZG}set buttonA(t){this.ZG=this.RU(t,this.ZG,Ch.A)}get buttonB(){return this.JG}set buttonB(t){this.JG=this.RU(t,this.JG,Ch.B)}get buttonX(){return this.tz}set buttonX(t){this.tz=this.RU(t,this.tz,Ch.X)}get buttonY(){return this.iz}set buttonY(t){this.iz=this.RU(t,this.iz,Ch.Y)}get buttonStart(){return this.sz}set buttonStart(t){this.sz=this.RU(t,this.sz,Ch.Start)}get buttonBack(){return this.ez}set buttonBack(t){this.ez=this.RU(t,this.ez,Ch.Back)}get buttonLB(){return this.nz}set buttonLB(t){this.nz=this.RU(t,this.nz,Ch.LB)}get buttonRB(){return this.rz}set buttonRB(t){this.rz=this.RU(t,this.rz,Ch.RB)}get buttonLeftStick(){return this.hz}set buttonLeftStick(t){this.hz=this.RU(t,this.hz,Ch.LeftStick)}get buttonRightStick(){return this.oz}set buttonRightStick(t){this.oz=this.RU(t,this.oz,Ch.RightStick)}get dPadUp(){return this.az}set dPadUp(t){this.az=this.gz(t,this.az,wh.Up)}get dPadDown(){return this.lz}set dPadDown(t){this.lz=this.gz(t,this.lz,wh.Down)}get dPadLeft(){return this.cz}set dPadLeft(t){this.cz=this.gz(t,this.cz,wh.Left)}get dPadRight(){return this.uz}set dPadRight(t){this.uz=this.gz(t,this.uz,wh.Right)}update(){super.update(),this.fz,this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}!function(t){t[t.Cross=0]="Cross",t[t.Circle=1]="Circle",t[t.Square=2]="Square",t[t.Triangle=3]="Triangle",t[t.L1=4]="L1",t[t.R1=5]="R1",t[t.Share=8]="Share",t[t.Options=9]="Options",t[t.LeftStick=10]="LeftStick",t[t.RightStick=11]="RightStick"}(xh||(xh={})),function(t){t[t.Up=12]="Up",t[t.Down=13]="Down",t[t.Left=14]="Left",t[t.Right=15]="Right"}(Th||(Th={}));class Wh extends sh{constructor(t,i,e){super(t.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),i,e,0,1,2,3),this.qG=0,this.QG=0,this.onButtonDownObservable=new h,this.onButtonUpObservable=new h,this.onPadDownObservable=new h,this.onPadUpObservable=new h,this.Sz=0,this.Ez=0,this.Az=0,this.Cz=0,this.wz=0,this.xz=0,this.Tz=0,this.Rz=0,this.hz=0,this.oz=0,this.az=0,this.lz=0,this.cz=0,this.uz=0,this.type=sh.DUALSHOCK}onlefttriggerchanged(t){this.dz=t}onrighttriggerchanged(t){this.pz=t}get leftTrigger(){return this.qG}set leftTrigger(t){this.dz&&this.qG!==t&&this.dz(t),this.qG=t}get rightTrigger(){return this.QG}set rightTrigger(t){this.pz&&this.QG!==t&&this.pz(t),this.QG=t}onbuttondown(t){this.xU=t}onbuttonup(t){this.TU=t}ondpaddown(t){this.mz=t}ondpadup(t){this.vz=t}RU(t,i,e){return t!==i&&(1===t&&(this.xU&&this.xU(e),this.onButtonDownObservable.notifyObservers(e)),0===t&&(this.TU&&this.TU(e),this.onButtonUpObservable.notifyObservers(e))),t}gz(t,i,e){return t!==i&&(1===t&&(this.mz&&this.mz(e),this.onPadDownObservable.notifyObservers(e)),0===t&&(this.vz&&this.vz(e),this.onPadUpObservable.notifyObservers(e))),t}get buttonCross(){return this.Sz}set buttonCross(t){this.Sz=this.RU(t,this.Sz,xh.Cross)}get buttonCircle(){return this.Ez}set buttonCircle(t){this.Ez=this.RU(t,this.Ez,xh.Circle)}get buttonSquare(){return this.Az}set buttonSquare(t){this.Az=this.RU(t,this.Az,xh.Square)}get buttonTriangle(){return this.Cz}set buttonTriangle(t){this.Cz=this.RU(t,this.Cz,xh.Triangle)}get buttonOptions(){return this.xz}set buttonOptions(t){this.xz=this.RU(t,this.xz,xh.Options)}get buttonShare(){return this.wz}set buttonShare(t){this.wz=this.RU(t,this.wz,xh.Share)}get buttonL1(){return this.Tz}set buttonL1(t){this.Tz=this.RU(t,this.Tz,xh.L1)}get buttonR1(){return this.Rz}set buttonR1(t){this.Rz=this.RU(t,this.Rz,xh.R1)}get buttonLeftStick(){return this.hz}set buttonLeftStick(t){this.hz=this.RU(t,this.hz,xh.LeftStick)}get buttonRightStick(){return this.oz}set buttonRightStick(t){this.oz=this.RU(t,this.oz,xh.RightStick)}get dPadUp(){return this.az}set dPadUp(t){this.az=this.gz(t,this.az,Th.Up)}get dPadDown(){return this.lz}set dPadDown(t){this.lz=this.gz(t,this.lz,Th.Down)}get dPadLeft(){return this.cz}set dPadLeft(t){this.cz=this.gz(t,this.cz,Th.Left)}get dPadRight(){return this.uz}set dPadRight(t){this.uz=this.gz(t,this.uz,Th.Right)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class $h{constructor(t){if(this.Kt=t,this.Iz=[],this.Mz=!1,this.bz=!1,this.onGamepadDisconnectedObservable=new h,xt()?(this._z="GamepadEvent"in window,this.Nz=navigator&&navigator.getGamepads):this._z=!1,this.onGamepadConnectedObservable=new h((t=>{for(const i in this.Iz){const e=this.Iz[i];e&&e.pU&&this.onGamepadConnectedObservable.notifyObserver(t,e)}})),this.Pz=t=>{const i=t.gamepad;if(i.index in this.Iz&&this.Iz[i.index].isConnected)return;let e;this.Iz[i.index]?(e=this.Iz[i.index],e.browserGamepad=i,e.pU=!0):e=this.Dz(i),this.onGamepadConnectedObservable.notifyObservers(e),this.Lz()},this.Oz=t=>{const i=t.gamepad;for(const t in this.Iz)if(this.Iz[t].index===i.index){const i=this.Iz[t];i.pU=!1,this.onGamepadDisconnectedObservable.notifyObservers(i),i.dispose&&i.dispose();break}},this.Nz)if(this.Fz(),this.Iz.length&&this.Lz(),this._z){const t=this.Kt?this.Kt.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this.Pz,!1),t.addEventListener("gamepaddisconnected",this.Oz,!1))}else this.Lz()}get gamepads(){return this.Iz}getGamepadByType(t=sh.XBOX){for(const i of this.Iz)if(i&&i.type===t)return i;return null}dispose(){this._z&&(this.Pz&&window.removeEventListener("gamepadconnected",this.Pz),this.Oz&&window.removeEventListener("gamepaddisconnected",this.Oz),this.Pz=null,this.Oz=null),this.Iz.forEach((t=>{t.dispose()})),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this.Mz=!1,this.Bz(),this.Iz=[]}Dz(t){let i;this.Mz||(this.Mz=!0);const e=-1!==t.id.search("054c")&&-1===t.id.search("0ce6"),s=-1!==t.id.search("Xbox One");return i=s||-1!==t.id.search("Xbox 360")||-1!==t.id.search("xinput")||-1!==t.id.search("045e")&&-1===t.id.search("Surface Dock")?new Xh(t.id,t.index,t,s):e?new Wh(t.id,t.index,t):t.pose?zh.InitiateController(t):new nh(t.id,t.index,t),this.Iz[i.index]=i,i}Lz(){this.bz||(this.bz=!0,this.Kt||this.Uz())}Bz(){this.bz=!1}Uz(){this.Fz();for(const t in this.Iz){const i=this.Iz[t];if(i&&i.isConnected)try{i.update()}catch(t){-1===this.Vz.indexOf(i.index)&&(ki.Warn(`Error updating gamepad ${i.id}`),this.Vz.push(i.index))}}this.bz&&!this.Kt&&Rs.QueueNewFrame((()=>{this.Uz()}))}Fz(){const t=navigator.getGamepads?navigator.getGamepads():[];for(let i=0;i<t.length;i++){const e=t[i];if(e)if(this.Iz[e.index])this.Iz[i].browserGamepad=e,this.Iz[i].isConnected||(this.Iz[i].pU=!0,this.onGamepadConnectedObservable.notifyObservers(this.Iz[i]));else{const t=this.Dz(e);this.onGamepadConnectedObservable.notifyObservers(t)}}}}Object.defineProperty(ke.prototype,"gamepadManager",{get:function(){if(!this.kz){this.kz=new $h(this);let t=this.Mg(fe.NAME_GAMEPAD);t||(t=new Yh(this),this.Ig(t))}return this.kz},enumerable:!0,configurable:!0}),Mh.prototype.addGamepad=function(){return this.add(new _h),this},lh.prototype.addGamepad=function(){return this.add(new rh),this};class Yh{constructor(t){this.name=fe.NAME_GAMEPAD,this.scene=t}register(){this.scene.Vv.registerStep(fe.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this.Gz)}rebuild(){}dispose(){const t=this.scene.kz;t&&(t.dispose(),this.scene.kz=null)}Gz(){const t=this.scene.kz;t&&t.bz&&t.Uz()}}dt.AddNodeConstructor("FreeCamera",((t,i)=>()=>new jh(t,w.Zero(),i)));class jh extends Lh{get gamepadAngularSensibility(){const t=this.inputs.attached.gamepad;return t?t.gamepadAngularSensibility:0}set gamepadAngularSensibility(t){const i=this.inputs.attached.gamepad;i&&(i.gamepadAngularSensibility=t)}get gamepadMoveSensibility(){const t=this.inputs.attached.gamepad;return t?t.gamepadMoveSensibility:0}set gamepadMoveSensibility(t){const i=this.inputs.attached.gamepad;i&&(i.gamepadMoveSensibility=t)}constructor(t,i,e){super(t,i,e),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}hs.kA=(t,i)=>new jh(t,w.Zero(),i),dt.AddNodeConstructor("GamepadCamera",((t,i)=>()=>new Kh(t,w.Zero(),i)));class Kh extends jh{constructor(t,i,e){super(t,i,e)}getClassName(){return"GamepadCamera"}}const qh="passCubePixelShader",Qh="varying vec2 vUV;\nuniform samplerCube textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nvec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));\n#endif\n}";ii.ShadersStore[qh]=Qh;class Zh extends nr{getClassName(){return"PassPostProcess"}constructor(t,i,e=null,s,n,r,h=0,o=!1){super(t,"pass",null,null,i,e,s,n,r,void 0,h,void 0,null,o)}static SL(t,i,e,s){return ot.Parse((()=>new Zh(t.name,t.options,i,t.renderTargetSamplingMode,t.Ls,t.reusable)),t,e,s)}}v("BABYLON.PassPostProcess",Zh);Rs.Bw=t=>new Zh("rescale",1,null,2,t,!1,0);const Jh="anaglyphPixelShader",to="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D leftSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 leftFrag=texture2D(leftSampler,vUV);\nleftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);\nvec4 rightFrag=texture2D(textureSampler,vUV);\nrightFrag=vec4(rightFrag.r,1.0,1.0,1.0);\ngl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);\n}";ii.ShadersStore[Jh]=to;class io extends nr{constructor(t,i,e,s,n,r){super(t,"anaglyph",null,["leftSampler"],i,e[1],s,n,r),this.Xz=e[0].MA,this.onApplyObservable.add((t=>{t.setTextureFromPostProcess("leftSampler",this.Xz)}))}getClassName(){return"AnaglyphPostProcess"}}function eo(t){t.uS[0].MA=new Zh(t.name+"_passthru",1,t.uS[0]),t.uS[1].MA=new io(t.name+"_anaglyph",1,t.uS)}v("BABYLON.AnaglyphPostProcess",io),dt.AddNodeConstructor("AnaglyphArcRotateCamera",((t,i,e)=>()=>new so(t,0,0,1,w.Zero(),e.interaxial_distance,i)));class so extends Oh{constructor(t,i,e,s,n,r,h){super(t,i,e,s,n,h),this.DA=eo.bind(null,this),this.interaxialDistance=r,this.setCameraRigMode(hs.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:r})}getClassName(){return"AnaglyphArcRotateCamera"}}dt.AddNodeConstructor("AnaglyphFreeCamera",((t,i,e)=>()=>new no(t,w.Zero(),e.interaxial_distance,i)));class no extends Dh{constructor(t,i,e,s){super(t,i,s),this.DA=eo.bind(null,this),this.interaxialDistance=e,this.setCameraRigMode(hs.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:e})}getClassName(){return"AnaglyphFreeCamera"}}dt.AddNodeConstructor("AnaglyphGamepadCamera",((t,i,e)=>()=>new ro(t,w.Zero(),e.interaxial_distance,i)));class ro extends Kh{constructor(t,i,e,s){super(t,i,s),this.DA=eo.bind(null,this),this.interaxialDistance=e,this.setCameraRigMode(hs.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:e})}getClassName(){return"AnaglyphGamepadCamera"}}dt.AddNodeConstructor("AnaglyphUniversalCamera",((t,i,e)=>()=>new ho(t,w.Zero(),e.interaxial_distance,i)));class ho extends jh{constructor(t,i,e,s){super(t,i,s),this.DA=eo.bind(null,this),this.interaxialDistance=e,this.setCameraRigMode(hs.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:e})}getClassName(){return"AnaglyphUniversalCamera"}}const oo="stereoscopicInterlacePixelShader",ao="const vec3 TWO=vec3(2.0,2.0,2.0);\nvarying vec2 vUV;\nuniform sampler2D camASampler;\nuniform sampler2D textureSampler;\nuniform vec2 stepSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nbool useCamA;\nbool useCamB;\nvec2 texCoord1;\nvec2 texCoord2;\nvec3 frag1;\nvec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;\nuseCamA=!useCamB;\ntexCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);\ntexCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\n#ifdef IS_STEREOSCOPIC_INTERLACED\nfloat rowNum=floor(vUV.y/stepSize.y);\nuseCamA=mod(rowNum,2.0)==1.0;\nuseCamB=mod(rowNum,2.0)==0.0;\ntexCoord1=vec2(vUV.x,vUV.y);\ntexCoord2=vec2(vUV.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;\nuseCamA=!useCamB;\ntexCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);\ntexCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n#endif\nif (useCamB){\nfrag1=texture2D(textureSampler,texCoord1).rgb;\nfrag2=texture2D(textureSampler,texCoord2).rgb;\n}else if (useCamA){\nfrag1=texture2D(camASampler ,texCoord1).rgb;\nfrag2=texture2D(camASampler ,texCoord2).rgb;\n}else {\ndiscard;\n}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);\n}\n";ii.ShadersStore[oo]=ao;class lo extends nr{constructor(t,i,e,s,n,r,h){super(t,"stereoscopicInterlace",["stepSize"],["camASampler"],1,i[1],n,r,h,s?"#define IS_STEREOSCOPIC_INTERLACED 1":e?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this.Xz=i[0].MA,this.Wz=new C(1/this.width,1/this.height),this.onSizeChangedObservable.add((()=>{this.Wz=new C(1/this.width,1/this.height)})),this.onApplyObservable.add((t=>{t.setTextureFromPostProcess("camASampler",this.Xz),t.setFloat2("stepSize",this.Wz.x,this.Wz.y)}))}getClassName(){return"StereoscopicInterlacePostProcessI"}}function co(t){const i=t.cameraRigMode===hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||t.cameraRigMode===hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,e=t.cameraRigMode===hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;t.cameraRigMode===hs.RIG_MODE_STEREOSCOPIC_INTERLACED?(t.uS[0].MA=new Zh(t.name+"_passthru",1,t.uS[0]),t.uS[1].MA=new lo(t.name+"_stereoInterlace",t.uS,!1,!0)):(t.uS[e?1:0].viewport=new rs(0,0,i?.5:1,i?1:.5),t.uS[e?0:1].viewport=new rs(i?.5:0,i?0:.5,i?.5:1,i?1:.5))}dt.AddNodeConstructor("StereoscopicArcRotateCamera",((t,i,e)=>()=>new uo(t,0,0,1,w.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,i)));class uo extends Oh{constructor(t,i,e,s,n,r,h,o){super(t,i,e,s,n,o),this.DA=co.bind(null,this),this.interaxialDistance=r,this.isStereoscopicSideBySide=h,this.setCameraRigMode(h?hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:hs.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:r})}getClassName(){return"StereoscopicArcRotateCamera"}}dt.AddNodeConstructor("StereoscopicFreeCamera",((t,i,e)=>()=>new fo(t,w.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,i)));class fo extends Dh{constructor(t,i,e,s,n){super(t,i,n),this.DA=co.bind(null,this),this.interaxialDistance=e,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:hs.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:e})}getClassName(){return"StereoscopicFreeCamera"}}dt.AddNodeConstructor("StereoscopicGamepadCamera",((t,i,e)=>()=>new po(t,w.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,i)));class po extends Kh{constructor(t,i,e,s,n){super(t,i,n),this.DA=co.bind(null,this),this.interaxialDistance=e,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:hs.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:e})}getClassName(){return"StereoscopicGamepadCamera"}}dt.AddNodeConstructor("StereoscopicFreeCamera",((t,i,e)=>()=>new mo(t,w.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,i)));class mo extends jh{constructor(t,i,e,s,n){super(t,i,n),this.DA=co.bind(null,this),this.interaxialDistance=e,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?hs.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:hs.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:e})}getClassName(){return"StereoscopicUniversalCamera"}}dt.AddNodeConstructor("VirtualJoysticksCamera",((t,i)=>()=>new vo(t,w.Zero(),i)));class vo extends Dh{constructor(t,i,e){super(t,i,e),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}}class go{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return R.Translation(t,0,0)}get rightHMatrix(){const t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return R.Translation(-t,0,0)}get leftPreViewMatrix(){return R.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return R.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const t=new go;return t.hResolution=1280,t.vResolution=800,t.hScreenSize=.149759993,t.vScreenSize=.0935999975,t.vScreenCenter=.0467999987,t.eyeToScreenDistance=.0410000011,t.lensSeparationDistance=.063500002,t.interpupillaryDistance=.064000003,t.distortionK=[1,.219999999,.239999995,0],t.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],t.postProcessScaleFactor=1.714605507808412,t.lensCenterOffset=.151976421,t}}const So="vrDistortionCorrectionPixelShader",Eo="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 LensCenter;\nuniform vec2 Scale;\nuniform vec2 ScaleIn;\nuniform vec4 HmdWarpParam;\nvec2 HmdWarp(vec2 in01) {\nvec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;\nvec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);\nreturn LensCenter+Scale*rvector;\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec2 tc=HmdWarp(vUV);\nif (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,0.0);\nelse{\ngl_FragColor=texture2D(textureSampler,tc);\n}\n}";ii.ShadersStore[So]=Eo;class Ao extends nr{constructor(t,i,e,s){super(t,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,s.postProcessScaleFactor,i,an.BILINEAR_SAMPLINGMODE),this.$z=e,this.Yz=s.distortionK,this.jz=s.postProcessScaleFactor,this.Kz=s.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add((()=>{this.qz=new C(2,2/this.aspectRatio),this.Qz=new C(1/this.jz*.5,1/this.jz*.5*this.aspectRatio),this.Zz=new C(this.$z?.5-.5*this.Kz:.5+.5*this.Kz,.5)})),this.onApplyObservable.add((t=>{t.setFloat2("LensCenter",this.Zz.x,this.Zz.y),t.setFloat2("Scale",this.Qz.x,this.Qz.y),t.setFloat2("ScaleIn",this.qz.x,this.qz.y),t.setFloat4("HmdWarpParam",this.Yz[0],this.Yz[1],this.Yz[2],this.Yz[3])}))}getClassName(){return"VRDistortionCorrectionPostProcess"}}const Co="vrMultiviewToSingleviewPixelShader",wo="precision mediump sampler2DArray;\nvarying vec2 vUV;\nuniform sampler2DArray multiviewSampler;\nuniform int imageIndex;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\ngl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));\n}";ii.ShadersStore[Co]=wo;class xo extends br{set samples(t){this.dw=t}get samples(){return this.dw}constructor(t,i=512){super("multiview rtt",i,t,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this.rO=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this.Lb=this.rO.texture,this.Lb.isMultiview=!0,this.Lb.format=5,this.samples=this.qb().getCaps().maxSamples||this.samples,this.Lb.samples=this.dw}fS(){this.rO&&this.getScene().getEngine().bindMultiviewFramebuffer(this.rO)}getViewCount(){return 2}}function To(t,i){const e=new ne(t,void 0,!0,i);return e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.addUniform("view",16),e.addUniform("projection",16),e.addUniform("vEyePosition",4),e}Rs.prototype.createMultiviewRenderTargetTexture=function(t,i){const e=this.lo;if(!this.getCaps().multiview)throw"Multiview is not supported";const s=this.$D(!1,!1,{width:t,height:i});s.$o=e.createFramebuffer();const n=new ai(this,oi.Unknown,!0);return n.width=t,n.height=i,n.isMultiview=!0,s.HD=e.createTexture(),e.bindTexture(e.TEXTURE_2D_ARRAY,s.HD),e.texStorage3D(e.TEXTURE_2D_ARRAY,1,e.RGBA8,t,i,2),s.XD=e.createTexture(),e.bindTexture(e.TEXTURE_2D_ARRAY,s.XD),e.texStorage3D(e.TEXTURE_2D_ARRAY,1,e.DEPTH24_STENCIL8,t,i,2),n.isReady=!0,s.setTextures(n),s.Yo=n,s},Rs.prototype.bindMultiviewFramebuffer=function(t){const i=t,e=this.lo,s=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(i,void 0,void 0,void 0,!0),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i.$o),!i.HD||!i.XD)throw"Invalid multiview frame buffer";this.getCaps().oculusMultiview?(s.framebufferTextureMultisampleMultiviewOVR(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,i.HD,0,i.samples,0,2),s.framebufferTextureMultisampleMultiviewOVR(e.DRAW_FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,i.XD,0,i.samples,0,2)):(s.framebufferTextureMultiviewOVR(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,i.HD,0,0,2),s.framebufferTextureMultiviewOVR(e.DRAW_FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,i.XD,0,0,2))},hs.prototype.wS=!1,hs.prototype.dS=null,hs.prototype.Jz=function(t,i){this.dS?this.dS.getRenderWidth()==t&&this.dS.getRenderHeight()==i||(this.dS.dispose(),this.dS=new xo(this.getScene(),{width:t,height:i})):this.dS=new xo(this.getScene(),{width:t,height:i})};const Ro=ke.prototype.createSceneUniformBuffer;ke.prototype.tH=R.Zero(),ke.prototype.Vg=null,ke.prototype.CS=function(){this.Vg=To(this.getEngine(),"scene_multiview")},ke.prototype.createSceneUniformBuffer=function(t){return this.Vg?To(this.getEngine(),t):Ro.bind(this)(t)},ke.prototype.kg=function(t,i){t&&i&&t.multiplyToRef(i,this.tH),t&&i&&(t.multiplyToRef(i,M.Matrix[0]),De.GetRightPlaneToRef(M.Matrix[0],this.Xf[3])),this.Vg&&(this.Vg.updateMatrix("viewProjection",this.getTransformMatrix()),this.Vg.updateMatrix("viewProjectionR",this.tH),this.Vg.updateMatrix("view",this.Bg),this.Vg.updateMatrix("projection",this.Ug))},ke.prototype.xS=function(t){t.Jz(t.MA&&t.MA&&t.MA.width>0?t.MA.width:this.getEngine().getRenderWidth(!0),t.MA&&t.MA&&t.MA.height>0?t.MA.height:this.getEngine().getRenderHeight(!0)),this.Vg||this.CS(),t.outputRenderTarget=t.dS,this.gS(t),t.outputRenderTarget=null;for(let i=0;i<t.uS.length;i++){const e=this.getEngine();this.wg=t.uS[i],e.setViewport(this.wg.viewport),this.postProcessManager&&(this.postProcessManager.mf(),this.postProcessManager.Sf(this.wg.isIntermediate))}};class Io extends nr{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(t,i,e){super(t,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],e,i,an.BILINEAR_SAMPLINGMODE);const s=null!=i?i:this.getCamera();this.onSizeChangedObservable.add((()=>{})),this.onApplyObservable.add((t=>{s.Kt.activeCamera&&s.Kt.activeCamera.isLeftCamera?t.setInt("imageIndex",0):t.setInt("imageIndex",1),t.setTexture("multiviewSampler",s.dS)}))}}function Mo(t,i){const e=i.vrCameraMetrics||go.GetDefault();t.uS[0].NA.vrMetrics=e,t.uS[0].viewport=new rs(0,0,.5,1),t.uS[0].NA.vrWorkMatrix=new R,t.uS[0].NA.vrHMatrix=e.leftHMatrix,t.uS[0].NA.vrPreViewMatrix=e.leftPreViewMatrix,t.uS[0].getProjectionMatrix=t.uS[0].LA,t.uS[1].NA.vrMetrics=e,t.uS[1].viewport=new rs(.5,0,.5,1),t.uS[1].NA.vrWorkMatrix=new R,t.uS[1].NA.vrHMatrix=e.rightHMatrix,t.uS[1].NA.vrPreViewMatrix=e.rightPreViewMatrix,t.uS[1].getProjectionMatrix=t.uS[1].LA,e.multiviewEnabled&&(t.getScene().getEngine().getCaps().multiview?(t.wS=!0,t.MA=new Io("VRMultiviewToSingleview",t,e.postProcessScaleFactor)):(F.Warn("Multiview is not supported, falling back to standard rendering"),e.multiviewEnabled=!1)),e.compensateDistortion&&(t.uS[0].MA=new Ao("VR_Distort_Compensation_Left",t.uS[0],!1,e),t.uS[1].MA=new Ao("VR_Distort_Compensation_Right",t.uS[1],!0,e))}dt.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",((t,i)=>()=>new bo(t,0,0,1,w.Zero(),i)));class bo extends Oh{constructor(t,i,e,s,n,r,h=!0,o=go.GetDefault()){super(t,i,e,s,n,r),this.DA=Mo.bind(null,this),o.compensateDistortion=h,this.setCameraRigMode(hs.RIG_MODE_VR,{vrCameraMetrics:o}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}}dt.AddNodeConstructor("VRDeviceOrientationFreeCamera",((t,i)=>()=>new _o(t,w.Zero(),i)));class _o extends Fh{constructor(t,i,e,s=!0,n=go.GetDefault()){super(t,i,e),this.DA=Mo.bind(null,this),n.compensateDistortion=s,this.setCameraRigMode(hs.RIG_MODE_VR,{vrCameraMetrics:n})}getClassName(){return"VRDeviceOrientationFreeCamera"}}dt.AddNodeConstructor("VRDeviceOrientationGamepadCamera",((t,i)=>()=>new yo(t,w.Zero(),i)));class yo extends _o{constructor(t,i,e,s=!0,n=go.GetDefault()){super(t,i,e,s,n),this.DA=Mo.bind(null,this),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}}class No extends dt{constructor(t,i){super(t,i),this.diffuse=new _(1,1,1),this.specular=new _(1,1,1),this.falloffType=No.FALLOFF_DEFAULT,this.intensity=1,this.iH=Number.MAX_VALUE,this.eH=0,this.sH=1,this.nH=No.INTENSITYMODE_AUTOMATIC,this.eR=1e-5,this.renderPriority=0,this.rH=!0,this.hH=0,this.oH=0,this.aH=0,this.lH=null,this.cH=new Array,this.uH=new Array,this.bt=!0,this.getScene().addLight(this),this.VT=new ne(this.getScene().getEngine(),void 0,void 0,t),this.kT(),this.includedOnlyMeshes=new Array,this.excludedMeshes=new Array,this.fH()}get range(){return this.iH}set range(t){this.iH=t,this.eH=1/(this.range*this.range)}get intensityMode(){return this.nH}set intensityMode(t){this.nH=t,this.dH()}get radius(){return this.eR}set radius(t){this.eR=t,this.dH()}get shadowEnabled(){return this.rH}set shadowEnabled(t){this.rH!==t&&(this.rH=t,this.pH())}get includedOnlyMeshes(){return this.mH}set includedOnlyMeshes(t){this.mH=t,this.vH(t)}get excludedMeshes(){return this.gH}set excludedMeshes(t){this.gH=t,this.SH(t)}get excludeWithLayerMask(){return this.hH}set excludeWithLayerMask(t){this.hH=t,this.fH()}get includeOnlyWithLayerMask(){return this.oH}set includeOnlyWithLayerMask(t){this.oH=t,this.fH()}get lightmapMode(){return this.aH}set lightmapMode(t){this.aH!==t&&(this.aH=t,this.pH())}transferTexturesToEffect(t,i){return this}cR(t,i,e,s,n=!0){var r;const h=t.toString();let o=!1;if(this.VT.bindToEffect(e,"Light"+h),this.Sv!==i.getRenderId()||this.EH!==s||!this.VT.useUbo){this.Sv=i.getRenderId(),this.EH=s;const t=this.getScaledIntensity();this.transferToEffect(e,h),this.diffuse.scaleToRef(t,N.Color3[0]),this.VT.updateColor4("vLightDiffuse",N.Color3[0],this.range,h),s&&(this.specular.scaleToRef(t,N.Color3[1]),this.VT.updateColor4("vLightSpecular",N.Color3[1],this.radius,h)),o=!0}if(this.transferTexturesToEffect(e,h),i.shadowsEnabled&&this.shadowEnabled&&n){const t=null!==(r=this.getShadowGenerator(i.activeCamera))&&void 0!==r?r:this.getShadowGenerator();t&&(t.bindShadowLight(h,e),o=!0)}o?this.VT.update():this.VT.bindUniformBuffer()}getClassName(){return"Light"}toString(t){let i="Name: "+this.name;if(i+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let e=0;e<this.animations.length;e++)i+=", animation[0]: "+this.animations[e].toString(t);return i}ki(){super.ki(),this.isDisposed()||this.fH()}setEnabled(t){super.setEnabled(t),this.fH()}getShadowGenerator(t=null){var i;return null===this.lH?null:null!==(i=this.lH.get(t))&&void 0!==i?i:null}getShadowGenerators(){return this.lH}getAbsolutePosition(){return w.Zero()}canAffectMesh(t){return!t||!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&-1===this.includedOnlyMeshes.indexOf(t))&&(!(this.excludedMeshes&&this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(t))&&((0===this.includeOnlyWithLayerMask||0!=(this.includeOnlyWithLayerMask&t.layerMask))&&!(0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&t.layerMask)))}dispose(t,i=!1){if(this.lH){const t=this.lH.values();for(let i=t.next();!0!==i.done;i=t.next()){i.value.dispose()}this.lH=null}if(this.getScene().stopAnimation(this),this.Si){const t=this.Si.lights.indexOf(this);t>-1&&this.Si.lights.splice(t,1),this.Si=null}for(const t of this.getScene().meshes)t.Wg(this,!0);this.VT.dispose(),this.getScene().removeLight(this),super.dispose(t,i)}getTypeID(){return 0}getScaledIntensity(){return this.sH*this.intensity}clone(t,i=null){const e=No.GetConstructorFromName(this.getTypeID(),t,this.getScene());if(!e)return null;const s=ot.Clone(e,this);return t&&(s.name=t),i&&(s.parent=i),s.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(s),s}serialize(){const t=ot.Serialize(this);return t.uniqueId=this.uniqueId,t.type=this.getTypeID(),this.parent&&this.parent.Gi(t),this.excludedMeshes.length>0&&(t.excludedMeshesIds=[],this.excludedMeshes.forEach((i=>{t.excludedMeshesIds.push(i.id)}))),this.includedOnlyMeshes.length>0&&(t.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach((i=>{t.includedOnlyMeshesIds.push(i.id)}))),ot.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.isEnabled=this.isEnabled(),t}static GetConstructorFromName(t,i,e){const s=dt.Construct("Light_Type_"+t,i,e);return s||null}static Parse(t,i){const e=No.GetConstructorFromName(t.type,t.name,i);if(!e)return null;const s=ot.Parse(e,t,i);if(t.excludedMeshesIds&&(s.cH=t.excludedMeshesIds),t.includedOnlyMeshesIds&&(s.uH=t.includedOnlyMeshesIds),void 0!==t.parentId&&(s.xi=t.parentId),void 0!==t.parentInstanceIndex&&(s.Ti=t.parentInstanceIndex),void 0!==t.falloffType&&(s.falloffType=t.falloffType),void 0!==t.lightmapMode&&(s.lightmapMode=t.lightmapMode),t.animations){for(let i=0;i<t.animations.length;i++){const e=t.animations[i],n=g("BABYLON.Animation");n&&s.animations.push(n.Parse(e))}dt.ParseAnimationRanges(s,t,i)}return t.autoAnimate&&i.beginAnimation(s,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),void 0!==t.isEnabled&&s.setEnabled(t.isEnabled),s}SH(t){const i=t.push;t.push=(...e)=>{const s=i.apply(t,e);for(const t of e)t.KT(this);return s};const e=t.splice;t.splice=(i,s)=>{const n=e.apply(t,[i,s]);for(const t of n)t.KT(this);return n};for(const i of t)i.KT(this)}vH(t){const i=t.push;t.push=(...e)=>{const s=i.apply(t,e);return this.fH(),s};const e=t.splice;t.splice=(i,s)=>{const n=e.apply(t,[i,s]);return this.fH(),n},this.fH()}fH(){for(const t of this.getScene().meshes)t.KT(this)}pH(){for(const t of this.getScene().meshes)-1!==t.lightSources.indexOf(this)&&t.$T()}dH(){this.sH=this.AH(),this.getScene().resetCachedMaterial()}AH(){let t=0;const i=this.getTypeID();let e=this.intensityMode;switch(e===No.INTENSITYMODE_AUTOMATIC&&(e=i===No.LIGHTTYPEID_DIRECTIONALLIGHT?No.INTENSITYMODE_ILLUMINANCE:No.INTENSITYMODE_LUMINOUSINTENSITY),i){case No.LIGHTTYPEID_POINTLIGHT:case No.LIGHTTYPEID_SPOTLIGHT:switch(e){case No.INTENSITYMODE_LUMINOUSPOWER:t=1/(4*Math.PI);break;case No.INTENSITYMODE_LUMINOUSINTENSITY:t=1;break;case No.INTENSITYMODE_LUMINANCE:t=this.radius*this.radius}break;case No.LIGHTTYPEID_DIRECTIONALLIGHT:switch(e){case No.INTENSITYMODE_ILLUMINANCE:t=1;break;case No.INTENSITYMODE_LUMINANCE:{let i=this.radius;i=Math.max(i,.001);t=2*Math.PI*(1-Math.cos(i));break}}break;case No.LIGHTTYPEID_HEMISPHERICLIGHT:t=1}return t}CH(){const t=this.getScene();0!=this.wH&&(t.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}No.FALLOFF_DEFAULT=Oe.FALLOFF_DEFAULT,No.FALLOFF_PHYSICAL=Oe.FALLOFF_PHYSICAL,No.FALLOFF_GLTF=Oe.FALLOFF_GLTF,No.FALLOFF_STANDARD=Oe.FALLOFF_STANDARD,No.LIGHTMAP_DEFAULT=Oe.LIGHTMAP_DEFAULT,No.LIGHTMAP_SPECULAR=Oe.LIGHTMAP_SPECULAR,No.LIGHTMAP_SHADOWSONLY=Oe.LIGHTMAP_SHADOWSONLY,No.INTENSITYMODE_AUTOMATIC=Oe.INTENSITYMODE_AUTOMATIC,No.INTENSITYMODE_LUMINOUSPOWER=Oe.INTENSITYMODE_LUMINOUSPOWER,No.INTENSITYMODE_LUMINOUSINTENSITY=Oe.INTENSITYMODE_LUMINOUSINTENSITY,No.INTENSITYMODE_ILLUMINANCE=Oe.INTENSITYMODE_ILLUMINANCE,No.INTENSITYMODE_LUMINANCE=Oe.INTENSITYMODE_LUMINANCE,No.LIGHTTYPEID_POINTLIGHT=Oe.LIGHTTYPEID_POINTLIGHT,No.LIGHTTYPEID_DIRECTIONALLIGHT=Oe.LIGHTTYPEID_DIRECTIONALLIGHT,No.LIGHTTYPEID_SPOTLIGHT=Oe.LIGHTTYPEID_SPOTLIGHT,No.LIGHTTYPEID_HEMISPHERICLIGHT=Oe.LIGHTTYPEID_HEMISPHERICLIGHT,ut([J()],No.prototype,"diffuse",void 0),ut([J()],No.prototype,"specular",void 0),ut([Q()],No.prototype,"falloffType",void 0),ut([Q()],No.prototype,"intensity",void 0),ut([Q()],No.prototype,"range",null),ut([Q()],No.prototype,"intensityMode",null),ut([Q()],No.prototype,"radius",null),ut([Q()],No.prototype,"_renderPriority",void 0),ut([q("_reorderLightsInScene")],No.prototype,"renderPriority",void 0),ut([Q("shadowEnabled")],No.prototype,"_shadowEnabled",void 0),ut([Q("excludeWithLayerMask")],No.prototype,"_excludeWithLayerMask",void 0),ut([Q("includeOnlyWithLayerMask")],No.prototype,"_includeOnlyWithLayerMask",void 0),ut([Q("lightmapMode")],No.prototype,"_lightmapMode",void 0),dt.AddNodeConstructor("Light_Type_3",((t,i)=>()=>new Po(t,w.Zero(),i)));class Po extends No{constructor(t,i,e){super(t,e),this.groundColor=new _(0,0,0),this.direction=i||w.Up()}kT(){this.VT.addUniform("vLightData",4),this.VT.addUniform("vLightDiffuse",4),this.VT.addUniform("vLightSpecular",4),this.VT.addUniform("vLightGround",3),this.VT.addUniform("shadowsInfo",3),this.VT.addUniform("depthValues",2),this.VT.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(t){return this.direction=w.Normalize(t.subtract(w.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(t,i){const e=w.Normalize(this.direction);return this.VT.updateFloat4("vLightData",e.x,e.y,e.z,0,i),this.VT.updateColor3("vLightGround",this.groundColor.scale(this.intensity),i),this}transferToNodeMaterialEffect(t,i){const e=w.Normalize(this.direction);return t.setFloat3(i,e.x,e.y,e.z),this}computeWorldMatrix(){return this._i||(this._i=R.Identity()),this._i}getTypeID(){return No.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(t,i){t["HEMILIGHT"+i]=!0}}function Do(t,i){if(i.vrDisplay){const e=i.vrDisplay.getEyeParameters("left"),s=i.vrDisplay.getEyeParameters("right");t.uS[0].viewport=new rs(0,0,.5,1),t.uS[0].setCameraRigParameter("left",!0),t.uS[0].setCameraRigParameter("specs",i.specs),t.uS[0].setCameraRigParameter("eyeParameters",e),t.uS[0].setCameraRigParameter("frameData",i.frameData),t.uS[0].setCameraRigParameter("parentCamera",i.parentCamera),t.uS[0].NA.vrWorkMatrix=new R,t.uS[0].getProjectionMatrix=t.BA,t.uS[0].parent=t,t.uS[0].yA=t.UA,t.uS[1].viewport=new rs(.5,0,.5,1),t.uS[1].setCameraRigParameter("eyeParameters",s),t.uS[1].setCameraRigParameter("specs",i.specs),t.uS[1].setCameraRigParameter("frameData",i.frameData),t.uS[1].setCameraRigParameter("parentCamera",i.parentCamera),t.uS[1].NA.vrWorkMatrix=new R,t.uS[1].getProjectionMatrix=t.BA,t.uS[1].parent=t,t.uS[1].yA=t.UA}}ut([J()],Po.prototype,"groundColor",void 0),ut([et()],Po.prototype,"direction",void 0),Object.defineProperty(Rs.prototype,"isInVRExclusivePointerMode",{get:function(){return this.xH},enumerable:!0,configurable:!0}),Rs.prototype.Ow=function(){this.TH=!1,this.xH=!1,this.onVRDisplayChangedObservable=new h,this.onVRRequestPresentComplete=new h,this.onVRRequestPresentStart=new h},Rs.prototype.isVRDevicePresent=function(){return!!this.RH},Rs.prototype.getVRDevice=function(){return this.RH},Rs.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable},Rs.prototype.initWebVRAsync=function(){const t=()=>{const t={vrDisplay:this.RH,vrSupported:this.TH};this.onVRDisplayChangedObservable.notifyObservers(t),this.IH=new Promise((i=>{i(t)}))};if(!this.MH){this.MH=i=>{this.RH=i.display,t()},this.bH=()=>{this.RH.cancelAnimationFrame(this.Vo),this.RH=void 0,this.Vo=Rs.QueueNewFrame(this.Go),t()},this._H=()=>{this.xH=this.RH&&this.RH.isPresenting};const i=this.getHostWindow();i&&(i.addEventListener("vrdisplayconnect",this.MH),i.addEventListener("vrdisplaydisconnect",this.bH),i.addEventListener("vrdisplaypresentchange",this._H))}return this.IH=this.IH||this.yH(),this.IH.then(t),this.IH},Rs.prototype.yH=function(){return new Promise((t=>{navigator.getVRDisplays?navigator.getVRDisplays().then((i=>{this.TH=!0,this.RH=i[0],t({vrDisplay:this.RH,vrSupported:this.TH})})):(this.RH=void 0,this.TH=!1,t({vrDisplay:this.RH,vrSupported:this.TH}))}))},Rs.prototype.enableVR=function(t){if(this.RH&&!this.RH.isPresenting){const i=()=>{this.onVRRequestPresentComplete.notifyObservers(!0),this.NH()},e=()=>{this.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this);const s={highRefreshRate:!!this.vrPresentationAttributes&&this.vrPresentationAttributes.highRefreshRate,foveationLevel:this.vrPresentationAttributes?this.vrPresentationAttributes.foveationLevel:1,multiview:(this.getCaps().multiview||this.getCaps().oculusMultiview)&&t.useMultiview};this.RH.requestPresent([{source:this.getRenderingCanvas(),attributes:s,...s}]).then(i).catch(e)}},Rs.prototype.NH=function(){if(this.RH&&this.RH.isPresenting){this.PH=new pt(this.getRenderWidth(),this.getRenderHeight()),this.DH=this.getHardwareScalingLevel();const t=this.RH.getEyeParameters("left");this.setHardwareScalingLevel(1),this.setSize(2*t.renderWidth,t.renderHeight)}else this.setHardwareScalingLevel(this.DH),this.setSize(this.PH.width,this.PH.height)},Rs.prototype.disableVR=function(){this.RH&&this.RH.isPresenting&&this.RH.exitPresent().then((()=>this.NH())).catch((()=>this.NH())),xt()&&(window.removeEventListener("vrdisplaypointerrestricted",this.LH),window.removeEventListener("vrdisplaypointerunrestricted",this.OH),this.MH&&(window.removeEventListener("vrdisplayconnect",this.MH),this.bH&&window.removeEventListener("vrdisplaydisconnect",this.bH),this._H&&window.removeEventListener("vrdisplaypresentchange",this._H),this.MH=null,this.bH=null))},Rs.prototype.Lw=function(t,i){if(this.LH=()=>{t&&t.requestPointerLock()},this.OH=()=>{if(i)i.exitPointerLock&&i.exitPointerLock();else{const t=this.getHostWindow();t.document&&t.document.exitPointerLock&&t.document.exitPointerLock()}},xt()){const t=this.getHostWindow();t.addEventListener("vrdisplaypointerrestricted",this.LH,!1),t.addEventListener("vrdisplaypointerunrestricted",this.OH,!1)}},Rs.prototype.tx=function(){if(this.RH&&this.RH.isPresenting)try{this.RH.submitFrame()}catch(t){ki.Warn("webVR submitFrame has had an unexpected failure: "+t)}},Rs.prototype.isVRPresenting=function(){return this.RH&&this.RH.isPresenting},Rs.prototype.ix=function(){this.Vo=Rs.QueueNewFrame(this.Go,this.RH)},dt.AddNodeConstructor("WebVRFreeCamera",((t,i)=>()=>new Lo(t,w.Zero(),i))),dt.AddNodeConstructor("WebVRGamepadCamera",((t,i)=>()=>new Lo(t,w.Zero(),i)));class Lo extends Dh{constructor(t,i,e,s={}){super(t,i,e),this.FH=s,this.BH=null,this.rawPose=null,this.UH="1.1",this._N=!1,this.VH=[],this.LG=w.Zero(),this.OG=T.Identity(),this.kH=null,this.devicePosition=w.Zero(),this.deviceRotationQuaternion=T.Identity(),this.deviceScaleFactor=1,this.kG=R.Identity(),this.GH=R.Identity(),this.controllers=[],this.onControllersAttachedObservable=new h,this.onControllerMeshLoadedObservable=new h,this.onPoseUpdatedFromDeviceObservable=new h,this.zH=!1,this.rigParenting=!0,this.HH=void 0,this.DA=Do.bind(null,this),this.XH=()=>{const t=this.getEngine().getVRDevice();t&&!t.isPresenting&&this.detachControl()},this.WH=w.Zero(),this.$H=w.One(),this.zG=R.Identity(),this.YH=new R,this.Ii.position=w.Zero(),s.defaultHeight&&(this.HH=s.defaultHeight,this.position.y=this.HH),this.minZ=.1,5===arguments.length&&(this.FH=arguments[4]),null==this.FH.trackPosition&&(this.FH.trackPosition=!0),null==this.FH.controllerMeshes&&(this.FH.controllerMeshes=!0),null==this.FH.defaultLightingOnControllers&&(this.FH.defaultLightingOnControllers=!0),this.rotationQuaternion=new T,this.FH&&this.FH.positionScale&&(this.deviceScaleFactor=this.FH.positionScale);const n=this.getEngine();this.jH=t=>{t&&this.initControllers()},n.onVRRequestPresentComplete.add(this.jH),n.initWebVR().add((t=>{t.vrDisplay&&this.BH!==t.vrDisplay&&(this.BH=t.vrDisplay,this.setCameraRigMode(hs.RIG_MODE_WEBVR,{parentCamera:this,vrDisplay:this.BH,frameData:this.KH,specs:this.UH}),this._N&&this.getEngine().enableVR(this.FH))})),"undefined"!=typeof VRFrameData&&(this.KH=new VRFrameData),s.useMultiview&&(this.getScene().getEngine().getCaps().multiview?(this.wS=!0,this.MA=new Io("VRMultiviewToSingleview",this,1)):(F.Warn("Multiview is not supported, falling back to standard rendering"),this.wS=!1)),this.getScene().onBeforeCameraRenderObservable.add((t=>{t.parent===this&&this.rigParenting&&(this.VH=this.getDescendants(!0,(t=>{const i=this.controllers.some((i=>i.fC===t)),e=-1!==this.uS.indexOf(t);return!i&&!e})),this.VH.forEach((i=>{i.parent=t})))})),this.getScene().onAfterCameraRenderObservable.add((t=>{t.parent===this&&this.rigParenting&&this.VH.forEach((t=>{t.parent=this}))}))}deviceDistanceToRoomGround(){return this.kH?(this.kH.getTranslationToRef(this.WH),this.LG.y+this.WH.y):this.HH||0}useStandingMatrix(t=(t=>{})){this.getEngine().initWebVRAsync().then((i=>{i.vrDisplay&&i.vrDisplay.stageParameters&&i.vrDisplay.stageParameters.sittingToStandingTransform&&this.FH.trackPosition?(this.kH=new R,R.FromFloat32ArrayToRefScaled(i.vrDisplay.stageParameters.sittingToStandingTransform,0,1,this.kH),this.getScene().useRightHandedSystem||this.kH&&this.kH.toggleModelMatrixHandInPlace(),t(!0)):t(!1)}))}useStandingMatrixAsync(){return new Promise((t=>{this.useStandingMatrix((i=>{t(i)}))}))}dispose(){this.XH(),this.getEngine().onVRRequestPresentComplete.removeCallback(this.jH),this.qH&&this.Kt.onBeforeRenderObservable.remove(this.qH),super.dispose()}getControllerByName(t){for(const i of this.controllers)if(i.hand===t)return i;return null}get leftController(){return this.QH||(this.QH=this.getControllerByName("left")),this.QH}get rightController(){return this.ZH||(this.ZH=this.getControllerByName("right")),this.ZH}getForwardRay(t=100){return this.leftCamera?super.getForwardRay(t,this.leftCamera.getWorldMatrix(),this.leftCamera.globalPosition):super.getForwardRay(t)}RA(){this.BH&&this.BH.isPresenting&&(this.BH.getFrameData(this.KH),this.updateFromDevice(this.KH.pose)),super.RA()}updateFromDevice(t){t&&t.orientation&&4===t.orientation.length&&(this.rawPose=t,this.OG.copyFromFloats(t.orientation[0],t.orientation[1],-t.orientation[2],-t.orientation[3]),this.getScene().useRightHandedSystem&&(this.OG.z*=-1,this.OG.w*=-1),this.FH.trackPosition&&this.rawPose.position&&(this.LG.copyFromFloats(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2]),this.getScene().useRightHandedSystem&&(this.LG.z*=-1)),this.zH=!0)}attachControl(t){t=ki.BackCompatCameraNoPreventDefault(arguments),super.attachControl(t),this._N=!0,t=!hs.ForceAttachControlToAlwaysPreventDefault&&t,this.BH&&this.getEngine().enableVR(this.FH);const i=this.Kt.getEngine().getHostWindow();i&&i.addEventListener("vrdisplaypresentchange",this.XH)}detachControl(){this.getScene().gamepadManager.onGamepadConnectedObservable.remove(this.MU),this.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this.bU),super.detachControl(),this._N=!1,this.getEngine().disableVR(),window.removeEventListener("vrdisplaypresentchange",this.XH)}getClassName(){return"WebVRFreeCamera"}resetToCurrentRotation(){this.BH.resetPose()}IA(){const t=this.uS[0],i=this.uS[1];t.rotationQuaternion.copyFrom(this.OG),i.rotationQuaternion.copyFrom(this.OG),t.position.copyFrom(this.LG),i.position.copyFrom(this.LG)}JH(t,i=!1){this.rawPose&&this.rawPose.position&&!this.FH.trackPosition&&(R.TranslationToRef(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2],this.YH),i||this.YH.invert(),this.YH.multiplyToRef(t,t))}Hi(t){this.rotationQuaternion.equals(this.Ii.rotationQuaternion)&&this.position.equals(this.Ii.position)||(this.tX||(this.tX=!0,this.update()),this.rotationQuaternion.toRotationMatrix(this.zG),w.TransformCoordinatesToRef(this.LG,this.zG,this.WH),this.devicePosition.subtractToRef(this.WH,this.WH),R.ComposeToRef(this.$H,this.rotationQuaternion,this.WH,this.kG),this.kG.getTranslationToRef(this.WH),this.WH.addInPlace(this.position),this.WH.subtractInPlace(this.Ii.position),this.kG.setTranslation(this.WH),this.kG.invertToRef(this.GH),this.controllers.forEach((t=>{t.kG.copyFrom(this.kG),this.JH(t.kG),t.update()}))),t||super.Hi(),this.tX=!1}jG(){w.TransformCoordinatesToRef(this.LG,this.kG,this.devicePosition)}update(){this.jG(),R.FromQuaternionToRef(this.OG,this.zG),this.zG.multiplyToRef(this.kG,this.zG),T.FromRotationMatrixToRef(this.zG,this.deviceRotationQuaternion),this.zH&&this.onPoseUpdatedFromDeviceObservable.notifyObservers(null),super.update()}yA(){return R.Identity()}UA(){const t=this.NA.parentCamera;t.Hi();const i=this.NA.left?this.NA.frameData.leftViewMatrix:this.NA.frameData.rightViewMatrix;return R.FromArrayToRef(i,0,this.fA),this.getScene().useRightHandedSystem||this.fA.toggleModelMatrixHandInPlace(),this.fA.getRotationMatrixToRef(this.bV),w.TransformCoordinatesToRef(this.Uk,this.bV,this.Vk),this.position.addToRef(this.Vk,this.Ok),1!==t.deviceScaleFactor&&(this.fA.invert(),t.deviceScaleFactor&&(this.fA.multiplyAtIndex(12,t.deviceScaleFactor),this.fA.multiplyAtIndex(13,t.deviceScaleFactor),this.fA.multiplyAtIndex(14,t.deviceScaleFactor)),this.fA.invert()),t.JH(this.fA,!0),t.GH.multiplyToRef(this.fA,this.fA),this.zG=this.zG||R.Identity(),this.fA.invertToRef(this.zG),this.zG.multiplyToRef(t.getWorldMatrix(),this.zG),this.zG.getTranslationToRef(this.dA),this.$i(),this.fA}BA(){const t=this.parent;t.BH.depthNear=t.minZ,t.BH.depthFar=t.maxZ;const i=this.NA.left?this.NA.frameData.leftProjectionMatrix:this.NA.frameData.rightProjectionMatrix;return R.FromArrayToRef(i,0,this.Ug),this.getScene().useRightHandedSystem||this.Ug.toggleProjectionMatrixHandInPlace(),this.Ug}initControllers(){this.controllers.length=0;const t=this.getScene().gamepadManager;this.bU=t.onGamepadDisconnectedObservable.add((t=>{if(t.type===sh.POSE_ENABLED){const i=t;i.defaultModel&&i.defaultModel.setEnabled(!1),"right"===i.hand&&(this.ZH=null),"left"===i.hand&&(this.QH=null);const e=this.controllers.indexOf(i);-1!==e&&this.controllers.splice(e,1)}})),this.MU=t.onGamepadConnectedObservable.add((t=>{if(t.type===sh.POSE_ENABLED){const i=t;if(this.FH.trackPosition||(i.$G(new w("left"==i.hand?-.15:.15,-.5,.25)),this.qH||(this.qH=this.Kt.onBeforeRenderObservable.add((()=>{this.Hi()})))),i.deviceScaleFactor=this.deviceScaleFactor,i.kG.copyFrom(this.kG),this.JH(i.kG),this.FH.controllerMeshes&&(i.defaultModel?i.defaultModel.setEnabled(!0):i.initControllerMesh(this.getScene(),(t=>{if(t.scaling.scaleInPlace(this.deviceScaleFactor),this.onControllerMeshLoadedObservable.notifyObservers(i),this.FH.defaultLightingOnControllers){this.iX||(this.iX=new Po("vrControllersLight",new w(0,1,0),this.getScene()));const i=function(t,e){const s=t.getChildren();s&&0!==s.length&&s.forEach((t=>{e.includedOnlyMeshes.push(t),i(t,e)}))};this.iX.includedOnlyMeshes.push(t),i(t,this.iX)}}))),i.attachToPoseControlledCamera(this),-1===this.controllers.indexOf(i)){this.controllers.push(i);let t=!1;for(let i=0;i<this.controllers.length;i++)this.controllers[i].controllerType===Ah.VIVE&&(t?this.controllers[i].hand="right":(t=!0,this.controllers[i].hand="left"));this.controllers.length>=2&&this.onControllersAttachedObservable.notifyObservers(this.controllers)}}}))}}class Oo extends Hh{constructor(t){super(t),this.onTriggerStateChangedObservable=new h,this.onMainButtonStateChangedObservable=new h,this.onSecondaryButtonStateChangedObservable=new h,this.onPadStateChangedObservable=new h,this.onPadValuesChangedObservable=new h,this.pad={x:0,y:0},this.eX={pressChanged:!1,touchChanged:!1,valueChanged:!1,changed:!1},this.wU=new Array(t.buttons.length),this.hand=t.hand}onButtonStateChange(t){this.sX=t}get defaultModel(){return this.nX}update(){super.update();for(let t=0;t<this.wU.length;t++)this.RU(this.browserGamepad.buttons[t],this.wU[t],t);this.leftStick.x===this.pad.x&&this.leftStick.y===this.pad.y||(this.pad.x=this.leftStick.x,this.pad.y=this.leftStick.y,this.onPadValuesChangedObservable.notifyObservers(this.pad))}RU(t,i,e){t||(t={pressed:!1,touched:!1,value:0}),i?(this.rX(t,i),this.eX.changed&&(this.sX&&this.sX(this.index,e,t),this.hX(e,t,this.eX)),this.wU[e].pressed=t.pressed,this.wU[e].touched=t.touched,this.wU[e].value=t.value<1e-8?0:t.value):this.wU[e]={pressed:t.pressed,touched:t.touched,value:t.value}}rX(t,i){return this.eX.pressChanged=t.pressed!==i.pressed,this.eX.touchChanged=t.touched!==i.touched,this.eX.valueChanged=t.value!==i.value,this.eX.changed=this.eX.pressChanged||this.eX.touchChanged||this.eX.valueChanged,this.eX}dispose(){super.dispose(),this.nX=null,this.onTriggerStateChangedObservable.clear(),this.onMainButtonStateChangedObservable.clear(),this.onSecondaryButtonStateChangedObservable.clear(),this.onPadStateChangedObservable.clear(),this.onPadValuesChangedObservable.clear()}}class Fo{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(t){t.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(t){}bindForSubMesh(t,i,e,s,n){if(i.prePassRenderer&&i.prePassRenderer.enabled&&i.prePassRenderer.currentRTisSceneRT&&-1!==i.prePassRenderer.getIndex(2)){this.previousWorldMatrices[e.uniqueId]||(this.previousWorldMatrices[e.uniqueId]=s.clone()),this.previousViewProjection||(this.previousViewProjection=i.getTransformMatrix().clone(),this.currentViewProjection=i.getTransformMatrix().clone());const n=i.getEngine();this.currentViewProjection.updateFlag!==i.getTransformMatrix().updateFlag?(this.oX=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(i.getTransformMatrix())):this.oX!==n.frameId&&(this.oX=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),t.setMatrix("previousWorld",this.previousWorldMatrices[e.uniqueId]),t.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[e.uniqueId]=s.clone()}}}class Bo{static get DiffuseTextureEnabled(){return this.aX}static set DiffuseTextureEnabled(t){this.aX!==t&&(this.aX=t,Rs.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this.lX}static set DetailTextureEnabled(t){this.lX!==t&&(this.lX=t,Rs.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this.cX}static set AmbientTextureEnabled(t){this.cX!==t&&(this.cX=t,Rs.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this.uX}static set OpacityTextureEnabled(t){this.uX!==t&&(this.uX=t,Rs.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this.fX}static set ReflectionTextureEnabled(t){this.fX!==t&&(this.fX=t,Rs.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this.dX}static set EmissiveTextureEnabled(t){this.dX!==t&&(this.dX=t,Rs.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this.pX}static set SpecularTextureEnabled(t){this.pX!==t&&(this.pX=t,Rs.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this.mX}static set BumpTextureEnabled(t){this.mX!==t&&(this.mX=t,Rs.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this.vX}static set LightmapTextureEnabled(t){this.vX!==t&&(this.vX=t,Rs.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this.gX}static set RefractionTextureEnabled(t){this.gX!==t&&(this.gX=t,Rs.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this.SX}static set ColorGradingTextureEnabled(t){this.SX!==t&&(this.SX=t,Rs.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this.EX}static set FresnelEnabled(t){this.EX!==t&&(this.EX=t,Rs.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this.AX}static set ClearCoatTextureEnabled(t){this.AX!==t&&(this.AX=t,Rs.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this.CX}static set ClearCoatBumpTextureEnabled(t){this.CX!==t&&(this.CX=t,Rs.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this.wX}static set ClearCoatTintTextureEnabled(t){this.wX!==t&&(this.wX=t,Rs.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this.xX}static set SheenTextureEnabled(t){this.xX!==t&&(this.xX=t,Rs.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this.TX}static set AnisotropicTextureEnabled(t){this.TX!==t&&(this.TX=t,Rs.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this.RX}static set ThicknessTextureEnabled(t){this.RX!==t&&(this.RX=t,Rs.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this.RX}static set RefractionIntensityTextureEnabled(t){this.IX!==t&&(this.IX=t,Rs.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this.RX}static set TranslucencyIntensityTextureEnabled(t){this.MX!==t&&(this.MX=t,Rs.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this.bX}static set IridescenceTextureEnabled(t){this.bX!==t&&(this.bX=t,Rs.MarkAllMaterialsAsDirty(1))}}Bo.aX=!0,Bo.lX=!0,Bo.cX=!0,Bo.uX=!0,Bo.fX=!0,Bo.dX=!0,Bo.pX=!0,Bo.mX=!0,Bo.vX=!0,Bo.gX=!0,Bo.SX=!0,Bo.EX=!0,Bo.AX=!0,Bo.CX=!0,Bo.wX=!0,Bo.xX=!0,Bo.TX=!0,Bo.RX=!0,Bo.IX=!0,Bo.MX=!0,Bo.bX=!0;const Uo="defaultFragmentDeclaration",Vo="uniform vec4 vEyePosition;\nuniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;\nuniform vec3 vAmbientColor;\nuniform float visibility;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#ifdef ALPHATEST\nuniform float alphaCutOff;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;\nuniform vec4 refractionRightColor;\n#endif\n#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)\nuniform vec3 vRefractionPosition;\nuniform vec3 vRefractionSize; \n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;\nuniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)\nuniform mat4 reflectionMatrix;\n#endif\n#ifndef REFLECTIONMAP_SKYBOX\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;\nuniform vec4 reflectionRightColor;\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";ii.IncludesShadersStore[Uo]=Vo;const ko="sceneUboDeclaration",Go="layout(std140,column_major) uniform;\nuniform Scene {\nmat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nmat4 view;\nmat4 projection;\nvec4 vEyePosition;\n};\n";ii.IncludesShadersStore[ko]=Go;const zo="meshUboDeclaration",Ho="#ifdef WEBGL2\nuniform mat4 world;\nuniform float visibility;\n#else\nlayout(std140,column_major) uniform;\nuniform Mesh\n{\nmat4 world;\nfloat visibility;\n};\n#endif\n#define WORLD_UBO\n";ii.IncludesShadersStore[zo]=Ho;const Xo="defaultUboDeclaration",Wo="layout(std140,column_major) uniform;\nuniform Material\n{\nvec4 diffuseLeftColor;\nvec4 diffuseRightColor;\nvec4 opacityParts;\nvec4 reflectionLeftColor;\nvec4 reflectionRightColor;\nvec4 refractionLeftColor;\nvec4 refractionRightColor;\nvec4 emissiveLeftColor;\nvec4 emissiveRightColor;\nvec2 vDiffuseInfos;\nvec2 vAmbientInfos;\nvec2 vOpacityInfos;\nvec2 vReflectionInfos;\nvec3 vReflectionPosition;\nvec3 vReflectionSize;\nvec2 vEmissiveInfos;\nvec2 vLightmapInfos;\nvec2 vSpecularInfos;\nvec3 vBumpInfos;\nmat4 diffuseMatrix;\nmat4 ambientMatrix;\nmat4 opacityMatrix;\nmat4 reflectionMatrix;\nmat4 emissiveMatrix;\nmat4 lightmapMatrix;\nmat4 specularMatrix;\nmat4 bumpMatrix;\nvec2 vTangentSpaceParams;\nfloat pointSize;\nfloat alphaCutOff;\nmat4 refractionMatrix;\nvec4 vRefractionInfos;\nvec3 vRefractionPosition;\nvec3 vRefractionSize;\nvec4 vSpecularColor;\nvec3 vEmissiveColor;\nvec4 vDiffuseColor;\nvec3 vAmbientColor;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";ii.IncludesShadersStore[Xo]=Wo;const $o="prePassDeclaration",Yo="#ifdef PREPASS\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;\n#ifdef PREPASS_DEPTH\nvarying highp vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nvarying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;\n#endif\n#endif\n";ii.IncludesShadersStore[$o]=Yo;const jo="oitDeclaration",Ko="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out vec2 depth; \nlayout(location=1) out vec4 frontColor;\nlayout(location=2) out vec4 backColor;\n#define MAX_DEPTH 99999.0\nhighp vec4 gl_FragColor;\nuniform sampler2D oitDepthSampler;\nuniform sampler2D oitFrontColorSampler;\n#endif\n";ii.IncludesShadersStore[jo]=Ko;const qo="mainUVVaryingDeclaration",Qo="#ifdef MAINUV{X}\nvarying vec2 vMainUV{X};\n#endif\n";ii.IncludesShadersStore[qo]=Qo;const Zo="helperFunctions",Jo="const float PI=3.1415926535897932384626433832795;\nconst float HALF_MIN=5.96046448e-08; \nconst float LinearEncodePowerApprox=2.2;\nconst float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;\nconst vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);\nconst float Epsilon=0.0000001;\n#define saturate(x) clamp(x,0.0,1.0)\n#define absEps(x) abs(x)+Epsilon\n#define maxEps(x) max(x,Epsilon)\n#define saturateEps(x) clamp(x,Epsilon,1.0)\nmat3 transposeMat3(mat3 inMatrix) {\nvec3 i0=inMatrix[0];\nvec3 i1=inMatrix[1];\nvec3 i2=inMatrix[2];\nmat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);\nreturn outMatrix;\n}\nmat3 inverseMat3(mat3 inMatrix) {\nfloat a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];\nfloat a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];\nfloat a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];\nfloat b01=a22*a11-a12*a21;\nfloat b11=-a22*a10+a12*a20;\nfloat b21=a21*a10-a11*a20;\nfloat det=a00*b01+a01*b11+a02*b21;\nreturn mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;\n}\n#if USE_EXACT_SRGB_CONVERSIONS\nvec3 toLinearSpaceExact(vec3 color)\n{\nvec3 nearZeroSection=0.0773993808*color;\nvec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));\n#else\nreturn\nvec3(\ncolor.r<=0.04045 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.04045 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.04045 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\nvec3 toGammaSpaceExact(vec3 color)\n{\nvec3 nearZeroSection=12.92*color;\nvec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));\n#else\nreturn\nvec3(\ncolor.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\n#endif\nfloat toLinearSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=0.0773993808*color;\nfloat remainingSection=pow(0.947867299*(color+0.055),2.4);\nreturn color<=0.04045 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nvec3 toLinearSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3(LinearEncodePowerApprox));\n#endif\n}\nvec4 toLinearSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfloat toGammaSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=12.92*color;\nfloat remainingSection=1.055*pow(color,0.41666)-0.055;\nreturn color<=0.0031308 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,GammaEncodePowerApprox);\n#endif\n}\nvec3 toGammaSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3(GammaEncodePowerApprox));\n#endif\n}\nvec4 toGammaSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfloat square(float value)\n{\nreturn value*value;\n}\nvec3 square(vec3 value)\n{\nreturn value*value;\n}\nfloat pow5(float value) {\nfloat sq=value*value;\nreturn sq*sq*value;\n}\nfloat getLuminance(vec3 color)\n{\nreturn clamp(dot(color,LuminanceEncodeApprox),0.,1.);\n}\nfloat getRand(vec2 seed) {\nreturn fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);\n}\nfloat dither(vec2 seed,float varianceAmount) {\nfloat rand=getRand(seed);\nfloat normVariance=varianceAmount/255.0;\nfloat dither=mix(-normVariance,normVariance,rand);\nreturn dither;\n}\nconst float rgbdMaxRange=255.0;\nvec4 toRGBD(vec3 color) {\nfloat maxRGB=maxEps(max(color.r,max(color.g,color.b)));\nfloat D =max(rgbdMaxRange/maxRGB,1.);\nD =clamp(floor(D)/255.0,0.,1.);\nvec3 rgb=color.rgb*D;\nrgb=toGammaSpace(rgb);\nreturn vec4(clamp(rgb,0.,1.),D); \n}\nvec3 fromRGBD(vec4 rgbd) {\nrgbd.rgb=toLinearSpace(rgbd.rgb);\nreturn rgbd.rgb/rgbd.a;\n}\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {\nvec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;\nvec3 halfSize=cubeSize*0.5;\nvec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;\nvec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;\nvec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);\nfloat distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);\nvec3 intersectPositionWS=vertexPos+origVec*distance;\nreturn intersectPositionWS-cubePos;\n}\n";ii.IncludesShadersStore[Zo]=Jo;const ta="lightFragmentDeclaration",ia="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float cascadeBlendFactor{X};\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\nuniform highp sampler2DArray depthSampler{X};\nuniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);\nvec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X};\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\nuniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#endif\n";ii.IncludesShadersStore[ta]=ia;const ea="lightUboDeclaration",sa="#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\nvec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float cascadeBlendFactor{X};\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\nuniform highp sampler2DArray depthSampler{X};\nuniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);\nvec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X}; \n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";ii.IncludesShadersStore[ea]=sa;const na="lightsFragmentFunctions",ra="struct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 lightVectorW;\nfloat attenuation=1.0;\nif (lightData.w==0.)\n{\nvec3 direction=lightData.xyz-vPositionW;\nattenuation=max(0.,1.0-length(direction)/range);\nlightVectorW=normalize(direction);\n}\nelse\n{\nlightVectorW=normalize(-lightData.xyz);\n}\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 direction=lightData.xyz-vPositionW;\nvec3 lightVectorW=normalize(direction);\nfloat attenuation=max(0.,1.0-length(direction)/range);\nfloat cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));\nif (cosAngle>=lightDirection.w)\n{\ncosAngle=max(0.,pow(cosAngle,lightData.w));\nattenuation*=cosAngle;\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {\nlightingInfo result;\nfloat ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor;\n#endif\nreturn result;\n}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\nreturn textureColor;\n}";ii.IncludesShadersStore[na]=ra;const ha="shadowsFragmentFunctions",oa="#ifdef SHADOWS\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{\nfloat mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));\nreturn mix(value,1.0,mask);\n}\n#define inline\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nreturn depth>shadow ? darkness : 1.0;\n}\n#define inline\nfloat computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\n#define inline\nfloat computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); \nreturn esm;\n}\n#define inline\nfloat computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn esm;\n}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define inline\nfloat computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nvec3 uvLayer=vec3(uv.x,uv.y,layer);\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uvLayer));\n#else\nfloat shadow=texture2D(shadowSampler,uvLayer).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;\n}\n#endif\n#define inline\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;\n}\n}\n#define inline\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\n#else\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#ifdef IS_NDC_HALF_ZRANGE\n#define ZINCLIP clipSpace.z\n#else\n#define ZINCLIP uvDepth.z\n#endif\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define GREATEST_LESS_THAN_ONE 0.99999994\n#define inline\nfloat computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);\nfloat shadow=texture2D(shadowSampler,uvDepthLayer);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;\nvec2 uvw1=1.+2.*st;\nvec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;\nvec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));\nshadow=shadow/16.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;\nvec2 uvw1=vec2(7.);\nvec2 uvw2=1.+3.*st;\nvec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;\nvec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));\nshadow=shadow/144.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nfloat shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;\nvec2 uvw1=1.+2.*st;\nvec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;\nvec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);\nshadow=shadow/16.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;\nvec2 uvw1=vec2(7.);\nvec2 uvw2=1.+3.*st;\nvec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;\nvec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);\nshadow=shadow/144.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.)\n);\nconst vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n#define inline\nfloat computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);\nfloat blockerDepth=0.0;\nfloat sumBlockerDepth=0.0;\nfloat numBlocker=0.0;\nfor (int i=0; i<searchTapCount; i ++) {\nblockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;\nif (blockerDepth<depthMetric) {\nsumBlockerDepth+=blockerDepth;\nnumBlocker++;\n}\n}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;\nfloat AAOffset=shadowMapSizeInverse*10.;\nfloat penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);\nvec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);\nfloat random=getRand(vPositionFromLight.xy);\nfloat rotationAngle=random*3.1415926;\nvec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));\nfloat shadow=0.;\nfor (int i=0; i<pcfTapCount; i++) {\nvec4 offset=vec4(poissonSamplers[i],0.);\noffset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);\nshadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);\n}\nshadow/=float(pcfTapCount);\nshadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));\nshadow=mix(darkness,1.,shadow);\nif (numBlocker<1.0) {\nreturn 1.0;\n}\nelse\n{\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nfloat blockerDepth=0.0;\nfloat sumBlockerDepth=0.0;\nfloat numBlocker=0.0;\nfor (int i=0; i<searchTapCount; i ++) {\nblockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;\nif (blockerDepth<depthMetric) {\nsumBlockerDepth+=blockerDepth;\nnumBlocker++;\n}\n}\nif (numBlocker<1.0) {\nreturn 1.0;\n}\nelse\n{\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;\nfloat AAOffset=shadowMapSizeInverse*10.;\nfloat penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);\nfloat filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;\nfloat random=getRand(vPositionFromLight.xy);\nfloat rotationAngle=random*3.1415926;\nvec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));\nfloat shadow=0.;\nfor (int i=0; i<pcfTapCount; i++) {\nvec3 offset=poissonSamplers[i];\noffset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);\nshadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);\n}\nshadow/=float(pcfTapCount);\nshadow=mix(shadow,1.,depthMetric-avgBlockerDepth);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n}\n#define inline\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);\n}\n#define inline\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);\n}\n#define inline\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);\n}\n#define inline\nfloat computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#define inline\nfloat computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#define inline\nfloat computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#endif\n#endif\n";ii.IncludesShadersStore[ha]=oa;const aa="samplerFragmentDeclaration",la="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\nuniform sampler2D _SAMPLERNAME_Sampler;\n#endif\n";ii.IncludesShadersStore[aa]=la;const ca="fresnelFunction",ua="#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{\nfloat fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);\nreturn clamp(fresnelTerm,0.,1.);\n}\n#endif\n";ii.IncludesShadersStore[ca]=ua;const fa="reflectionFunction",da="vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{\nfloat lon=atan(direction.z,direction.x);\nfloat lat=acos(direction.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(s,t,0); \n}\nvec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{\nfloat lon=atan(direction.z,direction.x);\nfloat lat=acos(direction.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(1.0-s,t,0); \n}\nvec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);\nvec3 r=normalize(reflect(cameraToVertex,worldNormal));\nr=vec3(reflectionMatrix*vec4(r,0));\nfloat lon=atan(r.z,r.x);\nfloat lat=acos(r.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(s,t,0);\n}\nvec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)\n{\nvec3 viewDir=normalize(vec3(view*worldPos));\nvec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));\nvec3 r=reflect(viewDir,viewNormal);\nr=vec3(reflectionMatrix*vec4(r,0));\nr.z=r.z-1.0;\nfloat m=2.0*length(r);\nreturn vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);\n}\nvec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 viewDir=worldPos.xyz-eyePosition;\nvec3 coords=normalize(reflect(viewDir,worldNormal));\nreturn vec3(reflectionMatrix*vec4(coords,1));\n}\nvec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 viewDir=normalize(worldPos.xyz-eyePosition);\nvec3 coords=reflect(viewDir,worldNormal);\ncoords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;\n}\nvec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)\n{\nvec3 viewDir=normalize(worldPos.xyz-eyePosition);\nvec3 coords=reflect(viewDir,worldNormal);\ncoords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);\ncoords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;\n}\nvec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)\n{\nreturn vec3(reflectionMatrix*(view*worldPos));\n}\nvec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)\n{\nreturn vec3(reflectionMatrix*vec4(positionW,1.));\n}\n#ifdef REFLECTION\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);\nreturn computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);\nreturn computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(vPositionUVW,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}\n#endif\n";ii.IncludesShadersStore[fa]=da;const pa="imageProcessingDeclaration",ma="#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vec2 vInverseScreenSize;\n#endif\n#ifdef VIGNETTE\nuniform vec4 vignetteSettings1;\nuniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;\nuniform vec4 vCameraColorCurveNeutral;\nuniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif\n#ifdef DITHER\nuniform float ditherIntensity;\n#endif\n";ii.IncludesShadersStore[pa]=ma;const va="imageProcessingFunctions",ga="#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n/** \n* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.\n* sampler3dSetting.x=textureOffset (0.5/textureSize).\n* sampler3dSetting.y=textureSize.\n*/\n#define inline\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{\nfloat sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);\nfloat sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;\nsliceUV.x+=sliceInteger*sliceSize;\nsliceUV=saturate(sliceUV);\nvec4 slice0Color=texture2D(colorTransform,sliceUV);\nsliceUV.x+=sliceSize;\nsliceUV=saturate(sliceUV);\nvec4 slice1Color=texture2D(colorTransform,sliceUV);\nvec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;\n}\n#endif\n#ifdef TONEMAPPING_ACES\nconst mat3 ACESInputMat=mat3(\nvec3(0.59719,0.07600,0.02840),\nvec3(0.35458,0.90834,0.13383),\nvec3(0.04823,0.01566,0.83777)\n);\nconst mat3 ACESOutputMat=mat3(\nvec3( 1.60475,-0.10208,-0.00327),\nvec3(-0.53108, 1.10813,-0.07276),\nvec3(-0.07367,-0.00605, 1.07602)\n);\nvec3 RRTAndODTFit(vec3 v)\n{\nvec3 a=v*(v+0.0245786)-0.000090537;\nvec3 b=v*(0.983729*v+0.4329510)+0.238081;\nreturn a/b;\n}\nvec3 ACESFitted(vec3 color)\n{\ncolor=ACESInputMat*color;\ncolor=RRTAndODTFit(color);\ncolor=ACESOutputMat*color;\ncolor=saturate(color);\nreturn color;\n}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nvec4 applyImageProcessing(vec4 result) {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;\nviewportXY=viewportXY*2.0-1.0;\nvec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);\nfloat vignetteTerm=dot(vignetteXY1,vignetteXY1);\nfloat vignette=pow(vignetteTerm,vignetteSettings2.w);\nvec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);\nresult.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#ifdef TONEMAPPING\n#ifdef TONEMAPPING_ACES\nresult.rgb=ACESFitted(result.rgb);\n#else\nconst float tonemappingCalibration=1.590579;\nresult.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\n#endif\nresult.rgb=toGammaSpace(result.rgb);\nresult.rgb=saturate(result.rgb);\n#ifdef CONTRAST\nvec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);\nif (contrast<1.0) {\nresult.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);\n} else {\nresult.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);\n}\n#endif\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nfloat luma=getLuminance(result.rgb);\nvec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));\nvec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;\nresult.rgb*=colorCurve.rgb;\nresult.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nfloat rand=getRand(gl_FragCoord.xy*vInverseScreenSize);\nfloat dither=mix(-ditherIntensity,ditherIntensity,rand);\nresult.rgb=saturate(result.rgb+vec3(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn result;\n}";ii.IncludesShadersStore[va]=ga;const Sa="bumpFragmentMainFunctions",Ea="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#endif\nvec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)\n{\n#ifdef NORMALXYSCALE\nnormal=normalize(normal*vec3(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*normal);\n}\nvec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)\n{\nreturn perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);\n}\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)\n{\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\nvec3 dp2perp=cross(dp2,normal);\nvec3 dp1perp=cross(normal,dp1);\nvec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;\ntangent*=tangentSpaceParams.x;\nbitangent*=tangentSpaceParams.y;\nfloat det=max(dot(tangent,tangent),dot(bitangent,bitangent));\nfloat invmax=det==0.0 ? 0.0 : inversesqrt(det);\nreturn mat3(tangent*invmax,bitangent*invmax,normal);\n}\n#endif\n";ii.IncludesShadersStore[Sa]=Ea;const Aa="bumpFragmentFunctions",Ca="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst float minSamples=4.;\nconst float maxSamples=15.;\nconst int iMaxSamples=15;\nvec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {\nfloat parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;\nparallaxLimit*=parallaxScale;\nvec2 vOffsetDir=normalize(vViewDirCoT.xy);\nvec2 vMaxOffset=vOffsetDir*parallaxLimit;\nfloat numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));\nfloat stepSize=1.0/numSamples;\nfloat currRayHeight=1.0;\nvec2 vCurrOffset=vec2(0,0);\nvec2 vLastOffset=vec2(0,0);\nfloat lastSampledHeight=1.0;\nfloat currSampledHeight=1.0;\nbool keepWorking=true;\nfor (int i=0; i<iMaxSamples; i++)\n{\ncurrSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;\nif (!keepWorking)\n{\n}\nelse if (currSampledHeight>currRayHeight)\n{\nfloat delta1=currSampledHeight-currRayHeight;\nfloat delta2=(currRayHeight+stepSize)-lastSampledHeight;\nfloat ratio=delta1/(delta1+delta2);\nvCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;\nkeepWorking=false;\n}\nelse\n{\ncurrRayHeight-=stepSize;\nvLastOffset=vCurrOffset;\nvCurrOffset+=stepSize*vMaxOffset;\nlastSampledHeight=currSampledHeight;\n}\n}\nreturn vCurrOffset;\n}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{\nfloat height=texture2D(bumpSampler,vBumpUV).w;\nvec2 texCoordOffset=heightScale*viewDir.xy*height;\nreturn -texCoordOffset;\n}\n#endif\n";ii.IncludesShadersStore[Aa]=Ca;const wa="clipPlaneFragmentDeclaration",xa="#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nvarying float fClipDistance6;\n#endif\n";ii.IncludesShadersStore[wa]=xa;const Ta="logDepthDeclaration",Ra="#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;\nvarying float vFragmentDepth;\n#endif\n";ii.IncludesShadersStore[Ta]=Ra;const Ia="fogFragmentDeclaration",Ma="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying vec3 vFogDistance;\nfloat CalcFogFactor()\n{\nfloat fogCoeff=1.0;\nfloat fogStart=vFogInfos.y;\nfloat fogEnd=vFogInfos.z;\nfloat fogDensity=vFogInfos.w;\nfloat fogDistance=length(vFogDistance);\nif (FOGMODE_LINEAR==vFogInfos.x)\n{\nfogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);\n}\nelse if (FOGMODE_EXP==vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDensity);\n}\nelse if (FOGMODE_EXP2==vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);\n}\nreturn clamp(fogCoeff,0.0,1.0);\n}\n#endif\n";ii.IncludesShadersStore[Ia]=Ma;const ba="clipPlaneFragment",_a="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE2\nelse if (fClipDistance2>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE3\nelse if (fClipDistance3>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE4\nelse if (fClipDistance4>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE5\nelse if (fClipDistance5>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE6\nelse if (fClipDistance6>0.0)\n{\ndiscard;\n}\n#endif\n";ii.IncludesShadersStore[ba]=_a;const ya="bumpFragment",Na="vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#elif defined(BUMP)\nfloat normalScale=vBumpInfos.y;\n#else\nfloat normalScale=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#elif defined(BUMP)\nvec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);\n#else\nvec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nvec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;\nmat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);\nvec2 detailNormalRG=detailColor.wy*2.0-1.0;\nfloat detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));\nvec3 detailNormal=vec3(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);\nnormalW=normalize(mat3(normalMatrix)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);\n#else\nvec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal.xy*=vDetailInfos.z;\nvec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal.xy*=vDetailInfos.z;\nbumpNormal+=vec3(0.0,0.0,1.0);\ndetailNormal*=vec3(-1.0,-1.0,1.0);\nvec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal.xy*=vDetailInfos.z;\nnormalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);\n#endif\n";ii.IncludesShadersStore[ya]=Na;const Pa="depthPrePass",Da="#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);\nreturn;\n#endif\n";ii.IncludesShadersStore[Pa]=Da;const La="lightFragment",Oa="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\n#ifdef PBR\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\npreInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\npreInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\npreInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\npreInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#ifdef HEMILIGHT{X}\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);\n#elif defined(SS_TRANSLUCENCY)\ninfo.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef SPECULARTERM\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#endif\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);\ninfo.diffuse*=absorption;\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) \n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;\n#else\ndiff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {\nindex{X}=i;\nbreak;\n}\n}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nfloat frustumLength=frustumLengths{X}[index{X}];\nfloat diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};\nif (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{\nindex{X}+=1;\nfloat nextShadow=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;\nshadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else \ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n";ii.IncludesShadersStore[La]=Oa;const Fa="logDepthFragment",Ba="#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif\n";ii.IncludesShadersStore[Fa]=Ba;const Ua="fogFragment",Va="#ifdef FOG\nfloat fog=CalcFogFactor();\n#ifdef PBR\nfog=toLinearSpace(fog);\n#endif\ncolor.rgb=mix(vFogColor,color.rgb,fog);\n#endif\n";ii.IncludesShadersStore[Ua]=Va;const ka="oitFragment",Ga="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\nfloat fragDepth=gl_FragCoord.z; \n#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS\nuint halfFloat=packHalf2x16(vec2(fragDepth));\nvec2 full=unpackHalf2x16(halfFloat);\nfragDepth=full.x;\n#endif\nivec2 fragCoord=ivec2(gl_FragCoord.xy);\nvec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;\nvec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);\ndepth.rg=vec2(-MAX_DEPTH);\nfrontColor=lastFrontColor;\nbackColor=vec4(0.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nfloat furthestDepth=-lastDepth.x;\nfloat nearestDepth=lastDepth.y;\n#else\nfloat nearestDepth=-lastDepth.x;\nfloat furthestDepth=lastDepth.y;\n#endif\nfloat alphaMultiplier=1.0-lastFrontColor.a;\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth>nearestDepth || fragDepth<furthestDepth) {\n#else\nif (fragDepth<nearestDepth || fragDepth>furthestDepth) {\n#endif\nreturn;\n}\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth<nearestDepth && fragDepth>furthestDepth) {\n#else\nif (fragDepth>nearestDepth && fragDepth<furthestDepth) {\n#endif\ndepth.rg=vec2(-fragDepth,fragDepth);\nreturn;\n}\n#endif\n";ii.IncludesShadersStore[ka]=Ga;const za="defaultPixelShader",Ha="#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#define RECIPROCAL_PI2 0.15915494\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\nvec4 baseColor=vec4(1.,1.,1.,1.);\nvec3 diffuseColor=vDiffuseColor.rgb;\nfloat alpha=vDiffuseColor.a;\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<alphaCutOff)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor.rgb*=vColor.rgb;\n#endif\n#ifdef DETAIL\nbaseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;\nvec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);\nspecularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);\nlightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;\n#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\nvec4 refractionColor=vec4(0.,0.,0.,1.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nif (dot(refractionVector,viewDirectionW)<1.0) {\nrefractionColor=textureCube(refractionCubeSampler,refractionVector);\n}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\nrefractionColor=texture2D(refraction2DSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor.rgb=fromRGBD(refractionColor);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor.rgb=toGammaSpace(refractionColor.rgb);\n#endif\nrefractionColor.rgb*=vRefractionInfos.x;\n#endif\nvec4 reflectionColor=vec4(0.,0.,0.,1.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\nreflectionColor=texture2D(reflection2DSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor.rgb=toGammaSpace(reflectionColor.rgb);\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);\nrefractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<alphaCutOff)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nemissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);\ndiffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor.rgb;\n#else\ncolor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);\ncolor=applyImageProcessing(color);\n#endif\n#endif\ncolor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;\ngl_FragData[0]=color; \n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;\nvec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;\nvec2 velocity=abs(a-b);\nvelocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;\ngl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_NORMAL\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4((view*vec4(normalW,0.0)).rgb,writeGeometryInfo); \n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULARTERM)\n#if defined(SPECULAR)\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularMapColor)*writeGeometryInfo; \n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularColor,1.0)*writeGeometryInfo;\n#endif\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {\nfrontColor.rgb+=color.rgb*color.a*alphaMultiplier;\nfrontColor.a=1.0-alphaMultiplier*(1.0-color.a);\n} else {\nbackColor+=color;\n}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";ii.ShadersStore[za]=Ha;const Xa="defaultVertexDeclaration",Wa="uniform mat4 viewProjection;\nuniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef REFLECTION\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\nuniform mat4 detailMatrix;\n#endif\n#define ADDITIONAL_VERTEX_DECLARATION\n";ii.IncludesShadersStore[Xa]=Wa;const $a="uvAttributeDeclaration",Ya="#ifdef UV{X}\nattribute vec2 uv{X};\n#endif\n";ii.IncludesShadersStore[$a]=Ya;const ja="bonesDeclaration",Ka="#if NUM_BONE_INFLUENCERS>0\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;\nattribute vec4 matricesWeightsExtra;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nuniform sampler2D boneSampler;\nuniform float boneTextureWidth;\n#else\nuniform mat4 mBones[BonesPerMesh];\n#ifdef BONES_VELOCITY_ENABLED\nuniform mat4 mPreviousBones[BonesPerMesh];\n#endif\n#endif\n#ifdef BONETEXTURE\n#define inline\nmat4 readMatrixFromRawSampler(sampler2D smp,float index)\n{\nfloat offset=index *4.0;\nfloat dx=1.0/boneTextureWidth;\nvec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));\nvec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));\nvec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));\nvec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));\nreturn mat4(m0,m1,m2,m3);\n}\n#endif\n#endif\n#endif\n";ii.IncludesShadersStore[ja]=Ka;const qa="bakedVertexAnimationDeclaration",Qa="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform float bakedVertexAnimationTime;\nuniform vec2 bakedVertexAnimationTextureSizeInverted;\nuniform vec4 bakedVertexAnimationSettings;\nuniform sampler2D bakedVertexAnimationTexture;\n#ifdef INSTANCES\nattribute vec4 bakedVertexAnimationSettingsInstanced;\n#endif\n#define inline\nmat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)\n{\nfloat offset=index*4.0;\nfloat frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;\nfloat dx=bakedVertexAnimationTextureSizeInverted.x;\nvec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));\nvec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));\nvec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));\nvec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));\nreturn mat4(m0,m1,m2,m3);\n}\n#endif\n";ii.IncludesShadersStore[qa]=Qa;const Za="instancesDeclaration",Ja="#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#ifdef INSTANCESCOLOR\nattribute vec4 instanceColor;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nattribute vec4 previousWorld0;\nattribute vec4 previousWorld1;\nattribute vec4 previousWorld2;\nattribute vec4 previousWorld3;\n#ifdef THIN_INSTANCES\nuniform mat4 previousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nuniform mat4 previousWorld;\n#endif\n#endif\n";ii.IncludesShadersStore[Za]=Ja;const tl="prePassVertexDeclaration",il="#ifdef PREPASS\n#ifdef PREPASS_DEPTH\nvarying vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nuniform mat4 previousViewProjection;\nvarying vec4 vCurrentPosition;\nvarying vec4 vPreviousPosition;\n#endif\n#endif\n";ii.IncludesShadersStore[tl]=il;const el="samplerVertexDeclaration",sl="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n";ii.IncludesShadersStore[el]=sl;const nl="bumpVertexDeclaration",rl="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n";ii.IncludesShadersStore[nl]=rl;const hl="clipPlaneVertexDeclaration",ol="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;\nvarying float fClipDistance6;\n#endif\n";ii.IncludesShadersStore[hl]=ol;const al="fogVertexDeclaration",ll="#ifdef FOG\nvarying vec3 vFogDistance;\n#endif\n";ii.IncludesShadersStore[al]=ll;const cl="lightVxFragmentDeclaration",ul="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\nuniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#endif\n";ii.IncludesShadersStore[cl]=ul;const fl="lightVxUboDeclaration",dl="#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\nvec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";ii.IncludesShadersStore[fl]=dl;const pl="morphTargetsVertexGlobalDeclaration",ml="#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#ifdef MORPHTARGETS_TEXTURE \nprecision mediump sampler2DArray; \nuniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];\nuniform vec3 morphTargetTextureInfo;\nuniform sampler2DArray morphTargets;\nvec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)\n{ \nfloat y=floor(vertexIndex/morphTargetTextureInfo.y);\nfloat x=vertexIndex-y*morphTargetTextureInfo.y;\nvec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);\nreturn texture(morphTargets,textureUV).xyz;\n}\n#endif\n#endif\n";ii.IncludesShadersStore[pl]=ml;const vl="morphTargetsVertexDeclaration",gl="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute vec3 position{X};\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#ifdef MORPHTARGETS_UV\nattribute vec2 uv_{X};\n#endif\n#endif\n#endif\n";ii.IncludesShadersStore[vl]=gl;const Sl="morphTargetsVertexGlobal",El="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nfloat vertexID;\n#endif\n#endif\n";ii.IncludesShadersStore[Sl]=El;const Al="morphTargetsVertex",Cl="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE \nvertexID=float(gl_VertexID)*morphTargetTextureInfo.x;\npositionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#else\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";ii.IncludesShadersStore[Al]=Cl;const wl="instancesVertex",xl="#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\nfinalWorld=world*finalWorld;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\nmat4 finalWorld=world;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=previousWorld;\n#endif\n#endif\n";ii.IncludesShadersStore[wl]=xl;const Tl="bonesVertex",Rl="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];\n#endif\n#else\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";ii.IncludesShadersStore[Tl]=Rl;const Il="bakedVertexAnimation",Ml="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\n#define BVASNAME bakedVertexAnimationSettingsInstanced\n#else\n#define BVASNAME bakedVertexAnimationSettings\n#endif\nfloat VATStartFrame=BVASNAME.x;\nfloat VATEndFrame=BVASNAME.y;\nfloat VATOffsetFrame=BVASNAME.z;\nfloat VATSpeed=BVASNAME.w;\nfloat totalFrames=VATEndFrame-VATStartFrame+1.0;\nfloat time=bakedVertexAnimationTime*VATSpeed/totalFrames;\nfloat frameCorrection=time<1.0 ? 0.0 : 1.0;\nfloat numOfFrames=totalFrames-frameCorrection;\nfloat VATFrameNum=fract(time)*numOfFrames;\nVATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);\nVATFrameNum=floor(VATFrameNum);\nVATFrameNum+=VATStartFrame+frameCorrection;\nmat4 VATInfluence;\nVATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;\n}\n#endif\n";ii.IncludesShadersStore[Il]=Ml;const bl="prePassVertex",_l="#ifdef PREPASS_DEPTH\nvViewPos=(view*worldPos).rgb;\n#endif\n#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*worldPos;\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;\npreviousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n";ii.IncludesShadersStore[bl]=_l;const yl="uvVariableDeclaration",Nl="#if !defined(UV{X}) && defined(MAINUV{X})\nvec2 uv{X}=vec2(0.,0.);\n#endif\n#ifdef MAINUV{X}\nvMainUV{X}=uv{X};\n#endif\n";ii.IncludesShadersStore[yl]=Nl;const Pl="samplerVertexImplementation",Dl="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nif (v_INFONAME_==0.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));\n}\n#ifdef UV2\nelse if (v_INFONAME_==1.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef UV3\nelse if (v_INFONAME_==2.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));\n}\n#endif\n#ifdef UV4\nelse if (v_INFONAME_==3.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));\n}\n#endif\n#ifdef UV5\nelse if (v_INFONAME_==4.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));\n}\n#endif\n#ifdef UV6\nelse if (v_INFONAME_==5.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));\n}\n#endif\n#endif\n";ii.IncludesShadersStore[Pl]=Dl;const Ll="bumpVertex",Ol="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);\nvec3 tbnTangent=normalize(tangentUpdated.xyz);\nvec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;\nvTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif\n";ii.IncludesShadersStore[Ll]=Ol;const Fl="clipPlaneVertex",Bl="#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nfClipDistance2=dot(worldPos,vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nfClipDistance3=dot(worldPos,vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nfClipDistance4=dot(worldPos,vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nfClipDistance5=dot(worldPos,vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nfClipDistance6=dot(worldPos,vClipPlane6);\n#endif\n";ii.IncludesShadersStore[Fl]=Bl;const Ul="fogVertex",Vl="#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif\n";ii.IncludesShadersStore[Ul]=Vl;const kl="shadowsVertex",Gl="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvPositionFromCamera{X}=view*worldPos;\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {\nvPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n}\n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n";ii.IncludesShadersStore[kl]=Gl;const zl="vertexColorMixing",Hl="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvColor=vec4(1.0);\n#ifdef VERTEXCOLOR\n#ifdef VERTEXALPHA\nvColor*=color;\n#else\nvColor.rgb*=color.rgb;\n#endif\n#endif\n#ifdef INSTANCESCOLOR\nvColor*=instanceColor;\n#endif\n#endif\n";ii.IncludesShadersStore[zl]=Hl;const Xl="pointCloudVertex",Wl="#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n";ii.IncludesShadersStore[Xl]=Wl;const $l="logDepthVertex",Yl="#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;\ngl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif\n";ii.IncludesShadersStore[$l]=Yl;const jl="defaultVertexShader",Kl="#include<__decl__defaultVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));\nvNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\nvPositionW=vec3(worldPos);\n#include<prePassVertex>\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";ii.ShadersStore[jl]=Kl;const ql=new RegExp("^([gimus]+)!");class Ql{constructor(t){this._X=[],this.yX=[],this.NX=[],this.IT=t,this.Kt=t.getScene(),this.Ls=this.Kt.getEngine()}PX(t){for(let i=0;i<this._X.length;++i)if(this._X[i].name===t.name)throw`Plugin "${t.name}" already added to the material "${this.IT.name}"!`;if(this.IT.RR)throw`The plugin "${t.name}" can't be added to the material "${this.IT.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const i=t.getClassName();Ql.DX[i]||(Ql.DX[i]="MATERIALPLUGIN_"+ ++Ql.LX),this.IT.MR=this.OX.bind(this),this._X.push(t),this._X.sort(((t,i)=>t.priority-i.priority)),this.FX={};const e={};e[Ql.DX[i]]={type:"boolean",default:!0};for(const t of this._X)t.collectDefines(e),this.BX("vertex",t.getCustomCode("vertex")),this.BX("fragment",t.getCustomCode("fragment"));this.UX=e}VX(t){-1===this.yX.indexOf(t)&&(this.yX.push(t),this.yX.sort(((t,i)=>t.priority-i.priority)),this.IT.bR=this.kX.bind(this),this.IT.yR=this.GX.bind(this),this.IT._R=this.zX.bind(this),this.IT.PR=this.HX.bind(this),t.registerForExtraEvents&&(this.NX.push(t),this.NX.sort(((t,i)=>t.priority-i.priority)),this.IT.DR=this.XX.bind(this),this.IT.LR=this.WX.bind(this),this.IT.NR=this.$X.bind(this)))}getPlugin(t){for(let i=0;i<this._X.length;++i)if(this._X[i].name===t)return this._X[i];return null}kX(t){let i=!0;for(const e of this.yX)i=i&&e.isReadyForSubMesh(t.defines,this.Kt,this.Ls,t.subMesh);t.isReadyForSubMesh=i}GX(t){for(const i of this.yX)i.prepareDefinesBeforeAttributes(t.defines,this.Kt,t.mesh)}zX(t){for(const i of this.yX)i.prepareDefines(t.defines,this.Kt,t.mesh)}$X(t){for(const i of this.NX)i.hardBindForSubMesh(this.IT.VT,this.Kt,this.Ls,t.subMesh)}HX(t){for(const i of this.yX)i.bindForSubMesh(this.IT.VT,this.Kt,this.Ls,t.subMesh)}XX(t){let i=!1;for(const t of this.NX)if(i=t.hasRenderTargetTextures(),i)break;t.hasRenderTargetTextures=i}WX(t){for(const i of this.NX)i.fillRenderTargetTextures(t.renderTargets)}OX(t,i){switch(t){case Us.GetActiveTextures:{const t=i;for(const i of this.yX)i.getActiveTextures(t.activeTextures);break}case Us.GetAnimatables:{const t=i;for(const i of this.yX)i.getAnimatables(t.animatables);break}case Us.HasTexture:{const t=i;let e=!1;for(const i of this.yX)if(e=i.hasTexture(t.texture),e)break;t.hasTexture=e;break}case Us.Disposed:{const t=i;for(const i of this._X)i.dispose(t.forceDisposeTextures);break}case Us.GetDefineNames:i.defineNames=this.UX;break;case Us.PrepareEffect:{const t=i;for(const i of this.yX)t.fallbackRank=i.addFallbacks(t.defines,t.fallbacks,t.fallbackRank),i.getAttributes(t.attributes,this.Kt,t.mesh);this.YX.length>0&&t.uniforms.push(...this.YX),this.Bs.length>0&&t.samplers.push(...this.Bs),this.jX.length>0&&t.uniformBuffersNames.push(...this.jX),t.customCode=this.KX(t.customCode);break}case Us.PrepareUniformBuffer:{const t=i;this.qX="",this.QX="",this.ZX="",this.YX=[],this.Bs=[],this.jX=[];for(const i of this._X){const e=i.getUniforms();if(e){if(e.ubo)for(const i of e.ubo)t.ubo.addUniform(i.name,i.size),this.qX+=`${i.type} ${i.name};\r\n`,this.YX.push(i.name);e.vertex&&(this.QX+=e.vertex+"\r\n"),e.fragment&&(this.ZX+=e.fragment+"\r\n")}i.getSamplers(this.Bs),i.getUniformBuffersNames(this.jX)}break}}}BX(t,i){if(i)for(const e in i)this.FX[t]||(this.FX[t]={}),this.FX[t][e]=!0}KX(t){return(i,e)=>{var s;t&&(e=t(i,e)),this.qX&&(e=e.replace("#define ADDITIONAL_UBO_DECLARATION",this.qX)),this.QX&&(e=e.replace("#define ADDITIONAL_VERTEX_DECLARATION",this.QX)),this.ZX&&(e=e.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this.ZX));const n=null===(s=this.FX)||void 0===s?void 0:s[i];if(!n)return e;for(let t in n){let s="";for(const e of this.yX){const n=e.getCustomCode(i);(null==n?void 0:n[t])&&(s+=n[t]+"\r\n")}if(s.length>0)if("!"===t.charAt(0)){t=t.substring(1);let i="g";if("!"===t.charAt(0))i="",t=t.substring(1);else{const e=ql.exec(t);e&&e.length>=2&&(i=e[1],t=t.substring(i.length+1))}i.indexOf("g")<0&&(i+="g");const n=e,r=new RegExp(t,i);let h=r.exec(n);for(;null!==h;){let t=s;for(let i=0;i<h.length;++i)t=t.replace("$"+i,h[i]);e=e.replace(h[0],t),h=r.exec(n)}}else{const i="#define "+t;e=e.replace(i,"\r\n"+s+"\r\n"+i)}}return e}}}Ql.DX={},Ql.LX=0;class Zl{constructor(t,i,e,s,n=!0,r=!1){this.priority=500,this.registerForExtraEvents=!1,this.IT=t,this.name=i,this.priority=e,t.pluginManager||(t.pluginManager=new Ql(t)),this.JX=s,this.tW=t.pluginManager,n&&this.tW.PX(this),r&&this.iW(!0),this.markAllDefinesAsDirty=t.BR[63]}iW(t){t&&this.tW.VX(this)}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(t,i,e,s){return!0}hardBindForSubMesh(t,i,e,s){}bindForSubMesh(t,i,e,s){}dispose(t){}getCustomCode(t){return null}collectDefines(t){if(this.JX)for(const i of Object.keys(this.JX)){if("_"===i[0])continue;const e=typeof this.JX[i];t[i]={type:"number"===e?"number":"string"===e?"string":"boolean"===e?"boolean":"object",default:this.JX[i]}}}prepareDefinesBeforeAttributes(t,i,e){}prepareDefines(t,i,e){}hasTexture(t){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(t){}getActiveTextures(t){}getAnimatables(t){}addFallbacks(t,i,e){return e}getSamplers(t){}getAttributes(t,i,e){}getUniformBuffersNames(t){}getUniforms(){return{}}copyTo(t){ot.Clone((()=>t),this)}serialize(){return ot.Serialize(this)}parse(t,i,e){ot.Parse((()=>this),t,i,e)}}ut([Q()],Zl.prototype,"name",void 0),ut([Q()],Zl.prototype,"priority",void 0),ut([Q()],Zl.prototype,"registerForExtraEvents",void 0);class Jl extends Wi{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class tc extends Zl{constructor(t,i=!0){super(t,"DetailMap",140,new Jl,i),this.Lb=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this.eW=Vs.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this.ui=!1,this.isEnabled=!1,this.sW=t.BR[1]}UR(){this.iW(this.ui),this.sW()}isReadyForSubMesh(t,i,e){return!this.ui||!(t._l&&i.texturesEnabled&&e.getCaps().standardDerivatives&&this.Lb&&Bo.DetailTextureEnabled&&!this.Lb.isReady())}prepareDefines(t,i){if(this.ui){t.DETAIL_NORMALBLENDMETHOD=this.eW;const e=i.getEngine();t._l&&(e.getCaps().standardDerivatives&&this.Lb&&Bo.DetailTextureEnabled&&this.ui?(Fs.PrepareDefinesForMergedUV(this.Lb,t,"DETAIL"),t.DETAIL_NORMALBLENDMETHOD=this.eW):t.DETAIL=!1)}else t.DETAIL=!1}bindForSubMesh(t,i){if(!this.ui)return;const e=this.IT.isFrozen;t.useUbo&&e&&t.isSync||this.Lb&&Bo.DetailTextureEnabled&&(t.updateFloat4("vDetailInfos",this.Lb.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),Fs.BindTextureMatrix(this.Lb,t,"detail")),i.texturesEnabled&&this.Lb&&Bo.DetailTextureEnabled&&t.setTexture("detailSampler",this.Lb)}hasTexture(t){return this.Lb===t}getActiveTextures(t){this.Lb&&t.push(this.Lb)}getAnimatables(t){this.Lb&&this.Lb.animations&&this.Lb.animations.length>0&&t.push(this.Lb)}dispose(t){var i;t&&(null===(i=this.Lb)||void 0===i||i.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(t){t.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}ut([Z("detailTexture"),q("_markAllSubMeshesAsTexturesDirty")],tc.prototype,"texture",void 0),ut([Q()],tc.prototype,"diffuseBlendLevel",void 0),ut([Q()],tc.prototype,"roughnessBlendLevel",void 0),ut([Q()],tc.prototype,"bumpLevel",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],tc.prototype,"normalBlendMethod",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],tc.prototype,"isEnabled",void 0);const ic={effect:null,subMesh:null};class ec extends Wi{constructor(t){super(t),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.rebuild()}setReflectionMode(t){const i=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const e of i)this[e]=e===t}}class sc extends Fn{constructor(t,i){super(t,i),this.nW=null,this.rW=null,this.hW=null,this.oW=null,this.aW=null,this.lW=null,this.cW=null,this.uW=null,this.fW=null,this.ambientColor=new _(0,0,0),this.diffuseColor=new _(1,1,1),this.specularColor=new _(1,1,1),this.emissiveColor=new _(0,0,0),this.specularPower=64,this.dW=!1,this.pW=!1,this.mW=!1,this.vW=!1,this.gW=!1,this.SW=!1,this.EW=!1,this.AW=!1,this.wW=!1,this.parallaxScaleBias=.05,this.xW=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this.TW=!1,this.RW=!1,this.IW=!1,this.MW=4,this.bW=!1,this._W=!1,this.yW=!1,this._v=new zi(16),this.NW=R.Zero(),this.PW=new _(0,0,0),this.DW=!1,this.detailMap=new tc(this),this.$L(null),this.prePassConfiguration=new Fo,this.getRenderTargetTextures=()=>(this._v.reset(),sc.ReflectionTextureEnabled&&this.oW&&this.oW.isRenderTarget&&this._v.push(this.oW),sc.RefractionTextureEnabled&&this.fW&&this.fW.isRenderTarget&&this._v.push(this.fW),this.IR.renderTargets=this._v,this.LR(this.IR),this._v)}get imageProcessingConfiguration(){return this.Sg}set imageProcessingConfiguration(t){this.$L(t),this.UR()}$L(t){t!==this.Sg&&(this.Sg&&this.uF&&this.Sg.onUpdateParameters.remove(this.uF),this.Sg=t||this.getScene().imageProcessingConfiguration,this.Sg&&(this.uF=this.Sg.onUpdateParameters.add((()=>{this.fI()}))))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(t){this.imageProcessingConfiguration.colorCurvesEnabled=t}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(t){this.imageProcessingConfiguration.colorGradingEnabled=t}get cameraToneMappingEnabled(){return this.Sg.toneMappingEnabled}set cameraToneMappingEnabled(t){this.Sg.toneMappingEnabled=t}get cameraExposure(){return this.Sg.exposure}set cameraExposure(t){this.Sg.exposure=t}get cameraContrast(){return this.Sg.contrast}set cameraContrast(t){this.Sg.contrast=t}get cameraColorGradingTexture(){return this.Sg.colorGradingTexture}set cameraColorGradingTexture(t){this.Sg.colorGradingTexture=t}get cameraColorCurves(){return this.Sg.colorCurves}set cameraColorCurves(t){this.Sg.colorCurves=t}get canRenderToMRT(){return!0}get hasRenderTargetTextures(){return!!(sc.ReflectionTextureEnabled&&this.oW&&this.oW.isRenderTarget)||(!!(sc.RefractionTextureEnabled&&this.fW&&this.fW.isRenderTarget)||this.DW)}getClassName(){return"StandardMaterial"}get useLogarithmicDepth(){return this.IL}set useLogarithmicDepth(t){this.IL=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this.zR()}needAlphaBlending(){return!this.KR&&(this.alpha<1||null!=this.hW||this.LW()||this.OW&&this.OW.isEnabled)}needAlphaTesting(){return!!this.OR||this.FW()&&(null==this.FR||this.FR===Vs.MATERIAL_ALPHATEST)}LW(){return null!=this.nW&&this.nW.hasAlpha&&this.dW&&this.FR!==Vs.MATERIAL_OPAQUE}FW(){return null!=this.nW&&this.nW.hasAlpha||null!=this.hW}getAlphaTestTexture(){return this.nW}isReadyForSubMesh(t,i,e=!1){if(this.RR||this.buildUniformLayout(),i.effect&&this.isFrozen&&i.effect.cs&&i.effect.fs===e)return!0;i.materialDefines||(this.MR(Us.GetDefineNames,this.IR),i.materialDefines=new ec(this.IR.defineNames));const s=this.getScene(),n=i.materialDefines;if(this.oP(i))return!0;const r=s.getEngine();n.Fl=Fs.PrepareDefinesForLights(s,t,n,!0,this.MW,this.SW),Fs.PrepareDefinesForMultiview(s,n);const h=this.needAlphaBlendingForMesh(t)&&this.getScene().useOrderIndependentTransparency;if(Fs.PrepareDefinesForPrePass(s,n,this.canRenderToMRT&&!h),Fs.PrepareDefinesForOIT(s,n,h),n._l){this.IR.hasRenderTargetTextures=!1,this.DR(this.IR),this.DW=this.IR.hasRenderTargetTextures,n.Bl=!1;for(let t=1;t<=6;++t)n["MAINUV"+t]=!1;if(s.texturesEnabled){if(n.DIFFUSEDIRECTUV=0,n.BUMPDIRECTUV=0,n.AMBIENTDIRECTUV=0,n.OPACITYDIRECTUV=0,n.EMISSIVEDIRECTUV=0,n.SPECULARDIRECTUV=0,n.LIGHTMAPDIRECTUV=0,this.nW&&sc.DiffuseTextureEnabled){if(!this.nW.isReadyOrNotBlocking())return!1;Fs.PrepareDefinesForMergedUV(this.nW,n,"DIFFUSE")}else n.DIFFUSE=!1;if(this.rW&&sc.AmbientTextureEnabled){if(!this.rW.isReadyOrNotBlocking())return!1;Fs.PrepareDefinesForMergedUV(this.rW,n,"AMBIENT")}else n.AMBIENT=!1;if(this.hW&&sc.OpacityTextureEnabled){if(!this.hW.isReadyOrNotBlocking())return!1;Fs.PrepareDefinesForMergedUV(this.hW,n,"OPACITY"),n.OPACITYRGB=this.hW.getAlphaFromRGB}else n.OPACITY=!1;if(this.oW&&sc.ReflectionTextureEnabled){if(!this.oW.isReadyOrNotBlocking())return!1;switch(n.Fl=!0,n.REFLECTION=!0,n.ROUGHNESS=this.xW>0,n.REFLECTIONOVERALPHA=this.gW,n.INVERTCUBICMAP=this.oW.coordinatesMode===an.INVCUBIC_MODE,n.REFLECTIONMAP_3D=this.oW.isCube,n.REFLECTIONMAP_OPPOSITEZ=n.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this.oW.invertZ:this.oW.invertZ,n.RGBDREFLECTION=this.oW.isRGBD,this.oW.coordinatesMode){case an.EXPLICIT_MODE:n.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case an.PLANAR_MODE:n.setReflectionMode("REFLECTIONMAP_PLANAR");break;case an.PROJECTION_MODE:n.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case an.SKYBOX_MODE:n.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case an.SPHERICAL_MODE:n.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case an.EQUIRECTANGULAR_MODE:n.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case an.FIXED_EQUIRECTANGULAR_MODE:n.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case an.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:n.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case an.CUBIC_MODE:case an.INVCUBIC_MODE:default:n.setReflectionMode("REFLECTIONMAP_CUBIC")}n.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this.oW.boundingBoxSize}else n.REFLECTION=!1,n.REFLECTIONMAP_OPPOSITEZ=!1;if(this.aW&&sc.EmissiveTextureEnabled){if(!this.aW.isReadyOrNotBlocking())return!1;Fs.PrepareDefinesForMergedUV(this.aW,n,"EMISSIVE")}else n.EMISSIVE=!1;if(this.uW&&sc.LightmapTextureEnabled){if(!this.uW.isReadyOrNotBlocking())return!1;Fs.PrepareDefinesForMergedUV(this.uW,n,"LIGHTMAP"),n.USELIGHTMAPASSHADOWMAP=this.TW,n.RGBDLIGHTMAP=this.uW.isRGBD}else n.LIGHTMAP=!1;if(this.lW&&sc.SpecularTextureEnabled){if(!this.lW.isReadyOrNotBlocking())return!1;Fs.PrepareDefinesForMergedUV(this.lW,n,"SPECULAR"),n.GLOSSINESS=this.IW}else n.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this.cW&&sc.BumpTextureEnabled){if(!this.cW.isReady())return!1;Fs.PrepareDefinesForMergedUV(this.cW,n,"BUMP"),n.PARALLAX=this.AW,n.PARALLAXOCCLUSION=this.wW,n.OBJECTSPACE_NORMALMAP=this.EW}else n.BUMP=!1,n.PARALLAX=!1,n.PARALLAXOCCLUSION=!1;if(this.fW&&sc.RefractionTextureEnabled){if(!this.fW.isReadyOrNotBlocking())return!1;n.Bl=!0,n.REFRACTION=!0,n.REFRACTIONMAP_3D=this.fW.isCube,n.RGBDREFRACTION=this.fW.isRGBD,n.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this.fW.boundingBoxSize}else n.REFRACTION=!1;n.TWOSIDEDLIGHTING=!this.pR&&this.yW}else n.DIFFUSE=!1,n.AMBIENT=!1,n.OPACITY=!1,n.REFLECTION=!1,n.EMISSIVE=!1,n.LIGHTMAP=!1,n.BUMP=!1,n.REFRACTION=!1;n.ALPHAFROMDIFFUSE=this.LW(),n.EMISSIVEASILLUMINATION=this.pW,n.LINKEMISSIVEWITHDIFFUSE=this.mW,n.SPECULAROVERALPHA=this.vW,n.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,n.ALPHATEST_AFTERALLALPHACOMPUTATIONS=null!==this.transparencyMode,n.ALPHABLEND=null===this.transparencyMode||this.needAlphaBlendingForMesh(t)}if(this.IR.isReadyForSubMesh=!0,this.IR.defines=n,this.bR(this.IR),!this.IR.isReadyForSubMesh)return!1;if(n.Dl&&this.Sg){if(!this.Sg.isReady())return!1;this.Sg.prepareDefines(n),n.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,n.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}n.yl&&(sc.FresnelEnabled?(this.BW||this.OW||this.UW||this.VW||this.kW)&&(n.DIFFUSEFRESNEL=this.BW&&this.BW.isEnabled,n.OPACITYFRESNEL=this.OW&&this.OW.isEnabled,n.REFLECTIONFRESNEL=this.kW&&this.kW.isEnabled,n.REFLECTIONFRESNELFROMSPECULAR=this.RW,n.REFRACTIONFRESNEL=this.VW&&this.VW.isEnabled,n.EMISSIVEFRESNEL=this.UW&&this.UW.isEnabled,n.Fl=!0,n.FRESNEL=!0):n.FRESNEL=!1),Fs.PrepareDefinesForMisc(t,s,this.IL,this.pointsCloud,this.fogEnabled,this.qR(t)||this.OR,n),Fs.PrepareDefinesForFrameBoundValues(s,r,this,n,e,null,i.getRenderingMesh().hasThinInstances),this.IR.defines=n,this.IR.mesh=t,this.yR(this.IR),Fs.PrepareDefinesForAttributes(t,n,!0,!0,!0),this._R(this.IR);let o=!1;if(n.isDirty){const e=n.Ml;n.markAsProcessed();const h=new Jn;n.REFLECTION&&h.addFallback(0,"REFLECTION"),n.SPECULAR&&h.addFallback(0,"SPECULAR"),n.BUMP&&h.addFallback(0,"BUMP"),n.PARALLAX&&h.addFallback(1,"PARALLAX"),n.PARALLAXOCCLUSION&&h.addFallback(0,"PARALLAXOCCLUSION"),n.SPECULAROVERALPHA&&h.addFallback(0,"SPECULAROVERALPHA"),n.FOG&&h.addFallback(1,"FOG"),n.POINTSIZE&&h.addFallback(0,"POINTSIZE"),n.LOGARITHMICDEPTH&&h.addFallback(0,"LOGARITHMICDEPTH"),Fs.HandleFallbacksForShadows(n,h,this.MW),n.SPECULARTERM&&h.addFallback(0,"SPECULARTERM"),n.DIFFUSEFRESNEL&&h.addFallback(1,"DIFFUSEFRESNEL"),n.OPACITYFRESNEL&&h.addFallback(2,"OPACITYFRESNEL"),n.REFLECTIONFRESNEL&&h.addFallback(3,"REFLECTIONFRESNEL"),n.EMISSIVEFRESNEL&&h.addFallback(4,"EMISSIVEFRESNEL"),n.FRESNEL&&h.addFallback(4,"FRESNEL"),n.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");const a=[he.PositionKind];n.NORMAL&&a.push(he.NormalKind),n.TANGENT&&a.push(he.TangentKind);for(let t=1;t<=6;++t)n["UV"+t]&&a.push(`uv${1===t?"":t}`);n.VERTEXCOLOR&&a.push(he.ColorKind),Fs.PrepareAttributesForBones(a,t,n,h),Fs.PrepareAttributesForInstances(a,n),Fs.PrepareAttributesForMorphTargets(a,t,n),Fs.PrepareAttributesForBakedVertexAnimation(a,t,n);let l="default";const c=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],u=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],f=["Material","Scene","Mesh"];this.IR.fallbacks=h,this.IR.fallbackRank=0,this.IR.defines=n,this.IR.uniforms=c,this.IR.attributes=a,this.IR.samplers=u,this.IR.uniformBuffersNames=f,this.IR.customCode=void 0,this.IR.mesh=t,this.MR(Us.PrepareEffect,this.IR),Fo.AddUniforms(c),Fo.AddSamplers(u),ji&&(ji.PrepareUniforms(c,n),ji.PrepareSamplers(u,n)),Fs.PrepareUniformsAndSamplersList({uniformsNames:c,uniformBuffersNames:f,samplers:u,defines:n,maxSimultaneousLights:this.MW}),Ns(c);const d={};this.customShaderNameResolve&&(l=this.customShaderNameResolve(l,c,f,u,n,a,d));const p=n.toString(),m=i.effect;let v=s.getEngine().createEffect(l,{attributes:a,uniformsNames:c,uniformBuffersNames:f,samplers:u,defines:p,fallbacks:h,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.MW,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS},processFinalCode:d.processFinalCode,processCodeAfterIncludes:this.IR.customCode,multiTarget:n.PREPASS},r);if(this.IR.customCode=void 0,v)if(this.$R&&(ic.effect=v,ic.subMesh=i,this.$R.notifyObservers(ic)),this.allowShaderHotSwapping&&m&&!v.isReady()){if(v=m,n.markAsUnprocessed(),o=this.isFrozen,e)return n.Ml=!0,!1}else s.resetCachedMaterial(),i.setEffect(v,n,this.WR)}return!(!i.effect||!i.effect.isReady())&&(n.Sv=s.getRenderId(),i.effect.cs=!o,i.effect.fs=e,s.performancePriority!==Fe.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}buildUniformLayout(){const t=this.VT;t.addUniform("diffuseLeftColor",4),t.addUniform("diffuseRightColor",4),t.addUniform("opacityParts",4),t.addUniform("reflectionLeftColor",4),t.addUniform("reflectionRightColor",4),t.addUniform("refractionLeftColor",4),t.addUniform("refractionRightColor",4),t.addUniform("emissiveLeftColor",4),t.addUniform("emissiveRightColor",4),t.addUniform("vDiffuseInfos",2),t.addUniform("vAmbientInfos",2),t.addUniform("vOpacityInfos",2),t.addUniform("vReflectionInfos",2),t.addUniform("vReflectionPosition",3),t.addUniform("vReflectionSize",3),t.addUniform("vEmissiveInfos",2),t.addUniform("vLightmapInfos",2),t.addUniform("vSpecularInfos",2),t.addUniform("vBumpInfos",3),t.addUniform("diffuseMatrix",16),t.addUniform("ambientMatrix",16),t.addUniform("opacityMatrix",16),t.addUniform("reflectionMatrix",16),t.addUniform("emissiveMatrix",16),t.addUniform("lightmapMatrix",16),t.addUniform("specularMatrix",16),t.addUniform("bumpMatrix",16),t.addUniform("vTangentSpaceParams",2),t.addUniform("pointSize",1),t.addUniform("alphaCutOff",1),t.addUniform("refractionMatrix",16),t.addUniform("vRefractionInfos",4),t.addUniform("vRefractionPosition",3),t.addUniform("vRefractionSize",3),t.addUniform("vSpecularColor",4),t.addUniform("vEmissiveColor",3),t.addUniform("vDiffuseColor",4),t.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(t,i,e){var s;const n=this.getScene(),r=e.materialDefines;if(!r)return;const h=e.effect;if(!h)return;this.hP=h,i.getMeshUniformBuffer().bindToEffect(h,"Mesh"),i.transferToEffect(t),this.VT.bindToEffect(h,"Material"),this.prePassConfiguration.bindForSubMesh(this.hP,n,i,t,this.isFrozen),this.IR.subMesh=e,this.NR(this.IR),r.OBJECTSPACE_NORMALMAP&&(t.toNormalMatrix(this.rP),this.bindOnlyNormalMatrix(this.rP));const o=h.us||this.aP(n,h,i.visibility);Fs.BindBonesParameters(i,h);const a=this.VT;if(o){if(this.bindViewProjection(h),!a.useUbo||!this.isFrozen||!a.isSync||h.us){if(sc.FresnelEnabled&&r.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(a.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),a.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&a.updateColor4("opacityParts",new _(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(a.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),a.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(a.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),a.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(a.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),a.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),n.texturesEnabled){if(this.nW&&sc.DiffuseTextureEnabled&&(a.updateFloat2("vDiffuseInfos",this.nW.coordinatesIndex,this.nW.level),Fs.BindTextureMatrix(this.nW,a,"diffuse")),this.rW&&sc.AmbientTextureEnabled&&(a.updateFloat2("vAmbientInfos",this.rW.coordinatesIndex,this.rW.level),Fs.BindTextureMatrix(this.rW,a,"ambient")),this.hW&&sc.OpacityTextureEnabled&&(a.updateFloat2("vOpacityInfos",this.hW.coordinatesIndex,this.hW.level),Fs.BindTextureMatrix(this.hW,a,"opacity")),this.FW()&&a.updateFloat("alphaCutOff",this.alphaCutOff),this.oW&&sc.ReflectionTextureEnabled&&(a.updateFloat2("vReflectionInfos",this.oW.level,this.roughness),a.updateMatrix("reflectionMatrix",this.oW.getReflectionTextureMatrix()),this.oW.boundingBoxSize)){const t=this.oW;a.updateVector3("vReflectionPosition",t.boundingBoxPosition),a.updateVector3("vReflectionSize",t.boundingBoxSize)}if(this.aW&&sc.EmissiveTextureEnabled&&(a.updateFloat2("vEmissiveInfos",this.aW.coordinatesIndex,this.aW.level),Fs.BindTextureMatrix(this.aW,a,"emissive")),this.uW&&sc.LightmapTextureEnabled&&(a.updateFloat2("vLightmapInfos",this.uW.coordinatesIndex,this.uW.level),Fs.BindTextureMatrix(this.uW,a,"lightmap")),this.lW&&sc.SpecularTextureEnabled&&(a.updateFloat2("vSpecularInfos",this.lW.coordinatesIndex,this.lW.level),Fs.BindTextureMatrix(this.lW,a,"specular")),this.cW&&n.getEngine().getCaps().standardDerivatives&&sc.BumpTextureEnabled&&(a.updateFloat3("vBumpInfos",this.cW.coordinatesIndex,1/this.cW.level,this.parallaxScaleBias),Fs.BindTextureMatrix(this.cW,a,"bump"),n.Ag?a.updateFloat2("vTangentSpaceParams",this.bW?1:-1,this._W?1:-1):a.updateFloat2("vTangentSpaceParams",this.bW?-1:1,this._W?-1:1)),this.fW&&sc.RefractionTextureEnabled){let t=1;if(this.fW.isCube||(a.updateMatrix("refractionMatrix",this.fW.getReflectionTextureMatrix()),this.fW.depth&&(t=this.fW.depth)),a.updateFloat4("vRefractionInfos",this.fW.level,this.indexOfRefraction,t,this.invertRefractionY?-1:1),this.fW.boundingBoxSize){const t=this.fW;a.updateVector3("vRefractionPosition",t.boundingBoxPosition),a.updateVector3("vRefractionSize",t.boundingBoxSize)}}}this.pointsCloud&&a.updateFloat("pointSize",this.pointSize),r.SPECULARTERM&&a.updateColor4("vSpecularColor",this.specularColor,this.specularPower),a.updateColor3("vEmissiveColor",sc.EmissiveTextureEnabled?this.emissiveColor:_.BlackReadOnly),a.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),n.ambientColor.multiplyToRef(this.ambientColor,this.PW),a.updateColor3("vAmbientColor",this.PW)}n.texturesEnabled&&(this.nW&&sc.DiffuseTextureEnabled&&h.setTexture("diffuseSampler",this.nW),this.rW&&sc.AmbientTextureEnabled&&h.setTexture("ambientSampler",this.rW),this.hW&&sc.OpacityTextureEnabled&&h.setTexture("opacitySampler",this.hW),this.oW&&sc.ReflectionTextureEnabled&&(this.oW.isCube?h.setTexture("reflectionCubeSampler",this.oW):h.setTexture("reflection2DSampler",this.oW)),this.aW&&sc.EmissiveTextureEnabled&&h.setTexture("emissiveSampler",this.aW),this.uW&&sc.LightmapTextureEnabled&&h.setTexture("lightmapSampler",this.uW),this.lW&&sc.SpecularTextureEnabled&&h.setTexture("specularSampler",this.lW),this.cW&&n.getEngine().getCaps().standardDerivatives&&sc.BumpTextureEnabled&&h.setTexture("bumpSampler",this.cW),this.fW&&sc.RefractionTextureEnabled&&(this.fW.isCube?h.setTexture("refractionCubeSampler",this.fW):h.setTexture("refraction2DSampler",this.fW))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(i)&&this.getScene().depthPeelingRenderer.bind(h),this.IR.subMesh=e,this.PR(this.IR),Ds(h,this,n),this.bindEyePosition(h)}else n.getEngine().hs.needToAlwaysBindUniformBuffers&&(this.JR=!0);!o&&this.isFrozen||(n.lightsEnabled&&!this.SW&&Fs.BindLights(n,i,h,r,this.MW),(n.fogEnabled&&i.applyFog&&n.fogMode!==ke.FOGMODE_NONE||this.oW||this.fW||i.receiveShadows||r.PREPASS)&&this.bindView(h),Fs.BindFogParameters(n,i,h),r.NUM_MORPH_INFLUENCERS&&Fs.BindMorphTargetParameters(i,h),r.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(s=i.bakedVertexAnimationManager)||void 0===s||s.bind(h,r.INSTANCES)),this.useLogarithmicDepth&&Fs.BindLogDepth(r,h,n),this.Sg&&!this.Sg.applyByPostProcess&&this.Sg.bind(this.hP)),this.tI(i,this.hP),a.update()}getAnimatables(){const t=super.getAnimatables();return this.nW&&this.nW.animations&&this.nW.animations.length>0&&t.push(this.nW),this.rW&&this.rW.animations&&this.rW.animations.length>0&&t.push(this.rW),this.hW&&this.hW.animations&&this.hW.animations.length>0&&t.push(this.hW),this.oW&&this.oW.animations&&this.oW.animations.length>0&&t.push(this.oW),this.aW&&this.aW.animations&&this.aW.animations.length>0&&t.push(this.aW),this.lW&&this.lW.animations&&this.lW.animations.length>0&&t.push(this.lW),this.cW&&this.cW.animations&&this.cW.animations.length>0&&t.push(this.cW),this.uW&&this.uW.animations&&this.uW.animations.length>0&&t.push(this.uW),this.fW&&this.fW.animations&&this.fW.animations.length>0&&t.push(this.fW),t}getActiveTextures(){const t=super.getActiveTextures();return this.nW&&t.push(this.nW),this.rW&&t.push(this.rW),this.hW&&t.push(this.hW),this.oW&&t.push(this.oW),this.aW&&t.push(this.aW),this.lW&&t.push(this.lW),this.cW&&t.push(this.cW),this.uW&&t.push(this.uW),this.fW&&t.push(this.fW),t}hasTexture(t){return!!super.hasTexture(t)||(this.nW===t||(this.rW===t||(this.hW===t||(this.oW===t||(this.aW===t||(this.lW===t||(this.cW===t||(this.uW===t||this.fW===t))))))))}dispose(t,i){var e,s,n,r,h,o,a,l,c;i&&(null===(e=this.nW)||void 0===e||e.dispose(),null===(s=this.rW)||void 0===s||s.dispose(),null===(n=this.hW)||void 0===n||n.dispose(),null===(r=this.oW)||void 0===r||r.dispose(),null===(h=this.aW)||void 0===h||h.dispose(),null===(o=this.lW)||void 0===o||o.dispose(),null===(a=this.cW)||void 0===a||a.dispose(),null===(l=this.uW)||void 0===l||l.dispose(),null===(c=this.fW)||void 0===c||c.dispose()),this.Sg&&this.uF&&this.Sg.onUpdateParameters.remove(this.uF),super.dispose(t,i)}clone(t){const i=ot.Clone((()=>new sc(t,this.getScene())),this);return i.name=t,i.id=t,this.stencil.copyTo(i.stencil),i}static Parse(t,i,e){const s=ot.Parse((()=>new sc(t.name,i)),t,i,e);return t.stencil&&s.stencil.parse(t.stencil,i,e),s}static get DiffuseTextureEnabled(){return Bo.DiffuseTextureEnabled}static set DiffuseTextureEnabled(t){Bo.DiffuseTextureEnabled=t}static get DetailTextureEnabled(){return Bo.DetailTextureEnabled}static set DetailTextureEnabled(t){Bo.DetailTextureEnabled=t}static get AmbientTextureEnabled(){return Bo.AmbientTextureEnabled}static set AmbientTextureEnabled(t){Bo.AmbientTextureEnabled=t}static get OpacityTextureEnabled(){return Bo.OpacityTextureEnabled}static set OpacityTextureEnabled(t){Bo.OpacityTextureEnabled=t}static get ReflectionTextureEnabled(){return Bo.ReflectionTextureEnabled}static set ReflectionTextureEnabled(t){Bo.ReflectionTextureEnabled=t}static get EmissiveTextureEnabled(){return Bo.EmissiveTextureEnabled}static set EmissiveTextureEnabled(t){Bo.EmissiveTextureEnabled=t}static get SpecularTextureEnabled(){return Bo.SpecularTextureEnabled}static set SpecularTextureEnabled(t){Bo.SpecularTextureEnabled=t}static get BumpTextureEnabled(){return Bo.BumpTextureEnabled}static set BumpTextureEnabled(t){Bo.BumpTextureEnabled=t}static get LightmapTextureEnabled(){return Bo.LightmapTextureEnabled}static set LightmapTextureEnabled(t){Bo.LightmapTextureEnabled=t}static get RefractionTextureEnabled(){return Bo.RefractionTextureEnabled}static set RefractionTextureEnabled(t){Bo.RefractionTextureEnabled=t}static get ColorGradingTextureEnabled(){return Bo.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(t){Bo.ColorGradingTextureEnabled=t}static get FresnelEnabled(){return Bo.FresnelEnabled}static set FresnelEnabled(t){Bo.FresnelEnabled=t}}ut([Z("diffuseTexture")],sc.prototype,"_diffuseTexture",void 0),ut([q("_markAllSubMeshesAsTexturesAndMiscDirty")],sc.prototype,"diffuseTexture",void 0),ut([Z("ambientTexture")],sc.prototype,"_ambientTexture",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"ambientTexture",void 0),ut([Z("opacityTexture")],sc.prototype,"_opacityTexture",void 0),ut([q("_markAllSubMeshesAsTexturesAndMiscDirty")],sc.prototype,"opacityTexture",void 0),ut([Z("reflectionTexture")],sc.prototype,"_reflectionTexture",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"reflectionTexture",void 0),ut([Z("emissiveTexture")],sc.prototype,"_emissiveTexture",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"emissiveTexture",void 0),ut([Z("specularTexture")],sc.prototype,"_specularTexture",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"specularTexture",void 0),ut([Z("bumpTexture")],sc.prototype,"_bumpTexture",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"bumpTexture",void 0),ut([Z("lightmapTexture")],sc.prototype,"_lightmapTexture",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"lightmapTexture",void 0),ut([Z("refractionTexture")],sc.prototype,"_refractionTexture",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"refractionTexture",void 0),ut([J("ambient")],sc.prototype,"ambientColor",void 0),ut([J("diffuse")],sc.prototype,"diffuseColor",void 0),ut([J("specular")],sc.prototype,"specularColor",void 0),ut([J("emissive")],sc.prototype,"emissiveColor",void 0),ut([Q()],sc.prototype,"specularPower",void 0),ut([Q("useAlphaFromDiffuseTexture")],sc.prototype,"_useAlphaFromDiffuseTexture",void 0),ut([q("_markAllSubMeshesAsTexturesAndMiscDirty")],sc.prototype,"useAlphaFromDiffuseTexture",void 0),ut([Q("useEmissiveAsIllumination")],sc.prototype,"_useEmissiveAsIllumination",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"useEmissiveAsIllumination",void 0),ut([Q("linkEmissiveWithDiffuse")],sc.prototype,"_linkEmissiveWithDiffuse",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"linkEmissiveWithDiffuse",void 0),ut([Q("useSpecularOverAlpha")],sc.prototype,"_useSpecularOverAlpha",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"useSpecularOverAlpha",void 0),ut([Q("useReflectionOverAlpha")],sc.prototype,"_useReflectionOverAlpha",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"useReflectionOverAlpha",void 0),ut([Q("disableLighting")],sc.prototype,"_disableLighting",void 0),ut([q("_markAllSubMeshesAsLightsDirty")],sc.prototype,"disableLighting",void 0),ut([Q("useObjectSpaceNormalMap")],sc.prototype,"_useObjectSpaceNormalMap",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"useObjectSpaceNormalMap",void 0),ut([Q("useParallax")],sc.prototype,"_useParallax",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"useParallax",void 0),ut([Q("useParallaxOcclusion")],sc.prototype,"_useParallaxOcclusion",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"useParallaxOcclusion",void 0),ut([Q()],sc.prototype,"parallaxScaleBias",void 0),ut([Q("roughness")],sc.prototype,"_roughness",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"roughness",void 0),ut([Q()],sc.prototype,"indexOfRefraction",void 0),ut([Q()],sc.prototype,"invertRefractionY",void 0),ut([Q()],sc.prototype,"alphaCutOff",void 0),ut([Q("useLightmapAsShadowmap")],sc.prototype,"_useLightmapAsShadowmap",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"useLightmapAsShadowmap",void 0),ut([tt("diffuseFresnelParameters")],sc.prototype,"_diffuseFresnelParameters",void 0),ut([q("_markAllSubMeshesAsFresnelDirty")],sc.prototype,"diffuseFresnelParameters",void 0),ut([tt("opacityFresnelParameters")],sc.prototype,"_opacityFresnelParameters",void 0),ut([q("_markAllSubMeshesAsFresnelAndMiscDirty")],sc.prototype,"opacityFresnelParameters",void 0),ut([tt("reflectionFresnelParameters")],sc.prototype,"_reflectionFresnelParameters",void 0),ut([q("_markAllSubMeshesAsFresnelDirty")],sc.prototype,"reflectionFresnelParameters",void 0),ut([tt("refractionFresnelParameters")],sc.prototype,"_refractionFresnelParameters",void 0),ut([q("_markAllSubMeshesAsFresnelDirty")],sc.prototype,"refractionFresnelParameters",void 0),ut([tt("emissiveFresnelParameters")],sc.prototype,"_emissiveFresnelParameters",void 0),ut([q("_markAllSubMeshesAsFresnelDirty")],sc.prototype,"emissiveFresnelParameters",void 0),ut([Q("useReflectionFresnelFromSpecular")],sc.prototype,"_useReflectionFresnelFromSpecular",void 0),ut([q("_markAllSubMeshesAsFresnelDirty")],sc.prototype,"useReflectionFresnelFromSpecular",void 0),ut([Q("useGlossinessFromSpecularMapAlpha")],sc.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"useGlossinessFromSpecularMapAlpha",void 0),ut([Q("maxSimultaneousLights")],sc.prototype,"_maxSimultaneousLights",void 0),ut([q("_markAllSubMeshesAsLightsDirty")],sc.prototype,"maxSimultaneousLights",void 0),ut([Q("invertNormalMapX")],sc.prototype,"_invertNormalMapX",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"invertNormalMapX",void 0),ut([Q("invertNormalMapY")],sc.prototype,"_invertNormalMapY",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"invertNormalMapY",void 0),ut([Q("twoSidedLighting")],sc.prototype,"_twoSidedLighting",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],sc.prototype,"twoSidedLighting",void 0),ut([Q()],sc.prototype,"useLogarithmicDepth",null),v("BABYLON.StandardMaterial",sc),ke.DefaultMaterialFactory=t=>new sc("default material",t),Ei.prototype.createDynamicTexture=function(t,i,e,s){const n=new ai(this,oi.Dynamic);return n.baseWidth=t,n.baseHeight=i,e&&(t=this.needPOTTextures?Ei.GetExponentOfTwo(t,this.po.maxTextureSize):t,i=this.needPOTTextures?Ei.GetExponentOfTwo(i,this.po.maxTextureSize):i),n.width=t,n.height=i,n.isReady=!1,n.generateMipMaps=e,n.samplingMode=s,this.updateTextureSamplingMode(s,n),this.Rh.push(n),n},Ei.prototype.updateDynamicTexture=function(t,i,e,s=!1,n,r=!1,h=!1){if(!t)return;const o=this.lo,a=o.TEXTURE_2D,l=this.qo(a,t,!0,r);this.La(void 0===e?t.invertY:e),s&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const c=this.Ma(t.type),u=this.Ia(n||t.format),f=this.Ra(t.type,u);o.texImage2D(a,0,f,u,c,i),t.generateMipMaps&&o.generateMipmap(a),l||this.qo(a,null),s&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),t.isReady=!0};class nc extends an{constructor(t,i,e=null,s=!1,n=3,r=5,h){super(null,e,!s,h,n,void 0,void 0,void 0,void 0,r),this.name=t,this.wrapU=an.CLAMP_ADDRESSMODE,this.wrapV=an.CLAMP_ADDRESSMODE,this.uO=s;const o=this.qb();if(!o)return;i.getContext?(this.GW=i,this.Lb=o.createDynamicTexture(i.width,i.height,s,n)):(this.GW=o.createCanvas(1,1),i.width||0===i.width?this.Lb=o.createDynamicTexture(i.width,i.height,s,n):this.Lb=o.createDynamicTexture(i,i,s,n));const a=this.getSize();this.GW.width!==a.width&&(this.GW.width=a.width),this.GW.height!==a.height&&(this.GW.height=a.height),this.zr=this.GW.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}zW(t){this.GW.width=t.width,this.GW.height=t.height,this.releaseInternalTexture(),this.Lb=this.qb().createDynamicTexture(t.width,t.height,this.uO,this.samplingMode)}scale(t){const i=this.getSize();i.width*=t,i.height*=t,this.zW(i)}scaleTo(t,i){const e=this.getSize();e.width=t,e.height=i,this.zW(e)}getContext(){return this.zr}clear(){const t=this.getSize();this.zr.fillRect(0,0,t.width,t.height)}update(t,i=!1,e=!1){this.qb().updateDynamicTexture(this.Lb,this.GW,void 0===t||t,i,this.R_||void 0,void 0,e)}drawText(t,i,e,s,n,r,h,o=!0){const a=this.getSize();if(r&&(this.zr.fillStyle=r,this.zr.fillRect(0,0,a.width,a.height)),this.zr.font=s,null==i){const e=this.zr.measureText(t);i=(a.width-e.width)/2}if(null==e){const t=parseInt(s.replace(/\D/g,""));e=a.height/2+t/3.65}this.zr.fillStyle=n||"",this.zr.fillText(t,i,e),o&&this.update(h)}clone(){const t=this.getScene();if(!t)return this;const i=this.getSize(),e=new nc(this.name,i,t,this.uO);return e.hasAlpha=this.hasAlpha,e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e}serialize(){const t=this.getScene();t&&!t.isReady()&&F.Warn("The scene must be ready before serializing the dynamic texture");const i=super.serialize();return nc.HW(this.GW)&&(i.base64String=this.GW.toDataURL()),i.invertY=this.t_,i.samplingMode=this.samplingMode,i}static HW(t){return void 0!==t.toDataURL}br(){this.update()}}const rc="imageProcessingPixelShader",hc="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 result=texture2D(textureSampler,vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult.rgb=toLinearSpace(result.rgb);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\ngl_FragColor=result;\n}";ii.ShadersStore[rc]=hc;class oc extends nr{constructor(t,i,e=null,s,n,r,h=0,o){super(t,"imageProcessing",[],[],i,e,s,n,r,null,h,"postprocess",null,!0),this.XW=!0,this.PD={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},o?(o.applyByPostProcess=!0,this.$L(o,!0),this._c()):(this.$L(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=t=>{this.imageProcessingConfiguration.bind(t,this.aspectRatio)}}get imageProcessingConfiguration(){return this.Sg}set imageProcessingConfiguration(t){t.applyByPostProcess=!0,this.$L(t)}$L(t,i=!1){if(t!==this.Sg){if(this.Sg&&this.uF&&this.Sg.onUpdateParameters.remove(this.uF),t)this.Sg=t;else{let t=null;const i=this.getEngine(),e=this.getCamera();if(e)t=e.getScene();else if(i&&i.scenes){const e=i.scenes;t=e[e.length-1]}else t=E.LastCreatedScene;this.Sg=t?t.imageProcessingConfiguration:new ji}this.Sg&&(this.uF=this.Sg.onUpdateParameters.add((()=>{this._c()}))),i||this._c()}}get isSupported(){const t=this.getEffect();return!t||t.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(t){this.imageProcessingConfiguration.colorCurves=t}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(t){this.imageProcessingConfiguration.colorCurvesEnabled=t}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(t){this.imageProcessingConfiguration.colorGradingTexture=t}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(t){this.imageProcessingConfiguration.colorGradingEnabled=t}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(t){this.imageProcessingConfiguration.exposure=t}get toneMappingEnabled(){return this.Sg.toneMappingEnabled}set toneMappingEnabled(t){this.Sg.toneMappingEnabled=t}get toneMappingType(){return this.Sg.toneMappingType}set toneMappingType(t){this.Sg.toneMappingType=t}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(t){this.imageProcessingConfiguration.contrast=t}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(t){this.imageProcessingConfiguration.vignetteStretch=t}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(t){this.imageProcessingConfiguration.vignetteCenterX=t}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(t){this.imageProcessingConfiguration.vignetteCenterY=t}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(t){this.imageProcessingConfiguration.vignetteCenterY=t}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(t){this.imageProcessingConfiguration.vignetteCenterX=t}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(t){this.imageProcessingConfiguration.vignetteWeight=t}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(t){this.imageProcessingConfiguration.vignetteColor=t}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(t){this.imageProcessingConfiguration.vignetteCameraFov=t}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(t){this.imageProcessingConfiguration.vignetteBlendMode=t}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(t){this.imageProcessingConfiguration.vignetteEnabled=t}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(t){this.imageProcessingConfiguration.ditheringIntensity=t}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(t){this.imageProcessingConfiguration.ditheringEnabled=t}get fromLinearSpace(){return this.XW}set fromLinearSpace(t){this.XW!==t&&(this.XW=t,this._c())}getClassName(){return"ImageProcessingPostProcess"}_c(){this.PD.FROMLINEARSPACE=this.XW,this.imageProcessingConfiguration.prepareDefines(this.PD,!0);let t="";for(const i in this.PD)this.PD[i]&&(t+=`#define ${i};\r\n`);const i=["textureSampler"],e=["scale"];ji&&(ji.PrepareSamplers(i,this.PD),ji.PrepareUniforms(e,this.PD)),this.updateEffect(t,e,i)}dispose(t){super.dispose(t),this.Sg&&this.uF&&this.Sg.onUpdateParameters.remove(this.uF),this.Sg&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}ut([Q()],oc.prototype,"_fromLinearSpace",void 0);class ac{constructor(t,i,e,s,n){this.getWidth=t,this.getHeight=i,this.layer=e,this.layerType=s,this.createRenderTargetTextureProvider=n}get isFixedFoveationSupported(){return"XRWebGLLayer"==this.layerType&&"number"==typeof this.layer.fixedFoveation}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(t){if(this.isFixedFoveationSupported){const i=Math.max(0,Math.min(1,t||0));this.layer.fixedFoveation=i}}}class lc{constructor(t,i){this.Kt=t,this.layerWrapper=i,this.WW=new Array,this.Ls=t.getEngine()}Ta(t,i){const e=new ai(this.Ls,oi.Unknown,!0);return e.width=t.width,e.height=t.height,e.Er=new mi(i,this.Ls.lo),e.isReady=!0,e}dL(t,i,e,s,n,r){if(!this.Ls)throw new Error("Engine is disposed");const h={width:t,height:i},o=r?new xo(this.Kt,h):new br("XR renderTargetTexture",h,this.Kt),a=o.renderTarget;if(a.dw=o.samples,!e&&s||(a.$o=e),s)if(r)a.HD=s;else{const t=this.Ta(h,s);a.setTexture(t,0),o.Lb=t}return n&&(r?a.XD=n:a.Yo=this.Ta(h,n)),o.disableRescaling(),"undefined"!=typeof XRWebGLBinding&&(o.skipInitialClear=!0),this.WW.push(o),o}$W(t){this.WW.splice(this.WW.indexOf(t),1),t.dispose()}getFramebufferDimensions(){return this.YW}dispose(){this.WW.forEach((t=>t.dispose())),this.WW.length=0}}class cc extends ac{constructor(t){super((()=>t.framebufferWidth),(()=>t.framebufferHeight),t,"XRWebGLLayer",(t=>new uc(t.scene,this))),this.layer=t}}class uc extends lc{constructor(t,i){super(t,i),this.layerWrapper=i,this.jW=i.layer,this.YW={framebufferWidth:this.jW.framebufferWidth,framebufferHeight:this.jW.framebufferHeight}}trySetViewportForView(t,i){const e=this.jW.getViewport(i);if(!e)return!1;const s=this.YW.framebufferWidth,n=this.YW.framebufferHeight;return t.x=e.x/s,t.y=e.y/n,t.width=e.width/s,t.height=e.height/n,!0}getRenderTargetTextureForEye(t){const i=this.jW.framebufferWidth,e=this.jW.framebufferHeight,s=this.jW.framebuffer;return this.KW&&i===this.YW.framebufferWidth&&e===this.YW.framebufferHeight&&s===this.$o||(this.KW=this.dL(i,e,s),this.YW.framebufferWidth=i,this.YW.framebufferHeight=e,this.$o=s),this.KW}getRenderTargetTextureForView(t){return this.getRenderTargetTextureForEye(t.eye)}}class fc{static GetDefaults(t){const i=new fc;return i.canvasOptions={antialias:!0,depth:!0,stencil:!t||t.isStencilEnable,alpha:!0,framebufferScaleFactor:1},i.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",i}}class dc{constructor(t,i=fc.GetDefaults()){if(this.wb=i,this.GW=null,this.Ls=null,this.xrLayer=null,this.qW=null,this.onXRLayerInitObservable=new h,this.Ls=t.scene.getEngine(),this.Ls.onDisposeObservable.addOnce((()=>{this.Ls=null})),i.canvasElement)this.QW(i.canvasElement);else{const t=document.createElement("canvas");t.style.cssText=this.wb.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this.QW(t)}t.onXRSessionInit.add((()=>{this.ZW()})),t.onXRSessionEnded.add((()=>{this.JW()}))}dispose(){this.JW(),this.QW(null)}async initializeXRLayerAsync(t){const i=()=>(this.xrLayer=new XRWebGLLayer(t,this.canvasContext,this.wb.canvasOptions),this.qW=new cc(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then((()=>{}),(()=>{ki.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly.")})).then((()=>i())):Promise.resolve(i())}ZW(){this.GW&&this.Ls&&this.GW!==this.Ls.getRenderingCanvas()&&document.body.appendChild(this.GW),this.xrLayer?this.t$(!0):this.onXRLayerInitObservable.addOnce((()=>{this.t$(!0)}))}JW(){this.GW&&this.Ls&&document.body.contains(this.GW)&&this.GW!==this.Ls.getRenderingCanvas()&&document.body.removeChild(this.GW),this.t$(!1)}t$(t=!0,i=this.qW){this.GW&&this.Ls&&(t?i&&(this.GW!==this.Ls.getRenderingCanvas()?(this.GW.style.width=i.getWidth()+"px",this.GW.style.height=i.getHeight()+"px"):this.Ls.setSize(i.getWidth(),i.getHeight())):this.i$&&(this.GW!==this.Ls.getRenderingCanvas()?(this.GW.style.width=this.i$.width+"px",this.GW.style.height=this.i$.height+"px"):this.Ls.setSize(this.i$.width,this.i$.height)))}QW(t){this.JW(),t?(this.i$={width:t.offsetWidth,height:t.offsetHeight},this.GW=t,this.canvasContext=this.GW.getContext("webgl2"),this.canvasContext||(this.canvasContext=this.GW.getContext("webgl"))):(this.GW=null,this.canvasContext=null)}}class pc extends ac{constructor(t){super((()=>t.framebufferWidth),(()=>t.framebufferHeight),t,"XRWebGLLayer",(t=>new mc(t,this))),this.layer=t}}class mc extends lc{constructor(t,i){super(t.scene,i),this.layerWrapper=i,this.e$=navigator.xr.getNativeRenderTargetProvider(t.session,this.dL.bind(this),this.$W.bind(this)),this.s$=i.layer}trySetViewportForView(t){return t.x=0,t.y=0,t.width=1,t.height=1,!0}getRenderTargetTextureForEye(t){return this.e$.getRenderTargetForEye(t)}getRenderTargetTextureForView(t){return this.e$.getRenderTargetForEye(t.eye)}getFramebufferDimensions(){return{framebufferWidth:this.s$.framebufferWidth,framebufferHeight:this.s$.framebufferHeight}}}class vc{constructor(t){this.n$=navigator.xr.getWebXRRenderTarget(t.scene.getEngine())}async initializeXRLayerAsync(t){return await this.n$.initializeXRLayerAsync(t),this.xrLayer=this.n$.xrLayer,this.xrLayer}dispose(){}}class gc{constructor(t){this.scene=t,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new h,this.onXRReferenceSpaceChanged=new h,this.onXRSessionEnded=new h,this.onXRSessionInit=new h,this.inXRFrameLoop=!1,this.inXRSession=!1,this.Ls=t.getEngine(),this.r$=this.Ls.onDisposeObservable.addOnce((()=>{this.Ls=null})),t.onDisposeObservable.addOnce((()=>{this.dispose()}))}get referenceSpace(){return this.h$}set referenceSpace(t){this.h$=t,this.onXRReferenceSpaceChanged.notifyObservers(this.h$)}get sessionMode(){return this.o$}dispose(){var t;this.inXRSession&&this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),null===(t=this.Ls)||void 0===t||t.onDisposeObservable.remove(this.r$),this.Ls=null}exitXRAsync(){return this.session&&this.inXRSession?(this.inXRSession=!1,this.session.end().catch((()=>{F.Warn("Could not end XR session.")}))):Promise.resolve()}trySetViewportForView(t,i){var e;return(null===(e=this.a$)||void 0===e?void 0:e.trySetViewportForView(t,i))||!1}getRenderTargetTextureForEye(t){var i;return(null===(i=this.a$)||void 0===i?void 0:i.getRenderTargetTextureForEye(t))||null}getRenderTargetTextureForView(t){var i;return(null===(i=this.a$)||void 0===i?void 0:i.getRenderTargetTextureForView(t))||null}getWebXRRenderTarget(t){const i=this.scene.getEngine();return this.l$.xr.native?new vc(this):((t=t||fc.GetDefaults(i)).canvasElement=t.canvasElement||i.getRenderingCanvas()||void 0,new dc(this,t))}initializeAsync(){return this.l$=navigator,this.l$.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(t="immersive-vr",i={}){return this.l$.xr.requestSession(t,i).then((i=>(this.session=i,this.o$=t,this.onXRSessionInit.notifyObservers(i),this.inXRSession=!0,this.session.addEventListener("end",(()=>{var t;this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this.Ls&&(this.Ls.framebufferDimensionsObject=null,this.Ls.restoreDefaultFramebuffer(),this.Ls.customAnimationFrameRequester=null,this.Ls.Uo()),this.isNative&&(null===(t=this.a$)||void 0===t||t.dispose()),this.a$=null,this.c$=null}),{once:!0}),this.session)))}isSessionSupportedAsync(t){return gc.IsSessionSupportedAsync(t)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){var t;this.inXRSession&&this.Ls&&(this.Ls.customAnimationFrameRequester={requestAnimationFrame:this.session.requestAnimationFrame.bind(this.session),renderFunction:(t,i)=>{var e;this.inXRSession&&this.Ls&&(this.currentFrame=i,this.currentTimestamp=t,i&&(this.inXRFrameLoop=!0,this.Ls.framebufferDimensionsObject=(null===(e=this.a$)||void 0===e?void 0:e.getFramebufferDimensions())||null,this.onXRFrameObservable.notifyObservers(i),this.Ls.Uo(),this.Ls.framebufferDimensionsObject=null,this.inXRFrameLoop=!1))}},this.Ls.framebufferDimensionsObject=(null===(t=this.a$)||void 0===t?void 0:t.getFramebufferDimensions())||null,"undefined"!=typeof window&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this.Ls.Vo),this.Ls.Uo())}setReferenceSpaceTypeAsync(t="local-floor"){return this.session.requestReferenceSpace(t).then((t=>t),(t=>(F.Error("XR.requestReferenceSpace failed for the following reason: "),F.Error(t),F.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then((t=>{const i=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return t.getOffsetReferenceSpace(i)}),(t=>{throw F.Error(t),'XR initialization failed: required "viewer" reference space type not supported.'}))))).then((t=>this.session.requestReferenceSpace("viewer").then((i=>(this.viewerReferenceSpace=i,t))))).then((t=>(this.referenceSpace=this.baseReferenceSpace=t,this.referenceSpace)))}updateRenderStateAsync(t){return Promise.resolve(this.session.updateRenderState(t))}u$(t){var i,e;this.isNative&&(null===(i=this.a$)||void 0===i||i.dispose()),this.c$=t,this.a$=(null===(e=this.c$)||void 0===e?void 0:e.createRenderTargetTextureProvider(this))||null}updateRenderState(t){t.baseLayer&&this.u$(this.isNative?new pc(t.baseLayer):new cc(t.baseLayer)),this.session.updateRenderState(t)}static IsSessionSupportedAsync(t){if(!navigator.xr)return Promise.resolve(!1);const i=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return i?i.call(navigator.xr,t).then((t=>{const i=void 0===t||t;return Promise.resolve(i)})).catch((t=>(F.Warn(t),Promise.resolve(!1)))):Promise.resolve(!1)}get isNative(){var t;return null!==(t=this.l$.xr.native)&&void 0!==t&&t}get currentFrameRate(){var t;return null===(t=this.session)||void 0===t?void 0:t.frameRate}get supportedFrameRates(){var t;return null===(t=this.session)||void 0===t?void 0:t.supportedFrameRates}updateTargetFrameRate(t){return this.session.updateTargetFrameRate(t)}runInXRFrame(t,i=!0){this.inXRFrameLoop?t():!this.inXRSession&&i||this.onXRFrameObservable.addOnce(t)}get isFixedFoveationSupported(){var t;return(null===(t=this.c$)||void 0===t?void 0:t.isFixedFoveationSupported)||!1}get fixedFoveation(){var t;return(null===(t=this.c$)||void 0===t?void 0:t.fixedFoveation)||null}set fixedFoveation(t){const i=Math.max(0,Math.min(1,t||0));this.c$&&(this.c$.fixedFoveation=i)}}var Sc,Ec;function Ac(t){const i=t.height||2;let e=0===t.diameterTop?0:t.diameterTop||t.diameter||1,s=0===t.diameterBottom?0:t.diameterBottom||t.diameter||1;e=e||1e-5,s=s||1e-5;const n=t.tessellation||24,r=t.subdivisions||1,h=!!t.hasRings,o=!!t.enclose,a=0===t.cap?0:t.cap||Ys.CAP_ALL,l=t.arc&&(t.arc<=0||t.arc>1)?1:t.arc||1,c=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE,u=t.faceUV||new Array(3),f=t.faceColors,d=2+(1+(1!==l&&o?2:0))*(h?r:1);let p;for(p=0;p<d;p++)f&&void 0===f[p]&&(f[p]=new y(1,1,1,1));for(p=0;p<d;p++)u&&void 0===u[p]&&(u[p]=new x(0,0,1,1));const m=new Array,v=new Array,g=new Array,S=new Array,E=new Array,A=2*Math.PI*l/n;let T,R,I;const M=(s-e)/2/i,b=w.Zero(),_=w.Zero(),N=w.Zero(),P=w.Zero(),D=w.Zero(),L=Ge.Y;let O,F,B,U=1,V=1,k=0,G=0;for(O=0;O<=r;O++)for(R=O/r,I=(R*(e-s)+s)/2,U=h&&0!==O&&O!==r?2:1,B=0;B<U;B++){for(h&&(V+=B),o&&(V+=2*B),F=0;F<=n;F++)T=F*A,b.x=Math.cos(-T)*I,b.y=-i/2+R*i,b.z=Math.sin(-T)*I,0===e&&O===r?(_.x=g[g.length-3*(n+1)],_.y=g[g.length-3*(n+1)+1],_.z=g[g.length-3*(n+1)+2]):(_.x=b.x,_.z=b.z,_.y=Math.sqrt(_.x*_.x+_.z*_.z)*M,_.normalize()),0===F&&(N.copyFrom(b),P.copyFrom(_)),v.push(b.x,b.y,b.z),g.push(_.x,_.y,_.z),G=h?k!==V?u[V].y:u[V].w:u[V].y+(u[V].w-u[V].y)*R,S.push(u[V].x+(u[V].z-u[V].x)*F/n,As.UseOpenGLOrientationForUV?1-G:G),f&&E.push(f[V].r,f[V].g,f[V].b,f[V].a);1!==l&&o&&(v.push(b.x,b.y,b.z),v.push(0,b.y,0),v.push(0,b.y,0),v.push(N.x,N.y,N.z),w.CrossToRef(L,_,D),D.normalize(),g.push(D.x,D.y,D.z,D.x,D.y,D.z),w.CrossToRef(P,L,D),D.normalize(),g.push(D.x,D.y,D.z,D.x,D.y,D.z),G=h?k!==V?u[V+1].y:u[V+1].w:u[V+1].y+(u[V+1].w-u[V+1].y)*R,S.push(u[V+1].x,As.UseOpenGLOrientationForUV?1-G:G),S.push(u[V+1].z,As.UseOpenGLOrientationForUV?1-G:G),G=h?k!==V?u[V+2].y:u[V+2].w:u[V+2].y+(u[V+2].w-u[V+2].y)*R,S.push(u[V+2].x,As.UseOpenGLOrientationForUV?1-G:G),S.push(u[V+2].z,As.UseOpenGLOrientationForUV?1-G:G),f&&(E.push(f[V+1].r,f[V+1].g,f[V+1].b,f[V+1].a),E.push(f[V+1].r,f[V+1].g,f[V+1].b,f[V+1].a),E.push(f[V+2].r,f[V+2].g,f[V+2].b,f[V+2].a),E.push(f[V+2].r,f[V+2].g,f[V+2].b,f[V+2].a))),k!==V&&(k=V)}const z=1!==l&&o?n+4:n;for(O=0,V=0;V<r;V++){let t=0,i=0,e=0,s=0;for(F=0;F<n;F++)t=O*(z+1)+F,i=(O+1)*(z+1)+F,e=O*(z+1)+(F+1),s=(O+1)*(z+1)+(F+1),m.push(t,i,e),m.push(s,e,i);1!==l&&o&&(m.push(t+2,i+2,e+2),m.push(s+2,e+2,i+2),m.push(t+4,i+4,e+4),m.push(s+4,e+4,i+4)),O=h?O+2:O+1}const H=t=>{const r=t?e/2:s/2;if(0===r)return;let h,o,a;const c=t?u[d-1]:u[0];let p=null;f&&(p=t?f[d-1]:f[0]);const A=v.length/3,x=t?i/2:-i/2,T=new w(0,x,0);v.push(T.x,T.y,T.z),g.push(0,t?1:-1,0);const R=c.y+.5*(c.w-c.y);S.push(c.x+.5*(c.z-c.x),As.UseOpenGLOrientationForUV?1-R:R),p&&E.push(p.r,p.g,p.b,p.a);const I=new C(.5,.5);for(a=0;a<=n;a++){h=2*Math.PI*a*l/n;const i=Math.cos(-h),e=Math.sin(-h);o=new w(i*r,x,e*r);const s=new C(i*I.x+.5,e*I.y+.5);v.push(o.x,o.y,o.z),g.push(0,t?1:-1,0);const u=c.y+(c.w-c.y)*s.y;S.push(c.x+(c.z-c.x)*s.x,As.UseOpenGLOrientationForUV?1-u:u),p&&E.push(p.r,p.g,p.b,p.a)}for(a=0;a<n;a++)t?(m.push(A),m.push(A+(a+2)),m.push(A+(a+1))):(m.push(A),m.push(A+(a+1)),m.push(A+(a+2)))};a!==Ys.CAP_START&&a!==Ys.CAP_ALL||H(!1),a!==Ys.CAP_END&&a!==Ys.CAP_ALL||H(!0),os.JA(c,v,m,g,S,t.frontUVs,t.backUVs);const X=new os;return X.indices=m,X.positions=v,X.normals=g,X.uvs=S,f&&(X.colors=E),X}function Cc(t,i={},e){const s=new Ys(t,e);i.sideOrientation=Ys.OI(i.sideOrientation),s.yI=i.sideOrientation;return Ac(i).applyToMesh(s,i.updatable),s}!function(t){t[t.ENTERING_XR=0]="ENTERING_XR",t[t.EXITING_XR=1]="EXITING_XR",t[t.IN_XR=2]="IN_XR",t[t.NOT_IN_XR=3]="NOT_IN_XR"}(Sc||(Sc={})),function(t){t[t.NOT_TRACKING=0]="NOT_TRACKING",t[t.TRACKING_LOST=1]="TRACKING_LOST",t[t.TRACKING=2]="TRACKING"}(Ec||(Ec={}));function wc(t){const i=[],e=[],s=[],n=[],r=t.diameter||1,h=t.thickness||.5,o=t.tessellation||16,a=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE,l=o+1;for(let t=0;t<=o;t++){const a=t/o,c=t*Math.PI*2/o-Math.PI/2,u=R.Translation(r/2,0,0).multiply(R.RotationY(c));for(let r=0;r<=o;r++){const c=1-r/o,f=r*Math.PI*2/o+Math.PI,d=Math.cos(f),p=Math.sin(f);let m=new w(d,p,0),v=m.scale(h/2);const g=new C(a,c);v=w.TransformCoordinates(v,u),m=w.TransformNormal(m,u),e.push(v.x,v.y,v.z),s.push(m.x,m.y,m.z),n.push(g.x,As.UseOpenGLOrientationForUV?1-g.y:g.y);const S=(t+1)%l,E=(r+1)%l;i.push(t*l+r),i.push(t*l+E),i.push(S*l+r),i.push(t*l+E),i.push(S*l+E),i.push(S*l+r)}}os.JA(a,e,i,s,n,t.frontUVs,t.backUVs);const c=new os;return c.indices=i,c.positions=e,c.normals=s,c.uvs=n,c}function xc(t,i={},e){const s=new Ys(t,e);i.sideOrientation=Ys.OI(i.sideOrientation),s.yI=i.sideOrientation;return wc(i).applyToMesh(s,i.updatable),s}os.CreateCylinder=Ac,Ys.CreateCylinder=(t,i,e,s,n,r,h,o,a)=>{void 0!==h&&h instanceof ke||(void 0!==h&&(a=o||Ys.DEFAULTSIDE,o=h),h=r,r=1);return Cc(t,{height:i,diameterTop:e,diameterBottom:s,tessellation:n,subdivisions:r,sideOrientation:a,updatable:o},h)};os.CreateTorus=wc,Ys.CreateTorus=(t,i,e,s,n,r,h)=>xc(t,{diameter:i,thickness:e,tessellation:s,sideOrientation:h,updatable:r},n),Ys.dM=(t,i)=>Tc.Parse(t,i);class Tc extends Ys{constructor(t,i){super(t,i),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this.f$,this.d$)}get subdivisionsX(){return this.f$}get subdivisionsY(){return this.d$}optimize(t,i=32){this.f$=t,this.d$=t,this.subdivide(t);const e=this;e.createOrUpdateSubmeshesOctree&&e.createOrUpdateSubmeshesOctree(i)}getHeightAtCoordinates(t,i){const e=this.getWorldMatrix(),s=M.Matrix[5];e.invertToRef(s);const n=M.Vector3[8];if(w.TransformCoordinatesFromFloatsToRef(t,0,i,s,n),t=n.x,i=n.z,t<this.p$||t>=this.m$||i<=this.v$||i>this.g$)return this.position.y;this.S$&&0!=this.S$.length||(this.E$(),this.A$());const r=this.C$(t,i),h=-(r.x*t+r.z*i+r.w)/r.y;return w.TransformCoordinatesFromFloatsToRef(0,h,0,e,n),n.y}getNormalAtCoordinates(t,i){const e=new w(0,1,0);return this.getNormalAtCoordinatesToRef(t,i,e),e}getNormalAtCoordinatesToRef(t,i,e){const s=this.getWorldMatrix(),n=M.Matrix[5];s.invertToRef(n);const r=M.Vector3[8];if(w.TransformCoordinatesFromFloatsToRef(t,0,i,n,r),t=r.x,i=r.z,t<this.p$||t>this.m$||i<this.v$||i>this.g$)return this;this.S$&&0!=this.S$.length||(this.E$(),this.A$());const h=this.C$(t,i);return w.TransformNormalFromFloatsToRef(h.x,h.y,h.z,s,e),this}updateCoordinateHeights(){return this.S$&&0!=this.S$.length||this.E$(),this.A$(),this}C$(t,i){const e=Math.floor((t+this.m$)*this.f$/this.w$),s=Math.floor(-(i+this.g$)*this.d$/this.wL+this.d$),n=this.S$[s*this.f$+e];let r;return r=i<n.slope.x*t+n.slope.y?n.facet1:n.facet2,r}E$(){const t=this.f$,i=this.d$;this.S$=new Array;for(let e=0;e<i;e++)for(let i=0;i<t;i++){const s={slope:C.Zero(),facet1:new x(0,0,0,0),facet2:new x(0,0,0,0)};this.S$[e*t+i]=s}return this}A$(){const t=this.getVerticesData(he.PositionKind);if(!t)return this;const i=M.Vector3[3],e=M.Vector3[2],s=M.Vector3[1],n=M.Vector3[0],r=M.Vector3[4],h=M.Vector3[5],o=M.Vector3[6],a=M.Vector3[7],l=M.Vector3[8];let c=0,u=0,f=0,d=0,p=0,m=0,v=0;const g=this.f$,S=this.d$;for(let E=0;E<S;E++)for(let S=0;S<g;S++){c=3*S,u=E*(g+1)*3,f=(E+1)*(g+1)*3,i.x=t[u+c],i.y=t[u+c+1],i.z=t[u+c+2],e.x=t[u+c+3],e.y=t[u+c+4],e.z=t[u+c+5],s.x=t[f+c],s.y=t[f+c+1],s.z=t[f+c+2],n.x=t[f+c+3],n.y=t[f+c+4],n.z=t[f+c+5],d=(n.z-i.z)/(n.x-i.x),p=i.z-d*i.x,e.subtractToRef(i,r),s.subtractToRef(i,h),n.subtractToRef(i,o),w.CrossToRef(o,h,a),w.CrossToRef(r,o,l),a.normalize(),l.normalize(),m=-(a.x*i.x+a.y*i.y+a.z*i.z),v=-(l.x*e.x+l.y*e.y+l.z*e.z);const A=this.S$[E*g+S];A.slope.copyFromFloats(d,p),A.facet1.copyFromFloats(a.x,a.y,a.z,m),A.facet2.copyFromFloats(l.x,l.y,l.z,v)}return this}serialize(t){super.serialize(t),t.subdivisionsX=this.f$,t.subdivisionsY=this.d$,t.minX=this.p$,t.maxX=this.m$,t.minZ=this.v$,t.maxZ=this.g$,t.width=this.w$,t.height=this.wL}static Parse(t,i){const e=new Tc(t.name,i);return e.f$=t.subdivisionsX||1,e.d$=t.subdivisionsY||1,e.p$=t.minX,e.m$=t.maxX,e.v$=t.minZ,e.g$=t.maxZ,e.w$=t.width,e.wL=t.height,e}}function Rc(t){const i=[],e=[],s=[],n=[];let r,h;const o=t.width||1,a=t.height||1,l=t.subdivisionsX||t.subdivisions||1,c=t.subdivisionsY||t.subdivisions||1;for(r=0;r<=c;r++)for(h=0;h<=l;h++){const t=new w(h*o/l-o/2,0,(c-r)*a/c-a/2),i=new w(0,1,0);e.push(t.x,t.y,t.z),s.push(i.x,i.y,i.z),n.push(h/l,As.UseOpenGLOrientationForUV?r/c:1-r/c)}for(r=0;r<c;r++)for(h=0;h<l;h++)i.push(h+1+(r+1)*(l+1)),i.push(h+1+r*(l+1)),i.push(h+r*(l+1)),i.push(h+(r+1)*(l+1)),i.push(h+1+(r+1)*(l+1)),i.push(h+r*(l+1));const u=new os;return u.indices=i,u.positions=e,u.normals=s,u.uvs=n,u}function Ic(t){const i=void 0!==t.xmin&&null!==t.xmin?t.xmin:-1,e=void 0!==t.zmin&&null!==t.zmin?t.zmin:-1,s=void 0!==t.xmax&&null!==t.xmax?t.xmax:1,n=void 0!==t.zmax&&null!==t.zmax?t.zmax:1,r=t.subdivisions||{w:1,h:1},h=t.precision||{w:1,h:1},o=new Array,a=new Array,l=new Array,c=new Array;let u,f,d,p;r.h=r.h<1?1:r.h,r.w=r.w<1?1:r.w,h.w=h.w<1?1:h.w,h.h=h.h<1?1:h.h;const m=(s-i)/r.w,v=(n-e)/r.h;function g(t,i,e,s){const n=a.length/3,r=h.w+1;for(u=0;u<h.h;u++)for(f=0;f<h.w;f++){const t=[n+f+u*r,n+(f+1)+u*r,n+(f+1)+(u+1)*r,n+f+(u+1)*r];o.push(t[1]),o.push(t[2]),o.push(t[3]),o.push(t[0]),o.push(t[1]),o.push(t[3])}const d=w.Zero(),p=new w(0,1,0);for(u=0;u<=h.h;u++)for(d.z=u*(s-i)/h.h+i,f=0;f<=h.w;f++)d.x=f*(e-t)/h.w+t,d.y=0,a.push(d.x,d.y,d.z),l.push(p.x,p.y,p.z),c.push(f/h.w,u/h.h)}for(d=0;d<r.h;d++)for(p=0;p<r.w;p++)g(i+p*m,e+d*v,i+(p+1)*m,e+(d+1)*v);const S=new os;return S.indices=o,S.positions=a,S.normals=l,S.uvs=c,S}function Mc(t){const i=[],e=[],s=[],n=[];let r,h;const o=t.colorFilter||new _(.3,.59,.11),a=t.alphaFilter||0;let l=!1;if(t.minHeight>t.maxHeight){l=!0;const i=t.maxHeight;t.maxHeight=t.minHeight,t.minHeight=i}for(r=0;r<=t.subdivisions;r++)for(h=0;h<=t.subdivisions;h++){const i=new w(h*t.width/t.subdivisions-t.width/2,0,(t.subdivisions-r)*t.height/t.subdivisions-t.height/2),c=4*(((i.x+t.width/2)/t.width*(t.bufferWidth-1)|0)+((1-(i.z+t.height/2)/t.height)*(t.bufferHeight-1)|0)*t.bufferWidth);let f=t.buffer[c]/255,d=t.buffer[c+1]/255,p=t.buffer[c+2]/255;const m=t.buffer[c+3]/255;l&&(f=1-f,d=1-d,p=1-p);const v=f*o.r+d*o.g+p*o.b;i.y=m>=a?t.minHeight+(t.maxHeight-t.minHeight)*v:t.minHeight-u,e.push(i.x,i.y,i.z),s.push(0,0,0),n.push(h/t.subdivisions,1-r/t.subdivisions)}for(r=0;r<t.subdivisions;r++)for(h=0;h<t.subdivisions;h++){const s=h+1+(r+1)*(t.subdivisions+1),n=h+1+r*(t.subdivisions+1),o=h+r*(t.subdivisions+1),a=h+(r+1)*(t.subdivisions+1),l=e[3*s+1]>=t.minHeight,c=e[3*n+1]>=t.minHeight,u=e[3*o+1]>=t.minHeight;l&&c&&u&&(i.push(s),i.push(n),i.push(o));e[3*a+1]>=t.minHeight&&l&&u&&(i.push(a),i.push(s),i.push(o))}os.ComputeNormals(e,i,s);const c=new os;return c.indices=i,c.positions=e,c.normals=s,c.uvs=n,c}function bc(t,i={},e){const s=new Tc(t,e);s.ji(!1),s.f$=i.subdivisionsX||i.subdivisions||1,s.d$=i.subdivisionsY||i.subdivisions||1,s.w$=i.width||1,s.wL=i.height||1,s.m$=s.w$/2,s.g$=s.wL/2,s.p$=-s.m$,s.v$=-s.g$;return Rc(i).applyToMesh(s,i.updatable),s.ji(!0),s}function _c(t,i,e=null){const s=new Ys(t,e);return Ic(i).applyToMesh(s,i.updatable),s}function yc(t,i,e={},s=null){const n=e.width||10,r=e.height||10,h=e.subdivisions||1,o=e.minHeight||0,a=e.maxHeight||1,l=e.colorFilter||new _(.3,.59,.11),c=e.alphaFilter||0,u=e.updatable,f=e.onReady;s=s||E.LastCreatedScene;const d=new Tc(t,s);d.f$=h,d.d$=h,d.w$=n,d.wL=r,d.m$=d.w$/2,d.g$=d.wL/2,d.p$=-d.m$,d.v$=-d.g$,d.ji(!1);return ki.LoadImage(i,(t=>{const i=t.width,e=t.height;if(s.isDisposed)return;const p=null==s?void 0:s.getEngine().resizeImageBitmap(t,i,e);Mc({width:n,height:r,subdivisions:h,minHeight:o,maxHeight:a,colorFilter:l,buffer:p,bufferWidth:i,bufferHeight:e,alphaFilter:c}).applyToMesh(d,u),f&&f(d),d.ji(!0)}),(()=>{}),s.offlineProvider),d}os.CreateGround=Rc,os.CreateTiledGround=Ic,os.CreateGroundFromHeightMap=Mc,Ys.CreateGround=(t,i,e,s,n,r)=>bc(t,{width:i,height:e,subdivisions:s,updatable:r},n),Ys.CreateTiledGround=(t,i,e,s,n,r,h,o,a)=>_c(t,{xmin:i,zmin:e,xmax:s,zmax:n,subdivisions:r,precision:h,updatable:a},o),Ys.CreateGroundFromHeightMap=(t,i,e,s,n,r,h,o,a,l,c)=>yc(t,i,{width:e,height:s,subdivisions:n,minHeight:r,maxHeight:h,updatable:a,onReady:l,alphaFilter:c},o);class Nc{constructor(t,i=null){if(this.scene=t,this.x$=!1,this.T$=!1,this.R$=!1,this.I$=!1,this.M$=!1,this.b$=!1,this._$=!0,this.y$=!1,this.Al=Nc.N$++,i)this.P$=i.clone("gazeTracker");else{this.P$=xc("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},t),this.P$.bakeCurrentTransformIntoVertices(),this.P$.isPickable=!1,this.P$.isVisible=!1;const i=new sc("targetMat",t);i.specularColor=_.Black(),i.emissiveColor=new _(.7,.7,.7),i.backFaceCulling=!1,this.P$.material=i}}D$(t){return new vn(w.Zero(),new w(0,0,t))}L$(){this.x$=!0,this.O$&&this.scene.simulatePointerDown(this.O$,{pointerId:this.Al})}F$(){this.O$&&this.scene.simulatePointerUp(this.O$,{pointerId:this.Al}),this.x$=!1}B$(){this.y$=!0}U$(){this.y$=!1}V$(t=100){}dispose(){this.k$=!1,this.G$=!1,this.P$&&this.P$.dispose()}}Nc.N$=0;class Pc extends Nc{constructor(t,i,e){super(i,e),this.webVRController=t,this.z$=Cc("laserPointer",{updatable:!1,height:1,diameterTop:.004,diameterBottom:2e-4,tessellation:20,subdivisions:1},i);const s=new sc("laserPointerMat",i);if(s.emissiveColor=new _(.7,.7,.7),s.alpha=.6,this.z$.material=s,this.z$.rotation.x=Math.PI/2,this.z$.position.z=-.5,this.z$.isVisible=!1,this.z$.isPickable=!1,!t.mesh){const e=new Ys("preloadControllerMesh",i),s=new Ys(Hh.POINTING_POSE,i);s.rotation.x=-.7,e.addChild(s),t.attachToMesh(e)}this.H$(t.mesh),this.X$=t.HG.add((t=>{this.H$(t)}))}D$(t){return this.webVRController.getForwardRay(t)}B$(){super.B$(),this.z$.isVisible=!0}U$(){super.U$(),this.z$.isVisible=!1}W$(t){this.z$.material.emissiveColor=t}$$(t){this.z$.material.disableLighting=t}H$(t){const i=t=>{t.isPickable=!1,t.getChildMeshes().forEach((t=>{i(t)}))};i(t);const e=t.getChildren(void 0,!1);let s=t;this.webVRController.GG=null;for(let t=0;t<e.length;t++)if(e[t].name&&e[t].name.indexOf(Hh.POINTING_POSE)>=0){s=e[t],this.webVRController.GG=s;break}this.z$.parent=s}V$(t=100){this.z$.scaling.y=t,this.z$.position.z=-t/2}dispose(){super.dispose(),this.z$.dispose(),this.X$&&this.webVRController.HG.remove(this.X$)}}class Dc extends Nc{constructor(t,i){super(i),this.Y$=t}D$(t){const i=this.Y$();return i?i.getForwardRay(t):new vn(w.Zero(),w.Forward())}}class Lc{constructor(t,i={}){this.webVROptions=i,this.j$=!1,this.K$=!1,this.q$=!1,this.Q$=!1,this.Z$=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new h,this.onAfterEnteringVRObservable=new h,this.onExitingVRObservable=new h,this.onControllerMeshLoadedObservable=new h,this.J$=!1,this.tY=!1,this.iY=!1,this.eY=[],this.sY=Lc.TELEPORTATIONMODE_CONSTANTTIME,this.nY=122,this.rY=20,this.hY=!0,this.oY=new w(0,-1,-1),this.aY=!0,this.lY="#444444",this.cY="#FFFFFF",this.uY=0,this.fY=new w(0,0,0),this.dY=.65,this.pY=.35,this.QH=null,this.ZH=null,this.mY=new _(.7,.7,.7),this.vY=new _(.7,.7,.7),this.gY=new _(.2,.2,1),this.SY=new _(0,0,1),this.onNewMeshSelected=new h,this.onMeshSelectedWithController=new h,this.onNewMeshPicked=new h,this.onBeforeCameraTeleport=new h,this.onAfterCameraTeleport=new h,this.onSelectedMeshUnselected=new h,this.teleportationEnabled=!0,this.EY=!1,this.k$=!1,this.AY=!1,this.CY=!0,this.wY=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this.TM=()=>{this.xY(),this.Z$&&this.K$&&this.exitVR()},this.yw=()=>{this.Z$=!!document.fullscreenElement,!this.Z$&&this.TY&&(this.exitVR(),!this.J$&&this.RY&&(this.RY.style.top=this.TY.offsetTop+this.TY.offsetHeight-70+"px",this.RY.style.left=this.TY.offsetLeft+this.TY.offsetWidth-100+"px",this.IY()))},this.MY={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this.bY=()=>{this.QH&&this.QH.y$&&this._Y(this.QH),this.ZH&&this.ZH.y$&&this._Y(this.ZH),this.yY&&(this.Kt.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock)?this._Y(this.NY):this.NY.P$.isVisible=!1},this.PY=t=>{if(t.type!==sh.POSE_ENABLED)t.leftStick&&t.onleftstickchanged((t=>{this.EY&&this.teleportationEnabled&&(!this.QH&&!this.ZH||this.QH&&!this.QH.y$&&this.ZH&&!this.ZH.y$)&&(this.DY(t,this.NY),this.LY(t,this.NY))})),t.rightStick&&t.onrightstickchanged((t=>{this.EY&&this.OY(t,this.NY)})),t.type===sh.XBOX&&(t.onbuttondown((t=>{this.k$&&t===Ch.A&&this.NY.L$()})),t.onbuttonup((t=>{this.k$&&t===Ch.A&&this.NY.F$()})));else{const i=t,e=new Pc(i,this.Kt,this.NY.P$);"right"===i.hand||this.QH&&this.QH.webVRController!=i?this.ZH=e:this.QH=e,this.FY(e)}},this.FY=t=>{this.AY&&!t.k$&&this.BY(t),this.tY&&!t.G$&&this.UY(t)},this.VY=t=>{t instanceof Oo&&("left"===t.hand&&null!=this.QH&&(this.QH.dispose(),this.QH=null),"right"===t.hand&&null!=this.ZH&&(this.ZH.dispose(),this.ZH=null))},this.WH=w.Zero(),this.kY=T.Identity(),this.zG=R.Identity(),F.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this.Kt=t,this.TY=t.getEngine().getInputElement();if("getVRDisplays"in navigator||void 0!==i.useXR||(i.useXR=!0),void 0===i.createFallbackVRDeviceOrientationFreeCamera&&(i.createFallbackVRDeviceOrientationFreeCamera=!0),void 0===i.createDeviceOrientationCamera&&(i.createDeviceOrientationCamera=!0),void 0===i.laserToggle&&(i.laserToggle=!0),void 0===i.defaultHeight&&(i.defaultHeight=1.7),i.useCustomVRButton&&(this.J$=!0,i.customVRButton&&(this.RY=i.customVRButton)),i.rayLength&&(this.GY=i.rayLength),this.HH=i.defaultHeight,i.positionScale&&(this.GY*=i.positionScale,this.HH*=i.positionScale),this.zY=!1,this.Kt.activeCamera?this.rA=this.Kt.activeCamera.position.clone():this.rA=new w(0,this.HH,0),i.createDeviceOrientationCamera||!this.Kt.activeCamera){if(this.HY=new Fh("deviceOrientationVRHelper",this.rA.clone(),t),this.Kt.activeCamera&&(this.HY.minZ=this.Kt.activeCamera.minZ,this.HY.maxZ=this.Kt.activeCamera.maxZ,this.Kt.activeCamera instanceof Ph&&this.Kt.activeCamera.rotation)){const t=this.Kt.activeCamera;t.rotationQuaternion?this.HY.rotationQuaternion.copyFrom(t.rotationQuaternion):this.HY.rotationQuaternion.copyFrom(T.RotationYawPitchRoll(t.rotation.y,t.rotation.x,t.rotation.z)),this.HY.rotation=t.rotation.clone()}this.Kt.activeCamera=this.HY,this.TY&&this.Kt.activeCamera.attachControl()}else this.XY=this.Kt.activeCamera;this.webVROptions.useXR&&navigator.xr?gc.IsSessionSupportedAsync("immersive-vr").then((e=>{e?(F.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),t.createDefaultXRExperienceAsync({floorMeshes:i.floorMeshes||[]}).then((i=>{this.xr=i,this.xrTestDone=!0,this.NY=new Dc((()=>this.xr.baseExperience.camera),t),this.xr.baseExperience.onStateChangedObservable.add((t=>{switch(t){case Sc.ENTERING_XR:this.onEnteringVRObservable.notifyObservers(this),this.k$||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this.wY;break;case Sc.EXITING_XR:this.onExitingVRObservable.notifyObservers(this),this.Kt.getEngine().resize();break;case Sc.IN_XR:this.zY=!0;break;case Sc.NOT_IN_XR:this.zY=!1}}))}))):this.WY(t,i)})):this.WY(t,i)}get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get onControllerMeshLoaded(){return this.onControllerMeshLoadedObservable}get teleportationTarget(){return this.$Y}set teleportationTarget(t){t&&(t.name="teleportationTarget",this.aY=!1,this.$Y=t)}get gazeTrackerMesh(){return this.NY.P$}set gazeTrackerMesh(t){t&&(this.NY.P$&&this.NY.P$.dispose(),this.QH&&this.QH.P$&&this.QH.P$.dispose(),this.ZH&&this.ZH.P$&&this.ZH.P$.dispose(),this.NY.P$=t,this.NY.P$.bakeCurrentTransformIntoVertices(),this.NY.P$.isPickable=!1,this.NY.P$.isVisible=!1,this.NY.P$.name="gazeTracker",this.QH&&(this.QH.P$=this.NY.P$.clone("gazeTracker")),this.ZH&&(this.ZH.P$=this.NY.P$.clone("gazeTracker")))}get leftControllerGazeTrackerMesh(){return this.QH?this.QH.P$:null}get rightControllerGazeTrackerMesh(){return this.ZH?this.ZH.P$:null}get displayGaze(){return this.CY}set displayGaze(t){this.CY=t,t||(this.NY.P$.isVisible=!1,this.QH&&(this.QH.P$.isVisible=!1),this.ZH&&(this.ZH.P$.isVisible=!1))}get displayLaserPointer(){return this.wY}set displayLaserPointer(t){this.wY=t,t?(this.ZH&&this.ZH.B$(),this.QH&&this.QH.B$()):(this.ZH&&(this.ZH.U$(),this.ZH.P$.isVisible=!1),this.QH&&(this.QH.U$(),this.QH.P$.isVisible=!1))}get deviceOrientationCamera(){return this.HY}get currentVRCamera(){return this.K$?this.YY:this.Kt.activeCamera}get webVRCamera(){return this.YY}get vrDeviceOrientationCamera(){return this.jY}get vrButton(){return this.RY}get R$(){return this.NY.R$||null!==this.QH&&this.QH.R$||null!==this.ZH&&this.ZH.R$}WY(t,i){if(this.xrTestDone=!0,i.createFallbackVRDeviceOrientationFreeCamera&&(i.useMultiview&&(i.vrDeviceOrientationCameraMetrics||(i.vrDeviceOrientationCameraMetrics=go.GetDefault()),i.vrDeviceOrientationCameraMetrics.multiviewEnabled=!0),this.jY=new _o("VRDeviceOrientationVRHelper",this.rA,this.Kt,!0,i.vrDeviceOrientationCameraMetrics),this.jY.angularSensibility=Number.MAX_VALUE),this.YY=new Lo("WebVRHelper",this.rA,this.Kt,i),this.YY.useStandingMatrix(),this.NY=new Dc((()=>this.currentVRCamera),t),!this.J$){this.RY=document.createElement("BUTTON"),this.RY.className="babylonVRicon",this.RY.id="babylonVRiconbtn",this.RY.title="Click to switch to VR";let t=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";t+=".babylonVRicon.vrdisplaypresenting { display: none; }";const i=document.createElement("style");i.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(i),this.xY()}this.RY&&this.RY.addEventListener("click",(()=>{this.isInVRMode?this.Kt.getEngine().disableVR():this.enterVR()}));const e=this.Kt.getEngine().getHostWindow();e&&(e.addEventListener("resize",this.TM),document.addEventListener("fullscreenchange",this.yw,!1),i.createFallbackVRDeviceOrientationFreeCamera?this.KY():this.Kt.getEngine().onVRDisplayChangedObservable.add((t=>{t.vrDisplay&&this.KY()})),this.Im=t=>{27===t.keyCode&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this.Im),this.Kt.onPrePointerObservable.add((()=>{this.zY&&this.exitVROnDoubleTap&&(this.exitVR(),this.Z$&&this.Kt.getEngine().exitFullscreen())}),pe.POINTERDOUBLETAP,!1),this.qY=t=>this.QY(t),this.ZY=()=>this._H(),this.JY=()=>{this.q$=!0,this.IY()},this.tj=()=>{this.q$=!1,this.IY()},t.getEngine().onVRDisplayChangedObservable.add(this.qY),t.getEngine().onVRRequestPresentStart.add(this.JY),t.getEngine().onVRRequestPresentComplete.add(this.tj),e.addEventListener("vrdisplaypresentchange",this.ZY),t.onDisposeObservable.add((()=>{this.dispose()})),this.YY.onControllerMeshLoadedObservable.add((t=>this.ij(t))),this.Kt.gamepadManager.onGamepadConnectedObservable.add(this.PY),this.Kt.gamepadManager.onGamepadDisconnectedObservable.add(this.VY),this.IY(),this.ej=new qe,this.ej.setEasingMode(Ke.EASINGMODE_EASEINOUT),this.sj=this.ej,t.onPointerObservable.add((i=>{this.k$&&t.activeCamera===this.vrDeviceOrientationCamera&&"mouse"===i.event.pointerType&&(i.type===pe.POINTERDOWN?this.NY.L$():i.type===pe.POINTERUP&&this.NY.F$())})),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}ij(t){this.QH&&this.QH.webVRController==t&&t.mesh&&this.QH.H$(t.mesh),this.ZH&&this.ZH.webVRController==t&&t.mesh&&this.ZH.H$(t.mesh);try{this.onControllerMeshLoadedObservable.notifyObservers(t)}catch(t){F.Warn("Error in your custom logic onControllerMeshLoaded: "+t)}}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===Sc.IN_XR||this.Q$||this.Z$}_H(){const t=this.Kt.getEngine().getVRDevice();if(t){const i=this.Q$;this.Q$=t.isPresenting,i&&!this.Q$&&this.exitVR()}else F.Warn("Detected VRDisplayPresentChange on an unknown VRDisplay. Did you can enterVR on the vrExperienceHelper?");this.IY()}QY(t){this.j$=t.vrSupported,this.K$=!!t.vrDisplay,this.Q$=t.vrDisplay&&t.vrDisplay.isPresenting,this.IY()}xY(){if(this.TY&&!this.J$&&this.RY){const t=this.TY.getBoundingClientRect();this.RY.style.top=t.top+t.height-70+"px",this.RY.style.left=t.left+t.width-100+"px"}}KY(){this.J$||this.nj||!this.RY||(document.body.appendChild(this.RY),this.nj=!0)}IY(){this.RY&&!this.J$&&(this.RY.className="babylonVRicon",this.isInVRMode?this.RY.className+=" vrdisplaypresenting":(this.K$&&(this.RY.className+=" vrdisplayready"),this.j$&&(this.RY.className+=" vrdisplaysupported"),this.q$&&(this.RY.className+=" vrdisplayrequesting")))}enterVR(){if(this.xr)this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);else{if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(t){F.Warn("Error in your custom logic onEnteringVR: "+t)}if(this.Kt.activeCamera){if(this.rA=this.Kt.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=T.FromRotationMatrix(this.Kt.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this.webVRCamera){const t=this.webVRCamera.deviceRotationQuaternion.toEulerAngles().y,i=T.FromRotationMatrix(this.Kt.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles().y-t,e=this.webVRCamera.rotationQuaternion.toEulerAngles().y;this.webVRCamera.rotationQuaternion=T.FromEulerAngles(0,e+i,0)}this.XY=this.Kt.activeCamera,this.XY.angularSensibilityX&&(this.MY.angularSensibilityX=this.XY.angularSensibilityX,this.XY.angularSensibilityX=Number.MAX_VALUE),this.XY.angularSensibilityY&&(this.MY.angularSensibilityY=this.XY.angularSensibilityY,this.XY.angularSensibilityY=Number.MAX_VALUE),this.XY.angularSensibility&&(this.MY.angularSensibility=this.XY.angularSensibility,this.XY.angularSensibility=Number.MAX_VALUE)}this.q$||(this.K$?this.Q$||(this.Kt.getEngine().onVRRequestPresentComplete.addOnce((t=>{this.onAfterEnteringVRObservable.notifyObservers({success:t})})),this.YY.position=this.rA,this.Kt.activeCamera=this.YY):this.jY&&(this.jY.position=this.rA,this.Kt.activeCamera&&(this.jY.minZ=this.Kt.activeCamera.minZ),this.Kt.activeCamera=this.jY,this.Kt.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this.IY(),this.jY.onViewMatrixChangedObservable.addOnce((()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})}))),this.Kt.activeCamera&&this.TY&&this.Kt.activeCamera.attachControl(),this.k$&&this.Kt.registerBeforeRender(this.bY),this.wY&&[this.QH,this.ZH].forEach((t=>{t&&t.B$()})),this.zY=!0)}}exitVR(){if(this.xr)this.xr.baseExperience.exitXRAsync();else if(this.zY){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(t){F.Warn("Error in your custom logic onExitingVR: "+t)}this.Q$&&this.Kt.getEngine().disableVR(),this.Kt.activeCamera&&(this.rA=this.Kt.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this.HY?(this.HY.position=this.rA,this.Kt.activeCamera=this.HY,this.MY.angularSensibilityX&&(this.HY.angularSensibilityX=this.MY.angularSensibilityX,this.MY.angularSensibilityX=null),this.MY.angularSensibilityY&&(this.HY.angularSensibilityY=this.MY.angularSensibilityY,this.MY.angularSensibilityY=null),this.MY.angularSensibility&&(this.HY.angularSensibility=this.MY.angularSensibility,this.MY.angularSensibility=null)):this.XY&&(this.XY.position=this.rA,this.Kt.activeCamera=this.XY,this.TY&&this.Kt.activeCamera.attachControl(),this.MY.angularSensibilityX&&(this.XY.angularSensibilityX=this.MY.angularSensibilityX,this.MY.angularSensibilityX=null),this.MY.angularSensibilityY&&(this.XY.angularSensibilityY=this.MY.angularSensibilityY,this.MY.angularSensibilityY=null),this.MY.angularSensibility&&(this.XY.angularSensibility=this.MY.angularSensibility,this.MY.angularSensibility=null)),this.IY(),this.k$&&(this.Kt.unregisterBeforeRender(this.bY),this.NY.P$.isVisible=!1,this.QH&&(this.QH.P$.isVisible=!1),this.ZH&&(this.ZH.P$.isVisible=!1)),this.Kt.getEngine().resize(),[this.QH,this.ZH].forEach((t=>{t&&t.U$()})),this.zY=!1;const t=this.Kt.getEngine();t._H&&t._H()}}get position(){return this.rA}set position(t){this.rA=t,this.Kt.activeCamera&&(this.Kt.activeCamera.position=t)}enableInteractions(){if(!this.k$){if(this.AY=!0,this.xr)return void(this.xr.baseExperience.state===Sc.IN_XR&&this.xr.pointerSelection.attach());this.QH&&this.BY(this.QH),this.ZH&&this.BY(this.ZH),this.raySelectionPredicate=t=>t.isVisible&&(t.isPickable||t.name===this.rj),this.meshSelectionPredicate=()=>!0,this.hj=t=>!!(this.oj(t)||-1===t.name.indexOf("gazeTracker")&&-1===t.name.indexOf("teleportationTarget")&&-1===t.name.indexOf("torusTeleportation"))&&this.raySelectionPredicate(t),this.k$=!0}}get yY(){return!(this.QH&&this.QH.y$||this.ZH&&this.ZH.y$)}oj(t){for(let i=0;i<this.eY.length;i++)if(this.eY[i].id===t.id)return!0;return!(!this.rj||t.name!==this.rj)}addFloorMesh(t){this.eY&&(this.eY.indexOf(t)>-1||this.eY.push(t))}removeFloorMesh(t){if(!this.eY)return;const i=this.eY.indexOf(t);-1!==i&&this.eY.splice(i,1)}enableTeleportation(t={}){if(!this.EY){if(this.tY=!0,this.enableInteractions(),this.webVROptions.useXR&&(t.floorMeshes||t.floorMeshName)){const i=t.floorMeshes||[];if(!i.length){const e=this.Kt.getMeshByName(t.floorMeshName);e&&i.push(e)}if(this.xr)return i.forEach((t=>{this.xr.teleportation.addFloorMesh(t)})),void(this.xr.teleportation.attached||this.xr.teleportation.attach());if(!this.xrTestDone){const i=()=>{this.xrTestDone&&(this.Kt.unregisterBeforeRender(i),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(t))};return void this.Kt.registerBeforeRender(i)}}t.floorMeshName&&(this.rj=t.floorMeshName),t.floorMeshes&&(this.eY=t.floorMeshes),t.teleportationMode&&(this.sY=t.teleportationMode),t.teleportationTime&&t.teleportationTime>0&&(this.nY=t.teleportationTime),t.teleportationSpeed&&t.teleportationSpeed>0&&(this.rY=t.teleportationSpeed),void 0!==t.easingFunction&&(this.sj=t.easingFunction),null!=this.QH&&this.UY(this.QH),null!=this.ZH&&this.UY(this.ZH);const i=new ji;i.vignetteColor=new y(0,0,0,0),i.vignetteEnabled=!0,this.aj=new oc("postProcessMove",1,this.YY,void 0,void 0,void 0,void 0,i),this.YY.detachPostProcess(this.aj),this.EY=!0,this.aY&&(this.lj(),this.$Y.scaling.scaleInPlace(this.YY.deviceScaleFactor))}}BY(t){t.webVRController.mesh&&(t.k$=!0,this.isInVRMode&&this.wY&&t.B$(),this.webVROptions.laserToggle&&t.webVRController.onMainButtonStateChangedObservable.add((i=>{this.wY&&1===i.value&&(t.y$?t.U$():t.B$(),this.displayGaze&&(t.P$.isVisible=t.y$))})),t.webVRController.onTriggerStateChangedObservable.add((i=>{let e=t;this.yY&&(e=this.NY),e.x$?i.value<this.pY&&e.F$():i.value>this.dY&&e.L$()})))}DY(t,i){this.R$&&!i.R$||(i.R$?Math.sqrt(t.y*t.y+t.x*t.x)<this.pY&&(this.iY&&this.teleportCamera(this.fY),i.R$=!1):t.y<-this.dY&&i._$&&(i.B$(),i.R$=!0))}OY(t,i){i.R$||(i.b$?t.x>-this.pY&&(i.b$=!1):t.x<-this.dY&&i._$&&(i.b$=!0,this.hY&&this.eV(!1)),i.M$?t.x<this.pY&&(i.M$=!1):t.x>this.dY&&i._$&&(i.M$=!0,this.hY&&this.eV(!0)))}LY(t,i){if(!i.R$)if(t.y>this.dY&&i._$){if(!i.I$){if(!this.currentVRCamera)return;let t=T.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),e=this.currentVRCamera.position;this.currentVRCamera.devicePosition&&this.currentVRCamera.deviceRotationQuaternion&&(t=this.currentVRCamera.deviceRotationQuaternion,e=this.currentVRCamera.devicePosition),t.toEulerAnglesToRef(this.WH),this.WH.z=0,this.WH.x=0,T.RotationYawPitchRollToRef(this.WH.y,this.WH.x,this.WH.z,this.kY),this.kY.toRotationMatrix(this.zG),w.TransformCoordinatesToRef(this.oY,this.zG,this.WH);const s=new vn(e,this.WH),n=this.Kt.pickWithRay(s,this.hj);n&&n.pickedPoint&&n.pickedMesh&&this.oj(n.pickedMesh)&&n.distance<5&&this.teleportCamera(n.pickedPoint),i.I$=!0}}else i.I$=!1}UY(t){t.webVRController.mesh&&(t.k$||this.BY(t),t.k$=!0,t.G$=!0,t.webVRController.controllerType===Ah.VIVE&&(t._$=!1,t.webVRController.onPadStateChangedObservable.add((i=>{t._$=i.pressed,t._$||(t.b$=!1,t.M$=!1,t.I$=!1)}))),t.webVRController.onPadValuesChangedObservable.add((i=>{this.teleportationEnabled&&(this.LY(i,t),this.DY(i,t)),this.OY(i,t)})))}lj(){this.$Y=bc("teleportationTarget",{width:2,height:2,subdivisions:2},this.Kt),this.$Y.isPickable=!1;const t=new nc("DynamicTexture",512,this.Kt,!0);t.hasAlpha=!0;const i=t.getContext();i.beginPath(),i.arc(256,256,200,0,2*Math.PI,!1),i.fillStyle=this.lY,i.fill(),i.lineWidth=10,i.strokeStyle=this.cY,i.stroke(),i.closePath(),t.update();const e=new sc("TextPlaneMaterial",this.Kt);e.diffuseTexture=t,this.$Y.material=e;const s=xc("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this.Kt);s.isPickable=!1,s.parent=this.$Y;const n=new vt("animationInnerCircle","position.y",30,vt.ANIMATIONTYPE_FLOAT,vt.ANIMATIONLOOPMODE_CYCLE),r=[];r.push({frame:0,value:0}),r.push({frame:30,value:.4}),r.push({frame:60,value:0}),n.setKeys(r);const h=new Ze;h.setEasingMode(Ke.EASINGMODE_EASEINOUT),n.setEasingFunction(h),s.animations=[],s.animations.push(n),this.Kt.beginAnimation(s,0,60,!0),this.cj()}uj(){this.iY=!0,this.EY&&(this.$Y.isVisible=!0,this.aY&&(this.$Y.getChildren()[0].isVisible=!0))}cj(){this.iY=!1,this.EY&&(this.$Y.isVisible=!1,this.aY&&(this.$Y.getChildren()[0].isVisible=!1))}eV(t){if(!(this.currentVRCamera instanceof Dh))return;t?this.uY++:this.uY--,this.currentVRCamera.animations=[];const i=T.FromRotationMatrix(R.RotationY(Math.PI/4*this.uY)),e=new vt("animationRotation","rotationQuaternion",90,vt.ANIMATIONTYPE_QUATERNION,vt.ANIMATIONLOOPMODE_CONSTANT),s=[];s.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),s.push({frame:6,value:i}),e.setKeys(s),e.setEasingFunction(this.ej),this.currentVRCamera.animations.push(e),this.aj.animations=[];const n=new vt("animationPP","vignetteWeight",90,vt.ANIMATIONTYPE_FLOAT,vt.ANIMATIONLOOPMODE_CONSTANT),r=[];r.push({frame:0,value:0}),r.push({frame:3,value:4}),r.push({frame:6,value:0}),n.setKeys(r),n.setEasingFunction(this.ej),this.aj.animations.push(n);const h=new vt("animationPP2","vignetteStretch",90,vt.ANIMATIONTYPE_FLOAT,vt.ANIMATIONLOOPMODE_CONSTANT),o=[];o.push({frame:0,value:0}),o.push({frame:3,value:10}),o.push({frame:6,value:0}),h.setKeys(o),h.setEasingFunction(this.ej),this.aj.animations.push(h),this.aj.imageProcessingConfiguration.vignetteWeight=0,this.aj.imageProcessingConfiguration.vignetteStretch=0,this.aj.samples=4,this.YY.attachPostProcess(this.aj),this.Kt.beginAnimation(this.aj,0,6,!1,1,(()=>{this.YY.detachPostProcess(this.aj)})),this.Kt.beginAnimation(this.currentVRCamera,0,6,!1,1)}fj(t,i,e){if(t.pickedPoint){i.R$&&(this.uj(),this.fY.copyFrom(t.pickedPoint),this.$Y.position.copyFrom(t.pickedPoint));const s=this.dj(t.getNormal(!0,!1),e);if(s){const t=w.Cross(Ge.Y,s),i=w.Cross(s,t);w.RotationFromAxisToRef(i,s,t,this.$Y.rotation)}this.$Y.position.y+=.1}}teleportCamera(t){if(!(this.currentVRCamera instanceof Dh))return;this.webVRCamera.leftCamera?(this.WH.copyFrom(this.webVRCamera.leftCamera.globalPosition),this.WH.subtractInPlace(this.webVRCamera.position),t.subtractToRef(this.WH,this.WH)):this.WH.copyFrom(t),this.isInVRMode?this.WH.y+=this.webVRCamera.deviceDistanceToRoomGround()*this.YY.deviceScaleFactor:this.WH.y+=this.HH,this.onBeforeCameraTeleport.notifyObservers(this.WH);let i,e;if(this.sY==Lc.TELEPORTATIONMODE_CONSTANTSPEED){e=90;const t=w.Distance(this.currentVRCamera.position,this.WH);i=this.rY/t}else e=Math.round(90*this.nY/1e3),i=1;this.currentVRCamera.animations=[];const s=new vt("animationCameraTeleportation","position",90,vt.ANIMATIONTYPE_VECTOR3,vt.ANIMATIONLOOPMODE_CONSTANT),n=[{frame:0,value:this.currentVRCamera.position},{frame:e,value:this.WH}];s.setKeys(n),s.setEasingFunction(this.sj),this.currentVRCamera.animations.push(s),this.aj.animations=[];const r=Math.round(e/2),h=new vt("animationPP","vignetteWeight",90,vt.ANIMATIONTYPE_FLOAT,vt.ANIMATIONLOOPMODE_CONSTANT),o=[];o.push({frame:0,value:0}),o.push({frame:r,value:8}),o.push({frame:e,value:0}),h.setKeys(o),this.aj.animations.push(h);const a=new vt("animationPP2","vignetteStretch",90,vt.ANIMATIONTYPE_FLOAT,vt.ANIMATIONLOOPMODE_CONSTANT),l=[];l.push({frame:0,value:0}),l.push({frame:r,value:10}),l.push({frame:e,value:0}),a.setKeys(l),this.aj.animations.push(a),this.aj.imageProcessingConfiguration.vignetteWeight=0,this.aj.imageProcessingConfiguration.vignetteStretch=0,this.YY.attachPostProcess(this.aj),this.Kt.beginAnimation(this.aj,0,e,!1,i,(()=>{this.YY.detachPostProcess(this.aj)})),this.Kt.beginAnimation(this.currentVRCamera,0,e,!1,i,(()=>{this.onAfterCameraTeleport.notifyObservers(this.WH)})),this.cj()}dj(t,i){if(t){Math.acos(w.Dot(t,i.direction))<Math.PI/2&&t.scaleInPlace(-1)}return t}_Y(t){if(!(this.currentVRCamera instanceof Dh))return;const i=t.D$(this.GY),e=this.Kt.pickWithRay(i,this.hj);if(e&&this.Kt.simulatePointerMove(e,{pointerId:t.Al}),t.O$=e,e&&e.pickedPoint){if(this.CY){let s=1;t.P$.isVisible=!0,t.T$&&(s=3),this.updateGazeTrackerScale&&(t.P$.scaling.x=e.distance*s,t.P$.scaling.y=e.distance*s,t.P$.scaling.z=e.distance*s);const n=this.dj(e.getNormal(),i),r=.002;if(n){const i=w.Cross(Ge.Y,n),e=w.Cross(n,i);w.RotationFromAxisToRef(e,n,i,t.P$.rotation)}t.P$.position.copyFrom(e.pickedPoint),t.P$.position.x<0?t.P$.position.x+=r:t.P$.position.x-=r,t.P$.position.y<0?t.P$.position.y+=r:t.P$.position.y-=r,t.P$.position.z<0?t.P$.position.z+=r:t.P$.position.z-=r}t.V$(e.distance)}else t.V$(),t.P$.isVisible=!1;if(e&&e.pickedMesh){if(this.EY&&this.oj(e.pickedMesh)&&e.pickedPoint)return t.pj&&!this.oj(t.pj)&&this.mj(t.pj),t.pj=null,void(t.R$&&this.fj(e,t,i));if(e.pickedMesh!==t.pj)if(this.meshSelectionPredicate(e.pickedMesh)){this.onNewMeshPicked.notifyObservers(e),t.pj=e.pickedMesh,e.pickedMesh.isPickable&&e.pickedMesh.actionManager?(this.changeGazeColor(this.SY),this.changeLaserColor(this.gY),t.T$=!0):(this.changeGazeColor(this.mY),this.changeLaserColor(this.vY),t.T$=!1);try{this.onNewMeshSelected.notifyObservers(e.pickedMesh);const i=t;i.webVRController&&this.onMeshSelectedWithController.notifyObservers({mesh:e.pickedMesh,controller:i.webVRController})}catch(t){F.Warn("Error while raising onNewMeshSelected or onMeshSelectedWithController: "+t)}}else this.mj(t.pj),t.pj=null,this.changeGazeColor(this.mY),this.changeLaserColor(this.vY)}else this.mj(t.pj),t.pj=null,this.changeGazeColor(this.mY),this.changeLaserColor(this.vY)}mj(t){t&&this.onSelectedMeshUnselected.notifyObservers(t)}setLaserColor(t,i=this.gY){this.vY=t,this.gY=i}setLaserLightingState(t=!0){this.QH&&this.QH.$$(!t),this.ZH&&this.ZH.$$(!t)}setGazeColor(t,i=this.SY){this.mY=t,this.SY=i}changeLaserColor(t){this.updateControllerLaserColor&&(this.QH&&this.QH.W$(t),this.ZH&&this.ZH.W$(t))}changeGazeColor(t){this.updateGazeTrackerColor&&this.NY.P$.material&&(this.NY.P$.material.emissiveColor=t,this.QH&&(this.QH.P$.material.emissiveColor=t),this.ZH&&(this.ZH.P$.material.emissiveColor=t))}dispose(){this.isInVRMode&&this.exitVR(),this.aj&&this.aj.dispose(),this.YY&&this.YY.dispose(),this.jY&&this.jY.dispose(),!this.J$&&this.RY&&this.RY.parentNode&&document.body.removeChild(this.RY),this.HY&&this.Kt.activeCamera!=this.HY&&this.HY.dispose(),this.NY&&this.NY.dispose(),this.QH&&this.QH.dispose(),this.ZH&&this.ZH.dispose(),this.$Y&&this.$Y.dispose(),this.xr&&this.xr.dispose(),this.eY.length=0,document.removeEventListener("keydown",this.Im),window.removeEventListener("vrdisplaypresentchange",this.ZY),window.removeEventListener("resize",this.TM),document.removeEventListener("fullscreenchange",this.yw),this.Kt.getEngine().onVRDisplayChangedObservable.removeCallback(this.qY),this.Kt.getEngine().onVRRequestPresentStart.removeCallback(this.JY),this.Kt.getEngine().onVRRequestPresentComplete.removeCallback(this.tj),this.Kt.gamepadManager.onGamepadConnectedObservable.removeCallback(this.PY),this.Kt.gamepadManager.onGamepadDisconnectedObservable.removeCallback(this.VY),this.Kt.unregisterBeforeRender(this.bY)}getClassName(){return"VRExperienceHelper"}}Lc.TELEPORTATIONMODE_CONSTANTTIME=0,Lc.TELEPORTATIONMODE_CONSTANTSPEED=1;const Oc=function(){const t={root:0,found:!1};return function(i,e,s,n){t.root=0,t.found=!1;const r=e*e-4*i*s;if(r<0)return t;const h=Math.sqrt(r);let o=(-e-h)/(2*i),a=(-e+h)/(2*i);if(o>a){const t=a;a=o,o=t}return o>0&&o<n?(t.root=o,t.found=!0,t):a>0&&a<n?(t.root=a,t.found=!0,t):t}}();class Fc{constructor(){this.vj=w.Zero(),this.gj=w.Zero(),this.xL=w.Zero(),this.Sj=w.Zero(),this.Ej=w.Zero(),this.Aj=w.Zero(),this.Cj=w.Zero(),this.wj=w.Zero(),this.xj=w.Zero(),this.Tj=w.Zero(),this.Rj=w.Zero(),this.eR=w.One(),this.Ij=0,this.Mj=w.Zero(),this.bj=w.Zero(),this._j=w.Zero(),this.sT=-1}get collisionMask(){return this.sT}set collisionMask(t){this.sT=isNaN(t)?-1:t}get slidePlaneNormal(){return this.Tj}yj(t,i,e){this.Nj=i,this.Pj=this.Nj.lengthSquared();const s=Math.sqrt(this.Pj);0===s||1===s?this._j.copyFromFloats(i.U,i.V,i.k):i.scaleToRef(1/s,this._j),this.Dj=t,t.multiplyToRef(this.eR,this.Mj),i.multiplyToRef(this.eR,this.bj),this.Lj=this.bj.length(),this.Oj=e,this.collisionFound=!1}Fj(t,i,e,s,n){i.subtractToRef(t,this.xL),e.subtractToRef(t,this.Sj),w.CrossToRef(this.xL,this.Sj,this.Aj);let r=w.Dot(this.Aj,n);return!(r<0)&&(s.subtractToRef(t,this.Ej),w.CrossToRef(this.Sj,this.Ej,this.Aj),r=w.Dot(this.Aj,n),!(r<0)&&(w.CrossToRef(this.Ej,this.xL,this.Aj),r=w.Dot(this.Aj,n),r>=0))}rC(t,i,e,s){const n=w.Distance(this.Mj,t),r=Math.max(this.eR.x,this.eR.y,this.eR.z);return!(n>this.Lj+r+i)&&!!((t,i,e,s)=>!(t.x>e.x+s||e.x-s>i.x||t.y>e.y+s||e.y-s>i.y||t.z>e.z+s||e.z-s>i.z))(e,s,this.Mj,this.Lj+r)}Bj(t,i,e,s,n,r,h){let o,a=!1;i||(i=[]),i[t]||(i[t]=new Pe(0,0,0,0),i[t].copyFromPoints(e,s,n));const l=i[t];if(!r&&!l.isFrontFacingTo(this._j,0))return;const c=l.signedDistanceTo(this.Dj),u=w.Dot(l.normal,this.Nj);if(Fc.DoubleSidedCheck&&u>1e-4)return;if(0==u){if(Math.abs(c)>=1)return;a=!0,o=0}else{o=(-1-c)/u;let t=(1-c)/u;if(o>t){const i=t;t=o,o=i}if(o>1||t<0)return;o<0&&(o=0),o>1&&(o=1)}this.vj.copyFromFloats(0,0,0);let f=!1,d=1;if(a||(this.Dj.subtractToRef(l.normal,this.gj),this.Nj.scaleToRef(o,this.xL),this.gj.addInPlace(this.xL),this.Fj(this.gj,e,s,n,l.normal)&&(f=!0,d=o,this.vj.copyFrom(this.gj))),!f){let t=this.Pj;this.Dj.subtractToRef(e,this.xL);let i=2*w.Dot(this.Nj,this.xL),r=this.xL.lengthSquared()-1,h=Oc(t,i,r,d);h.found&&(d=h.root,f=!0,this.vj.copyFrom(e)),this.Dj.subtractToRef(s,this.xL),i=2*w.Dot(this.Nj,this.xL),r=this.xL.lengthSquared()-1,h=Oc(t,i,r,d),h.found&&(d=h.root,f=!0,this.vj.copyFrom(s)),this.Dj.subtractToRef(n,this.xL),i=2*w.Dot(this.Nj,this.xL),r=this.xL.lengthSquared()-1,h=Oc(t,i,r,d),h.found&&(d=h.root,f=!0,this.vj.copyFrom(n)),s.subtractToRef(e,this.Cj),e.subtractToRef(this.Dj,this.wj);let o=this.Cj.lengthSquared(),a=w.Dot(this.Cj,this.Nj),l=w.Dot(this.Cj,this.wj);if(t=o*-this.Pj+a*a,i=2*(o*w.Dot(this.Nj,this.wj)-a*l),r=o*(1-this.wj.lengthSquared())+l*l,h=Oc(t,i,r,d),h.found){const t=(a*h.root-l)/o;t>=0&&t<=1&&(d=h.root,f=!0,this.Cj.scaleInPlace(t),e.addToRef(this.Cj,this.vj))}if(n.subtractToRef(s,this.Cj),s.subtractToRef(this.Dj,this.wj),o=this.Cj.lengthSquared(),a=w.Dot(this.Cj,this.Nj),l=w.Dot(this.Cj,this.wj),t=o*-this.Pj+a*a,i=2*(o*w.Dot(this.Nj,this.wj)-a*l),r=o*(1-this.wj.lengthSquared())+l*l,h=Oc(t,i,r,d),h.found){const t=(a*h.root-l)/o;t>=0&&t<=1&&(d=h.root,f=!0,this.Cj.scaleInPlace(t),s.addToRef(this.Cj,this.vj))}if(e.subtractToRef(n,this.Cj),n.subtractToRef(this.Dj,this.wj),o=this.Cj.lengthSquared(),a=w.Dot(this.Cj,this.Nj),l=w.Dot(this.Cj,this.wj),t=o*-this.Pj+a*a,i=2*(o*w.Dot(this.Nj,this.wj)-a*l),r=o*(1-this.wj.lengthSquared())+l*l,h=Oc(t,i,r,d),h.found){const t=(a*h.root-l)/o;t>=0&&t<=1&&(d=h.root,f=!0,this.Cj.scaleInPlace(t),n.addToRef(this.Cj,this.vj))}}if(f){const t=d*d*this.Pj;(!this.collisionFound||t<this.Uj)&&(h.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this.vj):this.intersectionPoint=this.vj.clone(),this.Uj=t,this.Vj=Math.sqrt(t),this.collisionFound=!0),this.collidedMesh=h)}}nR(t,i,e,s,n,r,h,o,a,l=!1){if(l)if(e&&0!==e.length)for(let r=s;r<n-2;r+=1){const s=e[r],n=e[r+1],l=e[r+2];if(4294967295===l){r+=2;continue}const c=i[s],u=i[n],f=i[l];c&&u&&f&&((a?1:0)^r%2?this.Bj(r,t,c,u,f,h,o):this.Bj(r,t,u,c,f,h,o))}else for(let e=0;e<i.length-2;e+=1){const s=i[e],n=i[e+1],r=i[e+2];s&&n&&r&&((a?1:0)^e%2?this.Bj(e,t,s,n,r,h,o):this.Bj(e,t,n,s,r,h,o))}else if(e&&0!==e.length)for(let l=s;l<n;l+=3){const s=i[e[l]-r],n=i[e[l+1]-r],c=i[e[l+2]-r];a?this.Bj(l,t,s,n,c,h,o):this.Bj(l,t,c,n,s,h,o)}else for(let e=0;e<i.length;e+=3){const s=i[e],n=i[e+1],r=i[e+2];a?this.Bj(e,t,s,n,r,h,o):this.Bj(e,t,r,n,s,h,o)}}kj(t,i){t.addToRef(i,this.xj),i.scaleInPlace(this.Vj/i.length()),this.Dj.addToRef(i,t),t.subtractToRef(this.intersectionPoint,this.Tj),this.Tj.normalize(),this.Tj.scaleToRef(this.Oj,this.Rj),t.addInPlace(this.Rj),this.intersectionPoint.addInPlace(this.Rj),this.Tj.scaleInPlace(Pe.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this.Tj,this.xj)),this.xj.subtractInPlace(this.Tj),this.xj.subtractToRef(this.intersectionPoint,i)}}Fc.DoubleSidedCheck=!1;class Bc{constructor(){this.Gj=w.Zero(),this.zj=w.Zero(),this.Hj=w.Zero()}getNewPosition(t,i,e,s,n,r,h){t.divideToRef(e.eR,this.Gj),i.divideToRef(e.eR,this.zj),e.collidedMesh=null,e.Ij=0,e.Xj=this.zj,e.Wj=this.Gj,this.rG(this.Gj,this.zj,e,s,this.Hj,n),this.Hj.multiplyInPlace(e.eR),r(h,this.Hj,e.collidedMesh)}createCollider(){return new Fc}init(t){this.Kt=t}rG(t,i,e,s,n,r=null){const h=10*Rs.CollisionsEpsilon;if(e.Ij>=s)return void n.copyFrom(t);const o=r?r.collisionMask:e.collisionMask;e.yj(t,i,h);const a=r&&r.surroundingMeshes||this.Kt.meshes;for(let t=0;t<a.length;t++){const i=a[t];i.isEnabled()&&i.checkCollisions&&i.subMeshes&&i!==r&&0!=(o&i.collisionGroup)&&i.nC(e)}e.collisionFound?(0===i.x&&0===i.y&&0===i.z||e.kj(t,i),i.length()<=h?n.copyFrom(t):(e.Ij++,this.rG(t,i,e,s,n,r))):t.addToRef(i,n)}}ke.CollisionCoordinatorFactory=()=>new Bc;class Uc{constructor(t,i,e,s=""){var n,r;let o;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new h,this.onErrorObservable=new h,this.onBindObservable=new h,this.cs=!1,this.di=!1,this.Es="",this.ws="",this.$j="",this.Ms=null,this.Yj="",this.jj="",this.Vs=qt.WGSL,this.name=t,this.ws=s,this.Ls=e,this.uniqueId=Uc.zs++,this.defines=null!==(n=i.defines)&&void 0!==n?n:"",this.onError=i.onError,this.onCompiled=i.onCompiled,this.Kj=null!==(r=i.entryPoint)&&void 0!==r?r:"main",this.qj=ii.GetShadersStore(this.Vs),this.Qj=ii.GetShadersRepository(this.Vs),this.Zj=ii.GetIncludesShadersStore(this.Vs);const a=xt()?this.Ls.getHostDocument():null;t.computeSource?o="source:"+t.computeSource:t.computeElement?(o=a?a.getElementById(t.computeElement):null,o||(o=t.computeElement)):o=t.compute||t;const l={defines:this.defines.split("\n"),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this.Ls.supportsUniformBuffers,shadersRepository:this.Qj,includesShadersStore:this.Zj,version:(100*this.Ls.version).toString(),platformName:this.Ls.shaderPlatformName,processingContext:null,isNDCHalfZRange:this.Ls.isNDCHalfZRange,useReverseDepthBuffer:this.Ls.useReverseDepthBuffer};this.js(o,"Compute","",(e=>{ti.Initialize(l),ti.PreProcess(e,l,(s=>{this.jj=e,i.processFinalCode&&(s=i.processFinalCode(s));const n=ti.Finalize(s,"",l);this.Ys(n.vertexCode,t)}),this.Ls)}))}Ys(t,i){if(i){const e=i.computeElement||i.compute||i.spectorName||i;this.Yj="//#define SHADER_NAME compute:"+e+"\n"+t}else this.Yj=t;this.Ks()}get key(){return this.ws}isReady(){try{return this.qs()}catch(t){return!1}}qs(){return!!this.di||!!this.Ms&&this.Ms.isReady}getEngine(){return this.Ls}getPipelineContext(){return this.Ms}getCompilationError(){return this.Es}executeWhenCompiled(t){this.isReady()?t(this):(this.onCompileObservable.add((i=>{t(i)})),this.Ms&&!this.Ms.isAsync||setTimeout((()=>{this.Zs(null)}),16))}Zs(t){try{if(this.qs())return}catch(i){return void this.Js(i,t)}setTimeout((()=>{this.Zs(t)}),16)}js(t,i,e,s){if("undefined"!=typeof HTMLElement&&t instanceof HTMLElement){return void s(It(t))}if("source:"===t.substr(0,7))return void s(t.substr(7));if("base64:"===t.substr(0,7)){return void s(window.atob(t.substr(7)))}if(this.qj[t+i+"Shader"])return void s(this.qj[t+i+"Shader"]);if(e&&this.qj[t+e+"Shader"])return void s(this.qj[t+e+"Shader"]);let n;n="."===t[0]||"/"===t[0]||t.indexOf("http")>-1?t:this.Qj+t,this.Ls.tn(n+"."+i.toLowerCase()+".fx",s)}get computeSourceCode(){var t,i;return this.$j?this.$j:null!==(i=null===(t=this.Ms)||void 0===t?void 0:t.Jj())&&void 0!==i?i:this.Yj}get rawComputeSourceCode(){return this.jj}Ks(){const t=this.defines,i=this.Ms;this.di=!1;try{const e=this.Ls;this.Ms=e.createComputePipelineContext(),this.Ms.hn=this.ws,e.tK(this.Ms,this.$j?this.$j:this.Yj,this.jj,this.$j?null:t,this.Kj),e.iK(this.Ms,(()=>{this.Es="",this.di=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),i&&this.getEngine().eK(i)})),this.Ms.isAsync&&this.Zs(i)}catch(t){this.Js(t,i)}}un(t,i){const e=/COMPUTE SHADER ERROR: 0:(\d+?):/;let s=null;if(i&&t){const n=i.match(e);if(n&&2===n.length){const i=parseInt(n[1]),e=t.split("\n",-1);e.length>=i&&(s=`Offending line [${i}] in compute code: ${e[i-1]}`)}}return[t,s]}Js(t,i=null){var e;if(this.Es=t.message,F.Error("Unable to compile compute effect:"),F.Error("Defines:\r\n"+this.defines),Uc.LogShaderCodeOnCompilationError){let t=null,i=null;(null===(e=this.Ms)||void 0===e?void 0:e.Jj())&&([i,t]=this.un(this.Ms.Jj(),this.Es),i&&(F.Error("Compute code:"),F.Error(i))),t&&F.Error(t)}F.Error("Error: "+this.Es),i&&(this.Ms=i,this.di=!0,this.onError&&this.onError(this,this.Es),this.onErrorObservable.notifyObservers(this))}dispose(){this.Ms&&this.Ms.dispose(),this.Ls.sK(this)}static RegisterShader(t,i){ii.GetShadersStore(qt.WGSL)[`${t}ComputeShader`]=i}}var Vc,kc;Uc.zs=0,Uc.LogShaderCodeOnCompilationError=!0,function(t){t[t.Texture=0]="Texture",t[t.StorageTexture=1]="StorageTexture",t[t.UniformBuffer=2]="UniformBuffer",t[t.StorageBuffer=3]="StorageBuffer",t[t.TextureWithoutSampler=4]="TextureWithoutSampler",t[t.Sampler=5]="Sampler"}(Vc||(Vc={})),Ei.prototype.createComputeEffect=function(t,i){throw new Error("createComputeEffect: This engine does not support compute shaders!")},Ei.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")},Ei.prototype.createComputeContext=function(){},Ei.prototype.computeDispatch=function(t,i,e,s,n,r,h){throw new Error("computeDispatch: This engine does not support compute shaders!")},Ei.prototype.areAllComputeEffectsReady=function(){return!0},Ei.prototype.releaseComputeEffects=function(){},Ei.prototype.tK=function(t,i,e,s,n){},Ei.prototype.Io=function(){},Ei.prototype.iK=function(t,i){i()},Ei.prototype.sK=function(t){},Ei.prototype.eK=function(t){};class Gc{constructor(t,i,e,s={}){this.nK={},this.Ss={},this.rK=!1,this.onCompiled=null,this.onError=null,this.name=t,this.Ls=i,this.uniqueId=Le.UniqueId,this.Ls.getCaps().supportComputeShaders?s.bindingsMapping?(this.zr=i.createComputeContext(),this.hK=e,this.wb={bindingsMapping:{},defines:[],...s}):F.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!"):F.Error("This engine does not support compute shaders!")}get options(){return this.wb}get shaderPath(){return this.hK}getClassName(){return"ComputeShader"}setTexture(t,i,e=!0){const s=this.nK[t];this.nK[t]={type:e?Vc.Texture:Vc.TextureWithoutSampler,object:i,indexInGroupEntries:null==s?void 0:s.indexInGroupEntries},this.rK||(this.rK=!s||s.object!==i||s.type!==this.nK[t].type)}setStorageTexture(t,i){const e=this.nK[t];this.rK||(this.rK=!e||e.object!==i),this.nK[t]={type:Vc.StorageTexture,object:i,indexInGroupEntries:null==e?void 0:e.indexInGroupEntries}}setUniformBuffer(t,i){const e=this.nK[t];this.rK||(this.rK=!e||e.object!==i),this.nK[t]={type:Vc.UniformBuffer,object:i,indexInGroupEntries:null==e?void 0:e.indexInGroupEntries}}setStorageBuffer(t,i){const e=this.nK[t];this.rK||(this.rK=!e||e.object!==i),this.nK[t]={type:Vc.StorageBuffer,object:i,indexInGroupEntries:null==e?void 0:e.indexInGroupEntries}}setTextureSampler(t,i){const e=this.nK[t];this.rK||(this.rK=!e||!i.compareSampler(e.object)),this.nK[t]={type:Vc.Sampler,object:i,indexInGroupEntries:null==e?void 0:e.indexInGroupEntries}}isReady(){let t=this.oK;for(const t in this.nK){const i=this.nK[t],e=i.type,s=i.object;switch(e){case Vc.Texture:case Vc.TextureWithoutSampler:case Vc.StorageTexture:if(!s.isReady())return!1;break}}const i=[],e=this.hK;if(this.wb.defines)for(let t=0;t<this.wb.defines.length;t++)i.push(this.wb.defines[t]);const s=i.join("\n");return this.HO!==s&&(this.HO=s,t=this.Ls.createComputeEffect(e,{defines:s,entryPoint:this.wb.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this.oK=t),!!t.isReady()}dispatch(t,i,e){var s;if(!this.isReady())return!1;for(const t in this.nK){const i=this.nK[t];if(!this.wb.bindingsMapping[t])throw new Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+t+"'");if(i.type!==Vc.Texture)continue;const e=this.Ss[t],n=i.object;e&&n.Lb&&e.compareSampler(n.Lb)||(this.Ss[t]=(new hi).setParameters(n.wrapU,n.wrapV,n.wrapR,n.anisotropicFilteringLevel,n.Lb.samplingMode,null===(s=n.Lb)||void 0===s?void 0:s.Hn),this.rK=!0)}return this.rK&&(this.rK=!1,this.zr.clear()),this.Ls.computeDispatch(this.oK,this.zr,this.nK,t,i,e,this.wb.bindingsMapping),!0}dispatchWhenReady(t,i,e,s=10){return new Promise((n=>{const r=()=>{this.dispatch(t,i,e)?n():setTimeout(r,s)};r()}))}serialize(){const t=ot.Serialize(this);t.options=this.wb,t.shaderPath=this.hK,t.bindings={},t.textures={};for(const i in this.nK){const e=this.nK[i],s=e.object;switch(e.type){case Vc.Texture:case Vc.TextureWithoutSampler:case Vc.StorageTexture:{const n=s.serialize();n&&(t.textures[i]=n,t.bindings[i]={type:e.type});break}case Vc.UniformBuffer:}}return t}static Parse(t,i,e){const s=ot.Parse((()=>new Gc(t.name,i.getEngine(),t.shaderPath,t.options)),t,i,e);for(const n in t.textures){const r=t.bindings[n],h=an.Parse(t.textures[n],i,e);r.type===Vc.Texture?s.setTexture(n,h):r.type===Vc.TextureWithoutSampler?s.setTexture(n,h,!1):s.setStorageTexture(n,h)}return s}}ut([Q()],Gc.prototype,"name",void 0),v("BABYLON.ComputeShader",Gc);class zc{constructor(t,i,e,s,n,r){this.entries=new Array,this.aK=new Array,this.lK=e,this.cK=s,this.uK=n,this.fK=r,this.dK=t,this.pK=i,this.aK.push(t.clone()),this.aK.push(i.clone()),this.aK.push(t.clone()),this.aK[2].x=i.x,this.aK.push(t.clone()),this.aK[3].y=i.y,this.aK.push(t.clone()),this.aK[4].z=i.z,this.aK.push(i.clone()),this.aK[5].z=t.z,this.aK.push(i.clone()),this.aK[6].x=t.x,this.aK.push(i.clone()),this.aK[7].y=t.y}get capacity(){return this.lK}get minPoint(){return this.dK}get maxPoint(){return this.pK}addEntry(t){if(this.blocks)for(let i=0;i<this.blocks.length;i++){this.blocks[i].addEntry(t)}else this.fK(t,this),this.entries.length>this.capacity&&this.cK<this.uK&&this.createInnerBlocks()}removeEntry(t){if(this.blocks){for(let i=0;i<this.blocks.length;i++){this.blocks[i].removeEntry(t)}return}const i=this.entries.indexOf(t);i>-1&&this.entries.splice(i,1)}addEntries(t){for(let i=0;i<t.length;i++){const e=t[i];this.addEntry(e)}}select(t,i,e){if(ls.IsInFrustum(this.aK,t)){if(this.blocks){for(let s=0;s<this.blocks.length;s++){this.blocks[s].select(t,i,e)}return}e?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}}intersects(t,i,e,s){if(ls.IntersectsSphere(this.dK,this.pK,t,i)){if(this.blocks){for(let n=0;n<this.blocks.length;n++){this.blocks[n].intersects(t,i,e,s)}return}s?e.concat(this.entries):e.concatWithNoDuplicate(this.entries)}}intersectsRay(t,i){if(t.intersectsBoxMinMax(this.dK,this.pK)){if(this.blocks){for(let e=0;e<this.blocks.length;e++){this.blocks[e].intersectsRay(t,i)}return}i.concatWithNoDuplicate(this.entries)}}createInnerBlocks(){zc.mK(this.dK,this.pK,this.entries,this.lK,this.cK,this.uK,this,this.fK),this.entries.splice(0)}static mK(t,i,e,s,n,r,h,o){h.blocks=new Array;const a=new w((i.x-t.x)/2,(i.y-t.y)/2,(i.z-t.z)/2);for(let i=0;i<2;i++)for(let l=0;l<2;l++)for(let c=0;c<2;c++){const u=t.add(a.multiplyByFloats(i,l,c)),f=t.add(a.multiplyByFloats(i+1,l+1,c+1)),d=new zc(u,f,s,n+1,r,o);d.addEntries(e),h.blocks.push(d)}}}class Hc{constructor(t,i,e=2){this.maxDepth=e,this.dynamicContent=new Array,this.vK=i||64,this.gK=new Hi(1024),this.fK=t}update(t,i,e){zc.mK(t,i,e,this.vK,0,this.maxDepth,this,this.fK)}addMesh(t){for(let i=0;i<this.blocks.length;i++){this.blocks[i].addEntry(t)}}removeMesh(t){for(let i=0;i<this.blocks.length;i++){this.blocks[i].removeEntry(t)}}select(t,i){this.gK.reset();for(let e=0;e<this.blocks.length;e++){this.blocks[e].select(t,this.gK,i)}return i?this.gK.concat(this.dynamicContent):this.gK.concatWithNoDuplicate(this.dynamicContent),this.gK}intersects(t,i,e){this.gK.reset();for(let s=0;s<this.blocks.length;s++){this.blocks[s].intersects(t,i,this.gK,e)}return e?this.gK.concat(this.dynamicContent):this.gK.concatWithNoDuplicate(this.dynamicContent),this.gK}intersectsRay(t){this.gK.reset();for(let i=0;i<this.blocks.length;i++){this.blocks[i].intersectsRay(t,this.gK)}return this.gK.concatWithNoDuplicate(this.dynamicContent),this.gK}}Hc.CreationFuncForMeshes=(t,i)=>{const e=t.getBoundingInfo();!t.isBlocked&&e.boundingBox.intersectsMinMax(i.minPoint,i.maxPoint)&&i.entries.push(t)},Hc.CreationFuncForSubMeshes=(t,i)=>{t.getBoundingInfo().boundingBox.intersectsMinMax(i.minPoint,i.maxPoint)&&i.entries.push(t)},ke.prototype.createOrUpdateSelectionOctree=function(t=64,i=2){let e=this.Mg(fe.NAME_OCTREE);e||(e=new Xc(this),this.Ig(e)),this.SK||(this.SK=new Hc(Hc.CreationFuncForMeshes,t,i));const s=this.getWorldExtends();return this.SK.update(s.min,s.max,this.meshes),this.SK},Object.defineProperty(ke.prototype,"selectionOctree",{get:function(){return this.SK},enumerable:!0,configurable:!0}),ys.prototype.createOrUpdateSubmeshesOctree=function(t=64,i=2){const e=this.getScene();let s=e.Mg(fe.NAME_OCTREE);s||(s=new Xc(e),e.Ig(s)),this.EK||(this.EK=new Hc(Hc.CreationFuncForSubMeshes,t,i)),this.computeWorldMatrix(!0);const n=this.getBoundingInfo().boundingBox;return this.EK.update(n.minimumWorld,n.maximumWorld,this.subMeshes),this.EK};class Xc{constructor(t){this.name=fe.NAME_OCTREE,this.checksIsEnabled=!0,this.AK=new vn(w.Zero(),new w(1,1,1)),(t=t||E.LastCreatedScene)&&(this.scene=t,this.scene.getActiveMeshCandidates=this.getActiveMeshCandidates.bind(this),this.scene.getActiveSubMeshCandidates=this.getActiveSubMeshCandidates.bind(this),this.scene.getCollidingSubMeshCandidates=this.getCollidingSubMeshCandidates.bind(this),this.scene.getIntersectingSubMeshCandidates=this.getIntersectingSubMeshCandidates.bind(this))}register(){this.scene.onMeshRemovedObservable.add((t=>{const i=this.scene.selectionOctree;if(null!=i){const e=i.dynamicContent.indexOf(t);-1!==e&&i.dynamicContent.splice(e,1)}})),this.scene.onMeshImportedObservable.add((t=>{const i=this.scene.selectionOctree;null!=i&&i.addMesh(t)}))}getActiveMeshCandidates(){var t;return(null===(t=this.scene.SK)||void 0===t?void 0:t.select(this.scene.frustumPlanes))||this.scene.bg()}getActiveSubMeshCandidates(t){if(t.EK&&t.useOctreeForRenderingSelection){return t.EK.select(this.scene.frustumPlanes)}return this.scene._g(t)}getIntersectingSubMeshCandidates(t,i){if(t.EK&&t.useOctreeForPicking){vn.TransformToRef(i,t.getWorldMatrix(),this.AK);return t.EK.intersectsRay(this.AK)}return this.scene._g(t)}getCollidingSubMeshCandidates(t,i){if(t.EK&&t.useOctreeForCollisions){const e=i.Lj+Math.max(i.eR.x,i.eR.y,i.eR.z);return t.EK.intersects(i.Mj,e)}return this.scene._g(t)}rebuild(){}dispose(){}}class Wc{constructor(t,i=!0){this.originalScene=t,this.Xp={},this.CK={},this.wK=null,this.xK=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new h,this.utilityLayerScene=new ke(t.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=t.useRightHandedSystem,this.utilityLayerScene.ug=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),i&&(this.TK=t.onPrePointerObservable.add((i=>{if(!this.utilityLayerScene.activeCamera)return;if(!this.pickingEnabled)return;if(!this.processAllEvents&&i.type!==pe.POINTERMOVE&&i.type!==pe.POINTERUP&&i.type!==pe.POINTERDOWN&&i.type!==pe.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=t.pointerX,this.utilityLayerScene.pointerY=t.pointerY;const e=i.event;if(t.isPointerCaptured(e.pointerId))return void(this.Xp[e.pointerId]=!1);const s=e=>{let s=null;if(i.nearInteractionPickingInfo)s=i.nearInteractionPickingInfo.pickedMesh.getScene()==e?i.nearInteractionPickingInfo:new oe;else if(e!==this.utilityLayerScene&&i.originalPickingInfo)s=i.originalPickingInfo;else{let n=null;this.xK&&(n=e.wg,e.wg=this.xK,i.ray=null),s=i.ray?e.pickWithRay(i.ray):e.pick(t.pointerX,t.pointerY),n&&(e.wg=n)}return s},n=s(this.utilityLayerScene);if(!i.ray&&n&&(i.ray=n.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(i),this.onlyCheckPointerDownEvents&&i.type!=pe.POINTERDOWN)return i.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new ge(i.type,i.event,n),i.type),void(i.type===pe.POINTERUP&&this.Xp[e.pointerId]&&(this.Xp[e.pointerId]=!1));if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)n&&n.hit&&(i.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new ge(i.type,i.event,n),i.type),i.skipOnPointerObservable=!0);else{const e=s(t),r=i.event;e&&n&&(0===n.distance&&e.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(e.pickedMesh)?(this.RK(i,e,r),i.skipOnPointerObservable=!0):i.type===pe.POINTERDOWN?this.Xp[r.pointerId]=!0:i.type!==pe.POINTERMOVE&&i.type!==pe.POINTERUP||(this.CK[r.pointerId]&&(this.onPointerOutObservable.notifyObservers(r.pointerId),delete this.CK[r.pointerId]),this.RK(i,e,r)):!this.Xp[r.pointerId]&&(n.distance<e.distance||0===e.distance)?(this.RK(i,n,r),i.skipOnPointerObservable||(i.skipOnPointerObservable=n.distance>0)):!this.Xp[r.pointerId]&&n.distance>=e.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(e.pickedMesh)?(this.RK(i,e,r),i.skipOnPointerObservable=!0):(i.type!==pe.POINTERMOVE&&i.type!==pe.POINTERUP||this.CK[r.pointerId]&&(this.onPointerOutObservable.notifyObservers(r.pointerId),delete this.CK[r.pointerId]),this.RK(i,n,r))),i.type===pe.POINTERUP&&this.Xp[r.pointerId]&&(this.Xp[r.pointerId]=!1))}})),this.TK&&t.onPrePointerObservable.makeObserverTopPriority(this.TK)),this.utilityLayerScene.autoClear=!1,this.IK=this.originalScene.onAfterRenderCameraObservable.add((t=>{this.shouldRender&&t==this.getRenderCamera()&&this.render()})),this.MK=this.originalScene.onDisposeObservable.add((()=>{this.dispose()})),this.wV()}getRenderCamera(t){if(this.xK)return this.xK;{let i;return i=this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:this.originalScene.activeCamera,t&&i&&i.isRigCamera?i.rigParent:i}}setRenderCamera(t){this.xK=t}bK(){return this.wK||(this.wK=new Po("shared gizmo light",new w(0,1,0),this.utilityLayerScene),this.wK.intensity=2,this.wK.groundColor=_.Gray()),this.wK}static get DefaultUtilityLayer(){return null==Wc._K?Wc.yK(E.LastCreatedScene):Wc._K}static yK(t){return Wc._K=new Wc(t),Wc._K.originalScene.onDisposeObservable.addOnce((()=>{Wc._K=null})),Wc._K}static get DefaultKeepDepthUtilityLayer(){return null==Wc.NK&&(Wc.NK=new Wc(E.LastCreatedScene),Wc.NK.utilityLayerScene.autoClearDepthAndStencil=!1,Wc.NK.originalScene.onDisposeObservable.addOnce((()=>{Wc.NK=null}))),Wc.NK}RK(t,i,e){t.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new ge(t.type,t.event,i),t.type),this.CK[e.pointerId]=!0)}render(){if(this.wV(),this.utilityLayerScene.activeCamera){const t=this.utilityLayerScene.activeCamera.getScene(),i=this.utilityLayerScene.activeCamera;i.Kt=this.utilityLayerScene,i.leftCamera&&(i.leftCamera.Kt=this.utilityLayerScene),i.rightCamera&&(i.rightCamera.Kt=this.utilityLayerScene),this.utilityLayerScene.render(!1),i.Kt=t,i.leftCamera&&(i.leftCamera.Kt=t),i.rightCamera&&(i.rightCamera.Kt=t)}}dispose(){this.onPointerOutObservable.clear(),this.IK&&this.originalScene.onAfterCameraRenderObservable.remove(this.IK),this.MK&&this.originalScene.onDisposeObservable.remove(this.MK),this.TK&&this.originalScene.onPrePointerObservable.remove(this.TK),this.utilityLayerScene.dispose()}wV(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}Wc._K=null,Wc.NK=null;class $c{constructor(t=Wc.DefaultUtilityLayer){this.gizmoLayer=t,this.PK=null,this.DK=null,this.LK=null,this.QD=1,this.FK=!1,this.BK=!1,this.UK=!0,this.VK=!0,this.kK=!0,this.k$=!0,this.GK=R.RotationY(Math.PI),this.zK=new Ys("gizmoRootNode",t.utilityLayerScene),this.zK.rotationQuaternion=T.Identity(),this.AN=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add((()=>{this.HA()}))}set scaleRatio(t){this.QD=t}get scaleRatio(){return this.QD}get isHovered(){return this.FK}get attachedMesh(){return this.PK}set attachedMesh(t){this.PK=t,t&&(this.DK=t),this.zK.setEnabled(!!t),this.HK(t)}get attachedNode(){return this.DK}set attachedNode(t){this.DK=t,this.PK=null,this.zK.setEnabled(!!t),this.HK(t)}setCustomMesh(t){if(t.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this.zK.getChildMeshes().forEach((t=>{t.dispose()})),t.parent=this.zK,this.BK=!0}set updateGizmoRotationToMatchAttachedMesh(t){this.UK=t}get updateGizmoRotationToMatchAttachedMesh(){return this.UK}set updateGizmoPositionToMatchAttachedMesh(t){this.VK=t}get updateGizmoPositionToMatchAttachedMesh(){return this.VK}set updateScale(t){this.kK=t}get updateScale(){return this.kK}HK(t){}get customRotationQuaternion(){return this.LK}set customRotationQuaternion(t){this.LK=t}HA(){if(this.attachedNode){let t=this.attachedNode;if(this.attachedMesh&&(t=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh){const i=t.getWorldMatrix().getRow(3),e=i?i.toVector3():new w(0,0,0);this.zK.position.copyFrom(e)}if(this.updateGizmoRotationToMatchAttachedMesh){const i=t.Mt||"AbstractMesh"===t.getClassName()||"TransformNode"===t.getClassName()||"InstancedMesh"===t.getClassName()?t:void 0;t.getWorldMatrix().decompose(void 0,this.zK.rotationQuaternion,void 0,$c.PreserveScaling?i:void 0)}else this.LK?this.zK.rotationQuaternion.copyFrom(this.LK):this.zK.rotationQuaternion.set(0,0,0,1);if(this.updateScale){const i=this.gizmoLayer.utilityLayerScene.activeCamera;let e=i.globalPosition;i.devicePosition&&(e=i.devicePosition),this.zK.position.subtractToRef(e,M.Vector3[0]);let s=this.scaleRatio;if(i.mode==hs.ORTHOGRAPHIC_CAMERA){if(i.orthoTop&&i.orthoBottom){s*=i.orthoTop-i.orthoBottom}}else{const t=i.getScene().useRightHandedSystem?w.RightHandedForwardReadOnly:w.LeftHandedForwardReadOnly,e=i.getDirection(t);s*=w.Dot(M.Vector3[0],e)}this.zK.scaling.setAll(s),t.zi()<0&&!$c.PreserveScaling&&(this.zK.scaling.y*=-1)}else this.zK.scaling.setAll(this.scaleRatio)}}XK(){const t=this.DK;t.isUsingPivotMatrix&&t.isUsingPivotMatrix()&&t.position&&t.getWorldMatrix().setTranslation(t.position)}WK(){if(this.DK)if(this.DK._t){const t=this.DK;let i,e;if(t.parent){const e=M.Matrix[1];t.parent._i.invertToRef(e),this.DK._i.multiplyToRef(e,M.Matrix[0]),i=M.Matrix[0]}else i=this.DK._i;t.getScene().useRightHandedSystem?(this.GK.multiplyToRef(i,M.Matrix[1]),e=M.Matrix[1]):e=i,e.decompose(M.Vector3[1],M.Quaternion[0],M.Vector3[0]);if("FreeCamera"===this.DK.getClassName()||"FlyCamera"===this.DK.getClassName()||"ArcFollowCamera"===this.DK.getClassName()||"TargetCamera"===this.DK.getClassName()||"TouchCamera"===this.DK.getClassName()||"UniversalCamera"===this.DK.getClassName()){const t=this.DK;t.rotation=M.Quaternion[0].toEulerAngles(),t.rotationQuaternion&&(t.rotationQuaternion.copyFrom(M.Quaternion[0]),t.rotationQuaternion.normalize())}t.position.copyFrom(M.Vector3[0])}else if(this.DK.Mt||"AbstractMesh"===this.DK.getClassName()||"TransformNode"===this.DK.getClassName()||"InstancedMesh"===this.DK.getClassName()){const t=this.DK;if(t.parent){const i=M.Matrix[0],e=M.Matrix[1];t.parent.getWorldMatrix().invertToRef(i),this.DK.getWorldMatrix().multiplyToRef(i,e),e.decompose(M.Vector3[0],M.Quaternion[0],t.position,$c.PreserveScaling?t:void 0)}else this.DK._i.decompose(M.Vector3[0],M.Quaternion[0],t.position,$c.PreserveScaling?t:void 0);t.scaling.copyFrom(M.Vector3[0]),t.billboardMode||(t.rotationQuaternion?(t.rotationQuaternion.copyFrom(M.Quaternion[0]),t.rotationQuaternion.normalize()):t.rotation=M.Quaternion[0].toEulerAngles())}else if("Bone"===this.DK.getClassName()){const t=this.DK,i=t.getParent();if(i){const e=M.Matrix[0],s=M.Matrix[1];i.getWorldMatrix().invertToRef(e),t.getWorldMatrix().multiplyToRef(e,s);t.getLocalMatrix().copyFrom(s)}else{t.getLocalMatrix().copyFrom(t.getWorldMatrix())}t.markAsDirty()}else{const t=this.DK;if(t.getTypeID){const i=t.getTypeID();if(i===No.LIGHTTYPEID_DIRECTIONALLIGHT||i===No.LIGHTTYPEID_SPOTLIGHT||i===No.LIGHTTYPEID_POINTLIGHT){const i=t.parent;if(i){const e=M.Matrix[0],s=M.Matrix[1];i.getWorldMatrix().invertToRef(e),t.getWorldMatrix().multiplyToRef(e,s),s.decompose(void 0,M.Quaternion[0],M.Vector3[0])}else this.DK._i.decompose(void 0,M.Quaternion[0],M.Vector3[0]);t.position=new w(M.Vector3[0].x,M.Vector3[0].y,M.Vector3[0].z),t.direction&&(t.direction=new w(t.direction.x,t.direction.y,t.direction.z))}}}}$K(t,i){t&&t.forEach((t=>{t.material=i,t.color&&(t.color=i.diffuseColor)}))}static GizmoAxisPointerObserver(t,i){let e=!1;return t.utilityLayerScene.onPointerObservable.add((t=>{var s,n;if(t.pickInfo){if(t.type===pe.POINTERMOVE){if(e)return;i.forEach((i=>{var e,s;if(i.colliderMeshes&&i.gizmoMeshes){const n=-1!=(null===(e=i.colliderMeshes)||void 0===e?void 0:e.indexOf(null===(s=null==t?void 0:t.pickInfo)||void 0===s?void 0:s.pickedMesh)),r=i.dragBehavior.enabled?n||i.active?i.hoverMaterial:i.material:i.disableMaterial;i.gizmoMeshes.forEach((t=>{t.material=r,t.color&&(t.color=r.diffuseColor)}))}}))}if(t.type===pe.POINTERDOWN&&i.has(null===(s=t.pickInfo.pickedMesh)||void 0===s?void 0:s.parent)){e=!0;i.get(null===(n=t.pickInfo.pickedMesh)||void 0===n?void 0:n.parent).active=!0,i.forEach((i=>{var e,s;const n=(-1!=(null===(e=i.colliderMeshes)||void 0===e?void 0:e.indexOf(null===(s=null==t?void 0:t.pickInfo)||void 0===s?void 0:s.pickedMesh))||i.active)&&i.dragBehavior.enabled?i.hoverMaterial:i.disableMaterial;i.gizmoMeshes.forEach((t=>{t.material=n,t.color&&(t.color=n.diffuseColor)}))}))}t.type===pe.POINTERUP&&i.forEach((t=>{t.active=!1,e=!1,t.gizmoMeshes.forEach((i=>{i.material=t.dragBehavior.enabled?t.material:t.disableMaterial,i.color&&(i.color=t.material.diffuseColor)}))}))}}))}dispose(){this.zK.dispose(),this.AN&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this.AN)}}$c.PreserveScaling=!1;Object.defineProperty(ke.prototype,"debugLayer",{get:function(){return this.YK||(this.YK=new Yc(this)),this.YK},enumerable:!0,configurable:!0}),function(t){t[t.Properties=0]="Properties",t[t.Debug=1]="Debug",t[t.Statistics=2]="Statistics",t[t.Tools=3]="Tools",t[t.Settings=4]="Settings"}(kc||(kc={}));class Yc{constructor(t){this.BJSINSPECTOR=this.jK(),this.Kt=t||E.LastCreatedScene,this.Kt&&this.Kt.onDisposeObservable.add((()=>{this.Kt.YK&&this.Kt.YK.hide()}))}get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this.KK||(this.KK=new h),this.KK)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this.qK||(this.qK=new h),this.qK)}QK(t){if(this.isVisible())return;if(this.KK){for(const t of this.KK.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(t);this.KK.clear(),this.KK=void 0}if(this.qK){for(const t of this.qK.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(t);this.qK.clear(),this.qK=void 0}const i={overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0,...t};this.BJSINSPECTOR=this.BJSINSPECTOR||this.jK(),this.BJSINSPECTOR.Inspector.Show(this.Kt,i)}select(t,i){this.BJSINSPECTOR&&(i&&("[object String]"==Object.prototype.toString.call(i)?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(i):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(i)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(t))}jK(){return"undefined"!=typeof INSPECTOR?INSPECTOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.Inspector?BABYLON:void 0}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.ZK(this.Kt)}show(t){return new Promise((i=>{if(void 0===this.BJSINSPECTOR){const e=t&&t.inspectorURL?t.inspectorURL:Yc.InspectorURL;ki.LoadScript(e,(()=>{this.QK(t),i(this)}))}else this.QK(t),i(this)}))}}function jc(t){let i=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const e=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],s=[];let n=[];const r=t.width||t.size||1,h=t.height||t.size||1,o=t.depth||t.size||1,a=t.wrap||!1;let l=void 0===t.topBaseAt?1:t.topBaseAt,c=void 0===t.bottomBaseAt?0:t.bottomBaseAt;l=(l+4)%4,c=(c+4)%4;let u=[2,0,3,1][l],f=[2,0,1,3][c],d=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(a){i=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],d=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let t=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],e=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const s=[17,18,19,16],n=[22,23,20,21];for(;u>0;)t.unshift(t.pop()),s.unshift(s.pop()),u--;for(;f>0;)e.unshift(e.pop()),n.unshift(n.pop()),f--;t=t.flat(),e=e.flat(),d=d.concat(t).concat(e),i.push(s[0],s[2],s[3],s[0],s[1],s[2]),i.push(n[0],n[2],n[3],n[0],n[1],n[2])}const p=[r/2,h/2,o/2];n=d.reduce(((t,i,e)=>t.concat(i*p[e%3])),[]);const m=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE,v=t.faceUV||new Array(6),g=t.faceColors,S=[];for(let t=0;t<6;t++)void 0===v[t]&&(v[t]=new x(0,0,1,1)),g&&void 0===g[t]&&(g[t]=new y(1,1,1,1));for(let t=0;t<6;t++)if(s.push(v[t].z,As.UseOpenGLOrientationForUV?1-v[t].w:v[t].w),s.push(v[t].x,As.UseOpenGLOrientationForUV?1-v[t].w:v[t].w),s.push(v[t].x,As.UseOpenGLOrientationForUV?1-v[t].y:v[t].y),s.push(v[t].z,As.UseOpenGLOrientationForUV?1-v[t].y:v[t].y),g)for(let i=0;i<4;i++)S.push(g[t].r,g[t].g,g[t].b,g[t].a);os.JA(m,n,i,e,s,t.frontUVs,t.backUVs);const E=new os;if(E.indices=i,E.positions=n,E.normals=e,E.uvs=s,g){const t=m===os.DOUBLESIDE?S.concat(S):S;E.colors=t}return E}function Kc(t,i={},e=null){const s=new Ys(t,e);i.sideOrientation=Ys.OI(i.sideOrientation),s.yI=i.sideOrientation;return jc(i).applyToMesh(s,i.updatable),s}Yc.InspectorURL=`https://unpkg.com/babylonjs-inspector@${Rs.Version}/babylon.inspector.bundle.js`;function qc(t){const i=t.segments||32,e=t.diameterX||t.diameter||1,s=t.diameterY||t.diameter||1,n=t.diameterZ||t.diameter||1,r=t.arc&&(t.arc<=0||t.arc>1)?1:t.arc||1,h=t.slice&&t.slice<=0?1:t.slice||1,o=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE,a=!!t.dedupTopBottomIndices,l=new w(e/2,s/2,n/2),c=2+i,u=2*c,f=[],d=[],p=[],m=[];for(let t=0;t<=c;t++){const i=t/c,e=i*Math.PI*h;for(let t=0;t<=u;t++){const s=t/u,n=s*Math.PI*2*r,h=R.RotationZ(-e),o=R.RotationY(n),a=w.TransformCoordinates(w.Up(),h),c=w.TransformCoordinates(a,o),f=c.multiply(l),v=c.divide(l).normalize();d.push(f.x,f.y,f.z),p.push(v.x,v.y,v.z),m.push(s,As.UseOpenGLOrientationForUV?1-i:i)}if(t>0){const i=d.length/3;for(let e=i-2*(u+1);e+u+2<i;e++)a?(t>1&&(f.push(e),f.push(e+1),f.push(e+u+1)),(t<c||h<1)&&(f.push(e+u+1),f.push(e+1),f.push(e+u+2))):(f.push(e),f.push(e+1),f.push(e+u+1),f.push(e+u+1),f.push(e+1),f.push(e+u+2))}}os.JA(o,d,f,p,m,t.frontUVs,t.backUVs);const v=new os;return v.indices=f,v.positions=d,v.normals=p,v.uvs=m,v}function Qc(t,i={},e=null){const s=new Ys(t,e);i.sideOrientation=Ys.OI(i.sideOrientation),s.yI=i.sideOrientation;return qc(i).applyToMesh(s,i.updatable),s}os.CreateBox=jc,Ys.CreateBox=(t,i,e=null,s,n)=>Kc(t,{size:i,sideOrientation:n,updatable:s},e);function Zc(t={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){const i=Math.max(t.subdivisions?t.subdivisions:2,1),e=Math.max(t.tessellation?t.tessellation:16,3),s=Math.max(t.height?t.height:1,0),n=Math.max(t.radius?t.radius:.25,0),r=Math.max(t.capSubdivisions?t.capSubdivisions:6,1),h=e,o=i,a=Math.max(t.radiusTop?t.radiusTop:n,0),l=Math.max(t.radiusBottom?t.radiusBottom:n,0),c=s-(a+l),u=2*Math.PI,f=Math.max(t.topCapSubdivisions?t.topCapSubdivisions:r,1),d=Math.max(t.bottomCapSubdivisions?t.bottomCapSubdivisions:r,1),p=Math.acos((l-a)/s);let m=[];const v=[],g=[],S=[];let E=0;const A=[],x=.5*c,T=.5*Math.PI;let I,M;const b=w.Zero(),_=w.Zero(),y=Math.cos(p),N=Math.sin(p),P=new C(a*N,x+a*y).subtract(new C(l*N,l*y-x)).length(),D=a*p+P+l*(T-p);let L=0;for(M=0;M<=f;M++){const t=[],i=T-p*(M/f);L+=a*p/f;const e=Math.cos(i),s=Math.sin(i),n=e*a;for(I=0;I<=h;I++){const i=I/h,r=i*u+0,o=Math.sin(r),l=Math.cos(r);_.x=n*o,_.y=x+s*a,_.z=n*l,v.push(_.x,_.y,_.z),b.set(e*o,s,e*l),g.push(b.x,b.y,b.z),S.push(i,As.UseOpenGLOrientationForUV?L/D:1-L/D),t.push(E),E++}A.push(t)}const O=s-a-l+y*a-y*l,F=N*(l-a)/O;for(M=1;M<=o;M++){const t=[];L+=P/o;const i=N*(M*(l-a)/o+a);for(I=0;I<=h;I++){const e=I/h,s=e*u+0,n=Math.sin(s),r=Math.cos(s);_.x=i*n,_.y=x+y*a-M*O/o,_.z=i*r,v.push(_.x,_.y,_.z),b.set(n,F,r).normalize(),g.push(b.x,b.y,b.z),S.push(e,As.UseOpenGLOrientationForUV?L/D:1-L/D),t.push(E),E++}A.push(t)}for(M=1;M<=d;M++){const t=[],i=T-p-(Math.PI-p)*(M/d);L+=l*p/d;const e=Math.cos(i),s=Math.sin(i),n=e*l;for(I=0;I<=h;I++){const i=I/h,r=i*u+0,o=Math.sin(r),a=Math.cos(r);_.x=n*o,_.y=s*l-x,_.z=n*a,v.push(_.x,_.y,_.z),b.set(e*o,s,e*a),g.push(b.x,b.y,b.z),S.push(i,As.UseOpenGLOrientationForUV?L/D:1-L/D),t.push(E),E++}A.push(t)}for(I=0;I<h;I++)for(M=0;M<f+o+d;M++){const t=A[M][I],i=A[M+1][I],e=A[M+1][I+1],s=A[M][I+1];m.push(t),m.push(i),m.push(s),m.push(i),m.push(e),m.push(s)}if(m=m.reverse(),t.orientation&&!t.orientation.equals(w.Up())){const i=new R;t.orientation.clone().scale(.5*Math.PI).cross(w.Up()).toQuaternion().toRotationMatrix(i);const e=w.Zero();for(let t=0;t<v.length;t+=3)e.set(v[t],v[t+1],v[t+2]),w.TransformCoordinatesToRef(e.clone(),i,e),v[t]=e.x,v[t+1]=e.y,v[t+2]=e.z}const B=new os;return B.positions=v,B.normals=g,B.uvs=S,B.indices=m,B}function Jc(t,i={orientation:w.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},e=null){const s=new Ys(t,e);return Zc(i).applyToMesh(s,i.updatable),s}os.CreateSphere=qc,Ys.CreateSphere=(t,i,e,s,n,r)=>Qc(t,{segments:i,diameterX:e,diameterY:e,diameterZ:e,sideOrientation:r,updatable:n},s);Ys.CreateCapsule=(t,i,e)=>Jc(t,i,e),os.CreateCapsule=Zc;Ys.lM=(t,i)=>{const e=new tu(t,i);if(i.instancedBuffers){e.instancedBuffers={};for(const t in i.instancedBuffers)e.instancedBuffers[t]=i.instancedBuffers[t]}return e};class tu extends ys{constructor(t,i){super(t,i.getScene()),this.gM=-1,this.zf=0,i.addInstance(this),this.JK=i,this.IC=i.IC,this.position.copyFrom(i.position),this.rotation.copyFrom(i.rotation),this.scaling.copyFrom(i.scaling),i.rotationQuaternion&&(this.rotationQuaternion=i.rotationQuaternion.clone()),this.animations=i.animations.slice();for(const t of i.getAnimationRanges())null!=t&&this.createAnimationRange(t.name,t.from,t.to);this.infiniteDistance=i.infiniteDistance,this.setPivotMatrix(i.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this.hM()}getClassName(){return"InstancedMesh"}get lightSources(){return this.JK.DT}zg(){}KT(){}Wg(){}get receiveShadows(){return this.JK.receiveShadows}get material(){return this.JK.material}get visibility(){return this.JK.visibility}get skeleton(){return this.JK.skeleton}get renderingGroupId(){return this.JK.renderingGroupId}set renderingGroupId(t){this.JK&&t!==this.JK.renderingGroupId&&F.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this.JK?this.JK.getTotalVertices():0}getTotalIndices(){return this.JK.getTotalIndices()}get sourceMesh(){return this.JK}createInstance(t){return this.JK.createInstance(t)}isReady(t=!1){return this.JK.isReady(t,!0)}getVerticesData(t,i){return this.JK.getVerticesData(t,i)}setVerticesData(t,i,e,s){return this.sourceMesh&&this.sourceMesh.setVerticesData(t,i,e,s),this.sourceMesh}updateVerticesData(t,i,e,s){return this.sourceMesh&&this.sourceMesh.updateVerticesData(t,i,e,s),this.sourceMesh}setIndices(t,i=null){return this.sourceMesh&&this.sourceMesh.setIndices(t,i),this.sourceMesh}isVerticesDataPresent(t){return this.JK.isVerticesDataPresent(t)}getIndices(){return this.JK.getIndices()}get QC(){return this.JK.QC}refreshBoundingInfo(t=!1,i=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const e=this.JK.geometry?this.JK.geometry.boundingBias:null;return this.ZT(this.JK.JT(t,i),e),this}nS(){return this.sS&&this.sS.nS(),this}rS(t,i){if(super.rS(t,i),this.JK.subMeshes||F.Warn("Instances should only be created for meshes with geometry."),this.sS){if(this.sS.zi()>=0!=this.zi()>=0)return this._m.hS=!0,!0;if(this._m.hS=!1,this.sS.YI(this,t),i){if(!this.sS._m.ET)return this.sS._m.AT=!0,!0}else if(!this.sS._m.tS)return this.sS._m.oS=!0,!0}return!1}lS(){this.JK.edgesShareWithInstances&&this.JK.$f&&this.JK.$f.isEnabled&&this.JK.Wf?(this.JK.Wf.Mf.pushNoDuplicate(this.JK.$f),this.JK.$f.customInstances.push(this.getWorldMatrix())):this.$f&&this.$f.isEnabled&&this.JK.Wf&&this.JK.Wf.Mf.push(this.$f)}getWorldMatrix(){if(this.sS&&this.sS.billboardMode!==Is.BILLBOARDMODE_NONE&&this.sS.NT!==this){this.tq||(this.tq=new R);const t=this.sS.NT;return this.sS.NT=this,M.Vector3[7].copyFrom(this.sS.position),this.sS.position.set(0,0,0),this.tq.copyFrom(this.sS.computeWorldMatrix(!0)),this.sS.position.copyFrom(M.Vector3[7]),this.sS.NT=t,this.tq}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(t){if(!t)return this;const i=this.sourceMesh.getLODLevels();if(i&&0!==i.length){const i=this.getBoundingInfo();this.sS=this.sourceMesh.getLOD(t,i.boundingSphere)}else this.sS=this.sourceMesh;return this.sS}QT(t){return this.sourceMesh.QT(t)}hM(){if(this.releaseSubMeshes(),this.JK.subMeshes)for(let t=0;t<this.JK.subMeshes.length;t++)this.JK.subMeshes[t].clone(this,this.JK);return this}sw(){return this.JK.sw()}VC(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this.iR(this.worldMatrixFromCache),this}clone(t,i=null,e,s){const n=(s||this.JK).createInstance(t);if(k.DeepCopy(this,n,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),i&&(n.parent=i),!e)for(let t=0;t<this.getScene().meshes.length;t++){const i=this.getScene().meshes[t];i.parent===this&&i.clone(i.name,n)}return n.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(n),n}dispose(t,i=!1){this.JK.removeInstance(this),super.dispose(t,i)}Gi(t){super.Gi(t),t.parentId=this.JK.uniqueId,t.parentInstanceIndex=this.gM}instantiateHierarchy(t=null,i,e){const s=this.clone("Clone of "+(this.name||this.id),t||this.parent,!0,i&&i.newSourcedMesh);s&&e&&e(this,s);for(const t of this.getChildTransformNodes(!0))t.instantiateHierarchy(s,i,e);return s}}Ys.prototype.registerInstancedBuffer=function(t,i){var e,s;if(null===(s=null===(e=this.$I)||void 0===e?void 0:e.vertexBuffers[t])||void 0===s||s.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const t of this.instances)t.instancedBuffers={};this.$I||(this.$I={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[t]=null,this.$I.strides[t]=i,this.$I.sizes[t]=32*i,this.$I.data[t]=new Float32Array(this.$I.sizes[t]),this.$I.vertexBuffers[t]=new he(this.getEngine(),this.$I.data[t],t,!0,!1,i,!0);for(const i of this.instances)i.instancedBuffers[t]=null;this.KC(),this.tw()},Ys.prototype.ZI=function(t,i){const e=t?t.length:0;for(const s in this.instancedBuffers){let n=this.$I.sizes[s];const r=this.$I.strides[s],h=(e+1)*r;for(;n<h;)n*=2;this.$I.data[s].length!=n&&(this.$I.data[s]=new Float32Array(n),this.$I.sizes[s]=n,this.$I.vertexBuffers[s]&&(this.$I.vertexBuffers[s].dispose(),this.$I.vertexBuffers[s]=null));const o=this.$I.data[s];let a=0;if(i){const t=this.instancedBuffers[s];t.toArray?t.toArray(o,a):t.copyToArray?t.copyToArray(o,a):o[a]=t,a+=r}for(let i=0;i<e;i++){const e=t[i].instancedBuffers[s];e.toArray?e.toArray(o,a):e.copyToArray?e.copyToArray(o,a):o[a]=e,a+=r}this.$I.vertexBuffers[s]?this.$I.vertexBuffers[s].updateDirectly(o,0):(this.$I.vertexBuffers[s]=new he(this.getEngine(),this.$I.data[s],s,!0,!1,r,!0),this.KC())}},Ys.prototype.KC=function(){if(this.$I&&void 0!==this.$I.vertexArrayObjects){for(const t in this.$I.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this.$I.vertexArrayObjects[t]);this.$I.vertexArrayObjects={}}},Ys.prototype.oM=function(){for(this.bI.instancesBuffer&&(this.bI.instancesBuffer.dispose(),this.bI.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const t in this.instancedBuffers)this.$I.vertexBuffers[t]&&this.$I.vertexBuffers[t].dispose();this.KC(),this.instancedBuffers={}};const iu={effect:null,subMesh:null};class eu extends Fn{constructor(t,i,e,s={},n=!0){super(t,i,n),this.sx={},this.iq={},this.eq={},this.LO={},this.OO={},this.sq={},this.FO={},this.BO={},this.nq={},this.UO={},this.rq={},this.VO={},this.kO={},this.hq={},this.oq={},this.aq={},this.GO={},this.lq={},this.cq={},this.uq={},this.fq={},this.dq={},this.pq={},this.nh={},this.mq={},this.rh={},this.sF=new R,this.nF=new R,this.vq=!1,this.hK=e,this.wb={needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1,...s}}get shaderPath(){return this.hK}set shaderPath(t){this.hK=t}get options(){return this.wb}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this.wb.needAlphaBlending}needAlphaTesting(){return this.wb.needAlphaTesting}tF(t){-1===this.wb.uniforms.indexOf(t)&&this.wb.uniforms.push(t)}setTexture(t,i){return-1===this.wb.samplers.indexOf(t)&&this.wb.samplers.push(t),this.sx[t]=i,this}setTextureArray(t,i){return-1===this.wb.samplers.indexOf(t)&&this.wb.samplers.push(t),this.tF(t),this.iq[t]=i,this}setExternalTexture(t,i){return-1===this.wb.externalTextures.indexOf(t)&&this.wb.externalTextures.push(t),this.eq[t]=i,this}setFloat(t,i){return this.tF(t),this.LO[t]=i,this}setInt(t,i){return this.tF(t),this.OO[t]=i,this}setUInt(t,i){return this.tF(t),this.sq[t]=i,this}setFloats(t,i){return this.tF(t),this.FO[t]=i,this}setColor3(t,i){return this.tF(t),this.BO[t]=i,this}setColor3Array(t,i){return this.tF(t),this.nq[t]=i.reduce(((t,i)=>(i.toArray(t,t.length),t)),[]),this}setColor4(t,i){return this.tF(t),this.UO[t]=i,this}setColor4Array(t,i){return this.tF(t),this.rq[t]=i.reduce(((t,i)=>(i.toArray(t,t.length),t)),[]),this}setVector2(t,i){return this.tF(t),this.VO[t]=i,this}setVector3(t,i){return this.tF(t),this.kO[t]=i,this}setVector4(t,i){return this.tF(t),this.hq[t]=i,this}setQuaternion(t,i){return this.tF(t),this.oq[t]=i,this}setQuaternionArray(t,i){return this.tF(t),this.aq[t]=i.reduce(((t,i)=>(i.toArray(t,t.length),t)),[]),this}setMatrix(t,i){return this.tF(t),this.GO[t]=i,this}setMatrices(t,i){this.tF(t);const e=new Float32Array(16*i.length);for(let t=0;t<i.length;t++){i[t].copyToArray(e,16*t)}return this.lq[t]=e,this}setMatrix3x3(t,i){return this.tF(t),this.cq[t]=i,this}setMatrix2x2(t,i){return this.tF(t),this.uq[t]=i,this}setArray2(t,i){return this.tF(t),this.fq[t]=i,this}setArray3(t,i){return this.tF(t),this.dq[t]=i,this}setArray4(t,i){return this.tF(t),this.pq[t]=i,this}setUniformBuffer(t,i){return-1===this.wb.uniformBuffers.indexOf(t)&&this.wb.uniformBuffers.push(t),this.nh[t]=i,this}setTextureSampler(t,i){return-1===this.wb.samplerObjects.indexOf(t)&&this.wb.samplerObjects.push(t),this.mq[t]=i,this}setStorageBuffer(t,i){return-1===this.wb.storageBuffers.indexOf(t)&&this.wb.storageBuffers.push(t),this.rh[t]=i,this}isReadyForSubMesh(t,i,e){return this.isReady(t,e,i)}isReady(t,i,e){var s,n,r,h;const o=e&&this.Lg;if(this.isFrozen)if(o){if(e.effect&&e.effect.cs)return!0}else{const t=this.SC.effect;if(t&&t.cs&&t.fs===i)return!0}const a=this.getScene(),l=a.getEngine(),c=[],u=[],f=new Jn;let d=this.hK,p=this.wb.uniforms,m=this.wb.uniformBuffers,v=this.wb.samplers;l.getCaps().multiview&&a.activeCamera&&a.activeCamera.outputRenderTarget&&a.activeCamera.outputRenderTarget.getViewCount()>1&&(this.vq=!0,c.push("#define MULTIVIEW"),-1!==this.wb.uniforms.indexOf("viewProjection")&&-1===this.wb.uniforms.indexOf("viewProjectionR")&&this.wb.uniforms.push("viewProjectionR"));for(let t=0;t<this.wb.defines.length;t++){const i=0===this.wb.defines[t].indexOf("#define")?this.wb.defines[t]:`#define ${this.wb.defines[t]}`;c.push(i)}for(let t=0;t<this.wb.attributes.length;t++)u.push(this.wb.attributes[t]);if(t&&t.isVerticesDataPresent(he.ColorKind)&&(u.push(he.ColorKind),c.push("#define VERTEXCOLOR")),i&&(c.push("#define INSTANCES"),Fs.PushAttributesForInstances(u),(null==t?void 0:t.hasThinInstances)&&(c.push("#define THIN_INSTANCES"),t&&t.isVerticesDataPresent(he.ColorInstanceKind)&&(u.push(he.ColorInstanceKind),c.push("#define INSTANCESCOLOR")))),t&&t.useBones&&t.computeBonesUsingShaders&&t.skeleton){u.push(he.MatricesIndicesKind),u.push(he.MatricesWeightsKind),t.numBoneInfluencers>4&&(u.push(he.MatricesIndicesExtraKind),u.push(he.MatricesWeightsExtraKind));const i=t.skeleton;c.push("#define NUM_BONE_INFLUENCERS "+t.numBoneInfluencers),f.addCPUSkinningFallback(0,t),i.isUsingTextureForMatrices?(c.push("#define BONETEXTURE"),-1===this.wb.uniforms.indexOf("boneTextureWidth")&&this.wb.uniforms.push("boneTextureWidth"),-1===this.wb.samplers.indexOf("boneSampler")&&this.wb.samplers.push("boneSampler")):(c.push("#define BonesPerMesh "+(i.bones.length+1)),-1===this.wb.uniforms.indexOf("mBones")&&this.wb.uniforms.push("mBones"))}else c.push("#define NUM_BONE_INFLUENCERS 0");let g=0;const S=t?t.morphTargetManager:null;if(S){const t=S.supportsUVs&&-1!==c.indexOf("#define UV1"),i=S.supportsTangents&&-1!==c.indexOf("#define TANGENT"),e=S.supportsNormals&&-1!==c.indexOf("#define NORMAL");g=S.numInfluencers,t&&c.push("#define MORPHTARGETS_UV"),i&&c.push("#define MORPHTARGETS_TANGENT"),e&&c.push("#define MORPHTARGETS_NORMAL"),g>0&&c.push("#define MORPHTARGETS"),S.isUsingTextureForTargets&&(c.push("#define MORPHTARGETS_TEXTURE"),-1===this.wb.uniforms.indexOf("morphTargetTextureIndices")&&this.wb.uniforms.push("morphTargetTextureIndices"),-1===this.wb.samplers.indexOf("morphTargets")&&this.wb.samplers.push("morphTargets")),c.push("#define NUM_MORPH_INFLUENCERS "+g);for(let s=0;s<g;s++)u.push(he.PositionKind+s),e&&u.push(he.NormalKind+s),i&&u.push(he.TangentKind+s),t&&u.push(he.UVKind+"_"+s);g>0&&(p=p.slice(),p.push("morphTargetInfluences"),p.push("morphTargetTextureInfo"),p.push("morphTargetTextureIndices"))}else c.push("#define NUM_MORPH_INFLUENCERS 0");if(t){const i=t.bakedVertexAnimationManager;i&&i.isEnabled&&(c.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),-1===this.wb.uniforms.indexOf("bakedVertexAnimationSettings")&&this.wb.uniforms.push("bakedVertexAnimationSettings"),-1===this.wb.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")&&this.wb.uniforms.push("bakedVertexAnimationTextureSizeInverted"),-1===this.wb.uniforms.indexOf("bakedVertexAnimationTime")&&this.wb.uniforms.push("bakedVertexAnimationTime"),-1===this.wb.samplers.indexOf("bakedVertexAnimationTexture")&&this.wb.samplers.push("bakedVertexAnimationTexture")),Fs.PrepareAttributesForBakedVertexAnimation(u,t,c)}for(const t in this.sx)if(!this.sx[t].isReady())return!1;t&&this.qR(t)&&c.push("#define ALPHATEST"),!1!==this.wb.useClipPlane&&(Ns(p),Ps(this,a,c)),this.customShaderNameResolve&&(p=p.slice(),m=m.slice(),v=v.slice(),d=this.customShaderNameResolve(d,p,m,v,c,u));const E=o?e.mC():this.SC,A=null!==(s=null==E?void 0:E.effect)&&void 0!==s?s:null,C=null!==(n=null==E?void 0:E.defines)&&void 0!==n?n:null,w=c.join("\n");let x=A;return C!==w&&(x=l.createEffect(d,{attributes:u,uniformsNames:p,uniformBuffersNames:m,samplers:v,defines:w,fallbacks:f,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:g},shaderLanguage:this.wb.shaderLanguage},l),o?e.setEffect(x,w,this.WR):E&&E.setEffect(x,w),this.$R&&(iu.effect=x,iu.subMesh=null!==(r=null!=e?e:null==t?void 0:t.subMeshes[0])&&void 0!==r?r:null,this.$R.notifyObservers(iu))),x.fs=!!i,null!==(h=!(null==x?void 0:x.isReady()))&&void 0!==h&&!h&&(A!==x&&a.resetCachedMaterial(),x.cs=!0,!0)}bindOnlyWorldMatrix(t,i){const e=this.getScene(),s=null!=i?i:this.getEffect();s&&(-1!==this.wb.uniforms.indexOf("world")&&s.setMatrix("world",t),-1!==this.wb.uniforms.indexOf("worldView")&&(t.multiplyToRef(e.getViewMatrix(),this.sF),s.setMatrix("worldView",this.sF)),-1!==this.wb.uniforms.indexOf("worldViewProjection")&&(t.multiplyToRef(e.getTransformMatrix(),this.nF),s.setMatrix("worldViewProjection",this.nF)))}bindForSubMesh(t,i,e){var s;this.bind(t,i,null===(s=e.EC)||void 0===s?void 0:s.effect,e)}bind(t,i,e,s){var n;const r=s&&this.Lg,h=null!=e?e:r?s.effect:this.getEffect();if(!h)return;this.hP=h,this.bindOnlyWorldMatrix(t,e);const o=this.wb.uniformBuffers;let a=!1;if(h&&o&&o.length>0&&this.getScene().getEngine().supportsUniformBuffers)for(let e=0;e<o.length;++e){switch(o[e]){case"Mesh":i&&(i.getMeshUniformBuffer().bindToEffect(h,"Mesh"),i.transferToEffect(t));break;case"Scene":Fs.BindSceneUniformBuffer(h,this.getScene().getSceneUniformBuffer()),this.getScene().finalizeSceneUbo(),a=!0}}const l=i&&r?this.aP(this.getScene(),h,i.visibility):this.getScene().getCachedMaterial()!==this;if(h&&l){let t;for(t in a||-1===this.wb.uniforms.indexOf("view")||h.setMatrix("view",this.getScene().getViewMatrix()),a||-1===this.wb.uniforms.indexOf("projection")||h.setMatrix("projection",this.getScene().getProjectionMatrix()),a||-1===this.wb.uniforms.indexOf("viewProjection")||(h.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this.vq&&h.setMatrix("viewProjectionR",this.getScene().tH)),this.getScene().activeCamera&&-1!==this.wb.uniforms.indexOf("cameraPosition")&&h.setVector3("cameraPosition",this.getScene().activeCamera.globalPosition),Fs.BindBonesParameters(i,h),Ds(h,this,this.getScene()),this.sx)h.setTexture(t,this.sx[t]);for(t in this.iq)h.setTextureArray(t,this.iq[t]);for(t in this.eq)h.setExternalTexture(t,this.eq[t]);for(t in this.OO)h.setInt(t,this.OO[t]);for(t in this.sq)h.setUInt(t,this.sq[t]);for(t in this.LO)h.setFloat(t,this.LO[t]);for(t in this.FO)h.setArray(t,this.FO[t]);for(t in this.BO)h.setColor3(t,this.BO[t]);for(t in this.nq)h.setArray3(t,this.nq[t]);for(t in this.UO){const i=this.UO[t];h.setFloat4(t,i.r,i.g,i.b,i.a)}for(t in this.rq)h.setArray4(t,this.rq[t]);for(t in this.VO)h.setVector2(t,this.VO[t]);for(t in this.kO)h.setVector3(t,this.kO[t]);for(t in this.hq)h.setVector4(t,this.hq[t]);for(t in this.oq)h.setQuaternion(t,this.oq[t]);for(t in this.GO)h.setMatrix(t,this.GO[t]);for(t in this.lq)h.setMatrices(t,this.lq[t]);for(t in this.cq)h.setMatrix3x3(t,this.cq[t]);for(t in this.uq)h.setMatrix2x2(t,this.uq[t]);for(t in this.fq)h.setArray2(t,this.fq[t]);for(t in this.dq)h.setArray3(t,this.dq[t]);for(t in this.pq)h.setArray4(t,this.pq[t]);for(t in this.aq)h.setArray4(t,this.aq[t]);for(t in this.nh){const i=this.nh[t].getBuffer();i&&h.bindUniformBuffer(i,t)}for(t in this.mq)h.setTextureSampler(t,this.mq[t]);for(t in this.rh)h.setStorageBuffer(t,this.rh[t])}if(h&&i&&(l||!this.isFrozen)){const t=i.morphTargetManager;t&&t.numInfluencers>0&&Fs.BindMorphTargetParameters(i,h);const e=i.bakedVertexAnimationManager;e&&e.isEnabled&&(null===(n=i.bakedVertexAnimationManager)||void 0===n||n.bind(h,!!h.fs))}this.tI(i,h)}getActiveTextures(){const t=super.getActiveTextures();for(const i in this.sx)t.push(this.sx[i]);for(const i in this.iq){const e=this.iq[i];for(let i=0;i<e.length;i++)t.push(e[i])}return t}hasTexture(t){if(super.hasTexture(t))return!0;for(const i in this.sx)if(this.sx[i]===t)return!0;for(const i in this.iq){const e=this.iq[i];for(let i=0;i<e.length;i++)if(e[i]===t)return!0}return!1}clone(t){const i=ot.Clone((()=>new eu(t,this.getScene(),this.hK,this.wb,this.Lg)),this);i.name=t,i.id=t,"object"==typeof i.hK&&(i.hK={...i.hK}),this.wb={...this.wb},Object.keys(this.wb).forEach((t=>{const i=this.wb[t];Array.isArray(i)&&(this.wb[t]=i.slice(0))})),this.stencil.copyTo(i.stencil);for(const t in this.sx)i.setTexture(t,this.sx[t]);for(const t in this.iq)i.setTextureArray(t,this.iq[t]);for(const t in this.eq)i.setExternalTexture(t,this.eq[t]);for(const t in this.OO)i.setInt(t,this.OO[t]);for(const t in this.sq)i.setUInt(t,this.sq[t]);for(const t in this.LO)i.setFloat(t,this.LO[t]);for(const t in this.FO)i.setFloats(t,this.FO[t]);for(const t in this.BO)i.setColor3(t,this.BO[t]);for(const t in this.nq)i.nq[t]=this.nq[t];for(const t in this.UO)i.setColor4(t,this.UO[t]);for(const t in this.rq)i.rq[t]=this.rq[t];for(const t in this.VO)i.setVector2(t,this.VO[t]);for(const t in this.kO)i.setVector3(t,this.kO[t]);for(const t in this.hq)i.setVector4(t,this.hq[t]);for(const t in this.oq)i.setQuaternion(t,this.oq[t]);for(const t in this.aq)i.aq[t]=this.aq[t];for(const t in this.GO)i.setMatrix(t,this.GO[t]);for(const t in this.lq)i.lq[t]=this.lq[t].slice();for(const t in this.cq)i.setMatrix3x3(t,this.cq[t]);for(const t in this.uq)i.setMatrix2x2(t,this.uq[t]);for(const t in this.fq)i.setArray2(t,this.fq[t]);for(const t in this.dq)i.setArray3(t,this.dq[t]);for(const t in this.pq)i.setArray4(t,this.pq[t]);for(const t in this.nh)i.setUniformBuffer(t,this.nh[t]);for(const t in this.mq)i.setTextureSampler(t,this.mq[t]);for(const t in this.rh)i.setStorageBuffer(t,this.rh[t]);return i}dispose(t,i,e){if(i){let t;for(t in this.sx)this.sx[t].dispose();for(t in this.iq){const i=this.iq[t];for(let t=0;t<i.length;t++)i[t].dispose()}}this.sx={},super.dispose(t,i,e)}serialize(){const t=ot.Serialize(this);let i;for(i in t.customType="BABYLON.ShaderMaterial",t.uniqueId=this.uniqueId,t.options=this.wb,t.shaderPath=this.hK,t.storeEffectOnSubMeshes=this.Lg,t.stencil=this.stencil.serialize(),t.textures={},this.sx)t.textures[i]=this.sx[i].serialize();for(i in t.textureArrays={},this.iq){t.textureArrays[i]=[];const e=this.iq[i];for(let s=0;s<e.length;s++)t.textureArrays[i].push(e[s].serialize())}for(i in t.ints={},this.OO)t.ints[i]=this.OO[i];for(i in t.uints={},this.sq)t.uints[i]=this.sq[i];for(i in t.floats={},this.LO)t.floats[i]=this.LO[i];for(i in t.FloatArrays={},this.FO)t.FloatArrays[i]=this.FO[i];for(i in t.colors3={},this.BO)t.colors3[i]=this.BO[i].asArray();for(i in t.colors3Arrays={},this.nq)t.colors3Arrays[i]=this.nq[i];for(i in t.colors4={},this.UO)t.colors4[i]=this.UO[i].asArray();for(i in t.colors4Arrays={},this.rq)t.colors4Arrays[i]=this.rq[i];for(i in t.vectors2={},this.VO)t.vectors2[i]=this.VO[i].asArray();for(i in t.vectors3={},this.kO)t.vectors3[i]=this.kO[i].asArray();for(i in t.vectors4={},this.hq)t.vectors4[i]=this.hq[i].asArray();for(i in t.quaternions={},this.oq)t.quaternions[i]=this.oq[i].asArray();for(i in t.matrices={},this.GO)t.matrices[i]=this.GO[i].asArray();for(i in t.matrixArray={},this.lq)t.matrixArray[i]=this.lq[i];for(i in t.matrices3x3={},this.cq)t.matrices3x3[i]=this.cq[i];for(i in t.matrices2x2={},this.uq)t.matrices2x2[i]=this.uq[i];for(i in t.vectors2Arrays={},this.fq)t.vectors2Arrays[i]=this.fq[i];for(i in t.vectors3Arrays={},this.dq)t.vectors3Arrays[i]=this.dq[i];for(i in t.vectors4Arrays={},this.pq)t.vectors4Arrays[i]=this.pq[i];for(i in t.quaternionsArrays={},this.aq)t.quaternionsArrays[i]=this.aq[i];return t}static Parse(t,i,e){const s=ot.Parse((()=>new eu(t.name,i,t.shaderPath,t.options,t.storeEffectOnSubMeshes)),t,i,e);let n;for(n in t.stencil&&s.stencil.parse(t.stencil,i,e),t.textures)s.setTexture(n,an.Parse(t.textures[n],i,e));for(n in t.textureArrays){const r=t.textureArrays[n],h=new Array;for(let t=0;t<r.length;t++)h.push(an.Parse(r[t],i,e));s.setTextureArray(n,h)}for(n in t.ints)s.setInt(n,t.ints[n]);for(n in t.uints)s.setUInt(n,t.uints[n]);for(n in t.floats)s.setFloat(n,t.floats[n]);for(n in t.floatsArrays)s.setFloats(n,t.floatsArrays[n]);for(n in t.colors3)s.setColor3(n,_.FromArray(t.colors3[n]));for(n in t.colors3Arrays){const i=t.colors3Arrays[n].reduce(((t,i,e)=>(e%3==0?t.push([i]):t[t.length-1].push(i),t)),[]).map((t=>_.FromArray(t)));s.setColor3Array(n,i)}for(n in t.colors4)s.setColor4(n,y.FromArray(t.colors4[n]));for(n in t.colors4Arrays){const i=t.colors4Arrays[n].reduce(((t,i,e)=>(e%4==0?t.push([i]):t[t.length-1].push(i),t)),[]).map((t=>y.FromArray(t)));s.setColor4Array(n,i)}for(n in t.vectors2)s.setVector2(n,C.FromArray(t.vectors2[n]));for(n in t.vectors3)s.setVector3(n,w.FromArray(t.vectors3[n]));for(n in t.vectors4)s.setVector4(n,x.FromArray(t.vectors4[n]));for(n in t.quaternions)s.setQuaternion(n,T.FromArray(t.quaternions[n]));for(n in t.matrices)s.setMatrix(n,R.FromArray(t.matrices[n]));for(n in t.matrixArray)s.lq[n]=new Float32Array(t.matrixArray[n]);for(n in t.matrices3x3)s.setMatrix3x3(n,t.matrices3x3[n]);for(n in t.matrices2x2)s.setMatrix2x2(n,t.matrices2x2[n]);for(n in t.vectors2Arrays)s.setArray2(n,t.vectors2Arrays[n]);for(n in t.vectors3Arrays)s.setArray3(n,t.vectors3Arrays[n]);for(n in t.vectors4Arrays)s.setArray4(n,t.vectors4Arrays[n]);for(n in t.quaternionsArrays)s.setArray4(n,t.quaternionsArrays[n]);return s}static ParseFromFileAsync(t,i,e,s=""){return new Promise(((n,r)=>{const h=new mt;h.addEventListener("readystatechange",(()=>{if(4==h.readyState)if(200==h.status){const i=JSON.parse(h.responseText),r=this.Parse(i,e||E.LastCreatedScene,s);t&&(r.name=t),n(r)}else r("Unable to load the ShaderMaterial")})),h.open("GET",i),h.send()}))}static ParseFromSnippetAsync(t,i,e=""){return new Promise(((s,n)=>{const r=new mt;r.addEventListener("readystatechange",(()=>{if(4==r.readyState)if(200==r.status){const n=JSON.parse(JSON.parse(r.responseText).jsonPayload),h=JSON.parse(n.shaderMaterial),o=this.Parse(h,i||E.LastCreatedScene,e);o.snippetId=t,s(o)}else n("Unable to load the snippet "+t)})),r.open("GET",this.SnippetUrl+"/"+t.replace(/#/g,"/")),r.send()}))}}eu.SnippetUrl="https://snippet.babylonjs.com",eu.CreateFromSnippetAsync=eu.ParseFromSnippetAsync,v("BABYLON.ShaderMaterial",eu);const su="colorPixelShader",nu="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\n#define VERTEXCOLOR\nvarying vec4 vColor;\n#else\nuniform vec4 color;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\ngl_FragColor=vColor;\n#else\ngl_FragColor=color;\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}";ii.ShadersStore[su]=nu;const ru="colorVertexShader",hu="attribute vec3 position;\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#include<clipPlaneVertex>\n#include<vertexColorMixing>\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[ru]=hu;Ys.fM=(t,i)=>ou.Parse(t,i);class ou extends Ys{constructor(t,i=null,e=null,s=null,n,r,h,o){super(t,i,e,s,n),this.useVertexColor=r,this.useVertexAlpha=h,this.color=new _(1,1,1),this.alpha=1,s&&(this.color=s.color.clone(),this.alpha=s.alpha,this.useVertexColor=s.useVertexColor,this.useVertexAlpha=s.useVertexAlpha),this.intersectionThreshold=.1;const a={attributes:[he.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:[],useClipPlane:null};!1===h?a.needAlphaBlending=!1:a.defines.push("#define VERTEXALPHA"),r?(a.defines.push("#define VERTEXCOLOR"),a.attributes.push(he.ColorKind)):(a.uniforms.push("color"),this.gq=new y),o?this.material=o:(this.material=new eu("colorShader",this.getScene(),"color",a,!1),this.material.doNotSerialize=!0)}Sq(t){return"ShaderMaterial"===t.getClassName()}isReady(){return!!this.Eq.isReady(this,!!this.$I)&&super.isReady()}getClassName(){return"LinesMesh"}get material(){return this.Eq}set material(t){this.Eq=t,this.Eq.fillMode=Vs.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(t){}$C(t,i){if(!this.qC)return this;const e=this.isUnIndexed?null:this.qC.getIndexBuffer();if(this.$I?this.qC.$C(i,e,this.$I.vertexBuffers,this.$I.vertexArrayObjects):this.qC.$C(i,e),!this.useVertexColor&&this.Sq(this.Eq)){const{r:t,g:i,b:e}=this.color;this.gq.set(t,i,e,this.alpha),this.Eq.setColor4("color",this.gq)}return this}jI(t,i,e){if(!this.qC||!this.qC.getVertexBuffers()||!this.IC&&!this.qC.getIndexBuffer())return this;const s=this.getScene().getEngine();return this.IC?s.drawArraysType(Vs.LineListDrawMode,t.verticesStart,t.verticesCount,e):s.drawElementsType(Vs.LineListDrawMode,t.indexStart,t.indexCount,e),this}dispose(t,i=!1,e){e||this.Eq.dispose(!1,!1,!0),super.dispose(t)}clone(t,i=null,e){return new ou(t,this.getScene(),i,this,e)}createInstance(t){const i=new au(t,this);if(this.instancedBuffers){i.instancedBuffers={};for(const t in this.instancedBuffers)i.instancedBuffers[t]=this.instancedBuffers[t]}return i}serialize(t){super.serialize(t),t.color=this.color.asArray(),t.alpha=this.alpha}static Parse(t,i){const e=new ou(t.name,i);return e.color=_.FromArray(t.color),e.alpha=t.alpha,e}}class au extends tu{constructor(t,i){super(t,i),this.intersectionThreshold=i.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function lu(t){const i=[],e=[],s=t.lines,n=t.colors,r=[];let h=0;for(let t=0;t<s.length;t++){const o=s[t];for(let s=0;s<o.length;s++){if(e.push(o[s].x,o[s].y,o[s].z),n){const i=n[t];r.push(i[s].r,i[s].g,i[s].b,i[s].a)}s>0&&(i.push(h-1),i.push(h)),h++}}const o=new os;return o.indices=i,o.positions=e,n&&(o.colors=r),o}function cu(t){const i=t.dashSize||3,e=t.gapSize||1,s=t.dashNb||200,n=t.points,r=new Array,h=new Array,o=w.Zero();let a=0,l=0,c=0,u=0,f=0,d=0,p=0;for(p=0;p<n.length-1;p++)n[p+1].subtractToRef(n[p],o),a+=o.length();for(c=a/s,u=i*c/(i+e),p=0;p<n.length-1;p++){n[p+1].subtractToRef(n[p],o),l=Math.floor(o.length()/c),o.normalize();for(let t=0;t<l;t++)f=c*t,r.push(n[p].x+f*o.x,n[p].y+f*o.y,n[p].z+f*o.z),r.push(n[p].x+(f+u)*o.x,n[p].y+(f+u)*o.y,n[p].z+(f+u)*o.z),h.push(d,d+1),d+=2}const m=new os;return m.positions=r,m.indices=h,m}function uu(t,i,e){const s=i.instance,n=i.lines,r=i.colors;if(s){const t=s.getVerticesData(he.PositionKind);let i,e;r&&(i=s.getVerticesData(he.ColorKind));let h=0,o=0;for(let s=0;s<n.length;s++){const a=n[s];for(let n=0;n<a.length;n++)t[h]=a[n].x,t[h+1]=a[n].y,t[h+2]=a[n].z,r&&i&&(e=r[s],i[o]=e[n].r,i[o+1]=e[n].g,i[o+2]=e[n].b,i[o+3]=e[n].a,o+=4),h+=3}return s.updateVerticesData(he.PositionKind,t,!1,!1),r&&i&&s.updateVerticesData(he.ColorKind,i,!1,!1),s}const h=new ou(t,e,null,void 0,void 0,!!r,i.useVertexAlpha,i.material);return lu(i).applyToMesh(h,i.updatable),h}function fu(t,i,e=null){const s=i.colors?[i.colors]:null;return uu(t,{lines:[i.points],updatable:i.updatable,instance:i.instance,colors:s,useVertexAlpha:i.useVertexAlpha,material:i.material},e)}function du(t,i,e=null){const s=i.points,n=i.instance,r=i.gapSize||1,h=i.dashSize||3;if(n){const t=t=>{const i=w.Zero(),e=t.length/6;let r=0,h=0,o=0,a=0,l=0,c=0,u=0,f=0;for(u=0;u<s.length-1;u++)s[u+1].subtractToRef(s[u],i),r+=i.length();o=r/e;const d=n.MI.dashSize;for(a=d*o/(d+n.MI.gapSize),u=0;u<s.length-1;u++)for(s[u+1].subtractToRef(s[u],i),h=Math.floor(i.length()/o),i.normalize(),f=0;f<h&&c<t.length;)l=o*f,t[c]=s[u].x+l*i.x,t[c+1]=s[u].y+l*i.y,t[c+2]=s[u].z+l*i.z,t[c+3]=s[u].x+(l+a)*i.x,t[c+4]=s[u].y+(l+a)*i.y,t[c+5]=s[u].z+(l+a)*i.z,c+=6,f++;for(;c<t.length;)t[c]=s[u].x,t[c+1]=s[u].y,t[c+2]=s[u].z,c+=3};return(i.dashNb||i.dashSize||i.gapSize||i.useVertexAlpha||i.material)&&F.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),n.updateMeshPositions(t,!1),n}const o=new ou(t,e,null,void 0,void 0,void 0,i.useVertexAlpha,i.material);return cu(i).applyToMesh(o,i.updatable),o.MI=new zs,o.MI.dashSize=h,o.MI.gapSize=r,o}os.CreateLineSystem=lu,os.CreateDashedLines=cu,Ys.CreateLines=(t,i,e=null,s=!1,n=null)=>fu(t,{points:i,updatable:s,instance:n},e),Ys.CreateDashedLines=(t,i,e,s,n,r=null,h,o)=>du(t,{points:i,dashSize:e,gapSize:s,dashNb:n,updatable:h,instance:o},r);function pu(t){let i=t.pathArray;const e=t.closeArray||!1,s=t.closePath||!1,n=t.invertUV||!1,r=Math.floor(i[0].length/2);let h=t.offset||r;h=h>r?r:Math.floor(h);const o=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE,a=t.uvs,l=t.colors,c=[],u=[],f=[],d=[],p=[],m=[],v=[],g=[];let S;const E=[],A=[];let C,w,x;if(i.length<2){const t=[],e=[];for(w=0;w<i[0].length-h;w++)t.push(i[0][w]),e.push(i[0][w+h]);i=[t,e]}let T=0;const R=s?1:0;let I,M,b,_,y,N;for(S=i[0].length,C=0;C<i.length;C++){for(v[C]=0,p[C]=[0],I=i[C],M=I.length,S=S<M?S:M,x=0;x<M;)c.push(I[x].x,I[x].y,I[x].z),x>0&&(b=I[x].subtract(I[x-1]).length(),_=b+v[C],p[C].push(_),v[C]=_),x++;s&&(x--,c.push(I[0].x,I[0].y,I[0].z),b=I[x].subtract(I[0]).length(),_=b+v[C],p[C].push(_),v[C]=_),E[C]=M+R,A[C]=T,T+=M+R}let P,D,L=null,O=null;for(w=0;w<S+R;w++){for(g[w]=0,m[w]=[0],C=0;C<i.length-1;C++)y=i[C],N=i[C+1],w===S?(L=y[0],O=N[0]):(L=y[w],O=N[w]),b=O.subtract(L).length(),_=b+g[w],m[w].push(_),g[w]=_;e&&O&&L&&(y=i[C],N=i[0],w===S&&(O=N[0]),b=O.subtract(L).length(),_=b+g[w],g[w]=_)}if(a)for(C=0;C<a.length;C++)d.push(a[C].x,As.UseOpenGLOrientationForUV?1-a[C].y:a[C].y);else for(C=0;C<i.length;C++)for(w=0;w<S+R;w++)P=0!=v[C]?p[C][w]/v[C]:0,D=0!=g[w]?m[w][C]/g[w]:0,n?d.push(D,P):d.push(P,As.UseOpenGLOrientationForUV?1-D:D);C=0;let F=0,B=E[C]-1,U=E[C+1]-1,V=B<U?B:U,k=A[1]-A[0];const G=e?E.length:E.length-1;for(;F<=V&&C<G;)u.push(F,F+k,F+1),u.push(F+k+1,F+1,F+k),F+=1,F===V&&(C++,C===E.length-1?(k=A[0]-A[C],B=E[C]-1,U=E[0]-1):(k=A[C+1]-A[C],B=E[C]-1,U=E[C+1]-1),F=A[C],V=B<U?B+F:U+F);if(os.ComputeNormals(c,u,f),s){let t=0,e=0;for(C=0;C<i.length;C++)t=3*A[C],e=C+1<i.length?3*(A[C+1]-1):f.length-3,f[t]=.5*(f[t]+f[e]),f[t+1]=.5*(f[t+1]+f[e+1]),f[t+2]=.5*(f[t+2]+f[e+2]),f[e]=f[t],f[e+1]=f[t+1],f[e+2]=f[t+2]}os.JA(o,c,u,f,d,t.frontUVs,t.backUVs);let z=null;if(l){z=new Float32Array(4*l.length);for(let t=0;t<l.length;t++)z[4*t]=l[t].r,z[4*t+1]=l[t].g,z[4*t+2]=l[t].b,z[4*t+3]=l[t].a}const H=new os,X=new Float32Array(c),W=new Float32Array(f),$=new Float32Array(d);return H.indices=u,H.positions=X,H.normals=W,H.uvs=$,z&&H.set(z,he.ColorKind),s&&(H.Aq=A),H}function mu(t,i,e=null){const s=i.pathArray,n=i.closeArray,r=i.closePath,h=Ys.OI(i.sideOrientation),o=i.instance,a=i.updatable;if(o){const t=M.Vector3[0].setAll(Number.MAX_VALUE),e=M.Vector3[1].setAll(-Number.MAX_VALUE),n=i=>{let n=s[0].length;const r=o;let h=0;const a=r.yI===Ys.DOUBLESIDE?2:1;for(let o=1;o<=a;++o)for(let o=0;o<s.length;++o){const a=s[o],l=a.length;n=n<l?n:l;for(let s=0;s<n;++s){const n=a[s];i[h]=n.x,i[h+1]=n.y,i[h+2]=n.z,t.minimizeInPlaceFromFloats(n.x,n.y,n.z),e.maximizeInPlaceFromFloats(n.x,n.y,n.z),h+=3}if(r.MI&&r.MI.closePath){const t=a[0];i[h]=t.x,i[h+1]=t.y,i[h+2]=t.z,h+=3}}},r=o.getVerticesData(he.PositionKind);if(n(r),o.hasBoundingInfo?o.getBoundingInfo().reConstruct(t,e,o._i):o.buildBoundingInfo(t,e,o._i),o.updateVerticesData(he.PositionKind,r,!1,!1),i.colors){const t=o.getVerticesData(he.ColorKind);for(let e=0,s=0;e<i.colors.length;e++,s+=4){const n=i.colors[e];t[s]=n.r,t[s+1]=n.g,t[s+2]=n.b,t[s+3]=n.a}o.updateVerticesData(he.ColorKind,t,!1,!1)}if(i.uvs){const t=o.getVerticesData(he.UVKind);for(let e=0;e<i.uvs.length;e++)t[2*e]=i.uvs[e].x,t[2*e+1]=As.UseOpenGLOrientationForUV?1-i.uvs[e].y:i.uvs[e].y;o.updateVerticesData(he.UVKind,t,!1,!1)}if(!o.areNormalsFrozen||o.isFacetDataEnabled){const t=o.getIndices(),i=o.getVerticesData(he.NormalKind),e=o.isFacetDataEnabled?o.getFacetDataParameters():null;if(os.ComputeNormals(r,t,i,e),o.MI&&o.MI.closePath){let t=0,e=0;for(let n=0;n<s.length;n++)t=3*o.MI.idx[n],e=n+1<s.length?3*(o.MI.idx[n+1]-1):i.length-3,i[t]=.5*(i[t]+i[e]),i[t+1]=.5*(i[t+1]+i[e+1]),i[t+2]=.5*(i[t+2]+i[e+2]),i[e]=i[t],i[e+1]=i[t+1],i[e+2]=i[t+2]}o.areNormalsFrozen||o.updateVerticesData(he.NormalKind,i,!1,!1)}return o}{const s=new Ys(t,e);s.yI=h,s.MI=new zs;const o=pu(i);return r&&(s.MI.idx=o.Aq),s.MI.closePath=r,s.MI.closeArray=n,o.applyToMesh(s,a),s}}function vu(t,i,e=null){const s=i.path,n=i.shape,r=i.scale||1,h=i.rotation||0,o=0===i.cap?0:i.cap||Ys.NO_CAP,a=i.updatable,l=Ys.OI(i.sideOrientation),c=i.instance||null,u=i.invertUV||!1,f=i.closeShape||!1;return Su(t,n,s,r,h,null,null,i.closePath||!1,f,o,!1,e,!!a,l,c,u,i.frontUVs||null,i.backUVs||null,i.firstNormal||null,!!i.adjustFrame)}function gu(t,i,e=null){const s=i.path,n=i.shape,r=i.scaleFunction||(()=>1),h=i.rotationFunction||(()=>0),o=i.closePath||i.ribbonCloseArray||!1,a=i.closeShape||i.ribbonClosePath||!1,l=0===i.cap?0:i.cap||Ys.NO_CAP,c=i.updatable,u=i.firstNormal||null,f=i.adjustFrame||!1;return Su(t,n,s,null,null,r,h,o,a,l,!0,e,!!c,Ys.OI(i.sideOrientation),i.instance||null,i.invertUV||!1,i.frontUVs||null,i.backUVs||null,u,f)}function Su(t,i,e,s,n,r,h,o,a,l,c,u,f,d,p,m,v,g,S,E){const A=(t,i,e,s,n,r,h,o,a,l,c)=>{const u=e.getTangents(),f=e.getNormals(),d=e.getBinormals(),p=e.getDistances();if(c)for(let t=0;t<u.length;t++)if(0==u[t].x&&0==u[t].y&&0==u[t].z&&u[t].copyFrom(u[t-1]),0==f[t].x&&0==f[t].y&&0==f[t].z&&f[t].copyFrom(f[t-1]),0==d[t].x&&0==d[t].y&&0==d[t].z&&d[t].copyFrom(d[t-1]),t>0){let i=u[t-1];w.Dot(i,u[t])<0&&u[t].scaleInPlace(-1),i=f[t-1],w.Dot(i,f[t])<0&&f[t].scaleInPlace(-1),i=d[t-1],w.Dot(i,d[t])<0&&d[t].scaleInPlace(-1)}let m=0;const v=l&&o?o:()=>null!==r?r:0,g=l&&h?h:()=>null!==n?n:1;let S=a===Ys.NO_CAP||a===Ys.CAP_END?0:2;const E=M.Matrix[0];for(let e=0;e<i.length;e++){const n=new Array,r=v(e,p[e]),h=g(e,p[e]);R.RotationAxisToRef(u[e],m,E);for(let s=0;s<t.length;s++){const r=u[e].scale(t[s].z).add(f[e].scale(t[s].x)).add(d[e].scale(t[s].y)),o=w.Zero();w.TransformCoordinatesToRef(r,E,o),o.scaleInPlace(h).addInPlace(i[e]),n[s]=o}s[S]=n,m+=r,S++}const A=t=>{const i=Array(),e=w.Zero();let s;for(s=0;s<t.length;s++)e.addInPlace(t[s]);for(e.scaleInPlace(1/t.length),s=0;s<t.length;s++)i.push(e);return i};switch(a){case Ys.NO_CAP:break;case Ys.CAP_START:s[0]=A(s[2]),s[1]=s[2];break;case Ys.CAP_END:s[S]=s[S-1],s[S+1]=A(s[S-1]);break;case Ys.CAP_ALL:s[0]=A(s[2]),s[1]=s[2],s[S]=s[S-1],s[S+1]=A(s[S-1])}return s};let C,x;if(p){const t=p.MI;return C=S?t.path3D.update(e,S):t.path3D.update(e),x=A(i,e,t.path3D,t.pathArray,s,n,r,h,t.cap,c,E),p=mu("",{pathArray:x,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:p},u||void 0)}C=S?new Ye(e,S):new Ye(e);x=A(i,e,C,new Array,s,n,r,h,l=l<0||l>3?0:l,c,E);const T=mu(t,{pathArray:x,closeArray:o,closePath:a,updatable:f,sideOrientation:d,invertUV:m,frontUVs:v||void 0,backUVs:g||void 0},u);return T.MI.pathArray=x,T.MI.path3D=C,T.MI.cap=l,T}os.CreateRibbon=pu,Ys.CreateRibbon=(t,i,e=!1,s,n,r,h=!1,o,a)=>mu(t,{pathArray:i,closeArray:e,closePath:s,offset:n,updatable:h,sideOrientation:o,instance:a},r);Ys.ExtrudeShape=(t,i,e,s,n,r,h=null,o,a,l)=>vu(t,{shape:i,path:e,scale:s,rotation:n,cap:0===r?0:r||Ys.NO_CAP,sideOrientation:a,instance:l,updatable:o},h),Ys.ExtrudeShapeCustom=(t,i,e,s,n,r,h,o,a,l,c,u)=>gu(t,{shape:i,path:e,scaleFunction:s,rotationFunction:n,ribbonCloseArray:r,ribbonClosePath:h,cap:0===o?0:o||Ys.NO_CAP,sideOrientation:c,instance:u,updatable:l},a);class Eu{constructor(t,i,e,s=!0,n=3,r={}){var h,o,a,l,c,u,f,d,p,m,v,g,S,E;this.skeleton=t,this.mesh=i,this.autoUpdateBonesMatrices=s,this.renderingGroupId=n,this.options=r,this.color=_.White(),this.Cq=new Array,this.wq=null,this.ui=!0,this.xq=null,this.Kt=e,this.Tq=!1,r.pauseAnimations=null===(h=r.pauseAnimations)||void 0===h||h,r.returnToRest=null!==(o=r.returnToRest)&&void 0!==o&&o,r.displayMode=null!==(a=r.displayMode)&&void 0!==a?a:Eu.DISPLAY_LINES,r.displayOptions=null!==(l=r.displayOptions)&&void 0!==l?l:{},r.displayOptions.midStep=null!==(c=r.displayOptions.midStep)&&void 0!==c?c:.235,r.displayOptions.midStepFactor=null!==(u=r.displayOptions.midStepFactor)&&void 0!==u?u:.155,r.displayOptions.sphereBaseSize=null!==(f=r.displayOptions.sphereBaseSize)&&void 0!==f?f:.15,r.displayOptions.sphereScaleUnit=null!==(d=r.displayOptions.sphereScaleUnit)&&void 0!==d?d:2,r.displayOptions.sphereFactor=null!==(p=r.displayOptions.sphereFactor)&&void 0!==p?p:.865,r.displayOptions.spurFollowsChild=null!==(m=r.displayOptions.spurFollowsChild)&&void 0!==m&&m,r.displayOptions.showLocalAxes=null!==(v=r.displayOptions.showLocalAxes)&&void 0!==v&&v,r.displayOptions.localAxesSize=null!==(g=r.displayOptions.localAxesSize)&&void 0!==g?g:.075,r.computeBonesUsingShaders=null===(S=r.computeBonesUsingShaders)||void 0===S||S,r.useAllBones=null===(E=r.useAllBones)||void 0===E||E;const A=i.getVerticesData(he.MatricesIndicesKind),C=i.getVerticesData(he.MatricesWeightsKind);if(this.Rq=new Set,!r.useAllBones&&A&&C)for(let t=0;t<A.length;++t){const i=A[t];0!==C[t]&&this.Rq.add(i)}this.Iq=new Wc(this.Kt,!1),this.Iq.pickUtilitySceneFirst=!1,this.Iq.utilityLayerScene.autoClearDepthAndStencil=!0;let w=this.options.displayMode||0;w>Eu.DISPLAY_SPHERE_AND_SPURS&&(w=Eu.DISPLAY_LINES),this.displayMode=w,this.update(),this.Mq()}static CreateBoneWeightShader(t,i){var e,s,n,r,h,o;const a=t.skeleton,l=null!==(e=t.colorBase)&&void 0!==e?e:_.Black(),c=null!==(s=t.colorZero)&&void 0!==s?s:_.Blue(),u=null!==(n=t.colorQuarter)&&void 0!==n?n:_.Green(),f=null!==(r=t.colorHalf)&&void 0!==r?r:_.Yellow(),d=null!==(h=t.colorFull)&&void 0!==h?h:_.Red(),p=null!==(o=t.targetBoneIndex)&&void 0!==o?o:0;ei.ShadersStore["boneWeights:"+a.name+"VertexShader"]="precision highp float;\n\n        attribute vec3 position;\n        attribute vec2 uv;\n\n        uniform mat4 view;\n        uniform mat4 projection;\n        uniform mat4 worldViewProjection;\n\n        #include<bonesDeclaration>\n        #if NUM_BONE_INFLUENCERS == 0\n            attribute vec4 matricesIndices;\n            attribute vec4 matricesWeights;\n        #endif\n        #include<bakedVertexAnimationDeclaration>\n\n        #include<instancesDeclaration>\n\n        varying vec3 vColor;\n\n        uniform vec3 colorBase;\n        uniform vec3 colorZero;\n        uniform vec3 colorQuarter;\n        uniform vec3 colorHalf;\n        uniform vec3 colorFull;\n\n        uniform float targetBoneIndex;\n\n        void main() {\n            vec3 positionUpdated = position;\n\n            #include<instancesVertex>\n            #include<bonesVertex>\n            #include<bakedVertexAnimation>\n\n            vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n            vec3 color = colorBase;\n            float totalWeight = 0.;\n            if(matricesIndices[0] == targetBoneIndex && matricesWeights[0] > 0.){\n                totalWeight += matricesWeights[0];\n            }\n            if(matricesIndices[1] == targetBoneIndex && matricesWeights[1] > 0.){\n                totalWeight += matricesWeights[1];\n            }\n            if(matricesIndices[2] == targetBoneIndex && matricesWeights[2] > 0.){\n                totalWeight += matricesWeights[2];\n            }\n            if(matricesIndices[3] == targetBoneIndex && matricesWeights[3] > 0.){\n                totalWeight += matricesWeights[3];\n            }\n\n            color = mix(color, colorZero, smoothstep(0., 0.25, totalWeight));\n            color = mix(color, colorQuarter, smoothstep(0.25, 0.5, totalWeight));\n            color = mix(color, colorHalf, smoothstep(0.5, 0.75, totalWeight));\n            color = mix(color, colorFull, smoothstep(0.75, 1.0, totalWeight));\n            vColor = color;\n\n        gl_Position = projection * view * worldPos;\n        }",ei.ShadersStore["boneWeights:"+a.name+"FragmentShader"]="\n            precision highp float;\n            varying vec3 vPosition;\n\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4(vColor, 1.0);\n                gl_FragColor = color;\n            }\n        ";const m=new eu("boneWeight:"+a.name,i,{vertex:"boneWeights:"+a.name,fragment:"boneWeights:"+a.name},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorBase","colorZero","colorQuarter","colorHalf","colorFull","targetBoneIndex"]});return m.setColor3("colorBase",l),m.setColor3("colorZero",c),m.setColor3("colorQuarter",u),m.setColor3("colorHalf",f),m.setColor3("colorFull",d),m.setFloat("targetBoneIndex",p),m.getClassName=()=>"BoneWeightShader",m.transparencyMode=Vs.MATERIAL_OPAQUE,m}static CreateSkeletonMapShader(t,i){var e;const s=t.skeleton,n=null!==(e=t.colorMap)&&void 0!==e?e:[{color:new _(1,.38,.18),location:0},{color:new _(.59,.18,1),location:.2},{color:new _(.59,1,.18),location:.4},{color:new _(1,.87,.17),location:.6},{color:new _(1,.17,.42),location:.8},{color:new _(.17,.68,1),location:1}],r=s.bones.length+1,h=Eu.bq(r,n,i),o=new eu("boneWeights:"+s.name,i,{vertexSource:"precision highp float;\n\n            attribute vec3 position;\n            attribute vec2 uv;\n\n            uniform mat4 view;\n            uniform mat4 projection;\n            uniform mat4 worldViewProjection;\n            uniform float colorMap["+4*s.bones.length+"];\n\n            #include<bonesDeclaration>\n            #if NUM_BONE_INFLUENCERS == 0\n                attribute vec4 matricesIndices;\n                attribute vec4 matricesWeights;\n            #endif\n            #include<bakedVertexAnimationDeclaration>\n            #include<instancesDeclaration>\n\n            varying vec3 vColor;\n\n            void main() {\n                vec3 positionUpdated = position;\n\n                #include<instancesVertex>\n                #include<bonesVertex>\n                #include<bakedVertexAnimation>\n\n                vec3 color = vec3(0.);\n                bool first = true;\n\n                for (int i = 0; i < 4; i++) {\n                    int boneIdx = int(matricesIndices[i]);\n                    float boneWgt = matricesWeights[i];\n\n                    vec3 c = vec3(colorMap[boneIdx * 4 + 0], colorMap[boneIdx * 4 + 1], colorMap[boneIdx * 4 + 2]);\n\n                    if (boneWgt > 0.) {\n                        if (first) {\n                            first = false;\n                            color = c;\n                        } else {\n                            color = mix(color, c, boneWgt);\n                        }\n                    }\n                }\n\n                vColor = color;\n\n                vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n                gl_Position = projection * view * worldPos;\n            }",fragmentSource:"\n            precision highp float;\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4( vColor, 1.0 );\n                gl_FragColor = color;\n            }\n            "},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorMap"]});return o.setFloats("colorMap",h),o.getClassName=()=>"SkeletonMapShader",o.transparencyMode=Vs.MATERIAL_OPAQUE,o}static bq(t,i,e){const s=new nc("temp",{width:t,height:1},e,!1),n=s.getContext(),r=n.createLinearGradient(0,0,t,0);i.forEach((t=>{r.addColorStop(t.location,t.color.toHexString())})),n.fillStyle=r,n.fillRect(0,0,t,1),s.update();const h=[],o=n.getImageData(0,0,t,1).data;for(let t=0;t<o.length;t++)h.push(.00392156862745098*o[t]);return s.dispose(),h}get scene(){return this.Kt}get utilityLayer(){return this.Iq}get isReady(){return this.Tq}set ready(t){this.Tq=t}get debugMesh(){return this._q}set debugMesh(t){this._q=t}get displayMode(){return this.options.displayMode||Eu.DISPLAY_LINES}set displayMode(t){t>Eu.DISPLAY_SPHERE_AND_SPURS&&(t=Eu.DISPLAY_LINES),this.options.displayMode=t}Mq(){if(this.displayMode===Eu.DISPLAY_LINES)this.xq=this.scene.onBeforeRenderObservable.add((()=>{this.yq()}))}update(){switch(this.displayMode){case Eu.DISPLAY_LINES:this.yq();break;case Eu.DISPLAY_SPHERES:this.Nq(!0);break;case Eu.DISPLAY_SPHERE_AND_SPURS:this.Nq(!1)}this.Pq()}set isEnabled(t){this.isEnabled!==t&&(this.ui=t,this.debugMesh&&this.debugMesh.setEnabled(t),t&&!this.xq?this.Mq():!t&&this.xq&&(this.scene.onBeforeRenderObservable.remove(this.xq),this.xq=null))}get isEnabled(){return this.ui}Dq(t,i,e,s=0,n=0,r=0){const h=M.Matrix[0],o=i.getParent();if(h.copyFrom(i.getLocalMatrix()),0!==s||0!==n||0!==r){const t=M.Matrix[1];R.IdentityToRef(t),t.setTranslationFromFloats(s,n,r),t.multiplyToRef(h,h)}o&&h.multiplyToRef(o.getAbsoluteTransform(),h),h.multiplyToRef(e,h),t.x=h.m[12],t.y=h.m[13],t.z=h.m[14]}Lq(t,i){const e=t.length,s=this.mesh.position;let n=0;for(let r=0;r<e;r++){const e=t[r];let h=this.Cq[n];-1!==e.kS&&(this.Rq.has(e.getIndex())||this.options.useAllBones)&&(h||(h=[w.Zero(),w.Zero()],this.Cq[n]=h),this.Dq(h[0],e,i),this.Dq(h[1],e,i,0,e.length,0),h[0].subtractInPlace(s),h[1].subtractInPlace(s),n++)}}Oq(t){const i=t.length;let e=0;const s=this.mesh,n=s.position;for(let r=i-1;r>=0;r--){const i=t[r],h=i.getParent();if(!h||!this.Rq.has(i.getIndex())&&!this.options.useAllBones)continue;let o=this.Cq[e];o||(o=[w.Zero(),w.Zero()],this.Cq[e]=o),i.getAbsolutePositionToRef(s,o[0]),h.getAbsolutePositionToRef(s,o[1]),o[0].subtractInPlace(n),o[1].subtractInPlace(n),e++}}Fq(t){this.options.pauseAnimations&&(this.scene.animationsEnabled=t,this.utilityLayer.utilityLayerScene.animationsEnabled=t)}Bq(t,i){null!==t&&-1!==t.kS?(this.Bq(t.getParent(),i),t.getBaseMatrix().multiplyToRef(i,i)):i.copyFrom(R.Identity())}Nq(t=!0){var i,e;this._q&&(this._q.dispose(),this._q=null,this.ready=!1),this.Tq=!1;const s=null===(i=this.utilityLayer)||void 0===i?void 0:i.utilityLayerScene,n=this.skeleton.bones,r=[],h=[],o=this.scene.animationsEnabled;try{this.options.pauseAnimations&&(this.scene.animationsEnabled=!1,s.animationsEnabled=!1),this.options.returnToRest&&this.skeleton.returnToRest(),this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms();let i=Number.NEGATIVE_INFINITY;const a=this.options.displayOptions||{};for(let e=0;e<n.length;e++){const o=n[e];if(-1===o.kS||!this.Rq.has(o.getIndex())&&!this.options.useAllBones)continue;const l=new R;this.Bq(o,l);const c=new w;l.decompose(void 0,void 0,c),o.children.forEach((e=>{const n=new R;e.getBaseMatrix().multiplyToRef(l,n);const r=new w;n.decompose(void 0,void 0,r);const u=w.Distance(c,r);if(u>i&&(i=u),t)return;const f=r.clone().subtract(c.clone()),d=f.length(),p=f.normalize().scale(d),m=a.midStep||.165,v=a.midStepFactor||.215,g=p.scale(m),S=gu("skeletonViewer",{shape:[new w(1,-1,0),new w(1,1,0),new w(-1,1,0),new w(-1,-1,0),new w(1,-1,0)],path:[w.Zero(),g,p],scaleFunction:t=>{switch(t){case 0:case 2:return 0;case 1:return d*v}return 0},sideOrientation:Ys.DEFAULTSIDE,updatable:!1},s),E=S.getTotalVertices(),A=[],C=[];for(let t=0;t<E;t++)A.push(1,0,0,0),a.spurFollowsChild&&t>9?C.push(e.getIndex(),0,0,0):C.push(o.getIndex(),0,0,0);S.position=c.clone(),S.setVerticesData(he.MatricesWeightsKind,A,!1),S.setVerticesData(he.MatricesIndicesKind,C,!1),S.convertToFlatShadedMesh(),h.push(S)}));const u=Qc("skeletonViewer",{segments:6,diameter:a.sphereBaseSize||.2,updatable:!0},s),f=u.getTotalVertices(),d=[],p=[];for(let t=0;t<f;t++)d.push(1,0,0,0),p.push(o.getIndex(),0,0,0);u.setVerticesData(he.MatricesWeightsKind,d,!1),u.setVerticesData(he.MatricesIndicesKind,p,!1),u.position=c.clone(),r.push([u,o])}const l=a.sphereScaleUnit||2,c=a.sphereFactor||.85,u=[];for(let t=0;t<r.length;t++){const[e,s]=r[t],n=1/(l/i);let h=0,o=s;for(;o.getParent()&&-1!==o.getParent().getIndex();)h++,o=o.getParent();e.scaling.scaleInPlace(n*Math.pow(c,h)),u.push(e)}this.debugMesh=Ys.MergeMeshes(u.concat(h),!0,!0),this.debugMesh&&(this.debugMesh.renderingGroupId=this.renderingGroupId,this.debugMesh.skeleton=this.skeleton,this.debugMesh.parent=this.mesh,this.debugMesh.computeBonesUsingShaders=null===(e=this.options.computeBonesUsingShaders)||void 0===e||e,this.debugMesh.alwaysSelectAsActiveMesh=!0);this.utilityLayer.bK().intensity=.7,this.Fq(o),this.ready=!0}catch(t){console.error(t),this.Fq(o),this.dispose()}}Pq(){var t;this.wq&&this.wq.dispose(),this.wq=null;const i=this.options.displayOptions||{};if(!i.showLocalAxes)return;const e=this.Iq.utilityLayerScene,s=i.localAxesSize||.075,n=[],r=[],h=new y(1,0,0,1),o=new y(0,1,0,1),a=new y(0,0,1,1),l=[],c=[];for(const t in this.skeleton.bones){const i=this.skeleton.bones[t];if(-1===i.kS||!this.Rq.has(i.getIndex())&&!this.options.useAllBones)continue;const e=new R,u=new w;this.Bq(i,e),e.decompose(void 0,M.Quaternion[0],u);const f=new R;M.Quaternion[0].toRotationMatrix(f);const d=w.TransformCoordinates(new w(0+s,0,0),f),p=w.TransformCoordinates(new w(0,0+s,0),f),m=w.TransformCoordinates(new w(0,0,0+s),f),v=[[u,u.add(d)],[u,u.add(p)],[u,u.add(m)]],g=[[h,h],[o,o],[a,a]];n.push(...v),r.push(...g);for(let t=0;t<6;t++)l.push(1,0,0,0),c.push(i.getIndex(),0,0,0)}this.wq=uu("localAxes",{lines:n,colors:r,updatable:!0},e),this.wq.setVerticesData(he.MatricesWeightsKind,l,!1),this.wq.setVerticesData(he.MatricesIndicesKind,c,!1),this.wq.skeleton=this.skeleton,this.wq.renderingGroupId=this.renderingGroupId+1,this.wq.parent=this.mesh,this.wq.computeBonesUsingShaders=null===(t=this.options.computeBonesUsingShaders)||void 0===t||t}yq(){if(!this.Iq)return;this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms(),void 0===this.skeleton.bones[0].length?this.Oq(this.skeleton.bones):this.Lq(this.skeleton.bones,this.mesh.getWorldMatrix());const t=this.Iq.utilityLayerScene;t&&(this._q?uu("",{lines:this.Cq,updatable:!0,instance:this._q},t):(this._q=uu("",{lines:this.Cq,updatable:!0,instance:null},t),this._q.renderingGroupId=this.renderingGroupId),this._q.position.copyFrom(this.mesh.position),this._q.color=this.color)}changeDisplayMode(t){const i=!!this.isEnabled;this.displayMode!==t&&(this.isEnabled=!1,this._q&&(this._q.dispose(),this._q=null,this.ready=!1),this.displayMode=t,this.update(),this.Mq(),this.isEnabled=i)}changeDisplayOptions(t,i){const e=!!this.isEnabled;this.options.displayOptions[t]=i,this.isEnabled=!1,this._q&&(this._q.dispose(),this._q=null,this.ready=!1),this.update(),this.Mq(),this.isEnabled=e}dispose(){this.isEnabled=!1,this._q&&(this._q.dispose(),this._q=null),this.Iq&&(this.Iq.dispose(),this.Iq=null),this.ready=!1}}Eu.DISPLAY_LINES=0,Eu.DISPLAY_SPHERES=1,Eu.DISPLAY_SPHERE_AND_SPURS=2;class Au{}Au.ALPHA_DISABLE=0,Au.ALPHA_ADD=1,Au.ALPHA_COMBINE=2,Au.ALPHA_SUBTRACT=3,Au.ALPHA_MULTIPLY=4,Au.ALPHA_MAXIMIZED=5,Au.ALPHA_ONEONE=6,Au.ALPHA_PREMULTIPLIED=7,Au.ALPHA_PREMULTIPLIED_PORTERDUFF=8,Au.ALPHA_INTERPOLATE=9,Au.ALPHA_SCREENMODE=10,Au.ALPHA_ONEONE_ONEONE=11,Au.ALPHA_ALPHATOCOLOR=12,Au.ALPHA_REVERSEONEMINUS=13,Au.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,Au.ALPHA_ONEONE_ONEZERO=15,Au.ALPHA_EXCLUSION=16,Au.ALPHA_LAYER_ACCUMULATE=17,Au.ALPHA_EQUATION_ADD=0,Au.ALPHA_EQUATION_SUBSTRACT=1,Au.ALPHA_EQUATION_REVERSE_SUBTRACT=2,Au.ALPHA_EQUATION_MAX=3,Au.ALPHA_EQUATION_MIN=4,Au.ALPHA_EQUATION_DARKEN=5,Au.DELAYLOADSTATE_NONE=0,Au.DELAYLOADSTATE_LOADED=1,Au.DELAYLOADSTATE_LOADING=2,Au.DELAYLOADSTATE_NOTLOADED=4,Au.NEVER=512,Au.ALWAYS=519,Au.LESS=513,Au.EQUAL=514,Au.LEQUAL=515,Au.GREATER=516,Au.GEQUAL=518,Au.NOTEQUAL=517,Au.KEEP=7680,Au.ZERO=0,Au.REPLACE=7681,Au.INCR=7682,Au.DECR=7683,Au.INVERT=5386,Au.INCR_WRAP=34055,Au.DECR_WRAP=34056,Au.TEXTURE_CLAMP_ADDRESSMODE=0,Au.TEXTURE_WRAP_ADDRESSMODE=1,Au.TEXTURE_MIRROR_ADDRESSMODE=2,Au.TEXTURE_CREATIONFLAG_STORAGE=1,Au.TEXTUREFORMAT_ALPHA=0,Au.TEXTUREFORMAT_LUMINANCE=1,Au.TEXTUREFORMAT_LUMINANCE_ALPHA=2,Au.TEXTUREFORMAT_RGB=4,Au.TEXTUREFORMAT_RGBA=5,Au.TEXTUREFORMAT_RED=6,Au.TEXTUREFORMAT_R=6,Au.TEXTUREFORMAT_RG=7,Au.TEXTUREFORMAT_RED_INTEGER=8,Au.TEXTUREFORMAT_R_INTEGER=8,Au.TEXTUREFORMAT_RG_INTEGER=9,Au.TEXTUREFORMAT_RGB_INTEGER=10,Au.TEXTUREFORMAT_RGBA_INTEGER=11,Au.TEXTUREFORMAT_BGRA=12,Au.TEXTUREFORMAT_DEPTH24_STENCIL8=13,Au.TEXTUREFORMAT_DEPTH32_FLOAT=14,Au.TEXTUREFORMAT_DEPTH16=15,Au.TEXTUREFORMAT_DEPTH24=16,Au.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,Au.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,Au.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,Au.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,Au.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,Au.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,Au.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,Au.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,Au.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,Au.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,Au.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,Au.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,Au.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,Au.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,Au.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,Au.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,Au.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,Au.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,Au.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,Au.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,Au.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,Au.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,Au.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,Au.TEXTURETYPE_UNSIGNED_BYTE=0,Au.TEXTURETYPE_UNSIGNED_INT=0,Au.TEXTURETYPE_FLOAT=1,Au.TEXTURETYPE_HALF_FLOAT=2,Au.TEXTURETYPE_BYTE=3,Au.TEXTURETYPE_SHORT=4,Au.TEXTURETYPE_UNSIGNED_SHORT=5,Au.TEXTURETYPE_INT=6,Au.TEXTURETYPE_UNSIGNED_INTEGER=7,Au.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,Au.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,Au.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,Au.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,Au.TEXTURETYPE_UNSIGNED_INT_24_8=12,Au.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,Au.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,Au.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,Au.TEXTURETYPE_UNDEFINED=16,Au.TEXTURE_NEAREST_SAMPLINGMODE=1,Au.TEXTURE_NEAREST_NEAREST=1,Au.TEXTURE_BILINEAR_SAMPLINGMODE=2,Au.TEXTURE_LINEAR_LINEAR=2,Au.TEXTURE_TRILINEAR_SAMPLINGMODE=3,Au.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,Au.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,Au.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,Au.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,Au.TEXTURE_NEAREST_LINEAR=7,Au.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,Au.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,Au.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,Au.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,Au.TEXTURE_LINEAR_NEAREST=12,Au.TEXTURE_EXPLICIT_MODE=0,Au.TEXTURE_SPHERICAL_MODE=1,Au.TEXTURE_PLANAR_MODE=2,Au.TEXTURE_CUBIC_MODE=3,Au.TEXTURE_PROJECTION_MODE=4,Au.TEXTURE_SKYBOX_MODE=5,Au.TEXTURE_INVCUBIC_MODE=6,Au.TEXTURE_EQUIRECTANGULAR_MODE=7,Au.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,Au.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,Au.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,Au.TEXTURE_FILTERING_QUALITY_HIGH=64,Au.TEXTURE_FILTERING_QUALITY_MEDIUM=16,Au.TEXTURE_FILTERING_QUALITY_LOW=8,Au.SCALEMODE_FLOOR=1,Au.SCALEMODE_NEAREST=2,Au.SCALEMODE_CEILING=3,Au.MATERIAL_TextureDirtyFlag=1,Au.MATERIAL_LightDirtyFlag=2,Au.MATERIAL_FresnelDirtyFlag=4,Au.MATERIAL_AttributesDirtyFlag=8,Au.MATERIAL_MiscDirtyFlag=16,Au.MATERIAL_PrePassDirtyFlag=32,Au.MATERIAL_AllDirtyFlag=63,Au.MATERIAL_TriangleFillMode=0,Au.MATERIAL_WireFrameFillMode=1,Au.MATERIAL_PointFillMode=2,Au.MATERIAL_PointListDrawMode=3,Au.MATERIAL_LineListDrawMode=4,Au.MATERIAL_LineLoopDrawMode=5,Au.MATERIAL_LineStripDrawMode=6,Au.MATERIAL_TriangleStripDrawMode=7,Au.MATERIAL_TriangleFanDrawMode=8,Au.MATERIAL_ClockWiseSideOrientation=0,Au.MATERIAL_CounterClockWiseSideOrientation=1,Au.ACTION_NothingTrigger=0,Au.ACTION_OnPickTrigger=1,Au.ACTION_OnLeftPickTrigger=2,Au.ACTION_OnRightPickTrigger=3,Au.ACTION_OnCenterPickTrigger=4,Au.ACTION_OnPickDownTrigger=5,Au.ACTION_OnDoublePickTrigger=6,Au.ACTION_OnPickUpTrigger=7,Au.ACTION_OnPickOutTrigger=16,Au.ACTION_OnLongPressTrigger=8,Au.ACTION_OnPointerOverTrigger=9,Au.ACTION_OnPointerOutTrigger=10,Au.ACTION_OnEveryFrameTrigger=11,Au.ACTION_OnIntersectionEnterTrigger=12,Au.ACTION_OnIntersectionExitTrigger=13,Au.ACTION_OnKeyDownTrigger=14,Au.ACTION_OnKeyUpTrigger=15,Au.PARTICLES_BILLBOARDMODE_Y=2,Au.PARTICLES_BILLBOARDMODE_ALL=7,Au.PARTICLES_BILLBOARDMODE_STRETCHED=8,Au.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,Au.MESHES_CULLINGSTRATEGY_STANDARD=0,Au.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,Au.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,Au.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,Au.SCENELOADER_NO_LOGGING=0,Au.SCENELOADER_MINIMAL_LOGGING=1,Au.SCENELOADER_SUMMARY_LOGGING=2,Au.SCENELOADER_DETAILED_LOGGING=3,Au.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,Au.PREPASS_POSITION_TEXTURE_TYPE=1,Au.PREPASS_VELOCITY_TEXTURE_TYPE=2,Au.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,Au.PREPASS_COLOR_TEXTURE_TYPE=4,Au.PREPASS_DEPTH_TEXTURE_TYPE=5,Au.PREPASS_NORMAL_TEXTURE_TYPE=6,Au.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,Au.BUFFER_CREATIONFLAG_READ=1,Au.BUFFER_CREATIONFLAG_WRITE=2,Au.BUFFER_CREATIONFLAG_READWRITE=3,Au.BUFFER_CREATIONFLAG_UNIFORM=4,Au.BUFFER_CREATIONFLAG_VERTEX=8,Au.BUFFER_CREATIONFLAG_INDEX=16,Au.BUFFER_CREATIONFLAG_STORAGE=32,Au.RENDERPASS_MAIN=0,Au.INPUT_ALT_KEY=18,Au.INPUT_CTRL_KEY=17,Au.INPUT_META_KEY1=91,Au.INPUT_META_KEY2=92,Au.INPUT_META_KEY3=93,Au.INPUT_SHIFT_KEY=16,Au.SNAPSHOTRENDERING_STANDARD=0,Au.SNAPSHOTRENDERING_FAST=1,Au.PERSPECTIVE_CAMERA=0,Au.ORTHOGRAPHIC_CAMERA=1,Au.FOVMODE_VERTICAL_FIXED=0,Au.FOVMODE_HORIZONTAL_FIXED=1,Au.RIG_MODE_NONE=0,Au.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,Au.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,Au.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,Au.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,Au.RIG_MODE_STEREOSCOPIC_INTERLACED=14,Au.RIG_MODE_VR=20,Au.RIG_MODE_WEBVR=21,Au.RIG_MODE_CUSTOM=22,Au.MAX_SUPPORTED_UV_SETS=6,Au.GL_ALPHA_EQUATION_ADD=32774,Au.GL_ALPHA_EQUATION_MIN=32775,Au.GL_ALPHA_EQUATION_MAX=32776,Au.GL_ALPHA_EQUATION_SUBTRACT=32778,Au.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,Au.GL_ALPHA_FUNCTION_SRC=768,Au.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,Au.GL_ALPHA_FUNCTION_SRC_ALPHA=770,Au.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,Au.GL_ALPHA_FUNCTION_DST_ALPHA=772,Au.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,Au.GL_ALPHA_FUNCTION_DST_COLOR=774,Au.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,Au.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,Au.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,Au.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,Au.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,Au.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,Au.SnippetUrl="https://snippet.babylonjs.com";Ei.prototype.NO=function(t,i){},Ei.prototype.PO=function(t){},Ei.prototype.gf=function(t,i){},Ei.prototype.Uq=function(){};class Cu{constructor(){this.Vq=!1}}class wu{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=ys.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=ys.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}Rs.prototype.createQuery=function(){const t=this.lo.createQuery();if(!t)throw new Error("Unable to create Occlusion Query");return t},Rs.prototype.deleteQuery=function(t){return this.lo.deleteQuery(t),this},Rs.prototype.isQueryResultAvailable=function(t){return this.lo.getQueryParameter(t,this.lo.QUERY_RESULT_AVAILABLE)},Rs.prototype.getQueryResult=function(t){return this.lo.getQueryParameter(t,this.lo.QUERY_RESULT)},Rs.prototype.beginOcclusionQuery=function(t,i){const e=this.kq(t);return this.lo.beginQuery(e,i),!0},Rs.prototype.endOcclusionQuery=function(t){const i=this.kq(t);return this.lo.endQuery(i),this},Rs.prototype.Gq=function(){const t=this.getCaps().timerQuery;return t.createQueryEXT?t.createQueryEXT():this.createQuery()},Rs.prototype.zq=function(t){const i=this.getCaps().timerQuery;i.deleteQueryEXT?i.deleteQueryEXT(t):this.deleteQuery(t)},Rs.prototype.Hq=function(t){const i=this.getCaps().timerQuery;return i.getQueryObjectEXT?i.getQueryObjectEXT(t,i.QUERY_RESULT_EXT):this.getQueryResult(t)},Rs.prototype.Xq=function(t){const i=this.getCaps().timerQuery;return i.getQueryObjectEXT?i.getQueryObjectEXT(t,i.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(t)},Rs.prototype.startTimeQuery=function(){const t=this.getCaps(),i=t.timerQuery;if(!i)return null;const e=new Cu;if(this.lo.getParameter(i.GPU_DISJOINT_EXT),t.canUseTimestampForTimerQuery)e.Wq=this.Gq(),i.queryCounterEXT(e.Wq,i.TIMESTAMP_EXT);else{if(this.$q)return this.$q;e.Yq=this.Gq(),i.beginQueryEXT?i.beginQueryEXT(i.TIME_ELAPSED_EXT,e.Yq):this.lo.beginQuery(i.TIME_ELAPSED_EXT,e.Yq),this.$q=e}return e},Rs.prototype.endTimeQuery=function(t){const i=this.getCaps(),e=i.timerQuery;if(!e||!t)return-1;if(i.canUseTimestampForTimerQuery){if(!t.Wq)return-1;t.jq||(t.jq=this.Gq(),e.queryCounterEXT(t.jq,e.TIMESTAMP_EXT))}else if(!t.Vq){if(!t.Yq)return-1;e.endQueryEXT?e.endQueryEXT(e.TIME_ELAPSED_EXT):(this.lo.endQuery(e.TIME_ELAPSED_EXT),this.$q=null),t.Vq=!0}const s=this.lo.getParameter(e.GPU_DISJOINT_EXT);let n=!1;if(t.jq?n=this.Xq(t.jq):t.Yq&&(n=this.Xq(t.Yq)),n&&!s){let e=0;if(i.canUseTimestampForTimerQuery){if(!t.Wq||!t.jq)return-1;const i=this.Hq(t.Wq);e=this.Hq(t.jq)-i,this.zq(t.Wq),this.zq(t.jq),t.Wq=null,t.jq=null}else{if(!t.Yq)return-1;e=this.Hq(t.Yq),this.zq(t.Yq),t.Yq=null,t.Vq=!1}return e}return-1},Rs.prototype.Kq=!1,Rs.prototype.qq=new Ne,Rs.prototype.getGPUFrameTimeCounter=function(){return this.qq},Rs.prototype.captureGPUFrameTime=function(t){t!==this.Kq&&(this.Kq=t,t?(this.Qq=this.onBeginFrameObservable.add((()=>{this.Zq||(this.Zq=this.startTimeQuery())})),this.Jq=this.onEndFrameObservable.add((()=>{if(!this.Zq)return;const t=this.endTimeQuery(this.Zq);t>-1&&(this.Zq=null,this.qq.fetchNewFrame(),this.qq.addCount(t,!0))}))):(this.onBeginFrameObservable.remove(this.Qq),this.Qq=null,this.onEndFrameObservable.remove(this.Jq),this.Jq=null))},Rs.prototype.kq=function(t){return t===ys.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this.lo.ANY_SAMPLES_PASSED_CONSERVATIVE:this.lo.ANY_SAMPLES_PASSED},Object.defineProperty(ys.prototype,"isOcclusionQueryInProgress",{get:function(){return this.sM.isOcclusionQueryInProgress},set:function(t){this.sM.isOcclusionQueryInProgress=t},enumerable:!1,configurable:!0}),Object.defineProperty(ys.prototype,"sM",{get:function(){return this.tQ||(this.tQ=new wu),this.tQ},enumerable:!1,configurable:!0}),Object.defineProperty(ys.prototype,"isOccluded",{get:function(){return this.sM.isOccluded},set:function(t){this.sM.isOccluded=t},enumerable:!0,configurable:!0}),Object.defineProperty(ys.prototype,"occlusionQueryAlgorithmType",{get:function(){return this.sM.occlusionQueryAlgorithmType},set:function(t){this.sM.occlusionQueryAlgorithmType=t},enumerable:!0,configurable:!0}),Object.defineProperty(ys.prototype,"occlusionType",{get:function(){return this.sM.occlusionType},set:function(t){this.sM.occlusionType=t},enumerable:!0,configurable:!0}),Object.defineProperty(ys.prototype,"occlusionRetryCount",{get:function(){return this.sM.occlusionRetryCount},set:function(t){this.sM.occlusionRetryCount=t},enumerable:!0,configurable:!0}),Object.defineProperty(ys.prototype,"forceRenderingWhenOccluded",{get:function(){return this.sM.forceRenderingWhenOccluded},set:function(t){this.sM.forceRenderingWhenOccluded=t},enumerable:!0,configurable:!0}),ys.prototype.aR=function(){const t=this.sM;if(t.occlusionType===ys.OCCLUSION_TYPE_NONE)return t.isOccluded=!1,!1;const i=this.getEngine();if(!i.getCaps().supportOcclusionQuery)return t.isOccluded=!1,!1;if(!i.isQueryResultAvailable)return t.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this.yT){if(i.isQueryResultAvailable(this.yT)){const e=i.getQueryResult(this.yT);t.isOcclusionQueryInProgress=!1,t.occlusionInternalRetryCounter=0,t.isOccluded=!(e>0)}else{if(t.occlusionInternalRetryCounter++,!(-1!==t.occlusionRetryCount&&t.occlusionInternalRetryCounter>t.occlusionRetryCount))return t.occlusionType!==ys.OCCLUSION_TYPE_OPTIMISTIC&&t.isOccluded;t.isOcclusionQueryInProgress=!1,t.occlusionInternalRetryCounter=0,t.isOccluded=t.occlusionType!==ys.OCCLUSION_TYPE_OPTIMISTIC&&t.isOccluded}}const e=this.getScene();if(e.getBoundingBoxRenderer){const s=e.getBoundingBoxRenderer();null===this.yT&&(this.yT=i.createQuery()),i.beginOcclusionQuery(t.occlusionQueryAlgorithmType,this.yT)&&(s.renderOcclusionBoundingBox(this),i.endOcclusionQuery(t.occlusionQueryAlgorithmType),this.sM.isOcclusionQueryInProgress=!0)}return t.isOccluded};Rs.prototype.createTransformFeedback=function(){const t=this.lo.createTransformFeedback();if(!t)throw new Error("Unable to create Transform Feedback");return t},Rs.prototype.deleteTransformFeedback=function(t){this.lo.deleteTransformFeedback(t)},Rs.prototype.bindTransformFeedback=function(t){this.lo.bindTransformFeedback(this.lo.TRANSFORM_FEEDBACK,t)},Rs.prototype.beginTransformFeedback=function(t=!0){this.lo.beginTransformFeedback(t?this.lo.POINTS:this.lo.TRIANGLES)},Rs.prototype.endTransformFeedback=function(){this.lo.endTransformFeedback()},Rs.prototype.setTranformFeedbackVaryings=function(t,i){this.lo.transformFeedbackVaryings(t,i,this.lo.INTERLEAVED_ATTRIBS)},Rs.prototype.bindTransformFeedbackBuffer=function(t){this.lo.bindBufferBase(this.lo.TRANSFORM_FEEDBACK_BUFFER,0,t?t.underlyingResource:null)},Ei.prototype.createExternalTexture=function(t){return null},Ei.prototype.setExternalTexture=function(t,i){throw new Error("setExternalTexture: This engine does not support external textures!")},Ei.prototype.updateVideoTexture=function(t,i,e){if(!t||t.sr)return;const s=this.Ia(t.format),n=this.Ra(0,t.format),r=this.qo(this.lo.TEXTURE_2D,t,!0);this.La(!e);try{if(void 0===this.iQ&&(this.lo.getError(),this.lo.texImage2D(this.lo.TEXTURE_2D,0,n,s,this.lo.UNSIGNED_BYTE,i),0!==this.lo.getError()?this.iQ=!1:this.iQ=!0),this.iQ)this.lo.texImage2D(this.lo.TEXTURE_2D,0,n,s,this.lo.UNSIGNED_BYTE,i);else{if(!t.tr){t.tr=this.createCanvas(t.width,t.height);const i=t.tr.getContext("2d");if(!i)throw new Error("Unable to get 2d context");t.ir=i,t.tr.width=t.width,t.tr.height=t.height}t.ir.clearRect(0,0,t.width,t.height),t.ir.drawImage(i,0,0,i.videoWidth,i.videoHeight,0,0,t.width,t.height),this.lo.texImage2D(this.lo.TEXTURE_2D,0,n,s,this.lo.UNSIGNED_BYTE,t.tr)}t.generateMipMaps&&this.lo.generateMipmap(this.lo.TEXTURE_2D),r||this.qo(this.lo.TEXTURE_2D,null),t.isReady=!0}catch(i){t.sr=!0}},Ei.prototype.restoreSingleAttachment=function(){const t=this.lo;this.bindAttachments([t.BACK])},Ei.prototype.restoreSingleAttachmentForRenderTarget=function(){const t=this.lo;this.bindAttachments([t.COLOR_ATTACHMENT0])},Ei.prototype.buildTextureLayout=function(t){const i=this.lo,e=[];for(let s=0;s<t.length;s++)t[s]?e.push(i["COLOR_ATTACHMENT"+s]):e.push(i.NONE);return e},Ei.prototype.bindAttachments=function(t){this.lo.drawBuffers(t)},Ei.prototype.unBindMultiColorAttachmentFramebuffer=function(t,i=!1,e){this.zo=null;const s=this.lo,n=t.OD,r=n.length;if(t.Wo){s.bindFramebuffer(s.READ_FRAMEBUFFER,t.Wo),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,t.$o);for(let i=0;i<r;i++){const e=t.textures[i];for(let t=0;t<r;t++)n[t]=s.NONE;n[i]=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],s.readBuffer(n[i]),s.drawBuffers(n),s.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s.COLOR_BUFFER_BIT,s.NEAREST)}for(let t=0;t<r;t++)n[t]=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"];s.drawBuffers(n)}for(let e=0;e<r;e++){const n=t.textures[e];!n.generateMipMaps||i||n.isCube||(this.qo(s.TEXTURE_2D,n,!0),s.generateMipmap(s.TEXTURE_2D),this.qo(s.TEXTURE_2D,null))}e&&(t.Wo&&this.Xo(t.$o),e()),this.Xo(null)},Ei.prototype.createMultipleRenderTarget=function(t,i,e=!0){let s=!1,n=!0,r=!1,h=!1,o=15,a=1;let l=new Array,c=new Array,u=new Array;const f=this.$D(!0,!1,t);void 0!==i&&(s=void 0!==i.generateMipMaps&&i.generateMipMaps,n=void 0===i.generateDepthBuffer||i.generateDepthBuffer,r=void 0!==i.generateStencilBuffer&&i.generateStencilBuffer,h=void 0!==i.generateDepthTexture&&i.generateDepthTexture,a=i.textureCount||1,i.types&&(l=i.types),i.samplingModes&&(c=i.samplingModes),i.useSRGBBuffers&&(u=i.useSRGBBuffers),this.webGLVersion>1&&(13===i.depthTextureFormat||17===i.depthTextureFormat||16===i.depthTextureFormat||14===i.depthTextureFormat||18===i.depthTextureFormat)&&(o=i.depthTextureFormat));const d=this.lo,p=d.createFramebuffer();this.Xo(p);const m=t.width||t,v=t.height||t,g=[],S=[],E=this.webGLVersion>1&&h&&(13===i.depthTextureFormat||17===i.depthTextureFormat||18===i.depthTextureFormat),A=this.Xa(!E&&r,!h&&n,m,v);f.$o=p,f.zD=A,f.BD=!h&&n,f.FD=!E&&r,f.OD=S;for(let t=0;t<a;t++){let i=c[t]||3,e=l[t]||0,n=u[t]||false;(1!==e||this.po.textureFloatLinearFiltering)&&(2!==e||this.po.textureHalfFloatLinearFiltering)||(i=1);const r=this.wa(i,s);1!==e||this.po.textureFloat||(e=0,F.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),n=n&&this.po.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const h=new ai(this,oi.MultiRenderTarget),o=d[this.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"];g.push(h),S.push(o),d.activeTexture(d["TEXTURE"+t]),d.bindTexture(d.TEXTURE_2D,h.Er.underlyingResource),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,r.mag),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,r.min),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE);const a=this.Ra(e,5,n);d.texImage2D(d.TEXTURE_2D,0,a,m,v,0,d.RGBA,this.Ma(e),null),d.framebufferTexture2D(d.DRAW_FRAMEBUFFER,o,d.TEXTURE_2D,h.Er.underlyingResource,0),s&&this.lo.generateMipmap(this.lo.TEXTURE_2D),this.qo(d.TEXTURE_2D,null),h.baseWidth=m,h.baseHeight=v,h.width=m,h.height=v,h.isReady=!0,h.samples=1,h.generateMipMaps=s,h.samplingMode=i,h.type=e,h.ur=n,this.Rh.push(h)}if(h&&this.po.depthTextureExtension){const t=new ai(this,oi.Depth);let i=5,e=d.DEPTH_COMPONENT16,n=d.DEPTH_COMPONENT,r=d.UNSIGNED_SHORT,h=d.DEPTH_ATTACHMENT;this.webGLVersion<2?e=d.DEPTH_COMPONENT:14===o?(i=1,r=d.FLOAT,e=d.DEPTH_COMPONENT32F):18===o?(i=0,r=d.FLOAT_32_UNSIGNED_INT_24_8_REV,e=d.DEPTH32F_STENCIL8,n=d.DEPTH_STENCIL,h=d.DEPTH_STENCIL_ATTACHMENT):16===o?(i=0,r=d.UNSIGNED_INT,e=d.DEPTH_COMPONENT24,h=d.DEPTH_ATTACHMENT):13!==o&&17!==o||(i=12,r=d.UNSIGNED_INT_24_8,e=d.DEPTH24_STENCIL8,n=d.DEPTH_STENCIL,h=d.DEPTH_STENCIL_ATTACHMENT),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,t.Er.underlyingResource),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,e,m,v,0,n,r,null),d.framebufferTexture2D(d.FRAMEBUFFER,h,d.TEXTURE_2D,t.Er.underlyingResource,0),t.baseWidth=m,t.baseHeight=v,t.width=m,t.height=v,t.isReady=!0,t.samples=1,t.generateMipMaps=s,t.samplingMode=1,t.format=o,t.type=i,g.push(t),this.Rh.push(t)}return f.setTextures(g),e&&d.drawBuffers(S),this.Xo(null),this.resetTextureCache(),f},Ei.prototype.updateMultipleRenderTargetTextureSampleCount=function(t,i,e=!0){if(this.webGLVersion<2||!t||!t.texture)return 1;if(t.samples===i)return i;const s=t.OD.length;if(0===s)return 1;const n=this.lo;i=Math.min(i,this.getCaps().maxMSAASamples);const r=!!t.zD;if(r&&(n.deleteRenderbuffer(t.zD),t.zD=null),t.Wo&&(n.deleteFramebuffer(t.Wo),t.Wo=null),i>1&&n.renderbufferStorageMultisample){const r=n.createFramebuffer();if(!r)throw new Error("Unable to create multi sampled framebuffer");t.Wo=r,this.Xo(r);const h=[];for(let e=0;e<s;e++){const s=t.textures[e],r=s.Er,o=n[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"],a=r.Gr?this.$a(r.Gr,s.width,s.height,i,-1,this.nl(s.type),o):this.Wa(s.width,s.height,i,-1,this.nl(s.type),o);if(!a)throw new Error("Unable to create multi sampled framebuffer");r.Gr=a,s.samples=i,h.push(o)}e&&n.drawBuffers(h)}else this.Xo(t.$o);return r&&(t.zD=this.Xa(t.FD,t.BD,t.texture.width,t.texture.height,i)),this.Xo(null),i},Ei.prototype.YD=function(t,i,e){const s=new ai(this,oi.DepthStencil);if(s.isCube=!0,1===this.webGLVersion)return F.Error("Depth cube texture is not supported by WebGL 1."),s;const n={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...i},r=this.lo;this.qo(r.TEXTURE_CUBE_MAP,s,!0),this.Va(s,t,n.generateStencil,n.bilinearFiltering,n.comparisonFunction),e.Yo=s,e.jo=n.generateStencil;for(let i=0;i<6;i++)n.generateStencil?r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,r.DEPTH24_STENCIL8,t,t,0,r.DEPTH_STENCIL,r.UNSIGNED_INT_24_8,null):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,r.DEPTH_COMPONENT24,t,t,0,r.DEPTH_COMPONENT,r.UNSIGNED_INT,null);return this.qo(r.TEXTURE_CUBE_MAP,null),this.Rh.push(s),s},Ei.prototype.eQ=function(t,i,e,s,n=null){this.tn(t,(t=>{e[i]=t,e.sQ++,6===e.sQ&&s(e)}),void 0,void 0,!0,((t,i)=>{n&&t&&n(t.status+" "+t.statusText,i)}))},Ei.prototype.nQ=function(t,i,e,s=null){const n=[];n.sQ=0;for(let t=0;t<6;t++)this.eQ(e[t],t,n,i,s)},Ei.prototype.rQ=function(t,i,e,s,n=null,r){const h=[];h.sQ=0;for(let o=0;o<6;o++)this.hQ(s[o],o,h,t,i,e,n,r)},Ei.prototype.hQ=function(t,i,e,s,n,r,h=null,o){const a=Vi();bi(t,(t=>{e[i]=t,e.sQ++,s&&s.removePendingData(a),6===e.sQ&&r&&r(n,e)}),((t,i)=>{s&&s.removePendingData(a),h&&h(t,i)}),s?s.offlineProvider:null,o),s&&s.addPendingData(a)},Ei.prototype.oQ=function(t,i,e){const s=this.lo;s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,i?s.LINEAR_MIPMAP_LINEAR:s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),t.samplingMode=i?3:2,i&&this.getCaps().textureMaxLevel&&void 0!==e&&e>0&&(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAX_LEVEL,e),t.Ar=e),this.qo(s.TEXTURE_CUBE_MAP,null)},Ei.prototype.createCubeTextureBase=function(t,i,e,s,n=null,r=null,h,o=null,a=!1,l=0,c=0,u=null,f=null,d=null,p=!1){const m=u||new ai(this,oi.Cube);m.isCube=!0,m.url=t,m.generateMipMaps=!s,m.lr=l,m.cr=c,m.ur=!!p&&this.po.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!s),this.mh||(m.Zn=o,m.Jn=e);const v=t;this.$h&&!u&&(t=this.$h(t));const g=t.split("?")[0],S=g.lastIndexOf("."),E=o||(S>-1?g.substring(S).toLowerCase():"");let A=null;for(const t of Ei.ya)if(t.canLoad(E)){A=t;break}const C=(u,g)=>{t===v?r&&u&&r(u.status+" "+u.statusText,g):(F.Warn(`Failed to load ${t}, falling back to the ${v}`),this.createCubeTextureBase(v,i,e,!!s,n,r,h,o,a,l,c,m,f,d,p))};if(A){const s=t=>{f&&f(m,t),A.loadCubeData(t,m,a,n,r)};e&&6===e.length?A.supportCascades?this.nQ(i,(t=>s(t.map((t=>new Uint8Array(t))))),e,r):r?r("Textures type does not support cascades."):F.Warn("Texture loader does not support cascades."):this.tn(t,(t=>s(new Uint8Array(t))),void 0,void 0,!0,C)}else{if(!e)throw new Error("Cannot load cubemap because files were not defined");this.rQ(i,m,((t,i)=>{d&&d(t,i)}),e,r)}return this.Rh.push(m),m},Ei.prototype.createCubeTexture=function(t,i,e,s,n=null,r=null,h,o=null,a=!1,l=0,c=0,u=null,f,d=!1){const p=this.lo;return this.createCubeTextureBase(t,i,e,!!s,n,r,h,o,a,l,c,u,(t=>this.qo(p.TEXTURE_CUBE_MAP,t,!0)),((t,i)=>{const e=this.needPOTTextures?Ei.GetExponentOfTwo(i[0].width,this.po.maxCubemapTextureSize):i[0].width,r=e,o=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];this.qo(p.TEXTURE_CUBE_MAP,t,!0),this.La(!1);const a=h?this.Ia(h,t.ur):t.ur?p.SRGB8_ALPHA8:p.RGBA;let l=h?this.Ia(h):p.RGBA;t.ur&&1===this.webGLVersion&&(l=a);for(let t=0;t<o.length;t++)if(i[t].width!==e||i[t].height!==r){if(this.Bo(),!this.tr||!this.ir)return void F.Warn("Cannot create canvas to resize texture.");this.tr.width=e,this.tr.height=r,this.ir.drawImage(i[t],0,0,i[t].width,i[t].height,0,0,e,r),p.texImage2D(o[t],0,a,l,p.UNSIGNED_BYTE,this.tr)}else p.texImage2D(o[t],0,a,l,p.UNSIGNED_BYTE,i[t]);s||p.generateMipmap(p.TEXTURE_CUBE_MAP),this.oQ(t,!s),t.width=e,t.height=r,t.isReady=!0,h&&(t.format=h),t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()}),!!d)},Ei.prototype.setTextureSampler=function(t,i){throw new Error("setTextureSampler: This engine does not support separate texture sampler objects!")};const xu=new h,Tu=new h;function Ru(t){if(this.aQ&&this.aQ.some((i=>{const e="\\b"+i+"\\b";return t&&(t===i||t.match(new RegExp(e,"g")))})))return t;const i=t.lastIndexOf("."),e=t.lastIndexOf("?"),s=e>-1?t.substring(e,t.length):"";return(i>-1?t.substring(0,i):t)+this.lQ+s}Object.defineProperty(Rs.prototype,"onBeforeViewRenderObservable",{get:function(){return xu}}),Object.defineProperty(Rs.prototype,"onAfterViewRenderObservable",{get:function(){return Tu}}),Object.defineProperty(Rs.prototype,"inputElement",{get:function(){return this.TY},set:function(t){var i;this.TY!==t&&(this.TY=t,null===(i=this.qd)||void 0===i||i.call(this))}}),Rs.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()},Rs.prototype.registerView=function(t,i,e){this.views||(this.views=[]);for(const i of this.views)if(i.target===t)return i;const s=this.getRenderingCanvas();s&&(t.width=s.width,t.height=s.height);const n={target:t,camera:i,clearBeforeCopy:e,enabled:!0,id:(1e5*Math.random()).toFixed()};return this.views.push(n),i&&i.onDisposeObservable.add((()=>{this.unRegisterView(t)})),n},Rs.prototype.unRegisterView=function(t){if(!this.views||0===this.views.length)return this;for(const i of this.views)if(i.target===t){const t=this.views.indexOf(i);-1!==t&&this.views.splice(t,1);break}return this},Rs.prototype.cQ=function(t){const i=t.target,e=i.getContext("2d");if(!e)return!0;const s=this.getRenderingCanvas();xu.notifyObservers(t);const n=t.camera;let r=null,h=null;if(n){if(h=n.getScene(),!h||h.activeCameras&&h.activeCameras.length)return!0;this.activeView=t,r=h.activeCamera,h.activeCamera=n}if(t.customResize)t.customResize(i);else{const t=Math.floor(i.clientWidth/this.uo),e=Math.floor(i.clientHeight/this.uo),n=t!==i.width||s.width!==i.width||e!==i.height||s.height!==i.height;i.clientWidth&&i.clientHeight&&n&&(i.width=t,i.height=e,this.setSize(t,e))}return!(!s.width||!s.height)&&(this.ox(),this.flushFramebuffer(),t.clearBeforeCopy&&e.clearRect(0,0,s.width,s.height),e.drawImage(s,0,0),r&&h&&(h.activeCamera=r),Tu.notifyObservers(t),!0)},Rs.prototype.lx=function(){if(!this.views||0===this.views.length)return!1;if(!this.getRenderingCanvas())return!1;let t;for(const i of this.views){if(!i.enabled)continue;if(i.target!==this.inputElement){if(!this.cQ(i))return!1}else t=i}return!(t&&!this.cQ(t))&&(this.activeView=null,!0)},Ei.prototype.createStorageBuffer=function(t,i){throw new Error("createStorageBuffer: Unsupported method in this engine!")},Ei.prototype.updateStorageBuffer=function(t,i,e,s){},Ei.prototype.readFromStorageBuffer=function(t,i,e,s){throw new Error("readFromStorageBuffer: Unsupported method in this engine!")},Ei.prototype.setStorageBuffer=function(t,i){throw new Error("setStorageBuffer: Unsupported method in this engine!")},Object.defineProperty(Rs.prototype,"texturesSupported",{get:function(){const t=new Array;return this.po.astc&&t.push("-astc.ktx"),this.po.s3tc&&t.push("-dxt.ktx"),this.po.pvrtc&&t.push("-pvrtc.ktx"),this.po.etc2&&t.push("-etc2.ktx"),this.po.etc1&&t.push("-etc1.ktx"),t},enumerable:!0,configurable:!0}),Object.defineProperty(Rs.prototype,"textureFormatInUse",{get:function(){return this.lQ||null},enumerable:!0,configurable:!0}),Rs.prototype.setCompressedTextureExclusions=function(t){this.aQ=t},Rs.prototype.setTextureFormatToUse=function(t){const i=this.texturesSupported;for(let e=0,s=i.length;e<s;e++)for(let s=0,n=t.length;s<n;s++)if(i[e]===t[s].toLowerCase())return this.$h=Ru.bind(this),this.lQ=i[e];return this.lQ="",this.$h=null,null};class Iu{constructor(){const t=new ArrayBuffer(Iu.DEFAULT_BUFFER_SIZE);this.uQ=new Uint32Array(t),this.fQ=new Int32Array(t),this.dQ=new Float32Array(t),this.yE=Iu.DEFAULT_BUFFER_SIZE/4,this.rA=0,this.pQ=new _native.NativeDataStream((()=>{this.mQ()}))}writeUint32(t){this.vQ(1),this.uQ[this.rA++]=t}writeInt32(t){this.vQ(1),this.fQ[this.rA++]=t}writeFloat32(t){this.vQ(1),this.dQ[this.rA++]=t}writeUint32Array(t){this.vQ(1+t.length),this.uQ[this.rA++]=t.length,this.uQ.set(t,this.rA),this.rA+=t.length}writeInt32Array(t){this.vQ(1+t.length),this.uQ[this.rA++]=t.length,this.fQ.set(t,this.rA),this.rA+=t.length}writeFloat32Array(t){this.vQ(1+t.length),this.uQ[this.rA++]=t.length,this.dQ.set(t,this.rA),this.rA+=t.length}writeNativeData(t){this.vQ(t.length),this.uQ.set(t,this.rA),this.rA+=t.length}writeBoolean(t){this.writeUint32(t?1:0)}vQ(t){this.rA+t>this.yE&&this.mQ()}mQ(){this.pQ.writeBuffer(this.uQ.buffer,this.rA),this.rA=0}}Iu.DEFAULT_BUFFER_SIZE=65536;const Mu=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],bu=[()=>1,t=>t.y,t=>t.z,t=>t.x,t=>t.x*t.y,t=>t.y*t.z,t=>3*t.z*t.z-1,t=>t.x*t.z,t=>t.x*t.x-t.y*t.y],_u=(t,i)=>Mu[t]*bu[t](i),yu=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class Nu{constructor(){this.preScaled=!1,this.l00=w.Zero(),this.l1_1=w.Zero(),this.l10=w.Zero(),this.l11=w.Zero(),this.l2_2=w.Zero(),this.l2_1=w.Zero(),this.l20=w.Zero(),this.l21=w.Zero(),this.l22=w.Zero()}addLight(t,i,e){M.Vector3[0].set(i.r,i.g,i.b);const s=M.Vector3[0],n=M.Vector3[1];s.scaleToRef(e,n),n.scaleToRef(_u(0,t),M.Vector3[2]),this.l00.addInPlace(M.Vector3[2]),n.scaleToRef(_u(1,t),M.Vector3[2]),this.l1_1.addInPlace(M.Vector3[2]),n.scaleToRef(_u(2,t),M.Vector3[2]),this.l10.addInPlace(M.Vector3[2]),n.scaleToRef(_u(3,t),M.Vector3[2]),this.l11.addInPlace(M.Vector3[2]),n.scaleToRef(_u(4,t),M.Vector3[2]),this.l2_2.addInPlace(M.Vector3[2]),n.scaleToRef(_u(5,t),M.Vector3[2]),this.l2_1.addInPlace(M.Vector3[2]),n.scaleToRef(_u(6,t),M.Vector3[2]),this.l20.addInPlace(M.Vector3[2]),n.scaleToRef(_u(7,t),M.Vector3[2]),this.l21.addInPlace(M.Vector3[2]),n.scaleToRef(_u(8,t),M.Vector3[2]),this.l22.addInPlace(M.Vector3[2])}scaleInPlace(t){this.l00.scaleInPlace(t),this.l1_1.scaleInPlace(t),this.l10.scaleInPlace(t),this.l11.scaleInPlace(t),this.l2_2.scaleInPlace(t),this.l2_1.scaleInPlace(t),this.l20.scaleInPlace(t),this.l21.scaleInPlace(t),this.l22.scaleInPlace(t)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(yu[0]),this.l1_1.scaleInPlace(yu[1]),this.l10.scaleInPlace(yu[2]),this.l11.scaleInPlace(yu[3]),this.l2_2.scaleInPlace(yu[4]),this.l2_1.scaleInPlace(yu[5]),this.l20.scaleInPlace(yu[6]),this.l21.scaleInPlace(yu[7]),this.l22.scaleInPlace(yu[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(Mu[0]),this.l1_1.scaleInPlace(Mu[1]),this.l10.scaleInPlace(Mu[2]),this.l11.scaleInPlace(Mu[3]),this.l2_2.scaleInPlace(Mu[4]),this.l2_1.scaleInPlace(Mu[5]),this.l20.scaleInPlace(Mu[6]),this.l21.scaleInPlace(Mu[7]),this.l22.scaleInPlace(Mu[8])}updateFromArray(t){return w.FromArrayToRef(t[0],0,this.l00),w.FromArrayToRef(t[1],0,this.l1_1),w.FromArrayToRef(t[2],0,this.l10),w.FromArrayToRef(t[3],0,this.l11),w.FromArrayToRef(t[4],0,this.l2_2),w.FromArrayToRef(t[5],0,this.l2_1),w.FromArrayToRef(t[6],0,this.l20),w.FromArrayToRef(t[7],0,this.l21),w.FromArrayToRef(t[8],0,this.l22),this}updateFromFloatsArray(t){return w.FromFloatsToRef(t[0],t[1],t[2],this.l00),w.FromFloatsToRef(t[3],t[4],t[5],this.l1_1),w.FromFloatsToRef(t[6],t[7],t[8],this.l10),w.FromFloatsToRef(t[9],t[10],t[11],this.l11),w.FromFloatsToRef(t[12],t[13],t[14],this.l2_2),w.FromFloatsToRef(t[15],t[16],t[17],this.l2_1),w.FromFloatsToRef(t[18],t[19],t[20],this.l20),w.FromFloatsToRef(t[21],t[22],t[23],this.l21),w.FromFloatsToRef(t[24],t[25],t[26],this.l22),this}static FromArray(t){return(new Nu).updateFromArray(t)}static FromPolynomial(t){const i=new Nu;return i.l00=t.xx.scale(.376127).add(t.yy.scale(.376127)).add(t.zz.scale(.376126)),i.l1_1=t.y.scale(.977204),i.l10=t.z.scale(.977204),i.l11=t.x.scale(.977204),i.l2_2=t.xy.scale(1.16538),i.l2_1=t.yz.scale(1.16538),i.l20=t.zz.scale(1.34567).subtract(t.xx.scale(.672834)).subtract(t.yy.scale(.672834)),i.l21=t.zx.scale(1.16538),i.l22=t.xx.scale(1.16538).subtract(t.yy.scale(1.16538)),i.l1_1.scaleInPlace(-1),i.l11.scaleInPlace(-1),i.l2_1.scaleInPlace(-1),i.l21.scaleInPlace(-1),i.scaleInPlace(Math.PI),i}}class Pu{constructor(){this.x=w.Zero(),this.y=w.Zero(),this.z=w.Zero(),this.xx=w.Zero(),this.yy=w.Zero(),this.zz=w.Zero(),this.xy=w.Zero(),this.yz=w.Zero(),this.zx=w.Zero()}get preScaledHarmonics(){return this.gQ||(this.gQ=Nu.FromPolynomial(this)),this.gQ.preScaled||this.gQ.preScaleForRendering(),this.gQ}addAmbient(t){M.Vector3[0].copyFromFloats(t.r,t.g,t.b);const i=M.Vector3[0];this.xx.addInPlace(i),this.yy.addInPlace(i),this.zz.addInPlace(i)}scaleInPlace(t){this.x.scaleInPlace(t),this.y.scaleInPlace(t),this.z.scaleInPlace(t),this.xx.scaleInPlace(t),this.yy.scaleInPlace(t),this.zz.scaleInPlace(t),this.yz.scaleInPlace(t),this.zx.scaleInPlace(t),this.xy.scaleInPlace(t)}updateFromHarmonics(t){return this.gQ=t,this.x.copyFrom(t.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(t.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(t.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(t.l00),M.Vector3[0].copyFrom(t.l20).scaleInPlace(.247708),M.Vector3[1].copyFrom(t.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(M.Vector3[0]).addInPlace(M.Vector3[1]),this.yy.copyFrom(t.l00),this.yy.scaleInPlace(.886277).subtractInPlace(M.Vector3[0]).subtractInPlace(M.Vector3[1]),this.zz.copyFrom(t.l00),M.Vector3[0].copyFrom(t.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(M.Vector3[0]),this.yz.copyFrom(t.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(t.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(t.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(t){return(new Pu).updateFromHarmonics(t)}static FromArray(t){const i=new Pu;return w.FromArrayToRef(t[0],0,i.x),w.FromArrayToRef(t[1],0,i.y),w.FromArrayToRef(t[2],0,i.z),w.FromArrayToRef(t[3],0,i.xx),w.FromArrayToRef(t[4],0,i.yy),w.FromArrayToRef(t[5],0,i.zz),w.FromArrayToRef(t[6],0,i.yz),w.FromArrayToRef(t[7],0,i.zx),w.FromArrayToRef(t[8],0,i.xy),i}}const Du="rgbdDecodePixelShader",Lu="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);\n}";ii.ShadersStore[Du]=Lu;function Ou(t,i,e,s,n,r){const h=i.getEngine();return i.isReady=!1,n=null!=n?n:i.samplingMode,s=null!=s?s:i.type,r=null!=r?r:i.format,-1===s&&(s=0),new Promise((o=>{const a=new nr("postprocess",t,null,null,1,null,n,h,!1,void 0,s,void 0,null,!1,r);a.externalTextureSamplerBinding=!0;const l=h.createRenderTargetTexture({width:i.width,height:i.height},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:n,type:s,format:r});a.getEffect().executeWhenCompiled((()=>{a.onApply=t=>{t.fn("textureSampler",i),t.setFloat2("scale",1,1)},e.postProcessManager.directRender([a],l,!0),h.restoreDefaultFramebuffer(),h.Nr(i),a&&a.dispose(),l._r(i),i.type=s,i.format=5,i.isReady=!0,o(i)}))}))}let Fu,Bu;function Uu(t){Fu||(Fu=new Float32Array(1),Bu=new Int32Array(Fu.buffer)),Fu[0]=t;const i=Bu[0];let e=i>>16&32768,s=i>>12&2047;const n=i>>23&255;return n<103?e:n>142?(e|=31744,e|=(255==n?0:1)&&8388607&i,e):n<113?(s|=2048,e|=(s>>114-n)+(s>>113-n&1),e):(e|=n-112<<10|s>>1,e+=1&s,e)}function Vu(t){const i=(32768&t)>>15,e=(31744&t)>>10,s=1023&t;return 0===e?(i?-1:1)*Math.pow(2,-14)*(s/Math.pow(2,10)):31==e?s?NaN:1/0*(i?-1:1):(i?-1:1)*Math.pow(2,e-15)*(1+s/Math.pow(2,10))}class ku{static ExpandRGBDTexture(t){const i=t.Lb;if(!i||!t.isRGBD)return;const e=i.getEngine(),s=e.getCaps(),n=i.isReady;let r=!1;s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?(r=!0,i.type=2):s.textureFloatRender&&s.textureFloatLinearFiltering&&(r=!0,i.type=1),r&&(i.isReady=!1,i.vr=!1,i.invertY=!1);const h=()=>{if(r){const s=new nr("rgbdDecode","rgbdDecode",null,null,1,null,3,e,!1,void 0,i.type,void 0,null,!1);s.externalTextureSamplerBinding=!0;const n=e.createRenderTargetTexture(i.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:i.samplingMode,type:i.type,format:5});s.getEffect().executeWhenCompiled((()=>{s.onApply=t=>{t.fn("textureSampler",i),t.setFloat2("scale",1,1)},t.getScene().postProcessManager.directRender([s],n,!0),e.restoreDefaultFramebuffer(),e.Nr(i),s&&s.dispose(),n._r(i),i.isReady=!0}))}};n?h():t.onLoadObservable.addOnce(h)}static EncodeTextureToRGBD(t,i,e=0){return Ou("rgbdEncode",t,i,e,1,5)}}class Gu{constructor(t,i,e,s){this.name=t,this.worldAxisForNormal=i,this.worldAxisForFileX=e,this.worldAxisForFileY=s}}class zu{static ConvertCubeMapTextureToSphericalPolynomial(t){var i;if(!t.isCube)return null;null===(i=t.getScene())||void 0===i||i.getEngine().flushFramebuffer();const e=t.getSize().width,s=t.readPixels(0,void 0,void 0,!1),n=t.readPixels(1,void 0,void 0,!1);let r,h;t.isRenderTarget?(r=t.readPixels(3,void 0,void 0,!1),h=t.readPixels(2,void 0,void 0,!1)):(r=t.readPixels(2,void 0,void 0,!1),h=t.readPixels(3,void 0,void 0,!1));const o=t.readPixels(4,void 0,void 0,!1),a=t.readPixels(5,void 0,void 0,!1),l=t.gammaSpace;let c=0;return 1!=t.textureType&&2!=t.textureType||(c=1),new Promise((t=>{Promise.all([n,s,r,h,o,a]).then((([i,s,n,r,h,o])=>{const a={size:e,right:s,left:i,up:n,down:r,front:h,back:o,format:5,type:c,gammaSpace:l};t(this.ConvertCubeMapToSphericalPolynomial(a))}))}))}static SQ(t,i){return Math.atan2(t*i,Math.sqrt(t*t+i*i+1))}static ConvertCubeMapToSphericalPolynomial(t){const i=new Nu;let e=0;const s=2/t.size,n=s,r=.5*s,h=r-1;for(let a=0;a<6;a++){const c=this.EQ[a],u=t[c.name];let f=h;const d=5===t.format?4:3;for(let a=0;a<t.size;a++){let p=h;for(let n=0;n<t.size;n++){const h=c.worldAxisForFileX.scale(p).add(c.worldAxisForFileY.scale(f)).add(c.worldAxisForNormal);h.normalize();const m=this.SQ(p-r,f-r)-this.SQ(p-r,f+r)-this.SQ(p+r,f-r)+this.SQ(p+r,f+r);let v=u[a*t.size*d+n*d+0],g=u[a*t.size*d+n*d+1],S=u[a*t.size*d+n*d+2];isNaN(v)&&(v=0),isNaN(g)&&(g=0),isNaN(S)&&(S=0),0===t.type&&(v/=255,g/=255,S/=255),t.gammaSpace&&(v=Math.pow(o.Clamp(v),l),g=Math.pow(o.Clamp(g),l),S=Math.pow(o.Clamp(S),l));const E=4096;v=o.Clamp(v,0,E),g=o.Clamp(g,0,E),S=o.Clamp(S,0,E);const A=new _(v,g,S);i.addLight(h,A,m),e+=m,p+=s}f+=n}}const a=6*(4*Math.PI)/6/e;return i.scaleInPlace(a),i.convertIncidentRadianceToIrradiance(),i.convertIrradianceToLambertianRadiance(),Pu.FromHarmonics(i)}}zu.EQ=[new Gu("right",new w(1,0,0),new w(0,0,-1),new w(0,-1,0)),new Gu("left",new w(-1,0,0),new w(0,0,1),new w(0,-1,0)),new Gu("up",new w(0,1,0),new w(1,0,0),new w(0,0,1)),new Gu("down",new w(0,-1,0),new w(1,0,0),new w(0,0,-1)),new Gu("front",new w(0,0,1),new w(1,0,0),new w(0,-1,0)),new Gu("back",new w(0,0,-1),new w(-1,0,0),new w(0,-1,0))],nn.prototype.forceSphericalPolynomialsRecompute=function(){this.Lb&&(this.Lb.rr=null,this.Lb.hr=null,this.Lb.ar=!1)},Object.defineProperty(nn.prototype,"sphericalPolynomial",{get:function(){if(this.Lb){if(this.Lb.rr||this.Lb.ar)return this.Lb.rr;if(this.Lb.isReady)return this.Lb.hr||(this.Lb.hr=zu.ConvertCubeMapTextureToSphericalPolynomial(this),null===this.Lb.hr?this.Lb.ar=!0:this.Lb.hr.then((t=>{this.Lb.rr=t,this.Lb.ar=!0}))),null}return null},set:function(t){this.Lb&&(this.Lb.rr=t)},enumerable:!0,configurable:!0});const Hu="rgbdEncodePixelShader",Xu="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);\n}";ii.ShadersStore[Hu]=Xu;const Wu="image/png",$u=[134,22,135,150,246,214,150,54];function Yu(t){const i=new DataView(t.buffer,t.byteOffset,t.byteLength);let e=0;for(let t=0;t<$u.length;t++)if(i.getUint8(e++)!==$u[t])return F.Error("Not a babylon environment map"),null;let s="",n=0;for(;n=i.getUint8(e++);)s+=String.fromCharCode(n);let r=JSON.parse(s);return r=ju(r),r.specular&&(r.specular.specularDataPosition=e,r.specular.lodGenerationScale=r.specular.lodGenerationScale||.8),r}function ju(t){if(t.version>2)throw new Error(`Unsupported babylon environment map version "${t.version}". Latest supported version is "2".`);return 2===t.version?t:t={...t,version:2,imageType:Wu}}function Ku(t,i){const e=(i=ju(i)).specular;let s=o.Log2(i.width);if(s=Math.round(s)+1,e.mipmaps.length!==6*s)throw new Error(`Unsupported specular mipmaps number "${e.mipmaps.length}"`);const n=new Array(s);for(let i=0;i<s;i++){n[i]=new Array(6);for(let s=0;s<6;s++){const r=e.mipmaps[6*i+s];n[i][s]=new Uint8Array(t.buffer,t.byteOffset+e.specularDataPosition+r.position,r.length)}}return n}function qu(t,i,e){const s=(e=ju(e)).specular;if(!s)return Promise.resolve();t.lr=s.lodGenerationScale;return Zu(t,Ku(i,e),e.imageType)}function Qu(t,i,e,s,n,r,h,o,a,l,c){return new Promise(((u,f)=>{if(e){const e=i.createTexture(null,!0,!0,null,1,null,(t=>{f(t)}),t);s.getEffect().executeWhenCompiled((()=>{s.externalTextureSamplerBinding=!0,s.onApply=s=>{s.fn("textureSampler",e),s.setFloat2("scale",1,i.hs.needsInvertingBitmap&&t instanceof ImageBitmap?-1:1)},i.scenes.length&&(i.scenes[0].postProcessManager.directRender([s],l,!0,r,h),i.restoreDefaultFramebuffer(),e.dispose(),URL.revokeObjectURL(n),u())}))}else{if(i.Ex(c,t,r,h),o){const e=a[h];e&&i.Ex(e.Lb,t,r,0)}u()}}))}function Zu(t,i,e=Wu){if(!ki.IsExponentOfTwo(t.width))throw new Error("Texture size must be a power of two");const s=o.ILog2(t.width)+1,n=t.getEngine();let r=!1,h=!1,a=null,l=null,c=null;const u=n.getCaps();if(t.format=5,t.type=0,t.generateMipMaps=!0,t.zn=null,n.updateTextureSamplingMode(3,t),u.textureLOD?n.hs.supportRenderAndCopyToLodForFloatTextures?u.textureHalfFloatRender&&u.textureHalfFloatLinearFiltering?(r=!0,t.type=2):u.textureFloatRender&&u.textureFloatLinearFiltering&&(r=!0,t.type=1):r=!1:(r=!1,h=!0,c={}),r)a=new nr("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,t.type,void 0,null,!1),t.vr=!1,t.invertY=!1,l=n.createRenderTargetCubeTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:t.type,format:5});else if(t.vr=!0,t.invertY=!0,h){const i=3,e=t.lr,r=t.cr;for(let h=0;h<i;h++){const o=(s-1)*e+r,a=r+(o-r)*(1-h/(i-1)),l=Math.round(Math.min(Math.max(a,0),o)),u=new ai(n,oi.Temp);u.isCube=!0,u.invertY=!0,u.generateMipMaps=!1,n.updateTextureSamplingMode(2,u);const f=new nn(null);switch(f.Xb=!0,f.Lb=u,c[l]=f,h){case 0:t.mr=f;break;case 1:t.pr=f;break;case 2:t.dr=f}}}const f=[];for(let s=0;s<i.length;s++)for(let o=0;o<6;o++){const u=i[s][o],d=new Blob([u],{type:e}),p=URL.createObjectURL(d);let m;if("undefined"==typeof Image||n.hs.forceBitmapOverHTMLImageElement)m=n.createImageBitmap(d,{premultiplyAlpha:"none"}).then((i=>Qu(i,n,r,a,p,o,s,h,c,l,t)));else{const i=new Image;i.src=p,m=new Promise(((e,u)=>{i.onload=()=>{Qu(i,n,r,a,p,o,s,h,c,l,t).then((()=>e())).catch((t=>{u(t)}))},i.onerror=t=>{u(t)}}))}f.push(m)}if(i.length<s){let e;const r=Math.pow(2,s-1-i.length),h=r*r*4;switch(t.type){case 0:e=new Uint8Array(h);break;case 2:e=new Uint16Array(h);break;case 1:e=new Float32Array(h)}for(let r=i.length;r<s;r++)for(let i=0;i<6;i++)n.za(t,e,i,r)}return Promise.all(f).then((()=>{l&&(n.Nr(t),l._r(t)),a&&a.dispose(),h&&(t.dr&&t.dr.Lb&&(t.dr.Lb.isReady=!0),t.pr&&t.pr.Lb&&(t.pr.Lb.isReady=!0),t.mr&&t.mr.Lb&&(t.mr.Lb.isReady=!0))}))}function Ju(t,i){const e=(i=ju(i)).irradiance;if(!e)return;const s=new Pu;w.FromArrayToRef(e.x,0,s.x),w.FromArrayToRef(e.y,0,s.y),w.FromArrayToRef(e.z,0,s.z),w.FromArrayToRef(e.xx,0,s.xx),w.FromArrayToRef(e.yy,0,s.yy),w.FromArrayToRef(e.zz,0,s.zz),w.FromArrayToRef(e.yz,0,s.yz),w.FromArrayToRef(e.zx,0,s.zx),w.FromArrayToRef(e.xy,0,s.xy),t.rr=s}function tf(t,i,e,s){let n=s,r=0,h="";for(;n<e.length;){const s=e.charAt(n);if(h)s===h?'"'===h||"'"===h?"\\"!==e.charAt(n-1)&&(h=""):h="":"*/"===h&&"*"===s&&n+1<e.length&&("/"===e.charAt(n+1)&&(h=""),""===h&&n++);else switch(s){case t:r++;break;case i:r--;break;case'"':case"'":case"`":h=s;break;case"/":if(n+1<e.length){const t=e.charAt(n+1);"/"===t?h="\n":"*"===t&&(h="*/")}}if(n++,0===r)break}return 0===r?n-1:-1}function ef(t,i){for(;i<t.length;){const e=t[i];if(" "!==e&&"\n"!==e&&"\r"!==e&&"\t"!==e&&"\n"!==e&&" "!==e)break;i++}return i}function sf(t){const i=t.charCodeAt(0);return i>=48&&i<=57||i>=65&&i<=90||i>=97&&i<=122||95==i}function nf(t){let i=0,e="",s=!1;const n=[];for(;i<t.length;){const r=t.charAt(i);if(e)r===e?'"'===e||"'"===e?("\\"!==t.charAt(i-1)&&(e=""),n.push(r)):(e="",s=!1):"*/"===e&&"*"===r&&i+1<t.length?("/"===t.charAt(i+1)&&(e=""),""===e&&(s=!1,i++)):s||n.push(r);else{switch(r){case'"':case"'":case"`":e=r;break;case"/":if(i+1<t.length){const n=t.charAt(i+1);"/"===n?(e="\n",s=!0):"*"===n&&(e="*/",s=!0)}}s||n.push(r)}i++}return n.join("")}function rf(t,i,e){for(;i>=0&&t.charAt(i)!==e;)i--;return i}class hf{constructor(t,i=20){this.debug=!1,this.AQ=t,this.CQ=i,this.wQ=[],this.inlineToken="#define inline"}get code(){return this.AQ}processCode(){this.debug&&console.log(`Start inlining process (code size=${this.AQ.length})...`),this.xQ(),this.TQ(this.CQ),this.debug&&console.log("End of inlining process.")}xQ(){let t=0;for(;t<this.AQ.length;){const i=this.AQ.indexOf(this.inlineToken,t);if(i<0)break;const e=this.AQ.indexOf("(",i+this.inlineToken.length);if(e<0){this.debug&&console.warn(`Could not find the opening parenthesis after the token. startIndex=${t}`),t=i+this.inlineToken.length;continue}const s=hf.RQ.exec(this.AQ.substring(i+this.inlineToken.length,e));if(!s){this.debug&&console.warn(`Could not extract the name/type of the function from: ${this.AQ.substring(i+this.inlineToken.length,e)}`),t=i+this.inlineToken.length;continue}const[n,r]=[s[3],s[4]],h=tf("(",")",this.AQ,e);if(h<0){this.debug&&console.warn(`Could not extract the parameters the function '${r}' (type=${n}). funcParamsStartIndex=${e}`),t=i+this.inlineToken.length;continue}const o=this.AQ.substring(e+1,h),a=ef(this.AQ,h+1);if(a===this.AQ.length){this.debug&&console.warn(`Could not extract the body of the function '${r}' (type=${n}). funcParamsEndIndex=${h}`),t=i+this.inlineToken.length;continue}const l=tf("{","}",this.AQ,a);if(l<0){this.debug&&console.warn(`Could not extract the body of the function '${r}' (type=${n}). funcBodyStartIndex=${a}`),t=i+this.inlineToken.length;continue}const c=this.AQ.substring(a,l+1),u=nf(o).split(","),f=[];for(let t=0;t<u.length;++t){const i=u[t].trim(),e=i.lastIndexOf(" ");e>=0&&f.push(i.substring(e+1))}"void"!==n&&f.push("return"),this.wQ.push({name:r,type:n,parameters:f,body:c,callIndex:0}),t=l+1;const d=i>0?this.AQ.substring(0,i):"",p=l+1<this.AQ.length-1?this.AQ.substring(l+1):"";this.AQ=d+p,t-=l+1-i}this.debug&&console.log(`Collect functions: ${this.wQ.length} functions found. functionDescr=`,this.wQ)}TQ(t=20){for(;t-- >=0&&this.IQ(););return this.debug&&console.log(`numMaxIterations is ${t} after inlining process`),t>=0}IQ(){let t=!1;for(const i of this.wQ){const{name:e,type:s,parameters:n,body:r}=i;let h=0;for(;h<this.AQ.length;){const o=this.AQ.indexOf(e,h);if(o<0)break;if(0===o||sf(this.AQ.charAt(o-1))){h=o+e.length;continue}const a=ef(this.AQ,o+e.length);if(a===this.AQ.length||"("!==this.AQ.charAt(a)){h=o+e.length;continue}const l=tf("(",")",this.AQ,a);if(l<0){this.debug&&console.warn(`Could not extract the parameters of the function call. Function '${e}' (type=${s}). callParamsStartIndex=${a}`),h=o+e.length;continue}const c=this.AQ.substring(a+1,l),u=t=>{const i=[];let e=0,s=0;for(;e<t.length;){if("("===t.charAt(e)){const i=tf("(",")",t,e);if(i<0)return null;e=i}else","===t.charAt(e)&&(i.push(t.substring(s,e)),s=e+1);e++}return s<e&&i.push(t.substring(s,e)),i},f=u(nf(c));if(null===f){this.debug&&console.warn(`Invalid function call: can't extract the parameters of the function call. Function '${e}' (type=${s}). callParamsStartIndex=${a}, callParams=`+c),h=o+e.length;continue}const d=[];for(let t=0;t<f.length;++t){const i=f[t].trim();d.push(i)}const p="void"!==s?e+"_"+i.callIndex++:null;if(p&&d.push(p+" ="),d.length!==n.length){this.debug&&console.warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${e}' (type=${s}). function parameters=${n}, call parameters=${d}`),h=o+e.length;continue}h=l+1;const m=this.MQ(r,n,d);let v=o>0?this.AQ.substring(0,o):"";const g=l+1<this.AQ.length-1?this.AQ.substring(l+1):"";if(p){const t=rf(this.AQ,o-1,"\n");v=this.AQ.substring(0,t+1);const i=this.AQ.substring(t+1,o);this.AQ=v+s+" "+p+";\n"+m+"\n"+i+p+g,this.debug&&console.log(`Replace function call by code. Function '${e}' (type=${s}). injectDeclarationIndex=${t}, call parameters=${d}`)}else this.AQ=v+m+g,h+=m.length-(l+1-o),this.debug&&console.log(`Replace function call by code. Function '${e}' (type=${s}). functionCallIndex=${o}, call parameters=${d}`);t=!0}}return t}MQ(t,i,e){for(let s=0;s<i.length;++s){const n=new RegExp(i[s].replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),r=i[s].length,h=e[s];t=t.replace(n,((e,...n)=>{const o=n[0];return sf(t.charAt(o-1))||sf(t.charAt(o+r))?i[s]:h}))}return t}}hf.RQ=/((\s+?)(\w+)\s+(\w+)\s*?)$/;class of{constructor(t){this.isAsync=!1,this.isReady=!1,this.Pr={},this.Ls=t}en(){return null}sn(){return null}rn(t){throw new Error("Not implemented")}ln(t,i,e,s,n,r,h,o){const a=this.Ls;if(a.supportsUniformBuffers)for(const e in i)t.bindUniformBlock(e,i[e]);let l;for(this.Ls.getUniforms(this,e).forEach(((t,i)=>{s[e[i]]=t})),this.Cs=s,l=0;l<n.length;l++){null==t.getUniform(n[l])&&(n.splice(l,1),l--)}n.forEach(((t,i)=>{r[t]=i})),o.push(...a.getAttributes(this,h))}dispose(){this.Cs={}}Lr(t,i){const e=this.Pr[t],s=i.updateFlag;return(void 0===e||e!==s)&&(this.Pr[t]=s,!0)}Br(t,i,e){let s=this.Pr[t];if(!s)return s=[i,e],this.Pr[t]=s,!0;let n=!1;return s[0]!==i&&(s[0]=i,n=!0),s[1]!==e&&(s[1]=e,n=!0),n}Ur(t,i,e,s){let n=this.Pr[t];if(!n)return n=[i,e,s],this.Pr[t]=n,!0;let r=!1;return n[0]!==i&&(n[0]=i,r=!0),n[1]!==e&&(n[1]=e,r=!0),n[2]!==s&&(n[2]=s,r=!0),r}Vr(t,i,e,s,n){let r=this.Pr[t];if(!r)return r=[i,e,s,n],this.Pr[t]=r,!0;let h=!1;return r[0]!==i&&(r[0]=i,h=!0),r[1]!==e&&(r[1]=e,h=!0),r[2]!==s&&(r[2]=s,h=!0),r[3]!==n&&(r[3]=n,h=!0),h}setInt(t,i){const e=this.Pr[t];void 0!==e&&e===i||this.Ls.setInt(this.Cs[t],i)&&(this.Pr[t]=i)}setInt2(t,i,e){this.Br(t,i,e)&&(this.Ls.setInt2(this.Cs[t],i,e)||(this.Pr[t]=null))}setInt3(t,i,e,s){this.Ur(t,i,e,s)&&(this.Ls.setInt3(this.Cs[t],i,e,s)||(this.Pr[t]=null))}setInt4(t,i,e,s,n){this.Vr(t,i,e,s,n)&&(this.Ls.setInt4(this.Cs[t],i,e,s,n)||(this.Pr[t]=null))}setIntArray(t,i){this.Pr[t]=null,this.Ls.setIntArray(this.Cs[t],i)}setIntArray2(t,i){this.Pr[t]=null,this.Ls.setIntArray2(this.Cs[t],i)}setIntArray3(t,i){this.Pr[t]=null,this.Ls.setIntArray3(this.Cs[t],i)}setIntArray4(t,i){this.Pr[t]=null,this.Ls.setIntArray4(this.Cs[t],i)}setUInt(t,i){const e=this.Pr[t];void 0!==e&&e===i||this.Ls.setUInt(this.Cs[t],i)&&(this.Pr[t]=i)}setUInt2(t,i,e){this.Br(t,i,e)&&(this.Ls.setUInt2(this.Cs[t],i,e)||(this.Pr[t]=null))}setUInt3(t,i,e,s){this.Ur(t,i,e,s)&&(this.Ls.setUInt3(this.Cs[t],i,e,s)||(this.Pr[t]=null))}setUInt4(t,i,e,s,n){this.Vr(t,i,e,s,n)&&(this.Ls.setUInt4(this.Cs[t],i,e,s,n)||(this.Pr[t]=null))}setUIntArray(t,i){this.Pr[t]=null,this.Ls.setUIntArray(this.Cs[t],i)}setUIntArray2(t,i){this.Pr[t]=null,this.Ls.setUIntArray2(this.Cs[t],i)}setUIntArray3(t,i){this.Pr[t]=null,this.Ls.setUIntArray3(this.Cs[t],i)}setUIntArray4(t,i){this.Pr[t]=null,this.Ls.setUIntArray4(this.Cs[t],i)}setFloatArray(t,i){this.Pr[t]=null,this.Ls.setFloatArray(this.Cs[t],i)}setFloatArray2(t,i){this.Pr[t]=null,this.Ls.setFloatArray2(this.Cs[t],i)}setFloatArray3(t,i){this.Pr[t]=null,this.Ls.setFloatArray3(this.Cs[t],i)}setFloatArray4(t,i){this.Pr[t]=null,this.Ls.setFloatArray4(this.Cs[t],i)}setArray(t,i){this.Pr[t]=null,this.Ls.setArray(this.Cs[t],i)}setArray2(t,i){this.Pr[t]=null,this.Ls.setArray2(this.Cs[t],i)}setArray3(t,i){this.Pr[t]=null,this.Ls.setArray3(this.Cs[t],i)}setArray4(t,i){this.Pr[t]=null,this.Ls.setArray4(this.Cs[t],i)}setMatrices(t,i){i&&(this.Pr[t]=null,this.Ls.setMatrices(this.Cs[t],i))}setMatrix(t,i){this.Lr(t,i)&&(this.Ls.setMatrices(this.Cs[t],i.toArray())||(this.Pr[t]=null))}setMatrix3x3(t,i){this.Pr[t]=null,this.Ls.setMatrix3x3(this.Cs[t],i)}setMatrix2x2(t,i){this.Pr[t]=null,this.Ls.setMatrix2x2(this.Cs[t],i)}setFloat(t,i){const e=this.Pr[t];void 0!==e&&e===i||this.Ls.setFloat(this.Cs[t],i)&&(this.Pr[t]=i)}setBool(t,i){const e=this.Pr[t];void 0!==e&&e===i||this.Ls.setInt(this.Cs[t],i?1:0)&&(this.Pr[t]=i?1:0)}setVector2(t,i){this.Br(t,i.x,i.y)&&(this.Ls.setFloat2(this.Cs[t],i.x,i.y)||(this.Pr[t]=null))}setFloat2(t,i,e){this.Br(t,i,e)&&(this.Ls.setFloat2(this.Cs[t],i,e)||(this.Pr[t]=null))}setVector3(t,i){this.Ur(t,i.x,i.y,i.z)&&(this.Ls.setFloat3(this.Cs[t],i.x,i.y,i.z)||(this.Pr[t]=null))}setFloat3(t,i,e,s){this.Ur(t,i,e,s)&&(this.Ls.setFloat3(this.Cs[t],i,e,s)||(this.Pr[t]=null))}setVector4(t,i){this.Vr(t,i.x,i.y,i.z,i.w)&&(this.Ls.setFloat4(this.Cs[t],i.x,i.y,i.z,i.w)||(this.Pr[t]=null))}setQuaternion(t,i){this.Vr(t,i.x,i.y,i.z,i.w)&&(this.Ls.setFloat4(this.Cs[t],i.x,i.y,i.z,i.w)||(this.Pr[t]=null))}setFloat4(t,i,e,s,n){this.Vr(t,i,e,s,n)&&(this.Ls.setFloat4(this.Cs[t],i,e,s,n)||(this.Pr[t]=null))}setColor3(t,i){this.Ur(t,i.r,i.g,i.b)&&(this.Ls.setFloat3(this.Cs[t],i.r,i.g,i.b)||(this.Pr[t]=null))}setColor4(t,i,e){this.Vr(t,i.r,i.g,i.b,e)&&(this.Ls.setFloat4(this.Cs[t],i.r,i.g,i.b,e)||(this.Pr[t]=null))}setDirectColor4(t,i){this.Vr(t,i.r,i.g,i.b,i.a)&&(this.Ls.setFloat4(this.Cs[t],i.r,i.g,i.b,i.a)||(this.Pr[t]=null))}}class af extends er{constructor(t,i,e,s){super(t,i,e,s),this.bQ=null,this._Q=null,this.Ls=s}get $o(){return this.bQ}set $o(t){this.bQ&&this.Ls.yQ(this.bQ),this.bQ=t}get NQ(){return this._Q}set NQ(t){this._Q&&this.Ls.yQ(this._Q),this._Q=t}dispose(t=!1){this.$o=null,this.NQ=null,super.dispose(t)}}class lf{constructor(t,i){this.Ls=i,this.set(t)}get underlyingResource(){return this.PQ}setUsage(){}set(t){this.PQ=t}reset(){this.PQ=null}release(){this.PQ&&this.Ls.deleteTexture(this.PQ),this.reset()}}const cf=new h;if("undefined"!=typeof self&&!Object.prototype.hasOwnProperty.call(self,"_native")){let t;Object.defineProperty(self,"DQ",{get:()=>t,set:i=>{t=i,t&&cf.notifyObservers(t)}})}class uf extends ui{}class ff{constructor(t){this.Ls=t,this.LQ=new Array,this.OQ=!1,this.FQ=df.BQ(),this.Ls.setCommandDataStream(this.FQ)}beginCommandScope(){if(this.OQ)throw new Error("Command scope already active.");this.OQ=!0}endCommandScope(){if(!this.OQ)throw new Error("Command scope is not active.");this.OQ=!1,this.UQ()}startEncodingCommand(t){this.FQ.writeNativeData(t)}encodeCommandArgAsUInt32(t){this.FQ.writeUint32(t)}encodeCommandArgAsUInt32s(t){this.FQ.writeUint32Array(t)}encodeCommandArgAsInt32(t){this.FQ.writeInt32(t)}encodeCommandArgAsInt32s(t){this.FQ.writeInt32Array(t)}encodeCommandArgAsFloat32(t){this.FQ.writeFloat32(t)}encodeCommandArgAsFloat32s(t){this.FQ.writeFloat32Array(t)}encodeCommandArgAsNativeData(t){this.FQ.writeNativeData(t),this.LQ.push(t)}finishEncodingCommand(){this.OQ||this.UQ()}UQ(){this.Ls.submitCommands(),this.LQ.length=0}}class df extends Rs{constructor(t={}){if(super(null,!1,void 0,t.adaptToDeviceRatio),this.Ls=new _native.Engine,this.JD=_native.Camera?new _native.Camera:null,this.VQ=new ff(this.Ls),this.kQ=null,this.GQ=_native.Engine.DEPTH_TEST_LEQUAL,this.zQ=!1,this.HQ=255,this.XQ=519,this.WQ=0,this.$Q=255,this.YQ=7680,this.jQ=7680,this.KQ=7681,this.wn=0,this.xn=0,this.qQ=!0,_native.Engine.PROTOCOL_VERSION!==df.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${df.PROTOCOL_VERSION} (JS)`);this.hh=2,this.disableUniformBuffers=!0,this.co="NATIVE",this.po={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!0,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:1,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS},this.hs={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,Fo:!1},ki.Log("Babylon Native (v"+Rs.Version+") launched"),ki.LoadScript=function(t,i,e,s){ki.LoadFile(t,(t=>{Function(t).apply(null),i&&i()}),void 0,void 0,!1,((t,i)=>{e&&e("LoadScript Error",i)}))},"undefined"==typeof URL&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),"undefined"==typeof Blob&&(window.Blob=function(t){return t}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function t(){const i=isNaN(arguments[0])?1:Number(arguments[0]);return i?Array.prototype.reduce.call(this,(function(e,s){return Array.isArray(s)?e.push.apply(e,t.call(s,i-1)):e.push(s),e}),[]):Array.prototype.slice.call(this)},writable:!0});const i=window&&window.devicePixelRatio||1;this.uo=t.adaptToDeviceRatio?i:1,this.resize();const e=this.getDepthFunction();e&&this.setDepthFunction(e),this.mo=new ci,this.onNewSceneAddedObservable.add((t=>{const i=t.render;t.render=(...e)=>{this.VQ.beginCommandScope(),i.apply(t,e),this.VQ.endCommandScope()}}))}getHardwareScalingLevel(){return this.Ls.getHardwareScalingLevel()}setHardwareScalingLevel(t){this.Ls.setHardwareScalingLevel(t)}dispose(){super.dispose(),this.kQ&&this.QQ(this.kQ),this.Ls.dispose()}static BQ(){return new Iu}ko(t,i){return i.requestAnimationFrame&&i!==window?i.requestAnimationFrame(t):this.Ls.requestAnimationFrame(t),0}Xo(t){this.Lh!==t&&(this.Lh&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this.VQ.encodeCommandArgAsNativeData(this.Lh),this.VQ.finishEncodingCommand()),t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.finishEncodingCommand()),this.Lh=t)}getHostDocument(){return null}clear(t,i,e,s=!1){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this.VQ.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this.VQ.encodeCommandArgAsUInt32(i&&t?1:0),this.VQ.encodeCommandArgAsFloat32(t?t.r:0),this.VQ.encodeCommandArgAsFloat32(t?t.g:0),this.VQ.encodeCommandArgAsFloat32(t?t.b:0),this.VQ.encodeCommandArgAsFloat32(t?t.a:1),this.VQ.encodeCommandArgAsUInt32(e?1:0),this.VQ.encodeCommandArgAsFloat32(1),this.VQ.encodeCommandArgAsUInt32(s?1:0),this.VQ.encodeCommandArgAsUInt32(0),this.VQ.finishEncodingCommand()}createIndexBuffer(t,i){const e=this.ea(t),s=new uf;return s.references=1,s.is32Bits=4===e.BYTES_PER_ELEMENT,e.byteLength&&(s.nativeIndexBuffer=this.Ls.createIndexBuffer(e.buffer,e.byteOffset,e.byteLength,s.is32Bits,null!=i&&i)),s}createVertexBuffer(t,i){const e=ArrayBuffer.isView(t)?t:new Float32Array(t),s=new uf;return s.references=1,e.byteLength&&(s.nativeVertexBuffer=this.Ls.createVertexBuffer(e.buffer,e.byteOffset,e.byteLength,null!=i&&i)),s}ZQ(t,i,e,s,n){e&&this.Ls.recordIndexBuffer(t,e.nativeIndexBuffer);const r=s.getAttributesNames();for(let e=0;e<r.length;e++){const h=s.getAttributeLocation(e);if(h>=0){const s=r[e];let o=null;if(n&&(o=n[s]),o||(o=i[s]),o){const i=o.getBuffer();i&&i.nativeVertexBuffer&&this.Ls.recordVertexBuffer(t,i.nativeVertexBuffer,h,o.byteOffset,o.byteStride,o.getSize(),this.JQ(o.type),o.normalized,o.getInstanceDivisor())}}}}bindBuffers(t,i,e){this.kQ&&this.QQ(this.kQ),this.kQ=this.Ls.createVertexArray(),this.ZQ(this.kQ,t,i,e),this.bindVertexArrayObject(this.kQ)}recordVertexArrayObject(t,i,e,s){const n=this.Ls.createVertexArray();return this.ZQ(n,t,i,e,s),n}QQ(t){this.VQ.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.finishEncodingCommand()}bindVertexArrayObject(t){this.VQ.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.finishEncodingCommand()}releaseVertexArrayObject(t){this.QQ(t)}getAttributes(t,i){const e=t;return this.Ls.getAttributes(e.nativeProgram,i)}drawElementsType(t,i,e,s){this.Iw.addCount(1,!1),this.VQ.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this.VQ.encodeCommandArgAsUInt32(t),this.VQ.encodeCommandArgAsUInt32(i),this.VQ.encodeCommandArgAsUInt32(e),this.VQ.finishEncodingCommand()}drawArraysType(t,i,e,s){this.Iw.addCount(1,!1),this.VQ.startEncodingCommand(_native.Engine.COMMAND_DRAW),this.VQ.encodeCommandArgAsUInt32(t),this.VQ.encodeCommandArgAsUInt32(i),this.VQ.encodeCommandArgAsUInt32(e),this.VQ.finishEncodingCommand()}createPipelineContext(){return new of(this)}createMaterialContext(){}createDrawContext(){}on(t,i,e,s,n,r,h,o){const a=t;a.nativeProgram=s?this.createRawShaderProgram():this.createShaderProgram(t,i,e,o)}Dr(t){return!0}an(t,i){i()}createRawShaderProgram(){throw new Error("Not Supported")}createShaderProgram(t,i,e,s){this.onBeforeShaderCompilationObservable.notifyObservers(this);const n=new hf(i);n.processCode(),i=n.code;const r=new hf(e);r.processCode(),e=r.code,i=Ei.va(i,s),e=Ei.va(e,s);const h=this.Ls.createProgram(i,e);return this.onAfterShaderCompilationObservable.notifyObservers(this),h}inlineShaderCode(t){const i=new hf(t);return i.debug=!1,i.processCode(),i.code}Ka(t){this.Ca!==t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.finishEncodingCommand(),this.Ca=t)}cn(t){const i=t;i&&i.nativeProgram&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this.VQ.encodeCommandArgAsNativeData(i.nativeProgram),this.VQ.finishEncodingCommand())}getUniforms(t,i){const e=t;return this.Ls.getUniforms(e.nativeProgram,i)}bindUniformBlock(t,i,e){throw new Error("Not Implemented")}bindSamplers(t){const i=t.getPipelineContext();this.Ka(i.nativeProgram);const e=t.getSamplers();for(let i=0;i<e.length;i++){const s=t.getUniform(e[i]);s&&(this.Zh[i]=s)}this.fa=null}getRenderWidth(t=!1){return!t&&this.zo?this.zo.width:this.Ls.getRenderWidth()}getRenderHeight(t=!1){return!t&&this.zo?this.zo.height:this.Ls.getRenderHeight()}setViewport(t,i,e){this.Eo=t,this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this.VQ.encodeCommandArgAsFloat32(t.x),this.VQ.encodeCommandArgAsFloat32(t.y),this.VQ.encodeCommandArgAsFloat32(t.width),this.VQ.encodeCommandArgAsFloat32(t.height),this.VQ.finishEncodingCommand()}setState(t,i=0,e,s=!1,n,r,h=0){var o,a;this.wn=i,this.xn=h,this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this.VQ.encodeCommandArgAsUInt32(t?1:0),this.VQ.encodeCommandArgAsFloat32(i),this.VQ.encodeCommandArgAsFloat32(h),this.VQ.encodeCommandArgAsUInt32(null===(a=null!==(o=this.cullBackFaces)&&void 0!==o?o:n)||void 0===a||a?1:0),this.VQ.encodeCommandArgAsUInt32(s?1:0),this.VQ.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(t){t!==this.wn&&(this.wn=t,this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this.VQ.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-t:t),this.VQ.finishEncodingCommand())}getZOffset(){return this.wn}setZOffsetUnits(t){t!==this.xn&&(this.xn=t,this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this.VQ.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-t:t),this.VQ.finishEncodingCommand())}getZOffsetUnits(){return this.xn}setDepthBuffer(t){this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this.VQ.encodeCommandArgAsUInt32(t?this.GQ:_native.Engine.DEPTH_TEST_ALWAYS),this.VQ.finishEncodingCommand()}getDepthWrite(){return this.qQ}getDepthFunction(){switch(this.GQ){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(t){let i=0;switch(t){case 512:i=_native.Engine.DEPTH_TEST_NEVER;break;case 519:i=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:i=_native.Engine.DEPTH_TEST_GREATER;break;case 518:i=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:i=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:i=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:i=_native.Engine.DEPTH_TEST_LESS;break;case 515:i=_native.Engine.DEPTH_TEST_LEQUAL}this.GQ=i,this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this.VQ.encodeCommandArgAsUInt32(this.GQ),this.VQ.finishEncodingCommand()}setDepthWrite(t){this.qQ=t,this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this.VQ.encodeCommandArgAsUInt32(Number(t)),this.VQ.finishEncodingCommand()}setColorWrite(t){this.gh=t,this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this.VQ.encodeCommandArgAsUInt32(Number(t)),this.VQ.finishEncodingCommand()}getColorWrite(){return this.gh}applyStencil(){this.tZ(this.HQ,this.iZ(this.YQ),this.eZ(this.jQ),this.sZ(this.KQ),this.nZ(this.XQ),this.WQ)}tZ(t,i,e,s,n,r){this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this.VQ.encodeCommandArgAsUInt32(t),this.VQ.encodeCommandArgAsUInt32(i),this.VQ.encodeCommandArgAsUInt32(e),this.VQ.encodeCommandArgAsUInt32(s),this.VQ.encodeCommandArgAsUInt32(n),this.VQ.encodeCommandArgAsUInt32(r),this.VQ.finishEncodingCommand()}setStencilBuffer(t){this.zQ=t,t?this.applyStencil():this.tZ(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this.zQ}getStencilOperationPass(){return this.KQ}setStencilOperationPass(t){this.KQ=t,this.applyStencil()}setStencilMask(t){this.HQ=t,this.applyStencil()}setStencilFunction(t){this.XQ=t,this.applyStencil()}setStencilFunctionReference(t){this.WQ=t,this.applyStencil()}setStencilFunctionMask(t){this.$Q=t}setStencilOperationFail(t){this.YQ=t,this.applyStencil()}setStencilOperationDepthFail(t){this.jQ=t,this.applyStencil()}getStencilMask(){return this.HQ}getStencilFunction(){return this.XQ}getStencilFunctionReference(){return this.WQ}getStencilFunctionMask(){return this.$Q}getStencilOperationFail(){return this.YQ}getStencilOperationDepthFail(){return this.jQ}setAlphaConstants(t,i,e,s){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(t,i=!1){if(this.xh===t)return;const e=this.rZ(t);this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this.VQ.encodeCommandArgAsUInt32(e),this.VQ.finishEncodingCommand(),i||this.setDepthWrite(0===t),this.xh=t}getAlphaMode(){return this.xh}setInt(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETINT),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsInt32(i),this.VQ.finishEncodingCommand(),!0)}setIntArray(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsInt32s(i),this.VQ.finishEncodingCommand(),!0)}setIntArray2(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsInt32s(i),this.VQ.finishEncodingCommand(),!0)}setIntArray3(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsInt32s(i),this.VQ.finishEncodingCommand(),!0)}setIntArray4(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsInt32s(i),this.VQ.finishEncodingCommand(),!0)}setFloatArray(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsFloat32s(i),this.VQ.finishEncodingCommand(),!0)}setFloatArray2(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsFloat32s(i),this.VQ.finishEncodingCommand(),!0)}setFloatArray3(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsFloat32s(i),this.VQ.finishEncodingCommand(),!0)}setFloatArray4(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsFloat32s(i),this.VQ.finishEncodingCommand(),!0)}setArray(t,i){return!!t&&this.setFloatArray(t,new Float32Array(i))}setArray2(t,i){return!!t&&this.setFloatArray2(t,new Float32Array(i))}setArray3(t,i){return!!t&&this.setFloatArray3(t,new Float32Array(i))}setArray4(t,i){return!!t&&this.setFloatArray4(t,new Float32Array(i))}setMatrices(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsFloat32s(i),this.VQ.finishEncodingCommand(),!0)}setMatrix3x3(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsFloat32s(i),this.VQ.finishEncodingCommand(),!0)}setMatrix2x2(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsFloat32s(i),this.VQ.finishEncodingCommand(),!0)}setFloat(t,i){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsFloat32(i),this.VQ.finishEncodingCommand(),!0)}setFloat2(t,i,e){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsFloat32(i),this.VQ.encodeCommandArgAsFloat32(e),this.VQ.finishEncodingCommand(),!0)}setFloat3(t,i,e,s){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsFloat32(i),this.VQ.encodeCommandArgAsFloat32(e),this.VQ.encodeCommandArgAsFloat32(s),this.VQ.finishEncodingCommand(),!0)}setFloat4(t,i,e,s,n){return!!t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsFloat32(i),this.VQ.encodeCommandArgAsFloat32(e),this.VQ.encodeCommandArgAsFloat32(s),this.VQ.encodeCommandArgAsFloat32(n),this.VQ.finishEncodingCommand(),!0)}setColor3(t,i){return!!t&&(this.setFloat3(t,i.r,i.g,i.b),!0)}setColor4(t,i,e){return!!t&&(this.setFloat4(t,i.r,i.g,i.b,e),!0)}wipeCaches(t){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this.fa=null,t&&(this.Ca=null,this.Ah.reset(),this.Eh.reset(),this.wh.reset()),this.Zo=null,this.ia=null,this.la=null)}xa(){return this.Ls.createTexture()}Ya(t){t&&this.Ls.deleteTexture(t)}updateDynamicTexture(t,i,e,s=!1,n){if(void 0===s&&(s=!1),t&&t.Er){const e=i.getCanvasTexture(),s=t.Er.underlyingResource;this.Ls.copyTexture(s,e),t.isReady=!0}}createDynamicTexture(t,i,e,s){return t=Math.max(t,1),i=Math.max(i,1),this.createRawTexture(new Uint8Array(t*i*4),t,i,5,!1,!1,s)}createVideoElement(t){return this.JD?this.JD.createVideo(t):null}updateVideoTexture(t,i,e){if(t&&t.Er&&this.JD){const s=t.Er.underlyingResource;this.JD.updateVideoTexture(s,i,e)}}createRawTexture(t,i,e,s,n,r,h,o=null,a=0,l=0,c=!1){const u=new ai(this,oi.Raw);if(u.format=s,u.generateMipMaps=n,u.samplingMode=h,u.invertY=r,u.baseWidth=i,u.baseHeight=e,u.width=u.baseWidth,u.height=u.baseHeight,u.nr=o,u.type=a,u.ur=this.ba(c,!n),this.updateRawTexture(u,t,s,r,o,a,u.ur),u.Er){const t=u.Er.underlyingResource,i=this.hZ(h);this.oZ(t,i)}return this.Rh.push(u),u}createRawTexture2DArray(t,i,e,s,n,r,h,o,a=null,l=0){const c=new ai(this,oi.Raw2DArray);if(c.baseWidth=i,c.baseHeight=e,c.baseDepth=s,c.width=i,c.height=e,c.depth=s,c.format=n,c.type=l,c.generateMipMaps=r,c.samplingMode=o,c.is2DArray=!0,c.Er){const a=c.Er.underlyingResource;this.Ls.loadRawTexture2DArray(a,t,i,e,s,this.aZ(n,l),r,h);const u=this.hZ(o);this.oZ(a,u)}return c.isReady=!0,this.Rh.push(c),c}updateRawTexture(t,i,e,s,n=null,r=0,h=!1){if(t){if(i&&t.Er){const s=t.Er.underlyingResource;this.Ls.loadRawTexture(s,i,t.width,t.height,this.aZ(e,r),t.generateMipMaps,t.invertY)}t.isReady=!0}}createTexture(t,i,e,s,n=3,r=null,h=null,o=null,a=null,l=null,c=null,u,f,d,p=!1){const m="data:"===(t=t||"").substr(0,5),v=m&&-1!==t.indexOf(";base64,"),g=a||new ai(this,oi.Url),S=t;!this.$h||v||a||o||(t=this.$h(t));const A=t.lastIndexOf("."),C=c||(A>-1?t.substring(A).toLowerCase():"");let w=null;for(const t of Rs.ya)if(t.canLoad(C)){w=t;break}s&&s.addPendingData(g),g.url=t,g.generateMipMaps=!i,g.samplingMode=n,g.invertY=e,g.ur=this.ba(p,i),this.doNotHandleContextLost||(g.Yn=o);let x=null;r&&!a&&(x=g.onLoadedObservable.add(r)),a||this.Rh.push(g);const T=(e,a)=>{s&&s.removePendingData(g),t===S?(x&&g.onLoadedObservable.remove(x),E.UseFallbackTexture&&this.createTexture(E.FallbackTexture,i,g.invertY,s,n,null,h,o,g),h&&h((e||"Unknown error")+(E.UseFallbackTexture?" - Fallback texture was used":""),a)):(F.Warn(`Failed to load ${t}, falling back to ${S}`),this.createTexture(S,i,g.invertY,s,n,r,h,o,g,l,c,u,f))};if(w)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{const r=t=>{if(!g.Er)return void(s&&s.removePendingData(g));const r=g.Er.underlyingResource;this.Ls.loadTexture(r,t,!i,e,p,(()=>{g.baseWidth=this.Ls.getTextureWidth(r),g.baseHeight=this.Ls.getTextureHeight(r),g.width=g.baseWidth,g.height=g.baseHeight,g.isReady=!0;const t=this.hZ(n);this.oZ(r,t),s&&s.removePendingData(g),g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear()}),(()=>{throw new Error("Could not load a native texture.")}))};if(m&&o)if(o instanceof ArrayBuffer)r(new Uint8Array(o));else if(ArrayBuffer.isView(o))r(o);else{if("string"!=typeof o)throw new Error("Unsupported buffer type");r(new Uint8Array(ki.DecodeBase64(o)))}else v?r(new Uint8Array(ki.DecodeBase64(t))):this.tn(t,(t=>r(new Uint8Array(t))),void 0,void 0,!0,((t,i)=>{T("Unable to load "+(t&&t.responseURL,i))}))}return g}wrapNativeTexture(t){const i=new lf(t,this.Ls),e=new ai(this,oi.Unknown,!0);return e.Er=i,e.isReady=!0,e}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}jD(t,i,e){const s=e,n=new ai(this,oi.DepthStencil),r=t.width||t,h=t.height||t,o=this.Ls.createFrameBuffer(n.Er.underlyingResource,r,h,!0,!0);return s.NQ=o,n}yQ(t){t&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.finishEncodingCommand())}Fw(t,i){return new Promise(((i,e)=>{const s=this.createCanvasImage();s.onload=()=>{try{const t=this.Ls.createImageBitmap(s);i(t)}catch(t){e(`Error loading image ${s.src} with exception: ${t}`)}},s.onerror=t=>{e(`Error loading image ${s.src} with exception: ${t}`)},s.src=t}))}createImageBitmap(t,i){return new Promise(((i,e)=>{if(Array.isArray(t)){const e=t;if(e.length){const t=this.Ls.createImageBitmap(e[0]);if(t)return void i(t)}}e("Unsupported data for createImageBitmap.")}))}resizeImageBitmap(t,i,e){return this.Ls.resizeImageBitmap(t,i,e)}createCubeTexture(t,i,e,s,n=null,r=null,h,o=null,a=!1,l=0,c=0,u=null,f,d=!1){const p=u||new ai(this,oi.Cube);p.isCube=!0,p.url=t,p.generateMipMaps=!s,p.lr=l,p.cr=c,this.mh||(p.Zn=o,p.Jn=e);const m=t.lastIndexOf(".");if(".env"===(o||(m>-1?t.substring(m).toLowerCase():""))){const i=t=>{const i=Yu(t);p.width=i.width,p.height=i.width,Ju(p,i);const e=i.specular;if(!e)throw new Error("Nothing else parsed so far");p.lr=e.lodGenerationScale;const s=Ku(t,i);p.format=5,p.type=0,p.generateMipMaps=!0,p.getEngine().updateTextureSamplingMode(an.TRILINEAR_SAMPLINGMODE,p),p.vr=!0,p.invertY=!0,this.Ls.loadCubeTextureWithMips(p.Er.underlyingResource,s,!1,d,(()=>{p.isReady=!0,n&&n()}),(()=>{throw new Error("Could not load a native cube texture.")}))};if(e&&6===e.length)throw new Error("Multi-file loading not allowed on env files.");{const e=(t,i)=>{r&&t&&r(t.status+" "+t.statusText,i)};this.tn(t,(t=>i(new Uint8Array(t))),void 0,void 0,!0,e)}}else{if(!e||6!==e.length)throw new Error("Cannot load cubemap because 6 files were not defined");const t=[e[0],e[3],e[1],e[4],e[2],e[5]];Promise.all(t.map((t=>ki.LoadFileAsync(t).then((t=>new Uint8Array(t)))))).then((t=>new Promise(((i,e)=>{this.Ls.loadCubeTexture(p.Er.underlyingResource,t,!s,!0,d,i,e)})))).then((()=>{p.isReady=!0,n&&n()}),(t=>{r&&r(`Failed to load cubemap: ${t.message}`,t)}))}return this.Rh.push(p),p}Ir(){return new lf(this.xa(),this.Ls)}$D(t,i,e){const s=new af(t,i,e,this);return this.Ih.push(s),s}Ta(t,i,e=!0,s=oi.Unknown){var n;let r=!1,h=0,o=3,a=5,l=!1,c=1;void 0!==i&&"object"==typeof i?(r=!!i.generateMipMaps,h=void 0===i.type?0:i.type,o=void 0===i.samplingMode?3:i.samplingMode,a=void 0===i.format?5:i.format,l=void 0!==i.useSRGBBuffer&&i.useSRGBBuffer,c=null!==(n=i.samples)&&void 0!==n?n:1):r=!!i,l&&(l=this.po.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==h||this.po.textureFloatLinearFiltering)&&(2!==h||this.po.textureHalfFloatLinearFiltering)||(o=1),1!==h||this.po.textureFloat||(h=0,F.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const u=new ai(this,s),f=t.width||t,d=t.height||t,p=t.layers||0;if(0!==p)throw new Error("Texture layers are not supported in Babylon Native");const m=u.Er.underlyingResource,v=this.aZ(a,h);return this.Ls.initializeTexture(m,f,d,r,v,!0,l),this.oZ(m,this.hZ(o)),u.ur=l,u.baseWidth=f,u.baseHeight=d,u.width=f,u.height=d,u.depth=p,u.isReady=!0,u.samples=c,u.generateMipMaps=r,u.samplingMode=o,u.type=h,u.format=a,this.Rh.push(u),u}createRenderTargetTexture(t,i){var e;const s=this.$D(!1,!1,t);let n,r=!0,h=!1,o=!1;void 0!==i&&"object"==typeof i&&(r=null===(e=i.generateDepthBuffer)||void 0===e||e,h=!!i.generateStencilBuffer,o=!!i.noColorAttachment,n=i.colorAttachment);const a=n||(o?null:this.Ta(t,i,!0,oi.RenderTarget)),l=t.width||t,c=t.height||t,u=this.Ls.createFrameBuffer(a?a.Er.underlyingResource:null,l,c,h,r);return s.$o=u,s.BD=r,s.FD=h,s.setTextures(a),s}updateTextureSamplingMode(t,i){if(i.Er){const e=this.hZ(t);this.oZ(i.Er.underlyingResource,e)}i.samplingMode=t}bindFramebuffer(t,i,e,s,n){const r=t;if(this.zo&&this.unBindFramebuffer(this.zo),this.zo=t,i)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(e||s)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");r.NQ?this.Xo(r.NQ):this.Xo(r.$o)}unBindFramebuffer(t,i=!1,e){this.zo=null,e&&e(),this.Xo(null)}createDynamicVertexBuffer(t){return this.createVertexBuffer(t,!0)}updateDynamicIndexBuffer(t,i,e=0){const s=t,n=this.ea(i);s.is32Bits=4===n.BYTES_PER_ELEMENT,this.Ls.updateDynamicIndexBuffer(s.nativeIndexBuffer,n.buffer,n.byteOffset,n.byteLength,e)}updateDynamicVertexBuffer(t,i,e,s){const n=t,r=ArrayBuffer.isView(i)?i:new Float32Array(i);this.Ls.updateDynamicVertexBuffer(n.nativeVertexBuffer,r.buffer,r.byteOffset+(null!=e?e:0),null!=s?s:r.byteLength)}Za(t,i,e=!1,s=!1){const n=this.Zh[t];if(!n)return!1;if(!i)return null!=this._h[t]&&(this.Mh=t,this._h[t]=null),!1;if(i.video)this.Mh=t,i.update();else if(4===i.delayLoadState)return i.delayLoad(),!1;let r;return r=s?i.depthStencilTexture:i.isReady()?i.getInternalTexture():i.isCube?this.emptyCubeTexture:i.is3D?this.emptyTexture3D:i.is2DArray?this.emptyTexture2DArray:this.emptyTexture,this.Mh=t,!(!r||!r.Er)&&(this.lZ(r.Er.underlyingResource,this.cZ(i.wrapU),this.cZ(i.wrapV),this.cZ(i.wrapR)),this.uZ(i),this.fZ(n,r.Er.underlyingResource),!0)}oZ(t,i){this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsUInt32(i),this.VQ.finishEncodingCommand()}lZ(t,i,e,s){this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsUInt32(i),this.VQ.encodeCommandArgAsUInt32(e),this.VQ.encodeCommandArgAsUInt32(s),this.VQ.finishEncodingCommand()}fZ(t,i){this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this.VQ.encodeCommandArgAsNativeData(t),this.VQ.encodeCommandArgAsNativeData(i),this.VQ.finishEncodingCommand()}uZ(t){const i=t.getInternalTexture(),e=t.anisotropicFilteringLevel;i&&i.Er&&i.zn!==e&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this.VQ.encodeCommandArgAsNativeData(i.Er.underlyingResource),this.VQ.encodeCommandArgAsUInt32(e),this.VQ.finishEncodingCommand(),i.zn=e)}cZ(t){switch(t){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+t+".")}}fn(t,i){const e=this.Zh[t];if(e&&i&&i.Er){const t=i.Er.underlyingResource;this.fZ(e,t)}}ua(t){t.nativeIndexBuffer&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this.VQ.encodeCommandArgAsNativeData(t.nativeIndexBuffer),this.VQ.finishEncodingCommand(),delete t.nativeIndexBuffer),t.nativeVertexBuffer&&(this.VQ.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this.VQ.encodeCommandArgAsNativeData(t.nativeVertexBuffer),this.VQ.finishEncodingCommand(),delete t.nativeVertexBuffer)}createCanvas(t,i){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");const e=new _native.Canvas;return e.width=t,e.height=i,e}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}updateTextureData(t,i,e,s,n,r,h=0,o=0,a=!1){throw new Error("updateTextureData not implemented.")}ka(t,i,e,s,n,r=0,h=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}Ga(t,i,e=0,s=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}za(t,i,e=0,s=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}Ex(t,i,e=0,s=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}hZ(t){switch(t){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${t}.`)}}nZ(t){switch(t){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${t}.`)}}iZ(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${t}.`)}}eZ(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${t}.`)}}sZ(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${t}.`)}}aZ(t,i){if(4==t&&0==i)return _native.Engine.TEXTURE_FORMAT_RGB8;if(5==t&&0==i)return _native.Engine.TEXTURE_FORMAT_RGBA8;if(5==t&&2==i)return _native.Engine.TEXTURE_FORMAT_RGBA16F;if(5==t&&1==i)return _native.Engine.TEXTURE_FORMAT_RGBA32F;throw new Bt(`Unsupported texture format or type: format ${t}, type ${i}.`,Pt)}rZ(t){switch(t){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${t}.`)}}JQ(t){switch(t){case he.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case he.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case he.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case he.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case he.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${t}.`)}}getFontOffset(t){return{ascent:0,height:0,descent:0}}Aw(t,i,e,s,n,r,h,o,a,l){var c,u,f,d;if(void 0!==s&&-1!==s)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${s}.`);return this.Ls.readTexture(null===(c=t.Er)||void 0===c?void 0:c.underlyingResource,null!=n?n:0,null!=a?a:0,null!=l?l:0,i,e,null!==(u=null==r?void 0:r.buffer)&&void 0!==u?u:null,null!==(f=null==r?void 0:r.byteOffset)&&void 0!==f?f:0,null!==(d=null==r?void 0:r.byteLength)&&void 0!==d?d:0).then((t=>(r||(r=new Uint8Array(t)),r)))}}df.PROTOCOL_VERSION=8,df.BQ=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new pf:new Iu};class pf extends Iu{constructor(){super()}writeUint32(t){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(t)}writeInt32(t){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(t)}writeFloat32(t){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(t)}writeUint32Array(t){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(t)}writeInt32Array(t){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(t)}writeFloat32Array(t){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(t)}writeNativeData(t){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(t)}writeBoolean(t){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(t)}}var mf,vf,gf,Sf,Ef,Af,Cf,wf,xf,Tf,Rf,If,Mf,bf,_f,yf,Nf,Pf,Df,Lf,Of,Ff,Bf,Uf,Vf,kf,Gf,zf,Hf,Xf,Wf,$f,Yf,jf,Kf,qf,Qf,Zf;!function(t){t.SRGB="srgb"}(mf||(mf={})),function(t){t.LowPower="low-power",t.HighPerformance="high-performance"}(vf||(vf={})),function(t){t.DepthClipControl="depth-clip-control",t.Depth24UnormStencil8="depth24unorm-stencil8",t.Depth32FloatStencil8="depth32float-stencil8",t.TextureCompressionBC="texture-compression-bc",t.TextureCompressionETC2="texture-compression-etc2",t.TextureCompressionASTC="texture-compression-astc",t.TimestampQuery="timestamp-query",t.IndirectFirstInstance="indirect-first-instance",t.ShaderF16="shader-f16",t.BGRA8UnormStorage="bgra8unorm-storage"}(gf||(gf={})),function(t){t[t.MapRead=1]="MapRead",t[t.MapWrite=2]="MapWrite",t[t.CopySrc=4]="CopySrc",t[t.CopyDst=8]="CopyDst",t[t.Index=16]="Index",t[t.Vertex=32]="Vertex",t[t.Uniform=64]="Uniform",t[t.Storage=128]="Storage",t[t.Indirect=256]="Indirect",t[t.QueryResolve=512]="QueryResolve"}(Sf||(Sf={})),function(t){t[t.Read=1]="Read",t[t.Write=2]="Write"}(Ef||(Ef={})),function(t){t.E1d="1d",t.E2d="2d",t.E3d="3d"}(Af||(Af={})),function(t){t[t.CopySrc=1]="CopySrc",t[t.CopyDst=2]="CopyDst",t[t.TextureBinding=4]="TextureBinding",t[t.StorageBinding=8]="StorageBinding",t[t.RenderAttachment=16]="RenderAttachment"}(Cf||(Cf={})),function(t){t.E1d="1d",t.E2d="2d",t.E2dArray="2d-array",t.Cube="cube",t.CubeArray="cube-array",t.E3d="3d"}(wf||(wf={})),function(t){t.All="all",t.StencilOnly="stencil-only",t.DepthOnly="depth-only"}(xf||(xf={})),function(t){t.R8Unorm="r8unorm",t.R8Snorm="r8snorm",t.R8Uint="r8uint",t.R8Sint="r8sint",t.R16Uint="r16uint",t.R16Sint="r16sint",t.R16Float="r16float",t.RG8Unorm="rg8unorm",t.RG8Snorm="rg8snorm",t.RG8Uint="rg8uint",t.RG8Sint="rg8sint",t.R32Uint="r32uint",t.R32Sint="r32sint",t.R32Float="r32float",t.RG16Uint="rg16uint",t.RG16Sint="rg16sint",t.RG16Float="rg16float",t.RGBA8Unorm="rgba8unorm",t.RGBA8UnormSRGB="rgba8unorm-srgb",t.RGBA8Snorm="rgba8snorm",t.RGBA8Uint="rgba8uint",t.RGBA8Sint="rgba8sint",t.BGRA8Unorm="bgra8unorm",t.BGRA8UnormSRGB="bgra8unorm-srgb",t.RGB9E5UFloat="rgb9e5ufloat",t.RGB10A2Unorm="rgb10a2unorm",t.RG11B10UFloat="rg11b10ufloat",t.RG32Uint="rg32uint",t.RG32Sint="rg32sint",t.RG32Float="rg32float",t.RGBA16Uint="rgba16uint",t.RGBA16Sint="rgba16sint",t.RGBA16Float="rgba16float",t.RGBA32Uint="rgba32uint",t.RGBA32Sint="rgba32sint",t.RGBA32Float="rgba32float",t.Stencil8="stencil8",t.Depth16Unorm="depth16unorm",t.Depth24Plus="depth24plus",t.Depth24PlusStencil8="depth24plus-stencil8",t.Depth32Float="depth32float",t.BC1RGBAUnorm="bc1-rgba-unorm",t.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",t.BC2RGBAUnorm="bc2-rgba-unorm",t.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",t.BC3RGBAUnorm="bc3-rgba-unorm",t.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",t.BC4RUnorm="bc4-r-unorm",t.BC4RSnorm="bc4-r-snorm",t.BC5RGUnorm="bc5-rg-unorm",t.BC5RGSnorm="bc5-rg-snorm",t.BC6HRGBUFloat="bc6h-rgb-ufloat",t.BC6HRGBFloat="bc6h-rgb-float",t.BC7RGBAUnorm="bc7-rgba-unorm",t.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",t.ETC2RGB8Unorm="etc2-rgb8unorm",t.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",t.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",t.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",t.ETC2RGBA8Unorm="etc2-rgba8unorm",t.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",t.EACR11Unorm="eac-r11unorm",t.EACR11Snorm="eac-r11snorm",t.EACRG11Unorm="eac-rg11unorm",t.EACRG11Snorm="eac-rg11snorm",t.ASTC4x4Unorm="astc-4x4-unorm",t.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",t.ASTC5x4Unorm="astc-5x4-unorm",t.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",t.ASTC5x5Unorm="astc-5x5-unorm",t.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",t.ASTC6x5Unorm="astc-6x5-unorm",t.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",t.ASTC6x6Unorm="astc-6x6-unorm",t.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",t.ASTC8x5Unorm="astc-8x5-unorm",t.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",t.ASTC8x6Unorm="astc-8x6-unorm",t.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",t.ASTC8x8Unorm="astc-8x8-unorm",t.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",t.ASTC10x5Unorm="astc-10x5-unorm",t.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",t.ASTC10x6Unorm="astc-10x6-unorm",t.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",t.ASTC10x8Unorm="astc-10x8-unorm",t.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",t.ASTC10x10Unorm="astc-10x10-unorm",t.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",t.ASTC12x10Unorm="astc-12x10-unorm",t.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",t.ASTC12x12Unorm="astc-12x12-unorm",t.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",t.Depth24UnormStencil8="depth24unorm-stencil8",t.Depth32FloatStencil8="depth32float-stencil8"}(Tf||(Tf={})),function(t){t.ClampToEdge="clamp-to-edge",t.Repeat="repeat",t.MirrorRepeat="mirror-repeat"}(Rf||(Rf={})),function(t){t.Nearest="nearest",t.Linear="linear"}(If||(If={})),function(t){t.Never="never",t.Less="less",t.Equal="equal",t.LessEqual="less-equal",t.Greater="greater",t.NotEqual="not-equal",t.GreaterEqual="greater-equal",t.Always="always"}(Mf||(Mf={})),function(t){t[t.Vertex=1]="Vertex",t[t.Fragment=2]="Fragment",t[t.Compute=4]="Compute"}(bf||(bf={})),function(t){t.Uniform="uniform",t.Storage="storage",t.ReadOnlyStorage="read-only-storage"}(_f||(_f={})),function(t){t.Filtering="filtering",t.NonFiltering="non-filtering",t.Comparison="comparison"}(yf||(yf={})),function(t){t.Float="float",t.UnfilterableFloat="unfilterable-float",t.Depth="depth",t.Sint="sint",t.Uint="uint"}(Nf||(Nf={})),function(t){t.WriteOnly="write-only"}(Pf||(Pf={})),function(t){t.Error="error",t.Warning="warning",t.Info="info"}(Df||(Df={})),function(t){t.Auto="auto"}(Lf||(Lf={})),function(t){t.PointList="point-list",t.LineList="line-list",t.LineStrip="line-strip",t.TriangleList="triangle-list",t.TriangleStrip="triangle-strip"}(Of||(Of={})),function(t){t.CCW="ccw",t.CW="cw"}(Ff||(Ff={})),function(t){t.None="none",t.Front="front",t.Back="back"}(Bf||(Bf={})),function(t){t[t.Red=1]="Red",t[t.Green=2]="Green",t[t.Blue=4]="Blue",t[t.Alpha=8]="Alpha",t[t.All=15]="All"}(Uf||(Uf={})),function(t){t.Zero="zero",t.One="one",t.Src="src",t.OneMinusSrc="one-minus-src",t.SrcAlpha="src-alpha",t.OneMinusSrcAlpha="one-minus-src-alpha",t.Dst="dst",t.OneMinusDst="one-minus-dst",t.DstAlpha="dst-alpha",t.OneMinusDstAlpha="one-minus-dst-alpha",t.SrcAlphaSaturated="src-alpha-saturated",t.Constant="constant",t.OneMinusConstant="one-minus-constant"}(Vf||(Vf={})),function(t){t.Add="add",t.Subtract="subtract",t.ReverseSubtract="reverse-subtract",t.Min="min",t.Max="max"}(kf||(kf={})),function(t){t.Keep="keep",t.Zero="zero",t.Replace="replace",t.Invert="invert",t.IncrementClamp="increment-clamp",t.DecrementClamp="decrement-clamp",t.IncrementWrap="increment-wrap",t.DecrementWrap="decrement-wrap"}(Gf||(Gf={})),function(t){t.Uint16="uint16",t.Uint32="uint32"}(zf||(zf={})),function(t){t.Uint8x2="uint8x2",t.Uint8x4="uint8x4",t.Sint8x2="sint8x2",t.Sint8x4="sint8x4",t.Unorm8x2="unorm8x2",t.Unorm8x4="unorm8x4",t.Snorm8x2="snorm8x2",t.Snorm8x4="snorm8x4",t.Uint16x2="uint16x2",t.Uint16x4="uint16x4",t.Sint16x2="sint16x2",t.Sint16x4="sint16x4",t.Unorm16x2="unorm16x2",t.Unorm16x4="unorm16x4",t.Snorm16x2="snorm16x2",t.Snorm16x4="snorm16x4",t.Float16x2="float16x2",t.Float16x4="float16x4",t.Float32="float32",t.Float32x2="float32x2",t.Float32x3="float32x3",t.Float32x4="float32x4",t.Uint32="uint32",t.Uint32x2="uint32x2",t.Uint32x3="uint32x3",t.Uint32x4="uint32x4",t.Sint32="sint32",t.Sint32x2="sint32x2",t.Sint32x3="sint32x3",t.Sint32x4="sint32x4"}(Hf||(Hf={})),function(t){t.Vertex="vertex",t.Instance="instance"}(Xf||(Xf={})),function(t){t.Beginning="beginning",t.End="end"}(Wf||(Wf={})),function(t){t.Beginning="beginning",t.End="end"}($f||($f={})),function(t){t.Load="load",t.Clear="clear"}(Yf||(Yf={})),function(t){t.Store="store",t.Discard="discard"}(jf||(jf={})),function(t){t.Occlusion="occlusion",t.Timestamp="timestamp"}(Kf||(Kf={})),function(t){t.Opaque="opaque",t.Premultiplied="premultiplied"}(qf||(qf={})),function(t){t.Destroyed="destroyed"}(Qf||(Qf={})),function(t){t.OutOfMemory="out-of-memory",t.Validation="validation"}(Zf||(Zf={}));class Jf{constructor(){this.shaderLanguage=qt.GLSL}dZ(t,i,e){let s=0;[t,i,s]=this.pZ(t,i,e);for(let i=0;i<this.mZ.leftOverUniforms.length;i++)if(this.mZ.leftOverUniforms[i].name===t)return;this.mZ.leftOverUniforms.push({name:t,type:i,length:s})}vZ(){if(!this.mZ.leftOverUniforms.length)return"";const t=Jf.LeftOvertUBOName;let i=this.mZ.availableBuffers[t];return i||(i={binding:this.mZ.getNextFreeUBOBinding()},this.mZ.availableBuffers[t]=i,this.gZ(t,i,_f.Uniform,!0),this.gZ(t,i,_f.Uniform,!1)),this.SZ(t,i)}EZ(){for(let t=0;t<this.mZ.bindGroupLayoutEntries.length;t++){const i=this.mZ.bindGroupLayoutEntries[t];if(void 0!==i)for(let e=0;e<i.length;e++){const i=this.mZ.bindGroupLayoutEntries[t][e],s=this.mZ.bindGroupLayoutEntryInfo[t][i.binding].name,n=this.mZ.bindGroupLayoutEntryInfo[t][i.binding].nameInArrayOfTexture;i&&(i.texture||i.externalTexture||i.storageTexture?this.mZ.textureNames.push(n):i.sampler?this.mZ.samplerNames.push(s):i.buffer&&this.mZ.bufferNames.push(s))}else this.mZ.bindGroupLayoutEntries[t]=[]}}AZ(){const t=this.mZ.bindGroupEntries;for(let i=0;i<this.mZ.bindGroupLayoutEntries.length;i++){const e=this.mZ.bindGroupLayoutEntries[i],s=[];for(let t=0;t<e.length;t++){const e=this.mZ.bindGroupLayoutEntries[i][t];e.sampler||e.texture||e.storageTexture||e.externalTexture?s.push({binding:e.binding,resource:void 0}):e.buffer&&s.push({binding:e.binding,resource:{buffer:void 0,offset:0,size:0}})}t[i]=s}}CZ(t,i,e,s,n,r){let{groupIndex:h,bindingIndex:o}=i.textures[e];if(this.mZ.bindGroupLayoutEntries[h]||(this.mZ.bindGroupLayoutEntries[h]=[],this.mZ.bindGroupLayoutEntryInfo[h]=[]),!this.mZ.bindGroupLayoutEntryInfo[h][o]){let r;r=null===s?this.mZ.bindGroupLayoutEntries[h].push({binding:o,visibility:0,externalTexture:{}}):n?this.mZ.bindGroupLayoutEntries[h].push({binding:o,visibility:0,storageTexture:{access:Pf.WriteOnly,format:n,viewDimension:s}}):this.mZ.bindGroupLayoutEntries[h].push({binding:o,visibility:0,texture:{sampleType:i.sampleType,viewDimension:s,multisampled:!1}});const a=i.isTextureArray?t+e:t;this.mZ.bindGroupLayoutEntryInfo[h][o]={name:t,index:r-1,nameInArrayOfTexture:a}}o=this.mZ.bindGroupLayoutEntryInfo[h][o].index,this.mZ.bindGroupLayoutEntries[h][o].visibility|=r?bf.Vertex:bf.Fragment}wZ(t,i,e){let{groupIndex:s,bindingIndex:n}=i.binding;if(this.mZ.bindGroupLayoutEntries[s]||(this.mZ.bindGroupLayoutEntries[s]=[],this.mZ.bindGroupLayoutEntryInfo[s]=[]),!this.mZ.bindGroupLayoutEntryInfo[s][n]){const e=this.mZ.bindGroupLayoutEntries[s].push({binding:n,visibility:0,sampler:{type:i.type}});this.mZ.bindGroupLayoutEntryInfo[s][n]={name:t,index:e-1}}n=this.mZ.bindGroupLayoutEntryInfo[s][n].index,this.mZ.bindGroupLayoutEntries[s][n].visibility|=e?bf.Vertex:bf.Fragment}gZ(t,i,e,s){let{groupIndex:n,bindingIndex:r}=i.binding;if(this.mZ.bindGroupLayoutEntries[n]||(this.mZ.bindGroupLayoutEntries[n]=[],this.mZ.bindGroupLayoutEntryInfo[n]=[]),!this.mZ.bindGroupLayoutEntryInfo[n][r]){const i=this.mZ.bindGroupLayoutEntries[n].push({binding:r,visibility:0,buffer:{type:e}});this.mZ.bindGroupLayoutEntryInfo[n][r]={name:t,index:i-1}}r=this.mZ.bindGroupLayoutEntryInfo[n][r].index,this.mZ.bindGroupLayoutEntries[n][r].visibility|=s?bf.Vertex:bf.Fragment}xZ(t,i,e,s){let n=t.indexOf(i);if(n<0)return console.error('No "main" function found in shader code! Processing aborted.'),t;if(e){for(;n++<t.length&&"{"!=t.charAt(n););if(n<t.length){const i=t.substring(0,n+1),s=t.substring(n+1);t=i+e+s}}if(s){const i=t.lastIndexOf("}");t=t.substring(0,i),t+=s+"\n}"}return t}}Jf.AutoSamplerSuffix="Sampler",Jf.LeftOvertUBOName="LeftOver",Jf.InternalsUBOName="Internals",Jf.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,vec3:3,ivec3:3,vec4:4,ivec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16},Jf.TZ={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"},Jf.RZ={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"},Jf.IZ={textureCube:wf.Cube,textureCubeArray:wf.CubeArray,texture2D:wf.E2d,texture2DArray:wf.E2dArray,texture3D:wf.E3d},Jf.MZ={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},Jf.bZ={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1};class td{constructor(t,i){this.hn="unnamed",this.shaderProcessingContext=t,this._Z={},this.engine=i}get isAsync(){return!1}get isReady(){return!!this.stages}rn(){}ln(t,i,e,s,n,r,h,o){const a=this.engine;t._s="",t.bs="";const l=this.shaderProcessingContext.availableTextures;let c;for(c=0;c<n.length;c++){const t=n[c],i=l[n[c]];null==i||null==i?(n.splice(c,1),c--):r[t]=c}for(const t of a.getAttributes(this,h))o.push(t);this.buildUniformLayout();const u=[],f=[];for(c=0;c<h.length;c++){const t=o[c];t>=0&&(u.push(h[c]),f.push(t))}this.shaderProcessingContext.attributeNamesFromEffect=u,this.shaderProcessingContext.attributeLocationsFromEffect=f}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new ne(this.engine,void 0,void 0,"leftOver-"+this.hn);for(const t of this.shaderProcessingContext.leftOverUniforms){const i=t.type.replace(/^(.*?)(<.*>)?$/,"$1"),e=Jf.UniformSizes[i];this.uniformBuffer.addUniform(t.name,e,t.length),this._Z[t.name]=t.type}this.uniformBuffer.create()}}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(t,i){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateInt(t,i)}setInt2(t,i,e){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateInt2(t,i,e)}setInt3(t,i,e,s){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateInt3(t,i,e,s)}setInt4(t,i,e,s,n){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateInt4(t,i,e,s,n)}setIntArray(t,i){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateIntArray(t,i)}setIntArray2(t,i){this.setIntArray(t,i)}setIntArray3(t,i){this.setIntArray(t,i)}setIntArray4(t,i){this.setIntArray(t,i)}setUInt(t,i){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateUInt(t,i)}setUInt2(t,i,e){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateUInt2(t,i,e)}setUInt3(t,i,e,s){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateUInt3(t,i,e,s)}setUInt4(t,i,e,s,n){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateUInt4(t,i,e,s,n)}setUIntArray(t,i){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateUIntArray(t,i)}setUIntArray2(t,i){this.setUIntArray(t,i)}setUIntArray3(t,i){this.setUIntArray(t,i)}setUIntArray4(t,i){this.setUIntArray(t,i)}setArray(t,i){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateArray(t,i)}setArray2(t,i){this.setArray(t,i)}setArray3(t,i){this.setArray(t,i)}setArray4(t,i){this.setArray(t,i)}setMatrices(t,i){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateMatrices(t,i)}setMatrix(t,i){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateMatrix(t,i)}setMatrix3x3(t,i){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateMatrix3x3(t,i)}setMatrix2x2(t,i){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateMatrix2x2(t,i)}setFloat(t,i){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateFloat(t,i)}setVector2(t,i){this.setFloat2(t,i.x,i.y)}setFloat2(t,i,e){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateFloat2(t,i,e)}setVector3(t,i){this.setFloat3(t,i.x,i.y,i.z)}setFloat3(t,i,e,s){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateFloat3(t,i,e,s)}setVector4(t,i){this.setFloat4(t,i.x,i.y,i.z,i.w)}setQuaternion(t,i){this.setFloat4(t,i.x,i.y,i.z,i.w)}setFloat4(t,i,e,s,n){this.uniformBuffer&&this._Z[t]&&this.uniformBuffer.updateFloat4(t,i,e,s,n)}setColor3(t,i){this.setFloat3(t,i.r,i.g,i.b)}setColor4(t,i,e){this.setFloat4(t,i.r,i.g,i.b,e)}setDirectColor4(t,i){this.setFloat4(t,i.r,i.g,i.b,i.a)}en(){var t;return null===(t=this.sources)||void 0===t?void 0:t.vertex}sn(){var t;return null===(t=this.sources)||void 0===t?void 0:t.fragment}}const id={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class ed{constructor(t){this.shaderLanguage=t,this.yZ=0,this.NZ=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],this.PZ()}static get KnownUBOs(){return ed.DZ?ed.LZ:ed.OZ}PZ(){const t=ed.KnownUBOs,i=[];for(const e in t){const s=t[e].binding;-1!==s.groupIndex&&(void 0===i[s.groupIndex]?i[s.groupIndex]=s.bindingIndex:i[s.groupIndex]=Math.max(i[s.groupIndex],s.bindingIndex))}this.freeGroupIndex=i.length-1,0===this.freeGroupIndex?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=i[i.length-1]+1}getAttributeNextLocation(t,i=0){var e;const s=this.yZ;return this.yZ+=(null!==(e=id[t])&&void 0!==e?e:1)*(i||1),s}getVaryingNextLocation(t,i=0){var e;const s=this.NZ;return this.NZ+=(null!==(e=id[t])&&void 0!==e?e:1)*(i||1),s}getNextFreeUBOBinding(){return this.FZ(1)}FZ(t){if(this.freeBindingIndex>65536-t&&(this.freeGroupIndex++,this.freeBindingIndex=0),4===this.freeGroupIndex)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";const i={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=t,i}}ed.DZ=!0,ed.LZ={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},ed.OZ={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}};class sd extends Jf{constructor(){super(...arguments),this.BZ=[],this.UZ=[],this.VZ=!1,this.kZ=!1,this.shaderLanguage=qt.GLSL,this.parseGLES3=!0}pZ(t,i,e){let s=0;const n=t.indexOf("["),r=t.indexOf("]");if(n>0&&r>0){const i=t.substring(n+1,r);s=+i,isNaN(s)&&(s=+e[i.trim()]),t=t.substr(0,n)}return[t,i,s]}initializeShaders(t){this.mZ=t,this.BZ.length=0,this.UZ.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(t,i){const e=`// Internals UBO\r\nuniform ${Jf.InternalsUBOName} {\nfloat yFactor_;\nfloat textureOutputHeight_;\n};\n`,s=-1!==t.indexOf("// Internals UBO");return i?(this.kZ=-1!==t.indexOf("#version 3"),this.kZ&&(this.varyingFragmentKeywordName="in"),s?t:e+"##INJECTCODE##\n"+t):(this.VZ=-1!==t.indexOf("#version 3"),this.VZ&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),s?t:e+t)}varyingProcessor(t,i,e){this.GZ=e;const s=(i&&this.kZ?/\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:!i&&this.VZ?/\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm).exec(t);if(null!==s){const n=s[1],r=s[2];let h;i?(h=this.mZ.availableVaryings[r],this.BZ[h]="",void 0===h&&F.Warn(`Invalid fragment shader: The varying named "${r}" is not declared in the vertex shader! This declaration will be ignored.`)):(h=this.mZ.getVaryingNextLocation(n,this.pZ(r,n,e)[2]),this.mZ.availableVaryings[r]=h,this.BZ[h]=`layout(location = ${h}) in ${n} ${r};`),t=t.replace(s[0],void 0===h?"":`layout(location = ${h}) ${i?"in":"out"} ${n} ${r};`)}return t}attributeProcessor(t,i){this.GZ=i;const e=(this.VZ?/\s*in\s+(\S+)\s+(\S+)\s*;/gm:/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm).exec(t);if(null!==e){const s=e[1],n=e[2],r=this.mZ.getAttributeNextLocation(s,this.pZ(n,s,i)[2]);this.mZ.availableAttributes[n]=r,this.mZ.orderedAttributes[r]=n,t=t.replace(e[0],`layout(location = ${r}) in ${s} ${n};`)}return t}uniformProcessor(t,i,e){var s;this.GZ=e;const n=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(t);if(null!==n){let r=n[1],h=n[2];if(0===r.indexOf("sampler")||1===r.indexOf("sampler")){let n=0;[h,r,n]=this.pZ(h,r,e);let o=this.mZ.availableTextures[h];if(!o){o={autoBindSampler:!0,isTextureArray:n>0,isStorageTexture:!1,textures:[],sampleType:Nf.Float};for(let t=0;t<(n||1);++t)o.textures.push(this.mZ.getNextFreeUBOBinding())}const a=null!==(s=Jf.MZ[r])&&void 0!==s?s:"sampler",l=!!Jf.bZ[a],c=l?yf.Comparison:yf.Filtering,u=h+Jf.AutoSamplerSuffix;let f=this.mZ.availableSamplers[u];f||(f={binding:this.mZ.getNextFreeUBOBinding(),type:c});const d="u"===r.charAt(0)?"u":"i"===r.charAt(0)?"i":"";d&&(r=r.substr(1));const p=l?Nf.Depth:"u"===d?Nf.Uint:"i"===d?Nf.Sint:Nf.Float;o.sampleType=p;const m=n>0,v=f.binding.groupIndex,g=f.binding.bindingIndex,S=Jf.TZ[r],E=Jf.RZ[r],A=Jf.IZ[E];if(m){const i=[];i.push(`layout(set = ${v}, binding = ${g}) uniform ${d}${a} ${u};`),t="\r\n";for(let e=0;e<n;++e){const s=o.textures[e].groupIndex,n=o.textures[e].bindingIndex;i.push(`layout(set = ${s}, binding = ${n}) uniform ${E} ${h}Texture${e};`),t+=`${e>0?"\r\n":""}#define ${h}${e} ${d}${S}(${h}Texture${e}, ${u})`}t=i.join("\r\n")+t,this.UZ.push(h)}else n=1,t=`layout(set = ${v}, binding = ${g}) uniform ${d}${a} ${u};\n                        layout(set = ${o.textures[0].groupIndex}, binding = ${o.textures[0].bindingIndex}) uniform ${E} ${h}Texture;\n                        #define ${h} ${d}${S}(${h}Texture, ${u})`;this.mZ.availableTextures[h]=o,this.mZ.availableSamplers[u]=f,this.wZ(u,f,!i);for(let t=0;t<n;++t)this.CZ(h,o,t,A,null,!i)}else this.dZ(h,r,e),t=""}return t}uniformBufferProcessor(t,i){const e=/uniform\s+(\w+)/gm.exec(t);if(null!==e){const s=e[1];let n=this.mZ.availableBuffers[s];if(!n){const t=ed.KnownUBOs[s];let i;i=t&&-1!==t.binding.groupIndex?t.binding:this.mZ.getNextFreeUBOBinding(),n={binding:i},this.mZ.availableBuffers[s]=n}this.gZ(s,n,_f.Uniform,!i),t=t.replace("uniform",`layout(set = ${n.binding.groupIndex}, binding = ${n.binding.bindingIndex}) uniform`)}return t}postProcessor(t,i,e,s,n){const r=-1!==t.search(/#extension.+GL_EXT_draw_buffers.+require/);if(t=(t=t.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),e){const i=t.indexOf("gl_FragCoord")>=0,e="\n                glFragCoord_ = gl_FragCoord;\n                if (yFactor_ == 1.) {\n                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;\n                }\n            ",s=i?"vec4 glFragCoord_;\n":"";if(t=(t=(t=(t=(t=(t=(t=t.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/gl_FragCoord/g,"glFragCoord_"),this.kZ){const i=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(t);null!==i&&(t=t.substring(0,i.index)+"layout(location = 0) "+t.substring(i.index))}else t=t.replace(/void\s+?main\s*\(/g,(r?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");t=(t=t.replace(/dFdy/g,"(-yFactor_)*dFdy")).replace("##INJECTCODE##",s),i&&(t=this.xZ(t,"void main",e))}else{t=(t=t.replace(/gl_InstanceID/g,"gl_InstanceIndex")).replace(/gl_VertexID/g,"gl_VertexIndex");if(-1!==i.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+t}if(!e){const i=t.lastIndexOf("}");t=t.substring(0,i),t+="gl_Position.y *= yFactor_;\n",n.isNDCHalfZRange||(t+="gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0;\n"),t+="}"}return t}zZ(t,i){const e=new RegExp(i+"\\s*\\[(.+)?\\]","gm");let s=e.exec(t);for(;null!==s;){const n=s[1];let r=+n;this.GZ&&isNaN(r)&&(r=+this.GZ[n.trim()]),t=t.replace(s[0],i+r),s=e.exec(t)}return t}SZ(t,i){let e=`layout(set = ${i.binding.groupIndex}, binding = ${i.binding.bindingIndex}) uniform ${t} {\n    `;for(const t of this.mZ.leftOverUniforms)t.length>0?e+=`    ${t.type} ${t.name}[${t.length}];\n`:e+=`    ${t.type} ${t.name};\n`;return e+="};\n\n",e}finalizeShaders(t,i){for(let e=0;e<this.UZ.length;++e){const s=this.UZ[e];t=this.zZ(t,s),i=this.zZ(i,s)}for(let t=0;t<this.BZ.length;++t){const e=this.BZ[t];e&&e.length>0&&(i=e+"\n"+i)}const e=this.vZ();return t=e+t,i=e+i,this.EZ(),this.AZ(),this.GZ=null,{vertexCode:t,fragmentCode:i}}}const nd="bonesDeclaration",rd="#if NUM_BONE_INFLUENCERS>0\nattribute matricesIndices : vec4<f32>;\nattribute matricesWeights : vec4<f32>;\n#if NUM_BONE_INFLUENCERS>4\nattribute matricesIndicesExtra : vec4<f32>;\nattribute matricesWeightsExtra : vec4<f32>;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nvar boneSampler : texture_2d<f32>;\nuniform boneTextureWidth : f32;\n#else\nuniform mBones : array<mat4x4,BonesPerMesh>;\n#ifdef BONES_VELOCITY_ENABLED\nuniform mPreviousBones : array<mat4x4,BonesPerMesh>;\n#endif\n#endif\n#ifdef BONETEXTURE\nfn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>\n{\nlet offset=i32(index) *4; \nlet m0=textureLoad(smp,vec2<i32>(offset+0,0),0);\nlet m1=textureLoad(smp,vec2<i32>(offset+1,0),0);\nlet m2=textureLoad(smp,vec2<i32>(offset+2,0),0);\nlet m3=textureLoad(smp,vec2<i32>(offset+3,0),0);\nreturn mat4x4<f32>(m0,m1,m2,m3);\n}\n#endif\n#endif\n#endif\n";ii.IncludesShadersStoreWGSL[nd]=rd;const hd="bonesVertex",od="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nvar influence : mat4x4<f32>;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];\n#endif \n#else \ninfluence=uniforms.mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+uniforms.mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+uniforms.mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+uniforms.mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+uniforms.mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+uniforms.mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+uniforms.mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+uniforms.mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif \n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";ii.IncludesShadersStoreWGSL[hd]=od;const ad="bakedVertexAnimationDeclaration",ld="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform bakedVertexAnimationTime: f32;\nuniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;\nuniform bakedVertexAnimationSettings: vec4<f32>;\nvar bakedVertexAnimationTexture : texture_2d<f32>;\n#ifdef INSTANCES\nattribute bakedVertexAnimationSettingsInstanced : vec4<f32>;\n#endif\nfn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>\n{\nlet offset=i32(index)*4;\nlet frameUV=i32(frame);\nlet m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);\nlet m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);\nlet m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);\nlet m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);\nreturn mat4x4<f32>(m0,m1,m2,m3);\n}\n#endif\n";ii.IncludesShadersStoreWGSL[ad]=ld;const cd="bakedVertexAnimation",ud="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\nlet VATStartFrame: f32=bakedVertexAnimationSettingsInstanced.x;\nlet VATEndFrame: f32=bakedVertexAnimationSettingsInstanced.y;\nlet VATOffsetFrame: f32=bakedVertexAnimationSettingsInstanced.z;\nlet VATSpeed: f32=bakedVertexAnimationSettingsInstanced.w;\n#else\nlet VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;\nlet VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;\nlet VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;\nlet VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;\n#endif\nlet totalFrames: f32=VATEndFrame-VATStartFrame+1.0;\nlet time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;\nlet frameCorrection: f32=select(1.0,0.0,time<1.0);\nlet numOfFrames: f32=totalFrames-frameCorrection;\nvar VATFrameNum: f32=fract(time)*numOfFrames;\nVATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;\nVATFrameNum=floor(VATFrameNum);\nVATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;\nvar VATInfluence : mat4x4<f32>;\nVATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;\n}\n#endif\n";ii.IncludesShadersStoreWGSL[cd]=ud;const fd="clipPlaneFragment",dd="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE2\nelse if (fClipDistance2>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE3\nelse if (fClipDistance3>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE4\nelse if (fClipDistance4>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE5\nelse if (fClipDistance5>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE6\nelse if (fClipDistance6>0.0)\n{\ndiscard;\n}\n#endif\n";ii.IncludesShadersStoreWGSL[fd]=dd;const pd="clipPlaneFragmentDeclaration",md="#ifdef CLIPPLANE\nvarying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nvarying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nvarying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nvarying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nvarying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nvarying fClipDistance6: f32;\n#endif\n";ii.IncludesShadersStoreWGSL[pd]=md;const vd="clipPlaneVertex",gd="#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,uniforms.vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nfClipDistance2=dot(worldPos,uniforms.vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nfClipDistance3=dot(worldPos,uniforms.vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nfClipDistance4=dot(worldPos,uniforms.vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nfClipDistance5=dot(worldPos,uniforms.vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nfClipDistance6=dot(worldPos,uniforms.vClipPlane6);\n#endif\n";ii.IncludesShadersStoreWGSL[vd]=gd;const Sd="clipPlaneVertexDeclaration",Ed="#ifdef CLIPPLANE\nuniform vClipPlane: vec4<f32>;\nvarying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nuniform vClipPlane2: vec4<f32>;\nvarying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nuniform vClipPlane3: vec4<f32>;\nvarying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nuniform vClipPlane4: vec4<f32>;\nvarying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nuniform vClipPlane5: vec4<f32>;\nvarying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nuniform vClipPlane6: vec4<f32>;\nvarying fClipDistance6: f32;\n#endif\n";ii.IncludesShadersStoreWGSL[Sd]=Ed;const Ad="instancesDeclaration",Cd="#ifdef INSTANCES\nattribute world0 : vec4<f32>;\nattribute world1 : vec4<f32>;\nattribute world2 : vec4<f32>;\nattribute world3 : vec4<f32>;\n#ifdef INSTANCESCOLOR\nattribute instanceColor : vec4<f32>;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nattribute previousWorld0 : vec4<f32>;\nattribute previousWorld1 : vec4<f32>;\nattribute previousWorld2 : vec4<f32>;\nattribute previousWorld3 : vec4<f32>;\n#ifdef THIN_INSTANCES\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n";ii.IncludesShadersStoreWGSL[Ad]=Cd;const wd="instancesVertex",xd="#ifdef INSTANCES\nvar finalWorld=mat4x4<f32>(world0,world1,world2,world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nvar finalPreviousWorld=mat4x4<f32>(previousWorld0,previousWorld1,previousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\n#if !defined(WORLD_UBO)\nfinalWorld=uniforms.world*finalWorld;\n#else\nfinalWorld=mesh.world*finalWorld;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nvar finalWorld=uniforms.world;\n#else\nvar finalWorld=mesh.world;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nvar finalPreviousWorld=previousWorld;\n#endif\n#endif\n";ii.IncludesShadersStoreWGSL[wd]=xd;const Td="meshUboDeclaration",Rd="struct Mesh {\nworld : mat4x4<f32>,\nvisibility : f32,\n};\nvar<uniform> mesh : Mesh;\n#define WORLD_UBO\n";ii.IncludesShadersStoreWGSL[Td]=Rd;const Id="morphTargetsVertex",Md="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE \nvertexID=f32(gl_VertexID)*uniforms.morphTargetTextureInfo.x;\npositionUpdated=positionUpdated+(readVector3FromRawSampler({X},vertexID)-position)*uniforms.morphTargetInfluences[{X}];\nvertexID=vertexID+1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated=normalUpdated+(readVector3FromRawSampler({X},vertexID) -normal)*uniforms.morphTargetInfluences[{X}];\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(readVector3FromRawSampler({X},vertexID).xy-uv)*uniforms.morphTargetInfluences[{X}];\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz=tangentUpdated.xyz+(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*uniforms.morphTargetInfluences[{X}];\n#endif\n#else\npositionUpdated=positionUpdated+(position{X}-position)*uniforms.morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz=tangentUpdated.xyz+(tangent{X}-tangent.xyz)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(uv_{X}-uv)*uniforms.morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";ii.IncludesShadersStoreWGSL[Id]=Md;const bd="morphTargetsVertexDeclaration",_d="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute position{X} : vec3<f32>;\n#ifdef MORPHTARGETS_NORMAL\nattribute normal{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute tangent{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_UV\nattribute uv_{X} : vec2<f32>;\n#endif\n#endif\n#endif\n";ii.IncludesShadersStoreWGSL[bd]=_d;const yd="morphTargetsVertexGlobal",Nd="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nvar vertexID : f32;\n#endif\n#endif\n";ii.IncludesShadersStoreWGSL[yd]=Nd;const Pd="morphTargetsVertexGlobalDeclaration",Dd="#ifdef MORPHTARGETS\nuniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;\n#ifdef MORPHTARGETS_TEXTURE \nuniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;\nuniform morphTargetTextureInfo : vec3<f32>;\nvar morphTargets : texture_2d_array<f32>;\nvar morphTargetsSampler : sampler;\nfn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>\n{ \nlet y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);\nlet x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;\nlet textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);\nreturn textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;\n}\n#endif\n#endif\n";ii.IncludesShadersStoreWGSL[Pd]=Dd;const Ld="sceneUboDeclaration",Od="struct Scene {\nviewProjection : mat4x4<f32>,\n#ifdef MULTIVIEW\nviewProjectionR : mat4x4<f32>,\n#endif \nview : mat4x4<f32>,\nprojection : mat4x4<f32>,\nvEyePosition : vec4<f32>,\n};\nvar<uniform> scene : Scene;\n";ii.IncludesShadersStoreWGSL[Ld]=Od;const Fd="gl_VertexID",Bd="gl_InstanceID",Ud="gl_Position",Vd="gl_FragCoord",kd="gl_FrontFacing",Gd="gl_FragDepth",zd="gl_FragColor",Hd={texture_1d:wf.E1d,texture_2d:wf.E2d,texture_2d_array:wf.E2dArray,texture_3d:wf.E3d,texture_cube:wf.Cube,texture_cube_array:wf.CubeArray,texture_multisampled_2d:wf.E2d,texture_depth_2d:wf.E2d,texture_depth_2d_array:wf.E2dArray,texture_depth_cube:wf.Cube,texture_depth_cube_array:wf.CubeArray,texture_depth_multisampled_2d:wf.E2d,texture_storage_1d:wf.E1d,texture_storage_2d:wf.E2d,texture_storage_2d_array:wf.E2dArray,texture_storage_3d:wf.E3d,texture_external:null};class Xd extends Jf{constructor(){super(...arguments),this.shaderLanguage=qt.WGSL,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0}pZ(t,i,e){let s=0;const n=i.lastIndexOf(">");if(i.indexOf("array")>=0&&n>0){let t=n;for(;t>0&&" "!==i.charAt(t)&&","!==i.charAt(t);)t--;const r=i.substring(t+1,n);for(s=+r,isNaN(s)&&(s=+e[r.trim()]);t>0&&(" "===i.charAt(t)||","===i.charAt(t));)t--;i=i.substring(i.indexOf("<")+1,t+1)}return[t,i,s]}initializeShaders(t){this.mZ=t,this.HZ=[],this.XZ=[],this.WZ=[],this.$Z=[],this.YZ=[],this.jZ=[],this.KZ=[]}preProcessShaderCode(t){return`struct ${Jf.InternalsUBOName} {\nyFactor_: f32,\ntextureOutputHeight_: f32,\n};\nvar<uniform> internals : ${Jf.InternalsUBOName};\n`+nf(t)}varyingProcessor(t,i,e){const s=/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(t);if(null!==s){const n=s[2],r=s[1];let h;i?(h=this.mZ.availableVaryings[r],void 0===h&&F.Warn(`Invalid fragment shader: The varying named "${r}" is not declared in the vertex shader! This declaration will be ignored.`)):(h=this.mZ.getVaryingNextLocation(n,this.pZ(r,n,e)[2]),this.mZ.availableVaryings[r]=h,this.$Z.push(`@location(${h}) ${r} : ${n},`),this.YZ.push(`var<private> ${r} : ${n};`),this.jZ.push(r)),t=""}return t}attributeProcessor(t,i){const e=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(t);if(null!==e){const s=e[2],n=e[1],r=this.mZ.getAttributeNextLocation(s,this.pZ(n,s,i)[2]);this.mZ.availableAttributes[n]=r,this.mZ.orderedAttributes[r]=n,this.HZ.push(`@location(${r}) ${n} : ${s},`),this.XZ.push(`var<private> ${n} : ${s};`),this.WZ.push(n),t=""}return t}uniformProcessor(t,i,e){const s=this.uniformRegexp.exec(t);if(null!==s){const i=s[2],n=s[1];this.dZ(n,i,e),t=""}return t}textureProcessor(t,i,e){const s=this.textureRegexp.exec(t);if(null!==s){const n=s[1],r=s[2],h=!!s[3],o=s[4],a=o.indexOf("storage")>0,l=s[6],c=a?l.substring(0,l.indexOf(",")).trim():null;let u=h?this.pZ(n,r,e)[2]:0,f=this.mZ.availableTextures[n];if(f)u=f.textures.length;else{f={isTextureArray:u>0,isStorageTexture:a,textures:[],sampleType:Nf.Float},u=u||1;for(let t=0;t<u;++t)f.textures.push(this.mZ.getNextFreeUBOBinding())}this.mZ.availableTextures[n]=f;const d=o.indexOf("depth")>0,p=Hd[o],m=d?Nf.Depth:"u32"===l?Nf.Uint:"i32"===l?Nf.Sint:Nf.Float;if(f.sampleType=m,void 0===p)throw`Can't get the texture dimension corresponding to the texture function "${o}"!`;for(let e=0;e<u;++e){const{groupIndex:s,bindingIndex:r}=f.textures[e];0===e&&(t=`@group(${s}) @binding(${r}) ${t}`),this.CZ(n,f,e,p,c,!i)}}return t}postProcessor(t){return t}finalizeShaders(t,i){const e=i.indexOf("gl_FragCoord")>=0?"\n            if (internals.yFactor_ == 1.) {\n                gl_FragCoord.y = internals.textureOutputHeight_ - gl_FragCoord.y;\n            }\n        ":"";t=this.qZ(t,!0),i=this.qZ(i,!1),t=this.QZ(t,!0),i=this.QZ(i,!1);const s=this.vZ();i=s+i,t=(t=s+t).replace(/#define /g,"//#define "),t=this.ZZ(t);const n=this.YZ.join("\n")+"\n",r=`var<private> ${Fd} : u32;\nvar<private> ${Bd} : u32;\nvar<private> ${Ud} : vec4<f32>;\n`,h=this.XZ.join("\n")+"\n";let o="struct VertexInputs {\n  @builtin(vertex_index) vertexIndex : u32,\n  @builtin(instance_index) instanceIndex : u32,\n";this.HZ.length>0&&(o+=this.HZ.join("\n")),o+="\n};\n";let a="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n";this.$Z.length>0&&(a+=this.$Z.join("\n")),a+="\n};\n",t=r+o+h+a+n+t;let l=`  var output : FragmentInputs;\n  ${Fd} = input.vertexIndex;\n  ${Bd} = input.instanceIndex;\n`;for(let t=0;t<this.WZ.length;++t){const i=this.WZ[t];l+=`  ${i} = input.${i};\n`}let c=`  output.position = ${Ud};\n  output.position.y = output.position.y * internals.yFactor_;\n`;for(let t=0;t<this.jZ.length;++t){const i=this.jZ[t];c+=`  output.${i} = ${i};\n`}c+="  return output;",t=this.xZ(t,"fn main",l,c),i=i.replace(/#define /g,"//#define "),i=(i=this.ZZ(i)).replace(/dpdy/g,"(-internals.yFactor_)*dpdy");const u=`var<private> ${Vd} : vec4<f32>;\nvar<private> ${kd} : bool;\nvar<private> ${zd} : vec4<f32>;\nvar<private> ${Gd} : f32;\n`;let f="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n  @builtin(front_facing) frontFacing : bool,\n";this.$Z.length>0&&(f+=this.$Z.join("\n")),f+="\n};\n";let d="struct FragmentOutputs {\n  @location(0) color : vec4<f32>,\n",p=!1,m=0;for(;!(p||(m=i.indexOf(Gd,m),m<0));){const t=m;for(p=!0;m>1&&"\n"!==i.charAt(m);){if("/"===i.charAt(m)&&"/"===i.charAt(m-1)){p=!1;break}m--}m=t+Gd.length}p&&(d+="  @builtin(frag_depth) fragDepth: f32,\n"),d+="};\n",i=u+f+n+d+i;let v=`  var output : FragmentOutputs;\n  ${Vd} = input.position;\n  ${kd} = input.frontFacing;\n`+e;for(let t=0;t<this.jZ.length;++t){const i=this.jZ[t];v+=`  ${i} = input.${i};\n`}let g=`  output.color = ${zd};\n`;return p&&(g+=`  output.fragDepth = ${Gd};\n`),g+="  return output;",i=this.xZ(i,"fn main",v,g),this.EZ(),this.AZ(),{vertexCode:t,fragmentCode:i}}SZ(t,i){let e="",s=`struct ${t} {\n`;for(const i of this.mZ.leftOverUniforms){const n=i.type.replace(/^(.*?)(<.*>)?$/,"$1"),r=Jf.UniformSizes[n];if(i.length>0)if(r<=2){const r=`${t}_${this.KZ.length}_strided_arr`;e+=`struct ${r} {\n                        @size(16)\n                        el: ${n},\n                    }`,this.KZ.push(i.name),s+=` @align(16) ${i.name} : array<${r}, ${i.length}>,\n`}else s+=` ${i.name} : array<${i.type}, ${i.length}>,\n`;else s+=`  ${i.name} : ${i.type},\n`}return s+="};\n",s=`${e}\n${s}`,s+=`@group(${i.binding.groupIndex}) @binding(${i.binding.bindingIndex}) var<uniform> uniforms : ${t};\n`,s}qZ(t,i){const e=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const s=e.exec(t);if(null===s)break;const n=s[1],r=s[2],h=n.indexOf(Jf.AutoSamplerSuffix)===n.length-Jf.AutoSamplerSuffix.length?n.substring(0,n.indexOf(Jf.AutoSamplerSuffix)):null,o="sampler_comparison"===r?yf.Comparison:yf.Filtering;if(h){const t=this.mZ.availableTextures[h];t&&(t.autoBindSampler=!0)}let a=this.mZ.availableSamplers[n];a||(a={binding:this.mZ.getNextFreeUBOBinding(),type:o},this.mZ.availableSamplers[n]=a),this.wZ(n,a,i);const l=t.substring(0,s.index),c=`@group(${a.binding.groupIndex}) @binding(${a.binding.bindingIndex}) `,u=t.substring(s.index);t=l+c+u,e.lastIndex+=c.length}return t}QZ(t,i){const e=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const s=e.exec(t);if(null===s)break;const n=s[1],r=s[3];let h=s[4];const o=s[5];let a=this.mZ.availableBuffers[h];if(!a){const t="uniform"===n?ed.KnownUBOs[o]:null;let i;t?(h=o,i=t.binding,-1===i.groupIndex&&(i=this.mZ.getNextFreeUBOBinding())):i=this.mZ.getNextFreeUBOBinding(),a={binding:i},this.mZ.availableBuffers[h]=a}this.gZ(h,this.mZ.availableBuffers[h],"read_write"===r?_f.Storage:"storage"===n?_f.ReadOnlyStorage:_f.Uniform,i);const l=a.binding.groupIndex,c=a.binding.bindingIndex,u=t.substring(0,s.index),f=`@group(${l}) @binding(${c}) `,d=t.substring(s.index);t=u+f+d,e.lastIndex+=f.length}return t}ZZ(t){for(const i of this.KZ)t=t.replace(new RegExp(`${i}\\s*\\[(.*)\\]`,"g"),`${i}[$1].el`);return t}}class Wd{constructor(t=null){this.format=Tf.RGBA8Unorm,this.textureUsages=0,this.textureAdditionalUsages=0,this.JZ=t,this.tJ=null,this.view=null,this.viewForWriting=null}get underlyingResource(){return this.JZ}get msaaTexture(){return this.tJ}set msaaTexture(t){this.tJ=t}set(t){this.JZ=t}setUsage(t,i,e,s,n){i=t!==oi.RenderTarget&&i,this.createView({format:this.format,dimension:e?wf.Cube:wf.E2d,mipLevelCount:i?o.ILog2(Math.max(s,n))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:e?6:1,aspect:xf.All})}createView(t,i=!1){if(this.view=this.JZ.createView(t),i&&t){const i=t.mipLevelCount;t.mipLevelCount=1,this.viewForWriting=this.JZ.createView(t),t.mipLevelCount=i}}reset(){this.JZ=null,this.tJ=null,this.view=null,this.viewForWriting=null}release(){var t,i,e;null===(t=this.JZ)||void 0===t||t.destroy(),null===(i=this.tJ)||void 0===i||i.destroy(),null===(e=this.iJ)||void 0===e||e.destroy(),this.reset()}}const $d="\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) out flat ivec2 vTextureSize;\n    #endif\n\n    void main() {\n        #ifdef INVERTY\n            vTextureSize = textureSize(img, 0);\n        #endif\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",Yd=$d;var jd,Kd;!function(t){t[t.MipMap=0]="MipMap",t[t.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",t[t.Clear=2]="Clear",t[t.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst"}(jd||(jd={})),function(t){t[t.DontInvertY=0]="DontInvertY",t[t.InvertY=1]="InvertY"}(Kd||(Kd={}));const qd=[{vertex:"\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(location = 0) out vec2 vTex;\n\n    void main() {\n        vTex = tex[gl_VertexIndex];\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    layout(set = 0, binding = 0) uniform sampler imgSampler;\n    layout(set = 0, binding = 1) uniform texture2D img;\n\n    layout(location = 0) in vec2 vTex;\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = texture(sampler2D(img, imgSampler), vTex);\n    }\n    "},{vertex:$d,fragment:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, vTextureSize.y - gl_FragCoord.y), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    "},{vertex:"\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n\n    void main() {\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    layout(set = 0, binding = 0) uniform Uniforms {\n        uniform vec4 color;\n    };\n\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = color;\n    }\n    "},{vertex:Yd,fragment:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n    layout(set = 0, binding = 1) uniform Params {\n        float ofstX;\n        float ofstY;\n        float width;\n        float height;\n    };\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        if (gl_FragCoord.x < ofstX || gl_FragCoord.x >= ofstX + width) {\n            discard;\n        }\n        if (gl_FragCoord.y < ofstY || gl_FragCoord.y >= ofstY + height) {\n            discard;\n        }\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, ofstY + height - (gl_FragCoord.y - ofstY)), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    "}],Qd={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2unorm:22,rg32uint:23,rg32sint:24,rg32float:25,rgba16uint:26,rgba16sint:27,rgba16float:28,rgba32uint:29,rgba32sint:30,rgba32float:31,stencil8:32,depth16unorm:33,depth24plus:34,"depth24plus-stencil8":35,depth32float:36,"depth24unorm-stencil8":37,"depth32float-stencil8":38};class Zd{constructor(t,i,e,s){this.eJ={},this.sJ=[],this.nJ={},this.rJ=[],this.hJ=[],this.oJ=t,this.aJ=i,this.lJ=e,this.cJ=s,this.uJ=t.createSampler({minFilter:If.Linear}),this.fJ=t.createSampler({minFilter:If.Linear}),this.dJ=this.cJ.createBuffer(16,Sf.Uniform|Sf.CopyDst).underlyingResource,this.pJ(Tf.RGBA8Unorm),this.mJ(Tf.RGBA8Unorm)}static ComputeNumMipmapLevels(t,i){return o.ILog2(Math.max(t,i))+1}pJ(t,i=jd.MipMap,e){const s=i===jd.MipMap?1:i===jd.InvertYPremultiplyAlpha?((e.invertY?1:0)<<1)+((e.premultiplyAlpha?1:0)<<2):i===jd.Clear?8:i===jd.InvertYPremultiplyAlphaWithOfst?((e.invertY?1:0)<<4)+((e.premultiplyAlpha?1:0)<<5):0;this.eJ[t]||(this.eJ[t]=[]);let n=this.eJ[t][s];if(!n){let r="#version 450\r\n";i!==jd.InvertYPremultiplyAlpha&&i!==jd.InvertYPremultiplyAlphaWithOfst||(e.invertY&&(r+="#define INVERTY\r\n"),e.premultiplyAlpha&&(r+="#define PREMULTIPLYALPHA\r\n"));let h=this.sJ[s];if(!h){let t=this.aJ.compileGLSL(r+qd[i].vertex,"vertex"),e=this.aJ.compileGLSL(r+qd[i].fragment,"fragment");this.lJ&&(t=this.lJ.convertSpirV2WGSL(t),e=this.lJ.convertSpirV2WGSL(e));const n=this.oJ.createShaderModule({code:t}),o=this.oJ.createShaderModule({code:e});h=this.sJ[s]=[n,o]}const o=this.oJ.createRenderPipeline({layout:Lf.Auto,vertex:{module:h[0],entryPoint:"main"},fragment:{module:h[1],entryPoint:"main",targets:[{format:t}]},primitive:{topology:Of.TriangleStrip,stripIndexFormat:zf.Uint16}});n=this.eJ[t][s]=[o,o.getBindGroupLayout(0)]}return n}mJ(t,i=Kd.DontInvertY){const e=i===Kd.InvertY?1:0;this.nJ[t]||(this.nJ[t]=[]);let s=this.nJ[t][e];if(!s){let i=this.rJ[e];if(!i){const t=this.oJ.createShaderModule({code:"\n    struct VertexOutput {\n        @builtin(position) Position : vec4<f32>,\n        @location(0) fragUV : vec2<f32>\n    }\n  \n    @vertex\n    fn main(\n        @builtin(vertex_index) VertexIndex : u32\n    ) -> VertexOutput {\n        var pos = array<vec2<f32>, 4>(\n            vec2(-1.0,  1.0),\n            vec2( 1.0,  1.0),\n            vec2(-1.0, -1.0),\n            vec2( 1.0, -1.0)\n        );\n        var tex = array<vec2<f32>, 4>(\n            vec2(0.0, 0.0),\n            vec2(1.0, 0.0),\n            vec2(0.0, 1.0),\n            vec2(1.0, 1.0)\n        );\n\n        var output: VertexOutput;\n\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n        output.fragUV = tex[VertexIndex];\n\n        return output;\n    }\n    "}),s=this.oJ.createShaderModule({code:0===e?"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);\n    }\n    ":"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));\n    }\n    "});i=this.rJ[e]=[t,s]}const n=this.oJ.createRenderPipeline({label:`CopyVideoToTexture_${t}_${0===e?"DontInvertY":"InvertY"}`,layout:Lf.Auto,vertex:{module:i[0],entryPoint:"main"},fragment:{module:i[1],entryPoint:"main",targets:[{format:t}]},primitive:{topology:Of.TriangleStrip,stripIndexFormat:zf.Uint16}});s=this.nJ[t][e]=[n,n.getBindGroupLayout(0)]}return s}static vJ(t){switch(t){case Tf.R8Unorm:case Tf.R8Snorm:case Tf.R8Uint:case Tf.R8Sint:case Tf.RG8Unorm:case Tf.RG8Snorm:case Tf.RG8Uint:case Tf.RG8Sint:case Tf.RGBA8Unorm:case Tf.RGBA8UnormSRGB:case Tf.RGBA8Snorm:case Tf.RGBA8Uint:case Tf.RGBA8Sint:case Tf.BGRA8Unorm:case Tf.BGRA8UnormSRGB:case Tf.RGB10A2Unorm:case Tf.RGB9E5UFloat:case Tf.RG11B10UFloat:case Tf.Depth24UnormStencil8:case Tf.Depth32FloatStencil8:case Tf.BC7RGBAUnorm:case Tf.BC7RGBAUnormSRGB:case Tf.BC6HRGBUFloat:case Tf.BC6HRGBFloat:case Tf.BC5RGUnorm:case Tf.BC5RGSnorm:case Tf.BC3RGBAUnorm:case Tf.BC3RGBAUnormSRGB:case Tf.BC2RGBAUnorm:case Tf.BC2RGBAUnormSRGB:case Tf.BC4RUnorm:case Tf.BC4RSnorm:case Tf.BC1RGBAUnorm:case Tf.BC1RGBAUnormSRGB:case Tf.ETC2RGB8Unorm:case Tf.ETC2RGB8UnormSRGB:case Tf.ETC2RGB8A1Unorm:case Tf.ETC2RGB8A1UnormSRGB:case Tf.ETC2RGBA8Unorm:case Tf.ETC2RGBA8UnormSRGB:case Tf.EACR11Unorm:case Tf.EACR11Snorm:case Tf.EACRG11Unorm:case Tf.EACRG11Snorm:case Tf.ASTC4x4Unorm:case Tf.ASTC4x4UnormSRGB:case Tf.ASTC5x4Unorm:case Tf.ASTC5x4UnormSRGB:case Tf.ASTC5x5Unorm:case Tf.ASTC5x5UnormSRGB:case Tf.ASTC6x5Unorm:case Tf.ASTC6x5UnormSRGB:case Tf.ASTC6x6Unorm:case Tf.ASTC6x6UnormSRGB:case Tf.ASTC8x5Unorm:case Tf.ASTC8x5UnormSRGB:case Tf.ASTC8x6Unorm:case Tf.ASTC8x6UnormSRGB:case Tf.ASTC8x8Unorm:case Tf.ASTC8x8UnormSRGB:case Tf.ASTC10x5Unorm:case Tf.ASTC10x5UnormSRGB:case Tf.ASTC10x6Unorm:case Tf.ASTC10x6UnormSRGB:case Tf.ASTC10x8Unorm:case Tf.ASTC10x8UnormSRGB:case Tf.ASTC10x10Unorm:case Tf.ASTC10x10UnormSRGB:case Tf.ASTC12x10Unorm:case Tf.ASTC12x10UnormSRGB:case Tf.ASTC12x12Unorm:case Tf.ASTC12x12UnormSRGB:return 0;case Tf.R16Uint:case Tf.R16Sint:case Tf.RG16Uint:case Tf.RG16Sint:case Tf.RGBA16Uint:case Tf.RGBA16Sint:case Tf.Depth16Unorm:return 5;case Tf.R16Float:case Tf.RG16Float:case Tf.RGBA16Float:return 2;case Tf.R32Uint:case Tf.R32Sint:case Tf.RG32Uint:case Tf.RG32Sint:case Tf.RGBA32Uint:case Tf.RGBA32Sint:return 7;case Tf.R32Float:case Tf.RG32Float:case Tf.RGBA32Float:case Tf.Depth32Float:return 1;case Tf.Stencil8:throw"No fixed size for Stencil8 format!";case Tf.Depth24Plus:throw"No fixed size for Depth24Plus format!";case Tf.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!"}return 0}static gJ(t){switch(t){case Tf.R8Unorm:case Tf.R8Snorm:case Tf.R8Uint:case Tf.R8Sint:return{width:1,height:1,length:1};case Tf.R16Uint:case Tf.R16Sint:case Tf.R16Float:case Tf.RG8Unorm:case Tf.RG8Snorm:case Tf.RG8Uint:case Tf.RG8Sint:return{width:1,height:1,length:2};case Tf.R32Uint:case Tf.R32Sint:case Tf.R32Float:case Tf.RG16Uint:case Tf.RG16Sint:case Tf.RG16Float:case Tf.RGBA8Unorm:case Tf.RGBA8UnormSRGB:case Tf.RGBA8Snorm:case Tf.RGBA8Uint:case Tf.RGBA8Sint:case Tf.BGRA8Unorm:case Tf.BGRA8UnormSRGB:case Tf.RGB9E5UFloat:case Tf.RGB10A2Unorm:case Tf.RG11B10UFloat:return{width:1,height:1,length:4};case Tf.RG32Uint:case Tf.RG32Sint:case Tf.RG32Float:case Tf.RGBA16Uint:case Tf.RGBA16Sint:case Tf.RGBA16Float:return{width:1,height:1,length:8};case Tf.RGBA32Uint:case Tf.RGBA32Sint:case Tf.RGBA32Float:return{width:1,height:1,length:16};case Tf.Stencil8:throw"No fixed size for Stencil8 format!";case Tf.Depth16Unorm:return{width:1,height:1,length:2};case Tf.Depth24Plus:throw"No fixed size for Depth24Plus format!";case Tf.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!";case Tf.Depth32Float:case Tf.Depth24UnormStencil8:return{width:1,height:1,length:4};case Tf.Depth32FloatStencil8:return{width:1,height:1,length:5};case Tf.BC7RGBAUnorm:case Tf.BC7RGBAUnormSRGB:case Tf.BC6HRGBUFloat:case Tf.BC6HRGBFloat:case Tf.BC5RGUnorm:case Tf.BC5RGSnorm:case Tf.BC3RGBAUnorm:case Tf.BC3RGBAUnormSRGB:case Tf.BC2RGBAUnorm:case Tf.BC2RGBAUnormSRGB:return{width:4,height:4,length:16};case Tf.BC4RUnorm:case Tf.BC4RSnorm:case Tf.BC1RGBAUnorm:case Tf.BC1RGBAUnormSRGB:case Tf.ETC2RGB8Unorm:case Tf.ETC2RGB8UnormSRGB:case Tf.ETC2RGB8A1Unorm:case Tf.ETC2RGB8A1UnormSRGB:case Tf.EACR11Unorm:case Tf.EACR11Snorm:return{width:4,height:4,length:8};case Tf.ETC2RGBA8Unorm:case Tf.ETC2RGBA8UnormSRGB:case Tf.EACRG11Unorm:case Tf.EACRG11Snorm:case Tf.ASTC4x4Unorm:case Tf.ASTC4x4UnormSRGB:return{width:4,height:4,length:16};case Tf.ASTC5x4Unorm:case Tf.ASTC5x4UnormSRGB:return{width:5,height:4,length:16};case Tf.ASTC5x5Unorm:case Tf.ASTC5x5UnormSRGB:return{width:5,height:5,length:16};case Tf.ASTC6x5Unorm:case Tf.ASTC6x5UnormSRGB:return{width:6,height:5,length:16};case Tf.ASTC6x6Unorm:case Tf.ASTC6x6UnormSRGB:return{width:6,height:6,length:16};case Tf.ASTC8x5Unorm:case Tf.ASTC8x5UnormSRGB:return{width:8,height:5,length:16};case Tf.ASTC8x6Unorm:case Tf.ASTC8x6UnormSRGB:return{width:8,height:6,length:16};case Tf.ASTC8x8Unorm:case Tf.ASTC8x8UnormSRGB:return{width:8,height:8,length:16};case Tf.ASTC10x5Unorm:case Tf.ASTC10x5UnormSRGB:return{width:10,height:5,length:16};case Tf.ASTC10x6Unorm:case Tf.ASTC10x6UnormSRGB:return{width:10,height:6,length:16};case Tf.ASTC10x8Unorm:case Tf.ASTC10x8UnormSRGB:return{width:10,height:8,length:16};case Tf.ASTC10x10Unorm:case Tf.ASTC10x10UnormSRGB:return{width:10,height:10,length:16};case Tf.ASTC12x10Unorm:case Tf.ASTC12x10UnormSRGB:return{width:12,height:10,length:16};case Tf.ASTC12x12Unorm:case Tf.ASTC12x12UnormSRGB:return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static SJ(t){return!!t.release}static EJ(t){return!!t.dispose}static IsImageBitmap(t){return void 0!==t.close}static IsImageBitmapArray(t){return Array.isArray(t)&&void 0!==t[0].close}setCommandEncoder(t){this.AJ=t}static IsCompressedFormat(t){switch(t){case Tf.BC7RGBAUnormSRGB:case Tf.BC7RGBAUnorm:case Tf.BC6HRGBFloat:case Tf.BC6HRGBUFloat:case Tf.BC5RGSnorm:case Tf.BC5RGUnorm:case Tf.BC4RSnorm:case Tf.BC4RUnorm:case Tf.BC3RGBAUnormSRGB:case Tf.BC3RGBAUnorm:case Tf.BC2RGBAUnormSRGB:case Tf.BC2RGBAUnorm:case Tf.BC1RGBAUnormSRGB:case Tf.BC1RGBAUnorm:case Tf.ETC2RGB8Unorm:case Tf.ETC2RGB8UnormSRGB:case Tf.ETC2RGB8A1Unorm:case Tf.ETC2RGB8A1UnormSRGB:case Tf.ETC2RGBA8Unorm:case Tf.ETC2RGBA8UnormSRGB:case Tf.EACR11Unorm:case Tf.EACR11Snorm:case Tf.EACRG11Unorm:case Tf.EACRG11Snorm:case Tf.ASTC4x4Unorm:case Tf.ASTC4x4UnormSRGB:case Tf.ASTC5x4Unorm:case Tf.ASTC5x4UnormSRGB:case Tf.ASTC5x5Unorm:case Tf.ASTC5x5UnormSRGB:case Tf.ASTC6x5Unorm:case Tf.ASTC6x5UnormSRGB:case Tf.ASTC6x6Unorm:case Tf.ASTC6x6UnormSRGB:case Tf.ASTC8x5Unorm:case Tf.ASTC8x5UnormSRGB:case Tf.ASTC8x6Unorm:case Tf.ASTC8x6UnormSRGB:case Tf.ASTC8x8Unorm:case Tf.ASTC8x8UnormSRGB:case Tf.ASTC10x5Unorm:case Tf.ASTC10x5UnormSRGB:case Tf.ASTC10x6Unorm:case Tf.ASTC10x6UnormSRGB:case Tf.ASTC10x8Unorm:case Tf.ASTC10x8UnormSRGB:case Tf.ASTC10x10Unorm:case Tf.ASTC10x10UnormSRGB:case Tf.ASTC12x10Unorm:case Tf.ASTC12x10UnormSRGB:case Tf.ASTC12x12Unorm:case Tf.ASTC12x12UnormSRGB:return!0}return!1}static GetWebGPUTextureFormat(t,i,e=!1){switch(i){case 15:return Tf.Depth16Unorm;case 16:return Tf.Depth24Plus;case 13:return Tf.Depth24PlusStencil8;case 14:return Tf.Depth32Float;case 17:return Tf.Depth24UnormStencil8;case 18:return Tf.Depth32FloatStencil8;case 36492:return e?Tf.BC7RGBAUnormSRGB:Tf.BC7RGBAUnorm;case 36495:return Tf.BC6HRGBUFloat;case 36494:return Tf.BC6HRGBFloat;case 33779:return e?Tf.BC3RGBAUnormSRGB:Tf.BC3RGBAUnorm;case 33778:return e?Tf.BC2RGBAUnormSRGB:Tf.BC2RGBAUnorm;case 33777:case 33776:return e?Tf.BC1RGBAUnormSRGB:Tf.BC1RGBAUnorm;case 37808:return e?Tf.ASTC4x4UnormSRGB:Tf.ASTC4x4Unorm;case 36196:case 37492:return e?Tf.ETC2RGB8UnormSRGB:Tf.ETC2RGB8Unorm;case 37496:return e?Tf.ETC2RGBA8UnormSRGB:Tf.ETC2RGBA8Unorm}switch(t){case 3:switch(i){case 6:return Tf.R8Snorm;case 7:return Tf.RG8Snorm;case 4:throw"RGB format not supported in WebGPU";case 8:return Tf.R8Sint;case 9:return Tf.RG8Sint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return Tf.RGBA8Sint;default:return Tf.RGBA8Snorm}case 0:switch(i){case 6:return Tf.R8Unorm;case 7:return Tf.RG8Unorm;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return e?Tf.RGBA8UnormSRGB:Tf.RGBA8Unorm;case 12:return e?Tf.BGRA8UnormSRGB:Tf.BGRA8Unorm;case 8:return Tf.R8Uint;case 9:return Tf.RG8Uint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return Tf.RGBA8Uint;case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return Tf.RGBA8Unorm}case 4:switch(i){case 8:return Tf.R16Sint;case 9:return Tf.RG16Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return Tf.RGBA16Sint}case 5:switch(i){case 8:return Tf.R16Uint;case 9:return Tf.RG16Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return Tf.RGBA16Uint}case 6:switch(i){case 8:return Tf.R32Sint;case 9:return Tf.RG32Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return Tf.RGBA32Sint}case 7:switch(i){case 8:return Tf.R32Uint;case 9:return Tf.RG32Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return Tf.RGBA32Uint}case 1:switch(i){case 6:return Tf.R32Float;case 7:return Tf.RG32Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return Tf.RGBA32Float}case 2:switch(i){case 6:return Tf.R16Float;case 7:return Tf.RG16Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return Tf.RGBA16Float}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:throw"TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV format not supported in WebGPU";case 14:throw"TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV format not supported in WebGPU";case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(i){case 5:default:return Tf.RGB10A2Unorm;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV"}}return e?Tf.RGBA8UnormSRGB:Tf.RGBA8Unorm}static GetNumChannelsFromWebGPUTextureFormat(t){switch(t){case Tf.R8Unorm:case Tf.R8Snorm:case Tf.R8Uint:case Tf.R8Sint:case Tf.BC4RUnorm:case Tf.BC4RSnorm:case Tf.R16Uint:case Tf.R16Sint:case Tf.Depth16Unorm:case Tf.R16Float:case Tf.R32Uint:case Tf.R32Sint:case Tf.R32Float:case Tf.Depth32Float:case Tf.Stencil8:case Tf.Depth24Plus:case Tf.EACR11Unorm:case Tf.EACR11Snorm:return 1;case Tf.RG8Unorm:case Tf.RG8Snorm:case Tf.RG8Uint:case Tf.RG8Sint:case Tf.Depth24UnormStencil8:case Tf.Depth32FloatStencil8:case Tf.BC5RGUnorm:case Tf.BC5RGSnorm:case Tf.RG16Uint:case Tf.RG16Sint:case Tf.RG16Float:case Tf.RG32Uint:case Tf.RG32Sint:case Tf.RG32Float:case Tf.Depth24PlusStencil8:case Tf.EACRG11Unorm:case Tf.EACRG11Snorm:return 2;case Tf.RGB9E5UFloat:case Tf.RG11B10UFloat:case Tf.BC6HRGBUFloat:case Tf.BC6HRGBFloat:case Tf.ETC2RGB8Unorm:case Tf.ETC2RGB8UnormSRGB:return 3;case Tf.RGBA8Unorm:case Tf.RGBA8UnormSRGB:case Tf.RGBA8Snorm:case Tf.RGBA8Uint:case Tf.RGBA8Sint:case Tf.BGRA8Unorm:case Tf.BGRA8UnormSRGB:case Tf.RGB10A2Unorm:case Tf.BC7RGBAUnorm:case Tf.BC7RGBAUnormSRGB:case Tf.BC3RGBAUnorm:case Tf.BC3RGBAUnormSRGB:case Tf.BC2RGBAUnorm:case Tf.BC2RGBAUnormSRGB:case Tf.BC1RGBAUnorm:case Tf.BC1RGBAUnormSRGB:case Tf.RGBA16Uint:case Tf.RGBA16Sint:case Tf.RGBA16Float:case Tf.RGBA32Uint:case Tf.RGBA32Sint:case Tf.RGBA32Float:case Tf.ETC2RGB8A1Unorm:case Tf.ETC2RGB8A1UnormSRGB:case Tf.ETC2RGBA8Unorm:case Tf.ETC2RGBA8UnormSRGB:case Tf.ASTC4x4Unorm:case Tf.ASTC4x4UnormSRGB:case Tf.ASTC5x4Unorm:case Tf.ASTC5x4UnormSRGB:case Tf.ASTC5x5Unorm:case Tf.ASTC5x5UnormSRGB:case Tf.ASTC6x5Unorm:case Tf.ASTC6x5UnormSRGB:case Tf.ASTC6x6Unorm:case Tf.ASTC6x6UnormSRGB:case Tf.ASTC8x5Unorm:case Tf.ASTC8x5UnormSRGB:case Tf.ASTC8x6Unorm:case Tf.ASTC8x6UnormSRGB:case Tf.ASTC8x8Unorm:case Tf.ASTC8x8UnormSRGB:case Tf.ASTC10x5Unorm:case Tf.ASTC10x5UnormSRGB:case Tf.ASTC10x6Unorm:case Tf.ASTC10x6UnormSRGB:case Tf.ASTC10x8Unorm:case Tf.ASTC10x8UnormSRGB:case Tf.ASTC10x10Unorm:case Tf.ASTC10x10UnormSRGB:case Tf.ASTC12x10Unorm:case Tf.ASTC12x10UnormSRGB:case Tf.ASTC12x12Unorm:case Tf.ASTC12x12UnormSRGB:return 4}throw`Unknown format ${t}!`}static HasStencilAspect(t){switch(t){case Tf.Stencil8:case Tf.Depth24UnormStencil8:case Tf.Depth32FloatStencil8:case Tf.Depth24PlusStencil8:return!0}return!1}static HasDepthAndStencilAspects(t){switch(t){case Tf.Depth24UnormStencil8:case Tf.Depth32FloatStencil8:case Tf.Depth24PlusStencil8:return!0}return!1}copyVideoToTexture(t,i,e,s=!1,n){var r,h,o,a;const l=void 0===n,[c,u]=this.mJ(e,s?Kd.InvertY:Kd.DontInvertY);l&&(n=this.oJ.createCommandEncoder({})),null===(h=(r=n).pushDebugGroup)||void 0===h||h.call(r,`copy video to texture - invertY=${s}`);const f={colorAttachments:[{view:i.Er.underlyingResource.createView({format:e,dimension:wf.E2d,mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:xf.All}),loadOp:Yf.Load,storeOp:jf.Store}]},d=n.beginRenderPass(f),p={layout:u,entries:[{binding:0,resource:this.fJ},{binding:1,resource:this.oJ.importExternalTexture({source:t.underlyingResource})}]},m=this.oJ.createBindGroup(p);d.setPipeline(c),d.setBindGroup(0,m),d.draw(4,1,0,0),d.end(),null===(a=(o=n).popDebugGroup)||void 0===a||a.call(o),l&&(this.oJ.queue.submit([n.finish()]),n=null)}invertYPreMultiplyAlpha(t,i,e,s,n=!1,r=!1,h=0,o=0,a=1,l=0,c=0,u=0,f=0,d,p){var m,v,g,S,E,A;const C=0!==u,w=void 0===d,[x,T]=this.pJ(s,C?jd.InvertYPremultiplyAlphaWithOfst:jd.InvertYPremultiplyAlpha,{invertY:n,premultiplyAlpha:r});let R;if(h=Math.max(h,0),w&&(d=this.oJ.createCommandEncoder({})),null===(v=(m=d).pushDebugGroup)||void 0===v||v.call(m,`internal process texture - invertY=${n} premultiplyAlpha=${r}`),Zd.SJ(t)?(R=t.underlyingResource,n&&!r&&1===a&&0===h||(t=void 0)):(R=t,t=void 0),!R)return;C&&this.cJ.setRawData(this.dJ,0,new Float32Array([l,c,u,f]),0,16);const I=t,M=null!==(g=null==I?void 0:I.iJ)&&void 0!==g?g:this.createTexture({width:i,height:e,layers:1},!1,!1,!1,!1,!1,s,1,d,Cf.CopySrc|Cf.RenderAttachment|Cf.TextureBinding),b=null!==(S=null==I?void 0:I.CJ)&&void 0!==S?S:{colorAttachments:[{view:M.createView({format:s,dimension:wf.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:Yf.Load,storeOp:jf.Store}]},_=d.beginRenderPass(b);let y=C?null==I?void 0:I.wJ:null==I?void 0:I.xJ;if(!y){const t={layout:T,entries:[{binding:0,resource:R.createView({format:s,dimension:wf.E2d,baseMipLevel:o,mipLevelCount:1,arrayLayerCount:a,baseArrayLayer:h})}]};C&&t.entries.push({binding:1,resource:{buffer:this.dJ}}),y=this.oJ.createBindGroup(t)}_.setPipeline(x),_.setBindGroup(0,y),_.draw(4,1,0,0),_.end(),d.copyTextureToTexture({texture:M},{texture:R,mipLevel:o,origin:{x:0,y:0,z:h}},{width:i,height:e,depthOrArrayLayers:1}),I?(I.iJ=M,I.CJ=b,C?I.wJ=y:I.xJ=y):this.hJ.push([M,null]),null===(A=(E=d).popDebugGroup)||void 0===A||A.call(E),w&&(this.oJ.queue.submit([d.finish()]),d=null)}copyWithInvertY(t,i,e,s){var n,r,h,o;const a=void 0===s,[l,c]=this.pJ(i,jd.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1});a&&(s=this.oJ.createCommandEncoder({})),null===(r=(n=s).pushDebugGroup)||void 0===r||r.call(n,"internal copy texture with invertY");const u=s.beginRenderPass(e),f=this.oJ.createBindGroup({layout:c,entries:[{binding:0,resource:t}]});u.setPipeline(l),u.setBindGroup(0,f),u.draw(4,1,0,0),u.end(),null===(o=(h=s).popDebugGroup)||void 0===o||o.call(h),a&&(this.oJ.queue.submit([s.finish()]),s=null)}createTexture(t,i=!1,e=!1,s=!1,n=!1,r=!1,h=Tf.RGBA8Unorm,o=1,a,l=-1,c=0){o>1&&(o=4);const u=t.layers||1,f={width:t.width,height:t.height,depthOrArrayLayers:u},d=Zd.IsCompressedFormat(h),p=i?Zd.ComputeNumMipmapLevels(t.width,t.height):1,m=l>=0?l:Cf.CopySrc|Cf.CopyDst|Cf.TextureBinding;c|=i&&!d?Cf.CopySrc|Cf.RenderAttachment:0,d||r||(c|=Cf.RenderAttachment|Cf.CopyDst);const v=this.oJ.createTexture({label:`Texture_${f.width}x${f.height}x${f.depthOrArrayLayers}_${i?"wmips":"womips"}_${h}_samples${o}`,size:f,dimension:r?Af.E3d:Af.E2d,format:h,usage:m|c,sampleCount:o,mipLevelCount:p});return Zd.IsImageBitmap(t)&&(this.updateTexture(t,v,t.width,t.height,u,h,0,0,s,n,0,0),i&&e&&this.generateMipmaps(v,h,p,0,a)),v}createCubeTexture(t,i=!1,e=!1,s=!1,n=!1,r=Tf.RGBA8Unorm,h=1,o,a=-1,l=0){h>1&&(h=4);const c=Zd.IsImageBitmapArray(t)?t[0].width:t.width,u=Zd.IsImageBitmapArray(t)?t[0].height:t.height,f=Zd.IsCompressedFormat(r),d=i?Zd.ComputeNumMipmapLevels(c,u):1,p=a>=0?a:Cf.CopySrc|Cf.CopyDst|Cf.TextureBinding;l|=i&&!f?Cf.CopySrc|Cf.RenderAttachment:0,f||(l|=Cf.RenderAttachment|Cf.CopyDst);const m=this.oJ.createTexture({label:`TextureCube_${c}x${u}x6_${i?"wmips":"womips"}_${r}_samples${h}`,size:{width:c,height:u,depthOrArrayLayers:6},dimension:Af.E2d,format:r,usage:p|l,sampleCount:h,mipLevelCount:d});return Zd.IsImageBitmapArray(t)&&(this.updateCubeTextures(t,m,c,u,r,s,n,0,0),i&&e&&this.generateCubeMipmaps(m,r,d,o)),m}generateCubeMipmaps(t,i,e,s){var n,r,h,o;const a=void 0===s;a&&(s=this.oJ.createCommandEncoder({})),null===(r=(n=s).pushDebugGroup)||void 0===r||r.call(n,`create cube mipmaps - ${e} levels`);for(let n=0;n<6;++n)this.generateMipmaps(t,i,e,n,s);null===(o=(h=s).popDebugGroup)||void 0===o||o.call(h),a&&(this.oJ.queue.submit([s.finish()]),s=null)}generateMipmaps(t,i,e,s=0,n){var r,h,o,a,l,c,u,f;const d=void 0===n,[p,m]=this.pJ(i);let v;if(s=Math.max(s,0),d&&(n=this.oJ.createCommandEncoder({})),null===(h=(r=n).pushDebugGroup)||void 0===h||h.call(r,`create mipmaps for face #${s} - ${e} levels`),Zd.SJ(t)?(v=t.underlyingResource,t.TJ=t.TJ||[],t.RJ=t.RJ||[]):(v=t,t=void 0),!v)return;const g=t;for(let t=1;t<e;++t){const e=null!==(a=null===(o=null==g?void 0:g.TJ[s])||void 0===o?void 0:o[t-1])&&void 0!==a?a:{colorAttachments:[{view:v.createView({format:i,dimension:wf.E2d,baseMipLevel:t,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s}),loadOp:Yf.Load,storeOp:jf.Store}]};g&&(g.TJ[s]=g.TJ[s]||[],g.TJ[s][t-1]=e);const r=n.beginRenderPass(e),h=null!==(c=null===(l=null==g?void 0:g.RJ[s])||void 0===l?void 0:l[t-1])&&void 0!==c?c:this.oJ.createBindGroup({layout:m,entries:[{binding:0,resource:this.uJ},{binding:1,resource:v.createView({format:i,dimension:wf.E2d,baseMipLevel:t-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s})}]});g&&(g.RJ[s]=g.RJ[s]||[],g.RJ[s][t-1]=h),r.setPipeline(p),r.setBindGroup(0,h),r.draw(4,1,0,0),r.end()}null===(f=(u=n).popDebugGroup)||void 0===f||f.call(u),d&&(this.oJ.queue.submit([n.finish()]),n=null)}createGPUTextureForInternalTexture(t,i,e,s,n){t.Er||(t.Er=new Wd),void 0===i&&(i=t.width),void 0===e&&(e=t.height),void 0===s&&(s=t.depth);const r=t.Er,h=0!=(1&(null!=n?n:0));r.format=Zd.GetWebGPUTextureFormat(t.type,t.format,t.ur),r.textureUsages=t.$n===oi.RenderTarget||t.source===oi.MultiRenderTarget?Cf.TextureBinding|Cf.CopySrc|Cf.RenderAttachment:t.$n===oi.DepthStencil?Cf.TextureBinding|Cf.RenderAttachment:-1,r.textureAdditionalUsages=h?Cf.StorageBinding:0;const o=t.generateMipMaps,a=s||1;let l;if(l=null!==t.Ar?t.Ar:o?Zd.ComputeNumMipmapLevels(i,e):1,t.isCube){const s=this.createCubeTexture({width:i,height:e},t.generateMipMaps,t.generateMipMaps,t.invertY,!1,r.format,1,this.AJ,r.textureUsages,r.textureAdditionalUsages);r.set(s),r.createView({format:r.format,dimension:wf.Cube,mipLevelCount:l,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:Zd.HasDepthAndStencilAspects(r.format)?xf.DepthOnly:xf.All},h)}else{const s=this.createTexture({width:i,height:e,layers:a},t.generateMipMaps,t.generateMipMaps,t.invertY,!1,t.is3D,r.format,1,this.AJ,r.textureUsages,r.textureAdditionalUsages);r.set(s),r.createView({format:r.format,dimension:t.is2DArray?wf.E2dArray:t.is3D?Af.E3d:wf.E2d,mipLevelCount:l,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:t.is3D?1:a,aspect:Zd.HasDepthAndStencilAspects(r.format)?xf.DepthOnly:xf.All},h)}return t.width=t.baseWidth=i,t.height=t.baseHeight=e,t.depth=t.baseDepth=s,this.createMSAATexture(t,t.samples),r}createMSAATexture(t,i){const e=t.Er;if((null==e?void 0:e.msaaTexture)&&(this.releaseTexture(e.msaaTexture),e.msaaTexture=null),!e||(null!=i?i:1)<=1)return;const s=t.width,n=t.height,r=t.depth||1;if(t.isCube){const r=this.createCubeTexture({width:s,height:n},!1,!1,t.invertY,!1,e.format,i,this.AJ,e.textureUsages,e.textureAdditionalUsages);e.msaaTexture=r}else{const h=this.createTexture({width:s,height:n,layers:r},!1,!1,t.invertY,!1,t.is3D,e.format,i,this.AJ,e.textureUsages,e.textureAdditionalUsages);e.msaaTexture=h}}updateCubeTextures(t,i,e,s,n,r=!1,h=!1,o=0,a=0){const l=[0,3,1,4,2,5];for(let c=0;c<l.length;++c){const u=t[l[c]];this.updateTexture(u,i,e,s,1,n,c,0,r,h,o,a)}}updateTexture(t,i,e,s,n,r,h=0,o=0,a=!1,l=!1,c=0,u=0,f){const d=Zd.EJ(i)?i.Er.underlyingResource:i,p=Zd.gJ(r),m=Zd.EJ(i)?i.Er:i,v={texture:d,origin:{x:c,y:u,z:Math.max(h,0)},mipLevel:o,premultipliedAlpha:l},g={width:Math.ceil(e/p.width)*p.width,height:Math.ceil(s/p.height)*p.height,depthOrArrayLayers:n||1};if(void 0!==t.byteLength){const d=Math.ceil(e/p.width)*p.length;if(256*Math.ceil(d/256)===d){const i=this.oJ.createCommandEncoder({}),e=this.cJ.createRawBuffer(t.byteLength,Sf.MapWrite|Sf.CopySrc,!0),n=e.getMappedRange();new Uint8Array(n).set(t),e.unmap(),i.copyBufferToTexture({buffer:e,offset:0,bytesPerRow:d,rowsPerImage:s},v,g),this.oJ.queue.submit([i.finish()]),this.cJ.releaseBuffer(e)}else this.oJ.queue.writeTexture(v,t,{offset:0,bytesPerRow:d,rowsPerImage:s},g);if(a||l){if(!Zd.EJ(i))throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!";{const t=0===c&&0===u&&e===i.width&&s===i.height;this.invertYPreMultiplyAlpha(m,i.width,i.height,r,a,l,h,o,n||1,c,u,t?0:e,t?0:s,void 0,f)}}}else if(a)if(v.premultipliedAlpha=!1,Zd.EJ(i)&&0===c&&0===u&&e===i.width&&s===i.height)this.oJ.queue.copyExternalImageToTexture({source:t},v,g),this.invertYPreMultiplyAlpha(m,e,s,r,a,l,h,o,n||1,0,0,0,0,void 0,f);else{const i=this.oJ.createCommandEncoder({}),c=this.createTexture({width:e,height:s,layers:1},!1,!1,!1,!1,!1,r,1,i,Cf.CopySrc|Cf.TextureBinding);this.hJ.push([c,null]),g.depthOrArrayLayers=1,this.oJ.queue.copyExternalImageToTexture({source:t},{texture:c},g),g.depthOrArrayLayers=n||1,this.invertYPreMultiplyAlpha(c,e,s,r,a,l,h,o,n||1,0,0,0,0,i,f),i.copyTextureToTexture({texture:c},v,g),this.oJ.queue.submit([i.finish()])}else this.oJ.queue.copyExternalImageToTexture({source:t},v,g)}readPixels(t,i,e,s,n,r,h=0,o=0,a=null,l=!1){const c=Zd.gJ(r),u=Math.ceil(s/c.width)*c.length,f=256*Math.ceil(u/256),d=f*n,p=this.cJ.createRawBuffer(d,Sf.MapRead|Sf.CopyDst),m=this.oJ.createCommandEncoder({});return m.copyTextureToBuffer({texture:t,mipLevel:o,origin:{x:i,y:e,z:Math.max(h,0)}},{buffer:p,offset:0,bytesPerRow:f},{width:s,height:n,depthOrArrayLayers:1}),this.oJ.queue.submit([m.finish()]),this.cJ.readDataFromBuffer(p,d,s,n,u,f,Zd.vJ(r),0,a,!0,l)}releaseTexture(t){if(Zd.EJ(t)){const i=t.Er,e=t.Sr;this.hJ.push([i,e])}else this.hJ.push([t,null])}destroyDeferredTextures(){for(let t=0;t<this.hJ.length;++t){const[i,e]=this.hJ[t];i&&(Zd.SJ(i)?i.release():i.destroy()),null==e||e.dispose()}this.hJ.length=0}}class Jd extends ui{constructor(t){super(),this.Yn=t}get underlyingResource(){return this.Yn}}class tp{constructor(t){this.IJ=[],this.oJ=t}static MJ(t){return void 0===t.underlyingResource}createRawBuffer(t,i,e=!1){const s={mappedAtCreation:e,size:void 0!==t.byteLength?t.byteLength+3&-4:t+3&-4,usage:i};return this.oJ.createBuffer(s)}createBuffer(t,i){const e=void 0!==t.byteLength,s=this.createRawBuffer(t,i),n=new Jd(s);return n.references=1,n.capacity=e?t.byteLength:t,e&&this.setSubData(n,0,t),n}setRawData(t,i,e,s,n){this.oJ.queue.writeBuffer(t,i,e.buffer,s,n)}setSubData(t,i,e,s=0,n=0){const r=t.underlyingResource;n=n||e.byteLength,n=Math.min(n,t.capacity-i);let h=e.byteOffset+s,o=h+n;const a=n+3&-4;if(a!==n){const t=new Uint8Array(e.buffer.slice(h,o));(e=new Uint8Array(a)).set(t),s=0,h=0,o=a,n=a}const l=15728640;let c=0;for(;o-(h+c)>l;)this.oJ.queue.writeBuffer(r,i+c,e.buffer,h+c,l),c+=l;this.oJ.queue.writeBuffer(r,i+c,e.buffer,h+c,n-c)}bJ(t,i,e){e||(e=new Float32Array(t));const s=new Uint16Array(i);for(;t--;)e[t]=Vu(s[t]);return e}readDataFromBuffer(t,i,e,s,n,r,h=0,o=0,a=null,l=!0,c=!1){const u=1===h?2:2===h?1:0;return new Promise(((e,f)=>{t.mapAsync(Ef.Read,o,i).then((()=>{const f=t.getMappedRange(o,i);let d=a;if(c)d=null===d?Ts(h,i,!0,f):Ts(h,d.buffer,void 0,f);else if(null===d)switch(u){case 0:d=new Uint8Array(i),d.set(new Uint8Array(f));break;case 1:d=this.bJ(i/2,f);break;case 2:d=new Float32Array(i/4),d.set(new Float32Array(f))}else switch(u){case 0:d=new Uint8Array(d.buffer),d.set(new Uint8Array(f));break;case 1:d=this.bJ(i/2,f,a);break;case 2:d=new Float32Array(d.buffer),d.set(new Float32Array(f))}if(n!==r){1!==u||c||(n*=2,r*=2);const t=new Uint8Array(d.buffer);let i=n,e=0;for(let h=1;h<s;++h){e=h*r;for(let s=0;s<n;++s)t[i++]=t[e++]}d=0===u||c?new Uint8Array(t.buffer,0,i):new Float32Array(t.buffer,0,i/4)}t.unmap(),l&&this.releaseBuffer(t),e(d)}),(t=>f(t)))}))}releaseBuffer(t){return tp.MJ(t)?(this.IJ.push(t),!0):(t.references--,0===t.references&&(this.IJ.push(t.underlyingResource),!0))}destroyDeferredBuffers(){for(let t=0;t<this.IJ.length;++t)this.IJ[t].destroy();this.IJ.length=0}}class ip{constructor(){this.colorAttachmentGPUTextures=[],this.reset()}reset(t=!1){this.renderPass=null,t&&(this.renderPassDescriptor=null,this.colorAttachmentViewDescriptor=null,this.depthAttachmentViewDescriptor=null,this.colorAttachmentGPUTextures=[],this.depthTextureFormat=void 0)}}const ep=[0,0,3,7,0,2,6,2,4,1,5,3,1],sp=[0,64,32,96,16,80,48,112,8],np=[0,128,128,0,0,0,0,128,0,0,0,0,128];class rp{constructor(t){this.Ss={},this.oJ=t,this.disabled=!1}static GetSamplerHashCode(t){var i,e,s;const n=t.zn&&t.zn>1?4:1;return ep[t.samplingMode]+sp[(t.Hn||514)-512+1]+np[t.samplingMode]+((null!==(i=t.Vn)&&void 0!==i?i:1)<<8)+((null!==(e=t.kn)&&void 0!==e?e:1)<<10)+((null!==(s=t.Gn)&&void 0!==s?s:1)<<12)+((t.useMipMaps?1:0)<<14)+(n<<15)}static _J(t,i){let e,s,n,r,h;const o=t.useMipMaps;switch(t.samplingMode){case 11:e=If.Linear,s=If.Linear,n=If.Nearest,o||(r=h=0);break;case 3:case 3:e=If.Linear,s=If.Linear,o?n=If.Linear:(n=If.Nearest,r=h=0);break;case 8:e=If.Nearest,s=If.Nearest,o?n=If.Linear:(n=If.Nearest,r=h=0);break;case 4:e=If.Nearest,s=If.Nearest,n=If.Nearest,o||(r=h=0);break;case 5:e=If.Nearest,s=If.Linear,n=If.Nearest,o||(r=h=0);break;case 6:e=If.Nearest,s=If.Linear,o?n=If.Linear:(n=If.Nearest,r=h=0);break;case 7:e=If.Nearest,s=If.Linear,n=If.Nearest,r=h=0;break;case 1:case 1:default:e=If.Nearest,s=If.Nearest,n=If.Nearest,r=h=0;break;case 9:e=If.Linear,s=If.Nearest,n=If.Nearest,o||(r=h=0);break;case 10:e=If.Linear,s=If.Nearest,o?n=If.Linear:(n=If.Nearest,r=h=0);break;case 2:case 2:e=If.Linear,s=If.Linear,n=If.Nearest,r=h=0;break;case 12:e=If.Linear,s=If.Nearest,n=If.Nearest,r=h=0}return i>1&&(0!==r||0!==h)?{magFilter:If.Linear,minFilter:If.Linear,mipmapFilter:If.Linear,anisotropyEnabled:!0}:{magFilter:e,minFilter:s,mipmapFilter:n,lodMinClamp:r,lodMaxClamp:h}}static yJ(t){switch(t){case 1:return Rf.Repeat;case 0:return Rf.ClampToEdge;case 2:return Rf.MirrorRepeat}return Rf.Repeat}static NJ(t){return{addressModeU:this.yJ(t.Vn),addressModeV:this.yJ(t.kn),addressModeW:this.yJ(t.Gn)}}static PJ(t){const i=t.useMipMaps&&t.zn&&t.zn>1?4:1,e=this._J(t,i);return{...e,...this.NJ(t),compare:t.Hn?rp.GetCompareFunction(t.Hn):void 0,maxAnisotropy:e.anisotropyEnabled?i:1}}static GetCompareFunction(t){switch(t){case 519:return Mf.Always;case 514:return Mf.Equal;case 516:return Mf.Greater;case 518:return Mf.GreaterEqual;case 513:default:return Mf.Less;case 515:return Mf.LessEqual;case 512:return Mf.Never;case 517:return Mf.NotEqual}}getSampler(t,i=!1,e=0){if(this.disabled)return this.oJ.createSampler(rp.PJ(t));i?e=0:0===e&&(e=rp.GetSamplerHashCode(t));let s=i?void 0:this.Ss[e];return s||(s=this.oJ.createSampler(rp.PJ(t)),i||(this.Ss[e]=s)),s}}var hp;!function(t){t[t.StencilReadMask=0]="StencilReadMask",t[t.StencilWriteMask=1]="StencilWriteMask",t[t.DepthBias=2]="DepthBias",t[t.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",t[t.DepthStencilState=4]="DepthStencilState",t[t.MRTAttachments1=5]="MRTAttachments1",t[t.MRTAttachments2=6]="MRTAttachments2",t[t.RasterizationState=7]="RasterizationState",t[t.ColorStates=8]="ColorStates",t[t.ShaderStage=9]="ShaderStage",t[t.TextureStage=10]="TextureStage",t[t.VertexState=11]="VertexState",t[t.NumStates=12]="NumStates"}(hp||(hp={}));const op={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},ap={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7};class lp{constructor(t,i,e){this.mrtTextureCount=0,this.oJ=t,this.DJ=e,this.LJ=new Array(30),this.OJ=0,this.FJ=0,this.BJ=i,this.UJ=[],this.VJ={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this.kJ=t.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this.F=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this.GJ=[Tf.BGRA8Unorm],this.setColorFormat(Tf.BGRA8Unorm),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat(Tf.Depth24PlusStencil8),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this.zJ(0)}get colorFormats(){return this.HJ>0?this.UJ:this.GJ}getRenderPipeline(t,i,e,s=0){if(e>1&&(e=4),this.disabled){const s=lp.XJ(t);return this.WJ(i),this.VJ.pipeline=this.$J(i,s,e),lp.NumCacheMiss++,lp.YJ++,this.VJ.pipeline}if(this.jJ(i.uniqueId),this.KJ(t,e),this.qJ(),this.QJ(),this.WJ(i),this.zJ(s),this.lastStateDirtyLowestIndex=this.FJ,!this.F&&this.VJ.pipeline)return this.FJ=this.OJ,lp.NumCacheHitWithoutHash++,this.VJ.pipeline;if(this.ZJ(this.VJ),this.F=!1,this.FJ=this.OJ,this.VJ.pipeline)return lp.NumCacheHitWithHash++,this.VJ.pipeline;const n=lp.XJ(t);return this.VJ.pipeline=this.$J(i,n,e),this.JJ(this.VJ),lp.NumCacheMiss++,lp.YJ++,this.VJ.pipeline}endFrame(){lp.NumPipelineCreationLastFrame=lp.YJ,lp.YJ=0}setAlphaToCoverage(t){this.t0=t}setFrontFace(t){this._n=t}setCullEnabled(t){this.i0=t}setCullFace(t){this.Tn=t}setClampDepth(t){this.e0=t}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(t,i,e,s,n,r,h,o){this.s0=h,this.n0=r,this.r0=(null!=o?o:519)-512,this.Tn=e,this.i0=t,this._n=i,this.setDepthBiasSlopeScale(s),this.setDepthBias(n)}setDepthBias(t){this.h0!==t&&(this.h0=t,this.LJ[hp.DepthBias]=t,this.F=!0,this.FJ=Math.min(this.FJ,hp.DepthBias))}setDepthBiasSlopeScale(t){this.o0!==t&&(this.o0=t,this.LJ[hp.DepthBiasSlopeScale]=t,this.F=!0,this.FJ=Math.min(this.FJ,hp.DepthBiasSlopeScale))}setColorFormat(t){this.GJ[0]=t,this.a0=Qd[null!=t?t:""]}setMRTAttachments(t){this.mrtAttachments=t;let i=0;for(let e=0;e<t.length;++e)0!==t[e]&&(i+=1<<e);this.l0!==i&&(this.l0=i,this.F=!0,this.FJ=Math.min(this.FJ,hp.MRTAttachments1))}setMRT(t,i){var e,s;if((i=null!=i?i:t.length)>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=t,this.mrtTextureCount=i,this.l0=65535;const n=[0,0];let r=0,h=0,o=0;for(let a=0;a<i;++a){const i=t[a],l=null==i?void 0:i.Er;this.UJ[o]=null!==(e=null==l?void 0:l.format)&&void 0!==e?e:this.GJ[0],n[r]+=Qd[null!==(s=this.UJ[o])&&void 0!==s?s:""]<<h,h+=6,o++,h>=32&&(h=0,r++)}this.UJ.length=o,this.HJ===n[0]&&this.c0===n[1]||(this.HJ=n[0],this.c0=n[1],this.LJ[hp.MRTAttachments1]=n[0],this.LJ[hp.MRTAttachments2]=n[1],this.F=!0,this.FJ=Math.min(this.FJ,hp.MRTAttachments1))}setAlphaBlendEnabled(t){this.u0=t}setAlphaBlendFactors(t,i){this.f0=t,this.d0=i}setWriteMask(t){this.m0=t}setDepthStencilFormat(t){this.v0=t,this.g0=void 0===t?0:Qd[t]}setDepthTestEnabled(t){this.n0=t}setDepthWriteEnabled(t){this.s0=t}setDepthCompare(t){this.r0=(null!=t?t:519)-512}setStencilEnabled(t){this.S0=t}setStencilCompare(t){this.E0=(null!=t?t:519)-512}setStencilDepthFailOp(t){this.A0=null===t?1:ap[t]}setStencilPassOp(t){this.C0=null===t?2:ap[t]}setStencilFailOp(t){this.w0=null===t?1:ap[t]}setStencilReadMask(t){this.x0!==t&&(this.x0=t,this.LJ[hp.StencilReadMask]=t,this.F=!0,this.FJ=Math.min(this.FJ,hp.StencilReadMask))}setStencilWriteMask(t){this.T0!==t&&(this.T0=t,this.LJ[hp.StencilWriteMask]=t,this.F=!0,this.FJ=Math.min(this.FJ,hp.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(t,i,e,s,n,r,h){this.S0=t,this.E0=(null!=i?i:519)-512,this.A0=null===e?1:ap[e],this.C0=null===s?2:ap[s],this.w0=null===n?1:ap[n],this.setStencilReadMask(r),this.setStencilWriteMask(h)}setBuffers(t,i,e){this.ff=t,this.R0=e,this.Xu=i}static XJ(t){switch(t){case 0:default:return Of.TriangleList;case 2:case 3:return Of.PointList;case 1:case 4:return Of.LineList;case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return Of.LineStrip;case 7:return Of.TriangleStrip;case 8:throw"TriangleFan is an unsupported fillmode in WebGPU"}}static I0(t){switch(t){case 32774:default:return kf.Add;case 32778:return kf.Subtract;case 32779:return kf.ReverseSubtract;case 32775:return kf.Min;case 32776:return kf.Max}}static M0(t){switch(t){case 0:return Vf.Zero;case 1:default:return Vf.One;case 768:return Vf.Src;case 769:return Vf.OneMinusSrc;case 770:return Vf.SrcAlpha;case 771:return Vf.OneMinusSrcAlpha;case 772:return Vf.DstAlpha;case 773:return Vf.OneMinusDstAlpha;case 774:return Vf.Dst;case 775:return Vf.OneMinusDst;case 776:return Vf.SrcAlphaSaturated;case 32769:case 32771:return Vf.Constant;case 32770:case 32772:return Vf.OneMinusConstant}}static b0(t){switch(t){case 0:return Mf.Never;case 1:return Mf.Less;case 2:return Mf.Equal;case 3:return Mf.LessEqual;case 4:return Mf.Greater;case 5:return Mf.NotEqual;case 6:return Mf.GreaterEqual;case 7:return Mf.Always}return Mf.Never}static _0(t){switch(t){case 0:return Gf.Zero;case 1:return Gf.Keep;case 2:return Gf.Replace;case 3:return Gf.IncrementClamp;case 4:return Gf.DecrementClamp;case 5:return Gf.Invert;case 6:return Gf.IncrementWrap;case 7:return Gf.DecrementWrap}return Gf.Keep}static y0(t){const i=t.type,e=t.normalized,s=t.getSize();switch(i){case he.BYTE:switch(s){case 1:case 2:return e?Hf.Snorm8x2:Hf.Sint8x2;case 3:case 4:return e?Hf.Snorm8x4:Hf.Sint8x4}break;case he.UNSIGNED_BYTE:switch(s){case 1:case 2:return e?Hf.Unorm8x2:Hf.Uint8x2;case 3:case 4:return e?Hf.Unorm8x4:Hf.Uint8x4}break;case he.SHORT:switch(s){case 1:case 2:return e?Hf.Snorm16x2:Hf.Sint16x2;case 3:case 4:return e?Hf.Snorm16x4:Hf.Sint16x4}break;case he.UNSIGNED_SHORT:switch(s){case 1:case 2:return e?Hf.Unorm16x2:Hf.Uint16x2;case 3:case 4:return e?Hf.Unorm16x4:Hf.Uint16x4}break;case he.INT:switch(s){case 1:return Hf.Sint32;case 2:return Hf.Sint32x2;case 3:return Hf.Sint32x3;case 4:return Hf.Sint32x4}break;case he.UNSIGNED_INT:switch(s){case 1:return Hf.Uint32;case 2:return Hf.Uint32x2;case 3:return Hf.Uint32x3;case 4:return Hf.Uint32x4}break;case he.FLOAT:switch(s){case 1:return Hf.Float32;case 2:return Hf.Float32x2;case 3:return Hf.Float32x3;case 4:return Hf.Float32x4}}throw new Error(`Invalid Format '${t.getKind()}' - type=${i}, normalized=${e}, size=${s}`)}N0(){return this.u0?{srcFactor:lp.M0(this.f0[2]),dstFactor:lp.M0(this.f0[3]),operation:lp.I0(this.d0[1])}:null}P0(){return this.u0?{srcFactor:lp.M0(this.f0[0]),dstFactor:lp.M0(this.f0[1]),operation:lp.I0(this.d0[0])}:null}jJ(t){this.D0!==t&&(this.D0=t,this.LJ[hp.ShaderStage]=t,this.F=!0,this.FJ=Math.min(this.FJ,hp.ShaderStage))}KJ(t,i){const e=this._n-1+((this.i0?this.Tn:0)<<1)+((this.e0?1:0)<<3)+((this.t0?1:0)<<4)+(t<<5)+(i<<8);this.L0!==e&&(this.L0=e,this.LJ[hp.RasterizationState]=this.L0,this.F=!0,this.FJ=Math.min(this.FJ,hp.RasterizationState))}qJ(){let t=((this.m0?1:0)<<22)+(this.a0<<23)+((this.s0?1:0)<<29);this.u0&&(t+=((null===this.f0[0]?2:op[this.f0[0]])<<0)+((null===this.f0[1]?2:op[this.f0[1]])<<4)+((null===this.f0[2]?2:op[this.f0[2]])<<8)+((null===this.f0[3]?2:op[this.f0[3]])<<12)+((null===this.d0[0]?1:this.d0[0]-32773)<<16)+((null===this.d0[1]?1:this.d0[1]-32773)<<19)),t!==this.O0&&(this.O0=t,this.LJ[hp.ColorStates]=this.O0,this.F=!0,this.FJ=Math.min(this.FJ,hp.ColorStates))}QJ(){const t=this.S0?this.E0+(this.A0<<3)+(this.C0<<6)+(this.w0<<9):591,i=this.g0+((this.n0?this.r0:7)<<6)+(t<<10);this.F0!==i&&(this.F0=i,this.LJ[hp.DepthStencilState]=this.F0,this.F=!0,this.FJ=Math.min(this.FJ,hp.DepthStencilState))}WJ(t){var i,e;const s=this.OJ;let n=hp.VertexState;const r=t.Ms,h=r.shaderProcessingContext.attributeNamesFromEffect,o=r.shaderProcessingContext.attributeLocationsFromEffect;let a,l=0;for(let t=0;t<h.length;t++){const s=o[t];let r=null!==(i=this.R0&&this.R0[h[t]])&&void 0!==i?i:this.ff[h[t]];r||(r=this.BJ);const c=null===(e=r.getBuffer())||void 0===e?void 0:e.underlyingResource;if(void 0===r.B0){const t=r.byteOffset,i=r.getSize(!0),e=r.byteStride;r.B0=t<=this.kJ-i&&(0===e||t+i<=e)}a&&a===c&&r.B0||(this.vertexBuffers[l++]=r,a=r.B0?c:null);const u=r.hashCode+(s<<7);this.F=this.F||this.LJ[n]!==u,this.LJ[n++]=u}this.vertexBuffers.length=l,this.OJ=n,this.F=this.F||n!==s,this.F&&(this.FJ=Math.min(this.FJ,hp.VertexState))}zJ(t){this.U0!==t&&(this.U0=t,this.LJ[hp.TextureStage]=this.U0,this.F=!0,this.FJ=Math.min(this.FJ,hp.TextureStage))}V0(t){if(this.DJ)return this.k0(t);const i=[],e=t.shaderProcessingContext.bindGroupLayoutEntries;for(let t=0;t<e.length;t++){const s=e[t];i[t]=this.oJ.createBindGroupLayout({entries:s})}return t.bindGroupLayouts=i,this.oJ.createPipelineLayout({bindGroupLayouts:i})}k0(t){var i;const e=t.shaderProcessingContext,s=e.bindGroupLayoutEntries;let n=1;for(let t=0;t<s.length;t++){const r=s[t];for(let h=0;h<r.length;h++){const r=s[t][h];if(r.texture){const h=e.bindGroupLayoutEntryInfo[t][r.binding].name,o=e.availableTextures[h],a=o.autoBindSampler?e.availableSamplers[h+Jf.AutoSamplerSuffix]:null;let l=o.sampleType,c=null!==(i=null==a?void 0:a.type)&&void 0!==i?i:yf.Filtering;if(this.U0&n&&l!==Nf.Depth&&(o.autoBindSampler&&(c=yf.NonFiltering),l=Nf.UnfilterableFloat),r.texture.sampleType=l,a){const t=e.bindGroupLayoutEntryInfo[a.binding.groupIndex][a.binding.bindingIndex].index;s[a.binding.groupIndex][t].sampler.type=c}n<<=1}}}const r=[];for(let t=0;t<s.length;++t)r[t]=this.oJ.createBindGroupLayout({entries:s[t]});return t.bindGroupLayouts=r,this.oJ.createPipelineLayout({bindGroupLayouts:r})}G0(t){var i,e;const s=[],n=t.Ms,r=n.shaderProcessingContext.attributeNamesFromEffect,h=n.shaderProcessingContext.attributeLocationsFromEffect;let o,a;for(let t=0;t<r.length;t++){const n=h[t];let l=null!==(i=this.R0&&this.R0[r[t]])&&void 0!==i?i:this.ff[r[t]];l||(l=this.BJ);let c=null===(e=l.getBuffer())||void 0===e?void 0:e.underlyingResource,u=l.byteOffset;const f=!l.B0;if(!o||!a||o!==c||f){const t={arrayStride:l.byteStride,stepMode:l.getIsInstanced()?Xf.Instance:Xf.Vertex,attributes:[]};s.push(t),a=t.attributes,f&&(u=0,c=null)}a.push({shaderLocation:n,offset:u,format:lp.y0(l)}),o=c}return s}$J(t,i,e){var s,n,r;const h=t.Ms,o=this.G0(t),a=this.V0(h),l=[],c=this.N0(),u=this.P0();if(this.HJ>0)for(let t=0;t<this.UJ.length;++t){const i=this.UJ[t];if(i){const e={format:i,writeMask:0!=(this.l0&1<<t)?this.m0:0};c&&u&&(e.blend={alpha:c,color:u}),l.push(e)}else l.push(null)}else if(this.GJ[0]){const t={format:this.GJ[0],writeMask:this.m0};c&&u&&(t.blend={alpha:c,color:u}),l.push(t)}else l.push(null);const f={compare:lp.b0(this.S0?this.E0:7),depthFailOp:lp._0(this.S0?this.A0:1),failOp:lp._0(this.S0?this.w0:1),passOp:lp._0(this.S0?this.C0:1)};let d;i!==Of.LineStrip&&i!==Of.TriangleStrip||(d=!this.Xu||this.Xu.is32Bits?zf.Uint32:zf.Uint16);const p=!!this.v0&&Zd.HasStencilAspect(this.v0);return this.oJ.createRenderPipeline({label:`RenderPipeline_${null!==(n=null===(s=l[0])||void 0===s?void 0:s.format)&&void 0!==n?n:"nooutput"}_${null!==(r=this.v0)&&void 0!==r?r:"nodepth"}_samples${e}`,layout:a,vertex:{module:h.stages.vertexStage.module,entryPoint:h.stages.vertexStage.entryPoint,buffers:o},primitive:{topology:i,stripIndexFormat:d,frontFace:1===this._n?Ff.CCW:Ff.CW,cullMode:this.i0?2===this.Tn?Bf.Front:Bf.Back:Bf.None},fragment:h.stages.fragmentStage?{module:h.stages.fragmentStage.module,entryPoint:h.stages.fragmentStage.entryPoint,targets:l}:void 0,multisample:{count:e},depthStencil:void 0===this.v0?void 0:{depthWriteEnabled:this.s0,depthCompare:this.n0?lp.b0(this.r0):Mf.Always,format:this.v0,stencilFront:this.S0&&p?f:void 0,stencilBack:this.S0&&p?f:void 0,stencilReadMask:this.S0&&p?this.x0:void 0,stencilWriteMask:this.S0&&p?this.T0:void 0,depthBias:this.h0,depthBiasClamp:this.z0,depthBiasSlopeScale:this.o0}})}}lp.NumCacheHitWithoutHash=0,lp.NumCacheHitWithHash=0,lp.NumCacheMiss=0,lp.NumPipelineCreationLastFrame=0,lp.YJ=0;class cp{constructor(){this.values={}}count(){let t=0,i=this.pipeline?1:0;for(const e in this.values){const s=this.values[e],[n,r]=s.count();t+=n,i+=r,t++}return[t,i]}}class up extends lp{constructor(t,i,e){super(t,i,e),this.H0=[],this.H0[0]=up.X0}static GetNodeCounts(){const t=up.X0.count();return{nodeCount:t[0],pipelineCount:t[1]}}static W0(t,i,e,s){if(t.pipeline){const t=e.slice();t.length=s,i.push(t)}for(const n in t.values){const r=t.values[n];e[s]=parseInt(n),up.W0(r,i,e,s+1)}}static GetPipelines(){const t=[];return up.W0(up.X0,t,[],0),t}ZJ(t){let i=this.H0[this.FJ];for(let t=this.FJ;t<this.OJ;++t){let e=i.values[this.LJ[t]];e||(e=new cp,i.values[this.LJ[t]]=e),i=e,this.H0[t+1]=i}t.token=i,t.pipeline=i.pipeline}JJ(t){t.token.pipeline=t.pipeline}}up.X0=new cp;class fp extends gi{constructor(t){super(!1),this.Ii=t,this.reset()}get func(){return this.jr}set func(t){this.jr!==t&&(this.jr=t,this.Ii.setStencilCompare(t))}get funcMask(){return this.qr}set funcMask(t){this.qr!==t&&(this.qr=t,this.Ii.setStencilReadMask(t))}get opStencilFail(){return this.Qr}set opStencilFail(t){this.Qr!==t&&(this.Qr=t,this.Ii.setStencilFailOp(t))}get opDepthFail(){return this.Zr}set opDepthFail(t){this.Zr!==t&&(this.Zr=t,this.Ii.setStencilDepthFailOp(t))}get opStencilDepthPass(){return this.Jr}set opStencilDepthPass(t){this.Jr!==t&&(this.Jr=t,this.Ii.setStencilPassOp(t))}get mask(){return this.th}set mask(t){this.th!==t&&(this.th=t,this.Ii.setStencilWriteMask(t))}get enabled(){return this.ih}set enabled(t){this.ih!==t&&(this.ih=t,this.Ii.setStencilEnabled(t))}reset(){super.reset(),this.Ii.resetStencilState()}apply(){var t;const i=null===(t=this.stencilMaterial)||void 0===t?void 0:t.enabled;this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask)}}class dp extends si{constructor(t){super(!1),this.Ii=t,this.reset()}get zOffset(){return this.wn}set zOffset(t){this.wn!==t&&(this.wn=t,this.An=!0,this.Ii.setDepthBiasSlopeScale(t))}get zOffsetUnits(){return this.xn}set zOffsetUnits(t){this.xn!==t&&(this.xn=t,this.An=!0,this.Ii.setDepthBias(t))}get cullFace(){return this.Tn}set cullFace(t){this.Tn!==t&&(this.Tn=t,this.Sn=!0,this.Ii.setCullFace(null!=t?t:1))}get cull(){return this.Rn}set cull(t){this.Rn!==t&&(this.Rn=t,this.En=!0,this.Ii.setCullEnabled(!!t))}get depthFunc(){return this.In}set depthFunc(t){this.In!==t&&(this.In=t,this.gn=!0,this.Ii.setDepthCompare(t))}get depthMask(){return this.Mn}set depthMask(t){this.Mn!==t&&(this.Mn=t,this.vn=!0,this.Ii.setDepthWriteEnabled(t))}get depthTest(){return this.bn}set depthTest(t){this.bn!==t&&(this.bn=t,this.mn=!0,this.Ii.setDepthTestEnabled(t))}get frontFace(){return this._n}set frontFace(t){this._n!==t&&(this._n=t,this.Cn=!0,this.Ii.setFrontFace(null!=t?t:2))}reset(){super.reset(),this.Ii.resetDepthCullingState()}apply(){}}class pp{constructor(t){this.useMipMaps=!1,this.type=16,this.$0=t,this.uniqueId=ai.Rr++}static IsExternalTexture(t){return void 0!==t.underlyingResource}getClassName(){return"ExternalTexture"}get underlyingResource(){return this.$0}isReady(){return this.$0.readyState>=this.$0.HAVE_CURRENT_DATA}dispose(){}}class mp{constructor(){this.uniqueId=mp.Rr++,this.updateId=0,this.reset()}get forceBindGroupCreation(){return this.Y0>0}get hasFloatTextures(){return this.j0>0}reset(){this.samplers={},this.textures={},this.isDirty=!0,this.j0=0,this.Y0=0}setSampler(t,i){let e=this.samplers[t],s=-1;e?s=e.hashCode:this.samplers[t]=e={sampler:i,hashCode:0},e.sampler=i,e.hashCode=i?rp.GetSamplerHashCode(i):0;const n=s!==e.hashCode;n&&this.updateId++,this.isDirty||(this.isDirty=n)}setTexture(t,i){var e,s,n;let r=this.textures[t],h=-1;r?h=null!==(s=null===(e=r.texture)||void 0===e?void 0:e.uniqueId)&&void 0!==s?s:-1:this.textures[t]=r={texture:i,isFloatTexture:!1,isExternalTexture:!1},r.isExternalTexture&&this.Y0--,r.isFloatTexture&&this.j0--,i?(r.isFloatTexture=1===i.type,r.isExternalTexture=pp.IsExternalTexture(i),r.isFloatTexture&&this.j0++,r.isExternalTexture&&this.Y0++):(r.isFloatTexture=!1,r.isExternalTexture=!1),r.texture=i;const o=h!==(null!==(n=null==i?void 0:i.uniqueId)&&void 0!==n?n:-1);o&&this.updateId++,this.isDirty||(this.isDirty=o)}}mp.Rr=0;class vp{constructor(t){this.cJ=t,this.uniqueId=vp.Rr++,this.K0=!1,this.q0=0,this.reset()}isDirty(t){return this.F||this.Q0!==t}resetIsDirty(t){this.F=!1,this.Q0=t}get useInstancing(){return this.K0}set useInstancing(t){this.K0!==t&&(t?(this.indirectDrawBuffer=this.cJ.createRawBuffer(40,Sf.CopyDst|Sf.Indirect),this.Z0=new Uint32Array(5),this.Z0[3]=0,this.Z0[4]=0):(this.indirectDrawBuffer&&this.cJ.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this.Z0=void 0),this.K0=t,this.q0=-1)}reset(){this.buffers={},this.F=!0,this.Q0=0,this.fastBundle=void 0,this.bindGroups=void 0}setBuffer(t,i){var e;this.F||(this.F=(null==i?void 0:i.uniqueId)!==(null===(e=this.buffers[t])||void 0===e?void 0:e.uniqueId)),this.buffers[t]=i}setIndirectData(t,i,e){i!==this.q0&&this.indirectDrawBuffer&&this.Z0&&(this.q0=i,this.Z0[0]=t,this.Z0[1]=i,this.Z0[2]=e,this.cJ.setRawData(this.indirectDrawBuffer,0,this.Z0,0,20))}dispose(){this.indirectDrawBuffer&&(this.cJ.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this.Z0=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0}}vp.Rr=0;class gp{constructor(){this.values={}}}class Sp{constructor(t,i,e){this.disabled=!1,this.oJ=t,this.J0=i,this.Ls=e}static get Statistics(){return{totalCreated:Sp.NumBindGroupsCreatedTotal,lastFrameCreated:Sp.NumBindGroupsCreatedLastFrame,lookupLastFrame:Sp.NumBindGroupsLookupLastFrame,noLookupLastFrame:Sp.NumBindGroupsNoLookupLastFrame}}endFrame(){Sp.NumBindGroupsCreatedLastFrame=Sp.t1,Sp.NumBindGroupsLookupLastFrame=Sp.i1,Sp.NumBindGroupsNoLookupLastFrame=Sp.e1,Sp.t1=0,Sp.i1=0,Sp.e1=0}getBindGroups(t,i,e){var s,n,r,h,o,a,l,c,u,f;let d,p=Sp.X0;const m=this.disabled||e.forceBindGroupCreation;if(!m){if(!i.isDirty(e.updateId)&&!e.isDirty)return Sp.e1++,i.bindGroups;for(const e of t.shaderProcessingContext.bufferNames){const t=null!==(n=null===(s=i.buffers[e])||void 0===s?void 0:s.uniqueId)&&void 0!==n?n:0;let r=p.values[t];r||(r=new gp,p.values[t]=r),p=r}for(const i of t.shaderProcessingContext.samplerNames){const t=null!==(h=null===(r=e.samplers[i])||void 0===r?void 0:r.hashCode)&&void 0!==h?h:0;let s=p.values[t];s||(s=new gp,p.values[t]=s),p=s}for(const i of t.shaderProcessingContext.textureNames){const t=null!==(l=null===(a=null===(o=e.textures[i])||void 0===o?void 0:o.texture)||void 0===a?void 0:a.uniqueId)&&void 0!==l?l:0;let s=p.values[t];s||(s=new gp,p.values[t]=s),p=s}d=p.bindGroups}if(i.resetIsDirty(e.updateId),e.isDirty=!1,d)return i.bindGroups=d,Sp.i1++,d;d=[],i.bindGroups=d,m||(p.bindGroups=d),Sp.NumBindGroupsCreatedTotal++,Sp.t1++;const v=t.bindGroupLayouts;for(let s=0;s<t.shaderProcessingContext.bindGroupLayoutEntries.length;s++){const n=t.shaderProcessingContext.bindGroupLayoutEntries[s],r=t.shaderProcessingContext.bindGroupEntries[s];for(let h=0;h<n.length;h++){const n=t.shaderProcessingContext.bindGroupLayoutEntries[s][h],o=t.shaderProcessingContext.bindGroupLayoutEntryInfo[s][n.binding],a=null!==(c=o.nameInArrayOfTexture)&&void 0!==c?c:o.name;if(n.sampler){const t=e.samplers[a];if(t){const i=t.sampler;if(!i){this.Ls.dbgSanityChecks&&F.Error(`Trying to bind a null sampler! entry=${JSON.stringify(n)}, name=${a}, bindingInfo=${JSON.stringify(t,((t,i)=>"texture"===t?"<no dump>":i))}, materialContext.uniqueId=${e.uniqueId}`,50);continue}r[h].resource=this.J0.getSampler(i,!1,t.hashCode)}else F.Error(`Sampler "${a}" could not be bound. entry=${JSON.stringify(n)}, materialContext=${JSON.stringify(e,((t,i)=>"texture"===t||"sampler"===t?"<no dump>":i))}`,50)}else if(n.texture||n.storageTexture){const t=e.textures[a];if(t){if(this.Ls.dbgSanityChecks&&null===t.texture){F.Error(`Trying to bind a null texture! entry=${JSON.stringify(n)}, bindingInfo=${JSON.stringify(t,((t,i)=>"texture"===t?"<no dump>":i))}, materialContext.uniqueId=${e.uniqueId}`,50);continue}const i=t.texture.Er;if(this.Ls.dbgSanityChecks&&(!i||n.texture&&!i.view||n.storageTexture&&!i.viewForWriting)){F.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(n)}, name=${a}, bindingInfo=${JSON.stringify(t,((t,i)=>"texture"===t?"<no dump>":i))}, isReady=${null===(u=t.texture)||void 0===u?void 0:u.isReady}, materialContext.uniqueId=${e.uniqueId}`,50);continue}r[h].resource=n.storageTexture?i.viewForWriting:i.view}else F.Error(`Texture "${a}" could not be bound. entry=${JSON.stringify(n)}, materialContext=${JSON.stringify(e,((t,i)=>"texture"===t||"sampler"===t?"<no dump>":i))}`,50)}else if(n.externalTexture){const t=e.textures[a];if(t){if(this.Ls.dbgSanityChecks&&null===t.texture){F.Error(`Trying to bind a null external texture! entry=${JSON.stringify(n)}, name=${a}, bindingInfo=${JSON.stringify(t,((t,i)=>"texture"===t?"<no dump>":i))}, materialContext.uniqueId=${e.uniqueId}`,50);continue}const i=t.texture.underlyingResource;if(this.Ls.dbgSanityChecks&&!i){F.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(n)}, name=${a}, bindingInfo=${JSON.stringify(t,((t,i)=>"texture"===t?"<no dump>":i))}, isReady=${null===(f=t.texture)||void 0===f?void 0:f.isReady}, materialContext.uniqueId=${e.uniqueId}`,50);continue}r[h].resource=this.oJ.importExternalTexture({source:i})}else F.Error(`Texture "${a}" could not be bound. entry=${JSON.stringify(n)}, materialContext=${JSON.stringify(e,((t,i)=>"texture"===t||"sampler"===t?"<no dump>":i))}`,50)}else if(n.buffer){const t=i.buffers[a];if(t){const i=t.underlyingResource;r[h].resource.buffer=i,r[h].resource.size=t.capacity}else F.Error(`Can't find buffer "${a}". entry=${JSON.stringify(n)}, buffers=${JSON.stringify(i.buffers)}, drawContext.uniqueId=${i.uniqueId}`,50)}}const h=v[s];d[s]=this.oJ.createBindGroup({layout:h,entries:r})}return d}}Sp.NumBindGroupsCreatedTotal=0,Sp.NumBindGroupsCreatedLastFrame=0,Sp.NumBindGroupsLookupLastFrame=0,Sp.NumBindGroupsNoLookupLastFrame=0,Sp.X0=new gp,Sp.t1=0,Sp.i1=0,Sp.e1=0;const Ep="clearQuadVertexShader",Ap="uniform float depthValue;\nconst vec2 pos[4]={\nvec2(-1.0,1.0),\nvec2(1.0,1.0),\nvec2(-1.0,-1.0),\nvec2(1.0,-1.0)\n};\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\ngl_Position=vec4(pos[gl_VertexID],depthValue,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n";ii.ShadersStore[Ep]=Ap;const Cp="clearQuadPixelShader",wp="uniform vec4 color;\nvoid main() {\ngl_FragColor=color;\n}\n";ii.ShadersStore[Cp]=wp;class xp{constructor(t,i,e){this.s1={},this.n1={},this.h1=[],this.oJ=t,this.Ls=i,this.o1=new up(this.oJ,e,!i.po.textureFloatLinearFiltering),this.o1.setDepthTestEnabled(!1),this.o1.setStencilReadMask(255),this.oK=i.createEffect("clearQuad",[],["color","depthValue"])}setDepthStencilFormat(t){this.a1=t,this.o1.setDepthStencilFormat(t)}setColorFormat(t){this.o1.setColorFormat(t)}setMRTAttachments(t,i,e){this.o1.setMRT(i,e),this.o1.setMRTAttachments(t)}clear(t,i,e,s,n=1){var r,h;let o,a,l=null;const c=!!this.Ls.zo;if(t)o=t;else{let t=0;this.h1.length=0;for(let i=0;i<this.o1.colorFormats.length;++i)this.h1[t++]=Qd[null!==(r=this.o1.colorFormats[i])&&void 0!==r?r:""];const u=Qd[null!==(h=this.a1)&&void 0!==h?h:0];if(this.h1[t]=(i?i.r+256*i.g+256*i.b*256+256*i.a*256*256:0)+(e?2**32:0)+(s?2**33:0)+(this.Ls.useReverseDepthBuffer?2**34:0)+(c?2**35:0)+(n>1?2**36:0)+u*2**37,a=this.h1.join("_"),l=this.n1[a],l)return l;o=this.oJ.createRenderBundleEncoder({colorFormats:this.o1.colorFormats,depthStencilFormat:this.a1,sampleCount:n})}this.o1.setDepthWriteEnabled(!!e),this.o1.setStencilEnabled(!!s&&!!this.a1&&Zd.HasStencilAspect(this.a1)),this.o1.setStencilWriteMask(s?255:0),this.o1.setStencilCompare(s?519:512),this.o1.setStencilPassOp(s?7681:7680),this.o1.setWriteMask(i?15:0);const u=this.o1.getRenderPipeline(7,this.oK,n),f=this.oK.Ms;i&&this.oK.setDirectColor4("color",i),this.oK.setFloat("depthValue",this.Ls.useReverseDepthBuffer?this.Ls.l1:this.Ls.c1),f.uniformBuffer.update();const d=c?this.Ls.u1:this.Ls.f1,p=f.uniformBuffer.getBuffer(),m=p.uniqueId+"-"+d.uniqueId;let v=this.s1[m];if(!v){const t=f.bindGroupLayouts;v=this.s1[m]=[],v.push(this.oJ.createBindGroup({layout:t[0],entries:[]})),ed.DZ||v.push(this.oJ.createBindGroup({layout:t[1],entries:[]})),v.push(this.oJ.createBindGroup({layout:t[ed.DZ?1:2],entries:[{binding:0,resource:{buffer:d.underlyingResource,size:d.capacity}},{binding:1,resource:{buffer:p.underlyingResource,size:p.capacity}}]}))}o.setPipeline(u);for(let t=0;t<v.length;++t)o.setBindGroup(t,v[t]);return o.draw(4,1,0,0),t||(l=o.finish(),this.n1[a]=l),l}}class Tp{constructor(t,i,e,s){this.x=Math.floor(t),this.y=Math.floor(i),this.w=Math.floor(e),this.h=Math.floor(s)}run(t){t.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new Tp(this.x,this.y,this.w,this.h)}}class Rp{constructor(t,i,e,s){this.x=t,this.y=i,this.w=e,this.h=s}run(t){t.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new Rp(this.x,this.y,this.w,this.h)}}class Ip{constructor(t){this.ref=t}run(t){t.setStencilReference(this.ref)}clone(){return new Ip(this.ref)}}class Mp{constructor(t){this.color=t}run(t){t.setBlendConstant(this.color)}clone(){return new Mp(this.color)}}class bp{constructor(t){this.query=t}run(t){t.beginOcclusionQuery(this.query)}clone(){return new bp(this.query)}}class _p{constructor(){}run(t){t.endOcclusionQuery()}clone(){return new _p}}class yp{constructor(){this.bundles=[]}run(t){t.executeBundles(this.bundles)}clone(){const t=new yp;return t.bundles=this.bundles,t}}class Np{constructor(t){this.numDrawCalls=0,this.oJ=t,this.d1=new Array(10),this.m1=0}addBundle(t){if(!this.v1){const t=new yp;this.d1[this.m1++]=t,this.g1=t.bundles,this.v1=!0}t&&this.g1.push(t)}S1(){this.v1&&this.E1&&(this.g1.push(this.E1.finish()),this.E1=void 0,this.v1=!1)}addItem(t){this.S1(),this.d1[this.m1++]=t,this.v1=!1}getBundleEncoder(t,i,e){return this.v1||(this.addBundle(),this.E1=this.oJ.createRenderBundleEncoder({colorFormats:t,depthStencilFormat:i,sampleCount:e})),this.E1}close(){this.S1()}run(t){this.close();for(let i=0;i<this.m1;++i)this.d1[i].run(t)}reset(){this.m1=0,this.v1=!1,this.numDrawCalls=0}clone(){this.close();const t=new Np(this.oJ);t.d1=new Array(this.m1),t.m1=this.m1,t.numDrawCalls=this.numDrawCalls;for(let i=0;i<this.m1;++i)t.d1[i]=this.d1[i].clone();return t}}class Pp{constructor(t,i,e,s,n=!0){this.A1=[],this.oJ=e,this.cJ=s,this.Tl=t,this.C1=n,this.w1=e.createQuerySet({type:i,count:t}),this.T1=s.createRawBuffer(8*t,Sf.QueryResolve|Sf.CopySrc),n||this.A1.push(this.cJ.createRawBuffer(8*this.Tl,Sf.MapRead|Sf.CopyDst))}get querySet(){return this.w1}I1(t,i){if(!this.C1&&0===this.A1.length)return null;const e=this.oJ.createCommandEncoder();let s;return 0===this.A1.length?s=this.cJ.createRawBuffer(8*this.Tl,Sf.MapRead|Sf.CopyDst):(s=this.A1[this.A1.length-1],this.A1.length--),e.resolveQuerySet(this.w1,t,i,this.T1,0),e.copyBufferToBuffer(this.T1,0,s,0,8*i),this.oJ.queue.submit([e.finish()]),s}async readValues(t=0,i=1){const e=this.I1(t,i);if(null===e)return null;await e.mapAsync(Ef.Read);const s=new BigUint64Array(e.getMappedRange()).slice();return e.unmap(),this.A1[this.A1.length]=e,s}async readValue(t=0){const i=this.I1(t,1);if(null===i)return null;await i.mapAsync(Ef.Read);const e=new BigUint64Array(i.getMappedRange()),s=Number(e[0]);return i.unmap(),this.A1[this.A1.length]=i,s}async readTwoValuesAndSubtract(t=0){const i=this.I1(t,2);if(null===i)return null;await i.mapAsync(Ef.Read);const e=new BigUint64Array(i.getMappedRange()),s=Number(e[1]-e[0]);return i.unmap(),this.A1[this.A1.length]=i,s}dispose(){this.w1.destroy(),this.cJ.releaseBuffer(this.T1);for(let t=0;t<this.A1.length;++t)this.cJ.releaseBuffer(this.A1[t])}}class Dp{constructor(t,i){this.ih=!1,this.M1=new Ne,this.b1=0,this.oJ=t,this.cJ=i}get gpuFrameTimeCounter(){return this.M1}get enable(){return this.ih}set enable(t){this.ih!==t&&(this.ih=t,this.b1=0,t?this._1=new Lp(this.oJ,this.cJ):this._1.dispose())}startFrame(t){this.ih&&0===this.b1&&(this._1.start(t),this.b1=1)}endFrame(t){1===this.b1&&(this.b1=2,this._1.stop(t).then((t=>{null!==t&&t>=0&&(this.M1.fetchNewFrame(),this.M1.addCount(t,!0)),this.b1=0})))}}class Lp{constructor(t,i){this.w1=new Pp(2,Kf.Timestamp,t,i)}start(t){t.writeTimestamp(this.w1.querySet,0)}async stop(t){return t.writeTimestamp(this.w1.querySet,1),this.w1.readTwoValuesAndSubtract(0)}dispose(){this.w1.dispose()}}class Op{constructor(t,i,e,s=50,n=100){this.N1=[],this.Ls=t,this.oJ=i,this.cJ=e,this.P1=-1,this.D1=0,this.O1=n,this.F1(s)}get querySet(){return this.w1.querySet}get hasQueries(){return this.D1!==this.N1.length}get canBeginQuery(){switch(this.Ls.B1()){case 0:return void 0!==this.Ls.U1.renderPassDescriptor.occlusionQuerySet;case 1:return void 0!==this.Ls.V1.renderPassDescriptor.occlusionQuerySet}return!1}createQuery(){0===this.N1.length&&this.F1();const t=this.N1[this.N1.length-1];return this.N1.length--,t}deleteQuery(t){this.N1[this.N1.length-1]=t}isQueryResultAvailable(t){return this.G1(),!!this.z1&&t<this.z1.length}getQueryResult(t){var i,e;return Number(null!==(e=null===(i=this.z1)||void 0===i?void 0:i[t])&&void 0!==e?e:-1)}G1(){this.z1&&this.P1===this.Ls.frameId||this.P1!==this.Ls.frameId&&(this.P1=this.Ls.frameId,this.w1.readValues(0,this.D1).then((t=>{this.z1=t})))}F1(t){t=null!=t?t:this.O1,this.H1();for(let i=0;i<t;++i)this.N1.push(this.D1+i);this.D1+=t,this.w1=new Pp(this.D1,Kf.Occlusion,this.oJ,this.cJ,!1)}H1(){const t=this.w1;t&&setTimeout((()=>t.dispose),1e3)}dispose(){var t;null===(t=this.w1)||void 0===t||t.dispose(),this.N1.length=0}}class Fp{constructor(){this.X1=null}async initTwgsl(t){return t=t||{},(t={...Fp.W1,...t}).twgsl?(this.X1=t.twgsl,Promise.resolve()):(t.jsPath&&t.wasmPath&&(xt()?await ki.LoadScriptAsync(t.jsPath):importScripts(t.jsPath)),self.twgsl?(this.X1=await self.twgsl(t.wasmPath),Promise.resolve()):Promise.reject("twgsl is not available."))}convertSpirV2WGSL(t){const i=this.X1.convertSpirV2WGSL(t);return Fp.ShowWGSLShaderCode&&(console.log(i),console.log("***********************************************")),i}}Fp.W1={jsPath:"https://preview.babylonjs.com/twgsl/twgsl.js",wasmPath:"https://preview.babylonjs.com/twgsl/twgsl.wasm"},Fp.ShowWGSLShaderCode=!1;class Bp{constructor(t,i,e,s){this.Y1=!1,this.j1=!1,this.K1=[],this.ih=!1,this.Ls=t,this.uA=i,this.q1=e,this.Q1=s}get enabled(){return this.ih}get play(){return this.j1}get record(){return this.Y1}set enabled(t){this.K1.length=0,this.Y1=this.ih=t,this.j1=!1,t&&(this.Z1=this.uA,this.uA=0)}get mode(){return this.uA}set mode(t){this.Y1?this.Z1=t:this.uA=t}endMainRenderPass(){this.Y1&&this.K1.push(this.q1.clone())}endRenderTargetPass(t,i){var e,s,n,r;if(this.j1)null===(s=null===(e=i.J1)||void 0===e?void 0:e[i.t2])||void 0===s||s.run(t),1===this.uA&&this.Ls.da(null===(r=null===(n=i.J1)||void 0===n?void 0:n[i.t2])||void 0===r?void 0:r.numDrawCalls);else{if(!this.Y1)return!1;i.J1||(i.J1=[]),i.J1[i.t2]=this.Q1.clone(),i.J1[i.t2].run(t),this.Q1.reset()}return!0}endFrame(t){if(this.Y1&&(this.K1.push(this.q1.clone()),this.Y1=!1,this.j1=!0,this.uA=this.Z1),null!==t&&this.j1)for(let i=0;i<this.K1.length;++i)this.K1[i].run(t),1===this.uA&&this.Ls.da(this.K1[i].numDrawCalls)}reset(){this.enabled=!1,this.enabled=!0}}class Up extends Rs{constructor(t,i={}){var e,s,n,r;if(super(null),this.i2={label:"upload"},this.e2={label:"render"},this.s2={label:"renderTarget"},this.c1=1,this.l1=0,this.n2=0,this.h2=4,this.aJ=null,this.lJ=null,this.o2={},this.a2={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this.l2=[null,null,null],this.c2=null,this.U1=new ip,this.V1=new ip,this.u2=[],this.f2=new h,this.d2=null,this.m2=null,this.v2=!0,this.g2=!1,this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsForFirstFrames=!1,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.S2=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],this.E2=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],this.A2={x:0,y:0,z:0,w:0},this.C2=[-1,-1],this.w2=[[null,null,null,null],[null,null,null,null]],this.hn="WebGPU",this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,i.deviceDescriptor=i.deviceDescriptor||{},i.antialiasing=void 0===i.antialiasing||i.antialiasing,i.stencil=null===(e=i.stencil)||void 0===e||e,i.enableGPUDebugMarkers=null!==(s=i.enableGPUDebugMarkers)&&void 0!==s&&s,S.SetMatrixPrecision(!!i.useHighPrecisionMatrix),F.Log(`Babylon.js v${Rs.Version} - ${this.description} engine`),!navigator.gpu)return void F.Error("WebGPU is not supported by your browser.");i.swapChainFormat=i.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this.Yh=!0,this.co="WEBGPU",void 0===i.deterministicLockstep&&(i.deterministicLockstep=!1),void 0===i.lockstepMaxSteps&&(i.lockstepMaxSteps=4),void 0===i.audioEngine&&(i.audioEngine=!0),this.Cw=i.deterministicLockstep,this.ww=i.lockstepMaxSteps,this.xw=i.timeStep||1/60,this.mh=!!i.doNotHandleContextLost,this.GW=t,this.wb=i,this.premultipliedAlpha=null===(n=i.premultipliedAlpha)||void 0===n||n;const o=xt()&&window.devicePixelRatio||1,a=i.limitDeviceRatio||o,l=null!==(r=i.adaptToDeviceRatio)&&void 0!==r&&r;this.uo=l?1/Math.min(a,o):1,this.T2=i.antialiasing?this.h2:1,this.fo=i.stencil,this.yo(t,!!i.doNotHandleTouchAction,i.audioEngine),this.mo=new sd,this.I2=new Xd}get snapshotRenderingMode(){return this.M2.mode}set snapshotRenderingMode(t){this.M2.mode=t}snapshotRenderingReset(){this.M2.reset()}get snapshotRendering(){return this.M2.enabled}set snapshotRendering(t){this.M2.enabled=t}get disableCacheSamplers(){return!!this.J0&&this.J0.disabled}set disableCacheSamplers(t){this.J0&&(this.J0.disabled=t)}get disableCacheRenderPipelines(){return!!this.o1&&this.o1.disabled}set disableCacheRenderPipelines(t){this.o1&&(this.o1.disabled=t)}get disableCacheBindGroups(){return!!this.b2&&this.b2.disabled}set disableCacheBindGroups(t){this.b2&&(this.b2.disabled=t)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then((t=>!!t),(()=>!1)).catch((()=>!1)):Promise.resolve(!1)}static get IsSupported(){return F.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._2}get enabledExtensions(){return this.N2}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:"unknown vendor",renderer:"unknown renderer",version:"unknown version"}}get compatibilityMode(){return this.bw}set compatibilityMode(t){this.bw=t}get currentSampleCount(){return this.zo?this.zo.samples:this.T2}static CreateAsync(t,i={}){const e=new Up(t,i);return new Promise((t=>{e.initAsync(i.glslangOptions,i.twgslOptions).then((()=>t(e)))}))}initAsync(t,i){var e;return this.P2(null!=t?t:null===(e=this.wb)||void 0===e?void 0:e.glslangOptions).then((t=>{var e;return this.aJ=t,this.lJ=Up.UseTWGSL?new Fp:null,this.lJ?this.lJ.initTwgsl(null!=i?i:null===(e=this.wb)||void 0===e?void 0:e.twgslOptions).then((()=>navigator.gpu.requestAdapter(this.wb)),(t=>{throw F.Error("Can not initialize twgsl!"),F.Error(t),Error("WebGPU initializations stopped.")})):navigator.gpu.requestAdapter(this.wb)}),(t=>{throw F.Error("Can not initialize glslang!"),F.Error(t),Error("WebGPU initializations stopped.")})).then((t=>{var i;if(t){this.D2=t,this._2=[],null===(i=this.D2.features)||void 0===i||i.forEach((t=>this._2.push(t)));const e=this.wb.deviceDescriptor;if(null==e?void 0:e.requiredFeatures){const t=e.requiredFeatures,i=[];for(const e of t)-1!==this._2.indexOf(e)&&i.push(e);e.requiredFeatures=i}return this.D2.requestDevice(this.wb.deviceDescriptor)}throw"Could not retrieve a WebGPU adapter (adapter is null)."})).then((t=>{var i,e;this.oJ=t,this.N2=[],null===(i=this.oJ.features)||void 0===i||i.forEach((t=>this.N2.push(t)));let s=-1;this.oJ.addEventListener("uncapturederror",(t=>{++s<this.numMaxUncapturedErrors?F.Warn(`WebGPU uncaptured error (${s+1}): ${t.error} - ${t.error.message}`):s++===this.numMaxUncapturedErrors&&F.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)})),this.mh||null===(e=this.oJ.lost)||void 0===e||e.then((t=>{this.ph=!0,F.Warn("WebGPU context lost. "+t),this.onContextLostObservable.notifyObservers(this),this.oo(this.initAsync.bind(this))}))}),(t=>{F.Error("Could not retrieve a WebGPU device."),F.Error(t)})).then((()=>{this.cJ=new tp(this.oJ),this.O2=new Zd(this.oJ,this.aJ,this.lJ,this.cJ),this.J0=new rp(this.oJ),this.b2=new Sp(this.oJ,this.J0,this),this.F2=new Dp(this.oJ,this.cJ),this.yT=this.oJ.createQuerySet?new Op(this,this.oJ,this.cJ):void 0,this.q1=new Np(this.oJ),this.Q1=new Np(this.oJ),this.M2=new Bp(this,this.jh,this.q1,this.Q1),this.u1=this.cJ.createBuffer(new Float32Array([-1,0]),Sf.Uniform|Sf.CopyDst),this.f1=this.cJ.createBuffer(new Float32Array([1,0]),Sf.Uniform|Sf.CopyDst),this.dbgVerboseLogsForFirstFrames&&void 0===this.Tl&&(this.Tl=0,console.log("%c frame #"+this.Tl+" - begin","background: #ffff00")),this.B2=this.oJ.createCommandEncoder(this.i2),this.U2=this.oJ.createCommandEncoder(this.e2),this.V2=this.oJ.createCommandEncoder(this.s2),this.BJ=new he(this,[0],"",!1,!1,1,!1,0,1),this.G2(),this.o1=new up(this.oJ,this.BJ,!this.po.textureFloatLinearFiltering),this.Eh=new dp(this.o1),this.Ah=new fp(this.o1),this.Ah.stencilGlobal=this.Ch,this.Eh.depthTest=!0,this.Eh.depthFunc=515,this.Eh.depthMask=!0,this.O2.setCommandEncoder(this.B2),this.z2=new xp(this.oJ,this,this.BJ),this.H2=this.createDrawContext(),this.JI=this.H2,this.X2=this.createMaterialContext(),this.W2=this.X2,this.Y2(),this.j2(),this.resize()})).catch((t=>{F.Error("Can not create WebGPU Device and/or context."),F.Error(t),console.trace&&console.trace()}))}P2(t){return t=t||{},(t={...Up.K2,...t}).glslang?Promise.resolve(t.glslang):self.glslang?self.glslang(t.wasmPath):t.jsPath&&t.wasmPath?xt()?ki.LoadScriptAsync(t.jsPath).then((()=>self.glslang(t.wasmPath))):(importScripts(t.jsPath),self.glslang(t.wasmPath)):Promise.reject("gslang is not available.")}G2(){this.po={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:8192,maxCubemapTextureSize:2048,maxRenderTextureSize:8192,maxVertexAttribs:16,maxVaryingVectors:15,maxFragmentUniformVectors:1024,maxVertexUniformVectors:1024,standardDerivatives:!0,astc:this.N2.indexOf(gf.TextureCompressionASTC)>=0||void 0,s3tc:this.N2.indexOf(gf.TextureCompressionBC)>=0||void 0,pvrtc:null,etc1:null,etc2:this.N2.indexOf(gf.TextureCompressionETC2)>=0||void 0,bptc:this.N2.indexOf(gf.TextureCompressionBC)>=0||void 0,maxAnisotropy:4,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:"undefined"!=typeof BigUint64Array&&-1!==this.enabledExtensions.indexOf(gf.TimestampQuery)||void 0,supportOcclusionQuery:"undefined"!=typeof BigUint64Array,canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:2048},this.po.parallelShaderCompile=null,this.hs={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,Fo:!1}}Y2(){this.zr=this.GW.getContext("webgpu"),this.q2(),this.a0=this.wb.swapChainFormat,this.U1.colorAttachmentGPUTextures=[new Wd],this.U1.colorAttachmentGPUTextures[0].format=this.a0}j2(){if(!this.cJ)return;this.flushFramebuffer(!1),this.Q2={width:this.getRenderWidth(),height:this.getRenderHeight(),depthOrArrayLayers:1};const t=new Float32Array([this.getRenderHeight()]);let i;if(this.cJ.setSubData(this.u1,4,t),this.cJ.setSubData(this.f1,4,t),this.wb.antialiasing){const t={label:"Texture_MainColor_antialiasing",size:this.Q2,mipLevelCount:1,sampleCount:this.T2,dimension:Af.E2d,format:this.wb.swapChainFormat,usage:Cf.RenderAttachment};this.Z2&&this.O2.releaseTexture(this.Z2),this.Z2=this.oJ.createTexture(t),i=[{view:this.Z2.createView(),clearValue:new y(0,0,0,1),loadOp:Yf.Clear,storeOp:jf.Store}]}else i=[{view:void 0,clearValue:new y(0,0,0,1),loadOp:Yf.Clear,storeOp:jf.Store}];this.U1.depthTextureFormat=this.isStencilEnable?Tf.Depth24PlusStencil8:Tf.Depth32Float,this.J2(this.U1);const e={label:"Texture_MainDepthStencil",size:this.Q2,mipLevelCount:1,sampleCount:this.T2,dimension:Af.E2d,format:this.U1.depthTextureFormat,usage:Cf.RenderAttachment};this.t3&&this.O2.releaseTexture(this.t3),this.t3=this.oJ.createTexture(e);const s={view:this.t3.createView(),depthClearValue:this.c1,depthLoadOp:Yf.Clear,depthStoreOp:jf.Store,stencilClearValue:this.n2,stencilLoadOp:this.isStencilEnable?Yf.Clear:void 0,stencilStoreOp:this.isStencilEnable?jf.Store:void 0};this.U1.renderPassDescriptor={colorAttachments:i,depthStencilAttachment:s}}q2(){this.zr.configure({device:this.oJ,format:this.wb.swapChainFormat,usage:Cf.RenderAttachment|Cf.CopySrc,alphaMode:this.premultipliedAlpha?qf.Premultiplied:qf.Opaque})}setSize(t,i,e=!1){return!!super.setSize(t,i,e)&&(this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - setSize called -",t,i)),this.j2(),this.snapshotRendering&&this.snapshotRenderingReset(),!0)}$s(t){return t===qt.WGSL?this.I2:this.mo}Xs(t){return new ed(t)}applyStates(){this.Ah.apply(),this.o1.setAlphaBlendEnabled(this.wh.alphaBlend)}wipeCaches(t){this.preventCacheWipeBetweenFrames&&!t||(this.g2=!0,this.m2=null,this.d2=null,this.o1.setBuffers(null,null,null),t&&(this.Ah.reset(),this.Eh.reset(),this.Eh.depthFunc=515,this.wh.reset(),this.xh=1,this.Th=0,this.o1.setAlphaBlendFactors(this.wh.yn,this.wh.Nn),this.o1.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this.Zo=null,this.ia=null,this.la=null)}setColorWrite(t){this.v2=t,this.o1.setWriteMask(t?15:0)}getColorWrite(){return this.v2}i3(t){this.S2[t].x=0,this.S2[t].y=0,this.S2[t].w=0,this.S2[t].h=0,1===t&&(this.qh.x=0,this.qh.y=0,this.qh.z=0,this.qh.w=0)}e3(t){const i=t===this.U1.renderPass?0:1,e=this.qh.x,s=this.qh.y,n=this.qh.z,r=this.qh.w,h=this.S2[i].x!==e||this.S2[i].y!==s||this.S2[i].w!==n||this.S2[i].h!==r;return h&&(this.S2[i].x=this.qh.x,this.S2[i].y=this.qh.y,this.S2[i].w=this.qh.z,this.S2[i].h=this.qh.w),h}s3(t){let i=Math.floor(this.qh.y);const e=Math.floor(this.qh.w);this.zo||(i=this.getRenderHeight()-i-e),t.setViewport(Math.floor(this.qh.x),i,Math.floor(this.qh.z),e,0,1),this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - viewport applied - (",this.qh.x,this.qh.y,this.qh.z,this.qh.w,") current pass is main pass="+(t===this.U1.renderPass)))}Ho(t,i,e,s){this.qh.x=t,this.qh.y=i,this.qh.z=e,this.qh.w=s}n3(t){this.E2[t].x=0,this.E2[t].y=0,this.E2[t].w=0,this.E2[t].h=0}r3(t){const i=t===this.U1.renderPass?0:1,e=this.A2.x,s=this.A2.y,n=this.A2.z,r=this.A2.w,h=this.E2[i].x!==e||this.E2[i].y!==s||this.E2[i].w!==n||this.E2[i].h!==r;return h&&(this.E2[i].x=this.A2.x,this.E2[i].y=this.A2.y,this.E2[i].w=this.A2.z,this.E2[i].h=this.A2.w),h}h3(t){t.setScissorRect(this.A2.x,this.zo?this.A2.y:this.getRenderHeight()-this.A2.w-this.A2.y,this.A2.z,this.A2.w),this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - scissor applied - (",this.A2.x,this.A2.y,this.A2.z,this.A2.w,") current pass is main pass="+(t===this.U1.renderPass)))}o3(){return 0!==this.A2.x||0!==this.A2.y||0!==this.A2.z||0!==this.A2.w}enableScissor(t,i,e,s){this.A2.x=t,this.A2.y=i,this.A2.z=e,this.A2.w=s}disableScissor(){this.A2.x=0,this.A2.y=0,this.A2.z=0,this.A2.w=0,this.n3(0),this.n3(1)}a3(t){this.C2[t]=-1}l3(t){const i=t===this.U1.renderPass?0:1,e=this.Ah.funcRef!==this.C2[i];return e&&(this.C2[i]=this.Ah.funcRef),e}c3(t){var i;t.setStencilReference(null!==(i=this.Ah.funcRef)&&void 0!==i?i:0)}u3(t){this.w2[t][0]=this.w2[t][1]=this.w2[t][2]=this.w2[t][3]=null}f3(t){const i=t===this.U1.renderPass?0:1,e=this.wh.Pn,s=e[0]!==this.w2[i][0]||e[1]!==this.w2[i][1]||e[2]!==this.w2[i][2]||e[3]!==this.w2[i][3];return s&&(this.w2[i][0]=e[0],this.w2[i][1]=e[1],this.w2[i][2]=e[2],this.w2[i][3]=e[3]),s}d3(t){t.setBlendConstant(this.wh.Pn)}clear(t,i,e,s=!1){t&&void 0===t.a&&(t.a=1);const n=this.o3();this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - clear called - backBuffer=",i," depth=",e," stencil=",s," scissor is active=",n)),this.zo?n?(this.V1.renderPass||this.m3(this.zo,!1,i?t:null,e,s),this.compatibilityMode?this.h3(this.c2):this.Q1.addItem(new Rp(this.A2.x,this.A2.y,this.A2.z,this.A2.w)),this.v3(i?t:null,e,s)):(this.c2&&this.g3(),this.m3(this.zo,!0,i?t:null,e,s)):(this.U1.renderPass&&n||this.S3(!n,i?t:null,e,s),n&&(this.compatibilityMode?this.h3(this.c2):this.q1.addItem(new Rp(this.A2.x,this.A2.y,this.A2.z,this.A2.w)),this.v3(i?t:null,e,s)))}v3(t,i,e){var s,n,r;const h=this.compatibilityMode?this.E3():null,o=0===this.B1()?this.q1:this.Q1;this.z2.setColorFormat(this.a0),this.z2.setDepthStencilFormat(this.a1),this.z2.setMRTAttachments(null!==(s=this.o1.mrtAttachments)&&void 0!==s?s:[],null!==(n=this.o1.mrtTextureArray)&&void 0!==n?n:[],this.o1.mrtTextureCount),this.compatibilityMode?h.setStencilReference(this.n2):o.addItem(new Ip(this.n2));const a=this.z2.clear(h,t,i,e,this.currentSampleCount);this.compatibilityMode?this.c3(h):(o.addBundle(a),o.addItem(new Ip(null!==(r=this.Ah.funcRef)&&void 0!==r?r:0)),this.da())}createVertexBuffer(t){let i;i=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t;return this.cJ.createBuffer(i,Sf.Vertex|Sf.CopyDst)}createDynamicVertexBuffer(t){return this.createVertexBuffer(t)}createIndexBuffer(t){let i,e=!0;t instanceof Uint32Array||t instanceof Int32Array?i=t:t instanceof Uint16Array?(i=t,e=!1):t.length>65535?i=new Uint32Array(t):(i=new Uint16Array(t),e=!1);const s=this.cJ.createBuffer(i,Sf.Index|Sf.CopyDst);return s.is32Bits=e,s}A3(t,i){let e;e=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t;let s=0;return 1&i&&(s|=Sf.CopySrc),2&i&&(s|=Sf.CopyDst),4&i&&(s|=Sf.Uniform),8&i&&(s|=Sf.Vertex),16&i&&(s|=Sf.Index),32&i&&(s|=Sf.Storage),this.cJ.createBuffer(e,s)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}bindBuffers(t,i,e,s){this.m2=i,this.d2=null!=s?s:null,this.o1.setBuffers(t,i,this.d2)}ca(t){return this.cJ.releaseBuffer(t)}createEffect(t,i,e,s,n,r,h,o,a,l=qt.GLSL){var c;const u=t.vertexElement||t.vertex||t.vertexToken||t.vertexSource||t,f=t.fragmentElement||t.fragment||t.fragmentToken||t.fragmentSource||t,d=this.rs();let p=null!==(c=null!=n?n:i.defines)&&void 0!==c?c:"";d&&(p+="\n"+d);const m=u+"+"+f+"@"+p;if(this.yh[m]){const t=this.yh[m];return h&&t.isReady()&&h(t),t}const v=new ei(t,i,e,s,this,n,r,h,o,a,m,l);return this.yh[m]=v,v}C3(t,i){return this.aJ.compileGLSL(t,i)}w3(t,i,e,s){return this.C3(s+(e?e+"\n":"")+t,i)}x3(t,i,e){return(e=e?"//"+e.split("\n").join("\n//")+"\n":"")+t}T3(t,i,e){return this.lJ&&e===qt.GLSL&&(t=this.lJ.convertSpirV2WGSL(t),i=this.lJ.convertSpirV2WGSL(i)),{vertexStage:{module:this.oJ.createShaderModule({code:t}),entryPoint:"main"},fragmentStage:{module:this.oJ.createShaderModule({code:i}),entryPoint:"main"}}}I3(t,i,e){const s=e===qt.GLSL?this.C3(t,"vertex"):t,n=e===qt.GLSL?this.C3(i,"fragment"):i;return this.T3(s,n,e)}M3(t,i,e,s){this.onBeforeShaderCompilationObservable.notifyObservers(this);const n="#version 450\n",r=s===qt.GLSL?this.w3(t,"vertex",e,n):this.x3(t,"vertex",e),h=s===qt.GLSL?this.w3(i,"fragment",e,n):this.x3(i,"fragment",e),o=this.T3(r,h,s);return this.onAfterShaderCompilationObservable.notifyObservers(this),o}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(t){const i=new hf(t);return i.debug=!1,i.processCode(),i.code}createPipelineContext(t){return new td(t,this)}createMaterialContext(){return new mp}createDrawContext(){return new vp(this.cJ)}on(t,i,e,s,n,r,h,o){const a=t,l=a.shaderProcessingContext.shaderLanguage;this.dbgShowShaderCode&&(console.log(o),console.log(i),console.log(e),console.log("***********************************************")),a.sources={fragment:e,vertex:i,rawVertex:n,rawFragment:r},a.stages=s?this.I3(i,e,l):this.M3(i,e,o,l)}getAttributes(t,i){const e=new Array(i.length),s=t;for(let t=0;t<i.length;t++){const n=i[t],r=s.shaderProcessingContext.availableAttributes[n];void 0!==r&&(e[t]=r)}return e}enableEffect(t){if(!t)return;let i=!0;if(vi.IsWrapper(t)){if(!t.effect||t.effect===this.fa&&t.materialContext===this.W2&&t.drawContext===this.JI&&!this.g2){if(!t.effect&&this.dbgShowEmptyEnableEffectCalls)throw console.error("drawWrapper=",t),"Invalid call to enableEffect: the effect property is empty!";return}if(i=t.effect!==this.fa,this.fa=t.effect,this.W2=t.materialContext,this.JI=t.drawContext,this.a2.numEnableDrawWrapper++,!this.W2)throw console.error("drawWrapper=",t),"Invalid call to enableEffect: the materialContext property is empty!"}else i=t!==this.fa,this.fa=t,this.W2=this.X2,this.JI=this.H2,this.a2.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&F.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${t.uniqueId}, effect.name=${t.name}, effect.name.vertex=${t.name.vertex}, effect.name.fragment=${t.name.fragment}`,10);this.Ah.stencilMaterial=void 0,this.g2=!i&&!this.g2&&this.g2,i&&(this.fa.onBind&&this.fa.onBind(this.fa),this.fa.ls&&this.fa.ls.notifyObservers(this.fa))}pn(t){this.yh[t.ws]&&(delete this.yh[t.ws],this.cn(t.getPipelineContext()))}releaseEffects(){for(const t in this.yh){const i=this.yh[t].getPipelineContext();this.cn(i)}this.yh={}}cn(t){t&&t.dispose()}get needPOTTextures(){return!1}Ir(){return new Wd}Nr(t){const i=this.Rh.indexOf(t);-1!==i&&this.Rh.splice(i,1),this.O2.releaseTexture(t)}Ra(){return 5}updateTextureComparisonFunction(t,i){t.Hn=i}Ta(t,i,e=!0,s=oi.Unknown){var n,r,h;const o={};void 0!==i&&"object"==typeof i?(o.generateMipMaps=i.generateMipMaps,o.type=void 0===i.type?0:i.type,o.samplingMode=void 0===i.samplingMode?3:i.samplingMode,o.format=void 0===i.format?5:i.format,o.samples=null!==(n=i.samples)&&void 0!==n?n:1,o.creationFlags=null!==(r=i.creationFlags)&&void 0!==r?r:0,o.useSRGBBuffer=null!==(h=i.useSRGBBuffer)&&void 0!==h&&h):(o.generateMipMaps=i,o.type=0,o.samplingMode=3,o.format=5,o.samples=1,o.creationFlags=0,o.useSRGBBuffer=!1),(1!==o.type||this.po.textureFloatLinearFiltering)&&(2!==o.type||this.po.textureHalfFloatLinearFiltering)||(o.samplingMode=1),1!==o.type||this.po.textureFloat||(o.type=0,F.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const a=new ai(this,s),l=t.width||t,c=t.height||t,u=t.layers||0;return a.baseWidth=l,a.baseHeight=c,a.width=l,a.height=c,a.depth=u,a.isReady=!0,a.samples=o.samples,a.generateMipMaps=!!o.generateMipMaps,a.samplingMode=o.samplingMode,a.type=o.type,a.format=o.format,a.is2DArray=u>0,a.Vn=0,a.kn=0,a.ur=o.useSRGBBuffer,this.Rh.push(a),e||this.O2.createGPUTextureForInternalTexture(a,l,c,u||1,o.creationFlags),a}createTexture(t,i,e,s,n=3,r=null,h=null,o=null,a=null,l=null,c=null,u,f,d,p){return this._a(t,i,e,s,n,r,h,((t,i,e,s,n,r,h,o)=>{var a;const c=s;if(t.baseWidth=c.width,t.baseHeight=c.height,t.width=c.width,t.height=c.height,t.format=null!=l?l:-1,o(t.width,t.height,c,i,t,(()=>{})),null===(a=t.Er)||void 0===a?void 0:a.underlyingResource)r||h||this.b3(t,this.B2);else{const i=this.O2.createGPUTextureForInternalTexture(t,c.width,c.height,void 0,d);Zd.IsImageBitmap(c)&&(this.O2.updateTexture(c,t,c.width,c.height,t.depth,i.format,0,0,n,!1,0,0),r||h||this.b3(t,this.B2))}e&&e.removePendingData(t),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear()}),(()=>!1),o,a,l,c,u,f,p)}wrapWebGPUTexture(t){const i=new Wd(t),e=new ai(this,oi.Unknown,!0);return e.Er=i,e.isReady=!0,e}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}generateMipMapsForCubemap(t){var i;if(t.generateMipMaps){(null===(i=t.Er)||void 0===i?void 0:i.underlyingResource)||this.O2.createGPUTextureForInternalTexture(t),this.b3(t,t.source===oi.RenderTarget||t.source===oi.MultiRenderTarget?this.V2:void 0)}}updateTextureSamplingMode(t,i,e=!1){e&&(i.generateMipMaps=!0,this.b3(i)),i.samplingMode=t}updateTextureWrappingMode(t,i,e=null,s=null){null!==i&&(t.Vn=i),null!==e&&(t.kn=e),(t.is2DArray||t.is3D)&&null!==s&&(t.Gn=s)}updateTextureDimensions(t,i,e,s=1){if(!t.Er)return;if(t.width===i&&t.height===e&&t.depth===s)return;const n=t.Er.textureAdditionalUsages;t.Er.release(),this.O2.createGPUTextureForInternalTexture(t,i,e,s,n)}_3(t,i,e){if(e=null!=e?e:t,this.fa){const s=this.fa.Ms.shaderProcessingContext.availableTextures[e];if(this.W2.setTexture(t,i),s&&s.autoBindSampler){const t=e+Jf.AutoSamplerSuffix;this.W2.setSampler(t,i)}}}setTexture(t,i,e,s){this.Za(t,e,!1,!1,s,s)}setTextureArray(t,i,e,s){for(let t=0;t<e.length;t++)this.Za(-1,e[t],!0,!1,s+t.toString(),s)}Za(t,i,e=!1,s=!1,n="",r){if(r=null!=r?r:n,this.fa){if(!i)return this.W2.setTexture(n,null),!1;if(i.video)i.update();else if(4===i.delayLoadState)return i.delayLoad(),!1;let t=null;if(t=s?i.depthStencilTexture:i.isReady()?i.getInternalTexture():i.isCube?this.emptyCubeTexture:i.is3D?this.emptyTexture3D:i.is2DArray?this.emptyTexture2DArray:this.emptyTexture,t&&!t.isMultiview){if(t.isCube&&t.er!==i.coordinatesMode){t.er=i.coordinatesMode;const e=3!==i.coordinatesMode&&5!==i.coordinatesMode?1:0;i.wrapU=e,i.wrapV=e}t.Vn=i.wrapU,t.kn=i.wrapV,t.is3D&&(t.Gn=i.wrapR),this.tl(0,t,i.anisotropicFilteringLevel)}this._3(n,t,r)}else this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - _setTexture called with a null _currentEffect! texture=",i));return!0}tl(t,i,e){i.zn!==e&&(i.zn=Math.min(e,this.po.maxAnisotropy))}fn(t,i,e){void 0!==t&&this._3(e,i)}generateMipmaps(t){this.b3(t,this.V2)}b3(t,i){const e=t.Er;if(!e)return;i=null!=i?i:this.zo&&!this.c2?this.V2:this.c2?this.B2:this.U2;const s=t.Er.format,n=Zd.ComputeNumMipmapLevels(t.width,t.height);this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - generate mipmaps called - width=",t.width,"height=",t.height,"isCube=",t.isCube)),t.isCube?this.O2.generateCubeMipmaps(e,s,n,i):this.O2.generateMipmaps(e,s,n,0,i)}updateTextureData(t,i,e,s,n,r,h=0,o=0,a=!1){var l;let c=t.Er;(null===(l=t.Er)||void 0===l?void 0:l.underlyingResource)||(c=this.O2.createGPUTextureForInternalTexture(t));const u=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this.O2.updateTexture(u,t,n,r,t.depth,c.format,h,o,t.invertY,!1,e,s),a&&this.b3(t,this.V2)}ka(t,i,e,s,n,r=0,h=0){var o;let a=t.Er;(null===(o=t.Er)||void 0===o?void 0:o.underlyingResource)||(t.format=i,a=this.O2.createGPUTextureForInternalTexture(t,e,s));const l=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);this.O2.updateTexture(l,t,e,s,t.depth,a.format,r,h,!1,!1,0,0)}Ga(t,i,e=0,s=0,n,r=!1){var h;const o=Math.round(Math.log(t.width)*Math.LOG2E),a=Math.round(Math.log(t.height)*Math.LOG2E),l=r?t.width:Math.pow(2,Math.max(o-s,0)),c=r?t.height:Math.pow(2,Math.max(a-s,0));let u=t.Er;(null===(h=t.Er)||void 0===h?void 0:h.underlyingResource)||(u=this.O2.createGPUTextureForInternalTexture(t,l,c));const f=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this.O2.updateTexture(f,t,l,c,t.depth,u.format,e,s,t.invertY,!1,0,0)}za(t,i,e=0,s=0){this.Ga(t,i,e,s)}Ex(t,i,e=0,s=0){var n;let r=t.Er;if((null===(n=t.Er)||void 0===n?void 0:n.underlyingResource)||(r=this.O2.createGPUTextureForInternalTexture(t)),i instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";const h=i,o=Math.ceil(t.width/(1<<s)),a=Math.ceil(t.height/(1<<s));this.O2.updateTexture(h,t,o,a,t.depth,r.format,e,s,t.invertY,!1,0,0)}readPixels(t,i,e,s,n=!0,r=!0){const h=(this.V1.renderPass?this.V1:this.U1).colorAttachmentGPUTextures[0];if(!h)return Promise.resolve(new Uint8Array(0));const o=h.underlyingResource,a=h.format;return o?(r&&this.flushFramebuffer(),this.O2.readPixels(o,t,i,e,s,a)):Promise.resolve(new Uint8Array(0))}beginFrame(){super.beginFrame()}endFrame(){if(this.M2.endFrame(this.U1.renderPass),this.y3(),this.F2.endFrame(this.U2),this.flushFramebuffer(!1),this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - counters")),this.O2.destroyDeferredTextures(),this.cJ.destroyDeferredBuffers(),this.hs.Fo){if(this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)){const t=[];for(const i in ne.Yu)t.push(i+":"+ne.Yu[i]);console.log("frame #"+this.Tl+" - updated ubos -",t.join(", "))}ne.Yu={}}this.countersLastFrame.numEnableEffects=this.a2.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this.a2.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this.a2.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this.a2.numBundleReuseNonCompatMode,this.a2.numEnableEffects=0,this.a2.numEnableDrawWrapper=0,this.a2.numBundleCreationNonCompatMode=0,this.a2.numBundleReuseNonCompatMode=0,this.o1.endFrame(),this.b2.endFrame(),this.u2.length=0,super.endFrame(),this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),this.Tl<this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this.Tl+" - end","background: #ffff00"),this.Tl<this.dbgVerboseLogsNumFrames&&(this.Tl++,this.Tl!==this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this.Tl+" - begin","background: #ffff00")))}flushFramebuffer(t=!0){const i=!this.c2;let e=0;this.c2&&this.zo&&(e|=1,this.g3()),this.U1.renderPass&&(e|=2,this.y3()),this.l2[0]=this.B2.finish(),this.l2[1]=this.V2.finish(),this.l2[2]=this.U2.finish(),this.oJ.queue.submit(this.l2),this.B2=this.oJ.createCommandEncoder(this.i2),this.U2=this.oJ.createCommandEncoder(this.e2),this.V2=this.oJ.createCommandEncoder(this.s2),this.F2.startFrame(this.B2),this.O2.setCommandEncoder(this.B2),this.q1.reset(),this.Q1.reset(),t&&(2&e&&this.S3(!1),1&e&&this.m3(this.zo,!1,null,!1,!1),i&&this.zo&&(this.c2=null))}Ko(){return null===this.zo}m3(t,i,e,s,n){var r,h,o;const a=t,l=a.Yo,c=null==l?void 0:l.Er,u=null==c?void 0:c.underlyingResource,f=null==c?void 0:c.msaaTexture,d=null==u?void 0:u.createView(this.V1.depthAttachmentViewDescriptor),p=null==f?void 0:f.createView(this.V1.depthAttachmentViewDescriptor),m=!!c&&Zd.HasStencilAspect(c.format),v=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const g=i&&e,S=i&&s,E=i&&n;if(a.OD&&a.isMulti){this.N3&&0!==this.N3.length||(this.N3=a.P3);for(let t=0;t<this.N3.length;++t){const i=this.N3[t],s=a.textures[t],n=null==s?void 0:s.Er,r=null==n?void 0:n.underlyingResource;if(n&&r){const t={...this.V1.colorAttachmentViewDescriptor,format:n.format},s=n.msaaTexture,h=r.createView(t),o=null==s?void 0:s.createView(t);v.push({view:o||h,resolveTarget:s?h:void 0,clearValue:0!==i&&g?e:void 0,loadOp:0!==i&&g?Yf.Clear:Yf.Load,storeOp:jf.Store})}}this.o1.setMRT(a.textures,this.N3.length),this.o1.setMRTAttachments(this.N3)}else{const t=a.texture;if(t){const i=t.Er,s=i.underlyingResource,n=i.msaaTexture,r=s.createView(this.V1.colorAttachmentViewDescriptor),h=null==n?void 0:n.createView(this.V1.colorAttachmentViewDescriptor);v.push({view:h||r,resolveTarget:n?r:void 0,clearValue:g?e:void 0,loadOp:g?Yf.Clear:Yf.Load,storeOp:jf.Store})}else v.push(null)}if(null===(r=this.NO)||void 0===r||r.call(this,"render target pass",1),this.V1.renderPassDescriptor={colorAttachments:v,depthStencilAttachment:l&&u?{view:p||d,depthClearValue:S?this.useReverseDepthBuffer?this.l1:this.c1:void 0,depthLoadOp:S?Yf.Clear:Yf.Load,depthStoreOp:jf.Store,stencilClearValue:a.jo&&E?this.n2:void 0,stencilLoadOp:m?a.jo&&E?Yf.Clear:Yf.Load:void 0,stencilStoreOp:m?jf.Store:void 0}:void 0,occlusionQuerySet:(null===(h=this.yT)||void 0===h?void 0:h.hasQueries)?this.yT.querySet:void 0},this.V1.renderPass=this.V2.beginRenderPass(this.V1.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)){const t=a.texture;console.log("frame #"+this.Tl+" - render target begin pass - internalTexture.uniqueId=",t.uniqueId,"width=",t.width,"height=",t.height,this.V1.renderPassDescriptor)}this.c2=this.V1.renderPass,null===(o=this.Uq)||void 0===o||o.call(this),this.i3(1),this.n3(1),this.a3(1),this.u3(1),c&&Zd.HasStencilAspect(c.format)||(this.Ah.enabled=!1)}g3(){var t,i,e,s;if(this.c2){const n=null===(t=this.zo.texture)||void 0===t?void 0:t.Er;!n||this.M2.endRenderTargetPass(this.c2,n)||this.compatibilityMode||(this.Q1.run(this.c2),this.Q1.reset()),this.c2.end(),this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - render target end pass - internalTexture.uniqueId=",null===(e=null===(i=this.zo)||void 0===i?void 0:i.texture)||void 0===e?void 0:e.uniqueId)),null===(s=this.PO)||void 0===s||s.call(this,1),this.i3(1),this.n3(1),this.a3(1),this.u3(1),this.c2=null,this.V1.reset()}}E3(){return this.zo&&!this.c2?this.m3(this.zo,!1,null,!1,!1):this.c2||this.S3(!1),this.c2}B1(){return null===this.c2?-1:this.c2===this.U1.renderPass?0:1}S3(t,i,e,s){var n,r,h;this.U1.renderPass&&this.flushFramebuffer(!1),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const o=t&&i,a=t&&e,l=t&&s;this.U1.renderPassDescriptor.colorAttachments[0].clearValue=o?i:void 0,this.U1.renderPassDescriptor.colorAttachments[0].loadOp=o?Yf.Clear:Yf.Load,this.U1.renderPassDescriptor.depthStencilAttachment.depthClearValue=a?this.useReverseDepthBuffer?this.l1:this.c1:void 0,this.U1.renderPassDescriptor.depthStencilAttachment.depthLoadOp=a?Yf.Clear:Yf.Load,this.U1.renderPassDescriptor.depthStencilAttachment.stencilClearValue=l?this.n2:void 0,this.U1.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?l?Yf.Clear:Yf.Load:void 0,this.U1.renderPassDescriptor.occlusionQuerySet=(null===(n=this.yT)||void 0===n?void 0:n.hasQueries)?this.yT.querySet:void 0;const c=this.zr.getCurrentTexture();this.U1.colorAttachmentGPUTextures[0].set(c),this.wb.antialiasing?this.U1.renderPassDescriptor.colorAttachments[0].resolveTarget=c.createView():this.U1.renderPassDescriptor.colorAttachments[0].view=c.createView(),this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - main begin pass - texture width="+this.Q2.width," height="+this.Q2.height,this.U1.renderPassDescriptor)),null===(r=this.NO)||void 0===r||r.call(this,"main pass",0),this.c2=this.U2.beginRenderPass(this.U1.renderPassDescriptor),this.U1.renderPass=this.c2,null===(h=this.Uq)||void 0===h||h.call(this),this.i3(0),this.n3(0),this.a3(0),this.u3(0),this.fo||(this.Ah.enabled=!1)}y3(){var t;null!==this.U1.renderPass&&(this.M2.endMainRenderPass(),this.compatibilityMode||this.M2.play||(this.q1.run(this.U1.renderPass),this.q1.reset()),this.U1.renderPass.end(),this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - main end pass")),null===(t=this.PO)||void 0===t||t.call(this,0),this.i3(0),this.n3(0),this.a3(0),this.u3(0),this.U1.renderPass===this.c2&&(this.c2=null),this.U1.reset(!1))}bindFramebuffer(t,i=0,e,s,n,r=0,h=0){var o,a;const l=null===(o=t.texture)||void 0===o?void 0:o.Er;this.zo&&this.unBindFramebuffer(this.zo),this.zo=t,l&&(l.t2=t.isCube?6*h+i:h),this.V1.colorAttachmentGPUTextures[0]=l,this.V1.depthTextureFormat=this.zo.Yo?Zd.GetWebGPUTextureFormat(-1,this.zo.Yo.format):void 0,this.J2(this.V1),this.D3(this.V1),this.V1.colorAttachmentViewDescriptor={format:this.a0,dimension:wf.E2d,mipLevelCount:1,baseArrayLayer:t.isCube?6*h+i:h,baseMipLevel:r,arrayLayerCount:1,aspect:xf.All},this.V1.depthAttachmentViewDescriptor={format:this.a1,dimension:wf.E2d,mipLevelCount:1,baseArrayLayer:t.isCube?6*h+i:h,baseMipLevel:0,arrayLayerCount:1,aspect:xf.All},this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - bindFramebuffer called - internalTexture.uniqueId=",null===(a=t.texture)||void 0===a?void 0:a.uniqueId,"face=",i,"lodLevel=",r,"layer=",h,this.V1.colorAttachmentViewDescriptor,this.V1.depthAttachmentViewDescriptor)),this.c2=null,this.snapshotRendering&&1===this.snapshotRenderingMode&&this.E3(),this.Eo&&!n?this.setViewport(this.Eo,e,s):(e||(e=t.width,r&&(e/=Math.pow(2,r))),s||(s=t.height,r&&(s/=Math.pow(2,r))),this.Ho(0,0,e,s)),this.wipeCaches()}unBindFramebuffer(t,i=!1,e){var s,n;const r=this.zo;this.zo=null,e&&e(),this.zo=r,this.c2&&this.c2!==this.U1.renderPass&&this.g3(),!(null===(s=t.texture)||void 0===s?void 0:s.generateMipMaps)||i||t.isCube||this.b3(t.texture),this.zo=null,this.f2.notifyObservers(this),this.dbgVerboseLogsForFirstFrames&&(void 0===this.Tl&&(this.Tl=0),(!this.Tl||this.Tl<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this.Tl+" - unBindFramebuffer called - internalTexture.uniqueId=",null===(n=t.texture)||void 0===n?void 0:n.uniqueId)),this.N3=[],this.o1.setMRT([]),this.o1.setMRTAttachments(this.N3),this.c2=this.U1.renderPass,this.J2(this.U1),this.D3(this.U1)}restoreDefaultFramebuffer(){this.zo?this.unBindFramebuffer(this.zo):(this.c2=this.U1.renderPass,this.J2(this.U1),this.D3(this.U1)),this.c2&&this.Eo&&this.setViewport(this.Eo),this.wipeCaches()}D3(t){var i,e;const s=null!==(e=null===(i=t.colorAttachmentGPUTextures[0])||void 0===i?void 0:i.format)&&void 0!==e?e:null;this.o1.setColorFormat(s),this.a0!==s&&(this.a0=s)}J2(t){this.o1.setDepthStencilFormat(t.depthTextureFormat),this.a1!==t.depthTextureFormat&&(this.a1=t.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}setState(t,i=0,e,s=!1,n,r,h=0){var o,a;(this.Eh.cull!==t||e)&&(this.Eh.cull=t);const l=null===(a=null!==(o=this.cullBackFaces)&&void 0!==o?o:n)||void 0===a||a?1:2;(this.Eh.cullFace!==l||e)&&(this.Eh.cullFace=l),this.setZOffset(i),this.setZOffsetUnits(h);const c=s?this.zo?1:2:this.zo?2:1;(this.Eh.frontFace!==c||e)&&(this.Eh.frontFace=c),this.Ah.stencilMaterial=r}O3(t,i){var e;const s=this.e3(t),n=this.r3(t),r=!!this.Ah.enabled&&this.l3(t),h=!!this.wh.alphaBlend&&this.f3(t);i?(s&&i.addItem(new Tp(this.qh.x,this.qh.y,this.qh.z,this.qh.w)),n&&i.addItem(new Rp(this.A2.x,this.A2.y,this.A2.z,this.A2.w)),r&&i.addItem(new Ip(null!==(e=this.Ah.funcRef)&&void 0!==e?e:0)),h&&i.addItem(new Mp(this.wh.Pn.slice()))):(s&&this.s3(t),n&&this.h3(t),r&&this.c3(t),h&&this.d3(t))}jI(t,i,e,s,n){var r;const h=this.E3(),o=0===this.B1()?this.q1:this.Q1;this.applyStates();const a=this.fa.Ms;if(this.bindUniformBufferBase(this.zo?this.u1:this.f1,0,Jf.InternalsUBOName),a.uniformBuffer&&(a.uniformBuffer.update(),this.bindUniformBufferBase(a.uniformBuffer.getBuffer(),0,Jf.LeftOvertUBOName)),this.M2.play)return void this.da();!this.compatibilityMode&&(this.JI.isDirty(this.W2.updateId)||this.W2.isDirty||this.W2.forceBindGroupCreation)&&(this.JI.fastBundle=void 0);let l=h;if(!this.compatibilityMode&&this.JI.fastBundle||this.M2.record){if(this.O3(h,o),!this.M2.record)return this.a2.numBundleReuseNonCompatMode++,this.JI.indirectDrawBuffer&&this.JI.setIndirectData(s,n||1,e),o.addBundle(this.JI.fastBundle),void this.da();l=o.getBundleEncoder(this.o1.colorFormats,this.a1,this.currentSampleCount),o.numDrawCalls++}let c=0;if(!this.po.textureFloatLinearFiltering&&this.W2.hasFloatTextures){let t=1;for(let i=0;i<a.shaderProcessingContext.textureNames.length;++i){const e=a.shaderProcessingContext.textureNames[i],s=null===(r=this.W2.textures[e])||void 0===r?void 0:r.texture;1===(null==s?void 0:s.type)&&(c|=t),t<<=1}}const u=this.o1.getRenderPipeline(i,this.fa,this.currentSampleCount,c),f=this.b2.getBindGroups(a,this.JI,this.W2);this.M2.record||(this.O3(h,this.compatibilityMode?null:o),this.compatibilityMode||(this.a2.numBundleCreationNonCompatMode++,l=this.oJ.createRenderBundleEncoder({colorFormats:this.o1.colorFormats,depthStencilFormat:this.a1,sampleCount:this.currentSampleCount}))),l.setPipeline(u),this.m2&&l.setIndexBuffer(this.m2.underlyingResource,this.m2.is32Bits?zf.Uint32:zf.Uint16,0);const d=this.o1.vertexBuffers;for(let t=0;t<d.length;t++){const i=d[t],e=i.getBuffer();e&&l.setVertexBuffer(t,e.underlyingResource,i.B0?0:i.byteOffset)}for(let t=0;t<f.length;t++)l.setBindGroup(t,f[t]);const p=!this.compatibilityMode&&!this.M2.record;p&&this.JI.indirectDrawBuffer?(this.JI.setIndirectData(s,n||1,e),0===t?l.drawIndexedIndirect(this.JI.indirectDrawBuffer,0):l.drawIndirect(this.JI.indirectDrawBuffer,0)):0===t?l.drawIndexed(s,n||1,e,0,0):l.draw(s,n||1,e,0),p&&(this.JI.fastBundle=l.finish(),o.addBundle(this.JI.fastBundle)),this.da()}drawElementsType(t,i,e,s=1){this.jI(0,t,i,e,s)}drawArraysType(t,i,e,s=1){this.m2=null,this.jI(1,t,i,e,s)}dispose(){var t,i;null===(t=this.Z2)||void 0===t||t.destroy(),null===(i=this.t3)||void 0===i||i.destroy(),super.dispose()}getRenderWidth(t=!1){return!t&&this.zo?this.zo.width:this.GW.width}getRenderHeight(t=!1){return!t&&this.zo?this.zo.height:this.GW.height}getRenderingCanvas(){return this.GW}getError(){return 0}bindSamplers(){}qo(){return!1}areAllEffectsReady(){return!0}an(t,i){i()}Dr(){return!0}Oa(){return 1}La(){}Xo(){throw"_bindUnboundFramebuffer is not implementedin WebGPU! You probably want to use restoreDefaultFramebuffer or unBindFramebuffer instead"}wa(){throw"_getSamplingParameters is not available in WebGPU"}getUniforms(){return[]}setIntArray(){return!1}setIntArray2(){return!1}setIntArray3(){return!1}setIntArray4(){return!1}setArray(){return!1}setArray2(){return!1}setArray3(){return!1}setArray4(){return!1}setMatrices(){return!1}setMatrix3x3(){return!1}setMatrix2x2(){return!1}setFloat(){return!1}setFloat2(){return!1}setFloat3(){return!1}setFloat4(){return!1}}Up.K2={jsPath:"https://preview.babylonjs.com/glslang/glslang.js",wasmPath:"https://preview.babylonjs.com/glslang/glslang.wasm"},Up.UseTWGSL=!0,Up.prototype.setAlphaMode=function(t,i=!1){if(this.xh!==t||!(0===t&&!this.wh.alphaBlend||0!==t&&this.wh.alphaBlend)){switch(t){case 0:this.wh.alphaBlend=!1;break;case 7:this.wh.setAlphaBlendFunctionParameters(1,771,1,1),this.wh.alphaBlend=!0;break;case 8:case 14:this.wh.setAlphaBlendFunctionParameters(1,771,1,771),this.wh.alphaBlend=!0;break;case 2:this.wh.setAlphaBlendFunctionParameters(770,771,1,1),this.wh.alphaBlend=!0;break;case 6:this.wh.setAlphaBlendFunctionParameters(1,1,0,1),this.wh.alphaBlend=!0;break;case 1:this.wh.setAlphaBlendFunctionParameters(770,1,0,1),this.wh.alphaBlend=!0;break;case 3:this.wh.setAlphaBlendFunctionParameters(0,769,1,1),this.wh.alphaBlend=!0;break;case 4:this.wh.setAlphaBlendFunctionParameters(774,0,1,1),this.wh.alphaBlend=!0;break;case 5:this.wh.setAlphaBlendFunctionParameters(770,769,1,1),this.wh.alphaBlend=!0;break;case 9:this.wh.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this.wh.alphaBlend=!0;break;case 10:this.wh.setAlphaBlendFunctionParameters(1,769,1,771),this.wh.alphaBlend=!0;break;case 11:this.wh.setAlphaBlendFunctionParameters(1,1,1,1),this.wh.alphaBlend=!0;break;case 12:this.wh.setAlphaBlendFunctionParameters(772,1,0,0),this.wh.alphaBlend=!0;break;case 13:this.wh.setAlphaBlendFunctionParameters(775,769,773,771),this.wh.alphaBlend=!0;break;case 15:this.wh.setAlphaBlendFunctionParameters(1,1,1,0),this.wh.alphaBlend=!0;break;case 16:this.wh.setAlphaBlendFunctionParameters(775,769,0,1),this.wh.alphaBlend=!0;break;case 17:this.wh.setAlphaBlendFunctionParameters(770,771,1,771),this.wh.alphaBlend=!0}i||(this.setDepthWrite(t===Rs.ALPHA_DISABLE),this.o1.setDepthWriteEnabled(t===Rs.ALPHA_DISABLE)),this.xh=t,this.o1.setAlphaBlendEnabled(this.wh.alphaBlend),this.o1.setAlphaBlendFactors(this.wh.yn,this.wh.Nn)}},Up.prototype.setAlphaEquation=function(t){Rs.prototype.setAlphaEquation.call(this,t),this.o1.setAlphaBlendFactors(this.wh.yn,this.wh.Nn)};class Vp{constructor(t,i){this.oJ=t,this.J0=i,this.uniqueId=Vp.Rr++,this.F3=[],this.clear()}getBindGroups(t,i,e){if(!e)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(0===this.s1.length){const s=this.F3.length>0;for(const i in t){const n=t[i],r=e[i],h=r.group,o=r.binding,a=n.type,l=n.object;let c=n.indexInGroupEntries,u=this.F3[h];switch(u||(u=this.F3[h]=[]),a){case Vc.Sampler:{const t=l;void 0!==c&&s?u[c].resource=this.J0.getSampler(t):(n.indexInGroupEntries=u.length,u.push({binding:o,resource:this.J0.getSampler(t)}));break}case Vc.Texture:case Vc.TextureWithoutSampler:{const t=l,i=t.Lb.Er;void 0!==c&&s?(a===Vc.Texture&&(u[c++].resource=this.J0.getSampler(t.Lb)),u[c].resource=i.view):(n.indexInGroupEntries=u.length,a===Vc.Texture&&u.push({binding:o-1,resource:this.J0.getSampler(t.Lb)}),u.push({binding:o,resource:i.view}));break}case Vc.StorageTexture:{const t=l,i=t.Lb.Er;0==(i.textureAdditionalUsages&Cf.StorageBinding)&&F.Error(`computeDispatch: The texture (name=${t.name}, uniqueId=${t.uniqueId}) is not a storage texture!`,50),void 0!==c&&s?u[c].resource=i.viewForWriting:(n.indexInGroupEntries=u.length,u.push({binding:o,resource:i.viewForWriting}));break}case Vc.UniformBuffer:case Vc.StorageBuffer:{const t=(Vc.UniformBuffer,l).getBuffer(),i=t.underlyingResource;void 0!==c&&s?(u[c].resource.buffer=i,u[c].resource.size=t.capacity):(n.indexInGroupEntries=u.length,u.push({binding:o,resource:{buffer:i,offset:0,size:t.capacity}}));break}}}for(let t=0;t<this.F3.length;++t){const e=this.F3[t];e?this.s1[t]=this.oJ.createBindGroup({layout:i.getBindGroupLayout(t),entries:e}):this.s1[t]=void 0}this.s1.length=this.F3.length}return this.s1}clear(){this.s1=[]}}Vp.Rr=0;class kp{constructor(t){this.hn="unnamed",this.engine=t}get isAsync(){return!1}get isReady(){return!!this.stage}Jj(){var t;return null===(t=this.sources)||void 0===t?void 0:t.compute}dispose(){}}Up.prototype.createComputeContext=function(){return new Vp(this.oJ,this.J0)},Up.prototype.createComputeEffect=function(t,i){const e=(t.computeElement||t.compute||t.computeToken||t.computeSource||t)+"@"+i.defines;if(this.o2[e]){const t=this.o2[e];return i.onCompiled&&t.isReady()&&i.onCompiled(t),t}const s=new Uc(t,i,this,e);return this.o2[e]=s,s},Up.prototype.createComputePipelineContext=function(){return new kp(this)},Up.prototype.areAllComputeEffectsReady=function(){for(const t in this.o2){if(!this.o2[t].isReady())return!1}return!0},Up.prototype.computeDispatch=function(t,i,e,s,n,r,h){if(this.zo)return void this.f2.addOnce((()=>{this.computeDispatch(t,i,e,s,n,r,h)}));const o=t.Ms,a=i;o.computePipeline||(o.computePipeline=this.oJ.createComputePipeline({layout:Lf.Auto,compute:o.stage}));const l=this.V2.beginComputePass();l.setPipeline(o.computePipeline);const c=a.getBindGroups(e,o.computePipeline,h);for(let t=0;t<c.length;++t){const i=c[t];i&&l.setBindGroup(t,i)}l.dispatchWorkgroups(s,n,r),l.end()},Up.prototype.releaseComputeEffects=function(){for(const t in this.o2){const i=this.o2[t].getPipelineContext();this.eK(i)}this.o2={}},Up.prototype.tK=function(t,i,e,s,n){const r=t;this.dbgShowShaderCode&&(console.log(s),console.log(i)),r.sources={compute:i,rawCompute:e},r.stage=this.B3(i,s,n)},Up.prototype.sK=function(t){this.o2[t.ws]&&(delete this.o2[t.ws],this.eK(t.getPipelineContext()))},Up.prototype.Io=function(){for(const t in this.o2){const i=this.o2[t];i.Ms=null,i.cs=!1,i.Ks()}},Up.prototype.eK=function(t){t&&t.dispose()},Up.prototype.B3=function(t,i,e){return i=i?"//"+i.split("\n").join("\n//")+"\n":"",{module:this.oJ.createShaderModule({code:i+t}),entryPoint:e}},Up.prototype.YD=function(t,i){const e=new ai(this,oi.DepthStencil);e.isCube=!0;const s={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,...i};return e.format=s.generateStencil?13:14,this.Va(e,t,s.generateStencil,s.bilinearFiltering,s.comparisonFunction,s.samples),this.O2.createGPUTextureForInternalTexture(e),this.Rh.push(e),e},Up.prototype.createCubeTexture=function(t,i,e,s,n=null,r=null,h,o=null,a=!1,l=0,c=0,u=null,f=!1){return this.createCubeTextureBase(t,i,e,!!s,n,r,h,o,a,l,c,u,null,((t,i)=>{const e=i,r=e[0].width,o=r;this.oQ(t,!s),t.format=null!=h?h:-1;const a=this.O2.createGPUTextureForInternalTexture(t,r,o);this.O2.updateCubeTextures(e,a.underlyingResource,r,o,a.format,!1,!1,0,0),s||this.b3(t,this.B2),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()}),!!f)},Up.prototype.oQ=function(t,i,e){t.samplingMode=i?3:2,t.Vn=0,t.kn=0,e&&(t.Ar=e)},Up.prototype.NO=function(t,i){if(this.wb.enableGPUDebugMarkers)if(0===i||1===i){(0===i?this.U2:this.V2).pushDebugGroup(t)}else this.c2?this.c2.pushDebugGroup(t):this.u2.push(["push",t])},Up.prototype.PO=function(t){if(this.wb.enableGPUDebugMarkers)if(0===t||1===t){(0===t?this.U2:this.V2).popDebugGroup()}else this.c2?this.c2.popDebugGroup():this.u2.push(["pop",null])},Up.prototype.gf=function(t,i){if(this.wb.enableGPUDebugMarkers)if(0===i||1===i){(0===i?this.U2:this.V2).insertDebugMarker(t)}else this.c2?this.c2.insertDebugMarker(t):this.u2.push(["insert",t])},Up.prototype.Uq=function(){for(let t=0;t<this.u2.length;++t){const[i,e]=this.u2[t];switch(i){case"push":this.NO(e);break;case"pop":this.PO();break;case"insert":this.gf(e)}}this.u2.length=0},Up.prototype.updateDynamicIndexBuffer=function(t,i,e=0){const s=t;let n;n=t.is32Bits?i instanceof Uint32Array?i:new Uint32Array(i):i instanceof Uint16Array?i:new Uint16Array(i),this.cJ.setSubData(s,e,n)},Up.prototype.updateDynamicVertexBuffer=function(t,i,e,s){const n=t;let r;void 0===e&&(e=0),void 0===s?(r=i instanceof Array?new Float32Array(i):i instanceof ArrayBuffer?new Uint8Array(i):i,s=r.byteLength):r=i instanceof Array?new Float32Array(i):i instanceof ArrayBuffer?new Uint8Array(i):i,this.cJ.setSubData(n,e,r,0,s)},Up.prototype.updateDynamicTexture=function(t,i,e,s=!1,n,r,h){var o;if(!t)return;const a=i.width,l=i.height;let c=t.Er;(null===(o=t.Er)||void 0===o?void 0:o.underlyingResource)||(c=this.O2.createGPUTextureForInternalTexture(t,a,l)),this.O2.updateTexture(i,t,a,l,t.depth,c.format,0,0,e,s,0,0,h),t.generateMipMaps&&this.b3(t,this.B2),t.isReady=!0};class Gp extends pp{constructor(t){super(t)}}function zp(t,i,e,s){let n,r=1;1===s?n=new Float32Array(i*e*4):2===s?(n=new Uint16Array(i*e*4),r=15360):n=7===s?new Uint32Array(i*e*4):new Uint8Array(i*e*4);for(let s=0;s<i;s++)for(let h=0;h<e;h++){const e=3*(h*i+s),o=4*(h*i+s);n[o+0]=t[e+0],n[o+1]=t[e+1],n[o+2]=t[e+2],n[o+3]=r}return n}ei.prototype.setExternalTexture=function(t,i){this.Ls.setExternalTexture(t,i)},Up.prototype.createExternalTexture=function(t){return new Gp(t)},Up.prototype.setExternalTexture=function(t,i){i?this._3(t,i):this.W2.setTexture(t,null)},Up.prototype.unBindMultiColorAttachmentFramebuffer=function(t,i=!1,e){e&&e();const s=t.OD.length;this.c2&&this.c2!==this.U1.renderPass&&this.g3();for(let e=0;e<s;e++){const s=t.textures[e];!s.generateMipMaps||i||s.isCube||this.b3(s)}this.zo=null,this.N3=[],this.o1.setMRT([]),this.o1.setMRTAttachments(this.N3),this.c2=this.U1.renderPass,this.J2(this.U1),this.D3(this.U1)},Up.prototype.createMultipleRenderTarget=function(t,i,e){var s;let n=!1,r=!0,h=!1,o=!1,a=15,l=1;let c=new Array,u=new Array,f=new Array;const d=this.$D(!0,!1,t);void 0!==i&&(n=void 0!==i.generateMipMaps&&i.generateMipMaps,r=void 0===i.generateDepthBuffer||i.generateDepthBuffer,h=void 0!==i.generateStencilBuffer&&i.generateStencilBuffer,o=void 0!==i.generateDepthTexture&&i.generateDepthTexture,l=i.textureCount||1,a=null!==(s=i.depthTextureFormat)&&void 0!==s?s:15,i.types&&(c=i.types),i.samplingModes&&(u=i.samplingModes),i.useSRGBBuffers&&(f=i.useSRGBBuffers));const p=t.width||t,m=t.height||t;let v=null;(r||h||o)&&(v=d.createDepthStencilTexture(0,!1,h,1,a));const g=[],S=[],E=[];d.BD=r,d.FD=h,d.OD=S,d.P3=E;for(let t=0;t<l;t++){let i=u[t]||3,s=c[t]||0;const r=f[t]||false;(1!==s||this.po.textureFloatLinearFiltering)&&(2!==s||this.po.textureHalfFloatLinearFiltering)||(i=1),1!==s||this.po.textureFloat||(s=0,F.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));const h=new ai(this,oi.MultiRenderTarget);g.push(h),S.push(t+1),E.push(e?t+1:0===t?1:0),h.baseWidth=p,h.baseHeight=m,h.width=p,h.height=m,h.isReady=!0,h.samples=1,h.generateMipMaps=n,h.samplingMode=i,h.type=s,h.Vn=0,h.kn=0,h.ur=r,this.Rh.push(h),this.O2.createGPUTextureForInternalTexture(h)}return v&&(v.incrementReferences(),g.push(v),this.Rh.push(v)),d.setTextures(g),d},Up.prototype.updateMultipleRenderTargetTextureSampleCount=function(t,i){if(!t||!t.textures||t.textures[0].samples===i)return i;const e=t.textures.length;if(0===e)return 1;i=Math.min(i,this.getCaps().maxMSAASamples);for(let s=0;s<e;++s){const e=t.textures[s];this.O2.createMSAATexture(e,i),e.samples=i}return t.Yo&&t.Yo!==t.textures[t.textures.length-1]&&(this.O2.createMSAATexture(t.Yo,i),t.Yo.samples=i),i},Up.prototype.bindAttachments=function(t){0!==t.length&&this.zo&&(this.N3=t,this.c2&&this.o1.setMRTAttachments(t))},Up.prototype.buildTextureLayout=function(t){const i=[];for(let e=0;e<t.length;e++)t[e]?i.push(e+1):i.push(0);return i},Up.prototype.restoreSingleAttachment=function(){},Up.prototype.restoreSingleAttachmentForRenderTarget=function(){},Up.prototype.getGPUFrameTimeCounter=function(){return this.F2.gpuFrameTimeCounter},Up.prototype.captureGPUFrameTime=function(t){this.F2.enable=t&&!!this.po.timerQuery},Up.prototype.createQuery=function(){return this.yT.createQuery()},Up.prototype.deleteQuery=function(t){return this.yT.deleteQuery(t),this},Up.prototype.isQueryResultAvailable=function(t){return this.yT.isQueryResultAvailable(t)},Up.prototype.getQueryResult=function(t){return this.yT.getQueryResult(t)},Up.prototype.beginOcclusionQuery=function(t,i){var e;if(!this.compatibilityMode){return(0===this.B1()?this.q1:this.Q1).addItem(new bp(i)),!0}return!!this.yT.canBeginQuery&&(null===(e=this.c2)||void 0===e||e.beginOcclusionQuery(i),!0)},Up.prototype.endOcclusionQuery=function(){var t;if(this.compatibilityMode)null===(t=this.c2)||void 0===t||t.endOcclusionQuery();else{(0===this.B1()?this.q1:this.Q1).addItem(new _p)}return this},Up.prototype.createRawTexture=function(t,i,e,s,n,r,h,o=null,a=0,l=0,c=!1){const u=new ai(this,oi.Raw);return u.baseWidth=i,u.baseHeight=e,u.width=i,u.height=e,u.format=s,u.generateMipMaps=n,u.samplingMode=h,u.invertY=r,u.nr=o,u.type=a,u.ur=c,this.mh||(u.jn=t),this.O2.createGPUTextureForInternalTexture(u,i,e,void 0,l),this.updateRawTexture(u,t,s,r,o,a,c),this.Rh.push(u),u},Up.prototype.updateRawTexture=function(t,i,e,s,n=null,r=0,h=!1){if(t){if(this.mh||(t.jn=i,t.invertY=s,t.nr=n,t.ur=h),i){const n=t.Er;4===e&&(i=zp(i,t.width,t.height,r));const h=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this.O2.updateTexture(h,t,t.width,t.height,t.depth,n.format,0,0,s,!1,0,0),t.generateMipMaps&&this.b3(t,this.B2)}t.isReady=!0}},Up.prototype.createRawCubeTexture=function(t,i,e,s,n,r,h,o=null){const a=new ai(this,oi.CubeRaw);return 1!==s||this.po.textureFloatLinearFiltering?2!==s||this.po.textureHalfFloatLinearFiltering?1!==s||this.po.textureFloatRender?2!==s||this.po.colorBufferFloat||(n=!1,F.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(n=!1,F.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(n=!1,h=1,F.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(n=!1,h=1,F.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")),a.isCube=!0,a.format=4===e?5:e,a.type=s,a.generateMipMaps=n,a.width=i,a.height=i,a.samplingMode=h,this.mh||(a.Kn=t),a.invertY=r,a.nr=o,a.Vn=0,a.kn=0,this.O2.createGPUTextureForInternalTexture(a),t&&this.updateRawCubeTexture(a,t,e,s,r,o),a.isReady=!0,a},Up.prototype.updateRawCubeTexture=function(t,i,e,s,n,r=null){t.Kn=i,t.invertY=n,t.nr=r;const h=t.Er,o=4===e,a=[];for(let e=0;e<i.length;++e){let n=i[e];o&&(n=zp(i[e],t.width,t.height,s)),a.push(new Uint8Array(n.buffer,n.byteOffset,n.byteLength))}this.O2.updateCubeTextures(a,h.underlyingResource,t.width,t.height,h.format,n,!1,0,0),t.generateMipMaps&&this.b3(t,this.B2),t.isReady=!0},Up.prototype.createRawCubeTextureFromUrl=function(t,i,e,s,n,r,h,o,a=null,l=null,c=3,u=!1){const f=this.createRawCubeTexture(null,e,s,n,!r,u,c,null);null==i||i.addPendingData(f),f.url=t,this.Rh.push(f);const d=t=>{const e=f.width,r=h(t);if(!r)return;const l=[0,2,4,1,3,5];if(o){const t=4===s,i=o(r),h=f.Er,a=[0,1,2,3,4,5];for(let s=0;s<i.length;s++){const r=e>>s,o=[];for(let e=0;e<6;e++){let h=i[s][a[e]];t&&(h=zp(h,r,r,n)),o.push(new Uint8Array(h.buffer,h.byteOffset,h.byteLength))}this.O2.updateCubeTextures(o,h.underlyingResource,r,r,h.format,u,!1,0,0)}}else{const t=[];for(let i=0;i<6;i++)t.push(r[l[i]]);this.updateRawCubeTexture(f,t,s,n,u)}f.isReady=!0,null==i||i.removePendingData(f),a&&a()};return this.tn(t,(t=>{d(t)}),void 0,null==i?void 0:i.offlineProvider,!0,((t,e)=>{null==i||i.removePendingData(f),l&&t&&l(t.status+" "+t.statusText,e)})),f},Up.prototype.createRawTexture3D=function(t,i,e,s,n,r,h,o,a=null,l=0,c=0){const u=oi.Raw3D,f=new ai(this,u);return f.baseWidth=i,f.baseHeight=e,f.baseDepth=s,f.width=i,f.height=e,f.depth=s,f.format=n,f.type=l,f.generateMipMaps=r,f.samplingMode=o,f.is3D=!0,this.mh||(f.jn=t),this.O2.createGPUTextureForInternalTexture(f,i,e,void 0,c),this.updateRawTexture3D(f,t,n,h,a,l),this.Rh.push(f),f},Up.prototype.updateRawTexture3D=function(t,i,e,s,n=null,r=0){if(this.mh||(t.jn=i,t.format=e,t.invertY=s,t.nr=n),i){const n=t.Er;4===e&&(i=zp(i,t.width,t.height,r));const h=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this.O2.updateTexture(h,t,t.width,t.height,t.depth,n.format,0,0,s,!1,0,0),t.generateMipMaps&&this.b3(t,this.B2)}t.isReady=!0},Up.prototype.createRawTexture2DArray=function(t,i,e,s,n,r,h,o,a=null,l=0,c=0){const u=oi.Raw2DArray,f=new ai(this,u);return f.baseWidth=i,f.baseHeight=e,f.baseDepth=s,f.width=i,f.height=e,f.depth=s,f.format=n,f.type=l,f.generateMipMaps=r,f.samplingMode=o,f.is2DArray=!0,this.mh||(f.jn=t),this.O2.createGPUTextureForInternalTexture(f,i,e,s,c),this.updateRawTexture2DArray(f,t,n,h,a,l),this.Rh.push(f),f},Up.prototype.updateRawTexture2DArray=function(t,i,e,s,n=null,r=0){if(this.mh||(t.jn=i,t.format=e,t.invertY=s,t.nr=n),i){const n=t.Er;4===e&&(i=zp(i,t.width,t.height,r));const h=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this.O2.updateTexture(h,t,t.width,t.height,t.depth,n.format,0,0,s,!1,0,0),t.generateMipMaps&&this.b3(t,this.B2)}t.isReady=!0},Up.prototype.Aw=function(t,i,e,s=-1,n=0,r=null,h=!0,o=!1,a=0,l=0){const c=t.Er;return h&&this.flushFramebuffer(),this.O2.readPixels(c.underlyingResource,a,l,i,e,c.format,s,n,r,o)},Up.prototype.Ew=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};class Hp extends er{}Up.prototype.$D=function(t,i,e){const s=new Hp(t,i,e,this);return this.Ih.push(s),s},Up.prototype.createRenderTargetTexture=function(t,i){var e,s;const n=this.$D(!1,!1,t),r={};void 0!==i&&"object"==typeof i?(r.generateMipMaps=i.generateMipMaps,r.generateDepthBuffer=void 0===i.generateDepthBuffer||i.generateDepthBuffer,r.generateStencilBuffer=r.generateDepthBuffer&&i.generateStencilBuffer,r.samplingMode=void 0===i.samplingMode?3:i.samplingMode,r.creationFlags=null!==(e=i.creationFlags)&&void 0!==e?e:0,r.noColorAttachment=!!i.noColorAttachment,r.samples=i.samples):(r.generateMipMaps=i,r.generateDepthBuffer=!0,r.generateStencilBuffer=!1,r.samplingMode=3,r.creationFlags=0,r.noColorAttachment=!1);const h=r.noColorAttachment?null:this.Ta(t,i,!0,oi.RenderTarget);return n.dw=null!==(s=r.samples)&&void 0!==s?s:1,n.BD=r.generateDepthBuffer,n.FD=!!r.generateStencilBuffer,n.setTextures(h),(n.BD||n.FD)&&n.createDepthStencilTexture(0,this.po.textureFloatLinearFiltering&&(void 0===r.samplingMode||2===r.samplingMode||2===r.samplingMode||3===r.samplingMode||3===r.samplingMode||5===r.samplingMode||6===r.samplingMode||7===r.samplingMode||11===r.samplingMode),n.FD,n.samples),h&&(void 0!==i&&"object"==typeof i&&i.createMipMaps&&!r.generateMipMaps&&(h.generateMipMaps=!0),this.O2.createGPUTextureForInternalTexture(h,void 0,void 0,void 0,r.creationFlags),void 0!==i&&"object"==typeof i&&i.createMipMaps&&!r.generateMipMaps&&(h.generateMipMaps=!1)),n},Up.prototype.jD=function(t,i){const e=new ai(this,oi.DepthStencil),s={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:i.generateStencil?13:14,...i};return e.format=s.depthTextureFormat,this.Va(e,t,s.generateStencil,s.bilinearFiltering,s.comparisonFunction,s.samples),this.O2.createGPUTextureForInternalTexture(e),this.Rh.push(e),e},Up.prototype.Va=function(t,i,e,s,n,r=1){const h=i.width||i,o=i.height||i,a=i.layers||0;t.baseWidth=h,t.baseHeight=o,t.width=h,t.height=o,t.is2DArray=a>0,t.depth=a,t.isReady=!0,t.samples=r,t.generateMipMaps=!1,t.samplingMode=s?2:1,t.type=1,t.Hn=n,t.Vn=0,t.kn=0},Up.prototype.updateRenderTargetTextureSampleCount=function(t,i){return t&&t.texture&&t.samples!==i?(i=Math.min(i,this.getCaps().maxMSAASamples),this.O2.createMSAATexture(t.texture,i),t.Yo&&(this.O2.createMSAATexture(t.Yo,i),t.Yo.samples=i),t.dw=i,t.texture.samples=i,i):i},Up.prototype.createRenderTargetCubeTexture=function(t,i){const e=this.$D(!1,!0,t),s={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...i};s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer,e.BD=s.generateDepthBuffer,e.FD=s.generateStencilBuffer;const n=new ai(this,oi.RenderTarget);return n.width=t,n.height=t,n.depth=0,n.isReady=!0,n.isCube=!0,n.samples=s.samples,n.generateMipMaps=s.generateMipMaps,n.samplingMode=s.samplingMode,n.type=s.type,n.format=s.format,this.Rh.push(n),e.setTextures(n),(e.BD||e.FD)&&e.createDepthStencilTexture(0,void 0===s.samplingMode||2===s.samplingMode||2===s.samplingMode||3===s.samplingMode||3===s.samplingMode||5===s.samplingMode||6===s.samplingMode||7===s.samplingMode||11===s.samplingMode,e.FD,e.samples),i&&i.createMipMaps&&!s.generateMipMaps&&(n.generateMipMaps=!0),this.O2.createGPUTextureForInternalTexture(n),i&&i.createMipMaps&&!s.generateMipMaps&&(n.generateMipMaps=!1),e},ei.prototype.setTextureSampler=function(t,i){this.Ls.setTextureSampler(t,i)},Up.prototype.setTextureSampler=function(t,i){var e;null===(e=this.W2)||void 0===e||e.setSampler(t,i)},ei.prototype.setStorageBuffer=function(t,i){this.Ls.setStorageBuffer(t,i)},Up.prototype.createStorageBuffer=function(t,i){return this.A3(t,32|i)},Up.prototype.updateStorageBuffer=function(t,i,e,s){const n=t;let r;void 0===e&&(e=0),void 0===s?(r=i instanceof Array?new Float32Array(i):i instanceof ArrayBuffer?new Uint8Array(i):i,s=r.byteLength):r=i instanceof Array?new Float32Array(i):i instanceof ArrayBuffer?new Uint8Array(i):i,this.cJ.setSubData(n,e,r,0,s)},Up.prototype.readFromStorageBuffer=function(t,i,e,s){e=e||t.capacity;const n=this.cJ.createRawBuffer(e,Sf.MapRead|Sf.CopyDst);return this.V2.copyBufferToBuffer(t.underlyingResource,null!=i?i:0,n,0,e),new Promise(((t,i)=>{this.onEndFrameObservable.addOnce((()=>{n.mapAsync(Ef.Read,0,e).then((()=>{const i=n.getMappedRange(0,e);let r=s;if(void 0===r)r=new Uint8Array(e),r.set(new Uint8Array(i));else{const t=r.constructor;r=new t(r.buffer),r.set(new t(i))}n.unmap(),this.cJ.releaseBuffer(n),t(r)}),(t=>i(t)))}))}))},Up.prototype.setStorageBuffer=function(t,i){var e,s;null===(e=this.JI)||void 0===e||e.setBuffer(t,null!==(s=null==i?void 0:i.getBuffer())&&void 0!==s?s:null)},Up.prototype.createUniformBuffer=function(t){let i;i=t instanceof Array?new Float32Array(t):t;return this.cJ.createBuffer(i,Sf.Uniform|Sf.CopyDst)},Up.prototype.createDynamicUniformBuffer=function(t){return this.createUniformBuffer(t)},Up.prototype.updateUniformBuffer=function(t,i,e,s){void 0===e&&(e=0);const n=t;let r;void 0===s?(r=i instanceof Float32Array?i:new Float32Array(i),s=r.byteLength):r=i instanceof Float32Array?i:new Float32Array(i),this.cJ.setSubData(n,e,r,0,s)},Up.prototype.bindUniformBufferBase=function(t,i,e){this.JI.setBuffer(e,t)},Up.prototype.bindUniformBlock=function(){},Up.prototype.updateVideoTexture=function(t,i,e){var s;if(!t||t.sr)return;void 0===this.iQ&&(this.iQ=!0);let n=t.Er;(null===(s=t.Er)||void 0===s?void 0:s.underlyingResource)||(n=this.O2.createGPUTextureForInternalTexture(t)),!function(t){return!(!t||void 0===t.underlyingResource)}(i)?i&&this.createImageBitmap(i).then((i=>{this.O2.updateTexture(i,t,t.width,t.height,t.depth,n.format,0,0,!e,!1,0,0),t.generateMipMaps&&this.b3(t,this.B2),t.isReady=!0})).catch((()=>{t.isReady=!0})):(this.O2.copyVideoToTexture(i,t,n.format,!e),t.generateMipMaps&&this.b3(t,this.B2),t.isReady=!0)};class Xp{}Xp.COPY=1,Xp.CUT=2,Xp.PASTE=3;class Wp extends Oo{constructor(t){super(t),this.controllerType=Ah.DAYDREAM}initControllerMesh(t,i){On.ImportMesh("",Wp.MODEL_BASE_URL,Wp.MODEL_FILENAME,t,(t=>{this.nX=t[1],this.attachToMesh(this.nX),i&&i(this.nX)}))}hX(t,i){if(0===t){const t=this.onTriggerStateChangedObservable;t&&t.notifyObservers(i)}else F.Warn(`Unrecognized Daydream button index: ${t}`)}}Wp.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",Wp.MODEL_FILENAME="generic.babylon",Wp.GAMEPAD_ID_PREFIX="Daydream",zh.PG.push({canCreate:t=>0===t.id.indexOf(Wp.GAMEPAD_ID_PREFIX),create:t=>new Wp(t)});class $p extends Oo{constructor(t){super(t),this.U3=["onPadStateChangedObservable","onTriggerStateChangedObservable"],this.controllerType=Ah.GEAR_VR,this.XG=new w("left"==this.hand?-.15:.15,-.5,.25),this.$G(this.XG)}initControllerMesh(t,i){On.ImportMesh("",$p.MODEL_BASE_URL,$p.MODEL_FILENAME,t,(e=>{const s=new Ys("",t);e[1].parent=s,e[1].position.z=-.15,this.nX=s,this.attachToMesh(this.nX),i&&i(this.nX)}))}hX(t,i){if(t<this.U3.length){const e=this[this.U3[t]];e&&e.notifyObservers(i)}}}$p.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",$p.MODEL_FILENAME="generic.babylon",$p.GAMEPAD_ID_PREFIX="Gear VR",zh.PG.push({canCreate:t=>0===t.id.indexOf($p.GAMEPAD_ID_PREFIX)||-1!==t.id.indexOf("Oculus Go")||-1!==t.id.indexOf("Vive Focus"),create:t=>new $p(t)});class Yp extends Oo{constructor(t){super(t)}initControllerMesh(t,i){On.ImportMesh("",Yp.MODEL_BASE_URL,Yp.MODEL_FILENAME,t,(t=>{this.nX=t[1],this.attachToMesh(this.nX),i&&i(this.nX)}))}hX(t,i){console.log("Button id: "+t+"state: "),console.dir(i)}}Yp.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",Yp.MODEL_FILENAME="generic.babylon",zh.DG=t=>new Yp(t);class jp extends Oo{constructor(t){super(t),this.onSecondaryTriggerStateChangedObservable=new h,this.onThumbRestChangedObservable=new h,this.controllerType=Ah.OCULUS}initControllerMesh(t,i){let e;e="left"===this.hand?jp.MODEL_LEFT_FILENAME:jp.MODEL_RIGHT_FILENAME,On.ImportMesh("",jp.V3?jp.QUEST_MODEL_BASE_URL:jp.MODEL_BASE_URL,e,t,(t=>{this.nX=jp.V3?t[0]:t[1],this.attachToMesh(this.nX),i&&i(this.nX)}))}get onAButtonStateChangedObservable(){if("right"===this.hand)return this.onMainButtonStateChangedObservable;throw new Error("No A button on left hand")}get onBButtonStateChangedObservable(){if("right"===this.hand)return this.onSecondaryButtonStateChangedObservable;throw new Error("No B button on left hand")}get onXButtonStateChangedObservable(){if("left"===this.hand)return this.onMainButtonStateChangedObservable;throw new Error("No X button on right hand")}get onYButtonStateChangedObservable(){if("left"===this.hand)return this.onSecondaryButtonStateChangedObservable;throw new Error("No Y button on right hand")}hX(t,i){const e=i,s="right"===this.hand?-1:1;switch(t){case 0:return void this.onPadStateChangedObservable.notifyObservers(e);case 1:return!jp.V3&&this.nX&&(this.nX.getChildren()[3].rotation.x=.2*-e.value,this.nX.getChildren()[3].position.y=.005*-e.value,this.nX.getChildren()[3].position.z=.005*-e.value),void this.onTriggerStateChangedObservable.notifyObservers(e);case 2:return!jp.V3&&this.nX&&(this.nX.getChildren()[4].position.x=s*e.value*.0035),void this.onSecondaryTriggerStateChangedObservable.notifyObservers(e);case 3:return!jp.V3&&this.nX&&(e.pressed?this.nX.getChildren()[1].position.y=-.001:this.nX.getChildren()[1].position.y=0),void this.onMainButtonStateChangedObservable.notifyObservers(e);case 4:return!jp.V3&&this.nX&&(e.pressed?this.nX.getChildren()[2].position.y=-.001:this.nX.getChildren()[2].position.y=0),void this.onSecondaryButtonStateChangedObservable.notifyObservers(e);case 5:return void this.onThumbRestChangedObservable.notifyObservers(e)}}}jp.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",jp.MODEL_LEFT_FILENAME="left.babylon",jp.MODEL_RIGHT_FILENAME="right.babylon",jp.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",jp.V3=!1,zh.PG.push({canCreate:t=>(E.LastCreatedEngine&&E.LastCreatedEngine.RH&&"Oculus Quest"===E.LastCreatedEngine.RH.displayName&&(jp.V3=!0),-1!==t.id.indexOf("Oculus Touch")),create:t=>new jp(t)});class Kp extends Oo{constructor(t){super(t),this.controllerType=Ah.VIVE,this.mU=!0}initControllerMesh(t,i){On.ImportMesh("",Kp.MODEL_BASE_URL,Kp.MODEL_FILENAME,t,(t=>{this.nX=t[1],this.attachToMesh(this.nX),i&&i(this.nX)}))}get onLeftButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onRightButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onMenuButtonStateChangedObservable(){return this.onSecondaryButtonStateChangedObservable}hX(t,i){const e=i;switch(t){case 0:return void this.onPadStateChangedObservable.notifyObservers(e);case 1:return this.nX&&(this.nX.getChildren()[6].rotation.x=.15*-e.value),void this.onTriggerStateChangedObservable.notifyObservers(e);case 2:return void this.onMainButtonStateChangedObservable.notifyObservers(e);case 3:return this.nX&&(e.pressed?this.nX.getChildren()[2].position.y=-.001:this.nX.getChildren()[2].position.y=0),void this.onSecondaryButtonStateChangedObservable.notifyObservers(e)}}}Kp.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",Kp.MODEL_FILENAME="wand.babylon",zh.PG.push({canCreate:t=>-1!==t.id.toLowerCase().indexOf("openvr"),create:t=>new Kp(t)});class qp{constructor(){this.buttonMeshes={},this.axisMeshes={}}}class Qp extends Oo{constructor(t){super(t),this.G3={buttons:["thumbstick","trigger","grip","menu","trackpad"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onPadStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["THUMBSTICK_X","THUMBSTICK_Y","TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y"],pointingPoseMeshName:Hh.POINTING_POSE},this.onTrackpadChangedObservable=new h,this.onTrackpadValuesChangedObservable=new h,this.trackpad={x:0,y:0},this.controllerType=Ah.WINDOWS,this.z3=null}get onTriggerButtonStateChangedObservable(){return this.onTriggerStateChangedObservable}get onMenuButtonStateChangedObservable(){return this.onSecondaryButtonStateChangedObservable}get onGripButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onThumbstickButtonStateChangedObservable(){return this.onPadStateChangedObservable}get onTouchpadButtonStateChangedObservable(){return this.onTrackpadChangedObservable}get onTouchpadValuesChangedObservable(){return this.onTrackpadValuesChangedObservable}H3(){!this.browserGamepad.axes||this.browserGamepad.axes[2]==this.trackpad.x&&this.browserGamepad.axes[3]==this.trackpad.y||(this.trackpad.x=this.browserGamepad.axes[this.G3.axisMeshNames.indexOf("TOUCHPAD_TOUCH_X")],this.trackpad.y=this.browserGamepad.axes[this.G3.axisMeshNames.indexOf("TOUCHPAD_TOUCH_Y")],this.onTrackpadValuesChangedObservable.notifyObservers(this.trackpad))}update(){if(super.update(),this.browserGamepad.axes&&(this.H3(),this.z3))for(let t=0;t<this.G3.axisMeshNames.length;t++)this.X3(t,this.browserGamepad.axes[t])}hX(t,i){const e=this.G3.buttons[t];if(!e)return;this.H3();const s=this[this.G3.buttonObservableNames[e]];s&&s.notifyObservers(i),this.W3(e,i.value)}W3(t,i){if(!this.z3)return;const e=this.z3.buttonMeshes[t];e&&e.unpressed.rotationQuaternion&&e.pressed.rotationQuaternion&&e.value.rotationQuaternion&&(T.SlerpToRef(e.unpressed.rotationQuaternion,e.pressed.rotationQuaternion,i,e.value.rotationQuaternion),w.LerpToRef(e.unpressed.position,e.pressed.position,i,e.value.position))}X3(t,i){if(!this.z3)return;const e=this.z3.axisMeshes[t];if(!e)return;if(!e.min.rotationQuaternion||!e.max.rotationQuaternion||!e.value.rotationQuaternion)return;const s=.5*i+.5;T.SlerpToRef(e.min.rotationQuaternion,e.max.rotationQuaternion,s,e.value.rotationQuaternion),w.LerpToRef(e.min.position,e.max.position,s,e.value.position)}initControllerMesh(t,i,e=!1){let s,n;if(On.IsPluginForExtensionAvailable(".glb")){let t="default";if(this.id&&!e){const i=this.id.match(Qp.GAMEPAD_ID_PATTERN);t=i&&i[0]||t}n="left"===this.hand?Qp.MODEL_LEFT_FILENAME:Qp.MODEL_RIGHT_FILENAME,s=Qp.MODEL_BASE_URL+t+"/"}else F.Warn("You need to reference GLTF loader to load Windows Motion Controllers model. Falling back to generic models"),s=Yp.MODEL_BASE_URL,n=Yp.MODEL_FILENAME;On.ImportMesh("",s,n,t,(e=>{this.z3=this.Y3(t,e),this.z3&&(this.nX=this.z3.rootNode,this.attachToMesh(this.nX),i&&i(this.nX))}),null,((t,r)=>{F.Log(r),F.Warn("Failed to retrieve controller model from the remote server: "+s+n),e||this.initControllerMesh(t,i,!0)}))}Y3(t,i){let e=null;const s=new Ys(this.id+" "+this.hand,t);let n=null;for(let t=0;t<i.length;t++){const e=i[t];if(!e.parent){e.isPickable=!1,n=e;break}}return n?(n.setParent(s),e=this.j3(s)):F.Warn("Could not find root node in model file."),e}j3(t){const i=new qp;let e;for(i.rootNode=t,i.buttonMeshes={},i.axisMeshes={},e=0;e<this.G3.buttons.length;e++){const r=this.G3.buttonMeshNames[this.G3.buttons[e]];if(!r){F.Log("Skipping unknown button at index: "+e+" with mapped name: "+this.G3.buttons[e]);continue}const h=s(t,r);if(!h){F.Warn("Missing button mesh with name: "+r);continue}const o={index:e,value:n(h,"VALUE"),pressed:n(h,"PRESSED"),unpressed:n(h,"UNPRESSED")};o.value&&o.pressed&&o.unpressed?i.buttonMeshes[this.G3.buttons[e]]=o:F.Warn("Missing button submesh under mesh with name: "+r+"(VALUE: "+!!o.value+", PRESSED: "+!!o.pressed+", UNPRESSED:"+!!o.unpressed+")")}for(e=0;e<this.G3.axisMeshNames.length;e++){const r=this.G3.axisMeshNames[e];if(!r){F.Log("Skipping unknown axis at index: "+e);continue}const h=s(t,r);if(!h){F.Warn("Missing axis mesh with name: "+r);continue}const o={index:e,value:n(h,"VALUE"),min:n(h,"MIN"),max:n(h,"MAX")};o.value&&o.min&&o.max?i.axisMeshes[e]=o:F.Warn("Missing axis submesh under mesh with name: "+r+"(VALUE: "+!!o.value+", MIN: "+!!o.min+", MAX:"+!!o.max+")")}return i.pointingPoseNode=s(t,this.G3.pointingPoseMeshName),i.pointingPoseNode?this.GG=i.pointingPoseNode:F.Warn("Missing pointing pose mesh with name: "+this.G3.pointingPoseMeshName),i;function s(t,i){return t.getChildren((t=>t.name===i),!1)[0]}function n(t,i){return t.getChildren((t=>t.name==i),!0)[0]}}getForwardRay(t=100){if(!this.z3||!this.z3.pointingPoseNode)return super.getForwardRay(t);const i=this.z3.pointingPoseNode.getWorldMatrix(),e=i.getTranslation(),s=new w(0,0,-1),n=w.TransformNormal(s,i),r=w.Normalize(n);return new vn(e,r,t)}dispose(){super.dispose(),this.onTrackpadChangedObservable.clear(),this.onTrackpadValuesChangedObservable.clear()}}Qp.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",Qp.MODEL_LEFT_FILENAME="left.glb",Qp.MODEL_RIGHT_FILENAME="right.glb",Qp.GAMEPAD_ID_PREFIX="Spatial Controller (Spatial Interaction Source) ",Qp.GAMEPAD_ID_PATTERN=/([0-9a-zA-Z]+-[0-9a-zA-Z]+)$/;zh.PG.push({canCreate:t=>0===t.id.indexOf(Qp.GAMEPAD_ID_PREFIX),create:t=>new Qp(t)});class Zp extends $c{constructor(t,i=_.Gray(),e=Wc.DefaultUtilityLayer,s=32,n=null,r=!1,o=1){var a;super(e),this.mN=null,this.snapDistance=0,this.onSnapObservable=new h,this.angle=0,this.ui=!0,this.jt=null,this.K3=!1,this.q3=new w,this.jt=n,this.Q3=new sc("",e.utilityLayerScene),this.Q3.diffuseColor=i,this.Q3.specularColor=i.subtract(new _(.1,.1,.1)),this.Z3=new sc("",e.utilityLayerScene),this.Z3.diffuseColor=_.Yellow(),this.J3=new sc("",e.utilityLayerScene),this.J3.diffuseColor=_.Gray(),this.J3.alpha=.4,this.t4=new Ys("",e.utilityLayerScene);const{rotationMesh:l,collider:c}=this.i4(this.t4,o,s);this.e4=En("rotationDisplay",{size:.6,updatable:!1},this.gizmoLayer.utilityLayerScene),this.e4.rotation.z=.5*Math.PI,this.e4.parent=this.t4,this.e4.setEnabled(!1),ei.ShadersStore.rotationGizmoVertexShader=Zp.s4,ei.ShadersStore.rotationGizmoFragmentShader=Zp.n4,this.r4=new eu("shader",this.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles"]}),this.r4.backFaceCulling=!1,this.e4.material=this.r4,this.e4.visibility=.999,this.t4.lookAt(this.zK.position.add(t)),this.zK.addChild(this.t4,$c.PreserveScaling),this.t4.scaling.scaleInPlace(1/3),this.dragBehavior=new An({dragPlaneNormal:t}),this.dragBehavior.moveAttached=!1,this.dragBehavior.maxDragAngle=Zp.MaxDragAngle,this.dragBehavior.Zy=!0,this.zK.addBehavior(this.dragBehavior);const f=new w,d=new R,p=new w;let m=new w;this.dragBehavior.onDragStartObservable.add((t=>{this.attachedNode&&(f.copyFrom(t.dragPlanePoint),this.e4.setEnabled(!0),this.e4.getWorldMatrix().invertToRef(d),w.TransformCoordinatesToRef(t.dragPlanePoint,d,f),this.q3.x=Math.atan2(f.y,f.x)+Math.PI,this.q3.y=0,this.q3.z=this.updateGizmoRotationToMatchAttachedMesh?1:0,this.K3=!0,f.copyFrom(t.dragPlanePoint),this.r4.setVector3("angles",this.q3),this.angle=0)})),this.dragBehavior.onDragEndObservable.add((()=>{this.K3=!1,this.e4.setEnabled(!1)}));const v={snapDistance:0};let g=0;const S=new R,E=new T;this.dragBehavior.onDragObservable.add((i=>{if(this.attachedNode){const s=new w(1,1,1),n=new T(0,0,0,1),r=new w(0,0,0);this.XK(),this.attachedNode.getWorldMatrix().decompose(s,n,r);if(!(Math.abs(Math.abs(s.x)-Math.abs(s.y))<=u&&Math.abs(Math.abs(s.x)-Math.abs(s.z))<=u)&&this.updateGizmoRotationToMatchAttachedMesh)return void F.Warn("Unable to use a rotation gizmo matching mesh rotation with non uniform scaling. Use uniform scaling or set updateGizmoRotationToMatchAttachedMesh to false.");n.normalize();const h=this.updateGizmoPositionToMatchAttachedMesh?r:this.zK.absolutePosition,o=i.dragPlanePoint.subtract(h).normalize(),a=f.subtract(h).normalize(),l=w.Cross(o,a),c=w.Dot(o,a);let A=Math.atan2(l.length(),c);p.copyFrom(t),m.copyFrom(t),this.updateGizmoRotationToMatchAttachedMesh&&(n.toRotationMatrix(d),m=w.TransformCoordinates(p,d));let C=!1;if(e.utilityLayerScene.activeCamera){const t=e.utilityLayerScene.activeCamera.position.subtract(h).normalize();w.Dot(t,m)>0&&(p.scaleInPlace(-1),m.scaleInPlace(-1),C=!0)}w.Dot(m,l)>0&&(A=-A);let x=!1;if(0!=this.snapDistance)if(g+=A,Math.abs(g)>this.snapDistance){let t=Math.floor(Math.abs(g)/this.snapDistance);g<0&&(t*=-1),g%=this.snapDistance,A=this.snapDistance*t,x=!0}else A=0;const I=Math.sin(A/2);if(E.set(p.x*I,p.y*I,p.z*I,Math.cos(A/2)),S.determinant()>0){const t=new w;E.toEulerAnglesToRef(t),T.RotationYawPitchRollToRef(t.y,-t.x,-t.z,E)}this.updateGizmoRotationToMatchAttachedMesh?(n.multiplyToRef(E,n),R.ComposeToRef(s,n,r,this.attachedNode.getWorldMatrix())):(E.toRotationMatrix(M.Matrix[0]),M.Matrix[0].multiplyToRef(this.attachedNode.getWorldMatrix(),this.attachedNode.getWorldMatrix())),f.copyFrom(i.dragPlanePoint),x&&(v.snapDistance=A,this.onSnapObservable.notifyObservers(v)),this.q3.y+=A,this.angle+=C?-A:A,this.r4.setVector3("angles",this.q3),this.WK()}}));const A=e.bK();A.includedOnlyMeshes=A.includedOnlyMeshes.concat(this.zK.getChildMeshes(!1));const C={colliderMeshes:[c],gizmoMeshes:[l],material:this.Q3,hoverMaterial:this.Z3,disableMaterial:this.J3,active:!1,dragBehavior:this.dragBehavior};null===(a=this.jt)||void 0===a||a.addToAxisCache(this.t4,C),this.mN=e.utilityLayerScene.onPointerObservable.add((t=>{var i;if(!this.BK&&(this.dragBehavior.maxDragAngle=Zp.MaxDragAngle,this.FK=!(-1==C.colliderMeshes.indexOf(null===(i=null==t?void 0:t.pickInfo)||void 0===i?void 0:i.pickedMesh)),!this.jt)){const t=C.dragBehavior.enabled?this.FK||this.K3?this.Z3:this.Q3:this.J3;this.$K(C.gizmoMeshes,t)}})),this.dragBehavior.onEnabledObservable.add((t=>{this.$K(C.gizmoMeshes,t?this.Q3:this.J3)}))}get coloredMaterial(){return this.Q3}get hoverMaterial(){return this.Z3}get disableMaterial(){return this.J3}i4(t,i,e){const s=xc("ignore",{diameter:.6,thickness:.03*i,tessellation:e},this.gizmoLayer.utilityLayerScene);s.visibility=0;const n=xc("",{diameter:.6,thickness:.005*i,tessellation:e},this.gizmoLayer.utilityLayerScene);return n.material=this.Q3,n.rotation.x=Math.PI/2,s.rotation.x=Math.PI/2,t.addChild(n,$c.PreserveScaling),t.addChild(s,$c.PreserveScaling),{rotationMesh:n,collider:s}}HK(t){this.dragBehavior&&(this.dragBehavior.enabled=!!t)}set isEnabled(t){this.ui=t,t?this.jt&&(this.attachedMesh=this.jt.attachedMesh):this.attachedMesh=null}get isEnabled(){return this.ui}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this.mN),this.dragBehavior.detach(),this.t4&&this.t4.dispose(),this.e4&&this.e4.dispose(),this.r4&&this.r4.dispose(),[this.Q3,this.Z3,this.J3].forEach((t=>{t&&t.dispose()})),super.dispose()}}Zp.MaxDragAngle=9*Math.PI/20,Zp.s4="\n        precision highp float;\n        attribute vec3 position;\n        attribute vec2 uv;\n        uniform mat4 worldViewProjection;\n        varying vec3 vPosition;\n        varying vec2 vUV;\n        void main(void) {\n            gl_Position = worldViewProjection * vec4(position, 1.0);\n            vUV = uv;\n        }",Zp.n4="\n        precision highp float;\n        varying vec2 vUV;\n        varying vec3 vPosition;\n        uniform vec3 angles;\n        #define twopi 6.283185307\n        void main(void) {\n            vec2 uv = vUV - vec2(0.5);\n            float angle = atan(uv.y, uv.x) + 3.141592;\n            float delta = gl_FrontFacing ? angles.y : -angles.y;\n            float begin = angles.x - delta * angles.z;\n            float start = (begin < (begin + delta)) ? begin : (begin + delta);\n            float end = (begin > (begin + delta)) ? begin : (begin + delta);\n            float len = sqrt(dot(uv,uv));\n            float opacity = 1. - step(0.5, len);\n\n            float base = abs(floor(start / twopi)) * twopi;\n            start += base;\n            end += base;\n\n            float intensity = 0.;\n            for (int i = 0; i < 5; i++)\n            {\n                intensity += max(step(start, angle) - step(end, angle), 0.);\n                angle += twopi;\n            }\n            gl_FragColor = vec4(1.,1.,0., min(intensity * 0.25, 0.8)) * opacity;\n        }";function Jp(t){const i=[];i[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},i[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},i[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},i[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},i[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},i[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},i[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},i[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},i[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},i[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},i[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},i[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},i[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},i[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},i[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};const e=t.type&&(t.type<0||t.type>=i.length)?0:t.type||0,s=t.size,n=t.sizeX||s||1,r=t.sizeY||s||1,h=t.sizeZ||s||1,o=t.custom||i[e],a=o.face.length,l=t.faceUV||new Array(a),c=t.faceColors,u=void 0===t.flat||t.flat,f=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE,d=new Array,p=new Array,m=new Array,v=new Array,g=new Array;let S=0,E=0;const A=new Array;let C,w,T,R,I,M,b=0,_=0;if(u)for(_=0;_<a;_++)c&&void 0===c[_]&&(c[_]=new y(1,1,1,1)),l&&void 0===l[_]&&(l[_]=new x(0,0,1,1));if(u)for(_=0;_<a;_++){const t=o.face[_].length;for(T=2*Math.PI/t,R=.5*Math.tan(T/2),I=.5,b=0;b<t;b++)d.push(o.vertex[o.face[_][b]][0]*n,o.vertex[o.face[_][b]][1]*r,o.vertex[o.face[_][b]][2]*h),A.push(S),S++,C=l[_].x+(l[_].z-l[_].x)*(.5+R),w=l[_].y+(l[_].w-l[_].y)*(I-.5),v.push(C,As.UseOpenGLOrientationForUV?1-w:w),M=R*Math.cos(T)-I*Math.sin(T),I=R*Math.sin(T)+I*Math.cos(T),R=M,c&&g.push(c[_].r,c[_].g,c[_].b,c[_].a);for(b=0;b<t-2;b++)p.push(A[0+E],A[b+2+E],A[b+1+E]);E+=t}else{for(b=0;b<o.vertex.length;b++)d.push(o.vertex[b][0]*n,o.vertex[b][1]*r,o.vertex[b][2]*h),v.push(0,As.UseOpenGLOrientationForUV?1:0);for(_=0;_<a;_++)for(b=0;b<o.face[_].length-2;b++)p.push(o.face[_][0],o.face[_][b+2],o.face[_][b+1])}os.ComputeNormals(d,p,m),os.JA(f,d,p,m,v,t.frontUVs,t.backUVs);const N=new os;return N.positions=d,N.indices=p,N.normals=m,N.uvs=v,c&&u&&(N.colors=g),N}function tm(t,i={},e=null){const s=new Ys(t,e);i.sideOrientation=Ys.OI(i.sideOrientation),s.yI=i.sideOrientation;return Jp(i).applyToMesh(s,i.updatable),s}os.CreatePolyhedron=Jp,Ys.CreatePolyhedron=(t,i,e)=>tm(t,i,e);class im extends No{constructor(){super(...arguments),this.h4=!0}o4(t){this.rA=t}get position(){return this.rA}set position(t){this.o4(t)}a4(t){this.GP=t}get direction(){return this.GP}set direction(t){this.a4(t)}get shadowMinZ(){return this.l4}set shadowMinZ(t){this.l4=t,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this.c4}set shadowMaxZ(t){this.c4=t,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return!(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition||(this.transformedPosition=w.Zero()),w.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=w.Zero()),w.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0)}getDepthScale(){return 50}getShadowDirection(t){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(t){return this.direction=w.Normalize(t.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const t=w.Cross(this.direction,Ge.Y),i=w.Cross(t,this.direction);return w.RotationFromAxis(t,i,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this.h4}forceProjectionMatrixCompute(){this.h4=!0}Fi(){super.Fi(),this.Ii.position=w.Zero()}Wi(){return!!this.Ii.position.equals(this.position)}computeWorldMatrix(t){return!t&&this.isSynchronized()?(this.Ai=this.getScene().getRenderId(),this._i):(this.Hi(),this.Ii.position.copyFrom(this.position),this._i||(this._i=R.Identity()),R.TranslationToRef(this.position.x,this.position.y,this.position.z,this._i),this.parent&&this.parent.getWorldMatrix&&(this._i.multiplyToRef(this.parent.getWorldMatrix(),this._i),this.$i()),this.Ni=!0,this._i)}getDepthMinZ(t){return void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ}getDepthMaxZ(t){return void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ}setShadowProjectionMatrix(t,i,e){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(i,e,t):this.u4(t,i,e),this}ki(){super.ki(),this.parent&&this.parent.getWorldMatrix||(this.transformedPosition=null,this.transformedDirection=null)}}ut([et()],im.prototype,"position",null),ut([et()],im.prototype,"direction",null),ut([Q()],im.prototype,"shadowMinZ",null),ut([Q()],im.prototype,"shadowMaxZ",null),dt.AddNodeConstructor("Light_Type_1",((t,i)=>()=>new em(t,w.Zero(),i)));class em extends im{constructor(t,i,e){super(t,e),this.f4=0,this.d4=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this.oA=Number.MAX_VALUE,this.aA=Number.MIN_VALUE,this.cA=Number.MIN_VALUE,this.lA=Number.MAX_VALUE,this.position=i.scale(-1),this.direction=i}get shadowFrustumSize(){return this.f4}set shadowFrustumSize(t){this.f4=t,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this.d4}set shadowOrthoScale(t){this.d4=t,this.forceProjectionMatrixCompute()}get orthoLeft(){return this.oA}set orthoLeft(t){this.oA=t}get orthoRight(){return this.aA}set orthoRight(t){this.aA=t}get orthoTop(){return this.cA}set orthoTop(t){this.cA=t}get orthoBottom(){return this.lA}set orthoBottom(t){this.lA=t}getClassName(){return"DirectionalLight"}getTypeID(){return No.LIGHTTYPEID_DIRECTIONALLIGHT}u4(t,i,e){this.shadowFrustumSize>0?this.m4(t):this.v4(t,i,e)}m4(t){const i=this.getScene().activeCamera;i&&R.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:i.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:i.maxZ,t,this.getScene().getEngine().isNDCHalfZRange)}v4(t,i,e){const s=this.getScene().activeCamera;if(!s)return;if(this.autoUpdateExtends||this.oA===Number.MAX_VALUE){const t=w.Zero();this.oA=Number.MAX_VALUE,this.aA=Number.MIN_VALUE,this.cA=Number.MIN_VALUE,this.lA=Number.MAX_VALUE;let s=Number.MAX_VALUE,n=Number.MIN_VALUE;for(let r=0;r<e.length;r++){const h=e[r];if(!h)continue;const o=h.getBoundingInfo().boundingBox;for(let e=0;e<o.vectorsWorld.length;e++)w.TransformCoordinatesToRef(o.vectorsWorld[e],i,t),t.x<this.oA&&(this.oA=t.x),t.y<this.lA&&(this.lA=t.y),t.x>this.aA&&(this.aA=t.x),t.y>this.cA&&(this.cA=t.y),this.autoCalcShadowZBounds&&(t.z<s&&(s=t.z),t.z>n&&(n=t.z))}this.autoCalcShadowZBounds&&(this.l4=s,this.c4=n)}const n=this.aA-this.oA,r=this.cA-this.lA,h=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,o=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;R.OrthoOffCenterLHToRef(this.oA-n*this.shadowOrthoScale,this.aA+n*this.shadowOrthoScale,this.lA-r*this.shadowOrthoScale,this.cA+r*this.shadowOrthoScale,a?o:h,a?h:o,t,this.getScene().getEngine().isNDCHalfZRange)}kT(){this.VT.addUniform("vLightData",4),this.VT.addUniform("vLightDiffuse",4),this.VT.addUniform("vLightSpecular",4),this.VT.addUniform("shadowsInfo",3),this.VT.addUniform("depthValues",2),this.VT.create()}transferToEffect(t,i){return this.computeTransformedInformation()?(this.VT.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,i),this):(this.VT.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,i),this)}transferToNodeMaterialEffect(t,i){return this.computeTransformedInformation()?(t.setFloat3(i,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(t.setFloat3(i,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(t){const i=this.Kt.getEngine();return!i.useReverseDepthBuffer&&i.isNDCHalfZRange?0:1}getDepthMaxZ(t){const i=this.Kt.getEngine();return i.useReverseDepthBuffer&&i.isNDCHalfZRange?0:1}prepareLightSpecificDefines(t,i){t["DIRLIGHT"+i]=!0}}function sm(t){const i=new Array,e=new Array,s=new Array,n=new Array,r=t.radius||.5,h=t.tessellation||64,o=t.arc&&(t.arc<=0||t.arc>1)?1:t.arc||1,a=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE;i.push(0,0,0),n.push(.5,.5);const l=2*Math.PI*o,c=1===o?l/h:l/(h-1);let u=0;for(let t=0;t<h;t++){const t=Math.cos(u),e=Math.sin(u),s=(t+1)/2,h=(1-e)/2;i.push(r*t,r*e,0),n.push(s,As.UseOpenGLOrientationForUV?1-h:h),u+=c}1===o&&(i.push(i[3],i[4],i[5]),n.push(n[2],As.UseOpenGLOrientationForUV?1-n[3]:n[3]));const f=i.length/3;for(let t=1;t<f-1;t++)e.push(t+1,0,t);os.ComputeNormals(i,e,s),os.JA(a,i,e,s,n,t.frontUVs,t.backUVs);const d=new os;return d.indices=e,d.positions=i,d.normals=s,d.uvs=n,d}function nm(t,i={},e=null){const s=new Ys(t,e);i.sideOrientation=Ys.OI(i.sideOrientation),s.yI=i.sideOrientation;return sm(i).applyToMesh(s,i.updatable),s}ut([Q()],em.prototype,"shadowFrustumSize",null),ut([Q()],em.prototype,"shadowOrthoScale",null),ut([Q()],em.prototype,"autoUpdateExtends",void 0),ut([Q()],em.prototype,"autoCalcShadowZBounds",void 0),ut([Q("orthoLeft")],em.prototype,"_orthoLeft",void 0),ut([Q("orthoRight")],em.prototype,"_orthoRight",void 0),ut([Q("orthoTop")],em.prototype,"_orthoTop",void 0),ut([Q("orthoBottom")],em.prototype,"_orthoBottom",void 0);function rm(t,i={},e){i.diameter||(i.diameter=1),i.segments||(i.segments=16);const s=Qc("",{slice:.5,diameter:i.diameter,segments:i.segments},e),n=nm("",{radius:i.diameter/2,tessellation:3*i.segments+(4-i.segments)},e);n.rotation.x=-Math.PI/2,n.parent=s;const r=Ys.MergeMeshes([n,s],!0);return r.name=t,r}os.CreateDisc=sm,Ys.CreateDisc=(t,i,e,s=null,n,r)=>nm(t,{radius:i,tessellation:e,sideOrientation:r,updatable:n},s);Ys.CreateHemisphere=(t,i,e,s)=>rm(t,{segments:i,diameter:e},s),dt.AddNodeConstructor("Light_Type_2",((t,i)=>()=>new hm(t,w.Zero(),w.Zero(),0,0,i)));class hm extends im{constructor(t,i,e,s,n,r){super(t,r),this.g4=0,this.S4=R.Zero(),this.E4=1e-6,this.A4=1e3,this.C4=w.Up(),this.w4=!0,this.x4=!0,this.T4=!0,this.R4=w.Zero(),this.I4=R.Zero(),this.M4=R.Zero(),this.b4=R.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=i,this.direction=e,this.angle=s,this.exponent=n}get angle(){return this.CL}set angle(t){this.CL=t,this._4=Math.cos(.5*t),this.x4=!0,this.forceProjectionMatrixCompute(),this.y4()}get innerAngle(){return this.g4}set innerAngle(t){this.g4=t,this.y4()}get shadowAngleScale(){return this.N4}set shadowAngleScale(t){this.N4=t,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this.S4}get projectionTextureLightNear(){return this.E4}set projectionTextureLightNear(t){this.E4=t,this.x4=!0}get projectionTextureLightFar(){return this.A4}set projectionTextureLightFar(t){this.A4=t,this.x4=!0}get projectionTextureUpDirection(){return this.C4}set projectionTextureUpDirection(t){this.C4=t,this.x4=!0}get projectionTexture(){return this.P4}set projectionTexture(t){this.P4!==t&&(this.P4=t,this.T4=!0,this.P4&&!this.P4.isReady()&&(hm.D4(this.P4)?this.P4.getEffect().executeWhenCompiled((()=>{this.pH()})):hm.L4(this.P4)&&this.P4.onLoadObservable.addOnce((()=>{this.pH()}))))}static D4(t){return void 0!==t.onGeneratedObservable}static L4(t){return void 0!==t.onLoadObservable}get projectionTextureProjectionLightMatrix(){return this.M4}set projectionTextureProjectionLightMatrix(t){this.M4=t,this.x4=!1,this.T4=!0}getClassName(){return"SpotLight"}getTypeID(){return No.LIGHTTYPEID_SPOTLIGHT}a4(t){super.a4(t),this.w4=!0}o4(t){super.o4(t),this.w4=!0}u4(t,i,e){const s=this.getScene().activeCamera;if(!s)return;this.N4=this.N4||1;const n=this.N4*this.CL,r=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,h=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;R.PerspectiveFovLHToRef(n,1,o?h:r,o?r:h,t,!0,this.Kt.getEngine().isNDCHalfZRange,void 0,o)}O4(){this.w4=!1,this.T4=!0,this.position.addToRef(this.direction,this.R4),R.LookAtLHToRef(this.position,this.R4,this.C4,this.I4)}F4(){this.x4=!1,this.T4=!0;const t=this.projectionTextureLightFar,i=this.projectionTextureLightNear,e=t/(t-i),s=-e*i,n=1/Math.tan(this.CL/2);R.FromValuesToRef(n/1,0,0,0,0,n,0,0,0,0,e,1,0,0,s,0,this.M4)}B4(){if(this.T4=!1,this.I4.multiplyToRef(this.M4,this.S4),this.P4 instanceof an){const t=this.P4.uScale/2,i=this.P4.vScale/2;R.FromValuesToRef(t,0,0,0,0,i,0,0,0,0,.5,0,.5,.5,.5,1,this.b4)}this.S4.multiplyToRef(this.b4,this.S4)}kT(){this.VT.addUniform("vLightData",4),this.VT.addUniform("vLightDiffuse",4),this.VT.addUniform("vLightSpecular",4),this.VT.addUniform("vLightDirection",3),this.VT.addUniform("vLightFalloff",4),this.VT.addUniform("shadowsInfo",3),this.VT.addUniform("depthValues",2),this.VT.create()}y4(){this.U4=1/Math.max(.001,Math.cos(.5*this.g4)-this._4),this.V4=-this._4*this.U4}transferTexturesToEffect(t,i){return this.projectionTexture&&this.projectionTexture.isReady()&&(this.w4&&this.O4(),this.x4&&this.F4(),this.T4&&this.B4(),t.setMatrix("textureProjectionMatrix"+i,this.S4),t.setTexture("projectionLightSampler"+i,this.projectionTexture)),this}transferToEffect(t,i){let e;return this.computeTransformedInformation()?(this.VT.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,i),e=w.Normalize(this.transformedDirection)):(this.VT.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,i),e=w.Normalize(this.direction)),this.VT.updateFloat4("vLightDirection",e.x,e.y,e.z,this._4,i),this.VT.updateFloat4("vLightFalloff",this.range,this.eH,this.U4,this.V4,i),this}transferToNodeMaterialEffect(t,i){let e;return e=this.computeTransformedInformation()?w.Normalize(this.transformedDirection):w.Normalize(this.direction),this.getScene().useRightHandedSystem?t.setFloat3(i,-e.x,-e.y,-e.z):t.setFloat3(i,e.x,e.y,e.z),this}dispose(){super.dispose(),this.P4&&this.P4.dispose()}getDepthMinZ(t){const i=this.Kt.getEngine(),e=void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ;return i.useReverseDepthBuffer&&i.isNDCHalfZRange?e:this.Kt.getEngine().isNDCHalfZRange?0:e}getDepthMaxZ(t){const i=this.Kt.getEngine(),e=void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ;return i.useReverseDepthBuffer&&i.isNDCHalfZRange?0:e}prepareLightSpecificDefines(t,i){t["SPOTLIGHT"+i]=!0,t["PROJECTEDLIGHTTEXTURE"+i]=!(!this.projectionTexture||!this.projectionTexture.isReady())}}ut([Q()],hm.prototype,"angle",null),ut([Q()],hm.prototype,"innerAngle",null),ut([Q()],hm.prototype,"shadowAngleScale",null),ut([Q()],hm.prototype,"exponent",void 0),ut([Q()],hm.prototype,"projectionTextureLightNear",null),ut([Q()],hm.prototype,"projectionTextureLightFar",null),ut([Q()],hm.prototype,"projectionTextureUpDirection",null),ut([Z("projectedLightTexture")],hm.prototype,"_projectionTexture",void 0);class om extends $c{constructor(t=Wc.DefaultUtilityLayer){super(t),this.G4=new w,this.z4=new w(0,0,1),this.mN=null,this.onClickedObservable=new h,this.H4=null,this.attachedMesh=new ys("",this.gizmoLayer.utilityLayerScene),this.X4=new Is("parent",this.gizmoLayer.utilityLayerScene),this.attachedMesh.parent=this.X4,this.IT=new sc("light",this.gizmoLayer.utilityLayerScene),this.IT.diffuseColor=new _(.5,.5,.5),this.IT.specularColor=new _(.1,.1,.1),this.mN=t.utilityLayerScene.onPointerObservable.add((t=>{this.H4&&(this.FK=!(!t.pickInfo||-1==this.zK.getChildMeshes().indexOf(t.pickInfo.pickedMesh)),this.FK&&0===t.event.button&&this.onClickedObservable.notifyObservers(this.H4))}),pe.POINTERDOWN)}get attachedNode(){return this.attachedMesh}set attachedNode(t){console.warn("Nodes cannot be attached to LightGizmo. Attach to a mesh instead.")}set light(t){if(this.H4=t,t){this.W4&&this.W4.dispose(),this.W4=t instanceof Po?om.Y4(this.gizmoLayer.utilityLayerScene):t instanceof em?om.j4(this.gizmoLayer.utilityLayerScene):t instanceof hm?om.K4(this.gizmoLayer.utilityLayerScene):om.q4(this.gizmoLayer.utilityLayerScene),this.W4.getChildMeshes(!1).forEach((t=>{t.material=this.IT})),this.W4.parent=this.zK;const i=this.gizmoLayer.bK();i.includedOnlyMeshes=i.includedOnlyMeshes.concat(this.W4.getChildMeshes(!1)),this.W4.rotationQuaternion=new T,this.attachedMesh.reservedDataStore||(this.attachedMesh.reservedDataStore={}),this.attachedMesh.reservedDataStore.lightGizmo=this,t.parent&&this.X4.freezeWorldMatrix(t.parent.getWorldMatrix()),t.position&&(this.attachedMesh.position.copyFrom(t.position),this.attachedMesh.computeWorldMatrix(!0),this.G4.copyFrom(this.attachedMesh.position)),t.direction&&(this.attachedMesh.setDirection(t.direction),this.attachedMesh.computeWorldMatrix(!0),this.z4.copyFrom(this.attachedMesh.forward)),this.HA()}}get light(){return this.H4}get material(){return this.IT}HA(){if(super.HA(),this.H4){if(this.H4.parent&&this.X4.freezeWorldMatrix(this.H4.parent.getWorldMatrix()),this.H4.position)if(this.attachedMesh.position.equals(this.G4))this.attachedMesh.position.copyFrom(this.H4.position),this.attachedMesh.computeWorldMatrix(!0),this.G4.copyFrom(this.attachedMesh.position);else{const t=this.attachedMesh.position;this.H4.position=new w(t.x,t.y,t.z),this.G4.copyFrom(this.attachedMesh.position)}if(this.H4.direction)if(w.DistanceSquared(this.attachedMesh.forward,this.z4)>1e-4){const t=this.attachedMesh.forward;this.H4.direction=new w(t.x,t.y,t.z),this.z4.copyFrom(this.attachedMesh.forward)}else w.DistanceSquared(this.attachedMesh.forward,this.H4.direction)>1e-4&&(this.attachedMesh.setDirection(this.H4.direction),this.attachedMesh.computeWorldMatrix(!0),this.z4.copyFrom(this.attachedMesh.forward))}}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this.mN),this.IT.dispose(),super.dispose(),this.X4.dispose()}static Y4(t){const i=new Ys("hemisphereLight",t),e=rm(i.name,{segments:10,diameter:1},t);e.position.z=-.15,e.rotation.x=Math.PI/2,e.parent=i;return this.Q4(3,t).parent=i,i.scaling.scaleInPlace(om.Z4),i.rotation.x=Math.PI/2,i}static q4(t){const i=new Ys("pointLight",t),e=Qc(i.name,{segments:10,diameter:1},t);e.rotation.x=Math.PI/2,e.parent=i;return this.Q4(5,t).parent=i,i.scaling.scaleInPlace(om.Z4),i.rotation.x=Math.PI/2,i}static K4(t){const i=new Ys("spotLight",t);Qc(i.name,{segments:10,diameter:1},t).parent=i;const e=rm(i.name,{segments:10,diameter:2},t);e.parent=i,e.rotation.x=-Math.PI/2;return this.Q4(2,t).parent=i,i.scaling.scaleInPlace(om.Z4),i.rotation.x=Math.PI/2,i}static j4(t){const i=new Ys("directionalLight",t),e=new Ys(i.name,t);e.parent=i;Qc(i.name,{diameter:1.2,segments:10},t).parent=e;const s=Cc(i.name,{updatable:!1,height:6,diameterTop:.3,diameterBottom:.3,tessellation:6,subdivisions:1},t);s.parent=e;let n=s.clone(i.name);n.scaling.y=.5,n.position.x+=1.25;let r=s.clone(i.name);r.scaling.y=.5,r.position.x+=-1.25;const h=Cc(i.name,{updatable:!1,height:1,diameterTop:0,diameterBottom:.6,tessellation:6,subdivisions:1},t);return h.position.y+=3,h.parent=e,n=h.clone(i.name),n.position.y=1.5,n.position.x+=1.25,r=h.clone(i.name),r.position.y=1.5,r.position.x+=-1.25,e.scaling.scaleInPlace(om.Z4),e.rotation.z=Math.PI/2,e.rotation.y=Math.PI/2,i}}om.Z4=.007,om.Q4=(t,i)=>{const e=new Ys("root",i);e.rotation.x=Math.PI/2;const s=new Ys("linePivot",i);s.parent=e;const n=Cc("line",{updatable:!1,height:2,diameterTop:.2,diameterBottom:.3,tessellation:6,subdivisions:1},i);if(n.position.y=n.scaling.y/2+1.2,n.parent=s,t<2)return s;for(let t=0;t<4;t++){const i=s.clone("lineParentClone");i.rotation.z=Math.PI/4,i.rotation.y=Math.PI/2+Math.PI/2*t,i.getChildMeshes()[0].scaling.y=.5,i.getChildMeshes()[0].scaling.x=i.getChildMeshes()[0].scaling.z=.8,i.getChildMeshes()[0].position.y=i.getChildMeshes()[0].scaling.y/2+1.2}if(t<3)return e;for(let t=0;t<4;t++){const i=s.clone("linePivotClone");i.rotation.z=Math.PI/2,i.rotation.y=Math.PI/2*t}if(t<4)return e;for(let t=0;t<4;t++){const i=s.clone("linePivotClone");i.rotation.z=Math.PI+Math.PI/4,i.rotation.y=Math.PI/2+Math.PI/2*t,i.getChildMeshes()[0].scaling.y=.5,i.getChildMeshes()[0].scaling.x=i.getChildMeshes()[0].scaling.z=.8,i.getChildMeshes()[0].position.y=i.getChildMeshes()[0].scaling.y/2+1.2}if(t<5)return e;return s.clone("linePivotClone").rotation.z=Math.PI,e};class am extends $c{constructor(t=Wc.DefaultUtilityLayer){super(t),this.mN=null,this.onClickedObservable=new h,this.JD=null,this.J4=new R,this.IT=new sc("cameraGizmoMaterial",this.gizmoLayer.utilityLayerScene),this.IT.diffuseColor=new _(.5,.5,.5),this.IT.specularColor=new _(.1,.1,.1),this.mN=t.utilityLayerScene.onPointerObservable.add((t=>{this.JD&&(this.FK=!(!t.pickInfo||-1==this.zK.getChildMeshes().indexOf(t.pickInfo.pickedMesh)),this.FK&&0===t.event.button&&this.onClickedObservable.notifyObservers(this.JD))}),pe.POINTERDOWN)}get displayFrustum(){return this.t5.isEnabled()}set displayFrustum(t){this.t5.setEnabled(t)}set camera(t){if(this.JD=t,this.attachedNode=t,t){this.i5&&this.i5.dispose(),this.t5&&this.t5.dispose(),this.i5=am.e5(this.gizmoLayer.utilityLayerScene),this.t5=am.s5(this.gizmoLayer.utilityLayerScene),this.i5.getChildMeshes(!1).forEach((t=>{t.material=this.IT})),this.i5.parent=this.zK,this.t5.parent=this.zK,this.gizmoLayer.utilityLayerScene.activeCamera&&this.gizmoLayer.utilityLayerScene.activeCamera.maxZ<1.5*t.maxZ&&(this.gizmoLayer.utilityLayerScene.activeCamera.maxZ=1.5*t.maxZ),this.attachedNode.reservedDataStore||(this.attachedNode.reservedDataStore={}),this.attachedNode.reservedDataStore.cameraGizmo=this;const i=this.gizmoLayer.bK();i.includedOnlyMeshes=i.includedOnlyMeshes.concat(this.i5.getChildMeshes(!1)),this.HA()}}get camera(){return this.JD}get material(){return this.IT}HA(){super.HA(),this.JD&&(this.JD.getProjectionMatrix().invertToRef(this.J4),this.t5.setPivotMatrix(this.J4,!1),this.t5.scaling.x=1/this.zK.scaling.x,this.t5.scaling.y=1/this.zK.scaling.y,this.t5.scaling.z=1/this.zK.scaling.z,this.i5.parent=null,this.i5.rotation.y=.5*Math.PI*(this.JD.getScene().useRightHandedSystem?1:-1),this.i5.parent=this.zK)}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this.mN),this.i5&&this.i5.dispose(),this.t5&&this.t5.dispose(),this.IT.dispose(),super.dispose()}static e5(t){const i=new Ys("rootCameraGizmo",t),e=new Ys(i.name,t);e.parent=i;Kc(i.name,{width:1,height:.8,depth:.5},t).parent=e;const s=Cc(i.name,{height:.5,diameterTop:.8,diameterBottom:.8},t);s.parent=e,s.position.y=.3,s.position.x=-.6,s.rotation.x=.5*Math.PI;const n=Cc(i.name,{height:.5,diameterTop:.6,diameterBottom:.6},t);n.parent=e,n.position.y=.5,n.position.x=.4,n.rotation.x=.5*Math.PI;const r=Cc(i.name,{height:.5,diameterTop:.5,diameterBottom:.5},t);return r.parent=e,r.position.y=0,r.position.x=.6,r.rotation.z=.5*Math.PI,i.scaling.scaleInPlace(am.Z4),e.position.x=-.9,i}static s5(t){const i=new Ys("rootCameraGizmo",t),e=new Ys(i.name,t);e.parent=i;for(let i=0;i<4;i+=2)for(let s=0;s<4;s+=2){let n=fu("lines",{points:[new w(-1+s,-1+i,-1),new w(-1+s,-1+i,1)]},t);n.parent=e,n.alwaysSelectAsActiveMesh=!0,n.isPickable=!1,n=fu("lines",{points:[new w(-1,-1+s,-1+i),new w(1,-1+s,-1+i)]},t),n.parent=e,n.alwaysSelectAsActiveMesh=!0,n.isPickable=!1,n=fu("lines",{points:[new w(-1+s,-1,-1+i),new w(-1+s,1,-1+i)]},t),n.parent=e,n.alwaysSelectAsActiveMesh=!0,n.isPickable=!1}return i}}am.Z4=.05;const lm="kernelBlurVaryingDeclaration",cm="varying vec2 sampleCoord{X};";ii.IncludesShadersStore[lm]=cm;const um="packingFunctions",fm="vec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}";ii.IncludesShadersStore[um]=fm;const dm="kernelBlurFragment",pm="#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif\n";ii.IncludesShadersStore[dm]=pm;const mm="kernelBlurFragment2",vm="#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});\ncomputedWeight=KERNEL_DEP_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";ii.IncludesShadersStore[mm]=vm;const gm="kernelBlurPixelShader",Sm="uniform sampler2D textureSampler;\nuniform vec2 delta;\nvarying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;\nfloat sampleCoC(in vec2 offset) {\nfloat coc=texture2D(circleOfConfusionSampler,offset).r;\nreturn coc; \n}\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat computedWeight=0.0;\n#ifdef PACKEDFLOAT\nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}";ii.ShadersStore[gm]=Sm;const Em="kernelBlurVertex",Am="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";ii.IncludesShadersStore[Em]=Am;const Cm="kernelBlurVertexShader",wm="attribute vec2 position;\nuniform vec2 delta;\nvarying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[Cm]=wm;class xm extends nr{constructor(t,i,e,s,n,r=an.BILINEAR_SAMPLINGMODE,h,o,a=0,l="",c=!1,u=5){super(t,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],s,n,r,h,o,null,a,"kernelBlur",{varyingCount:0,depCount:0},!0,u),this.n5=c,this.r5=!1,this.h5="",this.h5=l,this.direction=i,this.onApplyObservable.add((t=>{this.Ef?t.setFloat2("delta",1/this.Ef.width*this.direction.x,1/this.Ef.height*this.direction.y):t.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)})),this.kernel=e}set kernel(t){this.o5!==t&&(t=Math.max(t,1),this.o5=t,this.a5=this.l5(t),this.n5||this._c())}get kernel(){return this.o5}set packedFloat(t){this.r5!==t&&(this.r5=t,this.n5||this._c())}get packedFloat(){return this.r5}getClassName(){return"BlurPostProcess"}updateEffect(t=null,i=null,e=null,s,n,r){this._c(n,r)}_c(t,i){const e=this.a5,s=(e-1)/2;let n=[],r=[],h=0;for(let t=0;t<e;t++){const i=t/(e-1),o=this.c5(2*i-1);n[t]=t-s,r[t]=o,h+=o}for(let t=0;t<r.length;t++)r[t]/=h;const o=[],a=[],l=[];for(let t=0;t<=s;t+=2){const i=Math.min(t+1,Math.floor(s));if(t===i)l.push({o:n[t],w:r[t]});else{const e=i===s,h=r[t]+r[i]*(e?.5:1),o=n[t]+1/(1+r[t]/r[i]);0===o?(l.push({o:n[t],w:r[t]}),l.push({o:n[t+1],w:r[t+1]})):(l.push({o,w:h}),l.push({o:-o,w:h}))}}for(let t=0;t<l.length;t++)a[t]=l[t].o,o[t]=l[t].w;n=a,r=o;const c=this.getEngine().getCaps().maxVaryingVectors,u=Math.max(c,0)-1;let f=Math.min(n.length,u),d="";d+=this.h5,-1!=this.h5.indexOf("DOF")&&(d+=`#define CENTER_WEIGHT ${this.u5(r[f-1])}\r\n`,f--);for(let t=0;t<f;t++)d+=`#define KERNEL_OFFSET${t} ${this.u5(n[t])}\r\n`,d+=`#define KERNEL_WEIGHT${t} ${this.u5(r[t])}\r\n`;let p=0;for(let t=u;t<n.length;t++)d+=`#define KERNEL_DEP_OFFSET${p} ${this.u5(n[t])}\r\n`,d+=`#define KERNEL_DEP_WEIGHT${p} ${this.u5(r[t])}\r\n`,p++;this.packedFloat&&(d+="#define PACKEDFLOAT 1"),this.n5=!1,super.updateEffect(d,null,null,{varyingCount:f,depCount:p},t,i)}l5(t){const i=Math.round(t);for(const t of[i,i-1,i+1,i-2,i+2])if(t%2!=0&&Math.floor(t/2)%2==0&&t>0)return Math.max(t,3);return Math.max(i,3)}c5(t){const i=1/3,e=-t*t/(2*i*i);return 1/(Math.sqrt(2*Math.PI)*i)*Math.exp(e)}u5(t,i=8){return t.toFixed(i).replace(/0+$/,"")}static SL(t,i,e,s){return ot.Parse((()=>new xm(t.name,t.direction,t.kernel,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.reusable,t.textureType,void 0,!1)),t,e,s)}}ut([Q("kernel")],xm.prototype,"_kernel",void 0),ut([Q("packedFloat")],xm.prototype,"_packedFloat",void 0),ut([it()],xm.prototype,"direction",void 0),v("BABYLON.BlurPostProcess",xm);class Tm extends br{constructor(t,i,e,s,n=0,r=an.BILINEAR_SAMPLINGMODE,h=!0){if(super(t,i,e,s,!0,n,!1,r,h),this.mirrorPlane=new Pe(0,1,0,1),this.Ov=R.Zero(),this.f5=R.Zero(),this.d5=0,this.p5=0,this.m5=0,this.v5=1,!(e=this.getScene()))return this;this.ignoreCameraViewport=!0,this.g5(),this.S5=e.imageProcessingConfiguration.onUpdateParameters.add((()=>{this.g5()}));const o=e.getEngine();let a;o.supportsUniformBuffers&&(this.E5=e.createSceneUniformBuffer(`Scene for Mirror Texture (name "${t}")`)),this.onBeforeBindObservable.add((()=>{var i;null===(i=o.NO)||void 0===i||i.call(o,`mirror generation for ${t}`,1)})),this.onAfterUnbindObservable.add((()=>{var t;null===(t=o.PO)||void 0===t||t.call(o,1)})),this.onBeforeRenderObservable.add((()=>{this.E5&&(this.A5=e.getSceneUniformBuffer(),e.setSceneUniformBuffer(this.E5),e.getSceneUniformBuffer().unbindEffect()),R.ReflectionToRef(this.mirrorPlane,this.f5),this.f5.multiplyToRef(e.getViewMatrix(),this.Ov),e.setTransformMatrix(this.Ov,e.getProjectionMatrix()),a=e.clipPlane,e.clipPlane=this.mirrorPlane,e.Ag=w.TransformCoordinates(e.activeCamera.globalPosition,this.f5)})),this.onAfterRenderObservable.add((()=>{this.E5&&e.setSceneUniformBuffer(this.A5),e.updateTransformMatrix(),e.Ag=null,e.clipPlane=a}))}set blurRatio(t){this.v5!==t&&(this.v5=t,this.C5())}get blurRatio(){return this.v5}set adaptiveBlurKernel(t){this.d5=t,this.w5()}set blurKernel(t){this.blurKernelX=t,this.blurKernelY=t}set blurKernelX(t){this.p5!==t&&(this.p5=t,this.C5())}get blurKernelX(){return this.p5}set blurKernelY(t){this.m5!==t&&(this.m5=t,this.C5())}get blurKernelY(){return this.m5}w5(){const t=this.getScene().getEngine(),i=this.getRenderWidth()/t.getRenderWidth(),e=this.getRenderHeight()/t.getRenderHeight();this.blurKernelX=this.d5*i,this.blurKernelY=this.d5*e}EO(){this.AO&&(this.resize(this.hO),this.d5||this.C5()),this.d5&&this.w5()}g5(){const t=this.getScene();t&&(this.gammaSpace=!t.imageProcessingConfiguration.isEnabled||!t.imageProcessingConfiguration.applyByPostProcess)}C5(){if(this.clearPostProcesses(!0),this.p5&&this.m5){const t=this.getScene().getEngine(),i=t.getCaps().textureFloatRender&&t.getCaps().textureFloatLinearFiltering?1:2;this.x5=new xm("horizontal blur",new C(1,0),this.p5,this.v5,null,an.BILINEAR_SAMPLINGMODE,t,!1,i),this.x5.autoClear=!1,1===this.v5&&this.samples<2&&this.Lb?this.x5.inputTexture=this.rO:this.x5.alwaysForcePOT=!0,this.T5=new xm("vertical blur",new C(0,1),this.m5,this.v5,null,an.BILINEAR_SAMPLINGMODE,t,!1,i),this.T5.autoClear=!1,this.T5.alwaysForcePOT=1!==this.v5,this.addPostProcess(this.x5),this.addPostProcess(this.T5)}else this.T5&&(this.removePostProcess(this.T5),this.T5.dispose(),this.T5=null),this.x5&&(this.removePostProcess(this.x5),this.x5.dispose(),this.x5=null)}clone(){const t=this.getScene();if(!t)return this;const i=this.getSize(),e=new Tm(this.name,i.width,t,this.dO.generateMipMaps,this.dO.type,this.dO.samplingMode,this.dO.generateDepthBuffer);return e.hasAlpha=this.hasAlpha,e.level=this.level,e.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(e.renderList=this.renderList.slice(0)),e}serialize(){if(!this.name)return null;const t=super.serialize();return t.mirrorPlane=this.mirrorPlane.asArray(),t}dispose(){var t;super.dispose();const i=this.getScene();i&&i.imageProcessingConfiguration.onUpdateParameters.remove(this.S5),null===(t=this.E5)||void 0===t||t.dispose()}}an.B_=(t,i,e,s)=>new Tm(t,i,e,s);class Rm extends nn{constructor(t,i,e=null,s=!1,n=null,r=null,o=null,a=5,l=!1,c=null,u=!1,f=.8,d=0,p,m){var v;super(i),this.R5=.8,this.I5=0,this.onLoadObservable=new h,this.boundingBoxPosition=w.Zero(),this.M5=0,this.Jn=null,this.P_=null,this.b5=null,this.name=t,this.url=t,this.Jb=s,this.hasAlpha=!1,this.R_=a,this.isCube=!0,this.pO=R.Identity(),this._5=u,this.coordinatesMode=an.CUBIC_MODE,this.b5=e,this.Jn=n,this.P_=c,this.y_=p,this.ur=m,this.R5=f,this.I5=d,(t||n)&&this.updateURL(t,c,r,l,o,e,null===(v=this.getScene())||void 0===v?void 0:v.useDelayedTextureLoading,n)}set boundingBoxSize(t){if(this.CO&&this.CO.equals(t))return;this.CO=t;const i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this.CO}set rotationY(t){this.M5=t,this.setReflectionTextureMatrix(R.RotationY(this.M5))}get rotationY(){return this.M5}get noMipmap(){return this.Jb}get forcedExtension(){return this.P_}static CreateFromImages(t,i,e){let s="";return t.forEach((t=>s+=t)),new Rm(s,i,null,e,t)}static CreateFromPrefilteredData(t,i,e=null,s=!0){const n=i.useDelayedTextureLoading;i.useDelayedTextureLoading=!1;const r=new Rm(t,i,null,!1,null,null,null,void 0,!0,e,s);return i.useDelayedTextureLoading=n,r}getClassName(){return"CubeTexture"}updateURL(t,i,e=null,s=!1,n=null,r=null,h=!1,o=null){this.name&&!this.name.startsWith("data:")||(this.name=t),this.url=t,i&&(this.P_=i);const a=t.lastIndexOf("."),l=i||(a>-1?t.substring(a).toLowerCase():""),c=0===l.indexOf(".dds"),u=0===l.indexOf(".env"),f=0===l.indexOf(".basis");if(u?(this.gammaSpace=!1,this.Wb=!1,this.anisotropicFilteringLevel=1):(this.Wb=s,s&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),o)this.Jn=o;else if(f||u||c||r||(r=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this.Jn=this.Jn||[],this.Jn.length=0,r){for(let i=0;i<r.length;i++)this.Jn.push(t+r[i]);this.b5=r}h?(this.delayLoadState=4,this.I_=e,this.M_=n):this.y5(e,n)}delayLoad(t){4===this.delayLoadState&&(t&&(this.P_=t),this.delayLoadState=1,this.y5(this.I_,this.M_))}getReflectionTextureMatrix(){return this.pO}setReflectionTextureMatrix(t){var i;t.updateFlag!==this.pO.updateFlag&&(t.isIdentity()!==this.pO.isIdentity()&&(null===(i=this.getScene())||void 0===i||i.markAllMaterialsAsDirty(1,(t=>-1!==t.getActiveTextures().indexOf(this)))),this.pO=t)}y5(t=null,i=null){var e;const s=this.getScene(),n=this.Lb;this.Lb=this.Qb(this.url,this.Jb,void 0,void 0,this.ur,this.isCube);const r=()=>{var i;this.onLoadObservable.notifyObservers(this),n&&(n.dispose(),null===(i=this.getScene())||void 0===i||i.markAllMaterialsAsDirty(1)),t&&t()},h=(t,e)=>{this.Yb=!0,this.Kb={message:t,exception:e},i&&i(t,e),an.OnTextureLoadErrorObservable.notifyObservers(this)};this.Lb?this.Lb.isReady?ki.SetImmediate((()=>r())):this.Lb.onLoadedObservable.add((()=>r())):(this.Wb?this.Lb=this.qb().createPrefilteredCubeTexture(this.url,s,this.R5,this.I5,t,h,this.R_,this.P_,this._5):this.Lb=this.qb().createCubeTexture(this.url,s,this.Jn,this.Jb,t,h,this.R_,this.P_,!1,this.R5,this.I5,null,this.y_,!!this.ur),null===(e=this.Lb)||void 0===e||e.onLoadedObservable.add((()=>this.onLoadObservable.notifyObservers(this))))}static Parse(t,i,e){const s=ot.Parse((()=>{let s=!1;return t.prefiltered&&(s=t.prefiltered),new Rm(e+t.name,i,t.extensions,!1,t.files||null,null,null,void 0,s,t.forcedExtension)}),t,i);if(t.boundingBoxPosition&&(s.boundingBoxPosition=w.FromArray(t.boundingBoxPosition)),t.boundingBoxSize&&(s.boundingBoxSize=w.FromArray(t.boundingBoxSize)),t.animations)for(let i=0;i<t.animations.length;i++){const e=t.animations[i],n=g("BABYLON.Animation");n&&s.animations.push(n.Parse(e))}return s}clone(){let t=0;const i=ot.Clone((()=>{const i=new Rm(this.url,this.getScene()||this.qb(),this.b5,this.Jb,this.Jn);return t=i.uniqueId,i}),this);return i.uniqueId=t,i}}ut([Q()],Rm.prototype,"url",void 0),ut([Q("rotationY")],Rm.prototype,"rotationY",null),ut([Q("files")],Rm.prototype,"_files",void 0),ut([Q("forcedExtension")],Rm.prototype,"_forcedExtension",void 0),ut([Q("extensions")],Rm.prototype,"_extensions",void 0),ut([ht("textureMatrix")],Rm.prototype,"_textureMatrix",void 0),an.F_=Rm.Parse,v("BABYLON.CubeTexture",Rm);const Im="backgroundFragmentDeclaration",Mm="uniform vec4 vEyePosition;\nuniform vec4 vPrimaryColor;\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nuniform vec4 vPrimaryColorShadow;\n#endif\nuniform float shadowLevel;\nuniform float alpha;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n";ii.IncludesShadersStore[Im]=Mm;const bm="backgroundUboDeclaration",_m="layout(std140,column_major) uniform;\nuniform Material\n{\nuniform vec4 vPrimaryColor;\nuniform vec4 vPrimaryColorShadow;\nuniform vec2 vDiffuseInfos;\nuniform vec2 vReflectionInfos;\nuniform mat4 diffuseMatrix;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform float fFovMultiplier;\nuniform float pointSize;\nuniform float shadowLevel;\nuniform float alpha;\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n};\n#include<sceneUboDeclaration>\n";ii.IncludesShadersStore[bm]=_m;const ym="backgroundPixelShader",Nm="#ifdef TEXTURELODSUPPORT\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nprecision highp float;\n#include<__decl__backgroundFragment>\n#include<helperFunctions>\n#define RECIPROCAL_PI2 0.15915494\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2; \n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV==1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV==2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));\n}\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(0.0,1.0,0.0);\n#endif\nfloat shadow=1.;\nfloat globalShadow=0.;\nfloat shadowLightCount=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n#ifndef BACKMAT_SHADOWONLY\nvec4 reflectionColor=vec4(1.,1.,1.,1.);\n#ifdef REFLECTION\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nfloat reflectionLOD=vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\nreflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD);\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);\nif(lodReflectionNormalizedDoubled<1.0){\nreflectionColor=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);\n} else {\nreflectionColor=mix(\nreflectionSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#else\nvec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);\nreflectionColor=reflectionSample;\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor.rgb=toLinearSpace(reflectionColor.rgb);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor.rgb=reflectionColor.bgr;\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#endif\nvec3 diffuseColor=vec3(1.,1.,1.);\nfloat finalAlpha=alpha;\n#ifdef DIFFUSE\nvec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap.rgb=toLinearSpace(diffuseMap.rgb);\n#endif\ndiffuseMap.rgb*=vDiffuseInfos.y;\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 colorBase=diffuseColor;\n#else\nvec3 colorBase=reflectionColor.rgb*diffuseColor;\n#endif\ncolorBase=max(colorBase,0.0);\n#ifdef USERGBCOLOR\nvec3 finalColor=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);\n#else\nvec3 mainColor=vPrimaryColor.rgb;\n#endif\nvec3 finalColor=colorBase*mainColor;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 reflectionAmount=vReflectionControl.xxx;\nvec3 reflectionReflectance0=vReflectionControl.yyy;\nvec3 reflectionReflectance90=vReflectionControl.zzz;\nfloat VdotN=dot(normalize(vEyePosition.xyz),normalW);\nvec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);\nreflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nfloat reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);\nreflectionDistanceFalloff*=reflectionDistanceFalloff;\nreflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));\n#endif\n#ifdef OPACITYFRESNEL\nfloat viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));\nconst float startAngle=0.1;\nfloat fadeFactor=saturate(viewAngleToFloor/startAngle);\nfinalAlpha*=fadeFactor*fadeFactor;\n#endif\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);\n#endif\nvec4 color=vec4(finalColor,finalAlpha);\n#else\nvec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);\n#endif\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n#if !defined(SKIPFINALCOLORCLAMP)\ncolor.rgb=clamp(color.rgb,0.,30.0);\n#endif\n#else\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#ifdef NOISE\ncolor.rgb+=dither(vPositionW.xy,0.5);\ncolor=max(color,0.0);\n#endif\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";ii.ShadersStore[ym]=Nm;const Pm="backgroundVertexDeclaration",Dm="uniform mat4 view;\nuniform mat4 viewProjection;\nuniform float shadowLevel;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform float fFovMultiplier;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n";ii.IncludesShadersStore[Pm]=Dm;const Lm="backgroundVertexShader",Om="precision highp float;\n#include<__decl__backgroundVertex>\n#include<helperFunctions>\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nvarying vec2 vDiffuseUV;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n} else {\ngl_Position=viewProjectionR*finalWorld*vec4(position,1.0);\n}\n#else\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#endif\nvec4 worldPos=finalWorld*vec4(position,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nmat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));\nvec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));\nif (fFovMultiplier<=1.0) {\nvDirectionW=normalize(segment);\n} else {\nvDirectionW=normalize(vDirectionW+(vDirectionW-segment));\n}\n#endif\n#endif\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nif (vDiffuseInfos.x==0.)\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n";ii.ShadersStore[Lm]=Om;class Fm extends Wi{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class Bm extends Fn{constructor(t,i){super(t,i),this.primaryColor=_.White(),this.N5=0,this.P5=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this.D5=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=w.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this.L5=1,this.useEquirectangularFOV=!1,this.MW=4,this.maxSimultaneousLights=4,this.O5=!1,this.shadowOnly=!1,this.uF=null,this.switchToBGR=!1,this._v=new zi(16),this.F5=x.Zero(),this.B5=_.White(),this.U5=_.Black(),this.V5=_.Black(),this.$L(null),this.getRenderTargetTextures=()=>(this._v.reset(),this.nW&&this.nW.isRenderTarget&&this._v.push(this.nW),this.oW&&this.oW.isRenderTarget&&this._v.push(this.oW),this._v)}get k5(){return this.G5}set k5(t){this.G5=t,this.z5(),this.VR()}get primaryColorShadowLevel(){return this.N5}set primaryColorShadowLevel(t){this.N5=t,this.H5(),this.VR()}get primaryColorHighlightLevel(){return this.P5}set primaryColorHighlightLevel(t){this.P5=t,this.H5(),this.VR()}set reflectionStandardFresnelWeight(t){let i=t;i<.5?(i*=2,this.reflectionReflectance0=Bm.StandardReflectance0*i,this.reflectionReflectance90=Bm.StandardReflectance90*i):(i=2*i-1,this.reflectionReflectance0=Bm.StandardReflectance0+(1-Bm.StandardReflectance0)*i,this.reflectionReflectance90=Bm.StandardReflectance90+(1-Bm.StandardReflectance90)*i)}get fovMultiplier(){return this.L5}set fovMultiplier(t){isNaN(t)&&(t=1),this.L5=Math.max(0,Math.min(2,t))}$L(t){t!==this.Sg&&(this.Sg&&this.uF&&this.Sg.onUpdateParameters.remove(this.uF),this.Sg=t||this.getScene().imageProcessingConfiguration,this.Sg&&(this.uF=this.Sg.onUpdateParameters.add((()=>{this.z5(),this.fI()}))))}get imageProcessingConfiguration(){return this.Sg}set imageProcessingConfiguration(t){this.$L(t),this.UR()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(t){this.imageProcessingConfiguration.colorCurvesEnabled=t}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(t){this.imageProcessingConfiguration.colorGradingEnabled=t}get cameraToneMappingEnabled(){return this.Sg.toneMappingEnabled}set cameraToneMappingEnabled(t){this.Sg.toneMappingEnabled=t}get cameraExposure(){return this.Sg.exposure}set cameraExposure(t){this.Sg.exposure=t}get cameraContrast(){return this.Sg.contrast}set cameraContrast(t){this.Sg.contrast=t}get cameraColorGradingTexture(){return this.Sg.colorGradingTexture}set cameraColorGradingTexture(t){this.imageProcessingConfiguration.colorGradingTexture=t}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(t){this.imageProcessingConfiguration.colorCurves=t}get hasRenderTargetTextures(){return!(!this.nW||!this.nW.isRenderTarget)||!(!this.oW||!this.oW.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||null!=this.nW&&this.nW.hasAlpha||this.O5}isReadyForSubMesh(t,i,e=!1){if(i.effect&&this.isFrozen&&i.effect.cs&&i.effect.fs===e)return!0;i.materialDefines||(i.materialDefines=new Fm);const s=this.getScene(),n=i.materialDefines;if(this.oP(i))return!0;const r=s.getEngine();if(Fs.PrepareDefinesForLights(s,t,n,!1,this.MW),n.Fl=!0,Fs.PrepareDefinesForMultiview(s,n),n._l){if(n.Bl=!1,s.texturesEnabled){if(s.getEngine().getCaps().textureLOD&&(n.TEXTURELODSUPPORT=!0),this.nW&&Bo.DiffuseTextureEnabled){if(!this.nW.isReadyOrNotBlocking())return!1;Fs.PrepareDefinesForMergedUV(this.nW,n,"DIFFUSE"),n.DIFFUSEHASALPHA=this.nW.hasAlpha,n.GAMMADIFFUSE=this.nW.gammaSpace,n.OPACITYFRESNEL=this.X5}else n.DIFFUSE=!1,n.DIFFUSEDIRECTUV=0,n.DIFFUSEHASALPHA=!1,n.GAMMADIFFUSE=!1,n.OPACITYFRESNEL=!1;const t=this.oW;if(t&&Bo.ReflectionTextureEnabled){if(!t.isReadyOrNotBlocking())return!1;switch(n.REFLECTION=!0,n.GAMMAREFLECTION=t.gammaSpace,n.RGBDREFLECTION=t.isRGBD,n.REFLECTIONBLUR=this.W5>0,n.LODINREFLECTIONALPHA=t.lodLevelInAlpha,n.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,n.REFLECTIONBGR=this.switchToBGR,t.coordinatesMode===an.INVCUBIC_MODE&&(n.INVERTCUBICMAP=!0),n.REFLECTIONMAP_3D=t.isCube,n.REFLECTIONMAP_OPPOSITEZ=n.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!t.invertZ:t.invertZ,t.coordinatesMode){case an.EXPLICIT_MODE:n.REFLECTIONMAP_EXPLICIT=!0;break;case an.PLANAR_MODE:n.REFLECTIONMAP_PLANAR=!0;break;case an.PROJECTION_MODE:n.REFLECTIONMAP_PROJECTION=!0;break;case an.SKYBOX_MODE:n.REFLECTIONMAP_SKYBOX=!0;break;case an.SPHERICAL_MODE:n.REFLECTIONMAP_SPHERICAL=!0;break;case an.EQUIRECTANGULAR_MODE:n.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case an.FIXED_EQUIRECTANGULAR_MODE:n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case an.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case an.CUBIC_MODE:case an.INVCUBIC_MODE:default:n.REFLECTIONMAP_CUBIC=!0}this.reflectionFresnel?(n.REFLECTIONFRESNEL=!0,n.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this.F5.x=this.reflectionAmount,this.F5.y=this.reflectionReflectance0,this.F5.z=this.reflectionReflectance90,this.F5.w=1/this.reflectionFalloffDistance):(n.REFLECTIONFRESNEL=!1,n.REFLECTIONFALLOFF=!1)}else n.REFLECTION=!1,n.REFLECTIONFRESNEL=!1,n.REFLECTIONFALLOFF=!1,n.REFLECTIONBLUR=!1,n.REFLECTIONMAP_3D=!1,n.REFLECTIONMAP_SPHERICAL=!1,n.REFLECTIONMAP_PLANAR=!1,n.REFLECTIONMAP_CUBIC=!1,n.REFLECTIONMAP_PROJECTION=!1,n.REFLECTIONMAP_SKYBOX=!1,n.REFLECTIONMAP_EXPLICIT=!1,n.REFLECTIONMAP_EQUIRECTANGULAR=!1,n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,n.INVERTCUBICMAP=!1,n.REFLECTIONMAP_OPPOSITEZ=!1,n.LODINREFLECTIONALPHA=!1,n.GAMMAREFLECTION=!1,n.RGBDREFLECTION=!1}n.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,n.USERGBCOLOR=this.Y5,n.NOISE=this.j5}if(n.Il&&(n.USEHIGHLIGHTANDSHADOWCOLORS=!this.Y5&&(0!==this.N5||0!==this.P5),n.BACKMAT_SHADOWONLY=this.O5),n.Dl&&this.Sg){if(!this.Sg.isReady())return!1;this.Sg.prepareDefines(n)}if(Fs.PrepareDefinesForMisc(t,s,!1,this.pointsCloud,this.fogEnabled,this.qR(t),n),Fs.PrepareDefinesForFrameBoundValues(s,r,this,n,e,null,i.getRenderingMesh().hasThinInstances),Fs.PrepareDefinesForAttributes(t,n,!1,!0,!1)&&t&&(s.getEngine().getCaps().standardDerivatives||t.isVerticesDataPresent(he.NormalKind)||(t.createNormals(!0),F.Warn("BackgroundMaterial: Normals have been created for the mesh: "+t.name))),n.isDirty){n.markAsProcessed(),s.resetCachedMaterial();const e=new Jn;n.FOG&&e.addFallback(0,"FOG"),n.POINTSIZE&&e.addFallback(1,"POINTSIZE"),n.MULTIVIEW&&e.addFallback(0,"MULTIVIEW"),Fs.HandleFallbacksForShadows(n,e,this.MW);const h=[he.PositionKind];n.NORMAL&&h.push(he.NormalKind),n.UV1&&h.push(he.UVKind),n.UV2&&h.push(he.UV2Kind),Fs.PrepareAttributesForBones(h,t,n,e),Fs.PrepareAttributesForInstances(h,n);const o=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix"];Ns(o);const a=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],l=["Material","Scene"];ji&&(ji.PrepareUniforms(o,n),ji.PrepareSamplers(a,n)),Fs.PrepareUniformsAndSamplersList({uniformsNames:o,uniformBuffersNames:l,samplers:a,defines:n,maxSimultaneousLights:this.MW});const c=n.toString(),u=s.getEngine().createEffect("background",{attributes:h,uniformsNames:o,uniformBuffersNames:l,samplers:a,defines:c,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.MW}},r);i.setEffect(u,n,this.WR),this.buildUniformLayout()}return!(!i.effect||!i.effect.isReady())&&(n.Sv=s.getRenderId(),i.effect.cs=!0,i.effect.fs=e,s.performancePriority!==Fe.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}z5(){this.G5&&(this.K5.copyFrom(this.G5),this.K5.toLinearSpaceToRef(this.K5),this.Sg&&this.K5.scaleToRef(1/this.Sg.exposure,this.K5),this.H5())}H5(){0===this.N5&&0===this.P5||(this.K5.scaleToRef(this.N5,this.U5),this.K5.subtractToRef(this.U5,this.U5),this.B5.subtractToRef(this.K5,this.V5),this.V5.scaleToRef(this.P5,this.V5),this.K5.addToRef(this.V5,this.V5))}buildUniformLayout(){this.VT.addUniform("vPrimaryColor",4),this.VT.addUniform("vPrimaryColorShadow",4),this.VT.addUniform("vDiffuseInfos",2),this.VT.addUniform("vReflectionInfos",2),this.VT.addUniform("diffuseMatrix",16),this.VT.addUniform("reflectionMatrix",16),this.VT.addUniform("vReflectionMicrosurfaceInfos",3),this.VT.addUniform("fFovMultiplier",1),this.VT.addUniform("pointSize",1),this.VT.addUniform("shadowLevel",1),this.VT.addUniform("alpha",1),this.VT.addUniform("vBackgroundCenter",3),this.VT.addUniform("vReflectionControl",4),this.VT.create()}unbind(){this.nW&&this.nW.isRenderTarget&&this.VT.setTexture("diffuseSampler",null),this.oW&&this.oW.isRenderTarget&&this.VT.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(t){this.hP.setMatrix("world",t)}bindForSubMesh(t,i,e){const s=this.getScene(),n=e.materialDefines;if(!n)return;const r=e.effect;if(!r)return;this.hP=r,this.bindOnlyWorldMatrix(t),Fs.BindBonesParameters(i,this.hP);const h=this.aP(s,r,i.visibility);if(h){this.VT.bindToEffect(r,"Material"),this.bindViewProjection(r);const t=this.oW;this.VT.useUbo&&this.isFrozen&&this.VT.isSync||(s.texturesEnabled&&(this.nW&&Bo.DiffuseTextureEnabled&&(this.VT.updateFloat2("vDiffuseInfos",this.nW.coordinatesIndex,this.nW.level),Fs.BindTextureMatrix(this.nW,this.VT,"diffuse")),t&&Bo.ReflectionTextureEnabled&&(this.VT.updateMatrix("reflectionMatrix",t.getReflectionTextureMatrix()),this.VT.updateFloat2("vReflectionInfos",t.level,this.W5),this.VT.updateFloat3("vReflectionMicrosurfaceInfos",t.getSize().width,t.lodGenerationScale,t.lodGenerationOffset))),this.shadowLevel>0&&this.VT.updateFloat("shadowLevel",this.shadowLevel),this.VT.updateFloat("alpha",this.alpha),this.pointsCloud&&this.VT.updateFloat("pointSize",this.pointSize),n.USEHIGHLIGHTANDSHADOWCOLORS?(this.VT.updateColor4("vPrimaryColor",this.V5,1),this.VT.updateColor4("vPrimaryColorShadow",this.U5,1)):this.VT.updateColor4("vPrimaryColor",this.K5,1)),this.VT.updateFloat("fFovMultiplier",this.L5),s.texturesEnabled&&(this.nW&&Bo.DiffuseTextureEnabled&&this.VT.setTexture("diffuseSampler",this.nW),t&&Bo.ReflectionTextureEnabled&&(n.REFLECTIONBLUR&&n.TEXTURELODSUPPORT?this.VT.setTexture("reflectionSampler",t):n.REFLECTIONBLUR?(this.VT.setTexture("reflectionSampler",t.pr||t),this.VT.setTexture("reflectionSamplerLow",t.mr||t),this.VT.setTexture("reflectionSamplerHigh",t.dr||t)):this.VT.setTexture("reflectionSampler",t),n.REFLECTIONFRESNEL&&(this.VT.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this.VT.updateFloat4("vReflectionControl",this.F5.x,this.F5.y,this.F5.z,this.F5.w)))),Ds(this.hP,this,s),s.bindEyePosition(r)}else s.getEngine().hs.needToAlwaysBindUniformBuffers&&(this.VT.bindToEffect(r,"Material"),this.JR=!0);!h&&this.isFrozen||(s.lightsEnabled&&Fs.BindLights(s,i,this.hP,n,this.MW),this.bindView(r),Fs.BindFogParameters(s,i,this.hP,!0),this.Sg&&this.Sg.bind(this.hP)),this.tI(i,this.hP),this.VT.update()}hasTexture(t){return!!super.hasTexture(t)||(this.oW===t||this.nW===t)}dispose(t=!1,i=!1){i&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._v.dispose(),this.Sg&&this.uF&&this.Sg.onUpdateParameters.remove(this.uF),super.dispose(t)}clone(t){return ot.Clone((()=>new Bm(t,this.getScene())),this)}serialize(){const t=super.serialize();return t.customType="BABYLON.BackgroundMaterial",t}getClassName(){return"BackgroundMaterial"}static Parse(t,i,e){return ot.Parse((()=>new Bm(t.name,i)),t,i,e)}}Bm.StandardReflectance0=.05,Bm.StandardReflectance90=.5,ut([J()],Bm.prototype,"_primaryColor",void 0),ut([q("_markAllSubMeshesAsLightsDirty")],Bm.prototype,"primaryColor",void 0),ut([J()],Bm.prototype,"__perceptualColor",void 0),ut([Q()],Bm.prototype,"_primaryColorShadowLevel",void 0),ut([Q()],Bm.prototype,"_primaryColorHighlightLevel",void 0),ut([q("_markAllSubMeshesAsLightsDirty")],Bm.prototype,"primaryColorHighlightLevel",null),ut([Z()],Bm.prototype,"_reflectionTexture",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"reflectionTexture",void 0),ut([Q()],Bm.prototype,"_reflectionBlur",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"reflectionBlur",void 0),ut([Z()],Bm.prototype,"_diffuseTexture",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"diffuseTexture",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"shadowLights",void 0),ut([Q()],Bm.prototype,"_shadowLevel",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"shadowLevel",void 0),ut([et()],Bm.prototype,"_sceneCenter",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"sceneCenter",void 0),ut([Q()],Bm.prototype,"_opacityFresnel",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"opacityFresnel",void 0),ut([Q()],Bm.prototype,"_reflectionFresnel",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"reflectionFresnel",void 0),ut([Q()],Bm.prototype,"_reflectionFalloffDistance",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"reflectionFalloffDistance",void 0),ut([Q()],Bm.prototype,"_reflectionAmount",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"reflectionAmount",void 0),ut([Q()],Bm.prototype,"_reflectionReflectance0",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"reflectionReflectance0",void 0),ut([Q()],Bm.prototype,"_reflectionReflectance90",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"reflectionReflectance90",void 0),ut([Q()],Bm.prototype,"_useRGBColor",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"useRGBColor",void 0),ut([Q()],Bm.prototype,"_enableNoise",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"enableNoise",void 0),ut([Q()],Bm.prototype,"_maxSimultaneousLights",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Bm.prototype,"maxSimultaneousLights",void 0),ut([Q()],Bm.prototype,"_shadowOnly",void 0),ut([q("_markAllSubMeshesAsLightsDirty")],Bm.prototype,"shadowOnly",void 0),ut([rt()],Bm.prototype,"_imageProcessingConfiguration",void 0),v("BABYLON.BackgroundMaterial",Bm);class Um{constructor(t,i){this.q5=(t,i)=>{this.onErrorObservable.notifyObservers({message:t,exception:i})},this.wb={...Um.WV(),...t},this.Kt=i,this.onErrorObservable=new h,this.Q5(),this.Z5()}static WV(){return{createGround:!0,groundSize:15,groundTexture:this.J5,groundColor:new _(.2,.2,.3).toLinearSpace().scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this.t6,skyboxColor:new _(.2,.2,.3).toLinearSpace().scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:w.Zero(),setupImageProcessing:!0,environmentTexture:this.i6,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this.zK}get skybox(){return this.e6}get skyboxTexture(){return this.s6}get skyboxMaterial(){return this.n6}get ground(){return this.r6}get groundTexture(){return this.h6}get groundMirror(){return this.o6}get groundMirrorRenderList(){return this.o6?this.o6.renderList:null}get groundMaterial(){return this.a6}updateOptions(t){const i={...this.wb,...t};this.r6&&!i.createGround&&(this.r6.dispose(),this.r6=null),this.a6&&!i.createGround&&(this.a6.dispose(),this.a6=null),this.h6&&this.wb.groundTexture!=i.groundTexture&&(this.h6.dispose(),this.h6=null),this.e6&&!i.createSkybox&&(this.e6.dispose(),this.e6=null),this.n6&&!i.createSkybox&&(this.n6.dispose(),this.n6=null),this.s6&&this.wb.skyboxTexture!=i.skyboxTexture&&(this.s6.dispose(),this.s6=null),this.o6&&!i.enableGroundMirror&&(this.o6.dispose(),this.o6=null),this.Kt.environmentTexture&&this.wb.environmentTexture!=i.environmentTexture&&this.Kt.environmentTexture.dispose(),this.wb=i,this.Q5(),this.Z5()}setMainColor(t){this.groundMaterial&&(this.groundMaterial.primaryColor=t),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=t),this.groundMirror&&(this.groundMirror.clearColor=new y(t.r,t.g,t.b,1))}Z5(){this.wb.setupImageProcessing&&(this.Kt.imageProcessingConfiguration.contrast=this.wb.cameraContrast,this.Kt.imageProcessingConfiguration.exposure=this.wb.cameraExposure,this.Kt.imageProcessingConfiguration.toneMappingEnabled=this.wb.toneMappingEnabled,this.l6())}l6(){if(this.Kt.environmentTexture)return;if(this.wb.environmentTexture instanceof nn)return void(this.Kt.environmentTexture=this.wb.environmentTexture);const t=Rm.CreateFromPrefilteredData(this.wb.environmentTexture,this.Kt);this.Kt.environmentTexture=t}Q5(){this.zK||(this.zK=new Ys("BackgroundHelper",this.Kt)),this.zK.rotation.y=this.wb.backgroundYRotation;const t=this.c6();this.wb.createGround&&(this.u6(t),this.f6(),this.d6(),this.wb.enableGroundMirror&&this.p6(t),this.m6()),this.wb.createSkybox&&(this.v6(t),this.g6(),this.S6()),this.zK.position.x=t.rootPosition.x,this.zK.position.z=t.rootPosition.z,this.zK.position.y=t.rootPosition.y}c6(){let t=this.wb.groundSize,i=this.wb.skyboxSize,e=this.wb.rootPosition;if(!this.Kt.meshes||1===this.Kt.meshes.length)return{groundSize:t,skyboxSize:i,rootPosition:e};const s=this.Kt.getWorldExtends((t=>t!==this.r6&&t!==this.zK&&t!==this.e6)),n=s.max.subtract(s.min);if(this.wb.sizeAuto){this.Kt.activeCamera instanceof Oh&&this.Kt.activeCamera.upperRadiusLimit&&(t=2*this.Kt.activeCamera.upperRadiusLimit,i=t);const r=n.length();r>t&&(t=2*r,i=t),t*=1.1,i*=1.5,e=s.min.add(n.scale(.5)),e.y=s.min.y-this.wb.groundYBias}return{groundSize:t,skyboxSize:i,rootPosition:e}}u6(t){this.r6&&!this.r6.isDisposed()||(this.r6=En("BackgroundPlane",{size:t.groundSize},this.Kt),this.r6.rotation.x=Math.PI/2,this.r6.parent=this.zK,this.r6.onDisposeObservable.add((()=>{this.r6=null}))),this.r6.receiveShadows=this.wb.enableGroundShadow}f6(){this.a6||(this.a6=new Bm("BackgroundPlaneMaterial",this.Kt)),this.a6.alpha=this.wb.groundOpacity,this.a6.alphaMode=8,this.a6.shadowLevel=this.wb.groundShadowLevel,this.a6.primaryColor=this.wb.groundColor,this.a6.useRGBColor=!1,this.a6.enableNoise=!0,this.r6&&(this.r6.material=this.a6)}d6(){this.a6&&(this.h6||(this.wb.groundTexture instanceof nn?this.a6.diffuseTexture=this.wb.groundTexture:(this.h6=new an(this.wb.groundTexture,this.Kt,void 0,void 0,void 0,void 0,this.q5),this.h6.gammaSpace=!1,this.h6.hasAlpha=!0,this.a6.diffuseTexture=this.h6)))}p6(t){const i=an.CLAMP_ADDRESSMODE;if(!this.o6&&(this.o6=new Tm("BackgroundPlaneMirrorTexture",{ratio:this.wb.groundMirrorSizeRatio},this.Kt,!1,this.wb.groundMirrorTextureType,an.BILINEAR_SAMPLINGMODE,!0),this.o6.mirrorPlane=new Pe(0,-1,0,t.rootPosition.y),this.o6.anisotropicFilteringLevel=1,this.o6.wrapU=i,this.o6.wrapV=i,this.o6.renderList))for(let t=0;t<this.Kt.meshes.length;t++){const i=this.Kt.meshes[t];i!==this.r6&&i!==this.e6&&i!==this.zK&&this.o6.renderList.push(i)}const e=this.wb.groundColor.toGammaSpace();this.o6.clearColor=new y(e.r,e.g,e.b,1),this.o6.adaptiveBlurKernel=this.wb.groundMirrorBlurKernel}m6(){this.a6&&(this.a6.reflectionTexture=this.o6,this.a6.reflectionFresnel=!0,this.a6.reflectionAmount=this.wb.groundMirrorAmount,this.a6.reflectionStandardFresnelWeight=this.wb.groundMirrorFresnelWeight,this.a6.reflectionFalloffDistance=this.wb.groundMirrorFallOffDistance)}v6(t){this.e6&&!this.e6.isDisposed()||(this.e6=Kc("BackgroundSkybox",{size:t.skyboxSize,sideOrientation:Ys.BACKSIDE},this.Kt),this.e6.onDisposeObservable.add((()=>{this.e6=null}))),this.e6.parent=this.zK}g6(){this.e6&&(this.n6||(this.n6=new Bm("BackgroundSkyboxMaterial",this.Kt)),this.n6.useRGBColor=!1,this.n6.primaryColor=this.wb.skyboxColor,this.n6.enableNoise=!0,this.e6.material=this.n6)}S6(){this.n6&&(this.s6||(this.wb.skyboxTexture instanceof nn?this.n6.reflectionTexture=this.wb.skyboxTexture:(this.s6=new Rm(this.wb.skyboxTexture,this.Kt,void 0,void 0,void 0,void 0,this.q5),this.s6.coordinatesMode=an.SKYBOX_MODE,this.s6.gammaSpace=!1,this.n6.reflectionTexture=this.s6)))}dispose(){this.a6&&this.a6.dispose(!0,!0),this.n6&&this.n6.dispose(!0,!0),this.zK.dispose(!1)}}Um.J5="https://assets.babylonjs.com/environments/backgroundGround.png",Um.t6="https://assets.babylonjs.com/environments/backgroundSkybox.dds",Um.i6="https://assets.babylonjs.com/environments/environmentSpecular.env";class Vm extends Is{constructor(t,i,e,s,n=null){super(t,s),this.onError=n,this.E6=!1,this.A6=!1,this.C6=!1,this.w6=Vm.MODE_MONOSCOPIC,this.Zm=null,this.onLoadErrorObservable=new h,this.onLoadObservable=new h,s=this.getScene(),t=t||"textureDome",e.resolution=0|Math.abs(e.resolution)||32,e.clickToPlay=Boolean(e.clickToPlay),e.autoPlay=void 0===e.autoPlay||Boolean(e.autoPlay),e.loop=void 0===e.loop||Boolean(e.loop),e.size=Math.abs(e.size)||(s.activeCamera?.48*s.activeCamera.maxZ:1e3),void 0===e.useDirectMapping?this.C6=!0:this.C6=e.useDirectMapping,void 0===e.faceForward&&(e.faceForward=!0),this.ji(!1),e.mesh?this.fC=e.mesh:this.fC=Qc(t+"_mesh",{segments:e.resolution,diameter:e.size,updatable:!1,sideOrientation:Ys.BACKSIDE},s);const r=this.IT=new Bm(t+"_material",s);r.useEquirectangularFOV=!0,r.fovMultiplier=1,r.opacityFresnel=!1;const o=this.x6(i,s,e);if(this.texture=o,this.fC.material=r,this.fC.parent=this,this.T6=Qc("",{slice:.5,diameter:.98*e.size,segments:2*e.resolution,sideOrientation:Ys.BACKSIDE},s),this.T6.rotate(Ge.X,-Math.PI/2),this.T6.parent=this.fC,this.E6=!!e.halfDomeMode,this.T6.setEnabled(this.E6),this.A6=!!e.crossEyeMode,this.Lb.anisotropicFilteringLevel=1,this.Lb.onLoadObservable.addOnce((()=>{this.ji(!0)})),e.faceForward&&s.activeCamera){const t=s.activeCamera,i=w.Forward(),e=w.TransformNormal(i,t.getViewMatrix());e.normalize(),this.rotation.y=Math.acos(w.Dot(i,e))}this.R6(this.w6)}get texture(){return this.Lb}set texture(t){this.Lb!==t&&(this.Lb=t,this.C6?(this.Lb.wrapU=an.CLAMP_ADDRESSMODE,this.Lb.wrapV=an.CLAMP_ADDRESSMODE,this.IT.diffuseTexture=this.Lb):(this.Lb.coordinatesMode=an.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this.Lb.wrapV=an.CLAMP_ADDRESSMODE,this.IT.reflectionTexture=this.Lb),this.R6(this.w6))}get mesh(){return this.fC}get fovMultiplier(){return this.IT.fovMultiplier}set fovMultiplier(t){this.IT.fovMultiplier=t}get textureMode(){return this.w6}set textureMode(t){this.w6!==t&&this.R6(t)}get halfDome(){return this.E6}set halfDome(t){this.E6=t,this.T6.setEnabled(t),this.R6(this.w6)}set crossEye(t){this.A6=t,this.R6(this.w6)}get crossEye(){return this.A6}get material(){return this.IT}R6(t){switch(this.Kt.onBeforeCameraRenderObservable.remove(this.Zm),this.w6=t,this.Lb.uScale=1,this.Lb.vScale=1,this.Lb.uOffset=0,this.Lb.vOffset=0,this.Lb.vAng=0,t){case Vm.MODE_MONOSCOPIC:this.E6&&(this.Lb.uScale=2,this.Lb.uOffset=-1);break;case Vm.MODE_SIDEBYSIDE:{this.Lb.uScale=this.E6?.99999:.5;const t=this.E6?0:.5,i=this.E6?-.5:0;this.Zm=this.Kt.onBeforeCameraRenderObservable.add((e=>{let s=e.isRightCamera;this.A6&&(s=!s),this.Lb.uOffset=s?t:i}));break}case Vm.MODE_TOPBOTTOM:this.Lb.vScale=this.E6?.99999:.5,this.Zm=this.Kt.onBeforeCameraRenderObservable.add((t=>{let i=t.isRightCamera;this.A6&&(i=!i),this.Lb.vOffset=i?.5:0}))}}dispose(t,i=!1){this.Lb.dispose(),this.fC.dispose(),this.IT.dispose(),this.Kt.onBeforeCameraRenderObservable.remove(this.Zm),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),super.dispose(t,i)}}Vm.MODE_MONOSCOPIC=0,Vm.MODE_TOPBOTTOM=1,Vm.MODE_SIDEBYSIDE=2;class km extends Vm{get photoTexture(){return this.texture}set photoTexture(t){this.texture=t}get imageMode(){return this.textureMode}set imageMode(t){this.textureMode=t}x6(t,i,e){return new an(t,i,!e.generateMipMaps,!this.C6,void 0,(()=>{this.onLoadObservable.notifyObservers()}),((t,i)=>{this.onLoadErrorObservable.notifyObservers(t||"Unknown error occured"),this.onError&&this.onError(t,i)}))}}km.MODE_MONOSCOPIC=Vm.MODE_MONOSCOPIC,km.MODE_TOPBOTTOM=Vm.MODE_TOPBOTTOM,km.MODE_SIDEBYSIDE=Vm.MODE_SIDEBYSIDE;let Gm=0;const zm=t=>{if(!t.environmentBRDFTexture){const i=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const e=t.Wm;t.Wm=!1;const s=an.CreateFromBase64String("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==","EnvironmentBRDFTexture"+Gm++,t,!0,!1,an.BILINEAR_SAMPLINGMODE);t.Wm=e;const n=t.getEngine().getLoadedTexturesCache(),r=n.indexOf(s.getInternalTexture());-1!==r&&n.splice(r,1),s.isRGBD=!0,s.wrapU=an.CLAMP_ADDRESSMODE,s.wrapV=an.CLAMP_ADDRESSMODE,t.environmentBRDFTexture=s,t.useDelayedTextureLoading=i,ku.ExpandRGBDTexture(s);const h=t.getEngine().onContextRestoredObservable.add((()=>{s.isRGBD=!0;const t=()=>{s.isReady()?ku.ExpandRGBDTexture(s):ki.SetImmediate(t)};t()}));t.onDisposeObservable.add((()=>{t.getEngine().onContextRestoredObservable.remove(h)}))}return t.environmentBRDFTexture};class Hm extends Wi{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class Xm extends Zl{constructor(t,i=!0){super(t,"PBRBRDF",90,new Hm,i),this.I6=Xm.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=Xm.DEFAULT_USE_ENERGY_CONSERVATION,this.M6=Xm.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=Xm.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.b6=Xm.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=Xm.DEFAULT_USE_SPHERICAL_HARMONICS,this._6=Xm.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=Xm.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.y6=t.BR[16],this.iW(!0)}zR(){this.y6()}prepareDefines(t){t.BRDF_V_HEIGHT_CORRELATED=this.M6,t.MS_BRDF_ENERGY_CONSERVATION=this.I6&&this.M6,t.SPHERICAL_HARMONICS=this.b6,t.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._6}getClassName(){return"PBRBRDFConfiguration"}}Xm.DEFAULT_USE_ENERGY_CONSERVATION=!0,Xm.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,Xm.DEFAULT_USE_SPHERICAL_HARMONICS=!0,Xm.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,ut([Q(),q("_markAllSubMeshesAsMiscDirty")],Xm.prototype,"useEnergyConservation",void 0),ut([Q(),q("_markAllSubMeshesAsMiscDirty")],Xm.prototype,"useSmithVisibilityHeightCorrelated",void 0),ut([Q(),q("_markAllSubMeshesAsMiscDirty")],Xm.prototype,"useSphericalHarmonics",void 0),ut([Q(),q("_markAllSubMeshesAsMiscDirty")],Xm.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);const Wm="pbrFragmentDeclaration",$m="uniform vec4 vEyePosition;\nuniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\nuniform vec4 vLightingIntensity;\nuniform vec4 vReflectivityColor;\nuniform vec4 vMetallicReflectanceFactors;\nuniform vec3 vEmissiveColor;\nuniform float visibility;\nuniform vec3 vAmbientColor;\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REALTIME_FILTERING\nuniform vec2 vReflectionFilteringInfo;\n#endif\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif\n#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)\nuniform vec3 vRefractionPosition;\nuniform vec3 vRefractionSize; \n#endif\n#ifdef CLEARCOAT\nuniform vec2 vClearCoatParams;\nuniform vec4 vClearCoatRefractionParams;\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;\nuniform vec2 vClearCoatTangentSpaceParams;\nuniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT\nuniform vec4 vClearCoatTintParams;\nuniform float clearCoatColorAtDistance;\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;\nuniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#endif\n#ifdef IRIDESCENCE\nuniform vec4 vIridescenceParams;\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\nuniform vec3 vAnisotropy;\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;\nuniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\nuniform vec4 vSheenColor;\n#ifdef SHEEN_ROUGHNESS\nuniform float vSheenRoughness;\n#endif\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionMicrosurfaceInfos;\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\n#ifdef REALTIME_FILTERING\nuniform vec2 vRefractionFilteringInfo;\n#endif\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;\nuniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;\nuniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;\nuniform mat4 translucencyIntensityMatrix;\n#endif\nuniform vec2 vThicknessParam;\nuniform vec3 vDiffusionDistance;\nuniform vec4 vTintColor;\nuniform vec3 vSubSurfaceIntensity;\n#endif\n#ifdef PREPASS\n#ifdef SS_SCATTERING\nuniform float scatteringDiffusionProfile;\n#endif\n#endif\n#if DEBUGMODE>0\nuniform vec2 vDebugMode;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;\nuniform vec3 vSphericalL1_1;\nuniform vec3 vSphericalL10;\nuniform vec3 vSphericalL11;\nuniform vec3 vSphericalL2_2;\nuniform vec3 vSphericalL2_1;\nuniform vec3 vSphericalL20;\nuniform vec3 vSphericalL21;\nuniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX_ZZ;\nuniform vec3 vSphericalYY_ZZ;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\n#endif\n#endif\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";ii.IncludesShadersStore[Wm]=$m;const Ym="pbrUboDeclaration",jm="layout(std140,column_major) uniform;\nuniform Material {\nvec2 vAlbedoInfos;\nvec4 vAmbientInfos;\nvec2 vOpacityInfos;\nvec2 vEmissiveInfos;\nvec2 vLightmapInfos;\nvec3 vReflectivityInfos;\nvec2 vMicroSurfaceSamplerInfos;\nvec2 vReflectionInfos;\nvec2 vReflectionFilteringInfo;\nvec3 vReflectionPosition;\nvec3 vReflectionSize;\nvec3 vBumpInfos;\nmat4 albedoMatrix;\nmat4 ambientMatrix;\nmat4 opacityMatrix;\nmat4 emissiveMatrix;\nmat4 lightmapMatrix;\nmat4 reflectivityMatrix;\nmat4 microSurfaceSamplerMatrix;\nmat4 bumpMatrix;\nvec2 vTangentSpaceParams;\nmat4 reflectionMatrix;\nvec3 vReflectionColor;\nvec4 vAlbedoColor;\nvec4 vLightingIntensity;\nvec3 vReflectionMicrosurfaceInfos;\nfloat pointSize;\nvec4 vReflectivityColor;\nvec3 vEmissiveColor;\nvec3 vAmbientColor;\nvec2 vDebugMode;\nvec4 vMetallicReflectanceFactors;\nvec2 vMetallicReflectanceInfos;\nmat4 metallicReflectanceMatrix;\nvec2 vReflectanceInfos;\nmat4 reflectanceMatrix;\nvec3 vSphericalL00;\nvec3 vSphericalL1_1;\nvec3 vSphericalL10;\nvec3 vSphericalL11;\nvec3 vSphericalL2_2;\nvec3 vSphericalL2_1;\nvec3 vSphericalL20;\nvec3 vSphericalL21;\nvec3 vSphericalL22;\nvec3 vSphericalX;\nvec3 vSphericalY;\nvec3 vSphericalZ;\nvec3 vSphericalXX_ZZ;\nvec3 vSphericalYY_ZZ;\nvec3 vSphericalZZ;\nvec3 vSphericalXY;\nvec3 vSphericalYZ;\nvec3 vSphericalZX;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";ii.IncludesShadersStore[Ym]=jm;const Km="pbrFragmentExtraDeclaration",qm="varying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n";ii.IncludesShadersStore[Km]=qm;const Qm="samplerFragmentAlternateDeclaration",Zm="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n#endif\n";ii.IncludesShadersStore[Qm]=Zm;const Jm="pbrFragmentSamplersDeclaration",tv="#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)\n#ifdef CLEARCOAT\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D clearCoatRoughnessSampler;\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D sheenRoughnessSampler;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform samplerCube irradianceSampler;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D reflectionSamplerLow;\nuniform sampler2D reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform sampler2D irradianceSampler;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;\nuniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D refractionSamplerLow;\nuniform sampler2D refractionSamplerHigh;\n#endif\n#endif\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)\n#endif\n";ii.IncludesShadersStore[Jm]=tv;const iv="subSurfaceScatteringFunctions",ev="bool testLightingForSSS(float diffusionProfile)\n{\nreturn diffusionProfile<1.;\n}";ii.IncludesShadersStore[iv]=ev;const sv="importanceSampling",nv="vec3 hemisphereCosSample(vec2 u) {\nfloat phi=2.*PI*u.x;\nfloat cosTheta2=1.-u.y;\nfloat cosTheta=sqrt(cosTheta2);\nfloat sinTheta=sqrt(1.-cosTheta2);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}\nvec3 hemisphereImportanceSampleDggx(vec2 u,float a) {\nfloat phi=2.*PI*u.x;\nfloat cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));\nfloat cosTheta=sqrt(cosTheta2);\nfloat sinTheta=sqrt(1.-cosTheta2);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}\nvec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { \nfloat phi=2.*PI*u.x;\nfloat sinTheta=pow(u.y,a/(2.*a+1.));\nfloat cosTheta=sqrt(1.-sinTheta*sinTheta);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}";ii.IncludesShadersStore[sv]=nv;const rv="pbrHelperFunctions",hv="#define RECIPROCAL_PI2 0.15915494\n#define RECIPROCAL_PI 0.31830988618\n#define MINIMUMVARIANCE 0.0005\nfloat convertRoughnessToAverageSlope(float roughness)\n{\nreturn square(roughness)+MINIMUMVARIANCE;\n}\nfloat fresnelGrazingReflectance(float reflectance0) {\nfloat reflectance90=saturate(reflectance0*25.0);\nreturn reflectance90;\n}\nvec2 getAARoughnessFactors(vec3 normalVector) {\n#ifdef SPECULARAA\nvec3 nDfdx=dFdx(normalVector.xyz);\nvec3 nDfdy=dFdy(normalVector.xyz);\nfloat slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));\nfloat geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);\nfloat geometricAlphaGFactor=sqrt(slopeSquare);\ngeometricAlphaGFactor*=0.75;\nreturn vec2(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2(0.);\n#endif\n}\n#ifdef ANISOTROPIC\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {\nfloat alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);\nfloat alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);\nreturn vec2(alphaT,alphaB);\n}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy) {\nvec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;\nvec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);\nvec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);\nvec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));\nreturn anisotropicNormal;\n}\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\nvec3 cocaLambert(vec3 alpha,float distance) {\nreturn exp(-alpha*distance);\n}\nvec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {\nreturn cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));\n}\nvec3 computeColorAtDistanceInMedia(vec3 color,float distance) {\nreturn -log(color)/distance;\n}\nvec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {\nvec3 clearCoatAbsorption=mix(vec3(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);\nreturn clearCoatAbsorption;\n}\n#endif\n#ifdef MICROSURFACEAUTOMATIC\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{\nconst float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;\nfloat reflectivityLuminance=getLuminance(reflectivityColor);\nfloat reflectivityLuma=sqrt(reflectivityLuminance);\nmicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;\nreturn microSurface;\n}\n#endif\n";ii.IncludesShadersStore[rv]=hv;const ov="harmonicsFunctions",av="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nvec3 computeEnvironmentIrradiance(vec3 normal) {\nreturn vSphericalL00\n+ vSphericalL1_1*(normal.y)\n+ vSphericalL10*(normal.z)\n+ vSphericalL11*(normal.x)\n+ vSphericalL2_2*(normal.y*normal.x)\n+ vSphericalL2_1*(normal.y*normal.z)\n+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+ vSphericalL21*(normal.z*normal.x)\n+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));\n}\n#else\nvec3 computeEnvironmentIrradiance(vec3 normal) {\nfloat Nx=normal.x;\nfloat Ny=normal.y;\nfloat Nz=normal.z;\nvec3 C1=vSphericalZZ.rgb;\nvec3 Cx=vSphericalX.rgb;\nvec3 Cy=vSphericalY.rgb;\nvec3 Cz=vSphericalZ.rgb;\nvec3 Cxx_zz=vSphericalXX_ZZ.rgb;\nvec3 Cyy_zz=vSphericalYY_ZZ.rgb;\nvec3 Cxy=vSphericalXY.rgb;\nvec3 Cyz=vSphericalYZ.rgb;\nvec3 Czx=vSphericalZX.rgb;\nvec3 a1=Cyy_zz*Ny+Cy;\nvec3 a2=Cyz*Nz+a1;\nvec3 b1=Czx*Nz+Cx;\nvec3 b2=Cxy*Ny+b1;\nvec3 b3=Cxx_zz*Nx+b2;\nvec3 t1=Cz *Nz+C1;\nvec3 t2=a2 *Ny+t1;\nvec3 t3=b3 *Nx+t2;\nreturn t3;\n}\n#endif\n#endif\n";ii.IncludesShadersStore[ov]=av;const lv="pbrDirectLightingSetupFunctions",cv="struct preLightingInfo\n{\nvec3 lightOffset;\nfloat lightDistanceSquared;\nfloat lightDistance;\nfloat attenuation;\nvec3 L;\nvec3 H;\nfloat NdotV;\nfloat NdotLUnclamped;\nfloat NdotL;\nfloat VdotH;\nfloat roughness;\n#ifdef IRIDESCENCE\nfloat iridescenceIntensity;\n#endif\n};\npreLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\nresult.lightOffset=lightData.xyz-vPositionW;\nresult.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);\nresult.lightDistance=sqrt(result.lightDistanceSquared);\nresult.L=normalize(result.lightOffset);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\nresult.NdotLUnclamped=dot(N,result.L);\nresult.NdotL=saturateEps(result.NdotLUnclamped);\nreturn result;\n}\npreLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\nresult.lightDistance=length(-lightData.xyz);\nresult.L=normalize(-lightData.xyz);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\nresult.NdotLUnclamped=dot(N,result.L);\nresult.NdotL=saturateEps(result.NdotLUnclamped);\nreturn result;\n}\npreLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\nresult.NdotL=dot(N,lightData.xyz)*0.5+0.5;\nresult.NdotL=saturateEps(result.NdotL);\nresult.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\n#endif\nreturn result;\n}";ii.IncludesShadersStore[lv]=cv;const uv="pbrDirectLightingFalloffFunctions",fv="float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)\n{\nreturn max(0.,1.0-length(lightOffset)/range);\n}\nfloat computeDistanceLightFalloff_Physical(float lightDistanceSquared)\n{\nreturn 1.0/maxEps(lightDistanceSquared);\n}\nfloat computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)\n{\nfloat lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);\nfloat factor=lightDistanceSquared*inverseSquaredRange;\nfloat attenuation=saturate(1.0-factor*factor);\nattenuation*=attenuation;\nlightDistanceFalloff*=attenuation;\nreturn lightDistanceFalloff;\n}\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfloat computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{\nfloat falloff=0.0;\nfloat cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));\nif (cosAngle>=cosHalfAngle)\n{\nfalloff=max(0.,pow(cosAngle,exponent));\n}\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)\n{\nconst float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);\nvec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);\nfloat falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)\n{\nfloat cd=dot(-lightDirection,directionToLightCenterW);\nfloat falloff=saturate(cd*lightAngleScale+lightAngleOffset);\nfalloff*=falloff;\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}";ii.IncludesShadersStore[uv]=fv;const dv="pbrBRDFFunctions",pv="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\nreturn 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);\n}\n#endif\n#ifdef ENVIRONMENTBRDF\nvec3 getBRDFLookup(float NdotV,float perceptualRoughness) {\nvec2 UV=vec2(NdotV,perceptualRoughness);\nvec4 brdfLookup=texture2D(environmentBrdfSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup.rgb=fromRGBD(brdfLookup.rgba);\n#endif\nreturn brdfLookup.rgb;\n}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;\n}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;\n}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfloat getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)\n{\nfloat c=1.0-NdotV;\nfloat c3=c*c*c;\nreturn 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));\n}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nvec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));\n}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nvec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {\nvec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;\nreturn sheenEnvironmentReflectance;\n}\n#endif\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);\n}\nfloat fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);\n}\n#ifdef CLEARCOAT\nvec3 getR0RemappedForClearCoat(vec3 f0) {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturate(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvec3 s=sqrt(f0);\nvec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);\nreturn square(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst mat3 XYZ_TO_REC709=mat3(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);\nvec3 getIORTfromAirToSurfaceR0(vec3 f0) {\nvec3 sqrtF0=sqrt(f0);\nreturn (1.+sqrtF0)/(1.-sqrtF0);\n}\nvec3 getR0fromIORs(vec3 iorT,float iorI) {\nreturn square((iorT-vec3(iorI))/(iorT+vec3(iorI)));\n}\nfloat getR0fromIORs(float iorT,float iorI) {\nreturn square((iorT-iorI)/(iorT+iorI));\n}\nvec3 evalSensitivity(float opd,vec3 shift) {\nfloat phase=2.0*PI*opd*1.0e-9;\nconst vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);\nconst vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);\nconst vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);\nvec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);\nxyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));\nxyz/=1.0685e-7;\nvec3 srgb=XYZ_TO_REC709*xyz;\nreturn srgb;\n}\nvec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {\nvec3 I=vec3(1.0);\nfloat iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));\nfloat sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));\nfloat cosTheta2Sq=1.0-sinTheta2Sq;\nif (cosTheta2Sq<0.0) {\nreturn I;\n}\nfloat cosTheta2=sqrt(cosTheta2Sq);\nfloat R0=getR0fromIORs(iridescenceIOR,outsideIOR);\nfloat R12=fresnelSchlickGGX(cosTheta1,R0,1.);\nfloat R21=R12;\nfloat T121=1.0-R12;\nfloat phi12=0.0;\nif (iridescenceIOR<outsideIOR) phi12=PI;\nfloat phi21=PI-phi12;\nvec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); \nvec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);\nvec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));\nvec3 phi23=vec3(0.0);\nif (baseIOR[0]<iridescenceIOR) phi23[0]=PI;\nif (baseIOR[1]<iridescenceIOR) phi23[1]=PI;\nif (baseIOR[2]<iridescenceIOR) phi23[2]=PI;\nfloat opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;\nvec3 phi=vec3(phi21)+phi23;\nvec3 R123=clamp(R12*R23,1e-5,0.9999);\nvec3 r123=sqrt(R123);\nvec3 Rs=square(T121)*R23/(vec3(1.0)-R123);\nvec3 C0=R12+Rs;\nI=C0;\nvec3 Cm=Rs-T121;\nfor (int m=1; m<=2; ++m)\n{\nCm*=r123;\nvec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);\nI+=Cm*Sm;\n}\nreturn max(I,vec3(0.0));\n}\n#endif\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{\nfloat a2=square(alphaG);\nfloat d=NdotH*NdotH*(a2-1.0)+1.0;\nreturn a2/(PI*d*d);\n}\n#ifdef SHEEN\nfloat normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)\n{\nfloat invR=1./alphaG;\nfloat cos2h=NdotH*NdotH;\nfloat sin2h=1.-cos2h;\nreturn (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);\n}\n#endif\n#ifdef ANISOTROPIC\nfloat normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {\nfloat a2=alphaTB.x*alphaTB.y;\nvec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);\nfloat v2=dot(v,v);\nfloat w2=a2/v2;\nreturn a2*w2*w2*RECIPROCAL_PI;\n}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {\n#ifdef MOBILE\nfloat GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);\nfloat GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);\nreturn 0.5/(GGXV+GGXL);\n#else\nfloat a2=alphaG*alphaG;\nfloat GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);\nfloat GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);\nreturn 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfloat smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nfloat alphaSquared=alphaG*alphaG;\nreturn 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfloat smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)\n{\nfloat visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);\nreturn visibility;\n}\n#endif\n#ifdef ANISOTROPIC\nfloat smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {\nfloat lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));\nfloat lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));\nfloat v=0.5/(lambdaV+lambdaL);\nreturn v;\n}\n#endif\n#ifdef CLEARCOAT\nfloat visibility_Kelemen(float VdotH) {\nreturn 0.25/(VdotH*VdotH); \n}\n#endif\n#ifdef SHEEN\nfloat visibility_Ashikhmin(float NdotL,float NdotV)\n{\nreturn 1./(4.*(NdotL+NdotV-NdotL*NdotV));\n}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfloat l(float x,float alphaG)\n{\nfloat oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);\nfloat a=mix(21.5473,25.3245,oneMinusAlphaSq);\nfloat b=mix(3.82987,3.32435,oneMinusAlphaSq);\nfloat c=mix(0.19823,0.16801,oneMinusAlphaSq);\nfloat d=mix(-1.97760,-1.27393,oneMinusAlphaSq);\nfloat e=mix(-4.32054,-4.85967,oneMinusAlphaSq);\nreturn a/(1.0+b*pow(x,c))+d*x+e;\n}\nfloat lambdaSheen(float cosTheta,float alphaG)\n{\nreturn abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));\n}\nfloat visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)\n{\nfloat G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));\nreturn G/(4.0*NdotV*NdotL);\n}\n#endif\n*/\n#endif\nfloat diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {\nfloat diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));\nfloat diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));\nfloat diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;\nfloat fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);\nreturn fresnel/PI;\n}\n#ifdef SS_TRANSLUCENCY\nvec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {\nvec3 S=1./maxEps(diffusionDistance);\nvec3 temp=exp((-0.333333333*thickness)*S);\nreturn tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);\n}\nfloat computeWrappedDiffuseNdotL(float NdotL,float w) {\nfloat t=1.0+w;\nfloat invt2=1.0/square(t);\nreturn saturate((NdotL+w)*invt2);\n}\n#endif\n";ii.IncludesShadersStore[dv]=pv;const mv="hdrFilteringFunctions",vv="#ifdef NUM_SAMPLES\n#if NUM_SAMPLES>0\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfloat radicalInverse_VdC(uint bits) \n{\nbits=(bits<<16u) | (bits>>16u);\nbits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);\nbits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);\nbits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);\nbits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);\nreturn float(bits)*2.3283064365386963e-10; \n}\nvec2 hammersley(uint i,uint N)\n{\nreturn vec2(float(i)/float(N),radicalInverse_VdC(i));\n}\n#else\nfloat vanDerCorpus(int n,int base)\n{\nfloat invBase=1.0/float(base);\nfloat denom =1.0;\nfloat result =0.0;\nfor(int i=0; i<32; ++i)\n{\nif(n>0)\n{\ndenom =mod(float(n),2.0);\nresult+=denom*invBase;\ninvBase=invBase/2.0;\nn =int(float(n)/2.0);\n}\n}\nreturn result;\n}\nvec2 hammersley(int i,int N)\n{\nreturn vec2(float(i)/float(N),vanDerCorpus(i,2));\n}\n#endif\nfloat log4(float x) {\nreturn log2(x)/2.;\n}\nconst float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);\nconst float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;\nconst float K=4.;\n#define inline\nvec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{\nvec3 n=normalize(inputN);\nvec3 result=vec3(0.0);\nvec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);\ntangent=normalize(cross(tangent,n));\nvec3 bitangent=cross(n,tangent);\nmat3 tbn=mat3(tangent,bitangent,n);\nfloat maxLevel=filteringInfo.y;\nfloat dim0=filteringInfo.x;\nfloat omegaP=(4.*PI)/(6.*dim0*dim0);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{\nvec2 Xi=hammersley(i,NUM_SAMPLES);\nvec3 Ls=hemisphereCosSample(Xi);\nLs=normalize(Ls);\nvec3 Ns=vec3(0.,0.,1.);\nfloat NoL=dot(Ns,Ls);\nif (NoL>0.) {\nfloat pdf_inversed=PI/NoL;\nfloat omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;\nfloat l=log4(omegaS)-log4(omegaP)+log4(K);\nfloat mipLevel=clamp(l,0.0,maxLevel);\nvec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c;\n}\n}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;\nreturn result;\n}\n#define inline\nvec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{\nvec3 n=normalize(inputN);\nif (alphaG==0.) {\nvec3 c=textureCube(inputTexture,n).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;\n} else {\nvec3 result=vec3(0.);\nvec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);\ntangent=normalize(cross(tangent,n));\nvec3 bitangent=cross(n,tangent);\nmat3 tbn=mat3(tangent,bitangent,n);\nfloat maxLevel=filteringInfo.y;\nfloat dim0=filteringInfo.x;\nfloat omegaP=(4.*PI)/(6.*dim0*dim0);\nfloat weight=0.;\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{\nvec2 Xi=hammersley(i,NUM_SAMPLES);\nvec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);\nfloat NoV=1.;\nfloat NoH=H.z;\nfloat NoH2=H.z*H.z;\nfloat NoL=2.*NoH2-1.;\nvec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);\nL=normalize(L);\nif (NoL>0.) {\nfloat pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);\nfloat omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;\nfloat l=log4(omegaS)-log4(omegaP)+log4(K);\nfloat mipLevel=clamp(float(l),0.0,maxLevel);\nweight+=NoL;\nvec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;\n}\n}\nresult=result/weight;\nreturn result;\n}\n}\n#endif\n#endif\n";ii.IncludesShadersStore[mv]=vv;const gv="pbrDirectLightingFunctions",Sv="#define CLEARCOATREFLECTANCE90 1.0\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef CLEARCOAT\nvec4 clearCoat;\n#endif\n#ifdef SHEEN\nvec3 sheen;\n#endif\n};\nfloat adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\nfloat lightRoughness=lightRadius/lightDistance;\nfloat totalRoughness=saturate(lightRoughness+roughness);\nreturn totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nvec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {\nreturn mix(groundColor,lightColor,info.NdotL);\n}\nvec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {\nfloat diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);\nreturn diffuseTerm*info.attenuation*info.NdotL*lightColor;\n}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\nreturn toLinearSpace(textureColor);\n}\n#ifdef SS_TRANSLUCENCY\nvec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {\nfloat NdotL=absEps(info.NdotLUnclamped);\nfloat wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);\nfloat trAdapt=step(0.,info.NdotLUnclamped);\nvec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);\nfloat diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);\nreturn diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;\n}\n#endif\n#ifdef SPECULARTERM\nvec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat roughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nvec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nfloat smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvec3 specTerm=fresnel*distribution*smithVisibility;\nreturn specTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n#ifdef ANISOTROPIC\nvec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat TdotH=dot(T,info.H);\nfloat BdotH=dot(B,info.H);\nfloat TdotV=dot(T,V);\nfloat BdotV=dot(B,V);\nfloat TdotL=dot(T,info.L);\nfloat BdotL=dot(B,info.L);\nfloat alphaG=convertRoughnessToAverageSlope(info.roughness);\nvec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);\nalphaTB=max(alphaTB,square(geometricRoughnessFactor));\nvec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);\nfloat smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);\nvec3 specTerm=fresnel*distribution*smithVisibility;\nreturn specTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n#ifdef CLEARCOAT\nvec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {\nfloat NccdotL=saturateEps(dot(Ncc,info.L));\nfloat NccdotH=saturateEps(dot(Ncc,info.H));\nfloat clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\nfloat fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);\nfresnel*=clearCoatIntensity;\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);\nfloat kelemenVisibility=visibility_Kelemen(info.VdotH);\nfloat clearCoatTerm=fresnel*distribution*kelemenVisibility;\nreturn vec4(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);\n}\nvec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {\nvec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);\nfloat NdotLRefract=saturateEps(dot(Ncc,LRefract));\nvec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);\nreturn absorption;\n}\n#endif\n#ifdef SHEEN\nvec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat roughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nfloat fresnel=1.;\nfloat distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);\n/*#ifdef SHEEN_SOFTER\nfloat visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);\n#else */\nfloat visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);\n/* #endif */\nfloat sheenTerm=fresnel*distribution*visibility;\nreturn sheenTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n";ii.IncludesShadersStore[gv]=Sv;const Ev="pbrIBLFunctions",Av="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {\nfloat microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;\nfloat lod=log2(microsurfaceAverageSlopeTexels);\nreturn lod;\n}\nfloat getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {\nfloat lod=log2(cubeMapDimensionPixels)*roughness;\nreturn lod;\n}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {\nfloat temp=NdotVUnclamped+ambientOcclusion;\nreturn saturate(square(temp)-1.0+ambientOcclusion);\n}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfloat environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {\nvec3 reflection=reflect(view,normal);\nfloat temp=saturate(1.0+1.1*dot(reflection,geometricNormal));\nreturn square(temp);\n}\n#endif\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {\nfloat microsurfaceAverageSlope=alphaG;\nmicrosurfaceAverageSlope*=sqrt(abs(NdotV));\nreturn getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);\n}\n#endif\n";ii.IncludesShadersStore[Ev]=Av;const Cv="pbrBlockAlbedoOpacity",wv="struct albedoOpacityOutParams\n{\nvec3 surfaceAlbedo;\nfloat alpha;\n};\n#define pbr_inline\nvoid albedoOpacityBlock(\nin vec4 vAlbedoColor,\n#ifdef ALBEDO\nin vec4 albedoTexture,\nin vec2 albedoInfos,\n#endif\n#ifdef OPACITY\nin vec4 opacityMap,\nin vec2 vOpacityInfos,\n#endif\n#ifdef DETAIL\nin vec4 detailColor,\nin vec4 vDetailInfos,\n#endif\nout albedoOpacityOutParams outParams\n)\n{\nvec3 surfaceAlbedo=vAlbedoColor.rgb;\nfloat alpha=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nsurfaceAlbedo*=vColor.rgb;\n#endif\n#ifdef DETAIL\nfloat detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);\nsurfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; \n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;\noutParams.alpha=alpha;\n}\n";ii.IncludesShadersStore[Cv]=wv;const xv="pbrBlockReflectivity",Tv="struct reflectivityOutParams\n{\nfloat microSurface;\nfloat roughness;\nvec3 surfaceReflectivityColor;\n#ifdef METALLICWORKFLOW\nvec3 surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nvec3 ambientOcclusionColor;\n#endif\n#if DEBUGMODE>0\nvec4 surfaceMetallicColorMap;\nvec4 surfaceReflectivityColorMap;\nvec2 metallicRoughness;\nvec3 metallicF0;\n#endif\n};\n#define pbr_inline\nvoid reflectivityBlock(\nin vec4 vReflectivityColor,\n#ifdef METALLICWORKFLOW\nin vec3 surfaceAlbedo,\nin vec4 metallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nin vec3 reflectivityInfos,\nin vec4 surfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nin vec3 ambientOcclusionColorIn,\n#endif\n#ifdef MICROSURFACEMAP\nin vec4 microSurfaceTexel,\n#endif\n#ifdef DETAIL\nin vec4 detailColor,\nin vec4 vDetailInfos,\n#endif\nout reflectivityOutParams outParams\n)\n{\nfloat microSurface=vReflectivityColor.a;\nvec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);\noutParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nfloat detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);\nfloat loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);\nfloat hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);\nmetallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#if DEBUGMODE>0\noutParams.metallicRoughness=metallicRoughness;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\nmicroSurface=1.0-metallicRoughness.g;\nvec3 baseColor=surfaceAlbedo;\n#ifdef FROSTBITE_REFLECTANCE\noutParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);\nsurfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);\n#else\nvec3 metallicF0=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=metallicF0;\n#endif\noutParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);\nsurfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;\nmicroSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\n#endif\nmicroSurface=saturate(microSurface);\nfloat roughness=1.-microSurface;\noutParams.microSurface=microSurface;\noutParams.roughness=roughness;\noutParams.surfaceReflectivityColor=surfaceReflectivityColor;\n}\n";ii.IncludesShadersStore[xv]=Tv;const Rv="pbrBlockAmbientOcclusion",Iv="struct ambientOcclusionOutParams\n{\nvec3 ambientOcclusionColor;\n#if DEBUGMODE>0\nvec3 ambientOcclusionColorMap;\n#endif\n};\n#define pbr_inline\nvoid ambientOcclusionBlock(\n#ifdef AMBIENT\nin vec3 ambientOcclusionColorMap_,\nin vec4 vAmbientInfos,\n#endif\nout ambientOcclusionOutParams outParams\n)\n{\nvec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;\n}\n";ii.IncludesShadersStore[Rv]=Iv;const Mv="pbrBlockAlphaFresnel",bv="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{\nfloat alpha;\n};\n#define pbr_inline\nvoid alphaFresnelBlock(\nin vec3 normalW,\nin vec3 viewDirectionW,\nin float alpha,\nin float microSurface,\nout alphaFresnelOutParams outParams\n)\n{\nfloat opacityPerceptual=alpha;\n#ifdef LINEARALPHAFRESNEL\nfloat opacity0=opacityPerceptual;\n#else\nfloat opacity0=opacityPerceptual*opacityPerceptual;\n#endif\nfloat opacity90=fresnelGrazingReflectance(opacity0);\nvec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);\noutParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\noutParams.alpha=1.0;\n#endif\n#endif\n}\n#endif\n#endif\n";ii.IncludesShadersStore[Mv]=bv;const _v="pbrBlockAnisotropic",yv="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{\nfloat anisotropy;\nvec3 anisotropicTangent;\nvec3 anisotropicBitangent;\nvec3 anisotropicNormal;\n#if DEBUGMODE>0\nvec3 anisotropyMapData;\n#endif\n};\n#define pbr_inline\nvoid anisotropicBlock(\nin vec3 vAnisotropy,\n#ifdef ANISOTROPIC_TEXTURE\nin vec3 anisotropyMapData,\n#endif\nin mat3 TBN,\nin vec3 normalW,\nin vec3 viewDirectionW,\nout anisotropicOutParams outParams\n)\n{\nfloat anisotropy=vAnisotropy.b;\nvec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nanisotropy*=anisotropyMapData.b;\nanisotropyDirection.rg*=anisotropyMapData.rg*2.0-1.0;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\n#endif\nmat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));\nvec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);\nvec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));\noutParams.anisotropy=anisotropy;\noutParams.anisotropicTangent=anisotropicTangent;\noutParams.anisotropicBitangent=anisotropicBitangent;\noutParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy);\n}\n#endif\n";ii.IncludesShadersStore[_v]=yv;const Nv="pbrBlockReflection",Pv="#ifdef REFLECTION\nstruct reflectionOutParams\n{\nvec4 environmentRadiance;\nvec3 environmentIrradiance;\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords;\n#else\nvec2 reflectionCoords;\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nvec3 irradianceVector;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nvoid createReflectionCoords(\nin vec3 vPositionW,\nin vec3 normalW,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REFLECTIONMAP_3D\nout vec3 reflectionCoords\n#else\nout vec2 reflectionCoords\n#endif\n)\n{\n#ifdef ANISOTROPIC\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n}\n#define pbr_inline\n#define inline\nvoid sampleReflectionTexture(\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nconst vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nconst vec2 reflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout vec4 environmentRadiance\n)\n{\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nfloat reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);\nfloat requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);\nif (lodReflectionNormalizedDoubled<1.0){\nenvironmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);\n} else {\nenvironmentRadiance=mix(\nenvironmentMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);\n#endif\nenvironmentRadiance.rgb*=vReflectionInfos.x;\nenvironmentRadiance.rgb*=vReflectionColor.rgb;\n}\n#define pbr_inline\n#define inline\nvoid reflectionBlock(\nin vec3 vPositionW,\nin vec3 normalW,\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\n#else\nin sampler2D reflectionSampler,\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nin vec3 vEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nin mat4 reflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nin samplerCube irradianceSampler,\n#else\nin sampler2D irradianceSampler,\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout reflectionOutParams outParams\n)\n{\nvec4 environmentRadiance=vec4(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=vec3(0.);\n#else\nvec2 reflectionCoords=vec2(0.);\n#endif\ncreateReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\nreflectionCoords\n);\nsampleReflectionTexture(\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionSampler,\nreflectionCoords,\n#else\nreflectionSampler,\nreflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentRadiance\n);\nvec3 environmentIrradiance=vec3(0.,0.,0.);\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#ifdef ANISOTROPIC\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\nvec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);\nenvironmentIrradiance=environmentIrradiance4.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance.rgb=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb;\noutParams.environmentRadiance=environmentRadiance;\noutParams.environmentIrradiance=environmentIrradiance;\noutParams.reflectionCoords=reflectionCoords;\n}\n#endif\n";ii.IncludesShadersStore[Nv]=Pv;const Dv="pbrBlockSheen",Lv="#ifdef SHEEN\nstruct sheenOutParams\n{\nfloat sheenIntensity;\nvec3 sheenColor;\nfloat sheenRoughness;\n#ifdef SHEEN_LINKWITHALBEDO\nvec3 surfaceAlbedo;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfloat sheenAlbedoScaling;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 finalSheenRadianceScaled;\n#endif\n#if DEBUGMODE>0\nvec4 sheenMapData;\nvec3 sheenEnvironmentReflectance;\n#endif\n};\n#define pbr_inline\n#define inline\nvoid sheenBlock(\nin vec4 vSheenColor,\n#ifdef SHEEN_ROUGHNESS\nin float vSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nin vec4 sheenMapRoughnessData,\n#endif\n#endif\nin float roughness,\n#ifdef SHEEN_TEXTURE\nin vec4 sheenMapData,\nin float sheenMapLevel,\n#endif\nin float reflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nin vec3 baseColor,\nin vec3 surfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nin float NdotV,\nin vec3 environmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nin vec2 AARoughnessFactors,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\nin vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nin vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nin vec2 reflectionCoords,\n#endif\nin float NdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nin float seo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nin float eho,\n#endif\n#endif\nout sheenOutParams outParams\n)\n{\nfloat sheenIntensity=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nfloat sheenFactor=pow5(1.0-sheenIntensity);\nvec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);\nfloat sheenRoughness=sheenIntensity;\noutParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvec3 sheenColor=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\n#ifdef SHEEN_GAMMATEXTURE\nsheenColor.rgb*=toLinearSpace(sheenMapData.rgb);\n#else\nsheenColor.rgb*=sheenMapData.rgb;\n#endif\nsheenColor.rgb*=sheenMapLevel;\n#endif\n#ifdef SHEEN_ROUGHNESS\nfloat sheenRoughness=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\n#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL\nsheenRoughness*=sheenMapData.a;\n#else\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#endif\n#else\nfloat sheenRoughness=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\nsheenColor*=sheenIntensity;\n#endif\n#ifdef ENVIRONMENTBRDF\n/*#ifdef SHEEN_SOFTER\nvec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));\n#else*/\n#ifdef SHEEN_ROUGHNESS\nvec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvec3 environmentSheenBrdf=environmentBrdf;\n#endif\n/*#endif*/\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nfloat sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);\nsampleReflectionTexture(\nsheenAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nsheenRoughness,\n#endif\nreflectionSampler,\nreflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentSheenRadiance\n);\nvec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\noutParams.sheenIntensity=sheenIntensity;\noutParams.sheenColor=sheenColor;\noutParams.sheenRoughness=sheenRoughness;\n}\n#endif\n";ii.IncludesShadersStore[Dv]=Lv;const Ov="pbrBlockClearcoat",Fv="struct clearcoatOutParams\n{\nvec3 specularEnvironmentR0;\nfloat conservationFactor;\nvec3 clearCoatNormalW;\nvec2 clearCoatAARoughnessFactors;\nfloat clearCoatIntensity;\nfloat clearCoatRoughness;\n#ifdef REFLECTION\nvec3 finalClearCoatRadianceScaled;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 absorption;\nfloat clearCoatNdotVRefract;\nvec3 clearCoatColor;\nfloat clearCoatThickness;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nvec3 energyConservationFactorClearCoat;\n#endif\n#if DEBUGMODE>0\nmat3 TBNClearCoat;\nvec2 clearCoatMapData;\nvec4 clearCoatTintMapData;\nvec4 environmentClearCoatRadiance;\nfloat clearCoatNdotV;\nvec3 clearCoatEnvironmentReflectance;\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\n#define inline\nvoid clearcoatBlock(\nin vec3 vPositionW,\nin vec3 geometricNormalW,\nin vec3 viewDirectionW,\nin vec2 vClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nin vec4 clearCoatMapRoughnessData,\n#endif\nin vec3 specularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nin vec2 clearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nin vec4 vClearCoatTintParams,\nin float clearCoatColorAtDistance,\nin vec4 vClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nin vec4 clearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nin vec2 vClearCoatBumpInfos,\nin vec4 clearCoatBumpMapData,\nin vec2 vClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nin mat3 vTBN,\n#else\nin vec2 vClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nin mat4 normalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nin vec3 faceNormal,\n#endif\n#ifdef REFLECTION\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\nin vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\n#else\nin sampler2D reflectionSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nin float ambientMonochrome,\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\nin float frontFacingMultiplier,\n#endif\nout clearcoatOutParams outParams\n)\n{\nfloat clearCoatIntensity=vClearCoatParams.x;\nfloat clearCoatRoughness=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL\nclearCoatRoughness*=clearCoatMapData.y;\n#else\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;\noutParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatColor=vClearCoatTintParams.rgb;\nfloat clearCoatThickness=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\n#ifdef CLEARCOAT_TINT_GAMMATEXTURE\nclearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);\n#else\nclearCoatColor*=clearCoatTintMapData.rgb;\n#endif\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);\noutParams.clearCoatThickness=clearCoatThickness;\n#endif\n#ifdef CLEARCOAT_REMAP_F0\nvec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvec3 specularEnvironmentR0Updated=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);\nvec3 clearCoatNormalW=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nfloat clearCoatNormalScale=1.0;\n#else\nfloat clearCoatNormalScale=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBNClearCoat=vTBN;\n#else\nvec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;\nmat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);\nclearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;\noutParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);\nfloat clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);\nfloat clearCoatNdotV=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);\noutParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))\nvec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n#if defined(REFLECTION)\nfloat clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);\nvec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 clearCoatReflectionCoords=clearCoatReflectionVector;\n#else\nvec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nsampleReflectionTexture(\nclearCoatAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nclearCoatNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nclearCoatRoughness,\n#endif\nreflectionSampler,\nclearCoatReflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentClearCoatRadiance\n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef RADIANCEOCCLUSION\nfloat clearCoatSeo=environmentRadianceOcclusion(ambientMonochrome,clearCoatNdotVUnclamped);\nclearCoatEnvironmentReflectance*=clearCoatSeo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);\nclearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\nfloat fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);\nfresnelIBLClearCoat*=clearCoatIntensity;\noutParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\n}\n#endif\n";ii.IncludesShadersStore[Ov]=Fv;const Bv="pbrBlockIridescence",Uv="struct iridescenceOutParams\n{\nfloat iridescenceIntensity;\nfloat iridescenceIOR;\nfloat iridescenceThickness;\nvec3 specularEnvironmentR0;\n};\n#ifdef IRIDESCENCE\n#define pbr_inline\n#define inline\nvoid iridescenceBlock(\nin vec4 vIridescenceParams,\nin float viewAngle,\nin vec3 specularEnvironmentR0,\n#ifdef IRIDESCENCE_TEXTURE\nin vec2 iridescenceMapData,\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nin vec2 iridescenceThicknessMapData,\n#endif\n#ifdef CLEARCOAT\nin float NdotVUnclamped,\n#ifdef CLEARCOAT_TEXTURE\nin vec2 clearCoatMapData,\n#endif\n#endif\nout iridescenceOutParams outParams\n)\n{\nfloat iridescenceIntensity=vIridescenceParams.x;\nfloat iridescenceIOR=vIridescenceParams.y;\nfloat iridescenceThicknessMin=vIridescenceParams.z;\nfloat iridescenceThicknessMax=vIridescenceParams.w;\nfloat iridescenceThicknessWeight=1.;\n#ifdef IRIDESCENCE_TEXTURE\niridescenceIntensity*=iridescenceMapData.x;\n#ifdef IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE\niridescenceThicknessWeight=iridescenceMapData.g;\n#endif\n#endif\n#if defined(IRIDESCENCE_THICKNESS_TEXTURE)\niridescenceThicknessWeight=iridescenceThicknessMapData.g;\n#endif\nfloat iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);\nfloat topIor=1.; \n#ifdef CLEARCOAT\nfloat clearCoatIntensity=vClearCoatParams.x;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#endif\ntopIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);\nviewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));\n#endif\nvec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);\noutParams.iridescenceIntensity=iridescenceIntensity;\noutParams.iridescenceThickness=iridescenceThickness;\noutParams.iridescenceIOR=iridescenceIOR;\n}\n#endif\n";ii.IncludesShadersStore[Bv]=Uv;const Vv="pbrBlockSubSurface",kv="struct subSurfaceOutParams\n{\nvec3 specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvec3 finalRefraction;\nvec3 surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nfloat alpha;\n#endif\n#ifdef REFLECTION\nfloat refractionFactorForIrradiance;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvec3 transmittance;\nfloat translucencyIntensity;\n#ifdef REFLECTION\nvec3 refractionIrradiance;\n#endif\n#endif\n#if DEBUGMODE>0\nvec4 thicknessMap;\nvec4 environmentRefraction;\nvec3 refractionTransmittance;\n#endif\n};\n#ifdef SUBSURFACE\n#define pbr_inline\n#define inline\nvoid subSurfaceBlock(\nin vec3 vSubSurfaceIntensity,\nin vec2 vThicknessParam,\nin vec4 vTintColor,\nin vec3 normalW,\nin vec3 specularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nin vec4 thicknessMap,\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nin vec4 refractionIntensityMap,\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nin vec4 translucencyIntensityMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nin mat4 reflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nin vec3 irradianceVector_,\n#endif\n#if defined(REALTIME_FILTERING)\nin samplerCube reflectionSampler,\nin vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nin samplerCube irradianceSampler,\n#else\nin sampler2D irradianceSampler,\n#endif\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\nin vec3 surfaceAlbedo,\n#endif\n#ifdef SS_REFRACTION\nin vec3 vPositionW,\nin vec3 viewDirectionW,\nin mat4 view,\nin vec4 vRefractionInfos,\nin mat4 refractionMatrix,\nin vec4 vRefractionMicrosurfaceInfos,\nin vec4 vLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nin float alpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nin float NdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nin float roughness,\n#endif\nin float alphaG,\n#ifdef SS_REFRACTIONMAP_3D\nin samplerCube refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nin samplerCube refractionSamplerLow,\nin samplerCube refractionSamplerHigh,\n#endif\n#else\nin sampler2D refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nin sampler2D refractionSamplerLow,\nin sampler2D refractionSamplerHigh,\n#endif\n#endif\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vRefractionFilteringInfo,\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nin vec3 refractionPosition,\nin vec3 refractionSize,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nin vec3 vDiffusionDistance,\n#endif\nout subSurfaceOutParams outParams\n)\n{\noutParams.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nfloat refractionIntensity=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);\noutParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nfloat translucencyIntensity=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#if defined(SS_USE_GLTF_TEXTURES)\nfloat thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#else\nfloat thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#endif\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#ifdef SS_MASK_FROM_THICKNESS_TEXTURE\n#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE)\n#if defined(SS_USE_GLTF_TEXTURES)\nrefractionIntensity*=thicknessMap.r;\n#else\nrefractionIntensity*=thicknessMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE)\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#endif\n#else\nfloat thickness=vThicknessParam.y;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=refractionIntensityMap.r;\n#else\nrefractionIntensity*=refractionIntensityMap.g;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\ntranslucencyIntensity*=translucencyIntensityMap.b;\n#endif\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);\nvec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);\ntransmittance*=translucencyIntensity;\noutParams.transmittance=transmittance;\noutParams.translucencyIntensity=translucencyIntensity;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,vRefractionInfos.y);\n#else\nvec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n#ifdef SS_REFRACTIONMAP_3D\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nvec3 refractionCoords=refractionVector;\nrefractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\n#ifdef SS_USE_THICKNESS_AS_DEPTH\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\n#endif\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef SS_HAS_THICKNESS\nfloat ior=vRefractionInfos.y;\n#else\nfloat ior=vRefractionMicrosurfaceInfos.w;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nfloat refractionAlphaG=alphaG;\nrefractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nfloat refractionRoughness=alphaG;\nrefractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));\nfloat refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);\n#else\nfloat refractionAlphaG=alphaG;\nrefractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);\nfloat requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nfloat lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));\nfloat lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;\nvec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);\nif (lodRefractionNormalizedDoubled<1.0){\nenvironmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);\n} else {\nenvironmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef SS_RGBDREFRACTION\nenvironmentRefraction.rgb=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nenvironmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);\n#endif\nenvironmentRefraction.rgb*=vRefractionInfos.x;\n#endif\n#ifdef SS_REFRACTION\nvec3 refractionTransmittance=vec3(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);\nrefractionTransmittance*=cocaLambert(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\nfloat maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);\nvec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);\nenvironmentRefraction.rgb*=volumeAlbedo;\n#else\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);\nrefractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\nenvironmentRefraction.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);\n#ifdef REFLECTION\noutParams.refractionFactorForIrradiance=(1.-refractionIntensity);\n#endif\n#ifdef UNUSED_MULTIPLEBOUNCES\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);\noutParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);\n#endif\nrefractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvec3 irradianceVector=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);\n#else\nvec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec3 irradianceCoords=irradianceVector;\n#else\nvec2 irradianceCoords=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);\n#ifdef RGBDREFLECTION\nrefractionIrradiance.rgb=fromRGBD(refractionIrradiance);\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);\n#endif\n#else\nvec4 refractionIrradiance=vec4(0.);\n#endif\nrefractionIrradiance.rgb*=transmittance;\n#ifdef SS_ALBEDOFORTRANSLUCENCYTINT\nrefractionIrradiance.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.refractionIrradiance=refractionIrradiance.rgb;\n#endif\n}\n#endif\n";ii.IncludesShadersStore[Vv]=kv;const Gv="pbrBlockNormalGeometric",zv="vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\nvec3 geometricNormalW=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;\n#endif\n";ii.IncludesShadersStore[Gv]=zv;const Hv="pbrBlockNormalFinal",Xv="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n";ii.IncludesShadersStore[Hv]=Xv;const Wv="pbrBlockLightmapInit",$v="#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor.rgb=toLinearSpace(lightmapColor.rgb);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n";ii.IncludesShadersStore[Wv]=$v;const Yv="pbrBlockGeometryInfo",jv="float NdotVUnclamped=dot(normalW,viewDirectionW);\nfloat NdotV=absEps(NdotVUnclamped);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nvec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\nvec3 environmentBrdf=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=aoOut.ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n";ii.IncludesShadersStore[Yv]=jv;const Kv="pbrBlockReflectance0",qv="float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);\nvec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);\n#else \nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);\n#endif\n#ifdef ALPHAFRESNEL\nfloat reflectance90=fresnelGrazingReflectance(reflectance);\nspecularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n";ii.IncludesShadersStore[Kv]=qv;const Qv="pbrBlockReflectance",Zv="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);\n#ifdef RADIANCEOCCLUSION\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\nvec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\nspecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nspecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n";ii.IncludesShadersStore[Qv]=Zv;const Jv="pbrBlockDirectLighting",tg="vec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvec3 clearCoatBase=vec3(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvec3 sheenBase=vec3(0.,0.,0.);\n#endif\npreLightingInfo preInfo;\nlightingInfo info;\nfloat shadow=1.; \n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvec3 absorption=vec3(0.);\n#endif\n";ii.IncludesShadersStore[Jv]=tg;const ig="pbrBlockFinalLitComponents",eg="#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n#ifdef REFLECTION\nvec3 finalIrradiance=reflectionOut.environmentIrradiance;\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);\nfinalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\nfinalIrradiance*=surfaceAlbedo.rgb;\nfinalIrradiance*=vLightingIntensity.z;\nfinalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;\nfinalSpecular=max(finalSpecular,0.0);\nvec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef REFLECTION\nvec3 finalRadiance=reflectionOut.environmentRadiance.rgb;\nfinalRadiance*=subSurfaceOut.specularEnvironmentReflectance;\nvec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef SHEEN\nvec3 finalSheen=sheenBase*sheenOut.sheenColor;\nfinalSheen=max(finalSheen,0.0);\nvec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef CLEARCOAT\nvec3 finalClearCoat=clearCoatBase;\nfinalClearCoat=max(finalClearCoat,0.0);\nvec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n";ii.IncludesShadersStore[ig]=eg;const sg="pbrBlockFinalUnlitComponents",ng="vec3 finalDiffuse=diffuseBase;\nfinalDiffuse*=surfaceAlbedo.rgb;\nfinalDiffuse=max(finalDiffuse,0.0);\nfinalDiffuse*=vLightingIntensity.x;\nvec3 finalAmbient=vAmbientColor;\nfinalAmbient*=surfaceAlbedo.rgb;\nvec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\n#ifdef GAMMAEMISSIVE\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\n#else\nfinalEmissive*=emissiveColorTex.rgb;\n#endif\nfinalEmissive*= vEmissiveInfos.y;\n#endif\nfinalEmissive*=vLightingIntensity.y;\n#ifdef AMBIENT\nvec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);\n#else\nvec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;\nfinalDiffuse*=ambientOcclusionForDirectDiffuse;\n";ii.IncludesShadersStore[sg]=ng;const rg="pbrBlockFinalColorComposition",hg="vec4 finalColor=vec4(\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalAmbient +\nfinalDiffuse,\nalpha);\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor.rgb;\n#else\nfinalColor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\nfinalColor.rgb+=finalEmissive;\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,0.0);\n";ii.IncludesShadersStore[rg]=hg;const og="pbrBlockImageProcessing",ag="#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)\n#if !defined(SKIPFINALCOLORCLAMP)\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#endif\n#else\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\nfinalColor.rgb*=finalColor.a;\n#endif\n";ii.IncludesShadersStore[og]=ag;const lg="pbrDebug",cg="#if DEBUGMODE>0\nif (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {\n#if DEBUGMODE==1\ngl_FragColor.rgb=vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==2 && defined(NORMAL)\ngl_FragColor.rgb=vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==5\ngl_FragColor.rgb=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==6 && defined(MAINUV1)\ngl_FragColor.rgb=vec3(vMainUV1,0.0);\n#elif DEBUGMODE==7 && defined(MAINUV2)\ngl_FragColor.rgb=vec3(vMainUV2,0.0);\n#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==10 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==11 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==12 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==13 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==20 && defined(ALBEDO)\ngl_FragColor.rgb=albedoTexture.rgb;\n#elif DEBUGMODE==21 && defined(AMBIENT)\ngl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE==22 && defined(OPACITY)\ngl_FragColor.rgb=opacityMap.rgb;\n#elif DEBUGMODE==23 && defined(EMISSIVE)\ngl_FragColor.rgb=emissiveColorTex.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==24 && defined(LIGHTMAP)\ngl_FragColor.rgb=lightmapColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ngl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ngl_FragColor.rgb=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ngl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ngl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;\n#elif DEBUGMODE==40 && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==41 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)\ngl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==50\ngl_FragColor.rgb=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==51 && defined(SPECULARTERM)\ngl_FragColor.rgb=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==52 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==53 && defined(SHEEN)\ngl_FragColor.rgb=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==54 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==60\ngl_FragColor.rgb=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==61\ngl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);\n#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.metallicF0;\n#elif DEBUGMODE==63\ngl_FragColor.rgb=vec3(roughness);\n#elif DEBUGMODE==64\ngl_FragColor.rgb=vec3(alphaG);\n#elif DEBUGMODE==65\ngl_FragColor.rgb=vec3(NdotV);\n#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ngl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==67 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE==68 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ngl_FragColor.rgb=subSurfaceOut.transmittance;\n#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.refractionTransmittance;\n#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)\ngl_FragColor.rgb=vec3(seo);\n#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION)\ngl_FragColor.rgb=vec3(eho);\n#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ngl_FragColor.rgb=vec3(energyConservationFactor);\n#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=specularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)\ngl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==86 && defined(ALPHABLEND)\ngl_FragColor.rgb=vec3(luminanceOverAlpha);\n#elif DEBUGMODE==87\ngl_FragColor.rgb=vec3(alpha);\n#endif\ngl_FragColor.rgb*=vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ngl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ngl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);\n#endif\ngl_FragColor.a=1.0;\n#ifdef PREPASS\ngl_FragData[0]=toLinearSpace(gl_FragColor); \ngl_FragData[1]=vec4(0.,0.,0.,0.); \n#endif\nreturn;\n}\n#endif\n";ii.IncludesShadersStore[lg]=cg;const ug="pbrPixelShader",fg="#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\nprecision highp float;\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<__decl__pbrFragment>\n#include<pbrFragmentExtraDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockIridescence>\n#include<pbrBlockSubSurface>\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\nalbedoOpacityOutParams albedoOpacityOut;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#endif\nalbedoOpacityBlock(\nvAlbedoColor,\n#ifdef ALBEDO\nalbedoTexture,\nvAlbedoInfos,\n#endif\n#ifdef OPACITY\nopacityMap,\nvOpacityInfos,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\nalbedoOpacityOut\n);\nvec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;\nfloat alpha=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nambientOcclusionOutParams aoOut;\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;\n#endif\nambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nvAmbientInfos,\n#endif\naoOut\n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvec3 diffuseBase=vec3(1.,1.,1.);\n#else\nvec3 baseColor=surfaceAlbedo;\nreflectivityOutParams reflectivityOut;\n#if defined(REFLECTIVITY)\nvec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\nvec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\n#ifdef REFLECTIVITY_GAMMA\nsurfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);\n#endif\nsurfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef METALLICWORKFLOW\nvec4 metallicReflectanceFactors=vMetallicReflectanceFactors;\n#ifdef REFLECTANCE\nvec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);\n#ifdef REFLECTANCE_GAMMA\nreflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);\n#endif\nmetallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;\n#endif\n#ifdef METALLIC_REFLECTANCE\nvec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);\n#ifdef METALLIC_REFLECTANCE_GAMMA\nmetallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);\n#endif\n#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY\nmetallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;\n#endif\nmetallicReflectanceFactors*=metallicReflectanceFactorsMap.a;\n#endif\n#endif\nreflectivityBlock(\nvReflectivityColor,\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo,\nmetallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nvReflectivityInfos,\nsurfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor,\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurfaceTexel,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\nreflectivityOut\n);\nfloat microSurface=reflectivityOut.microSurface;\nfloat roughness=reflectivityOut.roughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nalphaFresnelOutParams alphaFresnelOut;\nalphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface,\nalphaFresnelOut\n);\nalpha=alphaFresnelOut.alpha;\n#endif\n#endif\n#include<pbrBlockGeometryInfo>\n#ifdef ANISOTROPIC\nanisotropicOutParams anisotropicOut;\n#ifdef ANISOTROPIC_TEXTURE\nvec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;\n#endif\nanisotropicBlock(\nvAnisotropy,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW,\nanisotropicOut\n);\n#endif\n#ifdef REFLECTION\nreflectionOutParams reflectionOut;\n#ifndef USE_CUSTOM_REFLECTION\nreflectionBlock(\nvPositionW,\nnormalW,\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\nreflectionSampler,\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nvEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nreflectionOut\n);\n#else\n#define CUSTOM_REFLECTION\n#endif\n#endif\n#include<pbrBlockReflectance0>\n#ifdef SHEEN\nsheenOutParams sheenOut;\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;\n#endif\nsheenBlock(\nvSheenColor,\n#ifdef SHEEN_ROUGHNESS\nvSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nsheenMapRoughnessData,\n#endif\n#endif\nroughness,\n#ifdef SHEEN_TEXTURE\nsheenMapData,\nvSheenInfos.y,\n#endif\nreflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nbaseColor,\nsurfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nNdotV,\nenvironmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nAARoughnessFactors,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\nreflectionOut.reflectionCoords,\nNdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nseo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\neho,\n#endif\n#endif\nsheenOut\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;\n#endif\n#endif\n#ifdef IRIDESCENCE\niridescenceOutParams iridescenceOut;\n#ifdef IRIDESCENCE_TEXTURE\nvec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nvec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;\n#endif\niridescenceBlock(\nvIridescenceParams,\nNdotV,\nspecularEnvironmentR0,\n#ifdef IRIDESCENCE_TEXTURE\niridescenceMapData,\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\niridescenceThicknessMapData,\n#endif\n#ifdef CLEARCOAT\nNdotVUnclamped,\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData,\n#endif\n#endif\niridescenceOut\n);\nfloat iridescenceIntensity=iridescenceOut.iridescenceIntensity;\nspecularEnvironmentR0=iridescenceOut.specularEnvironmentR0;\n#endif\nclearcoatOutParams clearcoatOut;\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);\n#endif\n#ifdef CLEARCOAT_BUMP\nvec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatBlock(\nvPositionW,\ngeometricNormalW,\nviewDirectionW,\nvClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatMapRoughnessData,\n#endif\nspecularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nvClearCoatTintParams,\nclearCoatColorAtDistance,\nvClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nclearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nvClearCoatBumpInfos,\nclearCoatBumpMapData,\nvClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nvTBN,\n#else\nvClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nnormalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nfaceNormal,\n#endif\n#ifdef REFLECTION\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nambientMonochrome,\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n(gl_FrontFacing ? 1. : -1.),\n#endif\nclearcoatOut\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n#include<pbrBlockReflectance>\nsubSurfaceOutParams subSurfaceOut;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nvec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nvec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);\n#endif\nsubSurfaceBlock(\nvSubSurfaceIntensity,\nvThicknessParam,\nvTintColor,\nnormalW,\nspecularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nthicknessMap,\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nrefractionIntensityMap,\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\ntranslucencyIntensityMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nreflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionOut.irradianceVector,\n#endif\n#if defined(REALTIME_FILTERING)\nreflectionSampler,\nvReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\nsurfaceAlbedo,\n#endif\n#ifdef SS_REFRACTION\nvPositionW,\nviewDirectionW,\nview,\nvRefractionInfos,\nrefractionMatrix,\nvRefractionMicrosurfaceInfos,\nvLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nNdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nroughness,\n#endif\nalphaG,\nrefractionSampler,\n#ifndef LODBASEDMICROSFURACE\nrefractionSamplerLow,\nrefractionSamplerHigh,\n#endif\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nvRefractionFilteringInfo,\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nvRefractionPosition,\nvRefractionSize,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvDiffusionDistance,\n#endif\nsubSurfaceOut\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#endif\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n#include<pbrBlockFinalLitComponents>\n#endif \n#include<pbrBlockFinalUnlitComponents>\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;\nvec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;\nvec2 velocity=abs(a-b);\nvelocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;\ngl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nvec3 sqAlbedo=sqrt(surfaceAlbedo); \n#endif\n#ifdef PREPASS_IRRADIANCE\nvec3 irradiance=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\n#ifdef SS_SCATTERING\ngl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); \nirradiance/=sqAlbedo;\n#else\ngl_FragData[0]=finalColor; \nfloat scatteringDiffusionProfile=255.;\n#endif\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); \n#else\ngl_FragData[0]=vec4(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_NORMAL\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4((view*vec4(normalW,0.0)).rgb,writeGeometryInfo); \n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#ifndef UNLIT\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toGammaSpace(specularEnvironmentR0),microSurface)*writeGeometryInfo;\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {\nfrontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;\nfrontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);\n} else {\nbackColor+=finalColor;\n}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";ii.ShadersStore[ug]=fg;const dg="pbrVertexDeclaration",pg="uniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY \nuniform vec3 vReflectivityInfos;\nuniform mat4 reflectivityMatrix;\n#endif\n#ifdef METALLIC_REFLECTANCE\nuniform vec2 vMetallicReflectanceInfos;\nuniform mat4 metallicReflectanceMatrix;\n#endif\n#ifdef REFLECTANCE\nuniform vec2 vReflectanceInfos;\nuniform mat4 reflectanceMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\nuniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;\nuniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;\nuniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#ifdef IRIDESCENCE\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;\nuniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;\nuniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;\nuniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;\nuniform mat4 translucencyIntensityMatrix;\n#endif\n#endif\n#ifdef NORMAL\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;\nuniform vec3 vSphericalL1_1;\nuniform vec3 vSphericalL10;\nuniform vec3 vSphericalL11;\nuniform vec3 vSphericalL2_2;\nuniform vec3 vSphericalL2_1;\nuniform vec3 vSphericalL20;\nuniform vec3 vSphericalL21;\nuniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX_ZZ;\nuniform vec3 vSphericalYY_ZZ;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\n#endif\n#endif\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\nuniform mat4 detailMatrix;\n#endif\n#define ADDITIONAL_VERTEX_DECLARATION\n";ii.IncludesShadersStore[dg]=pg;const mg="pbrVertexShader",vg="precision highp float;\n#include<__decl__pbrVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#endif\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nvPositionW=vec3(worldPos);\n#include<prePassVertex>\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));\nvNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvClipSpacePosition=gl_Position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[mg]=vg;class gg extends Wi{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class Sg extends Zl{constructor(t,i=!0){super(t,"PBRClearCoat",100,new gg,i),this.ui=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this.N6=Sg.P6,this.indexOfRefraction=Sg.P6,this.Lb=null,this.texture=null,this.D6=!0,this.useRoughnessFromMainTexture=!0,this.L6=null,this.textureRoughness=null,this.O6=!0,this.remapF0OnInterfaceChange=!0,this.cW=null,this.bumpTexture=null,this.F6=!1,this.isTintEnabled=!1,this.tintColor=_.White(),this.tintColorAtDistance=1,this.tintThickness=1,this.B6=null,this.tintTexture=null,this.sW=t.BR[1]}UR(){this.iW(this.ui),this.sW()}isReadyForSubMesh(t,i,e){if(!this.ui)return!0;const s=this.IT.U6;if(t._l&&i.texturesEnabled){if(this.Lb&&Bo.ClearCoatTextureEnabled&&!this.Lb.isReadyOrNotBlocking())return!1;if(this.L6&&Bo.ClearCoatTextureEnabled&&!this.L6.isReadyOrNotBlocking())return!1;if(e.getCaps().standardDerivatives&&this.cW&&Bo.ClearCoatBumpTextureEnabled&&!s&&!this.cW.isReady())return!1;if(this.F6&&this.B6&&Bo.ClearCoatTintTextureEnabled&&!this.B6.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(t,i){var e;this.ui?(t.CLEARCOAT=!0,t.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this.D6,t.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=null!==this.Lb&&this.Lb.Lb===(null===(e=this.L6)||void 0===e?void 0:e.Lb)&&this.Lb.checkTransformsAreIdentical(this.L6),t.CLEARCOAT_REMAP_F0=this.O6,t._l&&i.texturesEnabled&&(this.Lb&&Bo.ClearCoatTextureEnabled?Fs.PrepareDefinesForMergedUV(this.Lb,t,"CLEARCOAT_TEXTURE"):t.CLEARCOAT_TEXTURE=!1,this.L6&&Bo.ClearCoatTextureEnabled?Fs.PrepareDefinesForMergedUV(this.L6,t,"CLEARCOAT_TEXTURE_ROUGHNESS"):t.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.cW&&Bo.ClearCoatBumpTextureEnabled?Fs.PrepareDefinesForMergedUV(this.cW,t,"CLEARCOAT_BUMP"):t.CLEARCOAT_BUMP=!1,t.CLEARCOAT_DEFAULTIOR=this.N6===Sg.P6,this.F6?(t.CLEARCOAT_TINT=!0,this.B6&&Bo.ClearCoatTintTextureEnabled?(Fs.PrepareDefinesForMergedUV(this.B6,t,"CLEARCOAT_TINT_TEXTURE"),t.CLEARCOAT_TINT_GAMMATEXTURE=this.B6.gammaSpace):t.CLEARCOAT_TINT_TEXTURE=!1):(t.CLEARCOAT_TINT=!1,t.CLEARCOAT_TINT_TEXTURE=!1))):(t.CLEARCOAT=!1,t.CLEARCOAT_TEXTURE=!1,t.CLEARCOAT_TEXTURE_ROUGHNESS=!1,t.CLEARCOAT_BUMP=!1,t.CLEARCOAT_TINT=!1,t.CLEARCOAT_TINT_TEXTURE=!1,t.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,t.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,t.CLEARCOAT_DEFAULTIOR=!1,t.CLEARCOAT_TEXTUREDIRECTUV=0,t.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,t.CLEARCOAT_BUMPDIRECTUV=0,t.CLEARCOAT_REMAP_F0=!1,t.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,t.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(t,i,e,s){var n,r,h,o,a,l,c,u;if(!this.ui)return;const f=s.materialDefines,d=this.IT.isFrozen,p=this.IT.U6,m=this.IT.bW,v=this.IT._W,g=f.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!t.useUbo||!d||!t.isSync){g&&Bo.ClearCoatTextureEnabled?(t.updateFloat4("vClearCoatInfos",this.Lb.coordinatesIndex,this.Lb.level,-1,-1),Fs.BindTextureMatrix(this.Lb,t,"clearCoat")):(this.Lb||this.L6)&&Bo.ClearCoatTextureEnabled&&(t.updateFloat4("vClearCoatInfos",null!==(r=null===(n=this.Lb)||void 0===n?void 0:n.coordinatesIndex)&&void 0!==r?r:0,null!==(o=null===(h=this.Lb)||void 0===h?void 0:h.level)&&void 0!==o?o:0,null!==(l=null===(a=this.L6)||void 0===a?void 0:a.coordinatesIndex)&&void 0!==l?l:0,null!==(u=null===(c=this.L6)||void 0===c?void 0:c.level)&&void 0!==u?u:0),this.Lb&&Fs.BindTextureMatrix(this.Lb,t,"clearCoat"),!this.L6||g||f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE||Fs.BindTextureMatrix(this.L6,t,"clearCoatRoughness")),this.cW&&e.getCaps().standardDerivatives&&Bo.ClearCoatTextureEnabled&&!p&&(t.updateFloat2("vClearCoatBumpInfos",this.cW.coordinatesIndex,this.cW.level),Fs.BindTextureMatrix(this.cW,t,"clearCoatBump"),i.Ag?t.updateFloat2("vClearCoatTangentSpaceParams",m?1:-1,v?1:-1):t.updateFloat2("vClearCoatTangentSpaceParams",m?-1:1,v?-1:1)),this.B6&&Bo.ClearCoatTintTextureEnabled&&(t.updateFloat2("vClearCoatTintInfos",this.B6.coordinatesIndex,this.B6.level),Fs.BindTextureMatrix(this.B6,t,"clearCoatTint")),t.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const s=1-this.N6,d=1+this.N6,S=Math.pow(-s/d,2),E=1/this.N6;t.updateFloat4("vClearCoatRefractionParams",S,E,s,d),this.F6&&(t.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),t.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}i.texturesEnabled&&(this.Lb&&Bo.ClearCoatTextureEnabled&&t.setTexture("clearCoatSampler",this.Lb),this.L6&&!g&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Bo.ClearCoatTextureEnabled&&t.setTexture("clearCoatRoughnessSampler",this.L6),this.cW&&e.getCaps().standardDerivatives&&Bo.ClearCoatBumpTextureEnabled&&!p&&t.setTexture("clearCoatBumpSampler",this.cW),this.F6&&this.B6&&Bo.ClearCoatTintTextureEnabled&&t.setTexture("clearCoatTintSampler",this.B6))}hasTexture(t){return this.Lb===t||(this.L6===t||(this.cW===t||this.B6===t))}getActiveTextures(t){this.Lb&&t.push(this.Lb),this.L6&&t.push(this.L6),this.cW&&t.push(this.cW),this.B6&&t.push(this.B6)}getAnimatables(t){this.Lb&&this.Lb.animations&&this.Lb.animations.length>0&&t.push(this.Lb),this.L6&&this.L6.animations&&this.L6.animations.length>0&&t.push(this.L6),this.cW&&this.cW.animations&&this.cW.animations.length>0&&t.push(this.cW),this.B6&&this.B6.animations&&this.B6.animations.length>0&&t.push(this.B6)}dispose(t){var i,e,s,n;t&&(null===(i=this.Lb)||void 0===i||i.dispose(),null===(e=this.L6)||void 0===e||e.dispose(),null===(s=this.cW)||void 0===s||s.dispose(),null===(n=this.B6)||void 0===n||n.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(t,i,e){return t.CLEARCOAT_BUMP&&i.addFallback(e++,"CLEARCOAT_BUMP"),t.CLEARCOAT_TINT&&i.addFallback(e++,"CLEARCOAT_TINT"),t.CLEARCOAT&&i.addFallback(e++,"CLEARCOAT"),e}getSamplers(t){t.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}Sg.P6=1.5,ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Sg.prototype,"isEnabled",void 0),ut([Q()],Sg.prototype,"intensity",void 0),ut([Q()],Sg.prototype,"roughness",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Sg.prototype,"indexOfRefraction",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Sg.prototype,"texture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Sg.prototype,"useRoughnessFromMainTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Sg.prototype,"textureRoughness",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Sg.prototype,"remapF0OnInterfaceChange",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Sg.prototype,"bumpTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Sg.prototype,"isTintEnabled",void 0),ut([J()],Sg.prototype,"tintColor",void 0),ut([Q()],Sg.prototype,"tintColorAtDistance",void 0),ut([Q()],Sg.prototype,"tintThickness",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Sg.prototype,"tintTexture",void 0);class Eg extends Wi{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0,this.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1}}class Ag extends Zl{constructor(t,i=!0){super(t,"PBRIridescence",110,new Eg,i),this.ui=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=Ag.V6,this.maximumThickness=Ag.k6,this.indexOfRefraction=Ag.P6,this.Lb=null,this.texture=null,this.G6=null,this.thicknessTexture=null,this.sW=t.BR[1]}UR(){this.iW(this.ui),this.sW()}isReadyForSubMesh(t,i){if(!this.ui)return!0;if(t._l&&i.texturesEnabled){if(this.Lb&&Bo.IridescenceTextureEnabled&&!this.Lb.isReadyOrNotBlocking())return!1;if(this.G6&&Bo.IridescenceTextureEnabled&&!this.G6.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(t,i){var e;this.ui?(t.IRIDESCENCE=!0,t.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=null!==this.Lb&&this.Lb.Lb===(null===(e=this.G6)||void 0===e?void 0:e.Lb)&&this.Lb.checkTransformsAreIdentical(this.G6),t._l&&i.texturesEnabled&&(this.Lb&&Bo.IridescenceTextureEnabled?Fs.PrepareDefinesForMergedUV(this.Lb,t,"IRIDESCENCE_TEXTURE"):t.IRIDESCENCE_TEXTURE=!1,!t.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&this.G6&&Bo.IridescenceTextureEnabled?Fs.PrepareDefinesForMergedUV(this.G6,t,"IRIDESCENCE_THICKNESS_TEXTURE"):t.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(t.IRIDESCENCE=!1,t.IRIDESCENCE_TEXTURE=!1,t.IRIDESCENCE_THICKNESS_TEXTURE=!1,t.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1,t.IRIDESCENCE_TEXTUREDIRECTUV=0,t.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(t,i,e,s){var n,r,h,o,a,l,c,u;if(!this.ui)return;const f=s.materialDefines,d=this.IT.isFrozen,p=f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;t.useUbo&&d&&t.isSync||(p&&Bo.IridescenceTextureEnabled?(t.updateFloat4("vIridescenceInfos",this.Lb.coordinatesIndex,this.Lb.level,-1,-1),Fs.BindTextureMatrix(this.Lb,t,"iridescence")):(this.Lb||this.G6)&&Bo.IridescenceTextureEnabled&&(t.updateFloat4("vIridescenceInfos",null!==(r=null===(n=this.Lb)||void 0===n?void 0:n.coordinatesIndex)&&void 0!==r?r:0,null!==(o=null===(h=this.Lb)||void 0===h?void 0:h.level)&&void 0!==o?o:0,null!==(l=null===(a=this.G6)||void 0===a?void 0:a.coordinatesIndex)&&void 0!==l?l:0,null!==(u=null===(c=this.G6)||void 0===c?void 0:c.level)&&void 0!==u?u:0),this.Lb&&Fs.BindTextureMatrix(this.Lb,t,"iridescence"),!this.G6||p||f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE||Fs.BindTextureMatrix(this.G6,t,"iridescenceThickness")),t.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),i.texturesEnabled&&(this.Lb&&Bo.IridescenceTextureEnabled&&t.setTexture("iridescenceSampler",this.Lb),this.G6&&!p&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&Bo.IridescenceTextureEnabled&&t.setTexture("iridescenceThicknessSampler",this.G6))}hasTexture(t){return this.Lb===t||this.G6===t}getActiveTextures(t){this.Lb&&t.push(this.Lb),this.G6&&t.push(this.G6)}getAnimatables(t){this.Lb&&this.Lb.animations&&this.Lb.animations.length>0&&t.push(this.Lb),this.G6&&this.G6.animations&&this.G6.animations.length>0&&t.push(this.G6)}dispose(t){var i,e;t&&(null===(i=this.Lb)||void 0===i||i.dispose(),null===(e=this.G6)||void 0===e||e.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(t,i,e){return t.IRIDESCENCE&&i.addFallback(e++,"IRIDESCENCE"),e}getSamplers(t){t.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}Ag.V6=100,Ag.k6=400,Ag.P6=1.3,ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Ag.prototype,"isEnabled",void 0),ut([Q()],Ag.prototype,"intensity",void 0),ut([Q()],Ag.prototype,"minimumThickness",void 0),ut([Q()],Ag.prototype,"maximumThickness",void 0),ut([Q()],Ag.prototype,"indexOfRefraction",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Ag.prototype,"texture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Ag.prototype,"thicknessTexture",void 0);class Cg extends Wi{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.MAINUV1=!1}}class wg extends Zl{constructor(t,i=!0){super(t,"PBRAnisotropic",110,new Cg,i),this.ui=!1,this.isEnabled=!1,this.intensity=1,this.direction=new C(1,0),this.Lb=null,this.texture=null,this.sW=t.BR[1]}UR(){this.iW(this.ui),this.sW()}isReadyForSubMesh(t,i){return!this.ui||!(t._l&&i.texturesEnabled&&this.Lb&&Bo.AnisotropicTextureEnabled&&!this.Lb.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(t,i,e){this.ui?(t.ANISOTROPIC=this.ui,this.ui&&!e.isVerticesDataPresent(he.TangentKind)&&(t.Bl=!0,t.MAINUV1=!0),t._l&&i.texturesEnabled&&(this.Lb&&Bo.AnisotropicTextureEnabled?Fs.PrepareDefinesForMergedUV(this.Lb,t,"ANISOTROPIC_TEXTURE"):t.ANISOTROPIC_TEXTURE=!1)):(t.ANISOTROPIC=!1,t.ANISOTROPIC_TEXTURE=!1,t.ANISOTROPIC_TEXTUREDIRECTUV=0,t.MAINUV1=!1)}bindForSubMesh(t,i){if(!this.ui)return;const e=this.IT.isFrozen;t.useUbo&&e&&t.isSync||(this.Lb&&Bo.AnisotropicTextureEnabled&&(t.updateFloat2("vAnisotropyInfos",this.Lb.coordinatesIndex,this.Lb.level),Fs.BindTextureMatrix(this.Lb,t,"anisotropy")),t.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),i.texturesEnabled&&this.Lb&&Bo.AnisotropicTextureEnabled&&t.setTexture("anisotropySampler",this.Lb)}hasTexture(t){return this.Lb===t}getActiveTextures(t){this.Lb&&t.push(this.Lb)}getAnimatables(t){this.Lb&&this.Lb.animations&&this.Lb.animations.length>0&&t.push(this.Lb)}dispose(t){t&&this.Lb&&this.Lb.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(t,i,e){return t.ANISOTROPIC&&i.addFallback(e++,"ANISOTROPIC"),e}getSamplers(t){t.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}}ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],wg.prototype,"isEnabled",void 0),ut([Q()],wg.prototype,"intensity",void 0),ut([it()],wg.prototype,"direction",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],wg.prototype,"texture",void 0);class xg extends Wi{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1}}class Tg extends Zl{constructor(t,i=!0){super(t,"Sheen",120,new xg,i),this.ui=!1,this.isEnabled=!1,this.z6=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=_.White(),this.Lb=null,this.texture=null,this.D6=!0,this.useRoughnessFromMainTexture=!0,this.xW=null,this.roughness=null,this.L6=null,this.textureRoughness=null,this.H6=!1,this.albedoScaling=!1,this.sW=t.BR[1]}UR(){this.iW(this.ui),this.sW()}isReadyForSubMesh(t,i){if(!this.ui)return!0;if(t._l&&i.texturesEnabled){if(this.Lb&&Bo.SheenTextureEnabled&&!this.Lb.isReadyOrNotBlocking())return!1;if(this.L6&&Bo.SheenTextureEnabled&&!this.L6.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(t,i){var e;this.ui?(t.SHEEN=!0,t.SHEEN_LINKWITHALBEDO=this.z6,t.SHEEN_ROUGHNESS=null!==this.xW,t.SHEEN_ALBEDOSCALING=this.H6,t.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this.D6,t.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=null!==this.Lb&&this.Lb.Lb===(null===(e=this.L6)||void 0===e?void 0:e.Lb)&&this.Lb.checkTransformsAreIdentical(this.L6),t._l&&i.texturesEnabled&&(this.Lb&&Bo.SheenTextureEnabled?(Fs.PrepareDefinesForMergedUV(this.Lb,t,"SHEEN_TEXTURE"),t.SHEEN_GAMMATEXTURE=this.Lb.gammaSpace):t.SHEEN_TEXTURE=!1,this.L6&&Bo.SheenTextureEnabled?Fs.PrepareDefinesForMergedUV(this.L6,t,"SHEEN_TEXTURE_ROUGHNESS"):t.SHEEN_TEXTURE_ROUGHNESS=!1)):(t.SHEEN=!1,t.SHEEN_TEXTURE=!1,t.SHEEN_TEXTURE_ROUGHNESS=!1,t.SHEEN_LINKWITHALBEDO=!1,t.SHEEN_ROUGHNESS=!1,t.SHEEN_ALBEDOSCALING=!1,t.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,t.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,t.SHEEN_GAMMATEXTURE=!1,t.SHEEN_TEXTUREDIRECTUV=0,t.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(t,i,e,s){var n,r,h,o,a,l,c,u;if(!this.ui)return;const f=s.materialDefines,d=this.IT.isFrozen,p=f.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;t.useUbo&&d&&t.isSync||(p&&Bo.SheenTextureEnabled?(t.updateFloat4("vSheenInfos",this.Lb.coordinatesIndex,this.Lb.level,-1,-1),Fs.BindTextureMatrix(this.Lb,t,"sheen")):(this.Lb||this.L6)&&Bo.SheenTextureEnabled&&(t.updateFloat4("vSheenInfos",null!==(r=null===(n=this.Lb)||void 0===n?void 0:n.coordinatesIndex)&&void 0!==r?r:0,null!==(o=null===(h=this.Lb)||void 0===h?void 0:h.level)&&void 0!==o?o:0,null!==(l=null===(a=this.L6)||void 0===a?void 0:a.coordinatesIndex)&&void 0!==l?l:0,null!==(u=null===(c=this.L6)||void 0===c?void 0:c.level)&&void 0!==u?u:0),this.Lb&&Fs.BindTextureMatrix(this.Lb,t,"sheen"),!this.L6||p||f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE||Fs.BindTextureMatrix(this.L6,t,"sheenRoughness")),t.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),null!==this.xW&&t.updateFloat("vSheenRoughness",this.xW)),i.texturesEnabled&&(this.Lb&&Bo.SheenTextureEnabled&&t.setTexture("sheenSampler",this.Lb),this.L6&&!p&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Bo.SheenTextureEnabled&&t.setTexture("sheenRoughnessSampler",this.L6))}hasTexture(t){return this.Lb===t||this.L6===t}getActiveTextures(t){this.Lb&&t.push(this.Lb),this.L6&&t.push(this.L6)}getAnimatables(t){this.Lb&&this.Lb.animations&&this.Lb.animations.length>0&&t.push(this.Lb),this.L6&&this.L6.animations&&this.L6.animations.length>0&&t.push(this.L6)}dispose(t){var i,e;t&&(null===(i=this.Lb)||void 0===i||i.dispose(),null===(e=this.L6)||void 0===e||e.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(t,i,e){return t.SHEEN&&i.addFallback(e++,"SHEEN"),e}getSamplers(t){t.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Tg.prototype,"isEnabled",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Tg.prototype,"linkSheenWithAlbedo",void 0),ut([Q()],Tg.prototype,"intensity",void 0),ut([J()],Tg.prototype,"color",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Tg.prototype,"texture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Tg.prototype,"useRoughnessFromMainTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Tg.prototype,"roughness",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Tg.prototype,"textureRoughness",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Tg.prototype,"albedoScaling",void 0);class Rg extends Wi{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_SCATTERING=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_MASK_FROM_THICKNESS_TEXTURE=!1,this.SS_USE_GLTF_TEXTURES=!1}}class Ig extends Zl{constructor(t,i=!0){super(t,"PBRSubSurface",130,new Rg,i),this.X6=!1,this.isRefractionEnabled=!1,this.W6=!1,this.isTranslucencyEnabled=!1,this.Y6=!1,this.isScatteringEnabled=!1,this.j6=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this.G6=null,this.thicknessTexture=null,this.fW=null,this.refractionTexture=null,this.N6=1.5,this.indexOfRefraction=1.5,this.K6=-1,this.q6=!1,this.invertRefractionY=!1,this.Q6=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=_.White(),this.tintColorAtDistance=1,this.diffusionDistance=_.White(),this.Z6=!1,this.useMaskFromThicknessTexture=!1,this.J6=null,this.refractionIntensityTexture=null,this.t8=null,this.translucencyIntensityTexture=null,this.i8=!1,this.useGltfStyleTextures=!1,this.Kt=t.getScene(),this.registerForExtraEvents=!0,this.sW=t.BR[1],this.e8=t.BR[32]}get scatteringDiffusionProfile(){return this.Kt.subSurfaceConfiguration?this.Kt.subSurfaceConfiguration.ssDiffusionProfileColors[this.j6]:null}set scatteringDiffusionProfile(t){this.Kt.enableSubSurfaceForPrePass()&&t&&(this.j6=this.Kt.subSurfaceConfiguration.addDiffusionProfile(t))}get volumeIndexOfRefraction(){return this.K6>=1?this.K6:this.N6}set volumeIndexOfRefraction(t){this.K6=t>=1?t:-1}UR(){this.iW(this.X6||this.W6||this.Y6),this.sW()}cI(){this.sW(),this.e8()}isReadyForSubMesh(t,i){if(!this.X6&&!this.W6&&!this.Y6)return!0;if(t._l&&i.texturesEnabled){if(this.G6&&Bo.ThicknessTextureEnabled&&!this.G6.isReadyOrNotBlocking())return!1;const t=this.s8(i);if(t&&Bo.RefractionTextureEnabled&&!t.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(t,i){if(!this.X6&&!this.W6&&!this.Y6)return t.SUBSURFACE=!1,t.SS_TRANSLUCENCY=!1,t.SS_SCATTERING=!1,t.SS_REFRACTION=!1,t.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,t.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,t.SS_THICKNESSANDMASK_TEXTURE=!1,t.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,t.SS_HAS_THICKNESS=!1,t.SS_REFRACTIONINTENSITY_TEXTURE=!1,t.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,t.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,t.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,t.SS_REFRACTIONMAP_3D=!1,t.SS_REFRACTIONMAP_OPPOSITEZ=!1,t.SS_LODINREFRACTIONALPHA=!1,t.SS_GAMMAREFRACTION=!1,t.SS_RGBDREFRACTION=!1,t.SS_LINEARSPECULARREFRACTION=!1,t.SS_LINKREFRACTIONTOTRANSPARENCY=!1,t.SS_ALBEDOFORREFRACTIONTINT=!1,t.SS_ALBEDOFORTRANSLUCENCYTINT=!1,t.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,t.SS_USE_THICKNESS_AS_DEPTH=!1,t.SS_MASK_FROM_THICKNESS_TEXTURE=!1,void(t.SS_USE_GLTF_TEXTURES=!1);if(t._l){t.SUBSURFACE=!0,t.SS_TRANSLUCENCY=this.W6,t.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,t.SS_SCATTERING=this.Y6,t.SS_THICKNESSANDMASK_TEXTURE=!1,t.SS_REFRACTIONINTENSITY_TEXTURE=!1,t.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,t.SS_HAS_THICKNESS=!1,t.SS_MASK_FROM_THICKNESS_TEXTURE=!1,t.SS_USE_GLTF_TEXTURES=!1,t.SS_REFRACTION=!1,t.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,t.SS_REFRACTIONMAP_3D=!1,t.SS_GAMMAREFRACTION=!1,t.SS_RGBDREFRACTION=!1,t.SS_LINEARSPECULARREFRACTION=!1,t.SS_REFRACTIONMAP_OPPOSITEZ=!1,t.SS_LODINREFRACTIONALPHA=!1,t.SS_LINKREFRACTIONTOTRANSPARENCY=!1,t.SS_ALBEDOFORREFRACTIONTINT=!1,t.SS_ALBEDOFORTRANSLUCENCYTINT=!1,t.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,t.SS_USE_THICKNESS_AS_DEPTH=!1;const e=!!this.G6&&!!this.J6&&this.J6.checkTransformsAreIdentical(this.G6)&&this.J6.Lb===this.G6.Lb,s=!!this.G6&&!!this.t8&&this.t8.checkTransformsAreIdentical(this.G6)&&this.t8.Lb===this.G6.Lb,n=(e||!this.J6)&&(s||!this.t8);if(t._l&&i.texturesEnabled&&(this.G6&&Bo.ThicknessTextureEnabled&&Fs.PrepareDefinesForMergedUV(this.G6,t,"SS_THICKNESSANDMASK_TEXTURE"),this.J6&&Bo.RefractionIntensityTextureEnabled&&!n&&Fs.PrepareDefinesForMergedUV(this.J6,t,"SS_REFRACTIONINTENSITY_TEXTURE"),this.t8&&Bo.TranslucencyIntensityTextureEnabled&&!n&&Fs.PrepareDefinesForMergedUV(this.t8,t,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),t.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!=0,t.SS_MASK_FROM_THICKNESS_TEXTURE=(this.Z6||!!this.J6||!!this.t8)&&n,t.SS_USE_GLTF_TEXTURES=this.i8,t.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this.Z6||!!this.J6)&&n,t.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this.Z6||!!this.t8)&&n,this.X6&&i.texturesEnabled){const e=this.s8(i);e&&Bo.RefractionTextureEnabled&&(t.SS_REFRACTION=!0,t.SS_REFRACTIONMAP_3D=e.isCube,t.SS_GAMMAREFRACTION=e.gammaSpace,t.SS_RGBDREFRACTION=e.isRGBD,t.SS_LINEARSPECULARREFRACTION=e.linearSpecularLOD,t.SS_REFRACTIONMAP_OPPOSITEZ=e.invertZ,t.SS_LODINREFRACTIONALPHA=e.lodLevelInAlpha,t.SS_LINKREFRACTIONTOTRANSPARENCY=this.Q6,t.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,t.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=e.isCube&&e.boundingBoxSize,t.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this.W6&&(t.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(t,i,e,s){if(!this.X6&&!this.W6&&!this.Y6)return;s.getRenderingMesh().getWorldMatrix().decompose(M.Vector3[0]);const n=Math.max(Math.abs(M.Vector3[0].x),Math.abs(M.Vector3[0].y),Math.abs(M.Vector3[0].z));t.updateFloat2("vThicknessParam",this.minimumThickness*n,(this.maximumThickness-this.minimumThickness)*n)}bindForSubMesh(t,i,e,s){if(!this.X6&&!this.W6&&!this.Y6)return;const n=s.materialDefines,r=this.IT.isFrozen,h=this.IT.realTimeFiltering,a=n.LODBASEDMICROSFURACE,l=this.s8(i);if(!t.useUbo||!r||!t.isSync){if(this.G6&&Bo.ThicknessTextureEnabled&&(t.updateFloat2("vThicknessInfos",this.G6.coordinatesIndex,this.G6.level),Fs.BindTextureMatrix(this.G6,t,"thickness")),this.J6&&Bo.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&(t.updateFloat2("vRefractionIntensityInfos",this.J6.coordinatesIndex,this.J6.level),Fs.BindTextureMatrix(this.J6,t,"refractionIntensity")),this.t8&&Bo.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(t.updateFloat2("vTranslucencyIntensityInfos",this.t8.coordinatesIndex,this.t8.level),Fs.BindTextureMatrix(this.t8,t,"translucencyIntensity")),l&&Bo.RefractionTextureEnabled){t.updateMatrix("refractionMatrix",l.getReflectionTextureMatrix());let i=1;l.isCube||l.depth&&(i=l.depth);const e=l.getSize().width,s=this.volumeIndexOfRefraction;if(t.updateFloat4("vRefractionInfos",l.level,1/s,i,this.q6?-1:1),t.updateFloat4("vRefractionMicrosurfaceInfos",e,l.lodGenerationScale,l.lodGenerationOffset,1/this.indexOfRefraction),h&&t.updateFloat2("vRefractionFilteringInfo",e,o.Log2(e)),l.boundingBoxSize){const i=l;t.updateVector3("vRefractionPosition",i.boundingBoxPosition),t.updateVector3("vRefractionSize",i.boundingBoxSize)}}this.Y6&&t.updateFloat("scatteringDiffusionProfile",this.j6),t.updateColor3("vDiffusionDistance",this.diffusionDistance),t.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),t.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}i.texturesEnabled&&(this.G6&&Bo.ThicknessTextureEnabled&&t.setTexture("thicknessSampler",this.G6),this.J6&&Bo.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&t.setTexture("refractionIntensitySampler",this.J6),this.t8&&Bo.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&t.setTexture("translucencyIntensitySampler",this.t8),l&&Bo.RefractionTextureEnabled&&(a?t.setTexture("refractionSampler",l):(t.setTexture("refractionSampler",l.pr||l),t.setTexture("refractionSamplerLow",l.mr||l),t.setTexture("refractionSamplerHigh",l.dr||l))))}s8(t){return this.fW?this.fW:this.X6?t.environmentTexture:null}get disableAlphaBlending(){return this.X6&&this.Q6}fillRenderTargetTextures(t){Bo.RefractionTextureEnabled&&this.fW&&this.fW.isRenderTarget&&t.push(this.fW)}hasTexture(t){return this.G6===t||this.fW===t}hasRenderTargetTextures(){return!!(Bo.RefractionTextureEnabled&&this.fW&&this.fW.isRenderTarget)}getActiveTextures(t){this.G6&&t.push(this.G6),this.fW&&t.push(this.fW)}getAnimatables(t){this.G6&&this.G6.animations&&this.G6.animations.length>0&&t.push(this.G6),this.fW&&this.fW.animations&&this.fW.animations.length>0&&t.push(this.fW)}dispose(t){t&&(this.G6&&this.G6.dispose(),this.fW&&this.fW.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(t,i,e){return t.SS_SCATTERING&&i.addFallback(e++,"SS_SCATTERING"),t.SS_TRANSLUCENCY&&i.addFallback(e++,"SS_TRANSLUCENCY"),e}getSamplers(t){t.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"}]}}}ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"isRefractionEnabled",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"isTranslucencyEnabled",void 0),ut([Q(),q("_markScenePrePassDirty")],Ig.prototype,"isScatteringEnabled",void 0),ut([Q()],Ig.prototype,"_scatteringDiffusionProfileIndex",void 0),ut([Q()],Ig.prototype,"refractionIntensity",void 0),ut([Q()],Ig.prototype,"translucencyIntensity",void 0),ut([Q()],Ig.prototype,"useAlbedoToTintRefraction",void 0),ut([Q()],Ig.prototype,"useAlbedoToTintTranslucency",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"thicknessTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"refractionTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"indexOfRefraction",void 0),ut([Q()],Ig.prototype,"_volumeIndexOfRefraction",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"volumeIndexOfRefraction",null),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"invertRefractionY",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"linkRefractionWithTransparency",void 0),ut([Q()],Ig.prototype,"minimumThickness",void 0),ut([Q()],Ig.prototype,"maximumThickness",void 0),ut([Q()],Ig.prototype,"useThicknessAsDepth",void 0),ut([J()],Ig.prototype,"tintColor",void 0),ut([Q()],Ig.prototype,"tintColorAtDistance",void 0),ut([J()],Ig.prototype,"diffusionDistance",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"useMaskFromThicknessTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"refractionIntensityTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"translucencyIntensityTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],Ig.prototype,"useGltfStyleTextures",void 0);const Mg={effect:null,subMesh:null};class bg extends Wi{constructor(t){super(t),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class _g extends Fn{constructor(t,i){super(t,i),this.n8=1,this.r8=1,this.h8=1,this.o8=1,this.a8=new x(this.n8,this.r8,this.h8,this.o8),this.U6=!1,this.l8=null,this.rW=null,this.c8=1,this.u8=_g.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.hW=null,this.oW=null,this.aW=null,this.f8=null,this.d8=null,this.p8=null,this.xW=null,this.m8=1,this.v8=_.White(),this.g8=!1,this.S8=null,this.E8=null,this.A8=null,this.cW=null,this.uW=null,this.C8=new _(0,0,0),this.w8=new _(1,1,1),this.x8=new _(1,1,1),this.T8=new _(1,1,1),this.I8=new _(0,0,0),this.M8=.9,this.TW=!1,this.b8=!0,this._8=!0,this.y8=!1,this.vW=!0,this.N8=!1,this.P8=!0,this.D8=!1,this.L8=!1,this.O8=!1,this.F8=!1,this.B8=!1,this.U8=_g.LIGHTFALLOFF_PHYSICAL,this.V8=!0,this.EW=!1,this.AW=!1,this.wW=!1,this.k8=.05,this.SW=!1,this.MW=4,this.bW=!1,this._W=!1,this.yW=!1,this.G8=.4,this.OR=!1,this.z8=!1,this.H8=!1,this.X8=null,this.W8=!1,this.Y8=!1,this.j8=8,this.K8=!1,this.q8=!1,this.uF=null,this._v=new zi(16),this.PW=new _(0,0,0),this.IL=!1,this.Q8=!1,this.Jy=0,this.debugMode=0,this.Z8=-1,this.J8=1,this.DW=!1,this.brdf=new Xm(this),this.clearCoat=new Sg(this),this.iridescence=new Ag(this),this.anisotropy=new wg(this),this.sheen=new Tg(this),this.subSurface=new Ig(this),this.detailMap=new tc(this),this.$L(null),this.getRenderTargetTextures=()=>(this._v.reset(),Bo.ReflectionTextureEnabled&&this.oW&&this.oW.isRenderTarget&&this._v.push(this.oW),this.IR.renderTargets=this._v,this.LR(this.IR),this._v),this.X8=zm(this.getScene()),this.prePassConfiguration=new Fo}get realTimeFiltering(){return this.Y8}set realTimeFiltering(t){this.Y8=t,this.markAsDirty(1)}get realTimeFilteringQuality(){return this.j8}set realTimeFilteringQuality(t){this.j8=t,this.markAsDirty(1)}get canRenderToMRT(){return!0}$L(t){t!==this.Sg&&(this.Sg&&this.uF&&this.Sg.onUpdateParameters.remove(this.uF),this.Sg=t||this.getScene().imageProcessingConfiguration,this.Sg&&(this.uF=this.Sg.onUpdateParameters.add((()=>{this.fI()}))))}get hasRenderTargetTextures(){return!!(Bo.ReflectionTextureEnabled&&this.oW&&this.oW.isRenderTarget)||this.DW}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get useLogarithmicDepth(){return this.IL}set useLogarithmicDepth(t){this.IL=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported}get KR(){var t;return this.FR===_g.PBRMATERIAL_OPAQUE||this.FR===_g.PBRMATERIAL_ALPHATEST||(null===(t=this.subSurface)||void 0===t?void 0:t.disableAlphaBlending)}needAlphaBlending(){return!this.KR&&(this.alpha<1||null!=this.hW||this.t7())}needAlphaTesting(){var t;return!!this.OR||!(null===(t=this.subSurface)||void 0===t?void 0:t.disableAlphaBlending)&&(this.FW()&&(null==this.FR||this.FR===_g.PBRMATERIAL_ALPHATEST))}t7(){return null!=this.l8&&this.l8.hasAlpha&&this.y8&&this.FR!==_g.PBRMATERIAL_OPAQUE}FW(){return null!=this.l8&&this.l8.hasAlpha||null!=this.hW}getAlphaTestTexture(){return this.l8}isReadyForSubMesh(t,i,e){if(this.RR||this.buildUniformLayout(),i.effect&&this.isFrozen&&i.effect.cs&&i.effect.fs===e)return!0;i.materialDefines||(this.MR(Us.GetDefineNames,this.IR),i.materialDefines=new bg(this.IR.defineNames));const s=i.materialDefines;if(this.oP(i))return!0;const n=this.getScene(),r=n.getEngine();if(s._l&&(this.IR.hasRenderTargetTextures=!1,this.DR(this.IR),this.DW=this.IR.hasRenderTargetTextures,n.texturesEnabled)){if(this.l8&&Bo.DiffuseTextureEnabled&&!this.l8.isReadyOrNotBlocking())return!1;if(this.rW&&Bo.AmbientTextureEnabled&&!this.rW.isReadyOrNotBlocking())return!1;if(this.hW&&Bo.OpacityTextureEnabled&&!this.hW.isReadyOrNotBlocking())return!1;const t=this.i7();if(t&&Bo.ReflectionTextureEnabled){if(!t.isReadyOrNotBlocking())return!1;if(t.irradianceTexture&&!t.irradianceTexture.isReadyOrNotBlocking())return!1}if(this.uW&&Bo.LightmapTextureEnabled&&!this.uW.isReadyOrNotBlocking())return!1;if(this.aW&&Bo.EmissiveTextureEnabled&&!this.aW.isReadyOrNotBlocking())return!1;if(Bo.SpecularTextureEnabled){if(this.d8){if(!this.d8.isReadyOrNotBlocking())return!1}else if(this.f8&&!this.f8.isReadyOrNotBlocking())return!1;if(this.S8&&!this.S8.isReadyOrNotBlocking())return!1;if(this.E8&&!this.E8.isReadyOrNotBlocking())return!1;if(this.A8&&!this.A8.isReadyOrNotBlocking())return!1}if(r.getCaps().standardDerivatives&&this.cW&&Bo.BumpTextureEnabled&&!this.U6&&!this.cW.isReady())return!1;if(this.X8&&Bo.ReflectionTextureEnabled&&!this.X8.isReady())return!1}if(this.IR.isReadyForSubMesh=!0,this.IR.defines=s,this.bR(this.IR),!this.IR.isReadyForSubMesh)return!1;if(s.Dl&&this.Sg&&!this.Sg.isReady())return!1;r.getCaps().standardDerivatives||t.isVerticesDataPresent(he.NormalKind)||(t.createNormals(!0),F.Warn("PBRMaterial: Normals have been created for the mesh: "+t.name));const h=i.effect,o=s.Ml;let a=this.Ks(t,s,this.onCompiled,this.onError,e,null,i.getRenderingMesh().hasThinInstances),l=!1;if(a)if(this.$R&&(Mg.effect=a,Mg.subMesh=i,this.$R.notifyObservers(Mg)),this.allowShaderHotSwapping&&h&&!a.isReady()){if(a=h,s.markAsUnprocessed(),l=this.isFrozen,o)return s.Ml=!0,!1}else n.resetCachedMaterial(),i.setEffect(a,s,this.WR);return!(!i.effect||!i.effect.isReady())&&(s.Sv=n.getRenderId(),i.effect.cs=!l,i.effect.fs=!!e,n.performancePriority!==Fe.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}isMetallicWorkflow(){return!(null==this.p8&&null==this.xW&&!this.d8)}Ks(t,i,e=null,s=null,n=null,r=null,h){if(this.e7(t,i,n,r,h),!i.isDirty)return null;i.markAsProcessed();const o=this.getScene().getEngine(),a=new Jn;let l=0;i.USESPHERICALINVERTEX&&a.addFallback(l++,"USESPHERICALINVERTEX"),i.FOG&&a.addFallback(l,"FOG"),i.SPECULARAA&&a.addFallback(l,"SPECULARAA"),i.POINTSIZE&&a.addFallback(l,"POINTSIZE"),i.LOGARITHMICDEPTH&&a.addFallback(l,"LOGARITHMICDEPTH"),i.PARALLAX&&a.addFallback(l,"PARALLAX"),i.PARALLAXOCCLUSION&&a.addFallback(l++,"PARALLAXOCCLUSION"),i.ENVIRONMENTBRDF&&a.addFallback(l++,"ENVIRONMENTBRDF"),i.TANGENT&&a.addFallback(l++,"TANGENT"),i.BUMP&&a.addFallback(l++,"BUMP"),l=Fs.HandleFallbacksForShadows(i,a,this.MW,l++),i.SPECULARTERM&&a.addFallback(l++,"SPECULARTERM"),i.USESPHERICALFROMREFLECTIONMAP&&a.addFallback(l++,"USESPHERICALFROMREFLECTIONMAP"),i.USEIRRADIANCEMAP&&a.addFallback(l++,"USEIRRADIANCEMAP"),i.LIGHTMAP&&a.addFallback(l++,"LIGHTMAP"),i.NORMAL&&a.addFallback(l++,"NORMAL"),i.AMBIENT&&a.addFallback(l++,"AMBIENT"),i.EMISSIVE&&a.addFallback(l++,"EMISSIVE"),i.VERTEXCOLOR&&a.addFallback(l++,"VERTEXCOLOR"),i.MORPHTARGETS&&a.addFallback(l++,"MORPHTARGETS"),i.MULTIVIEW&&a.addFallback(0,"MULTIVIEW");const c=[he.PositionKind];i.NORMAL&&c.push(he.NormalKind),i.TANGENT&&c.push(he.TangentKind);for(let t=1;t<=6;++t)i["UV"+t]&&c.push(`uv${1===t?"":t}`);i.VERTEXCOLOR&&c.push(he.ColorKind),i.INSTANCESCOLOR&&c.push(he.ColorInstanceKind),Fs.PrepareAttributesForBones(c,t,i,a),Fs.PrepareAttributesForInstances(c,i),Fs.PrepareAttributesForMorphTargets(c,t,i),Fs.PrepareAttributesForBakedVertexAnimation(c,t,i);let u="pbr";const f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],d=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],p=["Material","Scene","Mesh"];this.IR.fallbacks=a,this.IR.fallbackRank=l,this.IR.defines=i,this.IR.uniforms=f,this.IR.attributes=c,this.IR.samplers=d,this.IR.uniformBuffersNames=p,this.IR.customCode=void 0,this.IR.mesh=t,this.MR(Us.PrepareEffect,this.IR),Fo.AddUniforms(f),Fo.AddSamplers(d),Ns(f),ji&&(ji.PrepareUniforms(f,i),ji.PrepareSamplers(d,i)),Fs.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:p,samplers:d,defines:i,maxSimultaneousLights:this.MW});const m={};this.customShaderNameResolve&&(u=this.customShaderNameResolve(u,f,p,d,i,c,m));const v=i.toString(),g=o.createEffect(u,{attributes:c,uniformsNames:f,uniformBuffersNames:p,samplers:d,defines:v,fallbacks:a,onCompiled:e,onError:s,indexParameters:{maxSimultaneousLights:this.MW,maxSimultaneousMorphTargets:i.NUM_MORPH_INFLUENCERS},processFinalCode:m.processFinalCode,processCodeAfterIncludes:this.IR.customCode,multiTarget:i.PREPASS},o);return this.IR.customCode=void 0,g}e7(t,i,e=null,s=null,n=!1){var r;const h=this.getScene(),o=h.getEngine();Fs.PrepareDefinesForLights(h,t,i,!0,this.MW,this.SW),i.Fl=!0,Fs.PrepareDefinesForMultiview(h,i);const a=this.needAlphaBlendingForMesh(t)&&this.getScene().useOrderIndependentTransparency;if(Fs.PrepareDefinesForPrePass(h,i,this.canRenderToMRT&&!a),Fs.PrepareDefinesForOIT(h,i,a),i.METALLICWORKFLOW=this.isMetallicWorkflow(),i._l){if(i.Bl=!1,h.texturesEnabled){i.ALBEDODIRECTUV=0,i.AMBIENTDIRECTUV=0,i.OPACITYDIRECTUV=0,i.EMISSIVEDIRECTUV=0,i.REFLECTIVITYDIRECTUV=0,i.MICROSURFACEMAPDIRECTUV=0,i.METALLIC_REFLECTANCEDIRECTUV=0,i.REFLECTANCEDIRECTUV=0,i.BUMPDIRECTUV=0,i.LIGHTMAPDIRECTUV=0,o.getCaps().textureLOD&&(i.LODBASEDMICROSFURACE=!0),this.l8&&Bo.DiffuseTextureEnabled?(Fs.PrepareDefinesForMergedUV(this.l8,i,"ALBEDO"),i.GAMMAALBEDO=this.l8.gammaSpace):i.ALBEDO=!1,this.rW&&Bo.AmbientTextureEnabled?(Fs.PrepareDefinesForMergedUV(this.rW,i,"AMBIENT"),i.AMBIENTINGRAYSCALE=this.F8):i.AMBIENT=!1,this.hW&&Bo.OpacityTextureEnabled?(Fs.PrepareDefinesForMergedUV(this.hW,i,"OPACITY"),i.OPACITYRGB=this.hW.getAlphaFromRGB):i.OPACITY=!1;const t=this.i7();if(t&&Bo.ReflectionTextureEnabled){switch(i.REFLECTION=!0,i.GAMMAREFLECTION=t.gammaSpace,i.RGBDREFLECTION=t.isRGBD,i.LODINREFLECTIONALPHA=t.lodLevelInAlpha,i.LINEARSPECULARREFLECTION=t.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(i.NUM_SAMPLES=""+this.realTimeFilteringQuality,o.hs.needTypeSuffixInShaderConstants&&(i.NUM_SAMPLES=i.NUM_SAMPLES+"u"),i.REALTIME_FILTERING=!0):i.REALTIME_FILTERING=!1,t.coordinatesMode===an.INVCUBIC_MODE&&(i.INVERTCUBICMAP=!0),i.REFLECTIONMAP_3D=t.isCube,i.REFLECTIONMAP_OPPOSITEZ=i.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!t.invertZ:t.invertZ,i.REFLECTIONMAP_CUBIC=!1,i.REFLECTIONMAP_EXPLICIT=!1,i.REFLECTIONMAP_PLANAR=!1,i.REFLECTIONMAP_PROJECTION=!1,i.REFLECTIONMAP_SKYBOX=!1,i.REFLECTIONMAP_SPHERICAL=!1,i.REFLECTIONMAP_EQUIRECTANGULAR=!1,i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.coordinatesMode){case an.EXPLICIT_MODE:i.REFLECTIONMAP_EXPLICIT=!0;break;case an.PLANAR_MODE:i.REFLECTIONMAP_PLANAR=!0;break;case an.PROJECTION_MODE:i.REFLECTIONMAP_PROJECTION=!0;break;case an.SKYBOX_MODE:i.REFLECTIONMAP_SKYBOX=!0;break;case an.SPHERICAL_MODE:i.REFLECTIONMAP_SPHERICAL=!0;break;case an.EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case an.FIXED_EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case an.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case an.CUBIC_MODE:case an.INVCUBIC_MODE:default:i.REFLECTIONMAP_CUBIC=!0,i.USE_LOCAL_REFLECTIONMAP_CUBIC=!!t.boundingBoxSize}t.coordinatesMode!==an.SKYBOX_MODE&&(t.irradianceTexture?(i.USEIRRADIANCEMAP=!0,i.USESPHERICALFROMREFLECTIONMAP=!1):t.isCube&&(i.USESPHERICALFROMREFLECTIONMAP=!0,i.USEIRRADIANCEMAP=!1,this.W8||this.realTimeFiltering||o.getCaps().maxVaryingVectors<=8?i.USESPHERICALINVERTEX=!1:i.USESPHERICALINVERTEX=!0))}else i.REFLECTION=!1,i.REFLECTIONMAP_3D=!1,i.REFLECTIONMAP_SPHERICAL=!1,i.REFLECTIONMAP_PLANAR=!1,i.REFLECTIONMAP_CUBIC=!1,i.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,i.REFLECTIONMAP_PROJECTION=!1,i.REFLECTIONMAP_SKYBOX=!1,i.REFLECTIONMAP_EXPLICIT=!1,i.REFLECTIONMAP_EQUIRECTANGULAR=!1,i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,i.INVERTCUBICMAP=!1,i.USESPHERICALFROMREFLECTIONMAP=!1,i.USEIRRADIANCEMAP=!1,i.USESPHERICALINVERTEX=!1,i.REFLECTIONMAP_OPPOSITEZ=!1,i.LODINREFLECTIONALPHA=!1,i.GAMMAREFLECTION=!1,i.RGBDREFLECTION=!1,i.LINEARSPECULARREFLECTION=!1;if(this.uW&&Bo.LightmapTextureEnabled?(Fs.PrepareDefinesForMergedUV(this.uW,i,"LIGHTMAP"),i.USELIGHTMAPASSHADOWMAP=this.TW,i.GAMMALIGHTMAP=this.uW.gammaSpace,i.RGBDLIGHTMAP=this.uW.isRGBD):i.LIGHTMAP=!1,this.aW&&Bo.EmissiveTextureEnabled?(Fs.PrepareDefinesForMergedUV(this.aW,i,"EMISSIVE"),i.GAMMAEMISSIVE=this.aW.gammaSpace):i.EMISSIVE=!1,Bo.SpecularTextureEnabled){if(this.d8?(Fs.PrepareDefinesForMergedUV(this.d8,i,"REFLECTIVITY"),i.ROUGHNESSSTOREINMETALMAPALPHA=this.P8,i.ROUGHNESSSTOREINMETALMAPGREEN=!this.P8&&this.D8,i.METALLNESSSTOREINMETALMAPBLUE=this.L8,i.AOSTOREINMETALMAPRED=this.O8,i.REFLECTIVITY_GAMMA=!1):this.f8?(Fs.PrepareDefinesForMergedUV(this.f8,i,"REFLECTIVITY"),i.MICROSURFACEFROMREFLECTIVITYMAP=this.N8,i.MICROSURFACEAUTOMATIC=this.B8,i.REFLECTIVITY_GAMMA=this.f8.gammaSpace):i.REFLECTIVITY=!1,this.S8||this.E8){const t=null!==this.S8&&this.S8.Lb===(null===(r=this.E8)||void 0===r?void 0:r.Lb)&&this.S8.checkTransformsAreIdentical(this.E8);i.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this.g8&&!t,this.S8?(Fs.PrepareDefinesForMergedUV(this.S8,i,"METALLIC_REFLECTANCE"),i.METALLIC_REFLECTANCE_GAMMA=this.S8.gammaSpace):i.METALLIC_REFLECTANCE=!1,this.E8&&!t&&(!this.S8||this.S8&&this.g8)?(Fs.PrepareDefinesForMergedUV(this.E8,i,"REFLECTANCE"),i.REFLECTANCE_GAMMA=this.E8.gammaSpace):i.REFLECTANCE=!1}else i.METALLIC_REFLECTANCE=!1,i.REFLECTANCE=!1;this.A8?Fs.PrepareDefinesForMergedUV(this.A8,i,"MICROSURFACEMAP"):i.MICROSURFACEMAP=!1}else i.REFLECTIVITY=!1,i.MICROSURFACEMAP=!1;o.getCaps().standardDerivatives&&this.cW&&Bo.BumpTextureEnabled&&!this.U6?(Fs.PrepareDefinesForMergedUV(this.cW,i,"BUMP"),this.AW&&this.l8&&Bo.DiffuseTextureEnabled?(i.PARALLAX=!0,i.PARALLAXOCCLUSION=!!this.wW):i.PARALLAX=!1,i.OBJECTSPACE_NORMALMAP=this.EW):(i.BUMP=!1,i.PARALLAX=!1,i.PARALLAXOCCLUSION=!1,i.OBJECTSPACE_NORMALMAP=!1),this.X8&&Bo.ReflectionTextureEnabled?(i.ENVIRONMENTBRDF=!0,i.ENVIRONMENTBRDF_RGBD=this.X8.isRGBD):(i.ENVIRONMENTBRDF=!1,i.ENVIRONMENTBRDF_RGBD=!1),this.t7()?i.ALPHAFROMALBEDO=!0:i.ALPHAFROMALBEDO=!1}i.SPECULAROVERALPHA=this.vW,this.U8===_g.LIGHTFALLOFF_STANDARD?(i.USEPHYSICALLIGHTFALLOFF=!1,i.USEGLTFLIGHTFALLOFF=!1):this.U8===_g.LIGHTFALLOFF_GLTF?(i.USEPHYSICALLIGHTFALLOFF=!1,i.USEGLTFLIGHTFALLOFF=!0):(i.USEPHYSICALLIGHTFALLOFF=!0,i.USEGLTFLIGHTFALLOFF=!1),i.RADIANCEOVERALPHA=this.V8,!this.backFaceCulling&&this.yW?i.TWOSIDEDLIGHTING=!0:i.TWOSIDEDLIGHTING=!1,i.SPECULARAA=o.getCaps().standardDerivatives&&this.q8}(i._l||i.Nl)&&(i.ALPHATESTVALUE=`${this.G8}${this.G8%1==0?".":""}`,i.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,i.ALPHABLEND=this.needAlphaBlendingForMesh(t),i.ALPHAFRESNEL=this.z8||this.H8,i.LINEARALPHAFRESNEL=this.H8),i.Dl&&this.Sg&&this.Sg.prepareDefines(i),i.FORCENORMALFORWARD=this.K8,i.RADIANCEOCCLUSION=this._8,i.HORIZONOCCLUSION=this.b8,i.Nl&&(Fs.PrepareDefinesForMisc(t,h,this.IL,this.pointsCloud,this.fogEnabled,this.qR(t)||this.OR,i),i.UNLIT=this.Q8||(this.pointsCloud||this.wireframe)&&!t.isVerticesDataPresent(he.NormalKind),i.DEBUGMODE=this.Jy),Fs.PrepareDefinesForFrameBoundValues(h,o,this,i,!!e,s,n),this.IR.defines=i,this.IR.mesh=t,this.yR(this.IR),Fs.PrepareDefinesForAttributes(t,i,!0,!0,!0,this.FR!==_g.PBRMATERIAL_OPAQUE),this._R(this.IR)}forceCompilation(t,i,e){const s={clipPlane:!1,useInstances:!1,...e};this.RR||this.buildUniformLayout(),this.MR(Us.GetDefineNames,this.IR);const n=new bg(this.IR.defineNames),r=this.Ks(t,n,void 0,void 0,s.useInstances,s.clipPlane,t.hasThinInstances);this.$R&&(Mg.effect=r,Mg.subMesh=null,this.$R.notifyObservers(Mg)),r.isReady()?i&&i(this):r.onCompileObservable.add((()=>{i&&i(this)}))}buildUniformLayout(){const t=this.VT;t.addUniform("vAlbedoInfos",2),t.addUniform("vAmbientInfos",4),t.addUniform("vOpacityInfos",2),t.addUniform("vEmissiveInfos",2),t.addUniform("vLightmapInfos",2),t.addUniform("vReflectivityInfos",3),t.addUniform("vMicroSurfaceSamplerInfos",2),t.addUniform("vReflectionInfos",2),t.addUniform("vReflectionFilteringInfo",2),t.addUniform("vReflectionPosition",3),t.addUniform("vReflectionSize",3),t.addUniform("vBumpInfos",3),t.addUniform("albedoMatrix",16),t.addUniform("ambientMatrix",16),t.addUniform("opacityMatrix",16),t.addUniform("emissiveMatrix",16),t.addUniform("lightmapMatrix",16),t.addUniform("reflectivityMatrix",16),t.addUniform("microSurfaceSamplerMatrix",16),t.addUniform("bumpMatrix",16),t.addUniform("vTangentSpaceParams",2),t.addUniform("reflectionMatrix",16),t.addUniform("vReflectionColor",3),t.addUniform("vAlbedoColor",4),t.addUniform("vLightingIntensity",4),t.addUniform("vReflectionMicrosurfaceInfos",3),t.addUniform("pointSize",1),t.addUniform("vReflectivityColor",4),t.addUniform("vEmissiveColor",3),t.addUniform("vAmbientColor",3),t.addUniform("vDebugMode",2),t.addUniform("vMetallicReflectanceFactors",4),t.addUniform("vMetallicReflectanceInfos",2),t.addUniform("metallicReflectanceMatrix",16),t.addUniform("vReflectanceInfos",2),t.addUniform("reflectanceMatrix",16),t.addUniform("vSphericalL00",3),t.addUniform("vSphericalL1_1",3),t.addUniform("vSphericalL10",3),t.addUniform("vSphericalL11",3),t.addUniform("vSphericalL2_2",3),t.addUniform("vSphericalL2_1",3),t.addUniform("vSphericalL20",3),t.addUniform("vSphericalL21",3),t.addUniform("vSphericalL22",3),t.addUniform("vSphericalX",3),t.addUniform("vSphericalY",3),t.addUniform("vSphericalZ",3),t.addUniform("vSphericalXX_ZZ",3),t.addUniform("vSphericalYY_ZZ",3),t.addUniform("vSphericalZZ",3),t.addUniform("vSphericalXY",3),t.addUniform("vSphericalYZ",3),t.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(t,i,e){var s,n,r,h;const a=this.getScene(),l=e.materialDefines;if(!l)return;const c=e.effect;if(!c)return;this.hP=c,i.getMeshUniformBuffer().bindToEffect(c,"Mesh"),i.transferToEffect(t);const u=a.getEngine();this.VT.bindToEffect(c,"Material"),this.prePassConfiguration.bindForSubMesh(this.hP,a,i,t,this.isFrozen),this.IR.subMesh=e,this.NR(this.IR),l.OBJECTSPACE_NORMALMAP&&(t.toNormalMatrix(this.rP),this.bindOnlyNormalMatrix(this.rP));const f=c.us||this.aP(a,c,i.visibility);Fs.BindBonesParameters(i,this.hP,this.prePassConfiguration);let d=null;const p=this.VT;if(f){if(this.bindViewProjection(c),d=this.i7(),!p.useUbo||!this.isFrozen||!p.isSync||c.us){if(a.texturesEnabled){if(this.l8&&Bo.DiffuseTextureEnabled&&(p.updateFloat2("vAlbedoInfos",this.l8.coordinatesIndex,this.l8.level),Fs.BindTextureMatrix(this.l8,p,"albedo")),this.rW&&Bo.AmbientTextureEnabled&&(p.updateFloat4("vAmbientInfos",this.rW.coordinatesIndex,this.rW.level,this.c8,this.u8),Fs.BindTextureMatrix(this.rW,p,"ambient")),this.hW&&Bo.OpacityTextureEnabled&&(p.updateFloat2("vOpacityInfos",this.hW.coordinatesIndex,this.hW.level),Fs.BindTextureMatrix(this.hW,p,"opacity")),d&&Bo.ReflectionTextureEnabled){if(p.updateMatrix("reflectionMatrix",d.getReflectionTextureMatrix()),p.updateFloat2("vReflectionInfos",d.level,0),d.boundingBoxSize){const t=d;p.updateVector3("vReflectionPosition",t.boundingBoxPosition),p.updateVector3("vReflectionSize",t.boundingBoxSize)}if(this.realTimeFiltering){const t=d.getSize().width;p.updateFloat2("vReflectionFilteringInfo",t,o.Log2(t))}if(!l.USEIRRADIANCEMAP){const t=d.sphericalPolynomial;if(l.USESPHERICALFROMREFLECTIONMAP&&t)if(l.SPHERICAL_HARMONICS){const i=t.preScaledHarmonics;p.updateVector3("vSphericalL00",i.l00),p.updateVector3("vSphericalL1_1",i.l1_1),p.updateVector3("vSphericalL10",i.l10),p.updateVector3("vSphericalL11",i.l11),p.updateVector3("vSphericalL2_2",i.l2_2),p.updateVector3("vSphericalL2_1",i.l2_1),p.updateVector3("vSphericalL20",i.l20),p.updateVector3("vSphericalL21",i.l21),p.updateVector3("vSphericalL22",i.l22)}else p.updateFloat3("vSphericalX",t.x.x,t.x.y,t.x.z),p.updateFloat3("vSphericalY",t.y.x,t.y.y,t.y.z),p.updateFloat3("vSphericalZ",t.z.x,t.z.y,t.z.z),p.updateFloat3("vSphericalXX_ZZ",t.xx.x-t.zz.x,t.xx.y-t.zz.y,t.xx.z-t.zz.z),p.updateFloat3("vSphericalYY_ZZ",t.yy.x-t.zz.x,t.yy.y-t.zz.y,t.yy.z-t.zz.z),p.updateFloat3("vSphericalZZ",t.zz.x,t.zz.y,t.zz.z),p.updateFloat3("vSphericalXY",t.xy.x,t.xy.y,t.xy.z),p.updateFloat3("vSphericalYZ",t.yz.x,t.yz.y,t.yz.z),p.updateFloat3("vSphericalZX",t.zx.x,t.zx.y,t.zx.z)}p.updateFloat3("vReflectionMicrosurfaceInfos",d.getSize().width,d.lodGenerationScale,d.lodGenerationOffset)}this.aW&&Bo.EmissiveTextureEnabled&&(p.updateFloat2("vEmissiveInfos",this.aW.coordinatesIndex,this.aW.level),Fs.BindTextureMatrix(this.aW,p,"emissive")),this.uW&&Bo.LightmapTextureEnabled&&(p.updateFloat2("vLightmapInfos",this.uW.coordinatesIndex,this.uW.level),Fs.BindTextureMatrix(this.uW,p,"lightmap")),Bo.SpecularTextureEnabled&&(this.d8?(p.updateFloat3("vReflectivityInfos",this.d8.coordinatesIndex,this.d8.level,this.c8),Fs.BindTextureMatrix(this.d8,p,"reflectivity")):this.f8&&(p.updateFloat3("vReflectivityInfos",this.f8.coordinatesIndex,this.f8.level,1),Fs.BindTextureMatrix(this.f8,p,"reflectivity")),this.S8&&(p.updateFloat2("vMetallicReflectanceInfos",this.S8.coordinatesIndex,this.S8.level),Fs.BindTextureMatrix(this.S8,p,"metallicReflectance")),this.E8&&l.REFLECTANCE&&(p.updateFloat2("vReflectanceInfos",this.E8.coordinatesIndex,this.E8.level),Fs.BindTextureMatrix(this.E8,p,"reflectance")),this.A8&&(p.updateFloat2("vMicroSurfaceSamplerInfos",this.A8.coordinatesIndex,this.A8.level),Fs.BindTextureMatrix(this.A8,p,"microSurfaceSampler"))),this.cW&&u.getCaps().standardDerivatives&&Bo.BumpTextureEnabled&&!this.U6&&(p.updateFloat3("vBumpInfos",this.cW.coordinatesIndex,this.cW.level,this.k8),Fs.BindTextureMatrix(this.cW,p,"bump"),a.Ag?p.updateFloat2("vTangentSpaceParams",this.bW?1:-1,this._W?1:-1):p.updateFloat2("vTangentSpaceParams",this.bW?-1:1,this._W?-1:1))}if(this.pointsCloud&&p.updateFloat("pointSize",this.pointSize),l.METALLICWORKFLOW){N.Color3[0].r=void 0===this.p8||null===this.p8?1:this.p8,N.Color3[0].g=void 0===this.xW||null===this.xW?1:this.xW,p.updateColor4("vReflectivityColor",N.Color3[0],1);const t=null!==(n=null===(s=this.subSurface)||void 0===s?void 0:s.N6)&&void 0!==n?n:1.5,i=1,e=Math.pow((t-i)/(t+i),2);this.v8.scaleToRef(e*this.m8,N.Color3[0]);const r=this.m8;p.updateColor4("vMetallicReflectanceFactors",N.Color3[0],r)}else p.updateColor4("vReflectivityColor",this.x8,this.M8);p.updateColor3("vEmissiveColor",Bo.EmissiveTextureEnabled?this.I8:_.BlackReadOnly),p.updateColor3("vReflectionColor",this.T8),!l.SS_REFRACTION&&(null===(r=this.subSurface)||void 0===r?void 0:r.Q6)?p.updateColor4("vAlbedoColor",this.w8,1):p.updateColor4("vAlbedoColor",this.w8,this.alpha),this.a8.x=this.n8,this.a8.y=this.r8,this.a8.z=this.h8*a.environmentIntensity,this.a8.w=this.o8,p.updateVector4("vLightingIntensity",this.a8),a.ambientColor.multiplyToRef(this.C8,this.PW),p.updateColor3("vAmbientColor",this.PW),p.updateFloat2("vDebugMode",this.Z8,this.J8)}a.texturesEnabled&&(this.l8&&Bo.DiffuseTextureEnabled&&p.setTexture("albedoSampler",this.l8),this.rW&&Bo.AmbientTextureEnabled&&p.setTexture("ambientSampler",this.rW),this.hW&&Bo.OpacityTextureEnabled&&p.setTexture("opacitySampler",this.hW),d&&Bo.ReflectionTextureEnabled&&(l.LODBASEDMICROSFURACE?p.setTexture("reflectionSampler",d):(p.setTexture("reflectionSampler",d.pr||d),p.setTexture("reflectionSamplerLow",d.mr||d),p.setTexture("reflectionSamplerHigh",d.dr||d)),l.USEIRRADIANCEMAP&&p.setTexture("irradianceSampler",d.irradianceTexture)),l.ENVIRONMENTBRDF&&p.setTexture("environmentBrdfSampler",this.X8),this.aW&&Bo.EmissiveTextureEnabled&&p.setTexture("emissiveSampler",this.aW),this.uW&&Bo.LightmapTextureEnabled&&p.setTexture("lightmapSampler",this.uW),Bo.SpecularTextureEnabled&&(this.d8?p.setTexture("reflectivitySampler",this.d8):this.f8&&p.setTexture("reflectivitySampler",this.f8),this.S8&&p.setTexture("metallicReflectanceSampler",this.S8),this.E8&&l.REFLECTANCE&&p.setTexture("reflectanceSampler",this.E8),this.A8&&p.setTexture("microSurfaceSampler",this.A8)),this.cW&&u.getCaps().standardDerivatives&&Bo.BumpTextureEnabled&&!this.U6&&p.setTexture("bumpSampler",this.cW)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(i)&&this.getScene().depthPeelingRenderer.bind(c),this.IR.subMesh=e,this.PR(this.IR),Ds(this.hP,this,a),this.bindEyePosition(c)}else a.getEngine().hs.needToAlwaysBindUniformBuffers&&(this.JR=!0);!f&&this.isFrozen||(a.lightsEnabled&&!this.SW&&Fs.BindLights(a,i,this.hP,l,this.MW),(a.fogEnabled&&i.applyFog&&a.fogMode!==ke.FOGMODE_NONE||d||i.receiveShadows||l.PREPASS)&&this.bindView(c),Fs.BindFogParameters(a,i,this.hP,!0),l.NUM_MORPH_INFLUENCERS&&Fs.BindMorphTargetParameters(i,this.hP),l.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(h=i.bakedVertexAnimationManager)||void 0===h||h.bind(c,l.INSTANCES)),this.Sg.bind(this.hP),Fs.BindLogDepth(l,this.hP,a)),this.tI(i,this.hP),p.update()}getAnimatables(){const t=super.getAnimatables();return this.l8&&this.l8.animations&&this.l8.animations.length>0&&t.push(this.l8),this.rW&&this.rW.animations&&this.rW.animations.length>0&&t.push(this.rW),this.hW&&this.hW.animations&&this.hW.animations.length>0&&t.push(this.hW),this.oW&&this.oW.animations&&this.oW.animations.length>0&&t.push(this.oW),this.aW&&this.aW.animations&&this.aW.animations.length>0&&t.push(this.aW),this.d8&&this.d8.animations&&this.d8.animations.length>0?t.push(this.d8):this.f8&&this.f8.animations&&this.f8.animations.length>0&&t.push(this.f8),this.cW&&this.cW.animations&&this.cW.animations.length>0&&t.push(this.cW),this.uW&&this.uW.animations&&this.uW.animations.length>0&&t.push(this.uW),this.S8&&this.S8.animations&&this.S8.animations.length>0&&t.push(this.S8),this.E8&&this.E8.animations&&this.E8.animations.length>0&&t.push(this.E8),this.A8&&this.A8.animations&&this.A8.animations.length>0&&t.push(this.A8),t}i7(){return this.oW?this.oW:this.getScene().environmentTexture}getActiveTextures(){const t=super.getActiveTextures();return this.l8&&t.push(this.l8),this.rW&&t.push(this.rW),this.hW&&t.push(this.hW),this.oW&&t.push(this.oW),this.aW&&t.push(this.aW),this.f8&&t.push(this.f8),this.d8&&t.push(this.d8),this.S8&&t.push(this.S8),this.E8&&t.push(this.E8),this.A8&&t.push(this.A8),this.cW&&t.push(this.cW),this.uW&&t.push(this.uW),t}hasTexture(t){return!!super.hasTexture(t)||(this.l8===t||(this.rW===t||(this.hW===t||(this.oW===t||(this.aW===t||(this.f8===t||(this.d8===t||(this.S8===t||(this.E8===t||(this.A8===t||(this.cW===t||this.uW===t)))))))))))}setPrePassRenderer(){var t;if(!(null===(t=this.subSurface)||void 0===t?void 0:t.isScatteringEnabled))return!1;const i=this.getScene().enableSubSurfaceForPrePass();return i&&(i.enabled=!0),!0}dispose(t,i){var e,s,n,r,h,o,a,l,c,u,f,d;i&&(this.X8&&this.getScene().environmentBRDFTexture!==this.X8&&this.X8.dispose(),null===(e=this.l8)||void 0===e||e.dispose(),null===(s=this.rW)||void 0===s||s.dispose(),null===(n=this.hW)||void 0===n||n.dispose(),null===(r=this.oW)||void 0===r||r.dispose(),null===(h=this.aW)||void 0===h||h.dispose(),null===(o=this.d8)||void 0===o||o.dispose(),null===(a=this.f8)||void 0===a||a.dispose(),null===(l=this.cW)||void 0===l||l.dispose(),null===(c=this.uW)||void 0===c||c.dispose(),null===(u=this.S8)||void 0===u||u.dispose(),null===(f=this.E8)||void 0===f||f.dispose(),null===(d=this.A8)||void 0===d||d.dispose()),this._v.dispose(),this.Sg&&this.uF&&this.Sg.onUpdateParameters.remove(this.uF),super.dispose(t,i)}}_g.PBRMATERIAL_OPAQUE=Vs.MATERIAL_OPAQUE,_g.PBRMATERIAL_ALPHATEST=Vs.MATERIAL_ALPHATEST,_g.PBRMATERIAL_ALPHABLEND=Vs.MATERIAL_ALPHABLEND,_g.PBRMATERIAL_ALPHATESTANDBLEND=Vs.MATERIAL_ALPHATESTANDBLEND,_g.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,_g.LIGHTFALLOFF_PHYSICAL=0,_g.LIGHTFALLOFF_GLTF=1,_g.LIGHTFALLOFF_STANDARD=2,ut([rt()],_g.prototype,"_imageProcessingConfiguration",void 0),ut([q("_markAllSubMeshesAsMiscDirty")],_g.prototype,"debugMode",void 0),ut([Q()],_g.prototype,"useLogarithmicDepth",null);class yg extends _g{constructor(t,i){super(t,i),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=yg.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=_.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new _(0,0,0),this.albedoColor=new _(1,1,1),this.reflectivityColor=new _(1,1,1),this.reflectionColor=new _(1,1,1),this.emissiveColor=new _(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.X8=zm(this.getScene())}get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(t){this.subSurface.refractionTexture=t,t?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(t){this.subSurface.indexOfRefraction=t}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(t){this.subSurface.invertRefractionY=t}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(t){this.subSurface.linkRefractionWithTransparency=t,t&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this.U8===_g.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(t){t!==this.usePhysicalLightFalloff&&(this.UR(),this.U8=t?_g.LIGHTFALLOFF_PHYSICAL:_g.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this.U8===_g.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(t){t!==this.useGLTFLightFalloff&&(this.UR(),this.U8=t?_g.LIGHTFALLOFF_GLTF:_g.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this.Sg}set imageProcessingConfiguration(t){this.$L(t),this.UR()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(t){this.imageProcessingConfiguration.colorCurvesEnabled=t}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(t){this.imageProcessingConfiguration.colorGradingEnabled=t}get cameraToneMappingEnabled(){return this.Sg.toneMappingEnabled}set cameraToneMappingEnabled(t){this.Sg.toneMappingEnabled=t}get cameraExposure(){return this.Sg.exposure}set cameraExposure(t){this.Sg.exposure=t}get cameraContrast(){return this.Sg.contrast}set cameraContrast(t){this.Sg.contrast=t}get cameraColorGradingTexture(){return this.Sg.colorGradingTexture}set cameraColorGradingTexture(t){this.Sg.colorGradingTexture=t}get cameraColorCurves(){return this.Sg.colorCurves}set cameraColorCurves(t){this.Sg.colorCurves=t}getClassName(){return"PBRMaterial"}clone(t){const i=ot.Clone((()=>new yg(t,this.getScene())),this);return i.id=t,i.name=t,this.stencil.copyTo(i.stencil),this.clearCoat.copyTo(i.clearCoat),this.anisotropy.copyTo(i.anisotropy),this.brdf.copyTo(i.brdf),this.sheen.copyTo(i.sheen),this.subSurface.copyTo(i.subSurface),i}serialize(){const t=super.serialize();return t.customType="BABYLON.PBRMaterial",t.clearCoat=this.clearCoat.serialize(),t.anisotropy=this.anisotropy.serialize(),t.brdf=this.brdf.serialize(),t.sheen=this.sheen.serialize(),t.subSurface=this.subSurface.serialize(),t.iridescence=this.iridescence.serialize(),t}static Parse(t,i,e){const s=ot.Parse((()=>new yg(t.name,i)),t,i,e);return t.stencil&&s.stencil.parse(t.stencil,i,e),t.clearCoat&&s.clearCoat.parse(t.clearCoat,i,e),t.anisotropy&&s.anisotropy.parse(t.anisotropy,i,e),t.brdf&&s.brdf.parse(t.brdf,i,e),t.sheen&&s.sheen.parse(t.sheen,i,e),t.subSurface&&s.subSurface.parse(t.subSurface,i,e),t.iridescence&&s.iridescence.parse(t.iridescence,i,e),s}}yg.PBRMATERIAL_OPAQUE=_g.PBRMATERIAL_OPAQUE,yg.PBRMATERIAL_ALPHATEST=_g.PBRMATERIAL_ALPHATEST,yg.PBRMATERIAL_ALPHABLEND=_g.PBRMATERIAL_ALPHABLEND,yg.PBRMATERIAL_ALPHATESTANDBLEND=_g.PBRMATERIAL_ALPHATESTANDBLEND,yg.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=_g.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"directIntensity",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"emissiveIntensity",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"environmentIntensity",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"specularIntensity",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"disableBumpMap",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"albedoTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"ambientTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"ambientTextureStrength",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesAndMiscDirty")],yg.prototype,"opacityTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"reflectionTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"emissiveTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"reflectivityTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"metallicTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"metallic",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"roughness",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"metallicF0Factor",void 0),ut([J(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"metallicReflectanceColor",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"metallicReflectanceTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"reflectanceTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"microSurfaceTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"bumpTexture",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty",null)],yg.prototype,"lightmapTexture",void 0),ut([J("ambient"),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"ambientColor",void 0),ut([J("albedo"),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"albedoColor",void 0),ut([J("reflectivity"),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"reflectivityColor",void 0),ut([J("reflection"),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"reflectionColor",void 0),ut([J("emissive"),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"emissiveColor",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"microSurface",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useLightmapAsShadowmap",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesAndMiscDirty")],yg.prototype,"useAlphaFromAlbedoTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesAndMiscDirty")],yg.prototype,"forceAlphaTest",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesAndMiscDirty")],yg.prototype,"alphaCutOff",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useSpecularOverAlpha",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useRoughnessFromMetallicTextureGreen",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useMetallnessFromMetallicTextureBlue",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useAmbientInGrayScale",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),ut([Q()],yg.prototype,"usePhysicalLightFalloff",null),ut([Q()],yg.prototype,"useGLTFLightFalloff",null),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useRadianceOverAlpha",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useObjectSpaceNormalMap",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useParallax",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useParallaxOcclusion",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"parallaxScaleBias",void 0),ut([Q(),q("_markAllSubMeshesAsLightsDirty")],yg.prototype,"disableLighting",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"forceIrradianceInFragment",void 0),ut([Q(),q("_markAllSubMeshesAsLightsDirty")],yg.prototype,"maxSimultaneousLights",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"invertNormalMapX",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"invertNormalMapY",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"twoSidedLighting",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useAlphaFresnel",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useLinearAlphaFresnel",void 0),ut([q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"environmentBRDFTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"forceNormalForward",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"enableSpecularAntiAliasing",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useHorizonOcclusion",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],yg.prototype,"useRadianceOcclusion",void 0),ut([Q(),q("_markAllSubMeshesAsMiscDirty")],yg.prototype,"unlit",void 0),v("BABYLON.PBRMaterial",yg);const Ng=131072,Pg=131072;function Dg(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}const Lg=Dg("DXT1"),Og=Dg("DXT3"),Fg=Dg("DXT5"),Bg=Dg("DX10");class Ug{static GetDDSInfo(t){const i=new Int32Array(t.buffer,t.byteOffset,31),e=new Int32Array(t.buffer,t.byteOffset,35);let s=1;i[2]&Ng&&(s=Math.max(1,i[7]));const n=i[21],r=n===Bg?e[32]:0;let h=0;switch(n){case 113:h=2;break;case 116:h=1;break;case Bg:if(10===r){h=2;break}if(2===r){h=1;break}}return{width:i[4],height:i[3],mipmapCount:s,isFourCC:4==(4&i[20]),isRGB:64==(64&i[20]),isLuminance:(i[20]&Pg)===Pg,isCube:512==(512&i[28]),isCompressed:n===Lg||n===Og||n===Fg,dxgiFormat:r,textureType:h}}static s7(t,i,e,s,n,r){const h=new Float32Array(s),o=new Uint16Array(n,e);let a=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++){const s=4*(i+e*t);h[a]=Vu(o[s]),h[a+1]=Vu(o[s+1]),h[a+2]=Vu(o[s+2]),Ug.StoreLODInAlphaChannel?h[a+3]=r:h[a+3]=Vu(o[s+3]),a+=4}return h}static n7(t,i,e,s,n,r){if(Ug.StoreLODInAlphaChannel){const h=new Uint16Array(s),o=new Uint16Array(n,e);let a=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++){const s=4*(i+e*t);h[a]=o[s],h[a+1]=o[s+1],h[a+2]=o[s+2],h[a+3]=Uu(r),a+=4}return h}return new Uint16Array(n,e,s)}static r7(t,i,e,s,n,r){if(Ug.StoreLODInAlphaChannel){const h=new Float32Array(s),o=new Float32Array(n,e);let a=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++){const s=4*(i+e*t);h[a]=o[s],h[a+1]=o[s+1],h[a+2]=o[s+2],h[a+3]=r,a+=4}return h}return new Float32Array(n,e,s)}static h7(t,i,e,s,n,r){const h=new Uint16Array(s),o=new Float32Array(n,e);let a=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++)h[a]=Uu(o[a]),h[a+1]=Uu(o[a+1]),h[a+2]=Uu(o[a+2]),Ug.StoreLODInAlphaChannel?h[a+3]=Uu(r):h[a+3]=Uu(o[a+3]),a+=4;return h}static o7(t,i,e,s,n,r){const h=new Uint8Array(s),a=new Float32Array(n,e);let l=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++){const s=4*(i+e*t);h[l]=255*o.Clamp(a[s]),h[l+1]=255*o.Clamp(a[s+1]),h[l+2]=255*o.Clamp(a[s+2]),Ug.StoreLODInAlphaChannel?h[l+3]=r:h[l+3]=255*o.Clamp(a[s+3]),l+=4}return h}static a7(t,i,e,s,n,r){const h=new Uint8Array(s),a=new Uint16Array(n,e);let l=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++){const s=4*(i+e*t);h[l]=255*o.Clamp(Vu(a[s])),h[l+1]=255*o.Clamp(Vu(a[s+1])),h[l+2]=255*o.Clamp(Vu(a[s+2])),Ug.StoreLODInAlphaChannel?h[l+3]=r:h[l+3]=255*o.Clamp(Vu(a[s+3])),l+=4}return h}static l7(t,i,e,s,n,r,h,o,a){const l=new Uint8Array(s),c=new Uint8Array(n,e);let u=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++){const s=4*(i+e*t);l[u]=c[s+r],l[u+1]=c[s+h],l[u+2]=c[s+o],l[u+3]=c[s+a],u+=4}return l}static c7(t){return 0===t||255===t||-16777216===t?0:1+Ug.c7(t>>8)}static u7(t,i,e,s,n,r,h,o){const a=new Uint8Array(s),l=new Uint8Array(n,e);let c=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++){const s=3*(i+e*t);a[c]=l[s+r],a[c+1]=l[s+h],a[c+2]=l[s+o],c+=3}return a}static f7(t,i,e,s,n){const r=new Uint8Array(s),h=new Uint8Array(n,e);let o=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++){const s=i+e*t;r[o]=h[s],o++}return r}static UploadDDSLevels(t,i,e,s,n,r,h=-1,o,a=!0){let l=null;s.sphericalPolynomial&&(l=new Array);const c=!!t.getCaps().s3tc;i.generateMipMaps=n;const u=new Int32Array(e.buffer,e.byteOffset,31);let f,d,p,m,v,g,S,E=0,A=0,C=1;if(542327876!==u[0])return void F.Error("Invalid magic number in DDS header");if(!s.isFourCC&&!s.isRGB&&!s.isLuminance)return void F.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(s.isCompressed&&!c)return void F.Error("Compressed textures are not supported on this platform.");let w=u[22];m=u[1]+4;let x=!1;if(s.isFourCC)switch(f=u[21],f){case Lg:C=8,A=33777;break;case Og:C=16,A=33778;break;case Fg:C=16,A=33779;break;case 113:x=!0,w=64;break;case 116:x=!0,w=128;break;case Bg:{m+=20;let t=!1;switch(s.dxgiFormat){case 10:x=!0,w=64,t=!0;break;case 2:x=!0,w=128,t=!0;break;case 88:s.isRGB=!0,s.isFourCC=!1,w=32,t=!0}if(t)break}default:return void console.error("Unsupported FourCC code:",(T=f,String.fromCharCode(255&T,T>>8&255,T>>16&255,T>>24&255)))}var T;const R=Ug.c7(u[23]),I=Ug.c7(u[24]),M=Ug.c7(u[25]),b=Ug.c7(u[26]);x&&(A=t.Ra(s.textureType)),g=1,u[2]&Ng&&!1!==n&&(g=Math.max(1,u[7]));const _=o||0,y=t.getCaps();for(let n=_;n<r;n++){for(d=u[4],p=u[3],S=0;S<g;++S){if(-1===h||h===S){const r=-1===h?S:0;if(!s.isCompressed&&s.isFourCC){i.format=5,E=d*p*4;let s=null;if(t.lh||t.uh||!y.textureHalfFloat&&!y.textureFloat)128===w?(s=Ug.o7(d,p,e.byteOffset+m,E,e.buffer,r),l&&0==r&&l.push(Ug.r7(d,p,e.byteOffset+m,E,e.buffer,r))):64===w&&(s=Ug.a7(d,p,e.byteOffset+m,E,e.buffer,r),l&&0==r&&l.push(Ug.s7(d,p,e.byteOffset+m,E,e.buffer,r))),i.type=0;else{const t=y.textureFloat&&(a&&y.textureFloatLinearFiltering||!a),n=y.textureHalfFloat&&(a&&y.textureHalfFloatLinearFiltering||!a),h=(128===w||64===w&&!n)&&t?1:(64===w||128===w&&!t)&&n?2:0;let o,c=null;if(128===w)switch(h){case 1:o=Ug.r7,c=null;break;case 2:o=Ug.h7,c=Ug.r7;break;case 0:o=Ug.o7,c=Ug.r7}else switch(h){case 1:o=Ug.s7,c=null;break;case 2:o=Ug.n7,c=Ug.s7;break;case 0:o=Ug.a7,c=Ug.s7}i.type=h,s=o(d,p,e.byteOffset+m,E,e.buffer,r),l&&0==r&&l.push(c?c(d,p,e.byteOffset+m,E,e.buffer,r):s)}s&&t.Ga(i,s,n,r)}else if(s.isRGB)i.type=0,24===w?(i.format=4,E=d*p*3,v=Ug.u7(d,p,e.byteOffset+m,E,e.buffer,R,I,M),t.Ga(i,v,n,r)):(i.format=5,E=d*p*4,v=Ug.l7(d,p,e.byteOffset+m,E,e.buffer,R,I,M,b),t.Ga(i,v,n,r));else if(s.isLuminance){const s=t.Oa(),h=d;E=Math.floor((d+s-1)/s)*s*(p-1)+h,v=Ug.f7(d,p,e.byteOffset+m,E,e.buffer),i.format=1,i.type=0,t.Ga(i,v,n,r)}else E=Math.max(4,d)/4*Math.max(4,p)/4*C,v=new Uint8Array(e.buffer,e.byteOffset+m,E),i.type=0,t.ka(i,A,d,p,v,n,r)}m+=w?d*p*(w/8):E,d*=.5,p*=.5,d=Math.max(1,d),p=Math.max(1,p)}if(void 0!==o)break}l&&l.length>0?s.sphericalPolynomial=zu.ConvertCubeMapToSphericalPolynomial({size:u[4],right:l[0],left:l[1],up:l[2],down:l[3],front:l[4],back:l[5],format:5,type:1,gammaSpace:!1}):s.sphericalPolynomial=void 0}}Ug.StoreLODInAlphaChannel=!1,Ei.prototype.createPrefilteredCubeTexture=function(t,i,e,s,n=null,r=null,h,a=null,l=!0){return this.createCubeTexture(t,i,null,!1,(t=>{if(!t)return void(n&&n(null));const r=t.texture;if(l?t.info.sphericalPolynomial&&(r.rr=t.info.sphericalPolynomial):r.rr=new Pu,r.$n=oi.CubePrefiltered,this.getCaps().textureLOD)return void(n&&n(r));const h=this.lo,a=t.width;if(!a)return;const c=[];for(let n=0;n<3;n++){const l=1-n/2,u=s,f=o.Log2(a)*e+s,d=u+(f-u)*l,p=Math.round(Math.min(Math.max(d,0),f)),m=new ai(this,oi.Temp);if(m.type=r.type,m.format=r.format,m.width=Math.pow(2,Math.max(o.Log2(a)-p,0)),m.height=m.width,m.isCube=!0,m.Vn=0,m.kn=0,this.qo(h.TEXTURE_CUBE_MAP,m,!0),m.samplingMode=2,h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MIN_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),t.isDDS){const i=t.info,e=t.data;this.La(i.isCompressed),Ug.UploadDDSLevels(this,m,e,i,!0,6,p)}else F.Warn("DDS is the only prefiltered cube map supported so far.");this.qo(h.TEXTURE_CUBE_MAP,null);const v=new nn(i);v.Xb=!0,v.Lb=m,m.isReady=!0,c.push(v)}r.dr=c[2],r.pr=c[1],r.mr=c[0],n&&n(r)}),r,h,a,l,e,s)};Rs.ya.push(new class{constructor(){this.supportCascades=!0}canLoad(t){return t.endsWith(".dds")}loadCubeData(t,i,e,s){const n=i.getEngine();let r,h=!1,o=1e3;if(Array.isArray(t))for(let e=0;e<t.length;e++){const s=t[e];r=Ug.GetDDSInfo(s),i.width=r.width,i.height=r.height,h=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&i.generateMipMaps,n.La(r.isCompressed),Ug.UploadDDSLevels(n,i,s,r,h,6,-1,e),r.isFourCC||1!==r.mipmapCount?o=r.mipmapCount-1:n.generateMipMapsForCubemap(i)}else{const s=t;r=Ug.GetDDSInfo(s),i.width=r.width,i.height=r.height,e&&(r.sphericalPolynomial=new Pu),h=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&i.generateMipMaps,n.La(r.isCompressed),Ug.UploadDDSLevels(n,i,s,r,h,6),r.isFourCC||1!==r.mipmapCount?o=r.mipmapCount-1:n.generateMipMapsForCubemap(i,!1)}n.oQ(i,h,o),i.isReady=!0,i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),s&&s({isDDS:!0,width:i.width,info:r,data:t,texture:i})}loadData(t,i,e){const s=Ug.GetDDSInfo(t),n=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&i.generateMipMaps&&s.width>>s.mipmapCount-1==1;e(s.width,s.height,n,s.isFourCC,(()=>{Ug.UploadDDSLevels(i.getEngine(),i,t,s,n,1)}))}});Rs.ya.push(new class{constructor(){this.supportCascades=!1}canLoad(t){return t.endsWith(".env")}loadCubeData(t,i,e,s,n){if(Array.isArray(t))return;const r=Yu(t);if(r){i.width=r.width,i.height=r.width;try{Ju(i,r),qu(i,t,r).then((()=>{i.isReady=!0,i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),s&&s()}),(t=>{null==n||n("Can not upload environment levels",t)}))}catch(t){null==n||n("Can not upload environment file",t)}}else n&&n("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}});class Vg{constructor(t,i){if(this.data=t,this.isInvalid=!1,!Vg.IsValid(t))return this.isInvalid=!0,void F.Error("texture missing KTX identifier");const e=Uint32Array.BYTES_PER_ELEMENT,s=new DataView(this.data.buffer,this.data.byteOffset+12,13*e),n=67305985===s.getUint32(0,!0);this.glType=s.getUint32(1*e,n),this.glTypeSize=s.getUint32(2*e,n),this.glFormat=s.getUint32(3*e,n),this.glInternalFormat=s.getUint32(4*e,n),this.glBaseInternalFormat=s.getUint32(5*e,n),this.pixelWidth=s.getUint32(6*e,n),this.pixelHeight=s.getUint32(7*e,n),this.pixelDepth=s.getUint32(8*e,n),this.numberOfArrayElements=s.getUint32(9*e,n),this.numberOfFaces=s.getUint32(10*e,n),this.numberOfMipmapLevels=s.getUint32(11*e,n),this.bytesOfKeyValueData=s.getUint32(12*e,n),0===this.glType?(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0!==this.pixelHeight&&0===this.pixelDepth?0===this.numberOfArrayElements?this.numberOfFaces===i?this.loadType=Vg.COMPRESSED_2D:F.Error("number of faces expected"+i+", but found "+this.numberOfFaces):F.Error("texture arrays not currently supported"):F.Error("only 2D textures currently supported")):F.Error("only compressed formats currently supported")}uploadLevels(t,i){switch(this.loadType){case Vg.COMPRESSED_2D:this.d7(t,i);case Vg.TEX_2D:case Vg.COMPRESSED_3D:case Vg.TEX_3D:}}d7(t,i){let e=Vg.HEADER_LEN+this.bytesOfKeyValueData,s=this.pixelWidth,n=this.pixelHeight;const r=i?this.numberOfMipmapLevels:1;for(let i=0;i<r;i++){const r=new Int32Array(this.data.buffer,this.data.byteOffset+e,1)[0];e+=4;for(let h=0;h<this.numberOfFaces;h++){const o=new Uint8Array(this.data.buffer,this.data.byteOffset+e,r);t.getEngine().ka(t,t.format,s,n,o,h,i),e+=r,e+=3-(r+3)%4}s=Math.max(1,.5*s),n=Math.max(1,.5*n)}}static IsValid(t){if(t.byteLength>=12){const i=new Uint8Array(t.buffer,t.byteOffset,12);if(171===i[0]&&75===i[1]&&84===i[2]&&88===i[3]&&32===i[4]&&49===i[5]&&49===i[6]&&187===i[7]&&13===i[8]&&10===i[9]&&26===i[10]&&10===i[11])return!0}return!1}}Vg.HEADER_LEN=64,Vg.COMPRESSED_2D=0,Vg.COMPRESSED_3D=1,Vg.TEX_2D=2,Vg.TEX_3D=3;class kg{constructor(t){this.p7=new Array,this.m7=t.map((t=>({workerPromise:Promise.resolve(t),idle:!0})))}dispose(){for(const t of this.m7)t.workerPromise.then((t=>{t.terminate()}));this.m7.length=0,this.p7.length=0}push(t){this.v7(t)||this.p7.push(t)}v7(t){for(const i of this.m7)if(i.idle)return this.g7(i,t),!0;return!1}g7(t,i){t.idle=!1,t.workerPromise.then((e=>{i(e,(()=>{const i=this.p7.shift();i?this.g7(t,i):t.idle=!0}))}))}}class Gg extends kg{constructor(t,i,e=Gg.DefaultOptions){super([]),this.S7=t,this.E7=i,this.wb=e}push(t){if(!this.v7(t))if(this.m7.length<this.S7){const i={workerPromise:this.E7(),idle:!1};this.m7.push(i),this.g7(i,t)}else this.p7.push(t)}g7(t,i){t.timeoutId&&(clearTimeout(t.timeoutId),delete t.timeoutId),super.g7(t,((e,s)=>{i(e,(()=>{s(),t.idle&&(t.timeoutId=setTimeout((()=>{t.workerPromise.then((t=>{t.terminate()}));const i=this.m7.indexOf(t);-1!==i&&this.m7.splice(i,1)}),this.wb.idleTimeElapsedBeforeRelease))}))}))}}function zg(t){return t?ki.GetAbsoluteUrl(t):null}function Hg(t){null!==t.wasmUASTCToASTC&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=t.wasmUASTCToASTC),null!==t.wasmUASTCToBC7&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=t.wasmUASTCToBC7),null!==t.wasmUASTCToRGBA_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=t.wasmUASTCToRGBA_UNORM),null!==t.wasmUASTCToRGBA_SRGB&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=t.wasmUASTCToRGBA_SRGB),null!==t.wasmUASTCToR8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=t.wasmUASTCToR8_UNORM),null!==t.wasmUASTCToRG8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=t.wasmUASTCToRG8_UNORM),null!==t.jsMSCTranscoder&&(KTX2DECODER.MSCTranscoder.JSModuleURL=t.jsMSCTranscoder),null!==t.wasmMSCTranscoder&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=t.wasmMSCTranscoder),null!==t.wasmZSTDDecoder&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=t.wasmZSTDDecoder)}Gg.DefaultOptions={idleTimeElapsedBeforeRelease:1e3};class Xg{constructor(t,i=Xg.DefaultNumWorkers){this.Ls=t,Xg.A7(i)}static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static A7(t){if(Xg.C7||Xg.w7)return;const i={jsDecoderModule:ki.GetAbsoluteUrl(this.URLConfig.jsDecoderModule),wasmUASTCToASTC:zg(this.URLConfig.wasmUASTCToASTC),wasmUASTCToBC7:zg(this.URLConfig.wasmUASTCToBC7),wasmUASTCToRGBA_UNORM:zg(this.URLConfig.wasmUASTCToRGBA_UNORM),wasmUASTCToRGBA_SRGB:zg(this.URLConfig.wasmUASTCToRGBA_SRGB),wasmUASTCToR8_UNORM:zg(this.URLConfig.wasmUASTCToR8_UNORM),wasmUASTCToRG8_UNORM:zg(this.URLConfig.wasmUASTCToRG8_UNORM),jsMSCTranscoder:zg(this.URLConfig.jsMSCTranscoder),wasmMSCTranscoder:zg(this.URLConfig.wasmMSCTranscoder),wasmZSTDDecoder:zg(this.URLConfig.wasmZSTDDecoder)};t&&"function"==typeof Worker&&"undefined"!=typeof URL?Xg.C7=new Promise((e=>{const s=`${Hg}(${Wg})()`,n=URL.createObjectURL(new Blob([s],{type:"application/javascript"}));e(new Gg(t,(()=>new Promise(((t,e)=>{const s=new Worker(n),r=t=>{s.removeEventListener("error",r),s.removeEventListener("message",h),e(t)},h=i=>{"init"===i.data.action&&(s.removeEventListener("error",r),s.removeEventListener("message",h),t(s))};s.addEventListener("error",r),s.addEventListener("message",h),s.postMessage({action:"init",urls:i})})))))})):"undefined"==typeof KTX2DECODER?Xg.w7=ki.LoadScriptAsync(i.jsDecoderModule).then((()=>(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,Hg(i),new KTX2DECODER.KTX2Decoder))):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,Xg.w7=Promise.resolve(new KTX2DECODER.KTX2Decoder))}uploadAsync(t,i,e){const s=this.Ls.getCaps(),n={astc:!!s.astc,bptc:!!s.bptc,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,etc1:!!s.etc1};if(Xg.C7)return Xg.C7.then((s=>new Promise(((r,h)=>{s.push(((s,o)=>{const a=t=>{s.removeEventListener("error",a),s.removeEventListener("message",l),h(t),o()},l=t=>{if("decoded"===t.data.action){if(s.removeEventListener("error",a),s.removeEventListener("message",l),t.data.success)try{this.xa(t.data.decodedData,i,e),r()}catch(t){h({message:t})}else h({message:t.data.msg});o()}};s.addEventListener("error",a),s.addEventListener("message",l);const c=new Uint8Array(t.byteLength);c.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),s.postMessage({action:"decode",data:c,caps:n,options:e},[c.buffer])}))}))));if(Xg.w7)return Xg.w7.then((e=>new Promise(((n,r)=>{e.decode(t,s).then((t=>{this.xa(t,i),n()})).catch((t=>{r({message:t})}))}))));throw new Error("KTX2 decoder module is not available")}xa(t,i,e){this.Ls.qo(3553,i),e&&(e.transcodedFormat=t.transcodedFormat,e.isInGammaSpace=t.isInGammaSpace,e.hasAlpha=t.hasAlpha,e.transcoderName=t.transcoderName);let s=!0;switch(t.transcodedFormat){case 32856:i.type=0,i.format=5;break;case 33321:i.type=0,i.format=6;break;case 33323:i.type=0,i.format=7;break;default:i.format=t.transcodedFormat,s=!1}if(i.wr=t.isInGammaSpace,i.generateMipMaps=t.mipmaps.length>1,t.errors)throw new Error("KTX2 container - could not transcode the data. "+t.errors);for(let e=0;e<t.mipmaps.length;++e){const n=t.mipmaps[e];if(!n||!n.data)throw new Error("KTX2 container - could not transcode one of the image");s?(i.width=n.width,i.height=n.height,this.Ls.Ga(i,n.data,0,e,void 0,!0)):this.Ls.ka(i,t.transcodedFormat,n.width,n.height,n.data,0,e)}i.Zn=".ktx2",i.width=t.mipmaps[0].width,i.height=t.mipmaps[0].height,i.isReady=!0,this.Ls.qo(3553,null)}static IsValid(t){if(t.byteLength>=12){const i=new Uint8Array(t.buffer,t.byteOffset,12);if(171===i[0]&&75===i[1]&&84===i[2]&&88===i[3]&&32===i[4]&&50===i[5]&&48===i[6]&&187===i[7]&&13===i[8]&&10===i[9]&&26===i[10]&&10===i[11])return!0}return!1}}function Wg(){let t;onmessage=i=>{if(i.data)switch(i.data.action){case"init":{const e=i.data.urls;importScripts(e.jsDecoderModule),Hg(e),t=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break}case"decode":t.decode(i.data.data,i.data.caps,i.data.options).then((t=>{const i=[];for(let e=0;e<t.mipmaps.length;++e){const s=t.mipmaps[e];s&&s.data&&i.push(s.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:t},i)})).catch((t=>{postMessage({action:"decoded",success:!1,msg:t})}))}}}Xg.URLConfig={jsDecoderModule:"https://preview.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},Xg.DefaultNumWorkers=Xg.GetDefaultNumWorkers();Rs.ya.unshift(new class{constructor(){this.supportCascades=!1}canLoad(t,i){return t.endsWith(".ktx")||t.endsWith(".ktx2")||"image/ktx"===i||"image/ktx2"===i}loadCubeData(t,i,e,s){if(Array.isArray(t))return;i.Xn=!i.invertY;const n=i.getEngine(),r=new Vg(t,6),h=r.numberOfMipmapLevels>1&&i.generateMipMaps;n.La(!0),r.uploadLevels(i,i.generateMipMaps),i.width=r.pixelWidth,i.height=r.pixelHeight,n.oQ(i,h,r.numberOfMipmapLevels-1),i.isReady=!0,i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),s&&s()}loadData(t,i,e,s){if(Vg.IsValid(t)){i.Xn=!i.invertY;const s=new Vg(t,1),n=function(t){switch(t){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(s.glInternalFormat);n?(i.format=n,i.ur=i.getEngine().ba(!0,i.generateMipMaps),i.wr=!0):i.format=s.glInternalFormat,e(s.pixelWidth,s.pixelHeight,i.generateMipMaps,!0,(()=>{s.uploadLevels(i,i.generateMipMaps)}),s.isInvalid)}else if(Xg.IsValid(t)){new Xg(i.getEngine()).uploadAsync(t,i,s).then((()=>{e(i.width,i.height,i.generateMipMaps,!0,(()=>{}),!1)}),(t=>{F.Warn(`Failed to load KTX2 texture data: ${t.message}`),e(0,0,!1,!1,(()=>{}),!0)}))}else F.Error("texture missing KTX identifier"),e(0,0,!1,!1,(()=>{}),!0)}});class $g extends Dh{constructor(t,i,e){super(t,w.Zero(),i),this.RN=e,this.x7=!1,this.T7=T.Identity(),this.R7=new w,this.I7=Ec.NOT_TRACKING,this.onBeforeCameraTeleport=new h,this.onAfterCameraTeleport=new h,this.onTrackingStateChanged=new h,this.compensateOnFirstFrame=!0,this.minZ=.1,this.rotationQuaternion=new T,this.cameraRigMode=hs.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this.M7(1),this.freezeProjectionMatrix(),this.RN.onXRSessionInit.add((()=>{this.R7.copyFromFloats(0,0,0),this.T7.copyFromFloats(0,0,0,1),this.x7=this.compensateOnFirstFrame})),this.RN.onXRFrameObservable.add((()=>{this.x7&&this.b7(),this._7(),this.b7()}),void 0,!0)}get trackingState(){return this.I7}y7(t){this.I7!==t&&(this.I7=t,this.onTrackingStateChanged.notifyObservers(t))}get realWorldHeight(){const t=this.RN.currentFrame&&this.RN.currentFrame.getViewerPose(this.RN.baseReferenceSpace);return t&&t.transform?t.transform.position.y:0}N7(){this.M7(2),this.rigCameras[0].viewport=new rs(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new rs(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(t=this.getScene().activeCamera,i=!0){if(!t||t===this)return;t.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,T.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this.x7=!0,i&&this.RN.resetReferenceSpace()}getClassName(){return"WebXRCamera"}dispose(){super.dispose(),this.P7=void 0}b7(){const t=this.RN.currentFrame&&this.RN.currentFrame.getViewerPose(this.RN.referenceSpace);if(this.P7=t||void 0,!t)return void this.y7(Ec.NOT_TRACKING);const i=t.emulatedPosition?Ec.TRACKING_LOST:Ec.TRACKING;if(this.y7(i),this.minZ!==this.Ii.minZ||this.maxZ!==this.Ii.maxZ){const t={depthFar:this.maxZ||1e4,depthNear:this.minZ};this.RN.updateRenderState(t),this.Ii.minZ=this.minZ,this.Ii.maxZ=this.maxZ}if(t.transform){const i=t.transform.orientation;if(void 0===t.transform.orientation.x)return;const e=t.transform.position;this.R7.set(e.x,e.y,e.z),this.T7.set(i.x,i.y,i.z,i.w),this.Kt.useRightHandedSystem||(this.R7.z*=-1,this.T7.z*=-1,this.T7.w*=-1),this.x7?(this.x7=!1,this.position.y+=this.R7.y,this.T7.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this.T7),this.position.copyFrom(this.R7))}this.rigCameras.length!==t.views.length&&this.M7(t.views.length),t.views.forEach(((t,i)=>{var e;const s=this.rigCameras[i];s.isLeftCamera||s.isRightCamera||("right"===t.eye?s.EA=!0:"left"===t.eye&&(s.SA=!0));const n=t.transform.position,r=t.transform.orientation;s.parent=this.parent,s.position.set(n.x,n.y,n.z),s.rotationQuaternion.set(r.x,r.y,r.z,r.w),this.Kt.useRightHandedSystem||(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1),R.FromFloat32ArrayToRefScaled(t.projectionMatrix,0,1,s.Ug),this.Kt.useRightHandedSystem||s.Ug.toggleProjectionMatrixHandInPlace(),0===i&&this.Ug.copyFrom(s.Ug);const h=this.RN.getRenderTargetTextureForView(t);this.cS=(null===(e=null==h?void 0:h.Lb)||void 0===e?void 0:e.isMultiview)||!1,this.cS?0==i&&(this.RN.trySetViewportForView(this.viewport,t),this.outputRenderTarget=h):(this.RN.trySetViewportForView(s.viewport,t),s.outputRenderTarget=h||this.RN.getRenderTargetTextureForView(t)),s.layerMask=this.layerMask}))}M7(t=1){for(;this.rigCameras.length<t;){const t=new Ph("XR-RigCamera: "+this.rigCameras.length,w.Zero(),this.getScene());t.minZ=.1,t.rotationQuaternion=new T,t.updateUpVectorFromRotation=!0,t.isRigCamera=!0,t.rigParent=this,t.freezeProjectionMatrix(),this.rigCameras.push(t)}for(;this.rigCameras.length>t;){const t=this.rigCameras.pop();t&&t.dispose()}}_7(){if(!this.position.equals(this.R7)||!this.rotationQuaternion.equals(this.T7)){const t=M.Matrix[0],i=M.Matrix[1],e=M.Matrix[2];R.ComposeToRef($g.D7,this.T7,this.R7,t),R.ComposeToRef($g.D7,this.rotationQuaternion,this.position,i),t.invert().multiplyToRef(i,e),e.invert(),this.Kt.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),e.decompose(void 0,this.T7,this.R7);const s=new XRRigidTransform({x:this.R7.x,y:this.R7.y,z:this.R7.z},{x:this.T7.x,y:this.T7.y,z:this.T7.z,w:this.T7.w});this.RN.referenceSpace=this.RN.referenceSpace.getOffsetReferenceSpace(s)}}}$g.D7=w.One();class Yg{constructor(t){this.Kt=t,this.L7=null,this.rN=!1,this.O7=null,this.F7=!0,this.B7=!1,this.U7=!1,this.V7=0,this.onInitialXRPoseSetObservable=new h,this.onStateChangedObservable=new h,this.state=Sc.NOT_IN_XR,this.sessionManager=new gc(t),this.camera=new $g("webxr",t,this.sessionManager),this.featuresManager=new wn(this.sessionManager),t.onDisposeObservable.addOnce((()=>{this.dispose()}))}static CreateAsync(t){const i=new Yg(t);return i.sessionManager.initializeAsync().then((()=>(i.B7=!0,i))).catch((t=>{throw i.k7(Sc.NOT_IN_XR),i.dispose(),t}))}dispose(){var t;this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),null===(t=this.O7)||void 0===t||t.dispose(),this.L7&&(this.Kt.activeCamera=this.L7)}async enterXRAsync(t,i,e=this.sessionManager.getWebXRRenderTarget(),s={}){var n,r,h;if(!this.B7)throw"WebXR not supported in this browser or environment";this.k7(Sc.ENTERING_XR),"viewer"!==i&&"local"!==i&&(s.optionalFeatures=s.optionalFeatures||[],s.optionalFeatures.push(i)),s=await this.featuresManager.bN(s),"immersive-ar"===t&&"unbounded"!==i&&F.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(t,s),await this.sessionManager.setReferenceSpaceTypeAsync(i);const o=await e.initializeXRLayerAsync(this.sessionManager.session),a={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};return this.featuresManager.getEnabledFeature(Cn.LAYERS)||(a.baseLayer=o),this.sessionManager.updateRenderState(a),this.sessionManager.runXRRenderLoop(),this.F7=this.Kt.autoClear,this.L7=this.Kt.activeCamera,this.rN=!!(null===(r=null===(n=this.L7)||void 0===n?void 0:n.inputs)||void 0===r?void 0:r.attachedToElement),null===(h=this.L7)||void 0===h||h.detachControl(),this.Kt.activeCamera=this.camera,"immersive-ar"!==t?this.G7():(this.Kt.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1)),this.sessionManager.onXRSessionEnded.addOnce((()=>{this.state!==Sc.EXITING_XR&&this.k7(Sc.EXITING_XR),this.camera.rigCameras.forEach((t=>{t.outputRenderTarget=null})),this.Kt.autoClear=this.F7,this.Kt.activeCamera=this.L7,this.rN&&this.L7&&this.L7.attachControl(!!this.L7.inputs.noPreventDefault),"immersive-ar"!==t&&this.camera.compensateOnFirstFrame&&(this.L7.setPosition?this.L7.setPosition(this.camera.position):this.L7.position.copyFrom(this.camera.position)),this.k7(Sc.NOT_IN_XR)})),this.sessionManager.onXRFrameObservable.addOnce((()=>{this.k7(Sc.IN_XR)})),this.sessionManager}catch(t){throw console.log(t),console.log(t.message),this.k7(Sc.NOT_IN_XR),t}}exitXRAsync(){return this.state!==Sc.IN_XR?Promise.resolve():(this.k7(Sc.EXITING_XR),this.sessionManager.exitXRAsync())}enableSpectatorMode(t){this.U7||(this.U7=!0,this.z7(t))}disableSpecatatorMode(){this.U7&&(this.U7=!1,this.z7())}z7(t){const i=1/((null==t?void 0:t.fps)?t.fps:1e3)*1e3,e=(null==t?void 0:t.preferredCameraIndex)?null==t?void 0:t.preferredCameraIndex:0,s=()=>{if(this.O7){this.sessionManager.currentTimestamp-this.V7>=i&&(this.V7=this.sessionManager.currentTimestamp,this.O7.position.copyFrom(this.camera.rigCameras[e].globalPosition),this.O7.rotationQuaternion.copyFrom(this.camera.rigCameras[e].absoluteRotation))}};if(this.U7){if(e>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const t=()=>{this.state===Sc.IN_XR?(this.O7=new jh("webxr-spectator",w.Zero(),this.Kt),this.O7.rotationQuaternion=new T,this.Kt.activeCameras=[this.camera,this.O7],this.sessionManager.onXRFrameObservable.add(s),this.Kt.onAfterRenderCameraObservable.add((t=>{t===this.camera&&(this.Kt.getEngine().framebufferDimensionsObject=null)}))):this.state===Sc.EXITING_XR&&(this.sessionManager.onXRFrameObservable.removeCallback(s),this.Kt.activeCameras=null)};this.onStateChangedObservable.add(t),t()}else this.sessionManager.onXRFrameObservable.removeCallback(s),this.Kt.activeCameras=[this.camera]}G7(){this.camera.setTransformationFromNonVRCamera(this.L7),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}k7(t){this.state!==t&&(this.state=t,this.onStateChangedObservable.notifyObservers(this.state))}}class jg{constructor(t,i,e=-1,s=[]){this.id=t,this.type=i,this.H7=e,this.X7=s,this.W7={x:0,y:0},this.eX={},this.ve=0,this.Y7=!1,this.j7=!1,this.K7=!1,this.onAxisValueChangedObservable=new h,this.onButtonStateChangedObservable=new h}get axes(){return this.W7}get changes(){return this.eX}get hasChanges(){return this.Y7}get pressed(){return this.j7}get touched(){return this.K7}get value(){return this.ve}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return 0!==this.X7.length}isButton(){return-1!==this.H7}update(t){let i=!1,e=!1;if(this.Y7=!1,this.eX={},this.isButton()){const e=t.buttons[this.H7];if(!e)return;this.ve!==e.value&&(this.changes.value={current:e.value,previous:this.ve},i=!0,this.ve=e.value),this.K7!==e.touched&&(this.changes.touched={current:e.touched,previous:this.K7},i=!0,this.K7=e.touched),this.j7!==e.pressed&&(this.changes.pressed={current:e.pressed,previous:this.j7},i=!0,this.j7=e.pressed)}this.isAxes()&&(this.W7.x!==t.axes[this.X7[0]]&&(this.changes.axes={current:{x:t.axes[this.X7[0]],y:this.W7.y},previous:{x:this.W7.x,y:this.W7.y}},this.W7.x=t.axes[this.X7[0]],e=!0),this.W7.y!==t.axes[this.X7[1]]&&(this.changes.axes?this.changes.axes.current.y=t.axes[this.X7[1]]:this.changes.axes={current:{x:this.W7.x,y:t.axes[this.X7[1]]},previous:{x:this.W7.x,y:this.W7.y}},this.W7.y=t.axes[this.X7[1]],e=!0)),i&&(this.Y7=!0,this.onButtonStateChangedObservable.notifyObservers(this)),e&&(this.Y7=!0,this.onAxisValueChangedObservable.notifyObservers(this.W7))}}jg.BUTTON_TYPE="button",jg.SQUEEZE_TYPE="squeeze",jg.THUMBSTICK_TYPE="thumbstick",jg.TOUCHPAD_TYPE="touchpad",jg.TRIGGER_TYPE="trigger";class Kg{constructor(t,i,e,s,n=!1,r){this.scene=t,this.layout=i,this.gamepadObject=e,this.handedness=s,this.q7=n,this.Q7=r,this.Z7=t=>{if(!t)return;const i=this.layout.components[t],e=i.type,s=i.gamepadIndices.button,n=[];void 0!==i.gamepadIndices.xAxis&&void 0!==i.gamepadIndices.yAxis&&n.push(i.gamepadIndices.xAxis,i.gamepadIndices.yAxis),this.components[t]=new jg(t,e,s,n)},this.J7=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new h,i.components&&Object.keys(i.components).forEach(this.Z7)}dispose(){this.getComponentIds().forEach((t=>this.getComponent(t).dispose())),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach((t=>{t.setEnabled(!1)})),this.rootMesh.dispose(!!this.Q7,!this.Q7))}getAllComponentsOfType(t){return this.getComponentIds().map((t=>this.components[t])).filter((i=>i.type===t))}getComponent(t){return this.components[t]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(t){return this.getAllComponentsOfType(t)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){const t=!this.t9();let i=this.i9();return t?F.Warn("Falling back to generic models"):i=this.e9(),new Promise(((e,s)=>{const n=i=>{t?this.s9(i):this.n9(i),this.r9(i),this.J7=!0,this.onModelLoadedObservable.notifyObservers(this),e(!0)};if(this.Q7){const t=this.Q7.filter((t=>t.filename===i.filename&&t.path===i.path));if(t[0])return t[0].meshes.forEach((t=>t.setEnabled(!0))),void n(t[0].meshes)}On.ImportMesh("",i.path,i.filename,this.scene,(t=>{this.Q7&&this.Q7.push({...i,meshes:t}),n(t)}),null,((t,e)=>{F.Log(e),F.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${i.path}${i.filename}`),s(e)}))}))}updateFromXRFrame(t){this.getComponentIds().forEach((t=>this.getComponent(t).update(this.gamepadObject))),this.updateModel(t)}get handness(){return this.handedness}pulse(t,i,e=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[e]?this.gamepadObject.hapticActuators[e].pulse(t,i):Promise.resolve(!1)}h9(t,i){return t.getChildren((t=>t.name===i),!1)[0]}o9(t,i){return t.getChildren((t=>t.name==i),!0)[0]}a9(t,i,e){if(!t.minMesh||!t.maxMesh||!t.valueMesh)return;if(!t.minMesh.rotationQuaternion||!t.maxMesh.rotationQuaternion||!t.valueMesh.rotationQuaternion)return;const s=e?.5*i+.5:i;T.SlerpToRef(t.minMesh.rotationQuaternion,t.maxMesh.rotationQuaternion,s,t.valueMesh.rotationQuaternion),w.LerpToRef(t.minMesh.position,t.maxMesh.position,s,t.valueMesh.position)}updateModel(t){this.J7&&this.l9(t)}i9(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}s9(t){this.rootMesh=new Ys(this.profileId+" "+this.handedness,this.scene),t.forEach((t=>{t.parent||(t.isPickable=!1,t.setParent(this.rootMesh))})),this.rootMesh.rotationQuaternion=T.FromEulerAngles(0,Math.PI,0)}}class qg extends Kg{constructor(t,i,e){super(t,Qg[e],i,e),this.profileId=qg.ProfileId}e9(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}t9(){return!0}r9(t){}n9(t){this.rootMesh=new Ys(this.profileId+" "+this.handedness,this.scene),t.forEach((t=>{t.isPickable=!1,t.parent||t.setParent(this.rootMesh)})),this.rootMesh.rotationQuaternion=T.FromEulerAngles(0,Math.PI,0)}l9(){}}qg.ProfileId="generic-trigger";const Qg={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};class Zg extends Kg{constructor(t,i,e,s,n){super(t,e.layouts[i.handedness||"none"],i.gamepad,i.handedness,void 0,n),this.c9=s,this.controllerCache=n,this.u9={},this.f9={},this.profileId=e.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this.f9).forEach((t=>{this.f9[t].dispose()}))}e9(){return{filename:this.layout.assetPath,path:`${this.c9}/profiles/${this.profileId}/`}}t9(){const t=On.IsPluginForExtensionAvailable(".glb");return t||F.Warn("glTF / glb loader was not registered, using generic controller instead"),t}r9(t){this.getComponentIds().forEach((t=>{const i=this.layout.components[t];this.u9[t]={mainMesh:this.h9(this.rootMesh,i.rootNodeName),states:{}},Object.keys(i.visualResponses).forEach((e=>{const s=i.visualResponses[e];if("transform"===s.valueNodeProperty)this.u9[t].states[e]={valueMesh:this.h9(this.rootMesh,s.valueNodeName),minMesh:this.h9(this.rootMesh,s.minNodeName),maxMesh:this.h9(this.rootMesh,s.maxNodeName)};else{const n=i.type===jg.TOUCHPAD_TYPE&&i.touchPointNodeName?i.touchPointNodeName:s.valueNodeName;if(this.u9[t].states[e]={valueMesh:this.h9(this.rootMesh,n)},i.type===jg.TOUCHPAD_TYPE&&!this.f9[e]){const i=Qc(e+"dot",{diameter:.0015,segments:8},this.scene);i.material=new sc(e+"mat",this.scene),i.material.diffuseColor=_.Red(),i.parent=this.u9[t].states[e].valueMesh||null,i.isVisible=!1,this.f9[e]=i}}}))}))}n9(t){let i;this.rootMesh=new Ys(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let e=0;e<t.length;e++){const s=t[e];s.isPickable=!1,s.parent||(i=s)}i&&i.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(Ge.Y,Math.PI,Be.WORLD)}l9(t){this.disableAnimation||this.getComponentIds().forEach((t=>{const i=this.getComponent(t);if(!i.hasChanges)return;const e=this.u9[t],s=this.layout.components[t];Object.keys(s.visualResponses).forEach((t=>{const n=s.visualResponses[t];let r=i.value;if("xAxis"===n.componentProperty?r=i.axes.x:"yAxis"===n.componentProperty&&(r=i.axes.y),"transform"===n.valueNodeProperty)this.a9(e.states[t],r,"button"!==n.componentProperty);else{const s=e.states[t].valueMesh;s&&(s.isVisible=i.touched||i.pressed),this.f9[t]&&(this.f9[t].isVisible=i.touched||i.pressed)}}))}))}}const Jg=[];class tS{static ClearProfilesCache(){this.d9=null,this.p9={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(t){const i=this.m9[t]||[];return i.unshift(t),i}static GetMotionControllerWithXRInput(t,i,e){const s=[];if(e&&s.push(e),s.push(...t.profiles||[]),s.length&&!s[0]&&s.pop(),t.gamepad&&t.gamepad.id&&t.gamepad.id===(t.gamepad.id.match(/oculus touch/gi)?t.gamepad.id:void 0))s.push("oculus-touch-v2");const n=s.indexOf("windows-mixed-reality");if(-1!==n&&s.splice(n,0,"microsoft-mixed-reality"),s.length||s.push("generic-trigger"),this.UseOnlineRepository){const e=this.PrioritizeOnlineRepository?this.v9:this.g9,n=this.PrioritizeOnlineRepository?this.g9:this.v9;return e.call(this,s,t,i).catch((()=>n.call(this,s,t,i)))}return this.g9(s,t,i)}static RegisterController(t,i){this.S9[t]=i}static RegisterFallbacksForProfileId(t,i){this.m9[t]?this.m9[t].push(...i):this.m9[t]=i}static UpdateProfilesList(){return this.d9=ki.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then((t=>JSON.parse(t.toString()))),this.d9}static ClearControllerCache(){Jg.forEach((t=>{t.meshes.forEach((t=>{t.dispose(!1,!0)}))})),Jg.length=0}static v9(t,i,e){return Promise.resolve().then((()=>this.d9?this.d9:this.UpdateProfilesList())).then((i=>{for(let e=0;e<t.length;++e)if(t[e]&&i[t[e]])return t[e];throw new Error(`neither controller ${t[0]} nor all fallbacks were found in the repository,`)})).then((t=>(this.p9[t]||(this.p9[t]=ki.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${t}/profile.json`,!1).then((t=>JSON.parse(t)))),this.p9[t]))).then((t=>new Zg(e,i,t,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:Jg)))}static g9(t,i,e){for(let s=0;s<t.length;++s){if(!t[s])continue;const n=this.FindFallbackWithProfileId(t[s]);for(let t=0;t<n.length;++t){const s=this.S9[n[t]];if(s)return Promise.resolve(s(i,e))}}throw new Error("no controller requested was found in the available controllers list")}}tS.S9={},tS.m9={},tS.p9={},tS.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",tS.PrioritizeOnlineRepository=!0,tS.UseOnlineRepository=!0,tS.DisableControllerCache=!0,tS.RegisterController(qg.ProfileId,((t,i)=>new qg(i,t.gamepad,t.handedness))),tS.DefaultFallbacks();let iS=0;class eS{constructor(t,i,e={}){this.Kt=t,this.inputSource=i,this.wb=e,this.iN=new w,this.E9=!1,this.onDisposeObservable=new h,this.onMeshLoadedObservable=new h,this.onMotionControllerInitObservable=new h,this.Tr=`controller-${iS++}-${i.targetRayMode}-${i.handedness}`,this.pointer=new ys(`${this.Tr}-pointer`,t),this.pointer.rotationQuaternion=new T,this.inputSource.gripSpace&&(this.grip=new ys(`${this.Tr}-grip`,this.Kt),this.grip.rotationQuaternion=new T),this.iN.set(0,0,this.Kt.useRightHandedSystem?-1:1),this.inputSource.gamepad&&"tracked-pointer"===this.inputSource.targetRayMode&&tS.GetMotionControllerWithXRInput(i,t,this.wb.forceControllerProfile).then((t=>{this.motionController=t,this.onMotionControllerInitObservable.notifyObservers(t),this.wb.doNotLoadControllerMesh||this.motionController.q7||this.motionController.loadModel().then((t=>{var i;t&&this.motionController&&this.motionController.rootMesh&&(this.wb.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this.wb.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach((t=>t.renderingGroupId=this.wb.renderingGroupId))),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this.wb.disableMotionControllerAnimation),this.E9&&(null===(i=this.motionController)||void 0===i||i.dispose())}))}),(()=>{ki.Warn("Could not find a matching motion controller for the registered input source")}))}get uniqueId(){return this.Tr}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.E9=!0}getWorldPointerRayToRef(t,i=!1){const e=i&&this.grip?this.grip:this.pointer;w.TransformNormalToRef(this.iN,e.getWorldMatrix(),t.direction),t.direction.normalize(),t.origin.copyFrom(e.absolutePosition),t.length=1e3}updateFromXRFrame(t,i,e){const s=t.getPose(this.inputSource.targetRaySpace,i);if(this.A9=s,s){const t=s.transform.position;this.pointer.position.set(t.x,t.y,t.z);const i=s.transform.orientation;this.pointer.rotationQuaternion.set(i.x,i.y,i.z,i.w),this.Kt.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=e.parent}if(this.inputSource.gripSpace&&this.grip){const s=t.getPose(this.inputSource.gripSpace,i);if(s){const t=s.transform.position,i=s.transform.orientation;this.grip.position.set(t.x,t.y,t.z),this.grip.rotationQuaternion.set(i.x,i.y,i.z,i.w),this.Kt.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=e.parent}this.motionController&&this.motionController.updateFromXRFrame(t)}}class sS{constructor(t,i,e={}){if(this.xrSessionManager=t,this.xrCamera=i,this.wb=e,this.controllers=[],this.onControllerAddedObservable=new h,this.onControllerRemovedObservable=new h,this.C9=t=>{this.w9(t.added,t.removed)},this.x9=this.xrSessionManager.onXRSessionEnded.add((()=>{this.w9([],this.controllers.map((t=>t.inputSource)))})),this.T9=this.xrSessionManager.onXRSessionInit.add((t=>{t.addEventListener("inputsourceschange",this.C9)})),this.R9=this.xrSessionManager.onXRFrameObservable.add((t=>{this.controllers.forEach((i=>{i.updateFromXRFrame(t,this.xrSessionManager.referenceSpace,this.xrCamera)}))})),this.wb.customControllersRepositoryURL&&(tS.BaseRepositoryUrl=this.wb.customControllersRepositoryURL),tS.UseOnlineRepository=!this.wb.disableOnlineControllerRepository,tS.UseOnlineRepository)try{tS.UpdateProfilesList().catch((()=>{tS.UseOnlineRepository=!1}))}catch(t){tS.UseOnlineRepository=!1}}w9(t,i){const e=this.controllers.map((t=>t.inputSource));for(const i of t)if(-1===e.indexOf(i)){const t=new eS(this.xrSessionManager.scene,i,{...this.wb.controllerOptions||{},forceControllerProfile:this.wb.forceInputProfile,doNotLoadControllerMesh:this.wb.doNotLoadControllerMeshes,disableMotionControllerAnimation:this.wb.disableControllerAnimation});this.controllers.push(t),this.onControllerAddedObservable.notifyObservers(t)}const s=[],n=[];this.controllers.forEach((t=>{-1===i.indexOf(t.inputSource)?s.push(t):n.push(t)})),this.controllers=s,n.forEach((t=>{this.onControllerRemovedObservable.notifyObservers(t),t.dispose()}))}dispose(){this.controllers.forEach((t=>{t.dispose()})),this.xrSessionManager.onXRFrameObservable.remove(this.R9),this.xrSessionManager.onXRSessionInit.remove(this.T9),this.xrSessionManager.onXRSessionEnded.remove(this.x9),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),tS.ClearControllerCache()}}class nS extends xn{constructor(t,i){super(t),this.wb=i,this.I9=t=>{if(this.M9[t.uniqueId])return;const{laserPointer:i,selectionMesh:e}=this.b9(t.pointer);switch(this.M9[t.uniqueId]={xrController:t,laserPointer:i,selectionMesh:e,meshUnderPointer:null,pick:null,tmpRay:new vn(new w,new w),disabledByNearInteraction:!1,id:nS.N$++},this._9?!this.wb.enablePointerSelectionOnAllControllers&&this.wb.preferredHandedness&&t.inputSource.handedness===this.wb.preferredHandedness&&(this._9=t.uniqueId):this.wb.enablePointerSelectionOnAllControllers||(this._9=t.uniqueId),t.inputSource.targetRayMode){case"tracked-pointer":return this.y9(t);case"gaze":return this.N9(t);case"screen":return this.P9(t)}},this.M9={},this.D9=new w,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new _(.9,.9,.9),this.laserPointerDefaultColor=new _(.7,.7,.7),this.selectionMeshDefaultColor=new _(.8,.8,.8),this.selectionMeshPickedColor=new _(.3,.3,1),this.L9=R.Identity(),this.O9=w.Zero(),this.F9=new rs(0,0,0,0),this.Kt=this.RN.scene}attach(){if(!super.attach())return!1;if(this.wb.xrInput.controllers.forEach(this.I9),this.NN(this.wb.xrInput.onControllerAddedObservable,this.I9),this.NN(this.wb.xrInput.onControllerRemovedObservable,(t=>{this.B9(t.uniqueId)})),this.Kt.constantlyUpdateMeshUnderPointer=!0,this.wb.gazeCamera){const t=this.wb.gazeCamera,{laserPointer:i,selectionMesh:e}=this.b9(t);this.M9.camera={webXRCamera:t,laserPointer:i,selectionMesh:e,meshUnderPointer:null,pick:null,tmpRay:new vn(new w,new w),disabledByNearInteraction:!1,id:nS.N$++},this.N9()}return!0}detach(){return!!super.detach()&&(Object.keys(this.M9).forEach((t=>{this.B9(t)})),!0)}getMeshUnderPointer(t){return this.M9[t]?this.M9[t].meshUnderPointer:null}getXRControllerByPointerId(t){const i=Object.keys(this.M9);for(let e=0;e<i.length;++e)if(this.M9[i[e]].id===t)return this.M9[i[e]].xrController||null;return null}U9(t){const i=Object.keys(this.M9);for(let e=0;e<i.length;++e)if(this.M9[i[e]].id===t)return this.M9[i[e]].disabledByNearInteraction;return!0}V9(t,i){const e=Object.keys(this.M9);for(let s=0;s<e.length;++s)if(this.M9[e[s]].id===t)return void(this.M9[e[s]].disabledByNearInteraction=i)}PN(t){Object.keys(this.M9).forEach((t=>{const i=this.M9[t];if(!this.wb.enablePointerSelectionOnAllControllers&&t!==this._9||i.disabledByNearInteraction)return i.selectionMesh.isVisible=!1,i.laserPointer.isVisible=!1,void(i.pick=null);let e;if(i.laserPointer.isVisible=this.displayLaserPointer,i.xrController)e=i.xrController.pointer.position,i.xrController.getWorldPointerRayToRef(i.tmpRay);else{if(!i.webXRCamera)return;e=i.webXRCamera.position,i.webXRCamera.getForwardRayToRef(i.tmpRay)}if(this.wb.maxPointerDistance&&(i.tmpRay.length=this.wb.maxPointerDistance),!this.wb.disableScenePointerVectorUpdate&&e){const t=this.RN.scene,s=this.wb.xrInput.xrCamera;s&&(s.viewport.toGlobalToRef(t.getEngine().getRenderWidth(),t.getEngine().getRenderHeight(),this.F9),w.ProjectToRef(e,this.L9,t.getTransformMatrix(),this.F9,this.O9),"number"!=typeof this.O9.x||"number"!=typeof this.O9.y||isNaN(this.O9.x)||isNaN(this.O9.y)||(t.pointerX=this.O9.x,t.pointerY=this.O9.y,i.screenCoordinates={x:this.O9.x,y:this.O9.y}))}let s=null;this.k9&&(s=this.k9.pickWithRay(i.tmpRay,this.k9.pointerMovePredicate||this.raySelectionPredicate));const n=this.Kt.pickWithRay(i.tmpRay,this.Kt.pointerMovePredicate||this.raySelectionPredicate);s&&s.hit?n&&n.hit?s.distance<n.distance?i.pick=s:i.pick=n:i.pick=s:i.pick=n,i.pick&&i.xrController&&(i.pick.aimTransform=i.xrController.pointer,i.pick.gripTransform=i.xrController.grip||null);const r=i.pick;if(r&&r.pickedPoint&&r.hit){this.V$(i.laserPointer,r.distance),i.selectionMesh.position.copyFrom(r.pickedPoint),i.selectionMesh.scaling.x=Math.sqrt(r.distance),i.selectionMesh.scaling.y=Math.sqrt(r.distance),i.selectionMesh.scaling.z=Math.sqrt(r.distance);const t=this.dj(r.getNormal(!0),i.tmpRay),e=.001;if(i.selectionMesh.position.copyFrom(r.pickedPoint),t){const s=w.Cross(Ge.Y,t),n=w.Cross(t,s);w.RotationFromAxisToRef(n,t,s,i.selectionMesh.rotation),i.selectionMesh.position.addInPlace(t.scale(e))}i.selectionMesh.isVisible=this.displaySelectionMesh,i.meshUnderPointer=r.pickedMesh}else i.selectionMesh.isVisible=!1,this.V$(i.laserPointer,1),i.meshUnderPointer=null}))}get k9(){return this.wb.customUtilityLayerScene||Wc.DefaultUtilityLayer.utilityLayerScene}N9(t){const i=this.M9[t&&t.uniqueId||"camera"],e=this.wb.timeToSelect||3e3,s=this.wb.useUtilityLayer?this.k9:this.Kt;let n=new oe;const r=xc("selection",{diameter:.0525,thickness:.015,tessellation:20},s);r.isVisible=!1,r.isPickable=!1,r.parent=i.selectionMesh;let h=0,o=!1;const a={pointerId:i.id,pointerType:"xr"};i.onFrameObserver=this.RN.onXRFrameObservable.add((()=>{if(i.pick){if(this.G9(a,i.id,i.screenCoordinates),i.laserPointer.material.alpha=0,r.isVisible=!1,i.pick.hit)if(this.z9(n,i.pick))o&&(this.wb.disablePointerUpOnTouchOut||this.Kt.simulatePointerUp(i.pick,a)),o=!1,h=0;else if(h>e/10&&(r.isVisible=!0),h+=this.Kt.getEngine().getDeltaTime(),h>=e)this.Kt.simulatePointerDown(i.pick,a),o=!0,this.wb.disablePointerUpOnTouchOut&&this.Kt.simulatePointerUp(i.pick,a),r.isVisible=!1;else{const t=1-h/e;r.scaling.set(t,t,t)}else o=!1,h=0;this.Kt.simulatePointerMove(i.pick,a),n=i.pick}})),void 0!==this.wb.renderingGroupId&&(r.renderingGroupId=this.wb.renderingGroupId),t&&t.onDisposeObservable.addOnce((()=>{i.pick&&!this.wb.disablePointerUpOnTouchOut&&o&&(this.Kt.simulatePointerUp(i.pick,a),i.finalPointerUpTriggered=!0),r.dispose()}))}P9(t){const i=this.M9[t.uniqueId];let e=!1;const s={pointerId:i.id,pointerType:"xr"};i.onFrameObserver=this.RN.onXRFrameObservable.add((()=>{this.G9(s,i.id,i.screenCoordinates),!i.pick||this.wb.disablePointerUpOnTouchOut&&e||(e?this.Kt.simulatePointerMove(i.pick,s):(this.Kt.simulatePointerDown(i.pick,s),i.pointerDownTriggered=!0,e=!0,this.wb.disablePointerUpOnTouchOut&&this.Kt.simulatePointerUp(i.pick,s)))})),t.onDisposeObservable.addOnce((()=>{this.G9(s,i.id,i.screenCoordinates),this.RN.runInXRFrame((()=>{i.pick&&!i.finalPointerUpTriggered&&e&&!this.wb.disablePointerUpOnTouchOut&&(this.Kt.simulatePointerUp(i.pick,s),i.finalPointerUpTriggered=!0)}))}))}y9(t){const i=this.M9[t.uniqueId];if(this.wb.forceGazeMode)return this.N9(t);const e={pointerId:i.id,pointerType:"xr"};if(i.onFrameObserver=this.RN.onXRFrameObservable.add((()=>{i.laserPointer.material.disableLighting=this.disablePointerLighting,i.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,i.pick&&(this.G9(e,i.id,i.screenCoordinates),this.Kt.simulatePointerMove(i.pick,e))})),t.inputSource.gamepad){const s=s=>{this.wb.overrideButtonId&&(i.selectionComponent=s.getComponent(this.wb.overrideButtonId)),i.selectionComponent||(i.selectionComponent=s.getMainComponent()),i.onButtonChangedObserver=i.selectionComponent.onButtonStateChangedObservable.add((s=>{if(s.changes.pressed){const n=s.changes.pressed.current;i.pick?(this.wb.enablePointerSelectionOnAllControllers||t.uniqueId===this._9)&&(this.G9(e,i.id,i.screenCoordinates),n?(this.Kt.simulatePointerDown(i.pick,e),i.pointerDownTriggered=!0,i.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,i.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this.Kt.simulatePointerUp(i.pick,e),i.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,i.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)):!n||this.wb.enablePointerSelectionOnAllControllers||this.wb.disableSwitchOnClick||(this._9=t.uniqueId)}}))};t.motionController?s(t.motionController):t.onMotionControllerInitObservable.add(s)}else{const t=t=>{this.G9(e,i.id,i.screenCoordinates),i.xrController&&t.inputSource===i.xrController.inputSource&&i.pick&&(this.Kt.simulatePointerDown(i.pick,e),i.pointerDownTriggered=!0,i.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,i.laserPointer.material.emissiveColor=this.laserPointerPickedColor)},s=t=>{this.G9(e,i.id,i.screenCoordinates),i.xrController&&t.inputSource===i.xrController.inputSource&&i.pick&&(this.Kt.simulatePointerUp(i.pick,e),i.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,i.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)};i.eventListeners={selectend:s,selectstart:t},this.RN.session.addEventListener("selectstart",t),this.RN.session.addEventListener("selectend",s)}}dj(t,i){if(t){Math.acos(w.Dot(t,i.direction))<Math.PI/2&&t.scaleInPlace(-1)}return t}B9(t){const i=this.M9[t];if(i){if(i.selectionComponent&&i.onButtonChangedObserver&&i.selectionComponent.onButtonStateChangedObservable.remove(i.onButtonChangedObserver),i.onFrameObserver&&this.RN.onXRFrameObservable.remove(i.onFrameObserver),i.eventListeners&&Object.keys(i.eventListeners).forEach((t=>{const e=i.eventListeners&&i.eventListeners[t];e&&this.RN.session.removeEventListener(t,e)})),!i.finalPointerUpTriggered&&i.pointerDownTriggered){const t={pointerId:i.id,pointerType:"xr"};this.RN.runInXRFrame((()=>{this.G9(t,i.id,i.screenCoordinates),this.Kt.simulatePointerUp(i.pick||new oe,t),i.finalPointerUpTriggered=!0}))}this.RN.scene.onBeforeRenderObservable.addOnce((()=>{try{if(i.selectionMesh.dispose(),i.laserPointer.dispose(),delete this.M9[t],this._9===t){const t=Object.keys(this.M9);t.length?this._9=t[0]:this._9=""}}catch(t){ki.Warn("controller already detached.")}}))}}b9(t){const i=this.wb.useUtilityLayer?this.wb.customUtilityLayerScene||Wc.DefaultUtilityLayer.utilityLayerScene:this.Kt,e=this.wb.customLasterPointerMeshGenerator?this.wb.customLasterPointerMeshGenerator():Cc("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},i);e.parent=t;const s=new sc("laserPointerMat",i);s.emissiveColor=this.laserPointerDefaultColor,s.alpha=.7,e.material=s,e.rotation.x=Math.PI/2,this.V$(e,1),e.isPickable=!1,e.isVisible=!1;const n=this.wb.customSelectionMeshGenerator?this.wb.customSelectionMeshGenerator():xc("gazeTracker",{diameter:.0105,thickness:.0075,tessellation:20},i);n.bakeCurrentTransformIntoVertices(),n.isPickable=!1,n.isVisible=!1;const r=new sc("targetMat",i);return r.specularColor=_.Black(),r.emissiveColor=this.selectionMeshDefaultColor,r.backFaceCulling=!1,n.material=r,void 0!==this.wb.renderingGroupId&&(e.renderingGroupId=this.wb.renderingGroupId,n.renderingGroupId=this.wb.renderingGroupId),{laserPointer:e,selectionMesh:n}}z9(t,i){var e;if(!t.hit||!i.hit)return!0;if(!(t.pickedMesh&&t.pickedPoint&&i.pickedMesh&&i.pickedPoint))return!0;if(t.pickedMesh!==i.pickedMesh)return!0;null===(e=t.pickedPoint)||void 0===e||e.subtractToRef(i.pickedPoint,this.D9),this.D9.set(Math.abs(this.D9.x),Math.abs(this.D9.y),Math.abs(this.D9.z));const s=.01*(this.wb.gazeModePointerMovedFactor||1)*i.distance;return this.D9.length()>s}V$(t,i=100){t.scaling.y=i,this.Kt.useRightHandedSystem&&(i*=-1),t.position.z=i/2+.05}G9(t,i,e){t.pointerId=i,t.pointerType="xr",e&&(t.screenX=e.x,t.screenY=e.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}var rS,hS,oS;nS.N$=200,nS.Name=Cn.POINTER_SELECTION,nS.Version=1,wn.AddWebXRFeature(nS.Name,((t,i)=>()=>new nS(t,i)),nS.Version,!0),Ss.prototype.H9=function(t,i,e,s,n,r){const h=M.Vector3[0],o=M.Vector3[1];let a=1/0;for(let r=this.indexStart;r<this.indexStart+this.indexCount-(3-s);r+=s){const s=e[r],l=e[r+1],c=e[r+2];if(n&&4294967295===c){r+=2;continue}const u=i[s],f=i[l],d=i[c];if(!u||!f||!d)continue;const p=w.ProjectOnTriangleToRef(t,u,f,d,o);p<a&&(h.copyFrom(o),a=p)}return r.copyFrom(h),a},Ss.prototype.X9=function(t,i,e,s){const n=M.Vector3[0],r=M.Vector3[1];let h=1/0;for(let e=this.verticesStart;e<this.verticesStart+this.verticesCount;e+=3){const s=i[e],o=i[e+1],a=i[e+2],l=w.ProjectOnTriangleToRef(t,s,o,a,r);l<h&&(n.copyFrom(r),h=l)}return s.copyFrom(n),h},Ss.prototype.projectToRef=function(t,i,e,s){const n=this.getMaterial();if(!n)return-1;let r=3,h=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:r=1,h=!0}return 4===n.fillMode?-1:!e.length&&this.fC.IC?this.X9(t,i,e,s):this.H9(t,i,e,r,h,s)},function(t){t[t.DEHYDRATED=0]="DEHYDRATED",t[t.HOVER=1]="HOVER",t[t.TOUCH=2]="TOUCH"}(rS||(rS={})),function(t){t[t.DISABLED=0]="DISABLED",t[t.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",t[t.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"}(hS||(hS={}));class aS extends xn{constructor(t,i){super(t),this.wb=i,this.Py=new vn(new w,new w),this.I9=t=>{if(this.M9[t.uniqueId])return;const{touchCollisionMesh:i,touchCollisionMeshFunction:e,hydrateCollisionMeshFunction:s}=this.W9(),n=this.Y9();switch(this.M9[t.uniqueId]={xrController:t,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:i,touchCollisionMeshFunction:e,hydrateCollisionMeshFunction:s,currentAnimationState:rS.DEHYDRATED,grabRay:new vn(new w,new w),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,id:aS.N$++,pickedPointVisualCue:n},this._9?!this.wb.enableNearInteractionOnAllControllers&&this.wb.preferredHandedness&&t.inputSource.handedness===this.wb.preferredHandedness&&(this._9=t.uniqueId):this.wb.enableNearInteractionOnAllControllers||(this._9=t.uniqueId),t.inputSource.targetRayMode){case"tracked-pointer":return this.j9(t);case"gaze":case"screen":return null}},this.M9={},this.K9=null,this.selectionMeshDefaultColor=new _(.8,.8,.8),this.selectionMeshPickedColor=new _(.3,.3,1),this.q9=.1,this.Q9=.02,this.Z9=.03,this.J9=5,this.Kt=this.RN.scene,void 0===this.wb.nearInteractionControllerMode&&(this.wb.nearInteractionControllerMode=hS.CENTERED_IN_FRONT),this.wb.farInteractionFeature&&(this.K9=this.wb.farInteractionFeature)}attach(){return!!super.attach()&&(this.wb.xrInput.controllers.forEach(this.I9),this.NN(this.wb.xrInput.onControllerAddedObservable,this.I9),this.NN(this.wb.xrInput.onControllerRemovedObservable,(t=>{this.B9(t.uniqueId)})),this.Kt.constantlyUpdateMeshUnderPointer=!0,!0)}detach(){return!!super.detach()&&(Object.keys(this.M9).forEach((t=>{this.B9(t)})),!0)}getMeshUnderPointer(t){return this.M9[t]?this.M9[t].meshUnderPointer:null}getXRControllerByPointerId(t){const i=Object.keys(this.M9);for(let e=0;e<i.length;++e)if(this.M9[i[e]].id===t)return this.M9[i[e]].xrController||null;return null}setFarInteractionFeature(t){this.K9=t}ttt(t){return t.isEnabled()&&t.isVisible&&t.isPickable&&t.isNearPickable}itt(t){return t.isEnabled()&&t.isVisible&&t.isPickable&&t.isNearGrabbable}ett(t){return t.isEnabled()&&t.isVisible&&t.isPickable&&(t.isNearPickable||t.isNearGrabbable)}stt(t,i){let e=t;for(;e;){if(e.reservedDataStore&&e.reservedDataStore.nearInteraction&&e.reservedDataStore.nearInteraction.excludedControllerId===i)return!1;e=e.parent}return!0}ntt(t,i){var e;if(t.currentAnimationState!==i&&this.wb.nearInteractionControllerMode===hS.CENTERED_IN_FRONT&&!(null===(e=t.xrController)||void 0===e?void 0:e.inputSource.hand)){if(i>t.currentAnimationState)switch(t.currentAnimationState){case rS.DEHYDRATED:if(t.hydrateCollisionMeshFunction(!0),i===rS.HOVER)break;case rS.HOVER:if(t.touchCollisionMeshFunction(!0),i===rS.TOUCH)break}else switch(t.currentAnimationState){case rS.TOUCH:if(t.touchCollisionMeshFunction(!1),i===rS.HOVER)break;case rS.HOVER:if(t.hydrateCollisionMeshFunction(!1),i===rS.DEHYDRATED)break}t.currentAnimationState=i}}htt(t,i,e){var s;const n=this.M9[t];n.grabRay.origin.copyFrom(i),e.toEulerAnglesToRef(M.Vector3[0]),n.grabRay.direction.copyFrom(M.Vector3[0]),this.wb.nearInteractionControllerMode!==hS.CENTERED_IN_FRONT||(null===(s=n.xrController)||void 0===s?void 0:s.inputSource.hand)||(n.xrController.getWorldPointerRayToRef(this.Py),n.grabRay.origin.addInPlace(this.Py.direction.scale(.05))),n.grabRay.length=this.J9*this.q9,n.touchCollisionMesh.position.copyFrom(n.grabRay.origin)}PN(t){Object.keys(this.M9).forEach((i=>{var e;const s=this.M9[i],n=null===(e=s.xrController)||void 0===e?void 0:e.inputSource.hand;if(!this.wb.enableNearInteractionOnAllControllers&&i!==this._9||!s.xrController||!n&&(!this.wb.nearInteractionControllerMode||!s.xrController.inputSource.gamepad))return void(s.pick=null);if(s.hoverInteraction=!1,s.nearInteraction=!1,!s.xrController)return;if(n){const e=n.get("index-finger-tip");if(e){const s=t.getJointPose(e,this.RN.referenceSpace);if(s&&s.transform){const t=this.Kt.useRightHandedSystem?1:-1;M.Vector3[0].set(s.transform.position.x,s.transform.position.y,s.transform.position.z*t),M.Quaternion[0].set(s.transform.orientation.x,s.transform.orientation.y,s.transform.orientation.z*t,s.transform.orientation.w*t),this.htt(i,M.Vector3[0],M.Quaternion[0])}}}else if(s.xrController.inputSource.gamepad&&this.wb.nearInteractionControllerMode!==hS.DISABLED){let t=s.xrController.pointer;s.xrController.grip&&this.wb.nearInteractionControllerMode===hS.CENTERED_ON_CONTROLLER&&(t=s.xrController.grip),this.htt(i,t.position,t.rotationQuaternion)}const r=(t,i)=>{let e=null;return e=i&&i.hit?t&&t.hit?i.distance<t.distance?i:t:i:t,e},h=t=>{let i=new oe,e=!1;const s=t&&t.pickedPoint&&t.hit;return(null==t?void 0:t.pickedPoint)&&(e=0===t.pickedPoint.x&&0===t.pickedPoint.y&&0===t.pickedPoint.z),s&&!e&&(i=t),i};if(!s.grabInteraction){let t=null,i=null;this.wb.useUtilityLayer&&this.k9&&(i=this.ott(s,this.q9,this.k9,(t=>this.ett(t))));const e=r(this.ott(s,this.q9,this.Kt,(t=>this.ett(t))),i);if(e&&e.hit&&(t=h(e),t.hit&&(s.hoverInteraction=!0)),s.hoverInteraction){let i=null;const e=n?this.Q9:this.Z9;this.wb.useUtilityLayer&&this.k9&&(i=this.ott(s,e,this.k9,(t=>this.ttt(t))));const o=h(r(this.ott(s,e,this.Kt,(t=>this.ttt(t))),i));o.hit&&(t=o,s.nearInteraction=!0)}s.stalePick=s.pick,s.pick=t,s.pick&&s.pick.pickedPoint&&s.pick.hit?(s.meshUnderPointer=s.pick.pickedMesh,s.pickedPointVisualCue.position.copyFrom(s.pick.pickedPoint),s.pickedPointVisualCue.isVisible=!0,this.K9&&this.K9.attached&&this.K9.V9(s.id,!0)):(s.meshUnderPointer=null,s.pickedPointVisualCue.isVisible=!1,this.K9&&this.K9.attached&&this.K9.V9(s.id,!1))}let o=rS.DEHYDRATED;s.grabInteraction||s.nearInteraction?o=rS.TOUCH:s.hoverInteraction&&(o=rS.HOVER),this.ntt(s,o)}))}get k9(){return this.wb.customUtilityLayerScene||Wc.DefaultUtilityLayer.utilityLayerScene}Y9(){const t=this.wb.useUtilityLayer?this.wb.customUtilityLayerScene||Wc.DefaultUtilityLayer.utilityLayerScene:this.Kt,i=Qc("nearInteraction",{diameter:.0105},t);i.bakeCurrentTransformIntoVertices(),i.isPickable=!1,i.isVisible=!1,i.rotationQuaternion=T.Identity();const e=new sc("targetMat",t);return e.specularColor=_.Black(),e.emissiveColor=this.selectionMeshDefaultColor,e.backFaceCulling=!1,i.material=e,i}att(t){return!this.K9||this.K9.U9(t)}j9(t){const i=this.M9[t.uniqueId],e={pointerId:i.id,pointerType:"xr-near"};i.onFrameObserver=this.RN.onXRFrameObservable.add((()=>{(this.wb.enableNearInteractionOnAllControllers||t.uniqueId===this._9)&&i.xrController&&(i.xrController.inputSource.hand||this.wb.nearInteractionControllerMode&&i.xrController.inputSource.gamepad)&&(i.pick&&(i.pick.ray=i.grabRay),i.pick&&this.att(i.id)&&this.Kt.simulatePointerMove(i.pick,e),i.nearInteraction&&i.pick&&i.pick.hit?i.nearInteractionTargetMesh||(this.Kt.simulatePointerDown(i.pick,e),i.nearInteractionTargetMesh=i.meshUnderPointer):i.nearInteractionTargetMesh&&i.stalePick&&(this.Kt.simulatePointerUp(i.stalePick,e),i.nearInteractionTargetMesh=null))}));const s=s=>{this.wb.enableNearInteractionOnAllControllers||t.uniqueId===this._9&&this.att(i.id)?(i.pick&&(i.pick.ray=i.grabRay),s&&i.pick&&i.meshUnderPointer&&this.itt(i.meshUnderPointer)?(i.grabInteraction=!0,i.pickedPointVisualCue.isVisible=!1,this.Kt.simulatePointerDown(i.pick,e)):!s&&i.pick&&i.grabInteraction&&(this.Kt.simulatePointerUp(i.pick,e),i.grabInteraction=!1,i.pickedPointVisualCue.isVisible=!0)):!s||this.wb.enableNearInteractionOnAllControllers||this.wb.disableSwitchOnClick||(this._9=t.uniqueId)};if(t.inputSource.gamepad){const e=t=>{i.squeezeComponent=t.getComponent("grasp"),i.squeezeComponent?i.onSqueezeButtonChangedObserver=i.squeezeComponent.onButtonStateChangedObservable.add((t=>{if(t.changes.pressed){const i=t.changes.pressed.current;s(i)}})):(i.selectionComponent=t.getMainComponent(),i.onButtonChangedObserver=i.selectionComponent.onButtonStateChangedObservable.add((t=>{if(t.changes.pressed){const i=t.changes.pressed.current;s(i)}})))};t.motionController?e(t.motionController):t.onMotionControllerInitObservable.add(e)}else{const t=t=>{i.xrController&&t.inputSource===i.xrController.inputSource&&i.pick&&this.att(i.id)&&i.meshUnderPointer&&this.itt(i.meshUnderPointer)&&(i.grabInteraction=!0,i.pickedPointVisualCue.isVisible=!1,this.Kt.simulatePointerDown(i.pick,e))},s=t=>{i.xrController&&t.inputSource===i.xrController.inputSource&&i.pick&&this.att(i.id)&&(this.Kt.simulatePointerUp(i.pick,e),i.grabInteraction=!1,i.pickedPointVisualCue.isVisible=!0)};i.eventListeners={selectend:s,selectstart:t},this.RN.session.addEventListener("selectstart",t),this.RN.session.addEventListener("selectend",s)}}B9(t){const i=this.M9[t];if(i&&(i.squeezeComponent&&i.onSqueezeButtonChangedObserver&&i.squeezeComponent.onButtonStateChangedObservable.remove(i.onSqueezeButtonChangedObserver),i.selectionComponent&&i.onButtonChangedObserver&&i.selectionComponent.onButtonStateChangedObservable.remove(i.onButtonChangedObserver),i.onFrameObserver&&this.RN.onXRFrameObservable.remove(i.onFrameObserver),i.eventListeners&&Object.keys(i.eventListeners).forEach((t=>{const e=i.eventListeners&&i.eventListeners[t];e&&this.RN.session.removeEventListener(t,e)})),i.touchCollisionMesh.dispose(),i.pickedPointVisualCue.dispose(),this.RN.runInXRFrame((()=>{const t={pointerId:i.id,pointerType:"xr-near"};this.Kt.simulatePointerUp(new oe,t)})),delete this.M9[t],this._9===t)){const t=Object.keys(this.M9);t.length?this._9=t[0]:this._9=""}}W9(){const t=this.wb.useUtilityLayer?this.wb.customUtilityLayerScene||Wc.DefaultUtilityLayer.utilityLayerScene:this.Kt,i=Qc("PickSphere",{diameter:1},t);i.isVisible=!1,this.wb.motionControllerOrbMaterial?i.material=this.wb.motionControllerOrbMaterial:Br.ParseFromSnippetAsync("8RUNKL#3",t).then((t=>{i.material=t}));const e=new Qe;e.setEasingMode(Ke.EASINGMODE_EASEINOUT);const s=new w(this.Z9,this.Z9,this.Z9),n=this.Z9*(4/3),r=new w(n,n,n),h=this.Z9*(7/6),o=new w(h,h,h),a=.8*this.Z9,l=new w(a,a,a),c=1.5*this.Z9,u=[{frame:0,value:s},{frame:10,value:new w(c,c,c)},{frame:18,value:r}],f=[{frame:0,value:r},{frame:10,value:l},{frame:18,value:s}],d=[{frame:0,value:w.ZeroReadOnly},{frame:12,value:o},{frame:15,value:s}],p=[{frame:0,value:s},{frame:10,value:w.ZeroReadOnly},{frame:15,value:w.ZeroReadOnly}],m=new vt("touch","scaling",60,vt.ANIMATIONTYPE_VECTOR3,vt.ANIMATIONLOOPMODE_CONSTANT),v=new vt("release","scaling",60,vt.ANIMATIONTYPE_VECTOR3,vt.ANIMATIONLOOPMODE_CONSTANT),g=new vt("hydrate","scaling",60,vt.ANIMATIONTYPE_VECTOR3,vt.ANIMATIONLOOPMODE_CONSTANT),S=new vt("dehydrate","scaling",60,vt.ANIMATIONTYPE_VECTOR3,vt.ANIMATIONLOOPMODE_CONSTANT);m.setEasingFunction(e),v.setEasingFunction(e),g.setEasingFunction(e),S.setEasingFunction(e),m.setKeys(u),v.setKeys(f),g.setKeys(d),S.setKeys(p);return{touchCollisionMesh:i,touchCollisionMeshFunction:e=>{const s=e?m:v;t.beginDirectAnimation(i,[s],0,18,!1,1)},hydrateCollisionMeshFunction:e=>{const s=e?g:S;e&&(i.isVisible=!0),t.beginDirectAnimation(i,[s],0,15,!1,1,(()=>{e||(i.isVisible=!1)}))}}}ott(t,i,e,s){const n=new oe;if(n.distance=1/0,t.touchCollisionMesh&&t.xrController){const r=t.touchCollisionMesh.position,h=cs.CreateFromCenterAndRadius(r,i);for(let i=0;i<e.meshes.length;i++){const r=e.meshes[i];if(!s(r)||!this.stt(r,t.xrController.uniqueId))continue;const o=aS.PickMeshWithSphere(r,h);o&&o.hit&&o.distance<n.distance&&(n.hit=o.hit,n.pickedMesh=r,n.pickedPoint=o.pickedPoint,n.aimTransform=t.xrController.pointer,n.gripTransform=t.xrController.grip||null,n.originMesh=t.touchCollisionMesh,n.distance=o.distance)}}return n}static PickMeshWithSphere(t,i,e=!1){const s=t.subMeshes,n=new oe,r=t.getBoundingInfo();if(!t.sw())return n;if(!t.subMeshes||!r)return n;if(!e&&!cs.Intersects(r.boundingSphere,i))return n;const h=M.Vector3[0],o=M.Vector3[1];let a,l,c,u=1/0;const f=M.Vector3[2],d=M.Matrix[0];d.copyFrom(t.getWorldMatrix()),d.invert(),w.TransformCoordinatesToRef(i.center,d,f);for(let e=0;e<s.length;e++){s[e].projectToRef(f,t.QC,t.getIndices(),o),w.TransformCoordinatesToRef(o,t.getWorldMatrix(),o),a=w.Distance(o,i.center),c=w.Distance(o,t.getAbsolutePosition()),l=w.Distance(i.center,t.getAbsolutePosition()),-1!==l&&-1!==c&&c>l&&(a=0,o.copyFrom(i.center)),-1!==a&&a<u&&(u=a,h.copyFrom(o))}return u<i.radius&&(n.hit=!0,n.distance=u,n.pickedMesh=t,n.pickedPoint=h.clone()),n}}aS.N$=200,aS.Name=Cn.NEAR_INTERACTION,aS.Version=1,wn.AddWebXRFeature(aS.Name,((t,i)=>()=>new aS(t,i)),aS.Version,!0);class lS{constructor(t,i,e){this.element=t,this.sessionMode=i,this.referenceSpaceType=e}update(t){}}class cS{constructor(t,i){if(this.Kt=t,this.options=i,this.ltt=null,this.wU=[],this.activeButtonChangedObservable=new h,this.ctt=t=>{this.utt&&this.ftt(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!i.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this.ctt),"undefined"!=typeof window&&window.location&&"http:"===window.location.protocol&&"localhost"!==window.location.hostname)throw ki.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(i.customButtons)this.wU=i.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const t=i.sessionMode||"immersive-vr",e=i.referenceSpaceType||"local-floor";let s=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+("undefined"==typeof SVGSVGElement?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";s+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const n=document.createElement("style");n.appendChild(document.createTextNode(s)),document.getElementsByTagName("head")[0].appendChild(n);const r=document.createElement("button");r.className="babylonVRicon",r.title=`${t} - ${e}`,this.wU.push(new lS(r,t,e)),this.wU[this.wU.length-1].update=function(t){this.element.style.display=null===t||t===this?"":"none",r.className="babylonVRicon"+(t===this?" vrdisplaypresenting":"")},this.dtt(null)}const e=t.getEngine().getInputElement();e&&e.parentNode&&(e.parentNode.appendChild(this.overlay),t.onDisposeObservable.addOnce((()=>{this.dispose()})))}async setHelperAsync(t,i){this.utt=t,this.rO=i;const e=this.wU.map((i=>t.sessionManager.isSessionSupportedAsync(i.sessionMode)));t.onStateChangedObservable.add((t=>{t==Sc.NOT_IN_XR&&this.dtt(null)}));(await Promise.all(e)).forEach(((t,i)=>{t?(this.overlay.appendChild(this.wU[i].element),this.wU[i].element.onclick=this.ftt.bind(this,i)):ki.Warn(`Session mode "${this.wU[i].sessionMode}" not supported in browser`)}))}static async CreateAsync(t,i,e){const s=new cS(t,e);return await s.setHelperAsync(i,e.renderTarget||void 0),s}async ftt(t=0){if(this.utt.state==Sc.IN_XR)await this.utt.exitXRAsync(),this.dtt(null);else if(this.utt.state==Sc.NOT_IN_XR)try{await this.utt.enterXRAsync(this.wU[t].sessionMode,this.wU[t].referenceSpaceType,this.rO,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this.dtt(this.wU[t])}catch(i){this.dtt(null);const e=this.wU[t].element,s=e.title;e.title="Error entering XR session : "+s,e.classList.add("xr-error"),this.options.onError&&this.options.onError(i)}}dispose(){const t=this.Kt.getEngine().getInputElement();t&&t.parentNode&&t.parentNode.contains(this.overlay)&&t.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this.ctt)}dtt(t){this.ltt=t,this.wU.forEach((t=>{t.update(this.ltt)})),this.activeButtonChangedObservable.notifyObservers(this.ltt)}}function uS(t){var i;let e=0;const s=Date.now();t.observableParameters=null!==(i=t.observableParameters)&&void 0!==i?i:{};const n=t.contextObservable.add((i=>{const r=Date.now();e=r-s;const h={startTime:s,currentTime:r,deltaTime:e,completeRate:e/t.timeout,payload:i};t.onTick&&t.onTick(h),t.breakCondition&&t.breakCondition()&&(t.contextObservable.remove(n),t.onAborted&&t.onAborted(h)),e>=t.timeout&&(t.contextObservable.remove(n),t.onEnded&&t.onEnded(h))}),t.observableParameters.mask,t.observableParameters.insertFirst,t.observableParameters.scope);return n}!function(t){t[t.INIT=0]="INIT",t[t.STARTED=1]="STARTED",t[t.ENDED=2]="ENDED"}(oS||(oS={}));class fS extends xn{constructor(t,i){super(t),this.wb=i,this.M9={},this.ptt=!1,this.Py=new vn(new w,new w),this.iN=new w,this.Lk=new T,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new h,this.teleportationEnabled=!0,this.mtt=!0,this.I9=t=>{if(this.M9[t.uniqueId]||this.wb.forceHandedness&&t.inputSource.handedness!==this.wb.forceHandedness)return;this.M9[t.uniqueId]={xrController:t,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0}};const i=this.M9[t.uniqueId];if("tracked-pointer"===i.xrController.inputSource.targetRayMode&&i.xrController.inputSource.gamepad){const e=()=>{if(t.motionController){const e=t.motionController.getComponentOfType(jg.THUMBSTICK_TYPE)||t.motionController.getComponentOfType(jg.TOUCHPAD_TYPE);if(!e||this.wb.useMainComponentOnly){const e=t.motionController.getMainComponent();if(!e)return;i.teleportationComponent=e,i.onButtonChangedObserver=e.onButtonStateChangedObservable.add((()=>{if(this.teleportationEnabled&&e.changes.pressed)if(e.changes.pressed.current){i.teleportationState.forward=!0,this.vtt=i.xrController.uniqueId,i.teleportationState.baseRotation=this.wb.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,i.teleportationState.currentRotation=0;uS({timeout:this.wb.timeToTeleport||3e3,contextObservable:this.RN.onXRFrameObservable,breakCondition:()=>!e.pressed,onEnded:()=>{this.vtt===i.xrController.uniqueId&&i.teleportationState.forward&&this.gtt(t.uniqueId)}})}else i.teleportationState.forward=!1,this.vtt=""}))}else i.teleportationComponent=e,i.onAxisChangedObserver=e.onAxisValueChangedObservable.add((e=>{if(e.y<=.7&&i.teleportationState.backwards&&(i.teleportationState.backwards=!1),e.y>.7&&!i.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!i.teleportationState.backwards){i.teleportationState.backwards=!0,this.Lk.copyFrom(this.wb.xrInput.xrCamera.rotationQuaternion),this.Lk.toEulerAnglesToRef(this.iN),this.iN.x=0,this.iN.z=0,T.FromEulerVectorToRef(this.iN,this.Lk),this.iN.set(0,0,this.backwardsTeleportationDistance*(this.RN.scene.useRightHandedSystem?1:-1)),this.iN.rotateByQuaternionToRef(this.Lk,this.iN),this.iN.addInPlace(this.wb.xrInput.xrCamera.position),this.Py.origin.copyFrom(this.iN),this.Py.length=this.wb.xrInput.xrCamera.realWorldHeight+.1,this.Py.direction.set(0,-1,0);const t=this.RN.scene.pickWithRay(this.Py,(t=>-1!==this.Stt.indexOf(t)));t&&t.pickedPoint&&(this.wb.xrInput.xrCamera.position.x=t.pickedPoint.x,this.wb.xrInput.xrCamera.position.z=t.pickedPoint.z)}if(e.y<-.7&&!this.vtt&&!i.teleportationState.rotating&&this.teleportationEnabled&&(i.teleportationState.forward=!0,this.vtt=i.xrController.uniqueId,i.teleportationState.baseRotation=this.wb.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),e.x){if(i.teleportationState.forward)this.vtt===i.xrController.uniqueId&&(this.rotationEnabled?setTimeout((()=>{i.teleportationState.currentRotation=Math.atan2(e.x,e.y*(this.RN.scene.useRightHandedSystem?1:-1))})):i.teleportationState.currentRotation=0);else if(!i.teleportationState.rotating&&Math.abs(e.x)>.7){i.teleportationState.rotating=!0;const t=this.rotationAngle*(e.x>0?1:-1)*(this.RN.scene.useRightHandedSystem?-1:1);T.FromEulerAngles(0,t,0).multiplyToRef(this.wb.xrInput.xrCamera.rotationQuaternion,this.wb.xrInput.xrCamera.rotationQuaternion)}}else i.teleportationState.rotating=!1;0===e.x&&0===e.y&&i.teleportationState.forward&&this.gtt(t.uniqueId)}))}};t.motionController?e():t.onMotionControllerInitObservable.addOnce((()=>{e()}))}else this.RN.scene.onPointerObservable.add((e=>{if(e.type===pe.POINTERDOWN){i.teleportationState.forward=!0,this.vtt=i.xrController.uniqueId,i.teleportationState.baseRotation=this.wb.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,i.teleportationState.currentRotation=0;uS({timeout:this.wb.timeToTeleport||3e3,contextObservable:this.RN.onXRFrameObservable,onEnded:()=>{this.vtt===i.xrController.uniqueId&&i.teleportationState.forward&&this.gtt(t.uniqueId)}})}else e.type===pe.POINTERUP&&(i.teleportationState.forward=!1,this.vtt="")}))},this.wb.teleportationTargetMesh||this.Ett(),this.Stt=this.wb.floorMeshes||[],this.Att=this.wb.snapPositions||[],this.Ctt(!1)}get rotationEnabled(){return this.mtt}set rotationEnabled(t){if(this.mtt=t,this.wb.teleportationTargetMesh){const i=this.wb.teleportationTargetMesh.getChildMeshes(!1,(t=>"rotationCone"===t.name));i[0]&&i[0].setEnabled(t)}}get teleportationTargetMesh(){return this.wb.teleportationTargetMesh||null}get snapPointsOnly(){return!!this.wb.snapPointsOnly}set snapPointsOnly(t){this.wb.snapPointsOnly=t}addFloorMesh(t){this.Stt.push(t)}addBlockerMesh(t){this.wb.pickBlockerMeshes=this.wb.pickBlockerMeshes||[],this.wb.pickBlockerMeshes.push(t)}addSnapPoint(t){this.Att.push(t)}attach(){return!!super.attach()&&(this.vtt="",this.wb.xrInput.controllers.forEach(this.I9),this.NN(this.wb.xrInput.onControllerAddedObservable,this.I9),this.NN(this.wb.xrInput.onControllerRemovedObservable,(t=>{this.B9(t.uniqueId)})),!0)}detach(){return!!super.detach()&&(Object.keys(this.M9).forEach((t=>{this.B9(t)})),this.Ctt(!1),this.vtt="",this.M9={},!0)}dispose(){super.dispose(),this.wb.teleportationTargetMesh&&this.wb.teleportationTargetMesh.dispose(!1,!0)}removeFloorMesh(t){const i=this.Stt.indexOf(t);-1!==i&&this.Stt.splice(i,1)}removeBlockerMesh(t){this.wb.pickBlockerMeshes=this.wb.pickBlockerMeshes||[];const i=this.wb.pickBlockerMeshes.indexOf(t);-1!==i&&this.wb.pickBlockerMeshes.splice(i,1)}removeFloorMeshByName(t){const i=this.RN.scene.getMeshByName(t);i&&this.removeFloorMesh(i)}removeSnapPoint(t){let i=this.Att.indexOf(t);if(-1===i)for(let e=0;e<this.Att.length;++e)if(this.Att[e].equals(t)){i=e;break}return-1!==i&&(this.Att.splice(i,1),!0)}setSelectionFeature(t){this.wtt=t}PN(t){const i=this.RN.currentFrame,e=this.RN.scene;if(!this.attach||!i)return;const s=this.wb.teleportationTargetMesh;if(this.vtt){if(!s)return;s.rotationQuaternion=s.rotationQuaternion||new T;const t=this.M9[this.vtt];if(t&&t.teleportationState.forward){T.RotationYawPitchRollToRef(t.teleportationState.currentRotation+t.teleportationState.baseRotation,0,0,s.rotationQuaternion);let i=!1;if(t.xrController.getWorldPointerRayToRef(this.Py),this.straightRayEnabled){const t=e.pickWithRay(this.Py,(t=>{if(this.wb.pickBlockerMeshes&&-1!==this.wb.pickBlockerMeshes.indexOf(t))return!0;const i=this.Stt.indexOf(t);return-1!==i&&this.Stt[i].absolutePosition.y<this.wb.xrInput.xrCamera.globalPosition.y}));if(t&&t.pickedMesh&&this.wb.pickBlockerMeshes&&-1!==this.wb.pickBlockerMeshes.indexOf(t.pickedMesh))return;t&&t.pickedPoint&&(i=!0,this.xtt(t),this.Ctt(!0),this.Ttt(t))}if(this.parabolicRayEnabled&&!i){const s=t.xrController.pointer.rotationQuaternion.toEulerAngles().x,n=Math.PI/2-Math.abs(s)+1,r=this.parabolicCheckRadius*n;this.Py.origin.addToRef(this.Py.direction.scale(2*r),this.iN),this.iN.y=this.Py.origin.y,this.Py.origin.addInPlace(this.Py.direction.scale(r)),this.iN.subtractToRef(this.Py.origin,this.Py.direction),this.Py.direction.normalize();const h=e.pickWithRay(this.Py,(t=>!(!this.wb.pickBlockerMeshes||-1===this.wb.pickBlockerMeshes.indexOf(t))||-1!==this.Stt.indexOf(t)));if(h&&h.pickedMesh&&this.wb.pickBlockerMeshes&&-1!==this.wb.pickBlockerMeshes.indexOf(h.pickedMesh))return;h&&h.pickedPoint&&(i=!0,this.xtt(h),this.Ctt(!0),this.Ttt(h))}this.Ctt(i)}else this.Ctt(!1)}else this.Ctt(!1)}Ett(){this.wb.defaultTargetMeshOptions=this.wb.defaultTargetMeshOptions||{};const t=this.wb.useUtilityLayer?this.wb.customUtilityLayerScene||Wc.DefaultUtilityLayer.utilityLayerScene:this.RN.scene,i=bc("teleportationTarget",{width:2,height:2,subdivisions:2},t);if(i.isPickable=!1,this.wb.defaultTargetMeshOptions.teleportationCircleMaterial)i.material=this.wb.defaultTargetMeshOptions.teleportationCircleMaterial;else{const e=512,s=new nc("teleportationPlaneDynamicTexture",e,t,!0);s.hasAlpha=!0;const n=s.getContext(),r=e/2,h=e/2,o=200;n.beginPath(),n.arc(r,h,o,0,2*Math.PI,!1),n.fillStyle=this.wb.defaultTargetMeshOptions.teleportationFillColor||"#444444",n.fill(),n.lineWidth=10,n.strokeStyle=this.wb.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",n.stroke(),n.closePath(),s.update();const a=new sc("teleportationPlaneMaterial",t);a.diffuseTexture=s,i.material=a}const e=xc("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},t);if(e.isPickable=!1,e.parent=i,!this.wb.defaultTargetMeshOptions.disableAnimation){const i=new vt("animationInnerCircle","position.y",30,vt.ANIMATIONTYPE_FLOAT,vt.ANIMATIONLOOPMODE_CYCLE),s=[];s.push({frame:0,value:0}),s.push({frame:30,value:.4}),s.push({frame:60,value:0}),i.setKeys(s);const n=new Ze;n.setEasingMode(Ke.EASINGMODE_EASEINOUT),i.setEasingFunction(n),e.animations=[],e.animations.push(i),t.beginAnimation(e,0,60,!0)}const s=Cc("rotationCone",{diameterTop:0,tessellation:4},t);if(s.isPickable=!1,s.scaling.set(.5,.12,.2),s.rotate(Ge.X,Math.PI/2),s.position.z=.6,s.parent=e,this.wb.defaultTargetMeshOptions.torusArrowMaterial)e.material=this.wb.defaultTargetMeshOptions.torusArrowMaterial,s.material=this.wb.defaultTargetMeshOptions.torusArrowMaterial;else{const i=new sc("torusConsMat",t);i.disableLighting=!!this.wb.defaultTargetMeshOptions.disableLighting,i.disableLighting?i.emissiveColor=new _(.3,.3,1):i.diffuseColor=new _(.3,.3,1),i.alpha=.9,e.material=i,s.material=i,this.Rtt=i}void 0!==this.wb.renderingGroupId&&(i.renderingGroupId=this.wb.renderingGroupId,e.renderingGroupId=this.wb.renderingGroupId,s.renderingGroupId=this.wb.renderingGroupId),this.wb.teleportationTargetMesh=i,this.Ctt(!1)}B9(t){const i=this.M9[t];i&&(i.teleportationComponent&&(i.onAxisChangedObserver&&i.teleportationComponent.onAxisValueChangedObservable.remove(i.onAxisChangedObserver),i.onButtonChangedObserver&&i.teleportationComponent.onButtonStateChangedObservable.remove(i.onButtonChangedObserver)),delete this.M9[t])}Itt(t,i=this.wb.snapToPositionRadius||.8){let e=null,s=Number.MAX_VALUE;if(this.Att.length){const n=i*i;this.Att.forEach((i=>{const r=w.DistanceSquared(i,t);r<=n&&r<s&&(s=r,e=i)}))}return e}xtt(t){const i=t.pickedPoint;if(!this.wb.teleportationTargetMesh||!i)return;const e=this.Itt(i);this.ptt=!!e,this.snapPointsOnly&&!this.ptt&&this.Rtt?this.Rtt.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this.ptt&&this.Rtt&&this.Rtt.diffuseColor.set(.3,.3,1),this.wb.teleportationTargetMesh.position.copyFrom(e||i),this.wb.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(t)}Ctt(t){this.wb.teleportationTargetMesh&&this.wb.teleportationTargetMesh.isVisible!==t&&(this.wb.teleportationTargetMesh.isVisible=t,this.wb.teleportationTargetMesh.getChildren(void 0,!1).forEach((i=>{i.isVisible=t})),t?this.wtt&&this.wtt.detach():(this.Mtt&&(this.Mtt.dispose(),this.Mtt=null),this.wtt&&this.wtt.attach()))}Ttt(t){if(!t.pickedPoint||!this.vtt)return;const i=this.wb.useUtilityLayer?this.wb.customUtilityLayerScene||Wc.DefaultUtilityLayer.utilityLayerScene:this.RN.scene,e=this.M9[this.vtt],s=je.CreateQuadraticBezier(e.xrController.pointer.absolutePosition,t.ray.origin,t.pickedPoint,25);this.wb.generateRayPathMesh?this.Mtt=this.wb.generateRayPathMesh(s.getPoints(),t):this.Mtt=fu("teleportation path line",{points:s.getPoints(),instance:this.Mtt,updatable:!0},i),this.Mtt.isPickable=!1,void 0!==this.wb.renderingGroupId&&(this.Mtt.renderingGroupId=this.wb.renderingGroupId)}gtt(t){const i=this.M9[t];if(i&&i.teleportationState.forward&&this.teleportationEnabled&&(i.teleportationState.forward=!1,this.vtt="",!this.snapPointsOnly||this.ptt))if(this.skipNextTeleportation)this.skipNextTeleportation=!1;else if(this.wb.teleportationTargetMesh&&this.wb.teleportationTargetMesh.isVisible){const t=this.wb.xrInput.xrCamera.realWorldHeight;this.wb.xrInput.xrCamera.onBeforeCameraTeleport.notifyObservers(this.wb.xrInput.xrCamera.position),this.wb.xrInput.xrCamera.position.copyFrom(this.wb.teleportationTargetMesh.position),this.wb.xrInput.xrCamera.position.y+=t,T.FromEulerAngles(0,i.teleportationState.currentRotation-(this.RN.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this.wb.xrInput.xrCamera.rotationQuaternion,this.wb.xrInput.xrCamera.rotationQuaternion),this.wb.xrInput.xrCamera.onAfterCameraTeleport.notifyObservers(this.wb.xrInput.xrCamera.position)}}}fS.Name=Cn.TELEPORTATION,fS.Version=1,wn.AddWebXRFeature(fS.Name,((t,i)=>()=>new fS(t,i)),fS.Version,!0);class dS{constructor(){}static CreateAsync(t,i={}){const e=new dS;if(t.onDisposeObservable.addOnce((()=>{e.dispose()})),!i.disableDefaultUI){const s={renderTarget:e.renderTarget,...i.uiOptions||{}};i.optionalFeatures&&("boolean"==typeof i.optionalFeatures?s.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:s.optionalFeatures=i.optionalFeatures),e.enterExitUI=new cS(t,s)}return Yg.CreateAsync(t).then((t=>{if(e.baseExperience=t,i.ignoreNativeCameraTransformation&&(e.baseExperience.camera.compensateOnFirstFrame=!1),e.input=new sS(t.sessionManager,t.camera,{controllerOptions:{renderingGroupId:i.renderingGroupId},...i.inputOptions||{}}),!i.disablePointerSelection){const t={...i.pointerSelectionOptions,xrInput:e.input,renderingGroupId:i.renderingGroupId};e.pointerSelection=e.baseExperience.featuresManager.enableFeature(nS.Name,i.useStablePlugins?"stable":"latest",t),i.disableTeleportation||(e.teleportation=e.baseExperience.featuresManager.enableFeature(fS.Name,i.useStablePlugins?"stable":"latest",{floorMeshes:i.floorMeshes,xrInput:e.input,renderingGroupId:i.renderingGroupId,...i.teleportationOptions}),e.teleportation.setSelectionFeature(e.pointerSelection))}return i.disableNearInteraction||(e.nearInteraction=e.baseExperience.featuresManager.enableFeature(aS.Name,i.useStablePlugins?"stable":"latest",{xrInput:e.input,farInteractionFeature:e.pointerSelection,renderingGroupId:i.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0,...i.nearInteractionOptions})),e.renderTarget=e.baseExperience.sessionManager.getWebXRRenderTarget(i.outputCanvasOptions),i.disableDefaultUI?void 0:e.enterExitUI.setHelperAsync(e.baseExperience,e.renderTarget)})).then((()=>e)).catch((t=>(F.Error("Error initializing XR"),F.Error(t),e)))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}function pS(t){for(;t.firstChild;)t.removeChild(t.firstChild);t.srcObject=null,t.src="",t.removeAttribute("src")}ke.prototype.createDefaultLight=function(t=!1){if(t&&this.lights)for(let t=0;t<this.lights.length;t++)this.lights[t].dispose();0===this.lights.length&&new Po("default light",w.Up(),this)},ke.prototype.createDefaultCamera=function(t=!1,i=!1,e=!1){if(i&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const i=this.getWorldExtends((t=>t.isVisible&&t.isEnabled())),s=i.max.subtract(i.min),n=i.min.add(s.scale(.5));let r,h=1.5*s.length();if(isFinite(h)||(h=1,n.copyFromFloats(0,0,0)),t){const t=new Oh("default camera",-Math.PI/2,Math.PI/2,h,n,this);t.lowerRadiusLimit=.01*h,t.wheelPrecision=100/h,r=t}else{const t=new Dh("default camera",new w(n.x,n.y,-h),this);t.setTarget(n),r=t}r.minZ=.01*h,r.maxZ=1e3*h,r.speed=.2*h,this.activeCamera=r,e&&r.attachControl()}},ke.prototype.createDefaultCameraOrLight=function(t=!1,i=!1,e=!1){this.createDefaultLight(i),this.createDefaultCamera(t,i,e)},ke.prototype.createDefaultSkybox=function(t,i=!1,e=1e3,s=0,n=!0){if(!t)return F.Warn("Can not create default skybox without environment texture."),null;n&&t&&(this.environmentTexture=t);const r=Kc("hdrSkyBox",{size:e},this);if(i){const i=new yg("skyBox",this);i.backFaceCulling=!1,i.reflectionTexture=t.clone(),i.reflectionTexture&&(i.reflectionTexture.coordinatesMode=an.SKYBOX_MODE),i.microSurface=1-s,i.disableLighting=!0,i.twoSidedLighting=!0,r.material=i}else{const i=new sc("skyBox",this);i.backFaceCulling=!1,i.reflectionTexture=t.clone(),i.reflectionTexture&&(i.reflectionTexture.coordinatesMode=an.SKYBOX_MODE),i.disableLighting=!0,r.material=i}return r.isPickable=!1,r.infiniteDistance=!0,r.ignoreCameraMaxZ=!0,r},ke.prototype.createDefaultEnvironment=function(t){return Um?new Um(t,this):null},ke.prototype.createDefaultVRExperience=function(t={}){return new Lc(this,t)},ke.prototype.createDefaultXRExperienceAsync=function(t={}){return dS.CreateAsync(this,t).then((t=>t))};class mS extends an{constructor(t,i,e,s=!1,n=!1,r=an.TRILINEAR_SAMPLINGMODE,h={},o,a=5){var l,c;super(null,e,!s,n),this.btt=null,this._tt=!1,this.ytt=!1,this.sh=-1,this.Ntt=null,this.Ptt=!1,this.Ta=()=>{var t;if(null!=this.Lb){if(!this.ytt)return;this.Lb.dispose(),this.ytt=!1}if(!this.qb().needPOTTextures||ki.IsExponentOfTwo(this.video.videoWidth)&&ki.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=an.WRAP_ADDRESSMODE,this.wrapV=an.WRAP_ADDRESSMODE):(this.wrapU=an.CLAMP_ADDRESSMODE,this.wrapV=an.CLAMP_ADDRESSMODE,this.uO=!1),this.Lb=this.qb().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this.uO,this.samplingMode),this.Lb.format=null!==(t=this.R_)&&void 0!==t?t:5,this.video.autoplay||this.Dtt.poster||this.Dtt.independentVideoSource)this.Ltt(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this);else{const t=this.video.onplaying,i=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=i,this.video.onplaying=t,this.Ltt(),this.Ptt||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this.Ott()}},this.HL=()=>{null!=this.Lb&&(this.ytt||(this.Lb.dispose(),this.Lb=null))},this.Ltt=()=>{if(null==this.Lb)return;if(this.video.readyState<this.video.HAVE_CURRENT_DATA)return;if(this.ytt)return;const t=this.getScene().getFrameId();this.sh!==t&&(this.sh=t,this.qb().updateVideoTexture(this.Lb,this.Ftt?this.Ftt:this.video,this.t_))},this.Dtt={autoPlay:!0,loop:!0,autoUpdateTexture:!0,...h},this.Btt=o,this.uO=s,this.Vb=r,this.autoUpdateTexture=this.Dtt.autoUpdateTexture,this.Ntt=i,this.name=t||this.Utt(i),this.video=this.Vtt(i),this.Ftt=null!==(c=null===(l=this.Ls)||void 0===l?void 0:l.createExternalTexture(this.video))&&void 0!==c?c:null,this.Dtt.independentVideoSource||(this.Dtt.poster&&(this.video.poster=this.Dtt.poster),void 0!==this.Dtt.autoPlay&&(this.video.autoplay=this.Dtt.autoPlay),void 0!==this.Dtt.loop&&(this.video.loop=this.Dtt.loop),void 0!==this.Dtt.muted&&(this.video.muted=this.Dtt.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this.Ltt),this.video.addEventListener("seeked",this.Ltt),this.video.addEventListener("emptied",this.HL),this.Dtt.autoPlay&&this.Ott()),this.ktt=this.Dtt.poster&&!this.Dtt.autoPlay?"play":"canplay",this.video.addEventListener(this.ktt,this.Ta),this.R_=a;const u=this.video.readyState>=this.video.HAVE_CURRENT_DATA;!this.Dtt.poster||this.Dtt.autoPlay&&u?u&&this.Ta():(this.Lb=this.qb().createTexture(this.Dtt.poster,!1,!this.invertY,e),this.ytt=!0)}get onUserActionRequestedObservable(){return this.btt||(this.btt=new h),this.btt}Gtt(t){this.Ptt=!0,this.Btt?this.Btt(null==t?void 0:t.message):F.Error(null==t?void 0:t.message)}Ott(){this.Ptt=!1,this.video.play().catch((t=>{if("NotAllowedError"===(null==t?void 0:t.name)){if(this.btt&&this.btt.hasObservers())return void this.btt.notifyObservers(this);if(!this.video.muted)return F.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this.Ptt=!1,void this.video.play().catch((t=>{this.Gtt(t)}))}this.Gtt(t)}))}getClassName(){return"VideoTexture"}Utt(t){return t instanceof HTMLVideoElement?t.currentSrc:"object"==typeof t?t.toString():t}Vtt(t){if(t.isNative)return t;if(t instanceof HTMLVideoElement)return ki.SetCorsBehavior(t.currentSrc,t),t;const i=document.createElement("video");return"string"==typeof t?(ki.SetCorsBehavior(t,i),i.src=t):(ki.SetCorsBehavior(t[0],i),t.forEach((t=>{const e=document.createElement("source");e.src=t,i.appendChild(e)}))),this.onDisposeObservable.addOnce((()=>{pS(i)})),i}br(){this.update()}update(){this.autoUpdateTexture&&this.updateTexture(!0)}updateTexture(t){t&&(this.video.paused&&this._tt||(this._tt=!0,this.Ltt()))}updateURL(t){this.video.src=t,this.Ntt=t}clone(){return new mS(this.name,this.Ntt,this.getScene(),this.uO,this.invertY,this.samplingMode,this.Dtt)}dispose(){var t;super.dispose(),this.Ntt=null,this.btt&&(this.btt.clear(),this.btt=null),this.video.removeEventListener(this.ktt,this.Ta),this.Dtt.independentVideoSource||(this.video.removeEventListener("paused",this.Ltt),this.video.removeEventListener("seeked",this.Ltt),this.video.removeEventListener("emptied",this.HL),this.video.pause()),null===(t=this.Ftt)||void 0===t||t.dispose()}static CreateFromStreamAsync(t,i,e,s=!0){const n=t.getEngine().createVideoElement(e);return t.getEngine().lh&&(document.body.appendChild(n),n.style.transform="scale(0.0001, 0.0001)",n.style.opacity="0",n.style.position="fixed",n.style.bottom="0px",n.style.right="0px"),n.setAttribute("autoplay",""),n.setAttribute("muted","true"),n.setAttribute("playsinline",""),n.muted=!0,n.isNative||(void 0!==n.mozSrcObject?n.mozSrcObject=i:"object"==typeof n.srcObject?n.srcObject=i:n.src=window.URL&&window.URL.createObjectURL(i)),new Promise((i=>{const e=()=>{const r=new mS("video",n,t,!0,s,void 0,void 0,void 0,4);t.getEngine().lh&&r.onDisposeObservable.addOnce((()=>{n.remove()})),r.onDisposeObservable.addOnce((()=>{pS(n)})),i(r),n.removeEventListener("playing",e)};n.addEventListener("playing",e),n.play()}))}static async CreateFromWebCamAsync(t,i,e=!1,s=!0){if(navigator.mediaDevices){const n=await navigator.mediaDevices.getUserMedia({video:i,audio:e}),r=await this.CreateFromStreamAsync(t,n,i,s);return r.onDisposeObservable.addOnce((()=>{n.getTracks().forEach((t=>{t.stop()}))})),r}return Promise.reject("No support for userMedia on this device")}static CreateFromWebCam(t,i,e,s=!1,n=!0){this.CreateFromWebCamAsync(t,e,s,n).then((function(t){i&&i(t)})).catch((function(t){F.Error(t.name)}))}}class vS extends Vm{get videoTexture(){return this.Lb}get videoMode(){return this.textureMode}set videoMode(t){this.textureMode=t}x6(t,i,e){const s={loop:e.loop,autoPlay:e.autoPlay,autoUpdateTexture:!0,poster:e.poster},n=new mS((this.name||"videoDome")+"_texture",t,i,e.generateMipMaps,this.C6,an.TRILINEAR_SAMPLINGMODE,s);return e.clickToPlay&&(this.mN=i.onPointerObservable.add((t=>{var i;(null===(i=t.pickInfo)||void 0===i?void 0:i.pickedMesh)===this.mesh&&this.Lb.video.play()}),pe.POINTERDOWN)),this.ztt=n.onLoadObservable.add((()=>{this.onLoadObservable.notifyObservers()})),n}dispose(t,i=!1){this.Lb.onLoadObservable.remove(this.ztt),this.Kt.onPointerObservable.remove(this.mN),super.dispose(t,i)}}vS.MODE_MONOSCOPIC=Vm.MODE_MONOSCOPIC,vS.MODE_TOPBOTTOM=Vm.MODE_TOPBOTTOM,vS.MODE_SIDEBYSIDE=Vm.MODE_SIDEBYSIDE;const gS="glowMapGenerationPixelShader",SS="#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)\n#include<helperFunctions>\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;\nuniform sampler2D opacitySampler;\nuniform float opacityIntensity;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef VERTEXALPHA\nvarying vec4 vColor;\n#endif\nuniform vec4 glowColor;\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\nvec4 finalColor=glowColor;\n#ifdef DIFFUSE\nvec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);\n#ifdef DIFFUSE_ISLINEAR\nalbedoTexture=toGammaSpace(albedoTexture);\n#endif\n#ifdef GLOW\nfinalColor.a*=albedoTexture.a;\n#endif\n#ifdef HIGHLIGHT\nfinalColor.a=albedoTexture.a;\n#endif\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vUVOpacity);\n#ifdef OPACITYRGB\nfinalColor.a*=getLuminance(opacityMap.rgb);\n#else\nfinalColor.a*=opacityMap.a;\n#endif\nfinalColor.a*=opacityIntensity;\n#endif\n#ifdef VERTEXALPHA\nfinalColor.a*=vColor.a;\n#endif\n#ifdef ALPHATEST\nif (finalColor.a<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifdef EMISSIVE\nvec4 emissive=texture2D(emissiveSampler,vUVEmissive);\n#ifdef EMISSIVE_ISLINEAR\nemissive=toGammaSpace(emissive);\n#endif\ngl_FragColor=emissive*finalColor;\n#else\ngl_FragColor=finalColor;\n#endif\n#ifdef HIGHLIGHT\ngl_FragColor.a=glowColor.a;\n#endif\n}";ii.ShadersStore[gS]=SS;const ES="glowMapGenerationVertexShader",AS="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nvarying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;\nuniform mat4 opacityMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef VERTEXALPHA\nattribute vec4 color;\nvarying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef CUBEMAP\nvPosition=worldPos;\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*worldPos;\ngl_Position=vPosition;\n#endif\n#ifdef DIFFUSE\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef OPACITY\n#ifdef OPACITYUV1\nvUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef OPACITYUV2\nvUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef VERTEXALPHA\nvColor=color;\n#endif\n#include<clipPlaneVertex>\n}";ii.ShadersStore[ES]=AS;class CS{constructor(t,i){this.ff={},this.Htt=0,this.Xtt={width:0,height:0},this.ES=!0,this.vf=[],this.sx=[],this.Wtt={texture:null,color:new y},this.neutralColor=new y,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new h,this.onBeforeRenderMainTextureObservable=new h,this.onBeforeComposeObservable=new h,this.onBeforeRenderMeshToEffect=new h,this.onAfterRenderMeshToEffect=new h,this.onAfterComposeObservable=new h,this.onSizeChangedObservable=new h,this.$tt={},this.name=t,this.Kt=i||E.LastCreatedScene,CS.qM(this.Kt),this.Ls=this.Kt.getEngine(),this.Htt=this.Ls.getCaps().maxTextureSize,this.Kt.effectLayers.push(this),this.Ytt=[],this.jtt(),this.Ktt()}get camera(){return this.qtt.camera}get renderingGroupId(){return this.qtt.renderingGroupId}set renderingGroupId(t){this.qtt.renderingGroupId=t}get mainTexture(){return this.Z2}setMaterialForRendering(t,i){if(this.Z2.setMaterialForRendering(t,i),Array.isArray(t))for(let e=0;e<t.length;++e){const s=t[e];i?this.$tt[s.uniqueId]=[s,i]:delete this.$tt[s.uniqueId]}else i?this.$tt[t.uniqueId]=[t,i]:delete this.$tt[t.uniqueId]}Qtt(){return 1}YN(t){this.qtt={mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,...t},this.Ztt(),this.Jtt(),this.tit()}jtt(){const t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this.Xu=this.Ls.createIndexBuffer(t)}Ktt(){const t=[];t.push(1,1),t.push(-1,1),t.push(-1,-1),t.push(1,-1);const i=new he(this.Ls,t,he.PositionKind,!1,!1,2);this.ff[he.PositionKind]=i}Ztt(){this.qtt.mainTextureFixedSize?(this.Xtt.width=this.qtt.mainTextureFixedSize,this.Xtt.height=this.qtt.mainTextureFixedSize):(this.Xtt.width=this.Ls.getRenderWidth()*this.qtt.mainTextureRatio,this.Xtt.height=this.Ls.getRenderHeight()*this.qtt.mainTextureRatio,this.Xtt.width=this.Ls.needPOTTextures?Rs.GetExponentOfTwo(this.Xtt.width,this.Htt):this.Xtt.width,this.Xtt.height=this.Ls.needPOTTextures?Rs.GetExponentOfTwo(this.Xtt.height,this.Htt):this.Xtt.height),this.Xtt.width=Math.floor(this.Xtt.width),this.Xtt.height=Math.floor(this.Xtt.height)}Jtt(){this.Z2=new br("EffectLayerMainRTT",{width:this.Xtt.width,height:this.Xtt.height},this.Kt,!1,!0,this.qtt.mainTextureType),this.Z2.activeCamera=this.qtt.camera,this.Z2.wrapU=an.CLAMP_ADDRESSMODE,this.Z2.wrapV=an.CLAMP_ADDRESSMODE,this.Z2.anisotropicFilteringLevel=1,this.Z2.updateSamplingMode(an.BILINEAR_SAMPLINGMODE),this.Z2.renderParticles=!1,this.Z2.renderList=null,this.Z2.ignoreCameraViewport=!0;for(const t in this.$tt){const[i,e]=this.$tt[t];this.Z2.setMaterialForRendering(i,e)}if(this.Z2.customIsReadyFunction=(t,i,e)=>{if((e||0===i)&&t.subMeshes)for(let i=0;i<t.subMeshes.length;++i){const e=t.subMeshes[i],s=e.getMaterial(),n=e.getRenderingMesh();if(!s)continue;const r=n.KI(e.Al,!!e.getReplacementMesh()).hardwareInstancedRendering[e.Al]||n.hasThinInstances;if(this.iit(n,e,s),!this.di(e,r,this.Wtt.texture))return!1}return!0},this.Z2.customRenderFunction=(t,i,e,s)=>{let n;this.onBeforeRenderMainTextureObservable.notifyObservers(this);const r=this.Kt.getEngine();if(s.length){for(r.setColorWrite(!1),n=0;n<s.length;n++)this.eit(s.data[n]);r.setColorWrite(!0)}for(n=0;n<t.length;n++)this.eit(t.data[n]);for(n=0;n<i.length;n++)this.eit(i.data[n]);const h=r.getAlphaMode();for(n=0;n<e.length;n++)this.eit(e.data[n],!0);r.setAlphaMode(h)},this.Z2.onClearObservable.add((t=>{t.clear(this.neutralColor,!0,!0,!0)})),this.Kt.getBoundingBoxRenderer){const t=this.Kt.getBoundingBoxRenderer().enabled;this.Z2.onBeforeBindObservable.add((()=>{this.Kt.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&t})),this.Z2.onAfterUnbindObservable.add((()=>{this.Kt.getBoundingBoxRenderer().enabled=t}))}}sit(t){}di(t,i,e){var s;const n=this.Kt.getEngine(),r=t.getMesh(),h=null===(s=r._m.WT)||void 0===s?void 0:s[n.currentRenderPassId];if(h)return h.isReadyForSubMesh(r,t,i);const o=t.getMaterial();if(!o)return!1;if(this.nit(t.getRenderingMesh()))return o.isReadyForSubMesh(t.getMesh(),t,i);const a=[],l=[he.PositionKind];let c=!1,u=!1;if(o){const t=o.needAlphaTesting(),i=o.getAlphaTestTexture(),e=i&&i.hasAlpha&&(o.useAlphaFromDiffuseTexture||o.y8);i&&(t||e)&&(a.push("#define DIFFUSE"),r.isVerticesDataPresent(he.UV2Kind)&&1===i.coordinatesIndex?(a.push("#define DIFFUSEUV2"),u=!0):r.isVerticesDataPresent(he.UVKind)&&(a.push("#define DIFFUSEUV1"),c=!0),t&&(a.push("#define ALPHATEST"),a.push("#define ALPHATESTVALUE 0.4")),i.gammaSpace||a.push("#define DIFFUSE_ISLINEAR"));const s=o.opacityTexture;s&&(a.push("#define OPACITY"),r.isVerticesDataPresent(he.UV2Kind)&&1===s.coordinatesIndex?(a.push("#define OPACITYUV2"),u=!0):r.isVerticesDataPresent(he.UVKind)&&(a.push("#define OPACITYUV1"),c=!0))}e&&(a.push("#define EMISSIVE"),r.isVerticesDataPresent(he.UV2Kind)&&1===e.coordinatesIndex?(a.push("#define EMISSIVEUV2"),u=!0):r.isVerticesDataPresent(he.UVKind)&&(a.push("#define EMISSIVEUV1"),c=!0),e.gammaSpace||a.push("#define EMISSIVE_ISLINEAR")),r.useVertexColors&&r.isVerticesDataPresent(he.ColorKind)&&r.hasVertexAlpha&&o.transparencyMode!==Vs.MATERIAL_OPAQUE&&(l.push(he.ColorKind),a.push("#define VERTEXALPHA")),c&&(l.push(he.UVKind),a.push("#define UV1")),u&&(l.push(he.UV2Kind),a.push("#define UV2"));const f=new Jn;if(r.useBones&&r.computeBonesUsingShaders){l.push(he.MatricesIndicesKind),l.push(he.MatricesWeightsKind),r.numBoneInfluencers>4&&(l.push(he.MatricesIndicesExtraKind),l.push(he.MatricesWeightsExtraKind)),a.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers);const t=r.skeleton;t&&t.isUsingTextureForMatrices?a.push("#define BONETEXTURE"):a.push("#define BonesPerMesh "+(t?t.bones.length+1:0)),r.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,r)}else a.push("#define NUM_BONE_INFLUENCERS 0");const d=r.morphTargetManager;let p=0;d&&d.numInfluencers>0&&(a.push("#define MORPHTARGETS"),p=d.numInfluencers,a.push("#define NUM_MORPH_INFLUENCERS "+p),d.isUsingTextureForTargets&&a.push("#define MORPHTARGETS_TEXTURE"),Fs.PrepareAttributesForMorphTargetsInfluencers(l,r,p)),i&&(a.push("#define INSTANCES"),Fs.PushAttributesForInstances(l),t.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES")),Ps(o,this.Kt,a),this.sit(a);const m=t.mC(void 0,!0),v=m.defines,g=a.join("\n");if(v!==g){const t=["world","mBones","viewProjection","glowColor","morphTargetInfluences","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices"];Ns(t),m.setEffect(this.Ls.createEffect("glowMapGeneration",l,t,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],g,f,void 0,void 0,{maxSimultaneousMorphTargets:p}),g)}return m.effect.isReady()}render(){for(let t=0;t<this.vf.length;t++)if(!this.vf[t].isReady())return;const t=this.Kt.getEngine(),i=this.Qtt();let e=!0;for(let t=0;t<i;++t){let i=this.Ytt[t];i||(i=this.Ytt[t]=new vi(this.Ls),i.setEffect(this.rit())),e=e&&i.effect.isReady()}if(!e)return;this.onBeforeComposeObservable.notifyObservers(this);const s=t.getAlphaMode();for(let e=0;e<i;++e){const i=this.Ytt[e];t.enableEffect(i),t.setState(!1),t.bindBuffers(this.ff,this.Xu,i.effect),t.setAlphaMode(this.qtt.alphaBlendingMode),this.oit(i.effect,e)}t.setAlphaMode(s),this.onAfterComposeObservable.notifyObservers(this);const n=this.Z2.getSize();this.Ztt(),n.width===this.Xtt.width&&n.height===this.Xtt.height||0===this.Xtt.width||0===this.Xtt.height||(this.onSizeChangedObservable.notifyObservers(this),this.ait(),this.Jtt(),this.tit())}hasMesh(t){return-1===this.renderingGroupId||t.renderingGroupId===this.renderingGroupId}shouldRender(){return this.isEnabled&&this.ES}lit(t){return!0}cit(t,i){return!i.needAlphaBlendingForMesh(t)}uit(){return!0}eit(t,i=!1){var e,s;if(!this.shouldRender())return;const n=t.getMaterial(),r=t.getMesh(),h=t.getReplacementMesh(),o=t.getRenderingMesh(),a=t.getEffectiveMesh(),l=this.Kt,c=l.getEngine();if(a._m.ET=!1,!n)return;if(!this.cit(o,n))return;let u=null!==(e=o.overrideMaterialSideOrientation)&&void 0!==e?e:n.sideOrientation;a.zi()<0&&(u=u===Vs.ClockWiseSideOrientation?Vs.CounterClockWiseSideOrientation:Vs.ClockWiseSideOrientation);const f=u===Vs.ClockWiseSideOrientation;c.setState(n.backFaceCulling,n.zOffset,void 0,f,n.cullBackFaces,void 0,n.zOffsetUnits);const d=o.KI(t.Al,!!h);if(d.mustReturn)return;if(!this.lit(o))return;const p=d.hardwareInstancedRendering[t.Al]||o.hasThinInstances;if(this.iit(o,t,n),this.onBeforeRenderMeshToEffect.notifyObservers(r),this.nit(o))o.render(t,i,h||void 0);else if(this.di(t,p,this.Wtt.texture)){const e=null===(s=a._m.WT)||void 0===s?void 0:s[c.currentRenderPassId];let r=t.mC();if(!r&&e&&(r=e.mC()),!r)return;const h=r.effect;if(c.enableEffect(r),!p){const i=l.forcePointsCloud?Vs.PointFillMode:l.forceWireframe?Vs.WireFrameFillMode:n.fillMode;o.$C(t,h,i)}if(e?e.bindForSubMesh(a.getWorldMatrix(),a,t):(h.setMatrix("viewProjection",l.getTransformMatrix()),h.setMatrix("world",a.getWorldMatrix()),h.setFloat4("glowColor",this.Wtt.color.r,this.Wtt.color.g,this.Wtt.color.b,this.Wtt.color.a)),!e){const t=n.needAlphaTesting(),e=n.getAlphaTestTexture(),s=e&&e.hasAlpha&&(n.useAlphaFromDiffuseTexture||n.y8);if(e&&(t||s)){h.setTexture("diffuseSampler",e);const t=e.getTextureMatrix();t&&h.setMatrix("diffuseMatrix",t)}const r=n.opacityTexture;if(r){h.setTexture("opacitySampler",r),h.setFloat("opacityIntensity",r.level);const t=r.getTextureMatrix();t&&h.setMatrix("opacityMatrix",t)}if(this.Wtt.texture&&(h.setTexture("emissiveSampler",this.Wtt.texture),h.setMatrix("emissiveMatrix",this.Wtt.texture.getTextureMatrix())),o.useBones&&o.computeBonesUsingShaders&&o.skeleton){const t=o.skeleton;if(t.isUsingTextureForMatrices){const i=t.getTransformMatrixTexture(o);if(!i)return;h.setTexture("boneSampler",i),h.setFloat("boneTextureWidth",4*(t.bones.length+1))}else h.setMatrices("mBones",t.getTransformMatrices(o))}Fs.BindMorphTargetParameters(o,h),o.morphTargetManager&&o.morphTargetManager.isUsingTextureForTargets&&o.morphTargetManager.$C(h),i&&c.setAlphaMode(n.alphaMode),Ds(h,n,l)}o.eM(a,t,h,n.fillMode,d,p,((t,i)=>h.setMatrix("world",i)))}else this.Z2.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(r)}nit(t){return!1}br(){const t=this.ff[he.PositionKind];t&&t.br(),this.jtt()}ait(){this.Z2.dispose();for(let t=0;t<this.vf.length;t++)this.vf[t]&&this.vf[t].dispose();this.vf=[];for(let t=0;t<this.sx.length;t++)this.sx[t]&&this.sx[t].dispose();this.sx=[]}dispose(){const t=this.ff[he.PositionKind];t&&(t.dispose(),this.ff[he.PositionKind]=null),this.Xu&&(this.Kt.getEngine().ca(this.Xu),this.Xu=null);for(const t of this.Ytt)t.dispose();this.Ytt=[],this.ait();const i=this.Kt.effectLayers.indexOf(this,0);i>-1&&this.Kt.effectLayers.splice(i,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(t,i,e){return ki.Instantiate(t.customType).Parse(t,i,e)}}CS.qM=t=>{throw X("EffectLayerSceneComponent")},ut([Q()],CS.prototype,"name",void 0),ut([nt()],CS.prototype,"neutralColor",void 0),ut([Q()],CS.prototype,"isEnabled",void 0),ut([function(t){return K(11,t)}()],CS.prototype,"camera",null),ut([Q()],CS.prototype,"renderingGroupId",null),ut([Q()],CS.prototype,"disableBoundingBoxesFromEffectLayer",void 0),e.AddParser(fe.NAME_EFFECTLAYER,((t,i,e,s)=>{if(t.effectLayers){e.effectLayers||(e.effectLayers=new Array);for(let n=0;n<t.effectLayers.length;n++){const r=CS.Parse(t.effectLayers[n],i,s);e.effectLayers.push(r)}}})),e.prototype.removeEffectLayer=function(t){const i=this.effectLayers.indexOf(t);return-1!==i&&this.effectLayers.splice(i,1),i},e.prototype.addEffectLayer=function(t){this.effectLayers.push(t)};class wS{constructor(t){this.name=fe.NAME_EFFECTLAYER,this.fit=!1,this.dit=!1,this.pit=!1,this.scene=t||E.LastCreatedScene,this.scene&&(this.Ls=this.scene.getEngine(),this.scene.effectLayers=new Array)}register(){this.scene.Xv.registerStep(fe.STEP_ISREADYFORMESH_EFFECTLAYER,this,this.mit),this.scene.jv.registerStep(fe.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this.vit),this.scene.Kv.registerStep(fe.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this.tZ),this.scene.ad.registerStep(fe.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this.git),this.scene.Jv.registerStep(fe.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this.Sit),this.scene.Jv.registerStep(fe.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this.Eit)}rebuild(){const t=this.scene.effectLayers;for(const i of t)i.br()}serialize(t){t.effectLayers=[];const i=this.scene.effectLayers;for(const e of i)e.serialize&&t.effectLayers.push(e.serialize())}addFromContainer(t){t.effectLayers&&t.effectLayers.forEach((t=>{this.scene.addEffectLayer(t)}))}removeFromContainer(t,i){t.effectLayers&&t.effectLayers.forEach((t=>{this.scene.removeEffectLayer(t),i&&t.dispose()}))}dispose(){const t=this.scene.effectLayers;for(;t.length;)t[0].dispose()}mit(t,i){const e=this.Ls.currentRenderPassId,s=this.scene.effectLayers;for(const n of s){if(!n.hasMesh(t))continue;const s=n.Z2;this.Ls.currentRenderPassId=s.renderPassId;for(const s of t.subMeshes)if(!n.isReady(s,i))return this.Ls.currentRenderPassId=e,!1}return this.Ls.currentRenderPassId=e,!0}vit(t){this.fit=!1,this.dit=!1;let i=!1;const e=this.scene.effectLayers;if(e&&e.length>0){this.pit=this.Ls.getStencilBuffer();for(const s of e)if(s.shouldRender()&&(!s.camera||s.camera.cameraRigMode===hs.RIG_MODE_NONE&&t===s.camera||s.camera.cameraRigMode!==hs.RIG_MODE_NONE&&s.camera.uS.indexOf(t)>-1)){this.fit=!0,this.dit=this.dit||s.needStencil();const t=s.Z2;t.ES()&&(this.scene.incrementRenderId(),t.render(!1,!1),i=!0)}this.scene.incrementRenderId()}return i}tZ(){this.dit&&this.Ls.setStencilBuffer(!0)}Sit(){this.dit&&this.Ls.setStencilBuffer(this.pit)}jI(t){if(this.fit){this.Ls.setDepthBuffer(!1);const i=this.scene.effectLayers;for(let e=0;e<i.length;e++){const s=i[e];s.renderingGroupId===t&&s.shouldRender()&&s.render()}this.Ls.setDepthBuffer(!0)}}Eit(){this.fit&&this.jI(-1)}git(t){!this.scene.Qg()&&this.fit&&this.jI(t)}}CS.qM=t=>{let i=t.Mg(fe.NAME_EFFECTLAYER);i||(i=new wS(t),t.Ig(i))};const xS="glowMapMergePixelShader",TS="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#ifdef EMISSIVE\nuniform sampler2D textureSampler2;\n#endif\nuniform float offset;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef EMISSIVE\nbaseColor+=texture2D(textureSampler2,vUV);\nbaseColor*=offset;\n#else\nbaseColor.a=abs(offset-baseColor.a);\n#ifdef STROKE\nfloat alpha=smoothstep(.0,.1,baseColor.a);\nbaseColor.a=alpha;\nbaseColor.rgb=baseColor.rgb*alpha;\n#endif\n#endif\n#if LDR\nbaseColor=clamp(baseColor,0.,1.0);\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";ii.ShadersStore[xS]=TS;const RS="glowMapMergeVertexShader",IS="attribute vec2 position;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[RS]=IS;e.prototype.getGlowLayerByName=function(t){var i;for(let e=0;e<(null===(i=this.effectLayers)||void 0===i?void 0:i.length);e++)if(this.effectLayers[e].name===t&&this.effectLayers[e].getEffectName()===MS.EffectName)return this.effectLayers[e];return null};class MS extends CS{constructor(t,i,e){super(t,i),this.Ait=1,this.mH=[],this.gH=[],this.Cit=[],this.neutralColor=new y(0,0,0,1),this.wb={mainTextureRatio:MS.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,...e},this.YN({alphaBlendingMode:this.wb.alphaBlendingMode,camera:this.wb.camera,mainTextureFixedSize:this.wb.mainTextureFixedSize,mainTextureRatio:this.wb.mainTextureRatio,renderingGroupId:this.wb.renderingGroupId,mainTextureType:this.wb.mainTextureType})}set blurKernelSize(t){if(t===this.wb.blurKernelSize)return;this.wb.blurKernelSize=t;const i=this.wit();this.xit.kernel=i,this.Tit.kernel=i,this.Rit.kernel=i,this.Iit.kernel=i}get blurKernelSize(){return this.wb.blurKernelSize}set intensity(t){this.Ait=t}get intensity(){return this.Ait}getEffectName(){return MS.EffectName}rit(){let t="#define EMISSIVE \n";return this.wb.ldrMerge&&(t+="#define LDR \n"),this.Ls.createEffect("glowMapMerge",[he.PositionKind],["offset"],["textureSampler","textureSampler2"],t)}tit(){let t=this.Xtt.width,i=this.Xtt.height;t=this.Ls.needPOTTextures?Rs.GetExponentOfTwo(t,this.Htt):t,i=this.Ls.needPOTTextures?Rs.GetExponentOfTwo(i,this.Htt):i;let e=0;e=this.Ls.getCaps().textureHalfFloatRender?2:0,this.Mit=new br("GlowLayerBlurRTT",{width:t,height:i},this.Kt,!1,!0,e),this.Mit.wrapU=an.CLAMP_ADDRESSMODE,this.Mit.wrapV=an.CLAMP_ADDRESSMODE,this.Mit.updateSamplingMode(an.BILINEAR_SAMPLINGMODE),this.Mit.renderParticles=!1,this.Mit.ignoreCameraViewport=!0;const s=Math.floor(t/2),n=Math.floor(i/2);this.bit=new br("GlowLayerBlurRTT2",{width:s,height:n},this.Kt,!1,!0,e),this.bit.wrapU=an.CLAMP_ADDRESSMODE,this.bit.wrapV=an.CLAMP_ADDRESSMODE,this.bit.updateSamplingMode(an.BILINEAR_SAMPLINGMODE),this.bit.renderParticles=!1,this.bit.ignoreCameraViewport=!0,this.sx=[this.Mit,this.bit];const r=this.wit();this.xit=new xm("GlowLayerHBP1",new C(1,0),r,{width:t,height:i},null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,e),this.xit.width=t,this.xit.height=i,this.xit.externalTextureSamplerBinding=!0,this.xit.onApplyObservable.add((t=>{t.setTexture("textureSampler",this.Z2)})),this.Tit=new xm("GlowLayerVBP1",new C(0,1),r,{width:t,height:i},null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,e),this.Rit=new xm("GlowLayerHBP2",new C(1,0),r,{width:s,height:n},null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,e),this.Rit.width=s,this.Rit.height=n,this.Rit.externalTextureSamplerBinding=!0,this.Rit.onApplyObservable.add((t=>{t.setTexture("textureSampler",this.Mit)})),this.Iit=new xm("GlowLayerVBP2",new C(0,1),r,{width:s,height:n},null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,e),this.vf=[this.xit,this.Tit,this.Rit,this.Iit],this._it=[this.xit,this.Tit],this.yit=[this.Rit,this.Iit],this.Z2.samples=this.wb.mainTextureSamples,this.Z2.onAfterUnbindObservable.add((()=>{const t=this.Mit.renderTarget;if(t){this.Kt.postProcessManager.directRender(this._it,t,!0);const i=this.bit.renderTarget;i&&this.Kt.postProcessManager.directRender(this.yit,i,!0),this.Ls.unBindFramebuffer(null!=i?i:t,!0)}})),this.vf.map((t=>{t.autoClear=!1}))}wit(){return this.wb.blurKernelSize/2}isReady(t,i){const e=t.getMaterial(),s=t.getRenderingMesh();if(!e||!s)return!1;const n=e.emissiveTexture;return super.di(t,i,n)}needStencil(){return!1}cit(t,i){return!0}oit(t){t.setTexture("textureSampler",this.Mit),t.setTexture("textureSampler2",this.bit),t.setFloat("offset",this.Ait);const i=this.Ls,e=i.getStencilBuffer();i.setStencilBuffer(!1),i.drawElementsType(Vs.TriangleFillMode,0,6),i.setStencilBuffer(e)}iit(t,i,e){var s;let n=1;if(this.customEmissiveTextureSelector?this.Wtt.texture=this.customEmissiveTextureSelector(t,i,e):e?(this.Wtt.texture=e.emissiveTexture,this.Wtt.texture&&(n=this.Wtt.texture.level)):this.Wtt.texture=null,this.customEmissiveColorSelector)this.customEmissiveColorSelector(t,i,e,this.Wtt.color);else if(e.emissiveColor){n*=null!==(s=e.emissiveIntensity)&&void 0!==s?s:1,this.Wtt.color.set(e.emissiveColor.r*n,e.emissiveColor.g*n,e.emissiveColor.b*n,e.alpha)}else this.Wtt.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}lit(t){return this.hasMesh(t)}sit(t){t.push("#define GLOW")}addExcludedMesh(t){-1===this.gH.indexOf(t.uniqueId)&&this.gH.push(t.uniqueId)}removeExcludedMesh(t){const i=this.gH.indexOf(t.uniqueId);-1!==i&&this.gH.splice(i,1)}addIncludedOnlyMesh(t){-1===this.mH.indexOf(t.uniqueId)&&this.mH.push(t.uniqueId)}removeIncludedOnlyMesh(t){const i=this.mH.indexOf(t.uniqueId);-1!==i&&this.mH.splice(i,1)}hasMesh(t){return!!super.hasMesh(t)&&(this.mH.length?-1!==this.mH.indexOf(t.uniqueId):!this.gH.length||-1===this.gH.indexOf(t.uniqueId))}nit(t){return 0!=this.Cit.length&&this.Cit.indexOf(t.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(t){t.resetDrawCache(this.Z2.renderPassId),this.Cit.push(t.uniqueId),t.onDisposeObservable.add((()=>{this.Nit(t)}))}unReferenceMeshFromUsingItsOwnMaterial(t){let i=this.Cit.indexOf(t.uniqueId);for(;i>=0;)this.Cit.splice(i,1),i=this.Cit.indexOf(t.uniqueId);t.resetDrawCache(this.Z2.renderPassId)}Nit(t){this.removeIncludedOnlyMesh(t),this.removeExcludedMesh(t)}getClassName(){return"GlowLayer"}serialize(){const t=ot.Serialize(this);let i;if(t.customType="BABYLON.GlowLayer",t.includedMeshes=[],this.mH.length)for(i=0;i<this.mH.length;i++){const e=this.Kt.getMeshByUniqueId(this.mH[i]);e&&t.includedMeshes.push(e.id)}if(t.excludedMeshes=[],this.gH.length)for(i=0;i<this.gH.length;i++){const e=this.Kt.getMeshByUniqueId(this.gH[i]);e&&t.excludedMeshes.push(e.id)}return t}static Parse(t,i,e){const s=ot.Parse((()=>new MS(t.name,i,t.options)),t,i,e);let n;for(n=0;n<t.excludedMeshes.length;n++){const e=i.getMeshById(t.excludedMeshes[n]);e&&s.addExcludedMesh(e)}for(n=0;n<t.includedMeshes.length;n++){const e=i.getMeshById(t.includedMeshes[n]);e&&s.addIncludedOnlyMesh(e)}return s}}MS.EffectName="GlowLayer",MS.DefaultBlurKernelSize=32,MS.DefaultTextureRatio=.5,ut([Q()],MS.prototype,"blurKernelSize",null),ut([Q()],MS.prototype,"intensity",null),ut([Q("options")],MS.prototype,"_options",void 0),v("BABYLON.GlowLayer",MS);const bS="glowBlurPostProcessPixelShader",_S="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\nfloat getLuminance(vec3 color)\n{\nreturn dot(color,vec3(0.2126,0.7152,0.0722));\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat weights[7];\nweights[0]=0.05;\nweights[1]=0.1;\nweights[2]=0.2;\nweights[3]=0.3;\nweights[4]=0.2;\nweights[5]=0.1;\nweights[6]=0.05;\nvec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);\nvec2 texelStep=texelSize*direction*blurWidth;\nvec2 start=vUV-3.0*texelStep;\nvec4 baseColor=vec4(0.,0.,0.,0.);\nvec2 texelOffset=vec2(0.,0.);\nfor (int i=0; i<7; i++)\n{\nvec4 texel=texture2D(textureSampler,start+texelOffset);\nbaseColor.a+=texel.a*weights[i];\nfloat luminance=getLuminance(baseColor.rgb);\nfloat luminanceTexel=getLuminance(texel.rgb);\nfloat choice=step(luminanceTexel,luminance);\nbaseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;\ntexelOffset+=texelStep;\n}\ngl_FragColor=baseColor;\n}";ii.ShadersStore[bS]=_S;e.prototype.getHighlightLayerByName=function(t){var i;for(let e=0;e<(null===(i=this.effectLayers)||void 0===i?void 0:i.length);e++)if(this.effectLayers[e].name===t&&this.effectLayers[e].getEffectName()===NS.EffectName)return this.effectLayers[e];return null};class yS extends nr{constructor(t,i,e,s,n,r=an.BILINEAR_SAMPLINGMODE,h,o){super(t,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,s,n,r,h,o),this.direction=i,this.kernel=e,this.onApplyObservable.add((t=>{t.setFloat2("screenSize",this.width,this.height),t.setVector2("direction",this.direction),t.setFloat("blurWidth",this.kernel)}))}}class NS extends CS{constructor(t,i,e){super(t,i),this.name=t,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new h,this.onAfterBlurObservable=new h,this.Pit=NS.GlowingMeshStencilReference++,this.OC={},this.gH={},this.neutralColor=NS.NeutralColor,this.Ls.isStencilEnable||F.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this.wb={mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,...e},this.YN({alphaBlendingMode:this.wb.alphaBlendingMode,camera:this.wb.camera,mainTextureFixedSize:this.wb.mainTextureFixedSize,mainTextureRatio:this.wb.mainTextureRatio,renderingGroupId:this.wb.renderingGroupId,mainTextureType:this.wb.mainTextureType}),this.ES=!1}set blurHorizontalSize(t){this.Dit.kernel=t,this.wb.blurHorizontalSize=t}set blurVerticalSize(t){this.Lit.kernel=t,this.wb.blurVerticalSize=t}get blurHorizontalSize(){return this.Dit.kernel}get blurVerticalSize(){return this.Lit.kernel}getEffectName(){return NS.EffectName}Qtt(){return 2}rit(){return this.Ls.createEffect("glowMapMerge",[he.PositionKind],["offset"],["textureSampler"],this.wb.isStroke?"#define STROKE \n":void 0)}tit(){let t=this.Xtt.width*this.wb.blurTextureSizeRatio,i=this.Xtt.height*this.wb.blurTextureSizeRatio;t=this.Ls.needPOTTextures?Rs.GetExponentOfTwo(t,this.Htt):t,i=this.Ls.needPOTTextures?Rs.GetExponentOfTwo(i,this.Htt):i;let e=0;e=this.Ls.getCaps().textureHalfFloatRender?2:0,this.Oit=new br("HighlightLayerBlurRTT",{width:t,height:i},this.Kt,!1,!0,e),this.Oit.wrapU=an.CLAMP_ADDRESSMODE,this.Oit.wrapV=an.CLAMP_ADDRESSMODE,this.Oit.anisotropicFilteringLevel=16,this.Oit.updateSamplingMode(an.TRILINEAR_SAMPLINGMODE),this.Oit.renderParticles=!1,this.Oit.ignoreCameraViewport=!0,this.sx=[this.Oit],2===this.wb.alphaBlendingMode?(this.Fit=new Zh("HighlightLayerPPP",this.wb.blurTextureSizeRatio,null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine()),this.Fit.externalTextureSamplerBinding=!0,this.Fit.onApplyObservable.add((t=>{t.setTexture("textureSampler",this.Z2)})),this.Dit=new yS("HighlightLayerHBP",new C(1,0),this.wb.blurHorizontalSize,1,null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine()),this.Dit.onApplyObservable.add((e=>{e.setFloat2("screenSize",t,i)})),this.Lit=new yS("HighlightLayerVBP",new C(0,1),this.wb.blurVerticalSize,1,null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine()),this.Lit.onApplyObservable.add((e=>{e.setFloat2("screenSize",t,i)})),this.vf=[this.Fit,this.Dit,this.Lit]):(this.Dit=new xm("HighlightLayerHBP",new C(1,0),this.wb.blurHorizontalSize/2,{width:t,height:i},null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,e),this.Dit.width=t,this.Dit.height=i,this.Dit.externalTextureSamplerBinding=!0,this.Dit.onApplyObservable.add((t=>{t.setTexture("textureSampler",this.Z2)})),this.Lit=new xm("HighlightLayerVBP",new C(0,1),this.wb.blurVerticalSize/2,{width:t,height:i},null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,e),this.vf=[this.Dit,this.Lit]),this.Z2.onAfterUnbindObservable.add((()=>{this.onBeforeBlurObservable.notifyObservers(this);const t=this.Oit.renderTarget;t&&(this.Kt.postProcessManager.directRender(this.vf,t,!0),this.Ls.unBindFramebuffer(t,!0)),this.onAfterBlurObservable.notifyObservers(this)})),this.vf.map((t=>{t.autoClear=!1}))}needStencil(){return!0}isReady(t,i){const e=t.getMaterial(),s=t.getRenderingMesh();if(!e||!s||!this.OC)return!1;let n=null;const r=this.OC[s.uniqueId];return r&&r.glowEmissiveOnly&&e&&(n=e.emissiveTexture),super.di(t,i,n)}oit(t,i){t.setTexture("textureSampler",this.Oit);const e=this.Ls;e.cacheStencilState(),e.setStencilOperationPass(7681),e.setStencilOperationFail(7680),e.setStencilOperationDepthFail(7680),e.setStencilMask(0),e.setStencilBuffer(!0),e.setStencilFunctionReference(this.Pit),this.outerGlow&&0===i&&(t.setFloat("offset",0),e.setStencilFunction(517),e.drawElementsType(Vs.TriangleFillMode,0,6)),this.innerGlow&&1===i&&(t.setFloat("offset",1),e.setStencilFunction(514),e.drawElementsType(Vs.TriangleFillMode,0,6)),e.restoreStencilState()}shouldRender(){return!!super.shouldRender()&&!!this.OC}lit(t){return(!this.gH||!this.gH[t.uniqueId])&&!!super.hasMesh(t)}cit(t,i){return!0}sit(t){t.push("#define HIGHLIGHT")}iit(t,i,e){const s=this.OC[t.uniqueId];s?this.Wtt.color.set(s.color.r,s.color.g,s.color.b,1):this.Wtt.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),s&&s.glowEmissiveOnly&&e?(this.Wtt.texture=e.emissiveTexture,this.Wtt.color.set(1,1,1,1)):this.Wtt.texture=null}addExcludedMesh(t){if(!this.gH)return;this.gH[t.uniqueId]||(this.gH[t.uniqueId]={mesh:t,beforeBind:t.onBeforeBindObservable.add((t=>{t.getEngine().setStencilBuffer(!1)})),afterRender:t.onAfterRenderObservable.add((t=>{t.getEngine().setStencilBuffer(!0)}))})}removeExcludedMesh(t){if(!this.gH)return;const i=this.gH[t.uniqueId];i&&(i.beforeBind&&t.onBeforeBindObservable.remove(i.beforeBind),i.afterRender&&t.onAfterRenderObservable.remove(i.afterRender)),this.gH[t.uniqueId]=null}hasMesh(t){return!!this.OC&&(!!super.hasMesh(t)&&(void 0!==this.OC[t.uniqueId]&&null!==this.OC[t.uniqueId]))}addMesh(t,i,e=!1){if(!this.OC)return;const s=this.OC[t.uniqueId];s?s.color=i:(this.OC[t.uniqueId]={mesh:t,color:i,observerHighlight:t.onBeforeBindObservable.add((t=>{this.isEnabled&&(this.gH&&this.gH[t.uniqueId]?this.Bit(t):t.getScene().getEngine().setStencilFunctionReference(this.Pit))})),observerDefault:t.onAfterRenderObservable.add((t=>{this.isEnabled&&this.Bit(t)})),glowEmissiveOnly:e},t.onDisposeObservable.add((()=>{this.Nit(t)}))),this.ES=!0}removeMesh(t){if(!this.OC)return;const i=this.OC[t.uniqueId];i&&(i.observerHighlight&&t.onBeforeBindObservable.remove(i.observerHighlight),i.observerDefault&&t.onAfterRenderObservable.remove(i.observerDefault),delete this.OC[t.uniqueId]),this.ES=!1;for(const t in this.OC)if(this.OC[t]){this.ES=!0;break}}removeAllMeshes(){if(this.OC)for(const t in this.OC)if(Object.prototype.hasOwnProperty.call(this.OC,t)){const i=this.OC[t];i&&this.removeMesh(i.mesh)}}Bit(t){t.getScene().getEngine().setStencilFunctionReference(NS.NormalMeshStencilReference)}Nit(t){this.removeMesh(t),this.removeExcludedMesh(t)}dispose(){if(this.OC){for(const t in this.OC){const i=this.OC[t];i&&i.mesh&&(i.observerHighlight&&i.mesh.onBeforeBindObservable.remove(i.observerHighlight),i.observerDefault&&i.mesh.onAfterRenderObservable.remove(i.observerDefault))}this.OC=null}if(this.gH){for(const t in this.gH){const i=this.gH[t];i&&(i.beforeBind&&i.mesh.onBeforeBindObservable.remove(i.beforeBind),i.afterRender&&i.mesh.onAfterRenderObservable.remove(i.afterRender))}this.gH=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){const t=ot.Serialize(this);if(t.customType="BABYLON.HighlightLayer",t.meshes=[],this.OC)for(const i in this.OC){const e=this.OC[i];e&&t.meshes.push({glowEmissiveOnly:e.glowEmissiveOnly,color:e.color.asArray(),meshId:e.mesh.id})}if(t.excludedMeshes=[],this.gH)for(const i in this.gH){const e=this.gH[i];e&&t.excludedMeshes.push(e.mesh.id)}return t}static Parse(t,i,e){const s=ot.Parse((()=>new NS(t.name,i,t.options)),t,i,e);let n;for(n=0;n<t.excludedMeshes.length;n++){const e=i.getMeshById(t.excludedMeshes[n]);e&&s.addExcludedMesh(e)}for(n=0;n<t.meshes.length;n++){const e=t.meshes[n],r=i.getMeshById(e.meshId);r&&s.addMesh(r,_.FromArray(e.color),e.glowEmissiveOnly)}return s}}NS.EffectName="HighlightLayer",NS.NeutralColor=new y(0,0,0,0),NS.GlowingMeshStencilReference=2,NS.NormalMeshStencilReference=1,ut([Q()],NS.prototype,"innerGlow",void 0),ut([Q()],NS.prototype,"outerGlow",void 0),ut([Q()],NS.prototype,"blurHorizontalSize",null),ut([Q()],NS.prototype,"blurVerticalSize",null),ut([Q("options")],NS.prototype,"_options",void 0),v("BABYLON.HighlightLayer",NS);const PS="layerPixelShader",DS="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec4 color;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef LINEAR\nbaseColor.rgb=toGammaSpace(baseColor.rgb);\n#endif\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";ii.ShadersStore[PS]=DS;const LS="layerVertexShader",OS="attribute vec2 position;\nuniform vec2 scale;\nuniform vec2 offset;\nuniform mat4 textureMatrix;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 shiftedPosition=position*scale+offset;\nvUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));\ngl_Position=vec4(shiftedPosition,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[LS]=OS;class FS{constructor(t,i,e,s,n){this.size=t,this.position=i,this.alphaMode=6,this.color=e||new _(1,1,1),this.texture=s?new an(s,n.getScene(),!0):null,this.Uit=n;const r=n.scene.getEngine();this.SC=new vi(r),this.SC.effect=r.createEffect("lensFlare",[he.PositionKind],["color","viewportMatrix"],["textureSampler"],""),n.lensFlares.push(this)}static AddFlare(t,i,e,s,n){return new FS(t,i,e,s,n)}dispose(){this.texture&&this.texture.dispose();const t=this.Uit.lensFlares.indexOf(this);this.Uit.lensFlares.splice(t,1)}}const BS="lensFlarePixelShader",US="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec4 color;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\ngl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";ii.ShadersStore[BS]=US;const VS="lensFlareVertexShader",kS="attribute vec2 position;\nuniform mat4 viewportMatrix;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;\ngl_Position=viewportMatrix*vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[VS]=kS;class GS{constructor(t,i,e){this.name=t,this.lensFlares=new Array,this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this.ff={},this.ui=!0,this.Kt=e||E.LastCreatedScene,GS.qM(this.Kt),this.Vit=i,this.id=t,e.lensFlareSystems.push(this),this.meshesSelectionPredicate=t=>e.activeCamera&&t.material&&t.isVisible&&t.isEnabled()&&t.isBlocker&&0!=(t.layerMask&e.activeCamera.layerMask);const s=e.getEngine(),n=[];n.push(1,1),n.push(-1,1),n.push(-1,-1),n.push(1,-1),this.ff[he.PositionKind]=new he(s,n,he.PositionKind,!1,!1,2),this.KO()}get scene(){return this.Kt}KO(){const t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this.Xu=this.Kt.getEngine().createIndexBuffer(t)}get isEnabled(){return this.ui}set isEnabled(t){this.ui=t}getScene(){return this.Kt}getEmitter(){return this.Vit}setEmitter(t){this.Vit=t}getEmitterPosition(){return this.Vit.getAbsolutePosition?this.Vit.getAbsolutePosition():this.Vit.position}computeEffectivePosition(t){let i=this.getEmitterPosition();i=w.Project(i,R.Identity(),this.Kt.getTransformMatrix(),t),this.kit=i.x,this.Git=i.y,i=w.TransformCoordinates(this.getEmitterPosition(),this.Kt.getViewMatrix()),this.viewportBorder>0&&(t.x-=this.viewportBorder,t.y-=this.viewportBorder,t.width+=2*this.viewportBorder,t.height+=2*this.viewportBorder,i.x+=this.viewportBorder,i.y+=this.viewportBorder,this.kit+=this.viewportBorder,this.Git+=this.viewportBorder);const e=this.Kt.useRightHandedSystem;return!!(i.z>0&&!e||i.z<0&&e)&&(this.kit>t.x&&this.kit<t.x+t.width&&this.Git>t.y&&(this.Git,t.y,t.height),!0)}zit(){if(!this.ui||!this.Kt.activeCamera)return!1;const t=this.getEmitterPosition().subtract(this.Kt.activeCamera.globalPosition),i=t.length();t.normalize();const e=new vn(this.Kt.activeCamera.globalPosition,t),s=this.Kt.pickWithRay(e,this.meshesSelectionPredicate,!0);return!s||!s.hit||s.distance>i}render(){if(!this.Kt.activeCamera)return!1;const t=this.Kt.getEngine(),i=this.Kt.activeCamera.viewport.toGlobal(t.getRenderWidth(!0),t.getRenderHeight(!0));if(!this.computeEffectivePosition(i))return!1;if(!this.zit())return!1;let e,s;e=this.kit<this.borderLimit+i.x?this.borderLimit+i.x-this.kit:this.kit>i.x+i.width-this.borderLimit?this.kit-i.x-i.width+this.borderLimit:0,s=this.Git<this.borderLimit+i.y?this.borderLimit+i.y-this.Git:this.Git>i.y+i.height-this.borderLimit?this.Git-i.y-i.height+this.borderLimit:0;let n=e>s?e:s;n-=this.viewportBorder,n>this.borderLimit&&(n=this.borderLimit);let r=1-o.Clamp(n/this.borderLimit,0,1);if(r<0)return!1;r>1&&(r=1),this.viewportBorder>0&&(i.x+=this.viewportBorder,i.y+=this.viewportBorder,i.width-=2*this.viewportBorder,i.height-=2*this.viewportBorder,this.kit-=this.viewportBorder,this.Git-=this.viewportBorder);const h=i.x+i.width/2,a=i.y+i.height/2,l=h-this.kit,c=a-this.Git;t.setState(!1),t.setDepthBuffer(!1);for(let e=0;e<this.lensFlares.length;e++){const s=this.lensFlares[e];if(!s.SC.effect.isReady()||s.texture&&!s.texture.isReady())continue;t.enableEffect(s.SC),t.bindBuffers(this.ff,this.Xu,s.SC.effect),t.setAlphaMode(s.alphaMode);const n=h-l*s.position,o=a-c*s.position,u=s.size,f=s.size*t.getAspectRatio(this.Kt.activeCamera,!0),d=n/(i.width+2*i.x)*2-1,p=1-o/(i.height+2*i.y)*2,m=R.FromValues(u/2,0,0,0,0,f/2,0,0,0,0,1,0,d,p,0,1);s.SC.effect.setMatrix("viewportMatrix",m),s.SC.effect.setTexture("textureSampler",s.texture),s.SC.effect.setFloat4("color",s.color.r*r,s.color.g*r,s.color.b*r,1),t.drawElementsType(Vs.TriangleFillMode,0,6)}return t.setDepthBuffer(!0),t.setAlphaMode(0),!0}rebuild(){var t;this.KO();for(const i in this.ff)null===(t=this.ff[i])||void 0===t||t.br()}dispose(){const t=this.ff[he.PositionKind];for(t&&(t.dispose(),this.ff[he.PositionKind]=null),this.Xu&&(this.Kt.getEngine().ca(this.Xu),this.Xu=null);this.lensFlares.length;)this.lensFlares[0].dispose();const i=this.Kt.lensFlareSystems.indexOf(this);this.Kt.lensFlareSystems.splice(i,1)}static Parse(t,i,e){const s=i.getLastEntryById(t.emitterId),n=t.name||"lensFlareSystem#"+t.emitterId,r=new GS(n,s,i);r.id=t.id||n,r.borderLimit=t.borderLimit;for(let i=0;i<t.flares.length;i++){const s=t.flares[i];FS.AddFlare(s.size,s.position,_.FromArray(s.color),s.textureName?e+s.textureName:"",r)}return r}serialize(){const t={};t.id=this.id,t.name=this.name,t.emitterId=this.getEmitter().id,t.borderLimit=this.borderLimit,t.flares=[];for(let i=0;i<this.lensFlares.length;i++){const e=this.lensFlares[i];t.flares.push({size:e.size,position:e.position,color:e.color.asArray(),textureName:ki.GetFilename(e.texture?e.texture.name:"")})}return t}}GS.qM=t=>{throw X("LensFlareSystemSceneComponent")},e.AddParser(fe.NAME_LENSFLARESYSTEM,((t,i,e,s)=>{if(void 0!==t.lensFlareSystems&&null!==t.lensFlareSystems){e.lensFlareSystems||(e.lensFlareSystems=new Array);for(let n=0,r=t.lensFlareSystems.length;n<r;n++){const r=t.lensFlareSystems[n],h=GS.Parse(r,i,s);e.lensFlareSystems.push(h)}}})),e.prototype.getLensFlareSystemByName=function(t){for(let i=0;i<this.lensFlareSystems.length;i++)if(this.lensFlareSystems[i].name===t)return this.lensFlareSystems[i];return null},e.prototype.getLensFlareSystemById=function(t){for(let i=0;i<this.lensFlareSystems.length;i++)if(this.lensFlareSystems[i].id===t)return this.lensFlareSystems[i];return null},e.prototype.getLensFlareSystemByID=function(t){return this.getLensFlareSystemById(t)},e.prototype.removeLensFlareSystem=function(t){const i=this.lensFlareSystems.indexOf(t);return-1!==i&&this.lensFlareSystems.splice(i,1),i},e.prototype.addLensFlareSystem=function(t){this.lensFlareSystems.push(t)};class zS{constructor(t){this.name=fe.NAME_LENSFLARESYSTEM,this.scene=t,t.lensFlareSystems=new Array}register(){this.scene.Jv.registerStep(fe.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this.jI)}rebuild(){for(let t=0;t<this.scene.lensFlareSystems.length;t++)this.scene.lensFlareSystems[t].rebuild()}addFromContainer(t){t.lensFlareSystems&&t.lensFlareSystems.forEach((t=>{this.scene.addLensFlareSystem(t)}))}removeFromContainer(t,i){t.lensFlareSystems&&t.lensFlareSystems.forEach((t=>{this.scene.removeLensFlareSystem(t),i&&t.dispose()}))}serialize(t){t.lensFlareSystems=[];const i=this.scene.lensFlareSystems;for(const e of i)t.lensFlareSystems.push(e.serialize())}dispose(){const t=this.scene.lensFlareSystems;for(;t.length;)t[0].dispose()}jI(t){if(this.scene.lensFlaresEnabled){const i=this.scene.lensFlareSystems;ki.StartPerformanceCounter("Lens flares",i.length>0);for(const e of i)0!=(t.layerMask&e.layerMask)&&e.render();ki.EndPerformanceCounter("Lens flares",i.length>0)}}}GS.qM=t=>{let i=t.Mg(fe.NAME_LENSFLARESYSTEM);i||(i=new zS(t),t.Ig(i))};const HS="bayerDitherFunctions",XS="float bayerDither2(vec2 _P) {\nreturn mod(2.0*_P.y+_P.x+1.0,4.0);\n}\nfloat bayerDither4(vec2 _P) {\nvec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5*mod(_P,4.0)); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);\n}\nfloat bayerDither8(vec2 _P) {\nvec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5 *mod(_P,4.0)); \nvec2 P4=floor(0.25*mod(_P,8.0)); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);\n}\n";ii.IncludesShadersStore[HS]=XS;const WS="shadowMapFragmentExtraDeclaration",$S="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform float softTransparentShadowSM;\n#endif\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nuniform vec3 lightDataSM;\nvarying vec3 vPositionWSM;\n#endif\nuniform vec3 biasAndScaleSM;\nuniform vec2 depthValuesSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";ii.IncludesShadersStore[WS]=$S;const YS="shadowMapFragment",jS="float depthSM=vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\ndepthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_FragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\ngl_FragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\ngl_FragColor=vec4(depthSM,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depthSM);\n#endif\nreturn;";ii.IncludesShadersStore[YS]=jS;const KS="shadowMapPixelShader",qS="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nfloat alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE)\ndiscard;\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;\n#else\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;\n#endif\n#endif\n#include<shadowMapFragment>\n}";ii.ShadersStore[KS]=qS;const QS="sceneVertexDeclaration",ZS="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec4 vEyePosition;\n";ii.IncludesShadersStore[QS]=ZS;const JS="meshVertexDeclaration",tE="uniform mat4 world;\nuniform float visibility;\n";ii.IncludesShadersStore[JS]=tE;const iE="shadowMapVertexDeclaration",eE="#include<sceneVertexDeclaration>\n#include<meshVertexDeclaration>\n";ii.IncludesShadersStore[iE]=eE;const sE="shadowMapUboDeclaration",nE="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";ii.IncludesShadersStore[sE]=nE;const rE="shadowMapVertexExtraDeclaration",hE="#if SM_NORMALBIAS==1\nuniform vec3 lightDataSM;\n#endif\nuniform vec3 biasAndScaleSM;\nuniform vec2 depthValuesSM;\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nvarying vec3 vPositionWSM;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";ii.IncludesShadersStore[rE]=hE;const oE="shadowMapVertexNormalBias",aE="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvec3 worldLightDirSM=normalize(-lightDataSM.xyz);\n#else\nvec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;\nvec3 worldLightDirSM=normalize(directionToLightSM);\n#endif\nfloat ndlSM=dot(vNormalW,worldLightDirSM);\nfloat sinNLSM=sqrt(1.0-ndlSM*ndlSM);\nfloat normalBiasSM=biasAndScaleSM.y*sinNLSM;\nworldPos.xyz-=vNormalW*normalBiasSM;\n#endif\n";ii.IncludesShadersStore[oE]=aE;const lE="shadowMapVertexMetric",cE="#if SM_USEDISTANCE==1\nvPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#else\ngl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nzSM=gl_Position.z;\ngl_Position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\nvDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n";ii.IncludesShadersStore[lE]=cE;const uE="shadowMapVertexShader",fE="attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#endif\n#include<helperFunctions>\n#include<__decl__shadowMapVertex>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normWorldSM=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));\nvNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvec3 vNormalW=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\ngl_Position=viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n}";ii.ShadersStore[uE]=fE;const dE="depthBoxBlurPixelShader",pE="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 colorDepth=vec4(0.0);\nfor (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);\ngl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));\n}";ii.ShadersStore[dE]=pE;const mE="shadowMapFragmentSoftTransparentShadow",vE="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;\n#endif\n";ii.IncludesShadersStore[mE]=vE;class gE{constructor(t,i,e,s){this.onBeforeShadowMapRenderObservable=new h,this.onAfterShadowMapRenderObservable=new h,this.onBeforeShadowMapRenderMeshObservable=new h,this.onAfterShadowMapRenderMeshObservable=new h,this.Hit=5e-5,this.Xit=0,this.Wit=1,this.$it=2,this.Yit=1,this.jit=!1,this.Kit=gE.FILTER_NONE,this.qit=gE.QUALITY_HIGH,this.Qit=.1,this.Zit=0,this.Jit=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this.tet=w.Zero(),this.Bg=R.Zero(),this.Ug=R.Zero(),this.Ov=R.Zero(),this.G4=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.iet=new w(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.eet=0,this.net=0,this.ret=R.Identity(),this.het=t,this.H4=i,this.Kt=i.getScene(),this.JD=null!=s?s:null;let n=i.lH;n||(n=i.lH=new Map),n.set(this.JD,this),this.id=i.id,this.AR=this.Kt.getEngine().supportsUniformBuffers,this.AR&&(this.oet=[],this.oet.push(this.Kt.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this.H4.name}")`))),gE.qM(this.Kt);const r=this.Kt.getEngine().getCaps();e?r.textureFloatRender&&r.textureFloatLinearFiltering?this.tL=1:r.textureHalfFloatRender&&r.textureHalfFloatLinearFiltering?this.tL=2:this.tL=0:r.textureHalfFloatRender&&r.textureHalfFloatLinearFiltering?this.tL=2:r.textureFloatRender&&r.textureFloatLinearFiltering?this.tL=1:this.tL=0,this.aet(),this.let()}get bias(){return this.Hit}set bias(t){this.Hit=t}get normalBias(){return this.Xit}set normalBias(t){this.Xit=t}get blurBoxOffset(){return this.Wit}set blurBoxOffset(t){this.Wit!==t&&(this.Wit=t,this.cet())}get blurScale(){return this.$it}set blurScale(t){this.$it!==t&&(this.$it=t,this.cet())}get blurKernel(){return this.Yit}set blurKernel(t){this.Yit!==t&&(this.Yit=t,this.cet())}get useKernelBlur(){return this.jit}set useKernelBlur(t){this.jit!==t&&(this.jit=t,this.cet())}get depthScale(){return void 0!==this.uet?this.uet:this.H4.getDepthScale()}set depthScale(t){this.uet=t}fet(t){return t}get filter(){return this.Kit}set filter(t){if(t=this.fet(t),this.H4.needCube()){if(t===gE.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(t===gE.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(t===gE.FILTER_PCF||t===gE.FILTER_PCSS)return void(this.usePoissonSampling=!0)}t!==gE.FILTER_PCF&&t!==gE.FILTER_PCSS||this.Kt.getEngine().hs.supportShadowSamplers?this.Kit!==t&&(this.Kit=t,this.cet(),this.let(),this.H4.pH()):this.usePoissonSampling=!0}get usePoissonSampling(){return this.filter===gE.FILTER_POISSONSAMPLING}set usePoissonSampling(t){const i=this.fet(gE.FILTER_POISSONSAMPLING);(t||this.filter===gE.FILTER_POISSONSAMPLING)&&(this.filter=t?i:gE.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===gE.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(t){const i=this.fet(gE.FILTER_EXPONENTIALSHADOWMAP);(t||this.filter===gE.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=t?i:gE.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===gE.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(t){const i=this.fet(gE.FILTER_BLUREXPONENTIALSHADOWMAP);(t||this.filter===gE.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=t?i:gE.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===gE.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(t){const i=this.fet(gE.FILTER_CLOSEEXPONENTIALSHADOWMAP);(t||this.filter===gE.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=t?i:gE.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===gE.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(t){const i=this.fet(gE.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(t||this.filter===gE.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=t?i:gE.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===gE.FILTER_PCF}set usePercentageCloserFiltering(t){const i=this.fet(gE.FILTER_PCF);(t||this.filter===gE.FILTER_PCF)&&(this.filter=t?i:gE.FILTER_NONE)}get filteringQuality(){return this.qit}set filteringQuality(t){this.qit!==t&&(this.qit=t,this.cet(),this.let(),this.H4.pH())}get useContactHardeningShadow(){return this.filter===gE.FILTER_PCSS}set useContactHardeningShadow(t){const i=this.fet(gE.FILTER_PCSS);(t||this.filter===gE.FILTER_PCSS)&&(this.filter=t?i:gE.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this.Qit}set contactHardeningLightSizeUVRatio(t){this.Qit=t}get darkness(){return this.Zit}set darkness(t){this.setDarkness(t)}getDarkness(){return this.Zit}setDarkness(t){return this.Zit=t>=1?1:t<=0?0:t,this}get transparencyShadow(){return this.Jit}set transparencyShadow(t){this.setTransparencyShadow(t)}setTransparencyShadow(t){return this.Jit=t,this}getShadowMap(){return this.pet}getShadowMapForRendering(){return this.met?this.met:this.pet}getClassName(){return gE.CLASSNAME}addShadowCaster(t,i=!0){if(!this.pet)return this;if(this.pet.renderList||(this.pet.renderList=[]),-1===this.pet.renderList.indexOf(t)&&this.pet.renderList.push(t),i)for(const i of t.getChildMeshes())-1===this.pet.renderList.indexOf(i)&&this.pet.renderList.push(i);return this}removeShadowCaster(t,i=!0){if(!this.pet||!this.pet.renderList)return this;const e=this.pet.renderList.indexOf(t);if(-1!==e&&this.pet.renderList.splice(e,1),i)for(const i of t.getChildren())this.removeShadowCaster(i);return this}getLight(){return this.H4}Y$(){var t;return null!==(t=this.JD)&&void 0!==t?t:this.Kt.activeCamera}get mapSize(){return this.het}set mapSize(t){this.het=t,this.H4.pH(),this.recreateShadowMap()}aet(){this.H4.pH(),this.vet()}Eet(){const t=this.Kt.getEngine();t.hs.supportDepthStencilTexture?(this.pet=new br(this.H4.name+"_shadowMap",this.het,this.Kt,!1,!0,this.tL,this.H4.needCube(),void 0,!1,!1),this.pet.createDepthStencilTexture(t.useReverseDepthBuffer?516:513,!0)):this.pet=new br(this.H4.name+"_shadowMap",this.het,this.Kt,!1,!0,this.tL,this.H4.needCube())}vet(){if(this.Eet(),null===this.pet)return;this.pet.wrapU=an.CLAMP_ADDRESSMODE,this.pet.wrapV=an.CLAMP_ADDRESSMODE,this.pet.anisotropicFilteringLevel=1,this.pet.updateSamplingMode(an.BILINEAR_SAMPLINGMODE),this.pet.renderParticles=!1,this.pet.ignoreCameraViewport=!0,this.Aet&&(this.pet.uniqueId=this.Aet),this.pet.customRenderFunction=this.Cet.bind(this),this.pet.customIsReadyFunction=()=>!0;const t=this.Kt.getEngine();this.pet.onBeforeBindObservable.add((()=>{var i;this.A5=this.Kt.getSceneUniformBuffer(),null===(i=t.NO)||void 0===i||i.call(t,`shadow map generation for pass id ${t.currentRenderPassId}`,1)})),this.pet.onBeforeRenderObservable.add((i=>{this.oet&&this.Kt.setSceneUniformBuffer(this.oet[0]),this.eet=i,this.Kit===gE.FILTER_PCF&&t.setColorWrite(!1),this.getTransformMatrix(),this.Kt.setTransformMatrix(this.Bg,this.Ug),this.AR&&(this.Kt.getSceneUniformBuffer().unbindEffect(),this.Kt.finalizeSceneUbo())})),this.pet.onAfterUnbindObservable.add((()=>{var i,e;if(this.oet&&this.Kt.setSceneUniformBuffer(this.A5),this.Kt.updateTransformMatrix(),this.Kit===gE.FILTER_PCF&&t.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void(null===(i=t.PO)||void 0===i||i.call(t,1));const s=this.getShadowMapForRendering();s&&(this.Kt.postProcessManager.directRender(this.wet,s.renderTarget,!0),t.unBindFramebuffer(s.renderTarget,!0),null===(e=t.PO)||void 0===e||e.call(t,1))}));const i=new y(0,0,0,0),e=new y(1,1,1,1);this.pet.onClearObservable.add((t=>{this.Kit===gE.FILTER_PCF?t.clear(e,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?t.clear(i,!0,!0,!1):t.clear(e,!0,!0,!1)})),this.pet.onResizeObservable.add((t=>{this.Aet=this.pet.uniqueId,this.het=t.getRenderSize(),this.H4.pH(),this.recreateShadowMap()}));for(let t=ue.MIN_RENDERINGGROUPS;t<ue.MAX_RENDERINGGROUPS;t++)this.pet.setRenderingAutoClearDepthStencil(t,!1)}xet(){const t=this.Kt.getEngine(),i=this.het/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this.met=new br(this.H4.name+"_shadowMap2",i,this.Kt,!1,!0,this.tL,void 0,void 0,!1),this.met.wrapU=an.CLAMP_ADDRESSMODE,this.met.wrapV=an.CLAMP_ADDRESSMODE,this.met.updateSamplingMode(an.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this.Tet=new xm(this.H4.name+"KernelBlurX",new C(1,0),this.blurKernel,1,null,an.BILINEAR_SAMPLINGMODE,t,!1,this.tL),this.Tet.width=i,this.Tet.height=i,this.Tet.externalTextureSamplerBinding=!0,this.Tet.onApplyObservable.add((t=>{t.setTexture("textureSampler",this.pet)})),this.Ret=new xm(this.H4.name+"KernelBlurY",new C(0,1),this.blurKernel,1,null,an.BILINEAR_SAMPLINGMODE,t,!1,this.tL),this.Tet.autoClear=!1,this.Ret.autoClear=!1,0===this.tL&&(this.Tet.packedFloat=!0,this.Ret.packedFloat=!0),this.wet=[this.Tet,this.Ret]):(this.Iet=new nr(this.H4.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,an.BILINEAR_SAMPLINGMODE,t,!1,"#define OFFSET "+this.Wit,this.tL),this.Iet.externalTextureSamplerBinding=!0,this.Iet.onApplyObservable.add((t=>{t.setFloat2("screenSize",i,i),t.setTexture("textureSampler",this.pet)})),this.Iet.autoClear=!1,this.wet=[this.Iet])}Cet(t,i,e,s){let n;if(s.length)for(n=0;n<s.length;n++)this.Met(s.data[n]);for(n=0;n<t.length;n++)this.Met(t.data[n]);for(n=0;n<i.length;n++)this.Met(i.data[n]);if(this.Jit)for(n=0;n<e.length;n++)this.Met(e.data[n],!0);else for(n=0;n<e.length;n++)e.data[n].getEffectiveMesh()._m.ET=!1}bet(t,i,e){i.setMatrix("viewProjection",this.getTransformMatrix())}Met(t,i=!1){var e,s;const n=t.getRenderingMesh(),r=t.getEffectiveMesh(),h=this.Kt,o=h.getEngine(),a=t.getMaterial();if(r._m.ET=!1,!a||0===t.verticesCount||t.Sv===h.getRenderId())return;const l=r.zi()<0;let c=null!==(e=n.overrideMaterialSideOrientation)&&void 0!==e?e:a.sideOrientation;l&&(c=0===c?1:0);const u=0===c;o.setState(a.backFaceCulling,void 0,void 0,u,a.cullBackFaces);const f=n.KI(t.Al,!!t.getReplacementMesh());if(f.mustReturn)return;const d=o.getCaps().instancedArrays&&(null!==f.visibleInstances[t.Al]&&void 0!==f.visibleInstances[t.Al]||n.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(t))if(this.isReady(t,d,i)){t.Sv=h.getRenderId();const e=a.shadowDepthWrapper,l=null!==(s=null==e?void 0:e.getEffect(t,this,o.currentRenderPassId))&&void 0!==s?s:t.mC(),c=vi.GetEffect(l);o.enableEffect(l),d||n.$C(t,c,a.fillMode),this.getTransformMatrix(),c.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===No.LIGHTTYPEID_DIRECTIONALLIGHT?c.setVector3("lightDataSM",this.iet):c.setVector3("lightDataSM",this.G4);const u=this.Y$();if(u&&c.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(u),this.getLight().getDepthMinZ(u)+this.getLight().getDepthMaxZ(u)),i&&this.enableSoftTransparentShadow&&c.setFloat("softTransparentShadowSM",r.visibility*a.alpha),e)t.AC(l),e.standalone?e.baseMaterial.bindForSubMesh(r.getWorldMatrix(),n,t):a.bindForSubMesh(r.getWorldMatrix(),n,t),t.AC(null);else{if(this.useOpacityTextureForTransparentShadow){const t=a.opacityTexture;t&&(c.setTexture("diffuseSampler",t),c.setMatrix("diffuseMatrix",t.getTextureMatrix()||this.ret))}else if(a.needAlphaTesting()||a.needAlphaBlending()){const t=a.getAlphaTestTexture();t&&(c.setTexture("diffuseSampler",t),c.setMatrix("diffuseMatrix",t.getTextureMatrix()||this.ret))}if(n.useBones&&n.computeBonesUsingShaders&&n.skeleton){const t=n.skeleton;if(t.isUsingTextureForMatrices){const i=t.getTransformMatrixTexture(n);if(!i)return;c.setTexture("boneSampler",i),c.setFloat("boneTextureWidth",4*(t.bones.length+1))}else c.setMatrices("mBones",t.getTransformMatrices(n))}Fs.BindMorphTargetParameters(n,c),n.morphTargetManager&&n.morphTargetManager.isUsingTextureForTargets&&n.morphTargetManager.$C(c),Ds(c,a,h)}this.AR||e||this.bet(t,c,r),Fs.BindSceneUniformBuffer(c,this.Kt.getSceneUniformBuffer()),this.Kt.getSceneUniformBuffer().bindUniformBuffer();const p=r.getWorldMatrix();d&&(r.getMeshUniformBuffer().bindToEffect(c,"Mesh"),r.transferToEffect(p)),this.forceBackFacesOnly&&o.setState(!0,0,!1,!0,a.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(n),this.onBeforeShadowMapRenderObservable.notifyObservers(c),n.eM(r,t,c,a.fillMode,f,d,((t,i)=>{r===n||t?(r.getMeshUniformBuffer().bindToEffect(c,"Mesh"),r.transferToEffect(t?i:p)):(n.getMeshUniformBuffer().bindToEffect(c,"Mesh"),n.transferToEffect(i))})),this.forceBackFacesOnly&&o.setState(!0,0,!1,!1,a.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(c),this.onAfterShadowMapRenderMeshObservable.notifyObservers(n)}else this.pet&&this.pet.resetRefreshCounter()}let(){this.pet&&(this.filter===gE.FILTER_NONE||this.filter===gE.FILTER_PCSS?this.pet.updateSamplingMode(an.NEAREST_SAMPLINGMODE):this.pet.updateSamplingMode(an.BILINEAR_SAMPLINGMODE))}forceCompilation(t,i){const e={useInstances:!1,...i},s=this.getShadowMap();if(!s)return void(t&&t(this));const n=s.renderList;if(!n)return void(t&&t(this));const r=new Array;for(const t of n)r.push(...t.subMeshes);if(0===r.length)return void(t&&t(this));let h=0;const o=()=>{var i,s;if(this.Kt&&this.Kt.getEngine()){for(;this.isReady(r[h],e.useInstances,null!==(s=null===(i=r[h].getMaterial())||void 0===i?void 0:i.needAlphaBlendingForMesh(r[h].getMesh()))&&void 0!==s&&s);)if(h++,h>=r.length)return void(t&&t(this));setTimeout(o,16)}};o()}forceCompilationAsync(t){return new Promise((i=>{this.forceCompilation((()=>{i()}),t)}))}_et(t,i,e){}yet(t,i,e,s){e.push("#define SM_LIGHTTYPE_"+this.H4.getClassName().toUpperCase()),e.push("#define SM_FLOAT "+(0!==this.tL?"1":"0")),e.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),e.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const n=t.getMesh();return e.push("#define SM_NORMALBIAS "+(this.normalBias&&n.isVerticesDataPresent(he.NormalKind)?"1":"0")),e.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===No.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),e.push("#define SM_USEDISTANCE "+(this.H4.needCube()?"1":"0")),e.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&s?"1":"0")),this._et(e,t,i),e}isReady(t,i,e){var s;const n=t.getMaterial(),r=null==n?void 0:n.shadowDepthWrapper;if(!n)return!1;const h=[];if(this.yet(t,i,h,e),r){if(!r.isReadyForSubMesh(t,h,this,i,this.Kt.getEngine().currentRenderPassId))return!1}else{const e=t.mC(void 0,!0);let r=e.effect,o=e.defines;const a=[he.PositionKind],l=t.getMesh();this.normalBias&&l.isVerticesDataPresent(he.NormalKind)&&(a.push(he.NormalKind),h.push("#define NORMAL"),l.nonUniformScaling&&h.push("#define NONUNIFORMSCALING"));const c=null==n?void 0:n.needAlphaTesting(),u=null==n?void 0:n.needAlphaBlending();if(n&&(c||u)){let t=null;if(t=this.useOpacityTextureForTransparentShadow?n.opacityTexture:n.getAlphaTestTexture(),t){if(!t.isReady())return!1;const i=null!==(s=n.alphaCutOff)&&void 0!==s?s:gE.DEFAULT_ALPHA_CUTOFF;h.push("#define ALPHATEXTURE"),c&&h.push(`#define ALPHATESTVALUE ${i}${i%1==0?".":""}`),l.isVerticesDataPresent(he.UVKind)&&(a.push(he.UVKind),h.push("#define UV1")),l.isVerticesDataPresent(he.UV2Kind)&&1===t.coordinatesIndex&&(a.push(he.UV2Kind),h.push("#define UV2"))}}const f=new Jn;if(l.useBones&&l.computeBonesUsingShaders&&l.skeleton){a.push(he.MatricesIndicesKind),a.push(he.MatricesWeightsKind),l.numBoneInfluencers>4&&(a.push(he.MatricesIndicesExtraKind),a.push(he.MatricesWeightsExtraKind));const t=l.skeleton;h.push("#define NUM_BONE_INFLUENCERS "+l.numBoneInfluencers),l.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,l),t.isUsingTextureForMatrices?h.push("#define BONETEXTURE"):h.push("#define BonesPerMesh "+(t.bones.length+1))}else h.push("#define NUM_BONE_INFLUENCERS 0");const d=l.morphTargetManager;let p=0;if(d&&d.numInfluencers>0&&(h.push("#define MORPHTARGETS"),p=d.numInfluencers,h.push("#define NUM_MORPH_INFLUENCERS "+p),d.isUsingTextureForTargets&&h.push("#define MORPHTARGETS_TEXTURE"),Fs.PrepareAttributesForMorphTargetsInfluencers(a,l,p)),Ps(n,this.Kt,h),i&&(h.push("#define INSTANCES"),Fs.PushAttributesForInstances(a),t.getRenderingMesh().hasThinInstances&&h.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const t of this.customShaderOptions.defines)-1===h.indexOf(t)&&h.push(t);const m=h.join("\n");if(o!==m){o=m;let t="shadowMap";const i=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],s=["diffuseSampler","boneSampler","morphTargets"],n=["Scene","Mesh"];if(Ns(i),this.customShaderOptions){if(t=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const t of this.customShaderOptions.attributes)-1===a.indexOf(t)&&a.push(t);if(this.customShaderOptions.uniforms)for(const t of this.customShaderOptions.uniforms)-1===i.indexOf(t)&&i.push(t);if(this.customShaderOptions.samplers)for(const t of this.customShaderOptions.samplers)-1===s.indexOf(t)&&s.push(t)}const h=this.Kt.getEngine();r=h.createEffect(t,{attributes:a,uniformsNames:i,uniformBuffersNames:n,samplers:s,defines:m,fallbacks:f,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:p}},h),e.setEffect(r,o)}if(!r.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(this.wet&&this.wet.length||this.xet()),!(this.Tet&&!this.Tet.isReady())&&(!(this.Ret&&!this.Ret.isReady())&&!(this.Iet&&!this.Iet.isReady()))}prepareDefines(t,i){const e=this.Kt,s=this.H4;e.shadowsEnabled&&s.shadowEnabled&&(t["SHADOW"+i]=!0,this.useContactHardeningShadow?(t["SHADOWPCSS"+i]=!0,this.qit===gE.QUALITY_LOW?t["SHADOWLOWQUALITY"+i]=!0:this.qit===gE.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePercentageCloserFiltering?(t["SHADOWPCF"+i]=!0,this.qit===gE.QUALITY_LOW?t["SHADOWLOWQUALITY"+i]=!0:this.qit===gE.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePoissonSampling?t["SHADOWPOISSON"+i]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?t["SHADOWESM"+i]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(t["SHADOWCLOSEESM"+i]=!0),s.needCube()&&(t["SHADOWCUBE"+i]=!0))}bindShadowLight(t,i){const e=this.H4;if(!this.Kt.shadowsEnabled||!e.shadowEnabled)return;const s=this.Y$();if(!s)return;const n=this.getShadowMap();n&&(e.needCube()||i.setMatrix("lightMatrix"+t,this.getTransformMatrix()),this.Kit===gE.FILTER_PCF?(i.setDepthStencilTexture("shadowSampler"+t,this.getShadowMapForRendering()),e.VT.updateFloat4("shadowsInfo",this.getDarkness(),n.getSize().width,1/n.getSize().width,this.frustumEdgeFalloff,t)):this.Kit===gE.FILTER_PCSS?(i.setDepthStencilTexture("shadowSampler"+t,this.getShadowMapForRendering()),i.setTexture("depthSampler"+t,this.getShadowMapForRendering()),e.VT.updateFloat4("shadowsInfo",this.getDarkness(),1/n.getSize().width,this.Qit*n.getSize().width,this.frustumEdgeFalloff,t)):(i.setTexture("shadowSampler"+t,this.getShadowMapForRendering()),e.VT.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/n.getSize().width,this.depthScale,this.frustumEdgeFalloff,t)),e.VT.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),t))}getTransformMatrix(){const t=this.Kt;if(this.Ai===t.getRenderId()&&this.net===this.eet)return this.Ov;this.Ai=t.getRenderId(),this.net=this.eet;let i=this.H4.position;if(this.H4.computeTransformedInformation()&&(i=this.H4.transformedPosition),w.NormalizeToRef(this.H4.getShadowDirection(this.eet),this.tet),1===Math.abs(w.Dot(this.tet,w.Up()))&&(this.tet.z=1e-13),this.H4.needProjectionMatrixCompute()||!this.G4||!this.iet||!i.equals(this.G4)||!this.tet.equals(this.iet)){this.G4.copyFrom(i),this.iet.copyFrom(this.tet),R.LookAtLHToRef(i,i.add(this.tet),w.Up(),this.Bg);const t=this.getShadowMap();if(t){const i=t.renderList;i&&this.H4.setShadowProjectionMatrix(this.Ug,this.Bg,i)}this.Bg.multiplyToRef(this.Ug,this.Ov)}return this.Ov}recreateShadowMap(){const t=this.pet;if(!t)return;const i=t.renderList;if(this.Net(),this.aet(),this.filter=this.Kit,this.let(),i){this.pet.renderList||(this.pet.renderList=[]);for(const t of i)this.pet.renderList.push(t)}else this.pet.renderList=null}cet(){this.met&&(this.met.dispose(),this.met=null),this.Iet&&(this.Iet.dispose(),this.Iet=null),this.Tet&&(this.Tet.dispose(),this.Tet=null),this.Ret&&(this.Ret.dispose(),this.Ret=null),this.wet=[]}Net(){this.pet&&(this.pet.dispose(),this.pet=null),this.cet()}Pet(){if(this.oet){for(const t of this.oet)t.dispose();this.oet=[]}}dispose(){if(this.Net(),this.Pet(),this.H4){if(this.H4.lH){const t=this.H4.lH.entries();for(let i=t.next();!0!==i.done;i=t.next()){const[t,e]=i.value;e===this&&this.H4.lH.delete(t)}0===this.H4.lH.size&&(this.H4.lH=null)}this.H4.pH()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){var t;const i={},e=this.getShadowMap();if(!e)return i;if(i.className=this.getClassName(),i.lightId=this.H4.id,i.cameraId=null===(t=this.JD)||void 0===t?void 0:t.id,i.id=this.id,i.mapSize=e.getRenderSize(),i.forceBackFacesOnly=this.forceBackFacesOnly,i.darkness=this.getDarkness(),i.transparencyShadow=this.Jit,i.frustumEdgeFalloff=this.frustumEdgeFalloff,i.bias=this.bias,i.normalBias=this.normalBias,i.usePercentageCloserFiltering=this.usePercentageCloserFiltering,i.useContactHardeningShadow=this.useContactHardeningShadow,i.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,i.filteringQuality=this.filteringQuality,i.useExponentialShadowMap=this.useExponentialShadowMap,i.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,i.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,i.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,i.usePoissonSampling=this.usePoissonSampling,i.depthScale=this.depthScale,i.blurBoxOffset=this.blurBoxOffset,i.blurKernel=this.blurKernel,i.blurScale=this.blurScale,i.useKernelBlur=this.useKernelBlur,i.renderList=[],e.renderList)for(let t=0;t<e.renderList.length;t++){const s=e.renderList[t];i.renderList.push(s.id)}return i}static Parse(t,i,e){const s=i.getLightById(t.lightId),n=void 0!==t.cameraId?i.getCameraById(t.cameraId):null,r=e?e(t.mapSize,s,n):new gE(t.mapSize,s,void 0,n),h=r.getShadowMap();for(let e=0;e<t.renderList.length;e++){i.getMeshesById(t.renderList[e]).forEach((function(t){h&&(h.renderList||(h.renderList=[]),h.renderList.push(t))}))}return void 0!==t.id&&(r.id=t.id),r.forceBackFacesOnly=!!t.forceBackFacesOnly,void 0!==t.darkness&&r.setDarkness(t.darkness),t.transparencyShadow&&r.setTransparencyShadow(!0),void 0!==t.frustumEdgeFalloff&&(r.frustumEdgeFalloff=t.frustumEdgeFalloff),void 0!==t.bias&&(r.bias=t.bias),void 0!==t.normalBias&&(r.normalBias=t.normalBias),t.usePercentageCloserFiltering?r.usePercentageCloserFiltering=!0:t.useContactHardeningShadow?r.useContactHardeningShadow=!0:t.usePoissonSampling?r.usePoissonSampling=!0:t.useExponentialShadowMap?r.useExponentialShadowMap=!0:t.useBlurExponentialShadowMap?r.useBlurExponentialShadowMap=!0:t.useCloseExponentialShadowMap?r.useCloseExponentialShadowMap=!0:t.useBlurCloseExponentialShadowMap?r.useBlurCloseExponentialShadowMap=!0:t.useVarianceShadowMap?r.useExponentialShadowMap=!0:t.useBlurVarianceShadowMap&&(r.useBlurExponentialShadowMap=!0),void 0!==t.contactHardeningLightSizeUVRatio&&(r.contactHardeningLightSizeUVRatio=t.contactHardeningLightSizeUVRatio),void 0!==t.filteringQuality&&(r.filteringQuality=t.filteringQuality),t.depthScale&&(r.depthScale=t.depthScale),t.blurScale&&(r.blurScale=t.blurScale),t.blurBoxOffset&&(r.blurBoxOffset=t.blurBoxOffset),t.useKernelBlur&&(r.useKernelBlur=t.useKernelBlur),t.blurKernel&&(r.blurKernel=t.blurKernel),r}}gE.CLASSNAME="ShadowGenerator",gE.FILTER_NONE=0,gE.FILTER_EXPONENTIALSHADOWMAP=1,gE.FILTER_POISSONSAMPLING=2,gE.FILTER_BLUREXPONENTIALSHADOWMAP=3,gE.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,gE.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,gE.FILTER_PCF=6,gE.FILTER_PCSS=7,gE.QUALITY_HIGH=0,gE.QUALITY_MEDIUM=1,gE.QUALITY_LOW=2,gE.DEFAULT_ALPHA_CUTOFF=.5,gE.qM=t=>{throw X("ShadowGeneratorSceneComponent")};const SE="depthPixelShader",EE="#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying float vDepthMetric;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\ngl_FragColor=pack(gl_FragCoord.z);\n#else\ngl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\ngl_FragColor=pack(vDepthMetric);\n#else\ngl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n}";ii.ShadersStore[SE]=EE;const AE="depthVertexShader",CE="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nuniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvarying float vDepthMetric;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\ngl_Position=viewProjection*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));\n#else\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n";ii.ShadersStore[AE]=CE;class wE{constructor(t,i=1,e=null,s=!1,n=an.TRILINEAR_SAMPLINGMODE){this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.Kt=t,this.Det=s,this.isPacked=0===i,this.isPacked?this.Let=new y(1,1,1,1):this.Let=new y(1,0,0,1),wE.qM(this.Kt);const r=t.getEngine();this.JD=e,n!==an.NEAREST_SAMPLINGMODE&&(1!==i||r.po.textureFloatLinearFiltering||(n=an.NEAREST_SAMPLINGMODE),2!==i||r.po.textureHalfFloatLinearFiltering||(n=an.NEAREST_SAMPLINGMODE));const h=this.isPacked||!r.hs.supportExtendedTextureFormats?5:6;this.Oet=new br("DepthRenderer",{width:r.getRenderWidth(),height:r.getRenderHeight()},this.Kt,!1,!0,i,!1,n,void 0,void 0,void 0,h),this.Oet.wrapU=an.CLAMP_ADDRESSMODE,this.Oet.wrapV=an.CLAMP_ADDRESSMODE,this.Oet.refreshRate=1,this.Oet.renderParticles=!1,this.Oet.renderList=null,this.Oet.activeCamera=this.JD,this.Oet.ignoreCameraViewport=!0,this.Oet.useCameraPostProcesses=!1,this.Oet.onClearObservable.add((t=>{t.clear(this.Let,!0,!0,!0)})),this.Oet.onBeforeBindObservable.add((()=>{var t;null===(t=r.NO)||void 0===t||t.call(r,"depth renderer",1)})),this.Oet.onAfterUnbindObservable.add((()=>{var t;null===(t=r.PO)||void 0===t||t.call(r,1)})),this.Oet.customIsReadyFunction=(t,i,e)=>{if((e||0===i)&&t.subMeshes)for(let i=0;i<t.subMeshes.length;++i){const e=t.subMeshes[i],s=e.getRenderingMesh(),n=s.KI(e.Al,!!e.getReplacementMesh()),h=r.getCaps().instancedArrays&&(null!==n.visibleInstances[e.Al]&&void 0!==n.visibleInstances[e.Al]||s.hasThinInstances);if(!this.isReady(e,h))return!1}return!0};const o=t=>{var i,e;const s=t.getRenderingMesh(),n=t.getEffectiveMesh(),r=this.Kt,h=r.getEngine(),o=t.getMaterial();if(n._m.ET=!1,!o||n.infiniteDistance||o.disableDepthWrite||0===t.verticesCount||t.Sv===r.getRenderId())return;const a=n.zi()<0;let l=null!==(i=s.overrideMaterialSideOrientation)&&void 0!==i?i:o.sideOrientation;a&&(l=0===l?1:0);const c=0===l;h.setState(o.backFaceCulling,0,!1,c,o.cullBackFaces);const u=s.KI(t.Al,!!t.getReplacementMesh());if(u.mustReturn)return;const f=h.getCaps().instancedArrays&&(null!==u.visibleInstances[t.Al]&&void 0!==u.visibleInstances[t.Al]||s.hasThinInstances),d=this.JD||r.activeCamera;if(this.isReady(t,f)&&d){t.Sv=r.getRenderId();const i=null===(e=n._m.WT)||void 0===e?void 0:e[h.currentRenderPassId];let a=t.mC();!a&&i&&(a=i.mC());const l=d.mode===hs.ORTHOGRAPHIC_CAMERA;if(!a)return;const c=a.effect;let p,m;if(h.enableEffect(a),f||s.$C(t,c,o.fillMode),i?i.bindForSubMesh(n.getWorldMatrix(),n,t):(c.setMatrix("viewProjection",r.getTransformMatrix()),c.setMatrix("world",n.getWorldMatrix())),l?(p=!h.useReverseDepthBuffer&&h.isNDCHalfZRange?0:1,m=h.useReverseDepthBuffer&&h.isNDCHalfZRange?0:1):(p=h.useReverseDepthBuffer&&h.isNDCHalfZRange?d.minZ:h.isNDCHalfZRange?0:d.minZ,m=h.useReverseDepthBuffer&&h.isNDCHalfZRange?0:d.maxZ),c.setFloat2("depthValues",p,p+m),!i){if(o.needAlphaTesting()){const t=o.getAlphaTestTexture();t&&(c.setTexture("diffuseSampler",t),c.setMatrix("diffuseMatrix",t.getTextureMatrix()))}if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){const t=s.skeleton;if(t.isUsingTextureForMatrices){const i=t.getTransformMatrixTexture(s);if(!i)return;c.setTexture("boneSampler",i),c.setFloat("boneTextureWidth",4*(t.bones.length+1))}else c.setMatrices("mBones",t.getTransformMatrices(s))}Ds(c,o,r),Fs.BindMorphTargetParameters(s,c),s.morphTargetManager&&s.morphTargetManager.isUsingTextureForTargets&&s.morphTargetManager.$C(c)}s.eM(n,t,c,o.fillMode,u,f,((t,i)=>c.setMatrix("world",i)))}};this.Oet.customRenderFunction=(t,i,e,s)=>{let n;if(s.length)for(n=0;n<s.length;n++)o(s.data[n]);for(n=0;n<t.length;n++)o(t.data[n]);for(n=0;n<i.length;n++)o(i.data[n]);if(this.forceDepthWriteTransparentMeshes)for(n=0;n<e.length;n++)o(e.data[n]);else for(n=0;n<e.length;n++)e.data[n].getEffectiveMesh()._m.ET=!1}}setMaterialForRendering(t,i){this.Oet.setMaterialForRendering(t,i)}isReady(t,i){var e;const s=this.Kt.getEngine(),n=t.getMesh(),r=n.getScene(),h=null===(e=n._m.WT)||void 0===e?void 0:e[s.currentRenderPassId];if(h)return h.isReadyForSubMesh(n,t,i);const o=t.getMaterial();if(!o||o.disableDepthWrite)return!1;const a=[],l=[he.PositionKind];if(o&&o.needAlphaTesting()&&o.getAlphaTestTexture()&&(a.push("#define ALPHATEST"),n.isVerticesDataPresent(he.UVKind)&&(l.push(he.UVKind),a.push("#define UV1")),n.isVerticesDataPresent(he.UV2Kind)&&(l.push(he.UV2Kind),a.push("#define UV2"))),n.useBones&&n.computeBonesUsingShaders){l.push(he.MatricesIndicesKind),l.push(he.MatricesWeightsKind),n.numBoneInfluencers>4&&(l.push(he.MatricesIndicesExtraKind),l.push(he.MatricesWeightsExtraKind)),a.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),a.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0));const i=t.getRenderingMesh().skeleton;(null==i?void 0:i.isUsingTextureForMatrices)&&a.push("#define BONETEXTURE")}else a.push("#define NUM_BONE_INFLUENCERS 0");const c=n.morphTargetManager;let u=0;c&&c.numInfluencers>0&&(u=c.numInfluencers,a.push("#define MORPHTARGETS"),a.push("#define NUM_MORPH_INFLUENCERS "+u),c.isUsingTextureForTargets&&a.push("#define MORPHTARGETS_TEXTURE"),Fs.PrepareAttributesForMorphTargetsInfluencers(l,n,u)),i&&(a.push("#define INSTANCES"),Fs.PushAttributesForInstances(l),t.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES")),this.Det&&a.push("#define NONLINEARDEPTH"),this.isPacked&&a.push("#define PACKED"),Ps(o,r,a);const f=t.mC(void 0,!0),d=f.defines,p=a.join("\n");if(d!==p){const t=["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];Ns(t),f.setEffect(s.createEffect("depth",l,t,["diffuseSampler","morphTargets","boneSampler"],p,void 0,void 0,void 0,{maxSimultaneousMorphTargets:u}),p)}return f.effect.isReady()}getDepthMap(){return this.Oet}dispose(){const t=[];for(const i in this.Kt.Fet){this.Kt.Fet[i]===this&&t.push(i)}if(t.length>0){this.Oet.dispose();for(const i of t)delete this.Kt.Fet[i]}}}wE.qM=t=>{throw X("DepthRendererSceneComponent")};const xE="minmaxReduxPixelShader",TE="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#if defined(INITIAL)\nuniform sampler2D sourceTexture;\nuniform vec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*(texSize-1.0));\nfloat f1=texelFetch(sourceTexture,coord,0).r;\nfloat f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;\nfloat f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;\nfloat f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;\nfloat minz=min(min(min(f1,f2),f3),f4);\n#ifdef DEPTH_REDUX\nfloat maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#else\nfloat maxz=max(max(max(f1,f2),f3),f4);\n#endif\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(MAIN)\nuniform vec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*(texSize-1.0));\nvec2 f1=texelFetch(textureSampler,coord,0).rg;\nvec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;\nvec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;\nvec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;\nfloat minz=min(min(min(f1.x,f2.x),f3.x),f4.x);\nfloat maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(ONEBEFORELAST)\nuniform ivec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*vec2(texSize-1));\nvec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;\nvec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;\nvec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;\nvec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;\nfloat minz=min(f1.x,f2.x);\nfloat maxz=max(f1.y,f2.y);\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(LAST)\nvoid main(void)\n{\nglFragColor=vec4(0.);\nif (true) { \ndiscard;\n}\n}\n#endif\n";ii.ShadersStore[xE]=TE;class RE{constructor(t){this.onAfterReductionPerformed=new h,this.Bet=!0,this.Uet=!1,this.JD=t,this.RO=new ae(t.getScene()),this.EM=t.getEngine().onContextRestoredObservable.add((()=>{this.RO.br()}))}get sourceTexture(){return this.Vet}setSourceTexture(t,i,e=2,s=!0){if(t===this.Vet)return;this.dispose(!1),this.Vet=t,this.ket=[],this.Bet=s;const n=this.JD.getScene(),r=new nr("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,n.getEngine(),!1,"#define INITIAL"+(i?"\n#define DEPTH_REDUX":""),e,void 0,void 0,void 0,7);r.autoClear=!1,r.forceFullscreenViewport=s;let h=this.Vet.getRenderWidth(),o=this.Vet.getRenderHeight();r.onApply=((t,i)=>e=>{e.setTexture("sourceTexture",this.Vet),e.setFloat2("texSize",t,i)})(h,o),this.ket.push(r);let a=1;for(;h>1||o>1;){h=Math.max(Math.round(h/2),1),o=Math.max(Math.round(o/2),1);const t=new nr("Reduction phase "+a,"minmaxRedux",["texSize"],null,{width:h,height:o},null,1,n.getEngine(),!1,"#define "+(1==h&&1==o?"LAST":1==h||1==o?"ONEBEFORELAST":"MAIN"),e,void 0,void 0,void 0,7);if(t.autoClear=!1,t.forceFullscreenViewport=s,t.onApply=((t,i)=>e=>{1==t||1==i?e.setInt2("texSize",t,i):e.setFloat2("texSize",t,i)})(h,o),this.ket.push(t),a++,1==h&&1==o){const i=(t,i,e)=>{const s=new Float32Array(4*t*i),r={min:0,max:0};return()=>{n.getEngine().Aw(e.inputTexture.texture,t,i,-1,0,s,!1),r.min=s[0],r.max=s[1],this.onAfterReductionPerformed.notifyObservers(r)}};t.onAfterRenderObservable.add(i(h,o,t))}}}get refreshRate(){return this.Vet?this.Vet.refreshRate:-1}set refreshRate(t){this.Vet&&(this.Vet.refreshRate=t)}get activated(){return this.Uet}activate(){!this.gO&&this.Vet&&(this.gO=this.Vet.onAfterUnbindObservable.add((()=>{var t,i;const e=this.JD.getScene().getEngine();null===(t=e.NO)||void 0===t||t.call(e,"min max reduction",1),this.ket[0].activate(this.JD),this.RO.directRender(this.ket,this.ket[0].inputTexture,this.Bet),e.unBindFramebuffer(this.ket[0].inputTexture,!1),null===(i=e.PO)||void 0===i||i.call(e,1)})),this.Uet=!0)}deactivate(){this.gO&&this.Vet&&(this.Vet.onAfterUnbindObservable.remove(this.gO),this.gO=null,this.Uet=!1)}dispose(t=!0){if(t&&(this.onAfterReductionPerformed.clear(),this.EM&&(this.JD.getEngine().onContextRestoredObservable.remove(this.EM),this.EM=null)),this.deactivate(),this.ket){for(let t=0;t<this.ket.length;++t)this.ket[t].dispose();this.ket=null}this.RO&&t&&this.RO.dispose(),this.Vet=null}}class IE extends RE{constructor(t){super(t)}get depthRenderer(){return this.Fet}setDepthRenderer(t=null,i=2,e=!0){const s=this.JD.getScene();this.Fet&&(delete s.Fet[this.Get],this.Fet.dispose(),this.Fet=null),null===t&&(s.Fet||(s.Fet={}),(t=this.Fet=new wE(s,i,this.JD,!1,1)).enabled=!1,this.Get="minmax"+this.JD.id,s.Fet[this.Get]=t),super.setSourceTexture(t.getDepthMap(),!0,i,e)}setSourceTexture(t,i,e=2,s=!0){super.setSourceTexture(t,i,e,s)}activate(){this.Fet&&(this.Fet.enabled=!0),super.activate()}deactivate(){super.deactivate(),this.Fet&&(this.Fet.enabled=!1)}dispose(t=!0){if(super.dispose(t),this.Fet&&t){const t=this.Fet.getDepthMap().getScene();t&&delete t.Fet[this.Get],this.Fet.dispose(),this.Fet=null}}}const ME=w.Up(),bE=w.Zero(),_E=new w,yE=new w,NE=new R;class PE extends gE{constructor(t,i,e,s){PE.IsSupported?(super(t,i,e,s),this.usePercentageCloserFiltering=!0):F.Error("CascadedShadowMap is not supported by the current engine.")}fet(t){return t===gE.FILTER_NONE||t===gE.FILTER_PCF||t===gE.FILTER_PCSS?t:(console.error('Unsupported filter "'+t+'"!'),gE.FILTER_NONE)}get numCascades(){return this.zet}set numCascades(t){(t=Math.min(Math.max(t,PE.MIN_CASCADES_COUNT),PE.MAX_CASCADES_COUNT))!==this.zet&&(this.zet=t,this.recreateShadowMap(),this.Het())}get freezeShadowCastersBoundingInfo(){return this.Xet}set freezeShadowCastersBoundingInfo(t){this.Wet&&t&&(this.Kt.onBeforeRenderObservable.remove(this.Wet),this.Wet=null),this.Wet||t||(this.Wet=this.Kt.onBeforeRenderObservable.add(this.$et.bind(this))),this.Xet=t,t&&this.$et()}$et(){if(this.Yet.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.jet.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this.pet&&this.pet.renderList){const t=this.pet.renderList;for(let i=0;i<t.length;i++){const e=t[i];if(!e)continue;const s=e.getBoundingInfo().boundingBox;this.Yet.minimizeInPlace(s.minimumWorld),this.jet.maximizeInPlace(s.maximumWorld)}const i=this.Kt.meshes;for(let t=0;t<i.length;t++){const e=i[t];if(!(e&&e.isVisible&&e.isEnabled&&e.receiveShadows))continue;const s=e.getBoundingInfo().boundingBox;this.Yet.minimizeInPlace(s.minimumWorld),this.jet.maximizeInPlace(s.maximumWorld)}}this.Ket.reConstruct(this.Yet,this.jet)}get shadowCastersBoundingInfo(){return this.Ket}set shadowCastersBoundingInfo(t){this.Ket=t}setMinMaxDistance(t,i){this.qet===t&&this.Qet===i||(t>i&&(t=0,i=1),t<0&&(t=0),i>1&&(i=1),this.qet=t,this.Qet=i,this.Zet=!0)}get minDistance(){return this.qet}get maxDistance(){return this.Qet}getClassName(){return PE.CLASSNAME}getCascadeMinExtents(t){return t>=0&&t<this.zet?this.Jet[t]:null}getCascadeMaxExtents(t){return t>=0&&t<this.zet?this.tst[t]:null}get shadowMaxZ(){return this.Y$()?this.c4:0}set shadowMaxZ(t){const i=this.Y$();i?this.c4===t||t<i.minZ||t>i.maxZ||(this.c4=t,this.H4.pH(),this.Zet=!0):this.c4=t}get debug(){return this.ist}set debug(t){this.ist=t,this.H4.pH()}get depthClamp(){return this.est}set depthClamp(t){this.est=t}get cascadeBlendPercentage(){return this.sst}set cascadeBlendPercentage(t){this.sst=t,this.H4.pH()}get lambda(){return this.nst}set lambda(t){const i=Math.min(Math.max(t,0),1);this.nst!=i&&(this.nst=i,this.Zet=!0)}getCascadeViewMatrix(t){return t>=0&&t<this.zet?this.rst[t]:null}getCascadeProjectionMatrix(t){return t>=0&&t<this.zet?this.hst[t]:null}getCascadeTransformMatrix(t){return t>=0&&t<this.zet?this.GB[t]:null}setDepthRenderer(t){this.Fet=t,this.ost&&this.ost.setDepthRenderer(this.Fet)}get autoCalcDepthBounds(){return this.ast}set autoCalcDepthBounds(t){const i=this.Y$();if(i){if(this.ast=t,!t)return this.ost&&this.ost.deactivate(),void this.setMinMaxDistance(0,1);this.ost||(this.ost=new IE(i),this.ost.onAfterReductionPerformed.add((t=>{let i=t.min,e=t.max;i>=e&&(i=0,e=1),i==this.qet&&e==this.Qet||this.setMinMaxDistance(i,e)})),this.ost.setDepthRenderer(this.Fet)),this.ost.activate()}}get autoCalcDepthBoundsRefreshRate(){var t,i,e;return null!==(e=null===(i=null===(t=this.ost)||void 0===t?void 0:t.depthRenderer)||void 0===i?void 0:i.getDepthMap().refreshRate)&&void 0!==e?e:-1}set autoCalcDepthBoundsRefreshRate(t){var i;(null===(i=this.ost)||void 0===i?void 0:i.depthRenderer)&&(this.ost.depthRenderer.getDepthMap().refreshRate=t)}splitFrustum(){this.Zet=!0}lst(){const t=this.Y$();if(!t)return;const i=t.minZ,e=t.maxZ,s=e-i,n=this.qet,r=i+n*s,h=i+(this.c4<e&&this.c4>=i?Math.min((this.c4-i)/(e-i),this.Qet):this.Qet)*s,o=h-r,a=h/r;for(let t=0;t<this.cst.length;++t){const e=(t+1)/this.zet,h=r*a**e,l=r+o*e,c=this.nst*(h-l)+l;this.cst[t].prevBreakDistance=0===t?n:this.cst[t-1].breakDistance,this.cst[t].breakDistance=(c-i)/s,this.ust[t]=c,this.fst[t]=(this.cst[t].breakDistance-this.cst[t].prevBreakDistance)*s}this.Zet=!1}dst(){const t=this.Kt;if(!this.Y$())return;w.NormalizeToRef(this.H4.getShadowDirection(0),this.tet),1===Math.abs(w.Dot(this.tet,w.Up()))&&(this.tet.z=1e-13),this.iet.copyFrom(this.tet);const i=t.getEngine().useReverseDepthBuffer;for(let e=0;e<this.zet;++e){this.pst(e),this.mst(e),this.tst[e].subtractToRef(this.Jet[e],_E),this.vst[e].addToRef(this.tet.scale(this.Jet[e].z),this.gst[e]),R.LookAtLHToRef(this.gst[e],this.vst[e],ME,this.rst[e]);let s=0,n=_E.z;const r=this.Ket;r.update(this.rst[e]),n=Math.min(n,r.boundingBox.maximumWorld.z),s=this.est&&this.filter!==gE.FILTER_PCSS?Math.max(s,r.boundingBox.minimumWorld.z):Math.min(s,r.boundingBox.minimumWorld.z),R.OrthoOffCenterLHToRef(this.Jet[e].x,this.tst[e].x,this.Jet[e].y,this.tst[e].y,i?n:s,i?s:n,this.hst[e],t.getEngine().isNDCHalfZRange),this.Jet[e].z=s,this.tst[e].z=n,this.rst[e].multiplyToRef(this.hst[e],this.GB[e]),w.TransformCoordinatesToRef(bE,this.GB[e],_E),_E.scaleInPlace(this.het/2),yE.copyFromFloats(Math.round(_E.x),Math.round(_E.y),Math.round(_E.z)),yE.subtractInPlace(_E).scaleInPlace(2/this.het),R.TranslationToRef(yE.x,yE.y,0,NE),this.hst[e].multiplyToRef(NE,this.hst[e]),this.rst[e].multiplyToRef(this.hst[e],this.GB[e]),this.GB[e].copyToArray(this.Sst,16*e)}}pst(t){const i=this.Y$();if(!i)return;const e=this.cst[t].prevBreakDistance,s=this.cst[t].breakDistance,n=this.Kt.getEngine().isNDCHalfZRange;i.getViewMatrix();const r=R.Invert(i.getTransformationMatrix()),h=this.Kt.getEngine().useReverseDepthBuffer?4:0;for(let i=0;i<PE.Est.length;++i)_E.copyFrom(PE.Est[(i+h)%PE.Est.length]),n&&-1===_E.z&&(_E.z=0),w.TransformCoordinatesToRef(_E,r,this.Ast[t][i]);for(let i=0;i<PE.Est.length/2;++i)_E.copyFrom(this.Ast[t][i+4]).subtractInPlace(this.Ast[t][i]),yE.copyFrom(_E).scaleInPlace(e),_E.scaleInPlace(s),_E.addInPlace(this.Ast[t][i]),this.Ast[t][i+4].copyFrom(_E),this.Ast[t][i].addInPlace(yE)}mst(t){this.Jet[t].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.tst[t].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this.vst[t].copyFromFloats(0,0,0);if(this.Y$()){for(let i=0;i<this.Ast[t].length;++i)this.vst[t].addInPlace(this.Ast[t][i]);if(this.vst[t].scaleInPlace(1/this.Ast[t].length),this.stabilizeCascades){let i=0;for(let e=0;e<this.Ast[t].length;++e){const s=this.Ast[t][e].subtractToRef(this.vst[t],_E).length();i=Math.max(i,s)}i=Math.ceil(16*i)/16,this.tst[t].copyFromFloats(i,i,i),this.Jet[t].copyFromFloats(-i,-i,-i)}else{const i=this.vst[t];this.vst[t].addToRef(this.tet,_E),R.LookAtLHToRef(i,_E,ME,NE);for(let i=0;i<this.Ast[t].length;++i)w.TransformCoordinatesToRef(this.Ast[t][i],NE,_E),this.Jet[t].minimizeInPlace(_E),this.tst[t].maximizeInPlace(_E)}}}Het(){if(this.Pet(),this.oet)for(let t=0;t<this.zet;++t)this.oet.push(this.Kt.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this.H4.name}" cascade #${t})`))}static get IsSupported(){const t=E.LastCreatedEngine;return!!t&&t.hs.supportCSM}aet(){var t,i,e,s,n,r,h,o,a,l,c,u,f,d,p,m,v,g,S,E;this.penumbraDarkness=null!==(t=this.penumbraDarkness)&&void 0!==t?t:1,this.zet=null!==(i=this.zet)&&void 0!==i?i:PE.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=null!==(e=this.stabilizeCascades)&&void 0!==e&&e,this.Wet=null!==(s=this.Wet)&&void 0!==s?s:null,this.freezeShadowCastersBoundingInfo=null!==(n=this.freezeShadowCastersBoundingInfo)&&void 0!==n&&n,this.Yet=null!==(r=this.Yet)&&void 0!==r?r:new w(0,0,0),this.jet=null!==(h=this.jet)&&void 0!==h?h:new w(0,0,0),this.Ket=null!==(o=this.Ket)&&void 0!==o?o:new ms(new w(0,0,0),new w(0,0,0)),this.Zet=null===(a=this.Zet)||void 0===a||a,this.qet=null!==(l=this.qet)&&void 0!==l?l:0,this.Qet=null!==(c=this.Qet)&&void 0!==c?c:1,this.t2=null!==(u=this.t2)&&void 0!==u?u:0,this.c4=null!==(p=null!==(f=this.c4)&&void 0!==f?f:null===(d=this.Y$())||void 0===d?void 0:d.maxZ)&&void 0!==p?p:1e4,this.ist=null!==(m=this.ist)&&void 0!==m&&m,this.est=null===(v=this.est)||void 0===v||v,this.sst=null!==(g=this.sst)&&void 0!==g?g:.1,this.nst=null!==(S=this.nst)&&void 0!==S?S:.5,this.ast=null!==(E=this.ast)&&void 0!==E&&E,this.Het(),super.aet()}Eet(){const t=this.Kt.getEngine(),i={width:this.het,height:this.het,layers:this.numCascades};this.pet=new br(this.H4.name+"_CSMShadowMap",i,this.Kt,!1,!0,this.tL,!1,void 0,!1,!1,void 0),this.pet.createDepthStencilTexture(t.useReverseDepthBuffer?516:513,!0)}vet(){if(super.vet(),null===this.pet)return;this.Sst=new Float32Array(16*this.zet),this.ust=new Array(this.zet),this.fst=new Array(this.zet),this.Cst=new Array(2*this.zet),this.wst=new Array(this.zet),this.cst=[],this.rst=[],this.hst=[],this.GB=[],this.Jet=[],this.tst=[],this.vst=[],this.gst=[],this.Ast=[];for(let t=0;t<this.zet;++t){this.cst[t]={prevBreakDistance:0,breakDistance:0},this.rst[t]=R.Zero(),this.hst[t]=R.Zero(),this.GB[t]=R.Zero(),this.Jet[t]=new w,this.tst[t]=new w,this.vst[t]=new w,this.gst[t]=new w,this.Ast[t]=new Array(PE.Est.length);for(let i=0;i<PE.Est.length;++i)this.Ast[t][i]=new w}const t=this.Kt.getEngine();this.pet.onBeforeBindObservable.clear(),this.pet.onBeforeRenderObservable.clear(),this.pet.onBeforeRenderObservable.add((i=>{this.oet&&this.Kt.setSceneUniformBuffer(this.oet[i]),this.t2=i,this.Kit===gE.FILTER_PCF&&t.setColorWrite(!1),this.Kt.setTransformMatrix(this.getCascadeViewMatrix(i),this.getCascadeProjectionMatrix(i)),this.AR&&(this.Kt.getSceneUniformBuffer().unbindEffect(),this.Kt.finalizeSceneUbo())})),this.pet.onBeforeBindObservable.add((()=>{var i;this.A5=this.Kt.getSceneUniformBuffer(),null===(i=t.NO)||void 0===i||i.call(t,`cascaded shadow map generation for pass id ${t.currentRenderPassId}`,1),this.Zet&&this.lst(),this.dst()})),this.lst()}bet(t,i){i.setMatrix("viewProjection",this.getCascadeTransformMatrix(this.t2))}_et(t){t.push("#define SM_DEPTHCLAMP "+(this.est&&this.Kit!==gE.FILTER_PCSS?"1":"0"))}prepareDefines(t,i){super.prepareDefines(t,i);const e=this.Kt,s=this.H4;if(!e.shadowsEnabled||!s.shadowEnabled)return;t["SHADOWCSM"+i]=!0,t["SHADOWCSMDEBUG"+i]=this.debug,t["SHADOWCSMNUM_CASCADES"+i]=this.numCascades,t["SHADOWCSM_RIGHTHANDED"+i]=e.useRightHandedSystem;const n=this.Y$();n&&this.c4<n.maxZ&&(t["SHADOWCSMUSESHADOWMAXZ"+i]=!0),0===this.cascadeBlendPercentage&&(t["SHADOWCSMNOBLEND"+i]=!0)}bindShadowLight(t,i){const e=this.H4;if(!this.Kt.shadowsEnabled||!e.shadowEnabled)return;const s=this.Y$();if(!s)return;const n=this.getShadowMap();if(!n)return;const r=n.getSize().width;if(i.setMatrices("lightMatrix"+t,this.Sst),i.setArray("viewFrustumZ"+t,this.ust),i.setFloat("cascadeBlendFactor"+t,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),i.setArray("frustumLengths"+t,this.fst),this.Kit===gE.FILTER_PCF)i.setDepthStencilTexture("shadowSampler"+t,n),e.VT.updateFloat4("shadowsInfo",this.getDarkness(),r,1/r,this.frustumEdgeFalloff,t);else if(this.Kit===gE.FILTER_PCSS){for(let t=0;t<this.zet;++t)this.Cst[2*t+0]=0===t?1:(this.tst[0].x-this.Jet[0].x)/(this.tst[t].x-this.Jet[t].x),this.Cst[2*t+1]=0===t?1:(this.tst[0].y-this.Jet[0].y)/(this.tst[t].y-this.Jet[t].y),this.wst[t]=0===t?1:(this.tst[t].z-this.Jet[t].z)/(this.tst[0].z-this.Jet[0].z);i.setDepthStencilTexture("shadowSampler"+t,n),i.setTexture("depthSampler"+t,n),i.setArray2("lightSizeUVCorrection"+t,this.Cst),i.setArray("depthCorrection"+t,this.wst),i.setFloat("penumbraDarkness"+t,this.penumbraDarkness),e.VT.updateFloat4("shadowsInfo",this.getDarkness(),1/r,this.Qit*r,this.frustumEdgeFalloff,t)}else i.setTexture("shadowSampler"+t,n),e.VT.updateFloat4("shadowsInfo",this.getDarkness(),r,1/r,this.frustumEdgeFalloff,t);e.VT.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),t)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this.Wet&&(this.Kt.onBeforeRenderObservable.remove(this.Wet),this.Wet=null),this.ost&&(this.ost.dispose(),this.ost=null)}serialize(){const t=super.serialize(),i=this.getShadowMap();if(!i)return t;if(t.numCascades=this.zet,t.debug=this.ist,t.stabilizeCascades=this.stabilizeCascades,t.lambda=this.nst,t.cascadeBlendPercentage=this.cascadeBlendPercentage,t.depthClamp=this.est,t.autoCalcDepthBounds=this.autoCalcDepthBounds,t.shadowMaxZ=this.c4,t.penumbraDarkness=this.penumbraDarkness,t.freezeShadowCastersBoundingInfo=this.Xet,t.minDistance=this.minDistance,t.maxDistance=this.maxDistance,t.renderList=[],i.renderList)for(let e=0;e<i.renderList.length;e++){const s=i.renderList[e];t.renderList.push(s.id)}return t}static Parse(t,i){const e=gE.Parse(t,i,((t,i,e)=>new PE(t,i,void 0,e)));return void 0!==t.numCascades&&(e.numCascades=t.numCascades),void 0!==t.debug&&(e.debug=t.debug),void 0!==t.stabilizeCascades&&(e.stabilizeCascades=t.stabilizeCascades),void 0!==t.lambda&&(e.lambda=t.lambda),void 0!==t.cascadeBlendPercentage&&(e.cascadeBlendPercentage=t.cascadeBlendPercentage),void 0!==t.depthClamp&&(e.depthClamp=t.depthClamp),void 0!==t.autoCalcDepthBounds&&(e.autoCalcDepthBounds=t.autoCalcDepthBounds),void 0!==t.shadowMaxZ&&(e.shadowMaxZ=t.shadowMaxZ),void 0!==t.penumbraDarkness&&(e.penumbraDarkness=t.penumbraDarkness),void 0!==t.freezeShadowCastersBoundingInfo&&(e.freezeShadowCastersBoundingInfo=t.freezeShadowCastersBoundingInfo),void 0!==t.minDistance&&void 0!==t.maxDistance&&e.setMinMaxDistance(t.minDistance,t.maxDistance),e}}PE.Est=[new w(-1,1,-1),new w(1,1,-1),new w(1,-1,-1),new w(-1,-1,-1),new w(-1,1,1),new w(1,1,1),new w(1,-1,1),new w(-1,-1,1)],PE.CLASSNAME="CascadedShadowGenerator",PE.DEFAULT_CASCADES_COUNT=4,PE.MIN_CASCADES_COUNT=2,PE.MAX_CASCADES_COUNT=4,PE.qM=t=>{throw X("ShadowGeneratorSceneComponent")},e.AddParser(fe.NAME_SHADOWGENERATOR,((t,i)=>{if(void 0!==t.shadowGenerators&&null!==t.shadowGenerators)for(let e=0,s=t.shadowGenerators.length;e<s;e++){const s=t.shadowGenerators[e];s.className===PE.CLASSNAME?PE.Parse(s,i):gE.Parse(s,i)}}));class DE{constructor(t){this.name=fe.NAME_SHADOWGENERATOR,this.scene=t}register(){this.scene.zv.registerStep(fe.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this.xst)}rebuild(){}serialize(t){t.shadowGenerators=[];const i=this.scene.lights;for(const e of i){const i=e.getShadowGenerators();if(i){const e=i.values();for(let i=e.next();!0!==i.done;i=e.next()){const e=i.value;t.shadowGenerators.push(e.serialize())}}}}addFromContainer(t){}removeFromContainer(t,i){}dispose(){}xst(t){const i=this.scene;if(this.scene.shadowsEnabled)for(let e=0;e<i.lights.length;e++){const s=i.lights[e],n=s.getShadowGenerators();if(s.isEnabled()&&s.shadowEnabled&&n){const e=n.values();for(let s=e.next();!0!==s.done;s=e.next()){const e=s.value.getShadowMap();-1!==i.textures.indexOf(e)&&t.push(e)}}}}}gE.qM=t=>{let i=t.Mg(fe.NAME_SHADOWGENERATOR);i||(i=new DE(t),t.Ig(i))},dt.AddNodeConstructor("Light_Type_0",((t,i)=>()=>new LE(t,w.Zero(),i)));class LE extends im{constructor(t,i,e){super(t,e),this.Tst=Math.PI/2,this.position=i}get shadowAngle(){return this.Tst}set shadowAngle(t){this.Tst=t,this.forceProjectionMatrixCompute()}get direction(){return this.GP}set direction(t){const i=this.needCube();if(this.GP=t,this.needCube()!==i&&this.lH){const t=this.lH.values();for(let i=t.next();!0!==i.done;i=t.next()){i.value.recreateShadowMap()}}}getClassName(){return"PointLight"}getTypeID(){return No.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(t){if(this.direction)return super.getShadowDirection(t);switch(t){case 0:return new w(1,0,0);case 1:return new w(-1,0,0);case 2:return new w(0,-1,0);case 3:return new w(0,1,0);case 4:return new w(0,0,1);case 5:return new w(0,0,-1)}return w.Zero()}u4(t,i,e){const s=this.getScene().activeCamera;if(!s)return;const n=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,r=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,h=this.getScene().getEngine().useReverseDepthBuffer;R.PerspectiveFovLHToRef(this.shadowAngle,1,h?r:n,h?n:r,t,!0,this.Kt.getEngine().isNDCHalfZRange,void 0,h)}kT(){this.VT.addUniform("vLightData",4),this.VT.addUniform("vLightDiffuse",4),this.VT.addUniform("vLightSpecular",4),this.VT.addUniform("vLightFalloff",4),this.VT.addUniform("shadowsInfo",3),this.VT.addUniform("depthValues",2),this.VT.create()}transferToEffect(t,i){return this.computeTransformedInformation()?this.VT.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,i):this.VT.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,i),this.VT.updateFloat4("vLightFalloff",this.range,this.eH,0,0,i),this}transferToNodeMaterialEffect(t,i){return this.computeTransformedInformation()?t.setFloat3(i,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):t.setFloat3(i,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(t,i){t["POINTLIGHT"+i]=!0}}ut([Q()],LE.prototype,"shadowAngle",null);class OE{constructor(t,i="",e="black"){this.io=t,this.Rst=i,this.Ist=e,this.Mst=()=>{const t=this.io.getBoundingClientRect(),i=window.getComputedStyle(this.io).position;this.bst&&(this.bst.style.position="fixed"===i?"fixed":"absolute",this.bst.style.left=t.left+"px",this.bst.style.top=t.top+"px",this.bst.style.width=t.width+"px",this.bst.style.height=t.height+"px")}}displayLoadingUI(){if(this.bst)return;this.bst=document.createElement("div"),this.bst.id="babylonjsLoadingDiv",this.bst.style.opacity="0",this.bst.style.transition="opacity 1.5s ease",this.bst.style.pointerEvents="none",this.bst.style.display="grid",this.bst.style.gridTemplateRows="100%",this.bst.style.gridTemplateColumns="100%",this.bst.style.justifyItems="center",this.bst.style.alignItems="center",this._st=document.createElement("div"),this._st.style.position="absolute",this._st.style.left="0",this._st.style.top="50%",this._st.style.marginTop="80px",this._st.style.width="100%",this._st.style.height="20px",this._st.style.fontFamily="Arial",this._st.style.fontSize="14px",this._st.style.color="white",this._st.style.textAlign="center",this._st.style.zIndex="1",this._st.innerHTML="Loading",this.bst.appendChild(this._st),this._st.innerHTML=this.Rst,this.yst=document.createElement("style"),this.yst.type="text/css";this.yst.innerHTML="@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}\n                    100% { -webkit-transform: rotate(360deg);}\n                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}\n                    100% { transform: rotate(360deg);}\n                }",document.getElementsByTagName("head")[0].appendChild(this.yst);const t=!!window.SVGSVGElement,i=new Image;OE.DefaultLogoUrl?i.src=OE.DefaultLogoUrl:i.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",i.style.width="150px",i.style.gridColumn="1",i.style.gridRow="1",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.position="absolute";const e=document.createElement("div");e.style.width="300px",e.style.gridColumn="1",e.style.gridRow="1",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.position="absolute";const s=new Image;if(OE.DefaultSpinnerUrl?s.src=OE.DefaultSpinnerUrl:s.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",s.style.animation="spin1 0.75s infinite linear",s.style.webkitAnimation="spin1 0.75s infinite linear",s.style.transformOrigin="50% 50%",s.style.webkitTransformOrigin="50% 50%",!t){const t={w:16,h:18.5},e={w:30,h:30};i.style.width=`${t.w}vh`,i.style.height=`${t.h}vh`,i.style.left=`calc(50% - ${t.w/2}vh)`,i.style.top=`calc(50% - ${t.h/2}vh)`,s.style.width=`${e.w}vh`,s.style.height=`${e.h}vh`,s.style.left=`calc(50% - ${e.w/2}vh)`,s.style.top=`calc(50% - ${e.h/2}vh)`}e.appendChild(s),this.bst.appendChild(i),this.bst.appendChild(e),this.Mst(),window.addEventListener("resize",this.Mst),this.bst.style.backgroundColor=this.Ist,document.body.appendChild(this.bst),this.bst.style.opacity="1"}hideLoadingUI(){if(!this.bst)return;this.bst.style.opacity="0",this.bst.addEventListener("transitionend",(()=>{this._st&&(this._st.remove(),this._st=null),this.bst&&(this.bst.remove(),this.bst=null),this.yst&&(this.yst.remove(),this.yst=null),window.removeEventListener("resize",this.Mst)}))}set loadingUIText(t){this.Rst=t,this._st&&(this._st.innerHTML=this.Rst)}get loadingUIText(){return this.Rst}get loadingUIBackgroundColor(){return this.Ist}set loadingUIBackgroundColor(t){this.Ist=t,this.bst&&(this.bst.style.backgroundColor=this.Ist)}}OE.DefaultLogoUrl="",OE.DefaultSpinnerUrl="",Rs.DefaultLoadingScreenFactory=t=>new OE(t);class FE{static ConvertPanoramaToCubemap(t,i,e,s){if(!t)throw"ConvertPanoramaToCubemap: input cannot be null";if(t.length!=i*e*3)throw"ConvertPanoramaToCubemap: input size is wrong";return{front:this.CreateCubemapTexture(s,this.FACE_FRONT,t,i,e),back:this.CreateCubemapTexture(s,this.FACE_BACK,t,i,e),left:this.CreateCubemapTexture(s,this.FACE_LEFT,t,i,e),right:this.CreateCubemapTexture(s,this.FACE_RIGHT,t,i,e),up:this.CreateCubemapTexture(s,this.FACE_UP,t,i,e),down:this.CreateCubemapTexture(s,this.FACE_DOWN,t,i,e),size:s,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(t,i,e,s,n){const r=new ArrayBuffer(t*t*4*3),h=new Float32Array(r),o=i[1].subtract(i[0]).scale(1/t),a=i[3].subtract(i[2]).scale(1/t),l=1/t;let c=0;for(let r=0;r<t;r++){let u=i[0],f=i[2];for(let i=0;i<t;i++){const l=f.subtract(u).scale(c).add(u);l.normalize();const d=this.CalcProjectionSpherical(l,e,s,n);h[r*t*3+3*i+0]=d.r,h[r*t*3+3*i+1]=d.g,h[r*t*3+3*i+2]=d.b,u=u.add(o),f=f.add(a)}c+=l}return h}static CalcProjectionSpherical(t,i,e,s){let n=Math.atan2(t.z,t.x);const r=Math.acos(t.y);for(;n<-Math.PI;)n+=2*Math.PI;for(;n>Math.PI;)n-=2*Math.PI;let h=n/Math.PI;const o=r/Math.PI;h=.5*h+.5;let a=Math.round(h*e);a<0?a=0:a>=e&&(a=e-1);let l=Math.round(o*s);l<0?l=0:l>=s&&(l=s-1);const c=s-l-1;return{r:i[c*e*3+3*a+0],g:i[c*e*3+3*a+1],b:i[c*e*3+3*a+2]}}}FE.FACE_LEFT=[new w(-1,-1,-1),new w(1,-1,-1),new w(-1,1,-1),new w(1,1,-1)],FE.FACE_RIGHT=[new w(1,-1,1),new w(-1,-1,1),new w(1,1,1),new w(-1,1,1)],FE.FACE_FRONT=[new w(1,-1,-1),new w(1,-1,1),new w(1,1,-1),new w(1,1,1)],FE.FACE_BACK=[new w(-1,-1,1),new w(-1,-1,-1),new w(-1,1,1),new w(-1,1,-1)],FE.FACE_DOWN=[new w(1,1,-1),new w(1,1,1),new w(-1,1,-1),new w(-1,1,1)],FE.FACE_UP=[new w(-1,-1,-1),new w(-1,-1,1),new w(1,-1,-1),new w(1,-1,1)];class BE{static Nst(t,i){return i>1023?t*Math.pow(2,1023)*Math.pow(2,i-1023):i<-1074?t*Math.pow(2,-1074)*Math.pow(2,i+1074):t*Math.pow(2,i)}static Pst(t,i,e,s,n,r){n>0?(n=this.Nst(1,n-136),t[r+0]=i*n,t[r+1]=e*n,t[r+2]=s*n):(t[r+0]=0,t[r+1]=0,t[r+2]=0)}static Lst(t,i){let e="",s="";for(let n=i;n<t.length-i&&(s=String.fromCharCode(t[n]),"\n"!=s);n++)e+=s;return e}static RGBE_ReadHeader(t){let i=0,e=0,s=this.Lst(t,0);if("#"!=s[0]||"?"!=s[1])throw"Bad HDR Format.";let n=!1,r=!1,h=0;do{h+=s.length+1,s=this.Lst(t,h),"FORMAT=32-bit_rle_rgbe"==s?r=!0:0==s.length&&(n=!0)}while(!n);if(!r)throw"HDR Bad header format, unsupported FORMAT";h+=s.length+1,s=this.Lst(t,h);const o=/^-Y (.*) \+X (.*)$/g.exec(s);if(!o||o.length<3)throw"HDR Bad header format, no size";if(e=parseInt(o[2]),i=parseInt(o[1]),e<8||e>32767)throw"HDR Bad header format, unsupported size";return h+=s.length+1,{height:i,width:e,dataPosition:h}}static GetCubeMapTextureData(t,i){const e=new Uint8Array(t),s=this.RGBE_ReadHeader(e),n=this.RGBE_ReadPixels(e,s);return FE.ConvertPanoramaToCubemap(n,s.width,s.height,i)}static RGBE_ReadPixels(t,i){return this.Ost(t,i)}static Ost(t,i){let e=i.height;const s=i.width;let n,r,h,o,a,l=i.dataPosition,c=0,u=0,f=0;const d=new ArrayBuffer(4*s),p=new Uint8Array(d),m=new ArrayBuffer(i.width*i.height*4*3),v=new Float32Array(m);for(;e>0;){if(n=t[l++],r=t[l++],h=t[l++],o=t[l++],2!=n||2!=r||128&h||i.width<8||i.width>32767)return this.Fst(t,i);if((h<<8|o)!=s)throw"HDR Bad header format, wrong scan line width";for(c=0,f=0;f<4;f++)for(u=(f+1)*s;c<u;)if(n=t[l++],r=t[l++],n>128){if(a=n-128,0==a||a>u-c)throw"HDR Bad Format, bad scanline data (run)";for(;a-- >0;)p[c++]=r}else{if(a=n,0==a||a>u-c)throw"HDR Bad Format, bad scanline data (non-run)";if(p[c++]=r,--a>0)for(let i=0;i<a;i++)p[c++]=t[l++]}for(f=0;f<s;f++)n=p[f],r=p[f+s],h=p[f+2*s],o=p[f+3*s],this.Pst(v,n,r,h,o,(i.height-e)*s*3+3*f);e--}return v}static Fst(t,i){let e=i.height;const s=i.width;let n,r,h,o,a,l=i.dataPosition;const c=new ArrayBuffer(i.width*i.height*4*3),u=new Float32Array(c);for(;e>0;){for(a=0;a<i.width;a++)n=t[l++],r=t[l++],h=t[l++],o=t[l++],this.Pst(u,n,r,h,o,(i.height-e)*s*3+3*a);e--}return u}}const UE="hdrFilteringVertexShader",VE="attribute vec2 position;\nvarying vec3 direction;\nuniform vec3 up;\nuniform vec3 right;\nuniform vec3 front;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nmat3 view=mat3(up,right,front);\ndirection=view*vec3(position,1.0);\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[UE]=VE;const kE="hdrFilteringPixelShader",GE="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform float alphaG;\nuniform samplerCube inputTexture;\nuniform vec2 vFilteringInfo;\nuniform float hdrScale;\nvarying vec3 direction;\nvoid main() {\nvec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);\ngl_FragColor=vec4(color*hdrScale,1.0);\n}";ii.ShadersStore[kE]=GE;class zE{constructor(t,i={}){this.cr=0,this.lr=.8,this.quality=4096,this.hdrScale=1,this.Ls=t,this.hdrScale=i.hdrScale||this.hdrScale,this.quality=i.quality||this.quality}Bst(t){let i=0;this.Ls.getCaps().textureHalfFloatRender?i=2:this.Ls.getCaps().textureFloatRender&&(i=1);const e=this.Ls.createRenderTargetCubeTexture(t,{format:5,type:i,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this.Ls.updateTextureWrappingMode(e.texture,0,0,0),this.Ls.updateTextureSamplingMode(3,e.texture,!0),e}Ust(t){const i=t.getSize().width,e=o.ILog2(i)+1,s=this.Vst.effect,n=this.Bst(i);this.kst.setViewport();const r=t.getInternalTexture();r&&this.Ls.updateTextureSamplingMode(3,r,!0),this.kst.applyEffectWrapper(this.Vst);const h=[[new w(0,0,-1),new w(0,-1,0),new w(1,0,0)],[new w(0,0,1),new w(0,-1,0),new w(-1,0,0)],[new w(1,0,0),new w(0,0,1),new w(0,1,0)],[new w(1,0,0),new w(0,0,-1),new w(0,-1,0)],[new w(1,0,0),new w(0,-1,0),new w(0,0,1)],[new w(-1,0,0),new w(0,-1,0),new w(0,0,-1)]];s.setFloat("hdrScale",this.hdrScale),s.setFloat2("vFilteringInfo",t.getSize().width,e),s.setTexture("inputTexture",t);for(let t=0;t<6;t++){s.setVector3("up",h[t][0]),s.setVector3("right",h[t][1]),s.setVector3("front",h[t][2]);for(let r=0;r<e;r++){this.Ls.bindFramebuffer(n,t,void 0,void 0,!0,r),this.kst.applyEffectWrapper(this.Vst);let e=Math.pow(2,(r-this.cr)/this.lr)/i;0===r&&(e=0),s.setFloat("alphaG",e),this.kst.draw()}}return this.kst.restoreStates(),this.Ls.restoreDefaultFramebuffer(),this.Ls.Nr(t.Lb),n._r(t.Lb),t.Wb=!0,t}Gst(t,i){const e=[];t.gammaSpace&&e.push("#define GAMMA_INPUT"),e.push("#define NUM_SAMPLES "+this.quality+"u");return new xr({engine:this.Ls,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:e,onCompiled:i})}isReady(t){return t.isReady()&&this.Vst.effect.isReady()}prefilter(t,i=null){return this.Ls.hs.allowTexturePrefiltering?new Promise((e=>{this.kst=new wr(this.Ls),this.Vst=this.Gst(t),this.Vst.effect.executeWhenCompiled((()=>{this.Ust(t),this.kst.dispose(),this.Vst.dispose(),e(),i&&i()}))})):(F.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))}}class HE extends nn{constructor(t,i,e,s=!1,n=!0,r=!1,o=!1,a=null,l=null){var c;super(i),this.zst=!0,this.Btt=null,this.b_=!0,this.M5=0,this.boundingBoxPosition=w.Zero(),this.onLoadObservable=new h,t&&(this.Hb=an.CUBIC_MODE,this.name=t,this.url=t,this.hasAlpha=!1,this.isCube=!0,this.pO=R.Identity(),this.Hst=o,this.Xst=()=>{this.onLoadObservable.notifyObservers(this),a&&a()},this.Btt=l,this.gammaSpace=r,this.Jb=s,this.Qn=e,this.zst=n,this.Lb=this.Qb(t,this.Jb,void 0,void 0,void 0,this.isCube),this.Lb?this.Lb.isReady?ki.SetImmediate((()=>this.Xst())):this.Lb.onLoadedObservable.add(this.Xst):(null===(c=this.getScene())||void 0===c?void 0:c.useDelayedTextureLoading)?this.delayLoadState=4:this.y5())}set isBlocking(t){this.b_=t}get isBlocking(){return this.b_}set rotationY(t){this.M5=t,this.setReflectionTextureMatrix(R.RotationY(this.M5))}get rotationY(){return this.M5}set boundingBoxSize(t){if(this.CO&&this.CO.equals(t))return;this.CO=t;const i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this.CO}getClassName(){return"HDRCubeTexture"}y5(){const t=this.qb(),i=t.getCaps();let e=0;i.textureFloat&&i.textureFloatLinearFiltering?e=1:i.textureHalfFloat&&i.textureHalfFloatLinearFiltering&&(e=2);if(t.hs.allowTexturePrefiltering&&this.Hst){const i=this.Xst,e=new zE(t);this.Xst=()=>{e.prefilter(this,i)}}this.Lb=t.createRawCubeTextureFromUrl(this.url,this.getScene(),this.Qn,4,e,this.Jb,(t=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;const i=BE.GetCubeMapTextureData(t,this.Qn);if(this.zst){const t=zu.ConvertCubeMapToSphericalPolynomial(i);this.sphericalPolynomial=t}const s=[];let n=null,r=null;for(let t=0;t<6;t++){2===e?r=new Uint16Array(this.Qn*this.Qn*3):0===e&&(n=new Uint8Array(this.Qn*this.Qn*3));const h=i[HE.Wst[t]];if(this.gammaSpace||r||n)for(let t=0;t<this.Qn*this.Qn;t++)if(this.gammaSpace&&(h[3*t+0]=Math.pow(h[3*t+0],a),h[3*t+1]=Math.pow(h[3*t+1],a),h[3*t+2]=Math.pow(h[3*t+2],a)),r&&(r[3*t+0]=Uu(h[3*t+0]),r[3*t+1]=Uu(h[3*t+1]),r[3*t+2]=Uu(h[3*t+2])),n){let i=Math.max(255*h[3*t+0],0),e=Math.max(255*h[3*t+1],0),s=Math.max(255*h[3*t+2],0);const r=Math.max(Math.max(i,e),s);if(r>255){const t=255/r;i*=t,e*=t,s*=t}n[3*t+0]=i,n[3*t+1]=e,n[3*t+2]=s}r?s.push(r):n?s.push(n):s.push(h)}return s}),null,this.Xst,this.Btt)}clone(){const t=new HE(this.url,this.getScene()||this.qb(),this.Qn,this.Jb,this.zst,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this.Lb=this.Qb(this.url,this.Jb),this.Lb||this.y5())}getReflectionTextureMatrix(){return this.pO}setReflectionTextureMatrix(t){var i;this.pO=t,t.updateFlag!==this.pO.updateFlag&&t.isIdentity()!==this.pO.isIdentity()&&(null===(i=this.getScene())||void 0===i||i.markAllMaterialsAsDirty(1,(t=>-1!==t.getActiveTextures().indexOf(this))))}dispose(){this.onLoadObservable.clear(),super.dispose()}static Parse(t,i,e){let s=null;return t.name&&!t.isRenderTarget&&(s=new HE(e+t.name,i,t.size,t.noMipmap,t.generateHarmonics,t.useInGammaSpace),s.name=t.name,s.hasAlpha=t.hasAlpha,s.level=t.level,s.coordinatesMode=t.coordinatesMode,s.isBlocking=t.isBlocking),s&&(t.boundingBoxPosition&&(s.boundingBoxPosition=w.FromArray(t.boundingBoxPosition)),t.boundingBoxSize&&(s.boundingBoxSize=w.FromArray(t.boundingBoxSize)),t.rotationY&&(s.rotationY=t.rotationY)),s}serialize(){if(!this.name)return null;const t={};return t.name=this.name,t.hasAlpha=this.hasAlpha,t.isCube=!0,t.level=this.level,t.size=this.Qn,t.coordinatesMode=this.coordinatesMode,t.useInGammaSpace=this.gammaSpace,t.generateHarmonics=this.zst,t.customType="BABYLON.HDRCubeTexture",t.noMipmap=this.Jb,t.isBlocking=this.b_,t.rotationY=this.M5,t}}HE.Wst=["right","left","up","down","front","back"],v("BABYLON.HDRCubeTexture",HE);class XE{constructor(t,i=0,e=null){this.name=t,this.animations=new Array,this.QC=null,this.Ll=null,this.DE=null,this.Ol=null,this.Tr=0,this.onInfluenceChanged=new h,this.$st=new h,this.Pi=null,this.Kt=e||E.LastCreatedScene,this.influence=i,this.Kt&&(this.Tr=this.Kt.getUniqueId())}get influence(){return this.Yst}set influence(t){if(this.Yst===t)return;const i=this.Yst;this.Yst=t,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===i||0===t)}get animationPropertiesOverride(){return!this.Pi&&this.Kt?this.Kt.animationPropertiesOverride:this.Pi}set animationPropertiesOverride(t){this.Pi=t}get uniqueId(){return this.Tr}get hasPositions(){return!!this.QC}get hasNormals(){return!!this.Ll}get hasTangents(){return!!this.DE}get hasUVs(){return!!this.Ol}setPositions(t){const i=this.hasPositions;this.QC=t,i!==this.hasPositions&&this.$st.notifyObservers(void 0)}getPositions(){return this.QC}setNormals(t){const i=this.hasNormals;this.Ll=t,i!==this.hasNormals&&this.$st.notifyObservers(void 0)}getNormals(){return this.Ll}setTangents(t){const i=this.hasTangents;this.DE=t,i!==this.hasTangents&&this.$st.notifyObservers(void 0)}getTangents(){return this.DE}setUVs(t){const i=this.hasUVs;this.Ol=t,i!==this.hasUVs&&this.$st.notifyObservers(void 0)}getUVs(){return this.Ol}clone(){const t=ot.Clone((()=>new XE(this.name,this.influence,this.Kt)),this);return t.QC=this.QC,t.Ll=this.Ll,t.DE=this.DE,t.Ol=this.Ol,t}serialize(){const t={};return t.name=this.name,t.influence=this.influence,t.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(t.id=this.id),this.hasNormals&&(t.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(t.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(t.uvs=Array.prototype.slice.call(this.getUVs())),ot.AppendSerializedAnimations(this,t),t}getClassName(){return"MorphTarget"}static Parse(t,i){const e=new XE(t.name,t.influence);if(e.setPositions(t.positions),null!=t.id&&(e.id=t.id),t.normals&&e.setNormals(t.normals),t.tangents&&e.setTangents(t.tangents),t.uvs&&e.setUVs(t.uvs),t.animations){for(let i=0;i<t.animations.length;i++){const s=t.animations[i],n=g("BABYLON.Animation");n&&e.animations.push(n.Parse(s))}t.autoAnimate&&i&&i.beginAnimation(e,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1)}return e}static FromMesh(t,i,e){i||(i=t.name);const s=new XE(i,e,t.getScene());return s.setPositions(t.getVerticesData(he.PositionKind)),t.isVerticesDataPresent(he.NormalKind)&&s.setNormals(t.getVerticesData(he.NormalKind)),t.isVerticesDataPresent(he.TangentKind)&&s.setTangents(t.getVerticesData(he.TangentKind)),t.isVerticesDataPresent(he.UVKind)&&s.setUVs(t.getVerticesData(he.UVKind)),s}}ut([Q()],XE.prototype,"id",void 0);class WE extends an{constructor(t,i,e,s,n,r,h=!0,o=!1,a=an.TRILINEAR_SAMPLINGMODE,l=0){super(null,r,!h,o),this.format=n,this.Lb=r.getEngine().createRawTexture2DArray(t,i,e,s,n,h,o,a,null,l),this.cK=s,this.is2DArray=!0}get depth(){return this.cK}update(t){this.Lb&&this.qb().updateRawTexture2DArray(this.Lb,t,this.Lb.format,this.Lb.invertY,null,this.Lb.type)}static CreateRGBATexture(t,i,e,s,n,r=!0,h=!1,o=3,a=0){return new WE(t,i,e,s,5,n,r,h,o,a)}}class $E{constructor(t=null){if(this.jst=new Array,this.Kst=new Array,this.qst=new Array,this.Me=new zi(16),this.Qst=!1,this.Zst=!1,this.Jst=!1,this.tnt=0,this.ent=0,this.snt=0,this.nnt=1,this.Tr=0,this.rnt=new Array,this.hnt=!1,this.ont=0,this.Si=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this.ant=!0,t||(t=E.LastCreatedScene),this.Kt=t,this.Kt){this.Kt.morphTargetManagers.push(this),this.Tr=this.Kt.getUniqueId();const t=this.Kt.getEngine().getCaps();this.hnt=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0&&t.texture2DArrayMaxLayerCount>1}}set areUpdatesFrozen(t){t?this.ont++:(this.ont--,this.ont<=0&&(this.ont=0,this.lnt(!0)))}get areUpdatesFrozen(){return this.ont>0}get uniqueId(){return this.Tr}get vertexCount(){return this.tnt}get supportsNormals(){return this.Qst&&this.enableNormalMorphing}get supportsTangents(){return this.Zst&&this.enableTangentMorphing}get supportsUVs(){return this.Jst&&this.enableUVMorphing}get numTargets(){return this.jst.length}get numInfluencers(){return this.Me.length}get influences(){return this.cnt}get useTextureToStoreTargets(){return this.ant}set useTextureToStoreTargets(t){this.ant=t}get isUsingTextureForTargets(){return $E.EnableTextureStorage&&this.useTextureToStoreTargets&&this.hnt}getActiveTarget(t){return this.Me.data[t]}getTarget(t){return this.jst[t]}addTarget(t){this.jst.push(t),this.Kst.push(t.onInfluenceChanged.add((t=>{this.lnt(t)}))),this.qst.push(t.$st.add((()=>{this.lnt(!0)}))),this.lnt(!0)}removeTarget(t){const i=this.jst.indexOf(t);i>=0&&(this.jst.splice(i,1),t.onInfluenceChanged.remove(this.Kst.splice(i,1)[0]),t.$st.remove(this.qst.splice(i,1)[0]),this.lnt(!0))}$C(t){t.setFloat3("morphTargetTextureInfo",this.ent,this.snt,this.nnt),t.setFloatArray("morphTargetTextureIndices",this.unt),t.setTexture("morphTargets",this.fnt)}clone(){const t=new $E(this.Kt);for(const i of this.jst)t.addTarget(i.clone());return t.enableNormalMorphing=this.enableNormalMorphing,t.enableTangentMorphing=this.enableTangentMorphing,t.enableUVMorphing=this.enableUVMorphing,t}serialize(){const t={};t.id=this.uniqueId,t.targets=[];for(const i of this.jst)t.targets.push(i.serialize());return t}lnt(t){if(this.areUpdatesFrozen)return;let i=0;this.Me.reset(),this.Qst=!0,this.Zst=!0,this.Jst=!0,this.tnt=0,this.unt&&this.unt.length===this.jst.length||(this.unt=new Float32Array(this.jst.length));let e=-1;for(const t of this.jst){if(e++,0===t.influence&&this.optimizeInfluencers)continue;this.Me.push(t),this.unt[i]=e,this.rnt[i++]=t.influence,this.Qst=this.Qst&&t.hasNormals,this.Zst=this.Zst&&t.hasTangents,this.Jst=this.Jst&&t.hasUVs;const s=t.getPositions();if(s){const t=s.length/3;if(0===this.tnt)this.tnt=t;else if(this.tnt!==t)return void F.Error("Incompatible target. Targets must all have the same vertices count.")}}this.cnt&&this.cnt.length===i||(this.cnt=new Float32Array(i));for(let t=0;t<i;t++)this.cnt[t]=this.rnt[t];t&&this.synchronize()}synchronize(){if(this.Kt&&!this.areUpdatesFrozen){if(this.isUsingTextureForTargets&&this.tnt){this.ent=1,this.Qst&&this.ent++,this.Zst&&this.ent++,this.Jst&&this.ent++,this.snt=this.tnt*this.ent,this.nnt=1;const t=this.Kt.getEngine().getCaps().maxTextureSize;this.snt>t&&(this.nnt=Math.ceil(this.snt/t),this.snt=t);let i=!0;if(this.fnt){const t=this.fnt.getSize();t.width===this.snt&&t.height===this.nnt&&this.fnt.depth===this.jst.length&&(i=!1)}if(i){this.fnt&&this.fnt.dispose();const t=this.jst.length,i=new Float32Array(t*this.snt*this.nnt*4);let e=0;for(let s=0;s<t;s++){const t=this.jst[s],n=t.getPositions(),r=t.getNormals(),h=t.getUVs(),o=t.getTangents();if(!n)return void(0===s&&F.Error("Invalid morph target. Target must have positions."));e=s*this.snt*this.nnt*4;for(let t=0;t<this.tnt;t++)i[e]=n[3*t],i[e+1]=n[3*t+1],i[e+2]=n[3*t+2],e+=4,r&&(i[e]=r[3*t],i[e+1]=r[3*t+1],i[e+2]=r[3*t+2],e+=4),h&&(i[e]=h[2*t],i[e+1]=h[2*t+1],e+=4),o&&(i[e]=o[3*t],i[e+1]=o[3*t+1],i[e+2]=o[3*t+2],e+=4)}this.fnt=WE.CreateRGBATexture(i,this.snt,this.nnt,t,this.Kt,!1,!1,1,1)}}for(const t of this.Kt.meshes)t.morphTargetManager===this&&t.JC()}}dispose(){if(this.fnt&&this.fnt.dispose(),this.fnt=null,this.Kt&&(this.Kt.removeMorphTargetManager(this),this.Si)){const t=this.Si.morphTargetManagers.indexOf(this);t>-1&&this.Si.morphTargetManagers.splice(t,1),this.Si=null}}static Parse(t,i){const e=new $E(i);e.Tr=t.id;for(const s of t.targets)e.addTarget(XE.Parse(s,i));return e}}$E.EnableTextureStorage=!0;class YE{constructor(){this.dnt=!1,this.pnt=0,this.mnt=w.Zero(),this.vnt=w.Zero(),this.gnt=w.Zero(),this.Snt=w.Zero()}get hasHit(){return this.dnt}get hitDistance(){return this.pnt}get hitNormalWorld(){return this.mnt}get hitPointWorld(){return this.vnt}get rayFromWorld(){return this.gnt}get rayToWorld(){return this.Snt}setHitData(t,i){this.dnt=!0,this.mnt=new w(t.x,t.y,t.z),this.vnt=new w(i.x,i.y,i.z)}setHitDistance(t){this.pnt=t}calculateHitDistance(){this.pnt=w.Distance(this.gnt,this.vnt)}reset(t=w.Zero(),i=w.Zero()){this.gnt=t,this.Snt=i,this.dnt=!1,this.pnt=0,this.mnt=w.Zero(),this.vnt=w.Zero()}}class jE{constructor(t,i=jE.DefaultPluginFactory()){if(this.LN=i,this.Ent=[],this.$N=[],this.Ant=0,this.Cnt=0,!this.LN.isSupported())throw new Error("Physics Engine "+this.LN.name+" cannot be found. Please make sure it is included.");t=t||new w(0,-9.807,0),this.setGravity(t),this.setTimeStep()}getPluginVersion(){return this.LN.getPluginVersion()}static DefaultPluginFactory(){throw X("CannonJSPlugin")}setGravity(t){this.gravity=t,this.LN.setGravity(this.gravity)}setTimeStep(t=1/60){this.LN.setTimeStep(t)}getTimeStep(){return this.LN.getTimeStep()}setSubTimeStep(t=0){this.Ant=t}getSubTimeStep(){return this.Ant}dispose(){this.Ent.forEach((function(t){t.dispose()})),this.LN.dispose()}getPhysicsPluginName(){return this.LN.name}addImpostor(t){this.Ent.push(t),t.uniqueId=this.Cnt++,t.parent||this.LN.generatePhysicsBody(t)}removeImpostor(t){const i=this.Ent.indexOf(t);if(i>-1){this.Ent.splice(i,1).length&&this.getPhysicsPlugin().removePhysicsBody(t)}}addJoint(t,i,e){const s={mainImpostor:t,connectedImpostor:i,joint:e};e.physicsPlugin=this.LN,this.$N.push(s),this.LN.generateJoint(s)}removeJoint(t,i,e){const s=this.$N.filter((function(s){return s.connectedImpostor===i&&s.joint===e&&s.mainImpostor===t}));s.length&&this.LN.removeJoint(s[0])}wnt(t){this.Ent.forEach((t=>{t.isBodyInitRequired()&&this.LN.generatePhysicsBody(t)})),t>.1?t=.1:t<=0&&(t=1/60),this.LN.executeStep(t,this.Ent)}getPhysicsPlugin(){return this.LN}getImpostors(){return this.Ent}getImpostorForPhysicsObject(t){for(let i=0;i<this.Ent.length;++i)if(this.Ent[i].object===t)return this.Ent[i];return null}getImpostorWithPhysicsBody(t){for(let i=0;i<this.Ent.length;++i)if(this.Ent[i].physicsBody===t)return this.Ent[i];return null}raycast(t,i){return this.LN.raycast(t,i)}raycastToRef(t,i,e){return this.LN.raycastToRef(t,i,e)}}class KE{constructor(t=!0,i=10,e=CANNON){this.xnt=t,this.name="CannonJSPlugin",this.Tnt=new Array,this.Rnt=1/60,this.Mnt=new Array,this.x7=!0,this.Lk=new T,this.bnt=new T(-.7071067811865475,0,0,.7071067811865475),this._nt=new T(.7071067811865475,0,0,.7071067811865475),this.ynt=w.Zero(),this.Nnt=w.Zero(),this.Pnt=new T,this.BJSCANNON=e,this.isSupported()?(this.Dnt(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=i,this.Lnt=new this.BJSCANNON.RaycastResult,this.Ont=new YE):F.Error("CannonJS is not available. Please make sure you included the js file.")}getPluginVersion(){return 1}setGravity(t){const i=t;this.world.gravity.set(i.x,i.y,i.z)}setTimeStep(t){this.Rnt=t}getTimeStep(){return this.Rnt}executeStep(t,i){if(this.x7){this.x7=!1;for(const t of i)t.type!=Rn.HeightmapImpostor&&t.type!==Rn.PlaneImpostor&&t.beforeStep()}this.world.step(this.xnt?t:this.Rnt),this.Fnt()}Fnt(){this.Mnt.length>0&&(this.Mnt.forEach((t=>{"function"==typeof this.world.removeBody?this.world.removeBody(t):this.world.remove(t)})),this.Mnt.length=0)}applyImpulse(t,i,e){const s=new this.BJSCANNON.Vec3(e.x,e.y,e.z),n=new this.BJSCANNON.Vec3(i.x,i.y,i.z);t.physicsBody.applyImpulse(n,s)}applyForce(t,i,e){const s=new this.BJSCANNON.Vec3(e.x,e.y,e.z),n=new this.BJSCANNON.Vec3(i.x,i.y,i.z);t.physicsBody.applyForce(n,s)}generatePhysicsBody(t){if(this.Fnt(),t.parent)t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());else{if(t.isBodyInitRequired()){const i=this.Bnt(t);if(!i)return void F.Warn("It was not possible to create a physics body for this object.");const e=t.physicsBody;e&&this.removePhysicsBody(t);const s=this.Unt("mat-"+t.uniqueId,t.getParam("friction"),t.getParam("restitution")),n={mass:t.getParam("mass"),material:s},r=t.getParam("nativeOptions");for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&(n[t]=r[t]);t.physicsBody=new this.BJSCANNON.Body(n),t.physicsBody.addEventListener("collide",t.onCollide),this.world.addEventListener("preStep",t.beforeStep),this.world.addEventListener("postStep",t.afterStep),t.physicsBody.addShape(i),"function"==typeof this.world.addBody?this.world.addBody(t.physicsBody):this.world.add(t.physicsBody),e&&["force","torque","velocity","angularVelocity"].forEach((function(i){const s=e[i];t.physicsBody[i].set(s.x,s.y,s.z)})),this.Vnt(t)}this.knt(t)}}Vnt(t){const i=t.object.getChildMeshes?t.object.getChildMeshes(!0):[],e=t.object.rotationQuaternion;if(e?e.conjugateToRef(this.Lk):this.Lk.set(0,0,0,1),i.length){const e=i=>{if(!i.rotationQuaternion)return;const s=i.getPhysicsImpostor();if(s){if(s.parent!==t&&i.parent){const e=i.getAbsolutePosition().subtract(i.parent.getAbsolutePosition()),n=i.rotationQuaternion.multiply(this.Lk);s.physicsBody&&(this.removePhysicsBody(s),s.physicsBody=null),s.parent=t,s.resetUpdateFlags(),t.physicsBody.addShape(this.Bnt(s),new this.BJSCANNON.Vec3(e.x,e.y,e.z),new this.BJSCANNON.Quaternion(n.x,n.y,n.z,n.w)),t.physicsBody.mass+=s.getParam("mass")}}i.getChildMeshes(!0).filter((t=>!!t.physicsImpostor)).forEach(e)};i.filter((t=>!!t.physicsImpostor)).forEach(e)}}removePhysicsBody(t){t.physicsBody.removeEventListener("collide",t.onCollide),this.world.removeEventListener("preStep",t.beforeStep),this.world.removeEventListener("postStep",t.afterStep),-1===this.Mnt.indexOf(t.physicsBody)&&this.Mnt.push(t.physicsBody)}generateJoint(t){const i=t.mainImpostor.physicsBody,e=t.connectedImpostor.physicsBody;if(!i||!e)return;let s;const n=t.joint.jointData,r={pivotA:n.mainPivot?(new this.BJSCANNON.Vec3).set(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z):null,pivotB:n.connectedPivot?(new this.BJSCANNON.Vec3).set(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z):null,axisA:n.mainAxis?(new this.BJSCANNON.Vec3).set(n.mainAxis.x,n.mainAxis.y,n.mainAxis.z):null,axisB:n.connectedAxis?(new this.BJSCANNON.Vec3).set(n.connectedAxis.x,n.connectedAxis.y,n.connectedAxis.z):null,maxForce:n.nativeParams.maxForce,collideConnected:!!n.collision};switch(t.joint.type){case Tn.HingeJoint:case Tn.Hinge2Joint:s=new this.BJSCANNON.HingeConstraint(i,e,r);break;case Tn.DistanceJoint:s=new this.BJSCANNON.DistanceConstraint(i,e,n.maxDistance||2);break;case Tn.SpringJoint:{const t=n;s=new this.BJSCANNON.Spring(i,e,{restLength:t.length,stiffness:t.stiffness,damping:t.damping,localAnchorA:r.pivotA,localAnchorB:r.pivotB});break}case Tn.LockJoint:s=new this.BJSCANNON.LockConstraint(i,e,r);break;case Tn.PointToPointJoint:case Tn.BallAndSocketJoint:default:s=new this.BJSCANNON.PointToPointConstraint(i,r.pivotA,e,r.pivotB,r.maxForce)}s.collideConnected=!!n.collision,t.joint.physicsJoint=s,t.joint.type!==Tn.SpringJoint?this.world.addConstraint(s):(t.joint.jointData.forceApplicationCallback=t.joint.jointData.forceApplicationCallback||function(){s.applyForce()},t.mainImpostor.registerAfterPhysicsStep(t.joint.jointData.forceApplicationCallback))}removeJoint(t){t.joint.type!==Tn.SpringJoint?this.world.removeConstraint(t.joint.physicsJoint):t.mainImpostor.unregisterAfterPhysicsStep(t.joint.jointData.forceApplicationCallback)}Unt(t,i,e){let s,n;for(s=0;s<this.Tnt.length;s++)if(n=this.Tnt[s],n.friction===i&&n.restitution===e)return n;const r=new this.BJSCANNON.Material(t);return r.friction=i,r.restitution=e,this.Tnt.push(r),r}Gnt(t){return t<u?u:t}Bnt(t){const i=t.object;let e;const s=t.getObjectExtents();switch(t.type){case Rn.SphereImpostor:{const t=s.x,i=s.y,n=s.z;e=new this.BJSCANNON.Sphere(Math.max(this.Gnt(t),this.Gnt(i),this.Gnt(n))/2);break}case Rn.CylinderImpostor:{let i=t.getParam("nativeOptions");i||(i={});const n=void 0!==i.radiusTop?i.radiusTop:this.Gnt(s.x)/2,r=void 0!==i.radiusBottom?i.radiusBottom:this.Gnt(s.x)/2,h=void 0!==i.height?i.height:this.Gnt(s.y),o=void 0!==i.numSegments?i.numSegments:16;e=new this.BJSCANNON.Cylinder(n,r,h,o);const a=new this.BJSCANNON.Quaternion;a.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const l=new this.BJSCANNON.Vec3(0,0,0);e.transformAllPoints(l,a);break}case Rn.BoxImpostor:{const t=s.scale(.5);e=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this.Gnt(t.x),this.Gnt(t.y),this.Gnt(t.z)));break}case Rn.PlaneImpostor:F.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),e=new this.BJSCANNON.Plane;break;case Rn.MeshImpostor:{const s=i.getVerticesData?i.getVerticesData(he.PositionKind):[],n=i.getIndices?i.getIndices():[];if(!s)return void F.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");const r=i.position.clone(),h=i.rotation&&i.rotation.clone(),o=i.rotationQuaternion&&i.rotationQuaternion.clone();i.position.copyFromFloats(0,0,0),i.rotation&&i.rotation.copyFromFloats(0,0,0),i.rotationQuaternion&&i.rotationQuaternion.copyFrom(t.getParentsRotation()),i.rotationQuaternion&&i.parent&&i.rotationQuaternion.conjugateInPlace();const a=i.computeWorldMatrix(!0),l=new Array;let c;for(c=0;c<s.length;c+=3)w.TransformCoordinates(w.FromArray(s,c),a).toArray(l,c);F.Warn("MeshImpostor only collides against spheres."),e=new this.BJSCANNON.Trimesh(l,n),i.position.copyFrom(r),h&&i.rotation&&i.rotation.copyFrom(h),o&&i.rotationQuaternion&&i.rotationQuaternion.copyFrom(o);break}case Rn.HeightmapImpostor:{const s=i.position.clone(),n=i.rotation&&i.rotation.clone(),r=i.rotationQuaternion&&i.rotationQuaternion.clone();i.position.copyFromFloats(0,0,0),i.rotation&&i.rotation.copyFromFloats(0,0,0),i.rotationQuaternion&&i.rotationQuaternion.copyFrom(t.getParentsRotation()),i.rotationQuaternion&&i.parent&&i.rotationQuaternion.conjugateInPlace(),i.rotationQuaternion&&i.rotationQuaternion.multiplyInPlace(this.bnt),e=this.znt(i),i.position.copyFrom(s),n&&i.rotation&&i.rotation.copyFrom(n),r&&i.rotationQuaternion&&i.rotationQuaternion.copyFrom(r),i.computeWorldMatrix(!0);break}case Rn.ParticleImpostor:e=new this.BJSCANNON.Particle;break;case Rn.NoImpostor:e=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0))}return e}znt(t,i){let e=t.getVerticesData(he.PositionKind);const s=t.computeWorldMatrix(!0),n=new Array;let r;for(r=0;r<e.length;r+=3)w.TransformCoordinates(w.FromArray(e,r),s).toArray(n,r);e=n;const h=new Array,o=i||~~(Math.sqrt(e.length/3)-1),a=t.getBoundingInfo(),l=Math.min(a.boundingBox.extendSizeWorld.x,a.boundingBox.extendSizeWorld.y),c=a.boundingBox.extendSizeWorld.z,u=2*l/o;for(let t=0;t<e.length;t+=3){const i=Math.round(e[t+0]/u+o/2),s=Math.round(-1*(e[t+1]/u-o/2)),n=-e[t+2]+c;h[i]||(h[i]=[]),h[i][s]||(h[i][s]=n),h[i][s]=Math.max(n,h[i][s])}for(let t=0;t<=o;++t){if(!h[t]){let i=1;for(;!h[(t+i)%o];)i++;h[t]=h[(t+i)%o].slice()}for(let i=0;i<=o;++i)if(!h[t][i]){let e,s=1;for(;void 0===e;)e=h[t][(i+s++)%o];h[t][i]=e}}const f=new this.BJSCANNON.Heightfield(h,{elementSize:u});return f.minY=c,f}knt(t){const i=t.object;if(i.computeWorldMatrix&&i.computeWorldMatrix(!0),!i.getBoundingInfo())return;const e=t.getObjectCenter();this.Nnt.copyFrom(i.getAbsolutePivotPoint().subtract(e)),this.Nnt.divideInPlace(t.object.scaling),this.ynt.copyFrom(e);let s=i.rotationQuaternion;if(s){if(t.type!==Rn.PlaneImpostor&&t.type!==Rn.HeightmapImpostor||(s=s.multiply(this.bnt),t.setDeltaRotation(this._nt)),t.type===Rn.HeightmapImpostor){const t=i;let s=t.getBoundingInfo();const n=t.rotationQuaternion;t.rotationQuaternion=this.Pnt,t.computeWorldMatrix(!0);const r=e.clone();let h=t.getPivotMatrix();h=h?h.clone():R.Identity();const o=R.Translation(s.boundingBox.extendSizeWorld.x,0,-s.boundingBox.extendSizeWorld.z);t.setPreTransformMatrix(o),t.computeWorldMatrix(!0),s=t.getBoundingInfo();const a=s.boundingBox.centerWorld.subtract(e).subtract(t.position).negate();this.ynt.copyFromFloats(a.x,a.y-s.boundingBox.extendSizeWorld.y,a.z),this.Nnt.copyFrom(s.boundingBox.centerWorld.subtract(r)),this.Nnt.y+=s.boundingBox.extendSizeWorld.y,t.rotationQuaternion=n,t.setPreTransformMatrix(h),t.computeWorldMatrix(!0)}else t.type===Rn.MeshImpostor&&this.Nnt.copyFromFloats(0,0,0);t.setDeltaPosition(this.Nnt),t.physicsBody.position.set(this.ynt.x,this.ynt.y,this.ynt.z),t.physicsBody.quaternion.set(s.x,s.y,s.z,s.w)}}setTransformationFromPhysicsBody(t){if(t.object.position.set(t.physicsBody.position.x,t.physicsBody.position.y,t.physicsBody.position.z),t.object.rotationQuaternion){const i=t.physicsBody.quaternion;t.object.rotationQuaternion.set(i.x,i.y,i.z,i.w)}}setPhysicsBodyTransformation(t,i,e){t.physicsBody.position.set(i.x,i.y,i.z),t.physicsBody.quaternion.set(e.x,e.y,e.z,e.w)}isSupported(){return void 0!==this.BJSCANNON}setLinearVelocity(t,i){t.physicsBody.velocity.set(i.x,i.y,i.z)}setAngularVelocity(t,i){t.physicsBody.angularVelocity.set(i.x,i.y,i.z)}getLinearVelocity(t){const i=t.physicsBody.velocity;return i?new w(i.x,i.y,i.z):null}getAngularVelocity(t){const i=t.physicsBody.angularVelocity;return i?new w(i.x,i.y,i.z):null}setBodyMass(t,i){t.physicsBody.mass=i,t.physicsBody.updateMassProperties()}getBodyMass(t){return t.physicsBody.mass}getBodyFriction(t){return t.physicsBody.material.friction}setBodyFriction(t,i){t.physicsBody.material.friction=i}getBodyRestitution(t){return t.physicsBody.material.restitution}setBodyRestitution(t,i){t.physicsBody.material.restitution=i}sleepBody(t){t.physicsBody.sleep()}wakeUpBody(t){t.physicsBody.wakeUp()}updateDistanceJoint(t,i){t.physicsJoint.distance=i}setMotor(t,i,e,s){s||(t.physicsJoint.enableMotor(),t.physicsJoint.setMotorSpeed(i),e&&this.setLimit(t,e))}setLimit(t,i,e){t.physicsJoint.motorEquation.maxForce=e,t.physicsJoint.motorEquation.minForce=void 0===i?-i:i}syncMeshWithImpostor(t,i){const e=i.physicsBody;t.position.x=e.position.x,t.position.y=e.position.y,t.position.z=e.position.z,t.rotationQuaternion&&(t.rotationQuaternion.x=e.quaternion.x,t.rotationQuaternion.y=e.quaternion.y,t.rotationQuaternion.z=e.quaternion.z,t.rotationQuaternion.w=e.quaternion.w)}getRadius(t){return t.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(t,i){const e=t.physicsBody.shapes[0];i.x=2*e.halfExtents.x,i.y=2*e.halfExtents.y,i.z=2*e.halfExtents.z}dispose(){}Dnt(){const t=new this.BJSCANNON.Vec3,i=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(e,s,n){if(n=n||10,0===(s=s||0))this.internalStep(e),this.time+=e;else{let r=Math.floor((this.time+s)/e)-Math.floor(this.time/e);r=Math.min(r,n)||1;const h=performance.now();for(let t=0;t!==r&&(this.internalStep(e),!(performance.now()-h>1e3*e));t++);this.time+=s;const o=this.time%e/e,a=t,l=this.bodies;for(let t=0;t!==l.length;t++){const e=l[t];e.type!==i.Body.STATIC&&e.sleepState!==i.Body.SLEEPING?(e.position.vsub(e.previousPosition,a),a.scale(o,a),e.position.vadd(a,e.interpolatedPosition)):(e.interpolatedPosition.set(e.position.x,e.position.y,e.position.z),e.interpolatedQuaternion.set(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w))}}}}raycast(t,i){return this.Ont.reset(t,i),this.raycastToRef(t,i,this.Ont),this.Ont}raycastToRef(t,i,e){this.Lnt.reset(),this.world.raycastClosest(t,i,{},this.Lnt),e.reset(t,i),this.Lnt.hasHit&&(e.setHitData({x:this.Lnt.hitNormalWorld.x,y:this.Lnt.hitNormalWorld.y,z:this.Lnt.hitNormalWorld.z},{x:this.Lnt.hitPointWorld.x,y:this.Lnt.hitPointWorld.y,z:this.Lnt.hitPointWorld.z}),e.setHitDistance(this.Lnt.distance))}}jE.DefaultPluginFactory=()=>new KE;class qE{constructor(t=!0,i,e=OIMO){this.xnt=t,this.name="OimoJSPlugin",this.Rnt=1/60,this.Hnt=[],this.Xnt=w.Zero(),this.BJSOIMO=e,this.world=new this.BJSOIMO.World({iterations:i}),this.world.clear(),this.Ont=new YE}getPluginVersion(){return 1}setGravity(t){this.world.gravity.set(t.x,t.y,t.z)}setTimeStep(t){this.world.timeStep=t}getTimeStep(){return this.world.timeStep}executeStep(t,i){i.forEach((function(t){t.beforeStep()})),this.world.timeStep=this.xnt?t:this.Rnt,this.world.step(),i.forEach((t=>{t.afterStep(),this.Hnt[t.uniqueId]=t}));let e=this.world.contacts;for(;null!==e;){if(e.touching&&!e.body1.sleeping&&!e.body2.sleeping){e=e.next;continue}const t=this.Hnt[+e.body1.name],i=this.Hnt[+e.body2.name];t&&i?(t.onCollide({body:i.physicsBody,point:null,distance:0,impulse:0,normal:null}),i.onCollide({body:t.physicsBody,point:null,distance:0,impulse:0,normal:null}),e=e.next):e=e.next}}applyImpulse(t,i,e){const s=t.physicsBody.mass;t.physicsBody.applyImpulse(e.scale(this.world.invScale),i.scale(this.world.invScale*s))}applyForce(t,i,e){F.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(t,i,e)}generatePhysicsBody(t){if(t.parent)t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());else{if(t.isBodyInitRequired()){const i={name:t.uniqueId,config:[t.getParam("mass")||.001,t.getParam("friction"),t.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:0!==t.getParam("mass"),density:t.getParam("mass"),friction:t.getParam("friction"),restitution:t.getParam("restitution"),world:this.world},e=[t];(t=>{t.getChildMeshes&&t.getChildMeshes().forEach((function(t){t.physicsImpostor&&e.push(t.physicsImpostor)}))})(t.object);const s=t=>Math.max(t,u),n=new T;e.forEach((e=>{if(!e.object.rotationQuaternion)return;const r=e.object.rotationQuaternion;n.copyFrom(r),e.object.rotationQuaternion.set(0,0,0,1),e.object.computeWorldMatrix(!0);const h=n.toEulerAngles(),o=e.getObjectExtents(),a=57.29577951308232;if(e===t){const e=t.getObjectCenter();t.object.getAbsolutePivotPoint().subtractToRef(e,this.Xnt),this.Xnt.divideInPlace(t.object.scaling),i.pos.push(e.x),i.pos.push(e.y),i.pos.push(e.z),i.posShape.push(0,0,0),i.rotShape.push(0,0,0)}else{const t=e.object.position.clone();i.posShape.push(t.x),i.posShape.push(t.y),i.posShape.push(t.z),i.rotShape.push(h.x*a,h.y*a,h.z*a)}switch(e.object.rotationQuaternion.copyFrom(n),e.type){case Rn.ParticleImpostor:F.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case Rn.SphereImpostor:{const t=o.x,e=o.y,n=o.z,r=Math.max(s(t),s(e),s(n))/2;i.type.push("sphere"),i.size.push(r),i.size.push(r),i.size.push(r);break}case Rn.CylinderImpostor:{const t=s(o.x)/2,e=s(o.y);i.type.push("cylinder"),i.size.push(t),i.size.push(e),i.size.push(e);break}case Rn.PlaneImpostor:case Rn.BoxImpostor:default:{const t=s(o.x),e=s(o.y),n=s(o.z);i.type.push("box"),i.size.push(t),i.size.push(e),i.size.push(n);break}}e.object.rotationQuaternion=r})),t.physicsBody=this.world.add(i),t.physicsBody.resetQuaternion(n),t.physicsBody.updatePosition(0)}else this.Xnt.copyFromFloats(0,0,0);t.setDeltaPosition(this.Xnt)}}removePhysicsBody(t){this.world.removeRigidBody(t.physicsBody)}generateJoint(t){const i=t.mainImpostor.physicsBody,e=t.connectedImpostor.physicsBody;if(!i||!e)return;const s=t.joint.jointData,n=s.nativeParams||{};let r;const h={body1:i,body2:e,axe1:n.axe1||(s.mainAxis?s.mainAxis.asArray():null),axe2:n.axe2||(s.connectedAxis?s.connectedAxis.asArray():null),pos1:n.pos1||(s.mainPivot?s.mainPivot.asArray():null),pos2:n.pos2||(s.connectedPivot?s.connectedPivot.asArray():null),min:n.min,max:n.max,collision:n.collision||s.collision,spring:n.spring,world:this.world};switch(t.joint.type){case Tn.BallAndSocketJoint:r="jointBall";break;case Tn.SpringJoint:{F.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");const t=s;h.min=t.length||h.min,h.max=Math.max(h.min,h.max)}case Tn.DistanceJoint:r="jointDistance",h.max=s.maxDistance;break;case Tn.PrismaticJoint:r="jointPrisme";break;case Tn.SliderJoint:r="jointSlide";break;case Tn.WheelJoint:r="jointWheel";break;case Tn.HingeJoint:default:r="jointHinge"}h.type=r,t.joint.physicsJoint=this.world.add(h)}removeJoint(t){try{this.world.removeJoint(t.joint.physicsJoint)}catch(t){F.Warn(t)}}isSupported(){return void 0!==this.BJSOIMO}setTransformationFromPhysicsBody(t){if(!t.physicsBody.sleeping){if(t.physicsBody.shapes.next){let i=t.physicsBody.shapes;for(;i.next;)i=i.next;t.object.position.set(i.position.x,i.position.y,i.position.z)}else{const i=t.physicsBody.getPosition();t.object.position.set(i.x,i.y,i.z)}if(t.object.rotationQuaternion){const i=t.physicsBody.getQuaternion();t.object.rotationQuaternion.set(i.x,i.y,i.z,i.w)}}}setPhysicsBodyTransformation(t,i,e){const s=t.physicsBody;t.physicsBody.shapes.next||(s.position.set(i.x,i.y,i.z),s.orientation.set(e.x,e.y,e.z,e.w),s.syncShapes(),s.awake())}setLinearVelocity(t,i){t.physicsBody.linearVelocity.set(i.x,i.y,i.z)}setAngularVelocity(t,i){t.physicsBody.angularVelocity.set(i.x,i.y,i.z)}getLinearVelocity(t){const i=t.physicsBody.linearVelocity;return i?new w(i.x,i.y,i.z):null}getAngularVelocity(t){const i=t.physicsBody.angularVelocity;return i?new w(i.x,i.y,i.z):null}setBodyMass(t,i){const e=0===i;t.physicsBody.shapes.density=e?1:i,t.physicsBody.setupMass(e?2:1)}getBodyMass(t){return t.physicsBody.shapes.density}getBodyFriction(t){return t.physicsBody.shapes.friction}setBodyFriction(t,i){t.physicsBody.shapes.friction=i}getBodyRestitution(t){return t.physicsBody.shapes.restitution}setBodyRestitution(t,i){t.physicsBody.shapes.restitution=i}sleepBody(t){t.physicsBody.sleep()}wakeUpBody(t){t.physicsBody.awake()}updateDistanceJoint(t,i,e){t.physicsJoint.limitMotor.upperLimit=i,void 0!==e&&(t.physicsJoint.limitMotor.lowerLimit=e)}setMotor(t,i,e,s){void 0!==e?F.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):e=1e6,i*=-1;const n=s?t.physicsJoint.rotationalLimitMotor2:t.physicsJoint.rotationalLimitMotor1||t.physicsJoint.rotationalLimitMotor||t.physicsJoint.limitMotor;n&&n.setMotor(i,e)}setLimit(t,i,e,s){const n=s?t.physicsJoint.rotationalLimitMotor2:t.physicsJoint.rotationalLimitMotor1||t.physicsJoint.rotationalLimitMotor||t.physicsJoint.limitMotor;n&&n.setLimit(i,void 0===e?-i:e)}syncMeshWithImpostor(t,i){const e=i.physicsBody;t.position.x=e.position.x,t.position.y=e.position.y,t.position.z=e.position.z,t.rotationQuaternion&&(t.rotationQuaternion.x=e.orientation.x,t.rotationQuaternion.y=e.orientation.y,t.rotationQuaternion.z=e.orientation.z,t.rotationQuaternion.w=e.orientation.w)}getRadius(t){return t.physicsBody.shapes.radius}getBoxSizeToRef(t,i){const e=t.physicsBody.shapes;i.x=2*e.halfWidth,i.y=2*e.halfHeight,i.z=2*e.halfDepth}dispose(){this.world.clear()}raycast(t,i){return F.Warn("raycast is not currently supported by the Oimo physics plugin"),this.Ont.reset(t,i),this.Ont}raycastToRef(t,i,e){F.Warn("raycast is not currently supported by the Oimo physics plugin"),e.reset(t,i)}}class QE{constructor(t=!0,i=Ammo,e=null){this.xnt=t,this.bjsAMMO={},this.name="AmmoJSPlugin",this.xw=1/60,this.Rnt=1/60,this.Wnt=5,this.Lk=new T,this.$nt=!1,this.Ynt=new w,this.jnt=new w,this.Knt=new w,this.YH=new R,"function"!=typeof i?(this.bjsAMMO=i,this.isSupported()?(this.qnt=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this.Qnt=new this.bjsAMMO.btCollisionDispatcher(this.qnt),this.Znt=e||new this.bjsAMMO.btDbvtBroadphase,this.Jnt=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this.trt=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this.Qnt,this.Znt,this.Jnt,this.qnt,this.trt),this.irt=new this.bjsAMMO.ConcreteContactResultCallback,this.irt.addSingleResult=t=>{const i=(t=this.bjsAMMO.wrapPointer(t,this.bjsAMMO.btManifoldPoint)).getPositionWorldOnA(),e=t.m_normalWorldOnB;this.Ynt.x=i.x(),this.Ynt.y=i.y(),this.Ynt.z=i.z(),this.jnt.x=e.x(),this.jnt.y=e.y(),this.jnt.z=e.z(),this.ert=t.getAppliedImpulse(),this.srt=t.getDistance(),this.$nt=!0},this.Ont=new YE,this.nrt=new this.bjsAMMO.btTransform,this.nrt.setIdentity(),this.rrt=new this.bjsAMMO.btQuaternion(0,0,0,1),this.hrt=new this.bjsAMMO.btVector3(0,0,0),this.ort=new this.bjsAMMO.btVector3(0,0,0),this.art=new this.bjsAMMO.btVector3(0,0,0),this.lrt=new this.bjsAMMO.btVector3(0,0,0)):F.Error("AmmoJS is not available. Please make sure you included the js file.")):F.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.")}getPluginVersion(){return 1}setGravity(t){this.hrt.setValue(t.x,t.y,t.z),this.world.setGravity(this.hrt),this.world.getWorldInfo().set_m_gravity(this.hrt)}setTimeStep(t){this.xw=t}setFixedTimeStep(t){this.Rnt=t}setMaxSteps(t){this.Wnt=t}getTimeStep(){return this.xw}crt(t){return this.$nt=!1,this.world.contactTest(t.physicsBody,this.irt),this.$nt}urt(t,i){return this.$nt=!1,this.world.contactPairTest(t.physicsBody,i.physicsBody,this.irt),this.$nt}frt(t=1/60,i=10,e=1/60){if(0==i)this.world.stepSimulation(t,0);else for(;i>0&&t>0;)t-e<e?(this.world.stepSimulation(t,0),t=0):(t-=e,this.world.stepSimulation(e,0)),i--}executeStep(t,i){for(const t of i)t.soft||t.beforeStep();this.frt(this.xnt?t:this.xw,this.Wnt,this.Rnt);for(const t of i)if(t.soft?this.drt(t):t.afterStep(),t.VN.length>0&&this.crt(t))for(const i of t.VN)for(const e of i.otherImpostors)(t.physicsBody.isActive()||e.physicsBody.isActive())&&this.urt(t,e)&&(t.onCollide({body:e.physicsBody,point:this.Ynt,distance:this.srt,impulse:this.ert,normal:this.jnt}),e.onCollide({body:t.physicsBody,point:this.Ynt,distance:this.srt,impulse:this.ert,normal:this.jnt}))}drt(t){t.type===Rn.RopeImpostor?this.prt(t):this.mrt(t)}prt(t){const i=t.physicsBody.get_m_nodes(),e=i.size();let s,n,r,h,o;const a=new Array;for(let t=0;t<e;t++)s=i.at(t),n=s.get_m_x(),r=n.x(),h=n.y(),o=n.z(),a.push(new w(r,h,o));const l=t.object,c=t.getParam("shape");t.vrt?t.object=fu("lines",{points:a,instance:l}):t.object=vu("ext",{shape:c,path:a,instance:l})}mrt(t){const i=t.type===Rn.ClothImpostor?1:-1,e=t.object;let s=e.getVerticesData(he.PositionKind);s||(s=[]);let n=e.getVerticesData(he.NormalKind);n||(n=[]);const r=s.length/3,h=t.physicsBody.get_m_nodes();let o,a,l,c,u,f,d,p;for(let t=0;t<r;t++){o=h.at(t),a=o.get_m_x(),l=a.x(),c=a.y(),u=a.z()*i;const e=o.get_m_n();f=e.x(),d=e.y(),p=e.z()*i,s[3*t]=l,s[3*t+1]=c,s[3*t+2]=u,n[3*t]=f,n[3*t+1]=d,n[3*t+2]=p}const m=new os;m.positions=s,m.normals=n,m.uvs=e.getVerticesData(he.UVKind),m.colors=e.getVerticesData(he.ColorKind),e&&e.getIndices&&(m.indices=e.getIndices()),m.applyToMesh(e)}applyImpulse(t,i,e){if(t.soft)F.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();const s=this.hrt,n=this.ort;t.object&&t.object.getWorldMatrix&&e.subtractInPlace(t.object.getWorldMatrix().getTranslation()),s.setValue(e.x,e.y,e.z),n.setValue(i.x,i.y,i.z),t.physicsBody.applyImpulse(n,s)}}applyForce(t,i,e){if(t.soft)F.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();const s=this.hrt,n=this.ort;if(t.object&&t.object.getWorldMatrix){const i=t.object.getWorldMatrix().getTranslation();s.setValue(e.x-i.x,e.y-i.y,e.z-i.z)}else s.setValue(e.x,e.y,e.z);n.setValue(i.x,i.y,i.z),t.physicsBody.applyForce(n,s)}}generatePhysicsBody(t){if(t.ON.toDispose=[],t.parent)t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());else if(t.isBodyInitRequired()){const i=this.Bnt(t),e=t.getParam("mass");if(t.ON.mass=e,t.soft)i.get_m_cfg().set_collisions(17),i.get_m_cfg().set_kDP(t.getParam("damping")),this.bjsAMMO.castObject(i,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(t.getParam("margin")),i.setActivationState(QE.grt),this.world.addSoftBody(i,1,-1),t.physicsBody=i,t.ON.toDispose.push(i),this.setBodyPressure(t,0),t.type===Rn.SoftbodyImpostor&&this.setBodyPressure(t,t.getParam("pressure")),this.setBodyStiffness(t,t.getParam("stiffness")),this.setBodyVelocityIterations(t,t.getParam("velocityIterations")),this.setBodyPositionIterations(t,t.getParam("positionIterations"));else{const s=new this.bjsAMMO.btVector3(0,0,0),n=new this.bjsAMMO.btTransform;t.object.computeWorldMatrix(!0),n.setIdentity(),0!==e&&i.calculateLocalInertia(e,s),this.hrt.setValue(t.object.position.x,t.object.position.y,t.object.position.z),this.rrt.setValue(t.object.rotationQuaternion.x,t.object.rotationQuaternion.y,t.object.rotationQuaternion.z,t.object.rotationQuaternion.w),n.setOrigin(this.hrt),n.setRotation(this.rrt);const r=new this.bjsAMMO.btDefaultMotionState(n),h=new this.bjsAMMO.btRigidBodyConstructionInfo(e,r,i,s),o=new this.bjsAMMO.btRigidBody(h);if(0===e&&(o.setCollisionFlags(o.getCollisionFlags()|QE.Srt),o.setActivationState(QE.grt)),t.type!=Rn.NoImpostor||i.getChildShape||o.setCollisionFlags(o.getCollisionFlags()|QE.Ert),t.type!==Rn.MeshImpostor&&t.type!==Rn.NoImpostor){const i=t.object.getBoundingInfo();this.Knt.copyFrom(t.object.getAbsolutePosition()),this.Knt.subtractInPlace(i.boundingBox.centerWorld),this.Knt.x/=t.object.scaling.x,this.Knt.y/=t.object.scaling.y,this.Knt.z/=t.object.scaling.z,t.setDeltaPosition(this.Knt)}const a=t.getParam("group"),l=t.getParam("mask");a&&l?this.world.addRigidBody(o,a,l):this.world.addRigidBody(o),t.physicsBody=o,t.ON.toDispose=t.ON.toDispose.concat([o,h,r,n,s,i])}this.setBodyRestitution(t,t.getParam("restitution")),this.setBodyFriction(t,t.getParam("friction"))}}removePhysicsBody(t){this.world&&(t.soft?this.world.removeSoftBody(t.physicsBody):this.world.removeRigidBody(t.physicsBody),t.ON&&(t.ON.toDispose.forEach((t=>{this.bjsAMMO.destroy(t)})),t.ON.toDispose=[]))}generateJoint(t){const i=t.mainImpostor.physicsBody,e=t.connectedImpostor.physicsBody;if(!i||!e)return;const s=t.joint.jointData;let n;switch(s.mainPivot||(s.mainPivot=new w(0,0,0)),s.connectedPivot||(s.connectedPivot=new w(0,0,0)),t.joint.type){case Tn.DistanceJoint:{const t=s.maxDistance;t&&(s.mainPivot=new w(0,-t/2,0),s.connectedPivot=new w(0,t/2,0)),n=new this.bjsAMMO.btPoint2PointConstraint(i,e,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z));break}case Tn.HingeJoint:{s.mainAxis||(s.mainAxis=new w(0,0,0)),s.connectedAxis||(s.connectedAxis=new w(0,0,0));const t=new this.bjsAMMO.btVector3(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z),r=new this.bjsAMMO.btVector3(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z);n=new this.bjsAMMO.btHingeConstraint(i,e,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),t,r);break}case Tn.BallAndSocketJoint:n=new this.bjsAMMO.btPoint2PointConstraint(i,e,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z));break;default:F.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),n=new this.bjsAMMO.btPoint2PointConstraint(i,e,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z))}this.world.addConstraint(n,!t.joint.jointData.collision),t.joint.physicsJoint=n}removeJoint(t){this.world&&this.world.removeConstraint(t.joint.physicsJoint)}Art(t,i,e){let s=0;if(e&&e.getIndices&&e.getWorldMatrix&&e.getChildMeshes){let n=e.getIndices();n||(n=[]);let r,h=e.getVerticesData(he.PositionKind);if(h||(h=[]),i&&i!==e){let t;t=i.rotationQuaternion?i.rotationQuaternion:i.rotation?T.FromEulerAngles(i.rotation.x,i.rotation.y,i.rotation.z):T.Identity();R.Compose(w.One(),t,i.position).invertToRef(this.YH);r=e.computeWorldMatrix(!1).multiply(this.YH)}else R.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,this.YH),r=this.YH;const o=n.length/3;for(let i=0;i<o;i++){const e=[];for(let t=0;t<3;t++){let s,o=new w(h[3*n[3*i+t]+0],h[3*n[3*i+t]+1],h[3*n[3*i+t]+2]);o=w.TransformCoordinates(o,r),s=0==t?this.hrt:1==t?this.ort:this.art,s.setValue(o.x,o.y,o.z),e.push(s)}t.addTriangle(e[0],e[1],e[2]),s++}e.getChildMeshes().forEach((e=>{s+=this.Art(t,i,e)}))}return s}Crt(t){const i=t.object;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let t=i.getIndices();t||(t=[]);let e=i.getVerticesData(he.PositionKind);e||(e=[]);let s=i.getVerticesData(he.NormalKind);s||(s=[]),i.computeWorldMatrix(!1);const n=[],r=[];for(let t=0;t<e.length;t+=3){let h=new w(e[t],e[t+1],e[t+2]),o=new w(s[t],s[t+1],s[t+2]);h=w.TransformCoordinates(h,i.getWorldMatrix()),o=w.TransformNormal(o,i.getWorldMatrix()),n.push(h.x,h.y,h.z),r.push(o.x,o.y,o.z)}const h=new os;return h.positions=n,h.normals=r,h.uvs=i.getVerticesData(he.UVKind),h.colors=i.getVerticesData(he.ColorKind),i&&i.getIndices&&(h.indices=i.getIndices()),h.applyToMesh(i),i.position=w.Zero(),i.rotationQuaternion=null,i.rotation=w.Zero(),i.computeWorldMatrix(!0),h}return os.ExtractFromMesh(i)}wrt(t){const i=t.object;if(i&&i.getIndices){let e=i.getIndices();e||(e=[]);const s=this.Crt(t),n=s.positions,r=s.normals;if(null===n||null===r)return new this.bjsAMMO.btCompoundShape;{const t=[],s=[];for(let i=0;i<n.length;i+=3){const e=new w(n[i],n[i+1],n[i+2]),h=new w(r[i],r[i+1],r[i+2]);t.push(e.x,e.y,-e.z),s.push(h.x,h.y,-h.z)}const h=(new this.bjsAMMO.btSoftBodyHelpers).CreateFromTriMesh(this.world.getWorldInfo(),t,i.getIndices(),e.length/3,!0),o=n.length/3,a=h.get_m_nodes();let l,c;for(let t=0;t<o;t++)l=a.at(t),c=l.get_m_n(),c.setX(s[3*t]),c.setY(s[3*t+1]),c.setZ(s[3*t+2]);return h}}}xrt(t){const i=t.object;if(i&&i.getIndices){let e=i.getIndices();e||(e=[]);const s=this.Crt(t),n=s.positions,r=s.normals;if(null===n||null===r)return new this.bjsAMMO.btCompoundShape;{const i=n.length,e=Math.sqrt(i/3);t.segments=e;const s=e-1;this.hrt.setValue(n[0],n[1],n[2]),this.ort.setValue(n[3*s],n[3*s+1],n[3*s+2]),this.lrt.setValue(n[i-3],n[i-2],n[i-1]),this.art.setValue(n[i-3-3*s],n[i-2-3*s],n[i-1-3*s]);return(new this.bjsAMMO.btSoftBodyHelpers).CreatePatch(this.world.getWorldInfo(),this.hrt,this.ort,this.art,this.lrt,e,e,t.getParam("fixedPoints"),!0)}}}Trt(t){let i,e;const s=this.Crt(t),n=s.positions,r=s.normals;if(null===n||null===r)return new this.bjsAMMO.btCompoundShape;s.applyToMesh(t.object,!0),t.vrt=!0;if(0===r.map((t=>t*t)).reduce(((t,i)=>t+i)))i=n.length,e=i/3-1,this.hrt.setValue(n[0],n[1],n[2]),this.ort.setValue(n[i-3],n[i-2],n[i-1]);else{t.vrt=!1;const s=t.getParam("path");if(null===t.getParam("shape"))return F.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;i=s.length,e=i-1,this.hrt.setValue(s[0].x,s[0].y,s[0].z),this.ort.setValue(s[i-1].x,s[i-1].y,s[i-1].z)}t.segments=e;let h=t.getParam("fixedPoints");h=h>3?3:h;const o=(new this.bjsAMMO.btSoftBodyHelpers).CreateRope(this.world.getWorldInfo(),this.hrt,this.ort,e-1,h);return o.get_m_cfg().set_collisions(17),o}Rrt(t){let i=null;return this.onCreateCustomShape&&(i=this.onCreateCustomShape(t)),null==i&&(i=new this.bjsAMMO.btCompoundShape),i}Irt(t,i,e){let s=0;if(e&&e.getIndices&&e.getWorldMatrix&&e.getChildMeshes){let n=e.getIndices();n||(n=[]);let r=e.getVerticesData(he.PositionKind);r||(r=[]),e.computeWorldMatrix(!1);const h=n.length/3;for(let i=0;i<h;i++){const h=[];for(let t=0;t<3;t++){let s,o=new w(r[3*n[3*i+t]+0],r[3*n[3*i+t]+1],r[3*n[3*i+t]+2]);R.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,this.YH),o=w.TransformCoordinates(o,this.YH),s=0==t?this.hrt:1==t?this.ort:this.art,s.setValue(o.x,o.y,o.z),h.push(s)}t.addPoint(h[0],!0),t.addPoint(h[1],!0),t.addPoint(h[2],!0),s++}e.getChildMeshes().forEach((e=>{s+=this.Irt(t,i,e)}))}return s}Bnt(t,i=!1){const e=t.object;let s;const n=t.getObjectExtents();if(!i){const i=t.object.getChildMeshes?t.object.getChildMeshes(!0):[];s=new this.bjsAMMO.btCompoundShape;let e=0;if(i.forEach((t=>{const i=t.getPhysicsImpostor();if(i){if(i.type==Rn.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";const n=this.Bnt(i),r=t.parent.getWorldMatrix().clone(),h=new w;r.decompose(h),this.nrt.getOrigin().setValue(t.position.x*h.x,t.position.y*h.y,t.position.z*h.z),this.rrt.setValue(t.rotationQuaternion.x,t.rotationQuaternion.y,t.rotationQuaternion.z,t.rotationQuaternion.w),this.nrt.setRotation(this.rrt),s.addChildShape(this.nrt,n),i.dispose(),e++}})),e>0){if(t.type!=Rn.NoImpostor){const i=this.Bnt(t,!0);i&&(this.nrt.getOrigin().setValue(0,0,0),this.rrt.setValue(0,0,0,1),this.nrt.setRotation(this.rrt),s.addChildShape(this.nrt,i))}return s}this.bjsAMMO.destroy(s),s=null}switch(t.type){case Rn.SphereImpostor:if(o.WithinEpsilon(n.x,n.y,1e-4)&&o.WithinEpsilon(n.x,n.z,1e-4))s=new this.bjsAMMO.btSphereShape(n.x/2);else{const t=[new this.bjsAMMO.btVector3(0,0,0)],i=[1];s=new this.bjsAMMO.btMultiSphereShape(t,i,1),s.setLocalScaling(new this.bjsAMMO.btVector3(n.x/2,n.y/2,n.z/2))}break;case Rn.CapsuleImpostor:{const t=n.x/2;s=new this.bjsAMMO.btCapsuleShape(t,n.y-2*t)}break;case Rn.CylinderImpostor:this.hrt.setValue(n.x/2,n.y/2,n.z/2),s=new this.bjsAMMO.btCylinderShape(this.hrt);break;case Rn.PlaneImpostor:case Rn.BoxImpostor:this.hrt.setValue(n.x/2,n.y/2,n.z/2),s=new this.bjsAMMO.btBoxShape(this.hrt);break;case Rn.MeshImpostor:if(0==t.getParam("mass")){if(this.onCreateCustomMeshImpostor)s=this.onCreateCustomMeshImpostor(t);else{const i=new this.bjsAMMO.btTriangleMesh;t.ON.toDispose.push(i);const n=this.Art(i,e,e);s=0==n?new this.bjsAMMO.btCompoundShape:new this.bjsAMMO.btBvhTriangleMeshShape(i)}break}case Rn.ConvexHullImpostor:if(this.onCreateCustomConvexHullImpostor)s=this.onCreateCustomConvexHullImpostor(t);else{const i=new this.bjsAMMO.btConvexHullShape;0==this.Irt(i,e,e)?(t.ON.toDispose.push(i),s=new this.bjsAMMO.btCompoundShape):s=i}break;case Rn.NoImpostor:s=new this.bjsAMMO.btSphereShape(n.x/2);break;case Rn.CustomImpostor:s=this.Rrt(t);break;case Rn.SoftbodyImpostor:s=this.wrt(t);break;case Rn.ClothImpostor:s=this.xrt(t);break;case Rn.RopeImpostor:s=this.Trt(t);break;default:F.Warn("The impostor type is not currently supported by the ammo plugin.")}return s}setTransformationFromPhysicsBody(t){t.physicsBody.getMotionState().getWorldTransform(this.nrt),t.object.position.set(this.nrt.getOrigin().x(),this.nrt.getOrigin().y(),this.nrt.getOrigin().z()),t.object.rotationQuaternion?t.object.rotationQuaternion.set(this.nrt.getRotation().x(),this.nrt.getRotation().y(),this.nrt.getRotation().z(),this.nrt.getRotation().w()):t.object.rotation&&(this.Lk.set(this.nrt.getRotation().x(),this.nrt.getRotation().y(),this.nrt.getRotation().z(),this.nrt.getRotation().w()),this.Lk.toEulerAnglesToRef(t.object.rotation))}setPhysicsBodyTransformation(t,i,e){const s=t.physicsBody.getWorldTransform();if(Math.abs(s.getOrigin().x()-i.x)>u||Math.abs(s.getOrigin().y()-i.y)>u||Math.abs(s.getOrigin().z()-i.z)>u||Math.abs(s.getRotation().x()-e.x)>u||Math.abs(s.getRotation().y()-e.y)>u||Math.abs(s.getRotation().z()-e.z)>u||Math.abs(s.getRotation().w()-e.w)>u)if(this.hrt.setValue(i.x,i.y,i.z),s.setOrigin(this.hrt),this.rrt.setValue(e.x,e.y,e.z,e.w),s.setRotation(this.rrt),t.physicsBody.setWorldTransform(s),0==t.mass){const i=t.physicsBody.getMotionState();i&&i.setWorldTransform(s)}else t.physicsBody.activate()}isSupported(){return void 0!==this.bjsAMMO}setLinearVelocity(t,i){this.hrt.setValue(i.x,i.y,i.z),t.soft?t.physicsBody.linearVelocity(this.hrt):t.physicsBody.setLinearVelocity(this.hrt)}setAngularVelocity(t,i){this.hrt.setValue(i.x,i.y,i.z),t.soft?t.physicsBody.angularVelocity(this.hrt):t.physicsBody.setAngularVelocity(this.hrt)}getLinearVelocity(t){let i;if(i=t.soft?t.physicsBody.linearVelocity():t.physicsBody.getLinearVelocity(),!i)return null;const e=new w(i.x(),i.y(),i.z());return this.bjsAMMO.destroy(i),e}getAngularVelocity(t){let i;if(i=t.soft?t.physicsBody.angularVelocity():t.physicsBody.getAngularVelocity(),!i)return null;const e=new w(i.x(),i.y(),i.z());return this.bjsAMMO.destroy(i),e}setBodyMass(t,i){t.soft?t.physicsBody.setTotalMass(i,!1):t.physicsBody.setMassProps(i),t.ON.mass=i}getBodyMass(t){return t.ON.mass||0}getBodyFriction(t){return t.ON.friction||0}setBodyFriction(t,i){t.soft?t.physicsBody.get_m_cfg().set_kDF(i):t.physicsBody.setFriction(i),t.ON.friction=i}getBodyRestitution(t){return t.ON.restitution||0}setBodyRestitution(t,i){t.physicsBody.setRestitution(i),t.ON.restitution=i}getBodyPressure(t){return t.soft?t.ON.pressure||0:(F.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(t,i){t.soft?t.type===Rn.SoftbodyImpostor?(t.physicsBody.get_m_cfg().set_kPR(i),t.ON.pressure=i):(t.physicsBody.get_m_cfg().set_kPR(0),t.ON.pressure=0):F.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(t){return t.soft?t.ON.stiffness||0:(F.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(t,i){t.soft?(i=(i=i<0?0:i)>1?1:i,t.physicsBody.get_m_materials().at(0).set_m_kLST(i),t.ON.stiffness=i):F.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(t){return t.soft?t.ON.velocityIterations||0:(F.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(t,i){t.soft?(i=i<0?0:i,t.physicsBody.get_m_cfg().set_viterations(i),t.ON.velocityIterations=i):F.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(t){return t.soft?t.ON.positionIterations||0:(F.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(t,i){t.soft?(i=i<0?0:i,t.physicsBody.get_m_cfg().set_piterations(i),t.ON.positionIterations=i):F.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(t,i,e,s,n=1,r=!1){const h=t.segments,o=Math.round((h-1)*e)+h*(h-1-Math.round((h-1)*s));t.physicsBody.appendAnchor(o,i.physicsBody,r,n)}appendHook(t,i,e,s=1,n=!1){const r=Math.round(t.segments*e);t.physicsBody.appendAnchor(r,i.physicsBody,n,s)}sleepBody(t){t.physicsBody.forceActivationState(0)}wakeUpBody(t){t.physicsBody.activate()}updateDistanceJoint(){F.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(t,i,e){t.physicsJoint.enableAngularMotor(!0,i,e)}setLimit(){F.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(t,i){i.physicsBody.getMotionState().getWorldTransform(this.nrt),t.position.x=this.nrt.getOrigin().x(),t.position.y=this.nrt.getOrigin().y(),t.position.z=this.nrt.getOrigin().z(),t.rotationQuaternion&&(t.rotationQuaternion.x=this.nrt.getRotation().x(),t.rotationQuaternion.y=this.nrt.getRotation().y(),t.rotationQuaternion.z=this.nrt.getRotation().z(),t.rotationQuaternion.w=this.nrt.getRotation().w())}getRadius(t){return t.getObjectExtents().x/2}getBoxSizeToRef(t,i){const e=t.getObjectExtents();i.x=e.x,i.y=e.y,i.z=e.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this.Jnt),this.bjsAMMO.destroy(this.Znt),this.bjsAMMO.destroy(this.Qnt),this.bjsAMMO.destroy(this.qnt),this.bjsAMMO.destroy(this.hrt),this.bjsAMMO.destroy(this.ort),this.bjsAMMO.destroy(this.art),this.bjsAMMO.destroy(this.nrt),this.bjsAMMO.destroy(this.rrt),this.bjsAMMO.destroy(this.irt),this.world=null}raycast(t,i){return this.raycastToRef(t,i,this.Ont),this.Ont}raycastToRef(t,i,e){this.Mrt=new this.bjsAMMO.btVector3(t.x,t.y,t.z),this.brt=new this.bjsAMMO.btVector3(i.x,i.y,i.z);const s=new this.bjsAMMO.ClosestRayResultCallback(this.Mrt,this.brt);this.world.rayTest(this.Mrt,this.brt,s),e.reset(t,i),s.hasHit()&&(e.setHitData({x:s.get_m_hitNormalWorld().x(),y:s.get_m_hitNormalWorld().y(),z:s.get_m_hitNormalWorld().z()},{x:s.get_m_hitPointWorld().x(),y:s.get_m_hitPointWorld().y(),z:s.get_m_hitPointWorld().z()}),e.calculateHitDistance()),this.bjsAMMO.destroy(s),this.bjsAMMO.destroy(this.Mrt),this.bjsAMMO.destroy(this.brt)}}QE.Ert=4,QE.Srt=2,QE.grt=4,e.prototype.removeReflectionProbe=function(t){if(!this.reflectionProbes)return-1;const i=this.reflectionProbes.indexOf(t);return-1!==i&&this.reflectionProbes.splice(i,1),i},e.prototype.addReflectionProbe=function(t){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(t)};class ZE{constructor(t,i,e,s=!0,n=!1,r=!1){if(this.name=t,this.Bg=R.Identity(),this.Pt=w.Zero(),this._rt=w.Zero(),this.yrt=!1,this.position=w.Zero(),this.metadata=null,this.Si=null,this.Kt=e,e.getEngine().supportsUniformBuffers){this.oet=[];for(let i=0;i<6;++i)this.oet.push(e.createSceneUniformBuffer(`Scene for Reflection Probe (name "${t}") face #${i}`))}this.Kt.reflectionProbes||(this.Kt.reflectionProbes=new Array),this.Kt.reflectionProbes.push(this);let h=0;if(n){const t=this.Kt.getEngine().getCaps();t.textureHalfFloatRender?h=2:t.textureFloatRender&&(h=1)}this.Nrt=new br(t,i,e,s,!0,h,!0),this.Nrt.gammaSpace=!r;const o=e.getEngine().useReverseDepthBuffer;let a;this.Nrt.onBeforeRenderObservable.add((t=>{switch(this.oet&&(e.setSceneUniformBuffer(this.oet[t]),e.getSceneUniformBuffer().unbindEffect()),t){case 0:this._rt.copyFromFloats(1,0,0);break;case 1:this._rt.copyFromFloats(-1,0,0);break;case 2:this._rt.copyFromFloats(0,this.yrt?1:-1,0);break;case 3:this._rt.copyFromFloats(0,this.yrt?-1:1,0);break;case 4:this._rt.copyFromFloats(0,0,e.useRightHandedSystem?-1:1);break;case 5:this._rt.copyFromFloats(0,0,e.useRightHandedSystem?1:-1)}this.PK&&this.position.copyFrom(this.PK.getAbsolutePosition()),this.position.addToRef(this._rt,this.Pt);const i=e.useRightHandedSystem?R.LookAtRHToRef:R.LookAtLHToRef,s=e.useRightHandedSystem?R.PerspectiveFovRH:R.PerspectiveFovLH;i(this.position,this.Pt,w.Up(),this.Bg),e.activeCamera&&(this.Ug=s(Math.PI/2,1,o?e.activeCamera.maxZ:e.activeCamera.minZ,o?e.activeCamera.minZ:e.activeCamera.maxZ,this.Kt.getEngine().isNDCHalfZRange),e.setTransformMatrix(this.Bg,this.Ug),e.activeCamera.isRigCamera&&!this.Nrt.activeCamera&&(this.Nrt.activeCamera=e.activeCamera.rigParent||null)),e.Eg=this.position})),this.Nrt.onBeforeBindObservable.add((()=>{var i,s;this.A5=e.getSceneUniformBuffer(),null===(s=(i=e.getEngine()).NO)||void 0===s||s.call(i,`reflection probe generation for ${t}`,1),a=this.Kt.imageProcessingConfiguration.applyByPostProcess,r&&(e.imageProcessingConfiguration.applyByPostProcess=!0)})),this.Nrt.onAfterUnbindObservable.add((()=>{var t,i;e.imageProcessingConfiguration.applyByPostProcess=a,e.Eg=null,this.oet&&e.setSceneUniformBuffer(this.A5),e.updateTransformMatrix(!0),null===(i=(t=e.getEngine()).PO)||void 0===i||i.call(t,1)}))}get samples(){return this.Nrt.samples}set samples(t){this.Nrt.samples=t}get refreshRate(){return this.Nrt.refreshRate}set refreshRate(t){this.Nrt.refreshRate=t}getScene(){return this.Kt}get cubeTexture(){return this.Nrt}get renderList(){return this.Nrt.renderList}attachToMesh(t){this.PK=t}setRenderingAutoClearDepthStencil(t,i){this.Nrt.setRenderingAutoClearDepthStencil(t,i)}dispose(){const t=this.Kt.reflectionProbes.indexOf(this);if(-1!==t&&this.Kt.reflectionProbes.splice(t,1),this.Si){const t=this.Si.reflectionProbes.indexOf(this);t>-1&&this.Si.reflectionProbes.splice(t,1),this.Si=null}if(this.Nrt&&(this.Nrt.dispose(),this.Nrt=null),this.oet){for(const t of this.oet)t.dispose();this.oet=[]}}toString(t){let i="Name: "+this.name;return t&&(i+=", position: "+this.position.toString(),this.PK&&(i+=", attached mesh: "+this.PK.name)),i}getClassName(){return"ReflectionProbe"}serialize(){const t=ot.Serialize(this,this.Nrt.serialize());return t.isReflectionProbe=!0,t.metadata=this.metadata,t}static Parse(t,i,e){let s=null;if(i.reflectionProbes)for(let e=0;e<i.reflectionProbes.length;e++){const n=i.reflectionProbes[e];if(n.name===t.name){s=n;break}}return s=ot.Parse((()=>s||new ZE(t.name,t.renderTargetSize,i,t.uO)),t,i,e),s.cubeTexture.U_=t.renderList,t.PK&&s.attachToMesh(i.getMeshById(t.PK)),t.metadata&&(s.metadata=t.metadata),s}}ut([st()],ZE.prototype,"_attachedMesh",void 0),ut([et()],ZE.prototype,"position",void 0);class JE{}JE.LoaderInjectedPhysicsEngine=void 0;let tA={},iA={};const eA=(t,i,e,s)=>{if(!i.materials)return null;for(let n=0,r=i.materials.length;n<r;n++){const r=i.materials[n];if(t(r))return{parsedMaterial:r,material:Vs.Parse(r,e,s)}}return null},sA=(t,i,e)=>{for(const s in i)if(t.name===i[s])return e.push(t.id),!0;return void 0!==t.parentId&&-1!==e.indexOf(t.parentId)&&(e.push(t.id),!0)},nA=(t,i)=>t+" of "+(i?i.file+" from "+i.name+" version: "+i.version+", exporter version: "+i.exporter_version:"unknown"),rA=(t,i)=>{const e=i;if(i.OT.lods){if(i.OT.lods.ids&&i.OT.lods.ids.length>0){const s=i.OT.lods.ids,n=e.isEnabled(!1);if(i.OT.lods.distances){const r=i.OT.lods.distances;if(r.length>=s.length){const i=r.length>s.length?r[r.length-1]:0;e.setEnabled(!1);for(let i=0;i<s.length;i++){const n=s[i],h=t.getMeshById(n);null!=h&&e.addLODLevel(r[i],h)}i>0&&e.addLODLevel(i,null),!0===n&&e.setEnabled(!0)}else ki.Warn("Invalid level of detail distances for "+i.name)}}i.OT.lods=null}},hA=(t,i,e)=>{if("number"!=typeof t){const s=e.getLastEntryById(t);if(s&&null!=i){return s.instances[parseInt(i)]}return s}const s=tA[t];if(s&&null!=i){return s.instances[parseInt(i)]}return s},oA=(t,i)=>"number"!=typeof t?i.getLastMaterialById(t,!0):iA[t],aA=(t,i,s,n,r=!1)=>{const h=new qs(t);let o="importScene has failed JSON parse";try{var a=JSON.parse(i);o="";const n=On.loggingLevel===On.DETAILED_LOGGING;let l,c;if(void 0!==a.environmentTexture&&null!==a.environmentTexture){const i=void 0===a.isPBR||a.isPBR;if(a.environmentTextureType&&"BABYLON.HDRCubeTexture"===a.environmentTextureType){const e=a.environmentTextureSize?a.environmentTextureSize:128,n=new HE((a.environmentTexture.match(/https?:\/\//g)?"":s)+a.environmentTexture,t,e,!0,!i,void 0,a.environmentTexturePrefilterOnLoad);a.environmentTextureRotationY&&(n.rotationY=a.environmentTextureRotationY),t.environmentTexture=n}else if("object"==typeof a.environmentTexture){const i=Rm.Parse(a.environmentTexture,t,s);t.environmentTexture=i}else if(a.environmentTexture.endsWith(".env")){const i=new Rm((a.environmentTexture.match(/https?:\/\//g)?"":s)+a.environmentTexture,t,a.environmentTextureForcedExtension);a.environmentTextureRotationY&&(i.rotationY=a.environmentTextureRotationY),t.environmentTexture=i}else{const i=Rm.CreateFromPrefilteredData((a.environmentTexture.match(/https?:\/\//g)?"":s)+a.environmentTexture,t,a.environmentTextureForcedExtension);a.environmentTextureRotationY&&(i.rotationY=a.environmentTextureRotationY),t.environmentTexture=i}if(!0===a.createDefaultSkybox){const e=void 0!==t.activeCamera&&null!==t.activeCamera?(t.activeCamera.maxZ-t.activeCamera.minZ)/2:1e3,s=a.skyboxBlurLevel||0;t.createDefaultSkybox(t.environmentTexture,i,e,s)}h.environmentTexture=t.environmentTexture}if(void 0!==a.environmentIntensity&&null!==a.environmentIntensity&&(t.environmentIntensity=a.environmentIntensity),void 0!==a.lights&&null!==a.lights)for(l=0,c=a.lights.length;l<c;l++){const i=a.lights[l],e=No.Parse(i,t);e&&(tA[i.uniqueId]=e,h.lights.push(e),e.Si=h,o+=0===l?"\n\tLights:":"",o+="\n\t\t"+e.toString(n))}if(void 0!==a.reflectionProbes&&null!==a.reflectionProbes)for(l=0,c=a.reflectionProbes.length;l<c;l++){const i=a.reflectionProbes[l],e=ZE.Parse(i,t,s);e&&(h.reflectionProbes.push(e),e.Si=h,o+=0===l?"\n\tReflection Probes:":"",o+="\n\t\t"+e.toString(n))}if(void 0!==a.animations&&null!==a.animations)for(l=0,c=a.animations.length;l<c;l++){const i=a.animations[l],e=g("BABYLON.Animation");if(e){const s=e.Parse(i);t.animations.push(s),h.animations.push(s),o+=0===l?"\n\tAnimations:":"",o+="\n\t\t"+s.toString(n)}}if(void 0!==a.materials&&null!==a.materials)for(l=0,c=a.materials.length;l<c;l++){const i=a.materials[l],e=Vs.Parse(i,t,s);if(e){iA[i.uniqueId||i.id]=e,h.materials.push(e),e.Si=h,o+=0===l?"\n\tMaterials:":"",o+="\n\t\t"+e.toString(n);e.getActiveTextures().forEach((t=>{-1==h.textures.indexOf(t)&&(h.textures.push(t),t.Si=h)}))}}if(void 0!==a.multiMaterials&&null!==a.multiMaterials)for(l=0,c=a.multiMaterials.length;l<c;l++){const i=a.multiMaterials[l],e=ks.ParseMultiMaterial(i,t);iA[i.uniqueId||i.id]=e,h.multiMaterials.push(e),e.Si=h,o+=0===l?"\n\tMultiMaterials:":"",o+="\n\t\t"+e.toString(n);e.getActiveTextures().forEach((t=>{-1==h.textures.indexOf(t)&&(h.textures.push(t),t.Si=h)}))}if(void 0!==a.morphTargetManagers&&null!==a.morphTargetManagers)for(const i of a.morphTargetManagers){const e=$E.Parse(i,t);h.morphTargetManagers.push(e),e.Si=h}if(void 0!==a.skeletons&&null!==a.skeletons)for(l=0,c=a.skeletons.length;l<c;l++){const i=a.skeletons[l],e=Qr.Parse(i,t);h.skeletons.push(e),e.Si=h,o+=0===l?"\n\tSkeletons:":"",o+="\n\t\t"+e.toString(n)}const u=a.geometries;if(null!=u){const i=new Array,e=u.vertexData;if(null!=e)for(l=0,c=e.length;l<c;l++){const n=e[l];i.push(Cs.Parse(n,t,s))}i.forEach((t=>{t&&(h.geometries.push(t),t.Si=h)}))}if(void 0!==a.transformNodes&&null!==a.transformNodes)for(l=0,c=a.transformNodes.length;l<c;l++){const i=a.transformNodes[l],e=Is.Parse(i,t,s);tA[i.uniqueId]=e,h.transformNodes.push(e),e.Si=h}if(void 0!==a.meshes&&null!==a.meshes)for(l=0,c=a.meshes.length;l<c;l++){const i=a.meshes[l],e=Ys.Parse(i,t,s);if(tA[i.uniqueId]=e,h.meshes.push(e),e.Si=h,e.hasInstances)for(const t of e.instances)h.meshes.push(t),t.Si=h;o+=0===l?"\n\tMeshes:":"",o+="\n\t\t"+e.toString(n)}if(void 0!==a.cameras&&null!==a.cameras)for(l=0,c=a.cameras.length;l<c;l++){const i=a.cameras[l],e=hs.Parse(i,t);tA[i.uniqueId]=e,h.cameras.push(e),e.Si=h,o+=0===l?"\n\tCameras:":"",o+="\n\t\t"+e.toString(n)}if(void 0!==a.postProcesses&&null!==a.postProcesses)for(l=0,c=a.postProcesses.length;l<c;l++){const i=a.postProcesses[l],e=nr.Parse(i,t,s);e&&(h.postProcesses.push(e),e.Si=h,o+=0===l?"\nPostprocesses:":"",o+="\n\t\t"+e.toString())}if(void 0!==a.animationGroups&&null!==a.animationGroups)for(l=0,c=a.animationGroups.length;l<c;l++){const i=a.animationGroups[l],e=ts.Parse(i,t);h.animationGroups.push(e),e.Si=h,o+=0===l?"\n\tAnimationGroups:":"",o+="\n\t\t"+e.toString(n)}for(l=0,c=t.cameras.length;l<c;l++){const i=t.cameras[l];null!==i.xi&&(i.parent=hA(i.xi,i.Ti,t),i.xi=null,i.Ti=null)}for(l=0,c=t.lights.length;l<c;l++){const i=t.lights[l];i&&null!==i.xi&&(i.parent=hA(i.xi,i.Ti,t),i.xi=null,i.Ti=null)}for(l=0,c=t.transformNodes.length;l<c;l++){const i=t.transformNodes[l];null!==i.xi&&(i.parent=hA(i.xi,i.Ti,t),i.xi=null,i.Ti=null)}for(l=0,c=t.meshes.length;l<c;l++){const i=t.meshes[l];null!==i.xi&&(i.parent=hA(i.xi,i.Ti,t),i.xi=null,i.Ti=null),i.OT.lods&&rA(t,i)}for(t.multiMaterials.forEach((i=>{i.gI.forEach((e=>{i.subMaterials.push(oA(e,t))})),i.gI=[]})),t.meshes.forEach((i=>{null!==i._T&&(i.material=oA(i._T,t),i._T=null)})),l=0,c=t.skeletons.length;l<c;l++){const i=t.skeletons[l];i.VB&&(null!=i.bones&&i.bones.forEach((i=>{if(i.jS){const e=t.getLastEntryById(i.jS);e&&i.linkTransformNode(e),i.jS=null}})),i.VB=null)}for(l=0,c=t.meshes.length;l<c;l++){const i=t.meshes[l];i.OT.freezeWorldMatrix?(i.freezeWorldMatrix(),i.OT.freezeWorldMatrix=null):i.computeWorldMatrix(!0)}for(l=0,c=t.lights.length;l<c;l++){const i=t.lights[l];if(i.cH.length>0){for(let e=0;e<i.cH.length;e++){const s=t.getMeshById(i.cH[e]);s&&i.excludedMeshes.push(s)}i.cH=[]}if(i.uH.length>0){for(let e=0;e<i.uH.length;e++){const s=t.getMeshById(i.uH[e]);s&&i.includedOnlyMeshes.push(s)}i.uH=[]}}for(t.geometries.forEach((t=>{t.hw=""})),e.Parse(a,t,h,s),l=0,c=t.meshes.length;l<c;l++){const i=t.meshes[l];i.OT.actions&&(G.Parse(i.OT.actions,i,t),i.OT.actions=null)}void 0!==a.actions&&null!==a.actions&&G.Parse(a.actions,null,t)}catch(t){const i=nA("loadAssets",a?a.producer:"Unknown")+o;if(!n)throw F.Log(i),t;n(i,t)}finally{tA={},iA={},r||h.removeAllFromScene(),null!==o&&On.loggingLevel!==On.NO_LOGGING&&F.Log(nA("loadAssets",a?a.producer:"Unknown")+(On.loggingLevel!==On.MINIMAL_LOGGING?o:""))}return h};On.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:t=>-1!==t.indexOf("babylon"),importMesh:(t,i,s,n,r,h,o,a)=>{var l;let c="importMesh has failed JSON parse";try{var u=JSON.parse(s);c="";const a=On.loggingLevel===On.DETAILED_LOGGING;t?Array.isArray(t)||(t=[t]):t=null;const f=new Array,d=new Map,p=[];if(void 0!==u.transformNodes&&null!==u.transformNodes)for(let t=0,e=u.transformNodes.length;t<e;t++){const e=u.transformNodes[t],s=Is.Parse(e,i,n);p.push(s),d.set(s.Ri,s),s.Ri=null}if(void 0!==u.meshes&&null!==u.meshes){const e=[],s=[],h=[],m=[];for(let l=0,p=u.meshes.length;l<p;l++){const p=u.meshes[l];if(null===t||sA(p,t,f)){if(null!==t&&delete t[t.indexOf(p.name)],void 0!==p.geometryId&&null!==p.geometryId&&void 0!==u.geometries&&null!==u.geometries){let t=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach((e=>{!0!==t&&u.geometries[e]&&Array.isArray(u.geometries[e])&&u.geometries[e].forEach((s=>{if(s.id===p.geometryId){if("vertexData"===e)Cs.Parse(s,i,n);t=!0}}))})),!1===t&&F.Warn("Geometry not found for mesh "+p.id)}if(p.materialUniqueId||p.materialId){const t=p.materialUniqueId?h:s;let e=-1!==t.indexOf(p.materialUniqueId||p.materialId);if(!1===e&&void 0!==u.multiMaterials&&null!==u.multiMaterials){const s=(e,s)=>{t.push(e);const r=eA(s,u,i,n);r&&r.material&&(iA[r.parsedMaterial.uniqueId||r.parsedMaterial.id]=r.material,c+="\n\tMaterial "+r.material.toString(a))};for(let n=0,r=u.multiMaterials.length;n<r;n++){const r=u.multiMaterials[n];if(p.materialUniqueId&&r.uniqueId===p.materialUniqueId||r.id===p.materialId){r.materialsUniqueIds?r.materialsUniqueIds.forEach((t=>s(t,(i=>i.uniqueId===t)))):r.materials.forEach((t=>s(t,(i=>i.id===t)))),t.push(r.uniqueId||r.id);const n=ks.ParseMultiMaterial(r,i);iA[r.uniqueId||r.id]=n,n&&(e=!0,c+="\n\tMulti-Material "+n.toString(a));break}}}if(!1===e){t.push(p.materialUniqueId||p.materialId);const e=eA((t=>p.materialUniqueId&&t.uniqueId===p.materialUniqueId||t.id===p.materialId),u,i,n);e&&e.material?(iA[e.parsedMaterial.uniqueId||e.parsedMaterial.id]=e.material,c+="\n\tMaterial "+e.material.toString(a)):F.Warn("Material not found for mesh "+p.id)}}if(p.skeletonId>-1&&void 0!==u.skeletons&&null!==u.skeletons){if(!(e.indexOf(p.skeletonId)>-1))for(let t=0,s=u.skeletons.length;t<s;t++){const s=u.skeletons[t];if(s.id===p.skeletonId){const t=Qr.Parse(s,i);o.push(t),e.push(s.id),c+="\n\tSkeleton "+t.toString(a)}}}if(p.morphTargetManagerId>-1&&void 0!==u.morphTargetManagers&&null!==u.morphTargetManagers){if(!(m.indexOf(p.morphTargetManagerId)>-1))for(let t=0,e=u.morphTargetManagers.length;t<e;t++){const e=u.morphTargetManagers[t];if(e.id===p.morphTargetManagerId){const t=$E.Parse(e,i);m.push(t.uniqueId),c+="\nMorph target "+t.toString()}}}const l=Ys.Parse(p,i,n);r.push(l),d.set(l.Ri,l),l.Ri=null,c+="\n\tMesh "+l.toString(a)}}i.multiMaterials.forEach((t=>{t.gI.forEach((e=>{t.subMaterials.push(oA(e,i))})),t.gI=[]})),i.meshes.forEach((t=>{null!==t._T&&(t.material=oA(t._T,i),t._T=null)}));for(let t=0,e=i.transformNodes.length;t<e;t++){const e=i.transformNodes[t];if(null!==e.xi){let t=d.get(parseInt(e.xi))||null;null===t&&(t=i.getLastEntryById(e.xi));let s=t;e.Ti&&(s=t.instances[parseInt(e.Ti)],e.Ti=null),e.parent=s,e.xi=null}}let v;for(let t=0,e=i.meshes.length;t<e;t++){if(v=i.meshes[t],v.xi){let t=d.get(parseInt(v.xi))||null;null===t&&(t=i.getLastEntryById(v.xi));let e=t;if(v.Ti&&(e=t.instances[parseInt(v.Ti)],v.Ti=null),v.parent=e,"TransformNode"===(null===(l=v.parent)||void 0===l?void 0:l.getClassName())){const t=p.indexOf(v.parent);t>-1&&p.splice(t,1)}v.xi=null}v.OT.lods&&rA(i,v)}for(const t of p)t.dispose();for(let t=0,e=i.skeletons.length;t<e;t++){const e=i.skeletons[t];e.VB&&(null!=e.bones&&e.bones.forEach((t=>{if(t.jS){const e=i.getLastEntryById(t.jS);e&&t.linkTransformNode(e),t.jS=null}})),e.VB=null)}for(let t=0,e=i.meshes.length;t<e;t++)v=i.meshes[t],v.OT.freezeWorldMatrix?(v.freezeWorldMatrix(),v.OT.freezeWorldMatrix=null):v.computeWorldMatrix(!0)}if(void 0!==u.particleSystems&&null!==u.particleSystems){const t=e.GetIndividualParser(fe.NAME_PARTICLESYSTEM);if(t)for(let e=0,s=u.particleSystems.length;e<s;e++){const s=u.particleSystems[e];-1!==f.indexOf(s.emitterId)&&h.push(t(s,i,n))}}return!0}catch(t){const i=nA("importMesh",u?u.producer:"Unknown")+c;if(!a)throw F.Log(i),t;a(i,t)}finally{null!==c&&On.loggingLevel!==On.NO_LOGGING&&F.Log(nA("importMesh",u?u.producer:"Unknown")+(On.loggingLevel!==On.MINIMAL_LOGGING?c:""))}return!1},load:(t,i,e,s)=>{let n="importScene has failed JSON parse";try{var r=JSON.parse(i);if(n="",void 0!==r.useDelayedTextureLoading&&null!==r.useDelayedTextureLoading&&(t.useDelayedTextureLoading=r.useDelayedTextureLoading&&!On.ForceFullSceneLoadingForIncremental),void 0!==r.autoClear&&null!==r.autoClear&&(t.autoClear=r.autoClear),void 0!==r.clearColor&&null!==r.clearColor&&(t.clearColor=y.FromArray(r.clearColor)),void 0!==r.ambientColor&&null!==r.ambientColor&&(t.ambientColor=_.FromArray(r.ambientColor)),void 0!==r.gravity&&null!==r.gravity&&(t.gravity=w.FromArray(r.gravity)),void 0!==r.useRightHandedSystem&&(t.useRightHandedSystem=!!r.useRightHandedSystem),r.fogMode&&0!==r.fogMode)switch(t.fogMode=r.fogMode,t.fogColor=_.FromArray(r.fogColor),t.fogStart=r.fogStart,t.fogEnd=r.fogEnd,t.fogDensity=r.fogDensity,n+="\tFog mode for scene:  ",t.fogMode){case 1:n+="exp\n";break;case 2:n+="exp2\n";break;case 3:n+="linear\n"}if(r.physicsEnabled){let i;"cannon"===r.physicsEngine||r.physicsEngine===KE.name?i=new KE(void 0,void 0,JE.LoaderInjectedPhysicsEngine):"oimo"===r.physicsEngine||r.physicsEngine===qE.name?i=new qE(void 0,JE.LoaderInjectedPhysicsEngine):"ammo"!==r.physicsEngine&&r.physicsEngine!==QE.name||(i=new QE(void 0,JE.LoaderInjectedPhysicsEngine,void 0)),n="\tPhysics engine "+(r.physicsEngine?r.physicsEngine:"oimo")+" enabled\n";const e=r.physicsGravity?w.FromArray(r.physicsGravity):null;t.enablePhysics(e,i)}void 0!==r.metadata&&null!==r.metadata&&(t.metadata=r.metadata),void 0!==r.collisionsEnabled&&null!==r.collisionsEnabled&&(t.collisionsEnabled=r.collisionsEnabled);return!!aA(t,i,e,s,!0)&&(r.autoAnimate&&t.beginAnimation(t,r.autoAnimateFrom,r.autoAnimateTo,r.autoAnimateLoop,r.autoAnimateSpeed||1),void 0!==r.activeCameraID&&null!==r.activeCameraID&&t.setActiveCameraById(r.activeCameraID),!0)}catch(t){const i=nA("importScene",r?r.producer:"Unknown")+n;if(!s)throw F.Log(i),t;s(i,t)}finally{null!==n&&On.loggingLevel!==On.NO_LOGGING&&F.Log(nA("importScene",r?r.producer:"Unknown")+(On.loggingLevel!==On.MINIMAL_LOGGING?n:""))}return!1},loadAssetContainer:(t,i,e,s)=>aA(t,i,e,s)});class lA{constructor(t={}){this.ui=!0,this.bias=void 0===t.bias?0:t.bias,this.power=void 0===t.power?1:t.power,this.leftColor=t.leftColor||_.White(),this.rightColor=t.rightColor||_.Black(),!1===t.isEnabled&&(this.isEnabled=!1)}get isEnabled(){return this.ui}set isEnabled(t){this.ui!==t&&(this.ui=t,Rs.MarkAllMaterialsAsDirty(20))}clone(){const t=new lA;return k.DeepCopy(this,t),t}equals(t){return t&&this.bias===t.bias&&this.power===t.power&&this.leftColor.equals(t.leftColor)&&this.rightColor.equals(t.rightColor)&&this.isEnabled===t.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(t){return new lA({isEnabled:t.isEnabled,leftColor:_.FromArray(t.leftColor),rightColor:_.FromArray(t.rightColor),bias:t.bias,power:t.power||1})}}ot.ri=lA.Parse;class cA extends _g{constructor(t,i){super(t,i),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new _(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this.y8=!0,this.F8=!0}get doubleSided(){return this.yW}set doubleSided(t){this.yW!==t&&(this.yW=t,this.backFaceCulling=!t,this.UR())}getClassName(){return"PBRBaseSimpleMaterial"}}ut([Q(),q("_markAllSubMeshesAsLightsDirty")],cA.prototype,"maxSimultaneousLights",void 0),ut([Q(),q("_markAllSubMeshesAsLightsDirty")],cA.prototype,"disableLighting",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],cA.prototype,"environmentTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],cA.prototype,"invertNormalMapX",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],cA.prototype,"invertNormalMapY",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],cA.prototype,"normalTexture",void 0),ut([J("emissive"),q("_markAllSubMeshesAsTexturesDirty")],cA.prototype,"emissiveColor",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty")],cA.prototype,"emissiveTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],cA.prototype,"occlusionStrength",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],cA.prototype,"occlusionTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],cA.prototype,"alphaCutOff",void 0),ut([Q()],cA.prototype,"doubleSided",null),ut([Z(),q("_markAllSubMeshesAsTexturesDirty",null)],cA.prototype,"lightmapTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],cA.prototype,"useLightmapAsShadowmap",void 0);class uA extends cA{constructor(t,i){super(t,i),this.P8=!1,this.D8=!0,this.L8=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(t){const i=ot.Clone((()=>new uA(t,this.getScene())),this);return i.id=t,i.name=t,this.clearCoat.copyTo(i.clearCoat),this.anisotropy.copyTo(i.anisotropy),this.brdf.copyTo(i.brdf),this.sheen.copyTo(i.sheen),this.subSurface.copyTo(i.subSurface),i}serialize(){const t=ot.Serialize(this);return t.customType="BABYLON.PBRMetallicRoughnessMaterial",t.clearCoat=this.clearCoat.serialize(),t.anisotropy=this.anisotropy.serialize(),t.brdf=this.brdf.serialize(),t.sheen=this.sheen.serialize(),t.subSurface=this.subSurface.serialize(),t.iridescence=this.iridescence.serialize(),t}static Parse(t,i,e){const s=ot.Parse((()=>new uA(t.name,i)),t,i,e);return t.clearCoat&&s.clearCoat.parse(t.clearCoat,i,e),t.anisotropy&&s.anisotropy.parse(t.anisotropy,i,e),t.brdf&&s.brdf.parse(t.brdf,i,e),t.sheen&&s.sheen.parse(t.sheen,i,e),t.subSurface&&s.subSurface.parse(t.subSurface,i,e),t.iridescence&&s.iridescence.parse(t.iridescence,i,e),s}}ut([J(),q("_markAllSubMeshesAsTexturesDirty","_albedoColor")],uA.prototype,"baseColor",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],uA.prototype,"baseTexture",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],uA.prototype,"metallic",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty")],uA.prototype,"roughness",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],uA.prototype,"metallicRoughnessTexture",void 0),v("BABYLON.PBRMetallicRoughnessMaterial",uA);class fA extends cA{constructor(t,i){super(t,i),this.N8=!0}get useMicroSurfaceFromReflectivityMapAlpha(){return this.N8}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(t){const i=ot.Clone((()=>new fA(t,this.getScene())),this);return i.id=t,i.name=t,this.clearCoat.copyTo(i.clearCoat),this.anisotropy.copyTo(i.anisotropy),this.brdf.copyTo(i.brdf),this.sheen.copyTo(i.sheen),this.subSurface.copyTo(i.subSurface),i}serialize(){const t=ot.Serialize(this);return t.customType="BABYLON.PBRSpecularGlossinessMaterial",t.clearCoat=this.clearCoat.serialize(),t.anisotropy=this.anisotropy.serialize(),t.brdf=this.brdf.serialize(),t.sheen=this.sheen.serialize(),t.subSurface=this.subSurface.serialize(),t.iridescence=this.iridescence.serialize(),t}static Parse(t,i,e){const s=ot.Parse((()=>new fA(t.name,i)),t,i,e);return t.clearCoat&&s.clearCoat.parse(t.clearCoat,i,e),t.anisotropy&&s.anisotropy.parse(t.anisotropy,i,e),t.brdf&&s.brdf.parse(t.brdf,i,e),t.sheen&&s.sheen.parse(t.sheen,i,e),t.subSurface&&s.subSurface.parse(t.subSurface,i,e),t.iridescence&&s.iridescence.parse(t.iridescence,i,e),s}}ut([J("diffuse"),q("_markAllSubMeshesAsTexturesDirty","_albedoColor")],fA.prototype,"diffuseColor",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],fA.prototype,"diffuseTexture",void 0),ut([J("specular"),q("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],fA.prototype,"specularColor",void 0),ut([Q(),q("_markAllSubMeshesAsTexturesDirty","_microSurface")],fA.prototype,"glossiness",void 0),ut([Z(),q("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],fA.prototype,"specularGlossinessTexture",void 0),v("BABYLON.PBRSpecularGlossinessMaterial",fA);class dA extends nn{constructor(t,i,e=null){if(super(i),t)if(this.pO=R.Identity(),this.name=t,this.url=t,this.Xst=e,this.Lb=this.Qb(t,!0),this.Lb)this.Prt();else{const t=this.getScene();t&&t.useDelayedTextureLoading?this.delayLoadState=4:this.y5()}}Prt(){this.Xst&&this.Xst()}getTextureMatrix(){return this.pO}Drt(){const t=this.qb();let i;i=t.hs.support3DTextures?t.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):t.createRawTexture(null,1,1,5,!1,!1,2,null,0),this.Lb=i,this.Lb.isReady=!1,this.isCube=!1,this.is3D=t.hs.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;const e=e=>{if("string"!=typeof e)return;let s,n=null,r=null;const h=e.split("\n");let o=0,a=0,l=0,c=0,u=0;for(let t=0;t<h.length;t++){if(s=h[t],!dA.Lrt.test(s))continue;if(0===s.indexOf("#"))continue;const i=s.split(" ");if(0!==o){if(0!=o){const t=Math.max(parseInt(i[0]),0),e=Math.max(parseInt(i[1]),0),s=Math.max(parseInt(i[2]),0);u=Math.max(t,u),u=Math.max(e,u),u=Math.max(s,u);const n=4*(a+c*o+l*o*o);r&&(r[n+0]=t,r[n+1]=e,r[n+2]=s),l++,l%o==0&&(c++,l=0,c%o==0&&(a++,c=0))}}else o=i.length,n=new Uint8Array(o*o*o*4),r=new Float32Array(o*o*o*4)}if(r&&n)for(let t=0;t<r.length;t++)if(t>0&&(t+1)%4==0)n[t]=255;else{const i=r[t];n[t]=i/u*255}i.is3D?(i.updateSize(o,o,o),t.updateRawTexture3D(i,n,5,!1)):(i.updateSize(o*o,o),t.updateRawTexture(i,n,5,!1)),i.isReady=!0,this.Prt()},s=this.getScene();return s?s.tn(this.url,e):t.tn(this.url,e),this.Lb}y5(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this.Drt()}clone(){const t=new dA(this.url,this.getScene()||this.qb());return t.level=this.level,t}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this.Lb=this.Qb(this.url,!0),this.Lb||this.y5())}static Parse(t,i){let e=null;return t.name&&!t.isRenderTarget&&(e=new dA(t.name,i),e.name=t.name,e.level=t.level),e}serialize(){if(!this.name)return null;const t={};return t.name=this.name,t.level=this.level,t.customType="BABYLON.ColorGradingTexture",t}}dA.Lrt=/\S+/,v("BABYLON.ColorGradingTexture",dA);class pA extends nn{constructor(t,i,e,s=!1,n=!0,r=null,h=null){if(super(i),this.Xst=null,this.Btt=null,!t)throw new Error("Image url is not set");this.Hb=an.CUBIC_MODE,this.name=t,this.url=t,this.Qn=e,this.Jb=s,this.gammaSpace=n,this.Xst=r,this.Btt=h,this.hasAlpha=!1,this.isCube=!0,this.Lb=this.Qb(t,this.Jb,void 0,void 0,void 0,this.isCube),this.Lb?r&&(this.Lb.isReady?ki.SetImmediate((()=>r())):this.Lb.onLoadedObservable.add(r)):i.useDelayedTextureLoading?this.delayLoadState=4:this.Ort(this.y5.bind(this),this.Btt)}Ort(t,i){const e=document.createElement("canvas");bi(this.url,(i=>{this.w$=i.width,this.wL=i.height,e.width=this.w$,e.height=this.wL;const s=e.getContext("2d");s.drawImage(i,0,0);const n=s.getImageData(0,0,i.width,i.height);this.Yn=n.data.buffer,e.remove(),t()}),((t,e)=>{i&&i(`${this.getClassName()} could not be loaded`,e)}),null)}y5(){const t=this.getScene();t&&(this.Lb=t.getEngine().createRawCubeTextureFromUrl(this.url,t,this.Qn,4,t.getEngine().getCaps().textureFloat?1:7,this.Jb,(()=>{const t=this.Frt(this.Yn),i=FE.ConvertPanoramaToCubemap(t,this.w$,this.wL,this.Qn),e=[];for(let t=0;t<6;t++){const s=i[pA.Wst[t]];e.push(s)}return e}),null,this.Xst,this.Btt))}Frt(t){const i=new DataView(t),e=new Float32Array(3*t.byteLength/4);let s=0;for(let n=0;n<t.byteLength;n++)(n+1)%4!=0&&(e[s++]=i.getUint8(n)/255);return e}getClassName(){return"EquiRectangularCubeTexture"}clone(){const t=this.getScene();if(!t)return this;const i=new pA(this.url,t,this.Qn,this.Jb,this.gammaSpace);return i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i.coordinatesIndex=this.coordinatesIndex,i.coordinatesMode=this.coordinatesMode,i}}pA.Wst=["right","left","up","down","front","back"];class mA extends nn{constructor(t,i,e){var s,n;super(e.scene||e.engine),this.onLoadObservable=new h,i&&(e.engine||e.scene)&&(e={...mA.Brt,...e},this.uO=e.generateMipMaps,this.O_=e.samplingMode,this.pO=R.Identity(),this.R_=e.format,this.name=t,this.element=i,this.Urt=!!i.getVideoPlaybackQuality,this.Ftt=this.Urt&&null!==(n=null===(s=this.Ls)||void 0===s?void 0:s.createExternalTexture(i))&&void 0!==n?n:null,this.anisotropicFilteringLevel=1,this.Ta())}Ta(){let t=0,i=0;this.Urt?(t=this.element.videoWidth,i=this.element.videoHeight):(t=this.element.width,i=this.element.height);const e=this.qb();e&&(this.Lb=e.createDynamicTexture(t,i,this.uO,this.O_),this.Lb.format=this.R_),this.update()}getTextureMatrix(){return this.pO}update(t=null){const i=this.qb();if(null==this.Lb||null==i)return;const e=this.isReady();if(this.Urt){const e=this.element;if(e.readyState<e.HAVE_CURRENT_DATA)return;i.updateVideoTexture(this.Lb,this.Ftt?this.Ftt:e,null===t||t)}else{const e=this.element;i.updateDynamicTexture(this.Lb,e,null===t||t,!1,this.R_)}!e&&this.isReady()&&this.onLoadObservable.notifyObservers(this)}dispose(){this.onLoadObservable.clear(),super.dispose()}}mA.Brt={generateMipMaps:!1,samplingMode:2,format:5,engine:null,scene:null};function vA(t){let i=0;return{id_length:t[i++],colormap_type:t[i++],image_type:t[i++],colormap_index:t[i++]|t[i++]<<8,colormap_length:t[i++]|t[i++]<<8,colormap_size:t[i++],origin:[t[i++]|t[i++]<<8,t[i++]|t[i++]<<8],width:t[i++]|t[i++]<<8,height:t[i++]|t[i++]<<8,pixel_size:t[i++],flags:t[i++]}}function gA(t,i){if(i.length<19)return void F.Error("Unable to load TGA file - Not enough data to contain header");let e=18;const s=vA(i);if(s.id_length+e>i.length)return void F.Error("Unable to load TGA file - Not enough data");e+=s.id_length;let n,r=!1,h=!1,o=!1;switch(s.image_type){case 9:r=!0;case 1:h=!0;break;case 10:r=!0;case 2:break;case 11:r=!0;case 3:o=!0}const a=s.pixel_size>>3,l=s.width*s.height*a;let c,u,f,d,p,m,v;if(h&&(c=i.subarray(e,e+=s.colormap_length*(s.colormap_size>>3))),r){let t,s,r;n=new Uint8Array(l);let h=0;const o=new Uint8Array(a);for(;e<l&&h<l;)if(t=i[e++],s=1+(127&t),128&t){for(r=0;r<a;++r)o[r]=i[e++];for(r=0;r<s;++r)n.set(o,h+r*a);h+=a*s}else{for(s*=a,r=0;r<s;++r)n[h+r]=i[e++];h+=s}}else n=i.subarray(e,e+=h?s.width*s.height:l);switch((48&s.flags)>>4){default:case 2:u=0,d=1,v=s.width,f=0,p=1,m=s.height;break;case 0:u=0,d=1,v=s.width,f=s.height-1,p=-1,m=-1;break;case 3:u=s.width-1,d=-1,v=-1,f=0,p=1,m=s.height;break;case 1:u=s.width-1,d=-1,v=-1,f=s.height-1,p=-1,m=-1}const g="_getImageData"+(o?"Grey":"")+s.pixel_size+"bits",S=SA[g](s,c,n,f,p,m,u,d,v);t.getEngine().Ga(t,S)}const SA={GetTGAHeader:vA,UploadContent:gA,Vrt:function(t,i,e,s,n,r,h,o,a){const l=e,c=i,u=t.width,f=t.height;let d,p,m,v=0;const g=new Uint8Array(u*f*4);for(m=s;m!==r;m+=n)for(p=h;p!==a;p+=o,v++)d=l[v],g[4*(p+u*m)+3]=255,g[4*(p+u*m)+2]=c[3*d+0],g[4*(p+u*m)+1]=c[3*d+1],g[4*(p+u*m)+0]=c[3*d+2];return g},krt:function(t,i,e,s,n,r,h,o,a){const l=e,c=t.width,u=t.height;let f,d,p,m=0;const v=new Uint8Array(c*u*4);for(p=s;p!==r;p+=n)for(d=h;d!==a;d+=o,m+=2){f=l[m+0]+(l[m+1]<<8);const t=255*((31744&f)>>10)/31|0,i=255*((992&f)>>5)/31|0,e=255*(31&f)/31|0;v[4*(d+c*p)+0]=t,v[4*(d+c*p)+1]=i,v[4*(d+c*p)+2]=e,v[4*(d+c*p)+3]=32768&f?0:255}return v},Grt:function(t,i,e,s,n,r,h,o,a){const l=e,c=t.width,u=t.height;let f,d,p=0;const m=new Uint8Array(c*u*4);for(d=s;d!==r;d+=n)for(f=h;f!==a;f+=o,p+=3)m[4*(f+c*d)+3]=255,m[4*(f+c*d)+2]=l[p+0],m[4*(f+c*d)+1]=l[p+1],m[4*(f+c*d)+0]=l[p+2];return m},zrt:function(t,i,e,s,n,r,h,o,a){const l=e,c=t.width,u=t.height;let f,d,p=0;const m=new Uint8Array(c*u*4);for(d=s;d!==r;d+=n)for(f=h;f!==a;f+=o,p+=4)m[4*(f+c*d)+2]=l[p+0],m[4*(f+c*d)+1]=l[p+1],m[4*(f+c*d)+0]=l[p+2],m[4*(f+c*d)+3]=l[p+3];return m},Hrt:function(t,i,e,s,n,r,h,o,a){const l=e,c=t.width,u=t.height;let f,d,p,m=0;const v=new Uint8Array(c*u*4);for(p=s;p!==r;p+=n)for(d=h;d!==a;d+=o,m++)f=l[m],v[4*(d+c*p)+0]=f,v[4*(d+c*p)+1]=f,v[4*(d+c*p)+2]=f,v[4*(d+c*p)+3]=255;return v},Xrt:function(t,i,e,s,n,r,h,o,a){const l=e,c=t.width,u=t.height;let f,d,p=0;const m=new Uint8Array(c*u*4);for(d=s;d!==r;d+=n)for(f=h;f!==a;f+=o,p+=2)m[4*(f+c*d)+0]=l[p+0],m[4*(f+c*d)+1]=l[p+0],m[4*(f+c*d)+2]=l[p+0],m[4*(f+c*d)+3]=l[p+1];return m}};Rs.ya.push(new class{constructor(){this.supportCascades=!1}canLoad(t){return t.endsWith(".tga")}loadCubeData(){throw".env not supported in Cube."}loadData(t,i,e){const s=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n=vA(s);e(n.width,n.height,i.generateMipMaps,!1,(()=>{gA(i,s)}))}});Rs.ya.push(new class{constructor(){this.supportCascades=!1}canLoad(t){return t.endsWith(".hdr")}loadCubeData(){throw".env not supported in Cube."}loadData(t,i,e){const s=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n=BE.RGBE_ReadHeader(s),r=BE.RGBE_ReadPixels(s,n),h=n.width*n.height,o=new Float32Array(4*h);for(let t=0;t<h;t+=1)o[4*t]=r[3*t],o[4*t+1]=r[3*t+1],o[4*t+2]=r[3*t+2],o[4*t+3]=1;e(n.width,n.height,i.generateMipMaps,!1,(()=>{const t=i.getEngine();i.type=1,i.format=5,i.wr=!1,t.Ga(i,o)}))}});var EA;!function(t){t[t.cTFETC1=0]="cTFETC1",t[t.cTFETC2=1]="cTFETC2",t[t.cTFBC1=2]="cTFBC1",t[t.cTFBC3=3]="cTFBC3",t[t.cTFBC4=4]="cTFBC4",t[t.cTFBC5=5]="cTFBC5",t[t.cTFBC7=6]="cTFBC7",t[t.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",t[t.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",t[t.cTFASTC_4x4=10]="cTFASTC_4x4",t[t.cTFATC_RGB=11]="cTFATC_RGB",t[t.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",t[t.cTFRGBA32=13]="cTFRGBA32",t[t.cTFRGB565=14]="cTFRGB565",t[t.cTFBGR565=15]="cTFBGR565",t[t.cTFRGBA4444=16]="cTFRGBA4444",t[t.cTFFXT1_RGB=17]="cTFFXT1_RGB",t[t.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",t[t.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",t[t.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",t[t.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(EA||(EA={}));const AA={JSModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.js",WasmModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.wasm"};let CA=null,wA=null,xA=0;const TA=(t,i)=>{const e=t instanceof ArrayBuffer?new Uint8Array(t):t;return new Promise(((t,s)=>{(CA||(CA=new Promise(((t,i)=>{wA?t(wA):ki.LoadFileAsync(AA.WasmModuleURL).then((e=>{if("function"!=typeof URL)return i("Basis transcoder requires an environment with a URL constructor");const s=URL.createObjectURL(new Blob([`(${bA})()`],{type:"application/javascript"}));wA=new Worker(s);const n=e=>{"init"===e.data.action?(wA.removeEventListener("message",n),t(wA)):"error"===e.data.action&&i(e.data.error||"error initializing worker")};wA.addEventListener("message",n),wA.postMessage({action:"init",url:AA.JSModuleURL,wasmBinary:e})})).catch(i)}))),CA).then((()=>{const n=xA++,r=i=>{"transcode"===i.data.action&&i.data.id===n&&(wA.removeEventListener("message",r),i.data.success?t(i.data):s("Transcode is not supported on this device"))};wA.addEventListener("message",r);const h=new Uint8Array(e.byteLength);h.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),wA.postMessage({action:"transcode",id:n,imageData:h,config:i,ignoreSupportedFormats:false},[h.buffer])}),(t=>{s(t)}))}))},RA=(t,i)=>{var e,s;let n=null===(e=i.lo)||void 0===e?void 0:e.TEXTURE_2D;t.isCube&&(n=null===(s=i.lo)||void 0===s?void 0:s.TEXTURE_CUBE_MAP),i.qo(n,t,!0)},IA=(t,i)=>{const e=t.getEngine();for(let s=0;s<i.fileInfo.images.length;s++){const n=i.fileInfo.images[s].levels[0];if(t.Xn=t.invertY,-1===i.format||i.format===EA.cTFRGB565)if(t.type=10,t.format=4,!e.hs.basisNeedsPOT||o.Log2(n.width)%1==0&&o.Log2(n.height)%1==0)t.Xn=!t.invertY,t.width=n.width+3&-4,t.height=n.height+3&-4,t.samplingMode=2,RA(t,e),e.Ga(t,new Uint16Array(n.transcodedPixels.buffer),s,0,4,!0);else{const i=new ai(e,oi.Temp);t.Xn=t.invertY,i.type=10,i.format=4,i.width=n.width+3&-4,i.height=n.height+3&-4,RA(i,e),e.Ga(i,new Uint16Array(n.transcodedPixels.buffer),s,0,4,!0),e.Da(i,t,e.scenes[0],e.Ia(4),(()=>{e.Nr(i),RA(t,e)}))}else{t.width=n.width,t.height=n.height,t.generateMipMaps=i.fileInfo.images[s].levels.length>1;const r=MA.GetInternalFormatFromBasisFormat(i.format,e);t.format=r,RA(t,e),i.fileInfo.images[s].levels.forEach(((i,n)=>{e.ka(t,r,i.width,i.height,i.transcodedPixels,s,n)})),!e.hs.basisNeedsPOT||o.Log2(t.width)%1==0&&o.Log2(t.height)%1==0||(ki.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),t.Vn=an.CLAMP_ADDRESSMODE,t.kn=an.CLAMP_ADDRESSMODE)}}},MA={JSModuleURL:AA.JSModuleURL,WasmModuleURL:AA.WasmModuleURL,GetInternalFormatFromBasisFormat:(t,i)=>{let e;switch(t){case EA.cTFETC1:e=36196;break;case EA.cTFBC1:e=33776;break;case EA.cTFBC4:e=33779;break;case EA.cTFASTC_4x4:e=37808;break;case EA.cTFETC2:e=37496;break;case EA.cTFBC7:e=36492}if(void 0===e)throw"The chosen Basis transcoder format is not currently supported";return e},TranscodeAsync:TA,LoadTextureFromTranscodeResult:IA};function bA(){const t=0,i=1,e=2,s=3,n=6,r=8,h=9,o=10,a=14;let l=null;function c(t,i,e,s,n){const r=t.getImageTranscodedSizeInBytes(i,e,s);let h=new Uint8Array(r);if(!t.transcodeImage(h,i,e,s,1,0))return null;if(n){h=function(t,i,e,s){const n=new Uint16Array(4),r=new Uint16Array(e*s),h=e/4,o=s/4;for(let s=0;s<o;s++)for(let o=0;o<h;o++){const a=i+8*(s*h+o);n[0]=t[a]|t[a+1]<<8,n[1]=t[a+2]|t[a+3]<<8,n[2]=(2*(31&n[0])+1*(31&n[1]))/3|(2*(2016&n[0])+1*(2016&n[1]))/3&2016|(2*(63488&n[0])+1*(63488&n[1]))/3&63488,n[3]=(2*(31&n[1])+1*(31&n[0]))/3|(2*(2016&n[1])+1*(2016&n[0]))/3&2016|(2*(63488&n[1])+1*(63488&n[0]))/3&63488;for(let i=0;i<4;i++){const h=t[a+4+i];let l=(4*s+i)*e+4*o;r[l++]=n[3&h],r[l++]=n[h>>2&3],r[l++]=n[h>>4&3],r[l++]=n[h>>6&3]}}return r}(h,0,t.getImageWidth(i,e)+3&-4,t.getImageHeight(i,e)+3&-4)}return h}onmessage=u=>{if("init"===u.data.action){if(!l){try{importScripts(u.data.url)}catch(t){postMessage({action:"error",error:t})}l=BASIS({wasmBinary:u.data.wasmBinary})}null!==l&&l.then((t=>{BASIS=t,t.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===u.data.action){const l=u.data.config,f=u.data.imageData,d=new BASIS.BasisFile(f),p=function(t){const i=t.getHasAlpha(),e=t.getNumImages(),s=[];for(let i=0;i<e;i++){const e={levels:[]},n=t.getNumLevels(i);for(let s=0;s<n;s++){const n={width:t.getImageWidth(i,s),height:t.getImageHeight(i,s)};e.levels.push(n)}s.push(e)}return{hasAlpha:i,images:s}}(d);let m=u.data.ignoreSupportedFormats?null:function(l,c){let u=null;l.supportedCompressionFormats&&(u=l.supportedCompressionFormats.astc?o:l.supportedCompressionFormats.bc7?n:l.supportedCompressionFormats.s3tc?c.hasAlpha?s:e:l.supportedCompressionFormats.pvrtc?c.hasAlpha?h:r:l.supportedCompressionFormats.etc2?i:l.supportedCompressionFormats.etc1?t:a);return u}(u.data.config,p),v=!1;null===m&&(v=!0,m=p.hasAlpha?s:e);let g=!0;d.startTranscoding()||(g=!1);const S=[];for(let t=0;t<p.images.length&&g;t++){const i=p.images[t];if(void 0===l.loadSingleImage||l.loadSingleImage===t){let e=i.levels.length;!1===l.loadMipmapLevels&&(e=1);for(let s=0;s<e;s++){const e=i.levels[s],n=c(d,t,s,m,v);if(!n){g=!1;break}e.transcodedPixels=n,S.push(e.transcodedPixels.buffer)}}}d.close(),d.delete(),v&&(m=-1),g?postMessage({action:"transcode",success:g,id:u.data.id,fileInfo:p,format:m},S):postMessage({action:"transcode",success:g,id:u.data.id})}}}Object.defineProperty(MA,"JSModuleURL",{get:function(){return AA.JSModuleURL},set:function(t){AA.JSModuleURL=t}}),Object.defineProperty(MA,"WasmModuleURL",{get:function(){return AA.WasmModuleURL},set:function(t){AA.WasmModuleURL=t}});Rs.ya.push(new class{constructor(){this.supportCascades=!1}canLoad(t){return t.endsWith(".basis")}loadCubeData(t,i,e,s,n){if(Array.isArray(t))return;const r=i.getEngine().getCaps(),h={supportedCompressionFormats:{etc1:!!r.etc1,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,astc:!!r.astc,bc7:!!r.bptc}};TA(t,h).then((t=>{const e=t.fileInfo.images[0].levels.length>1&&i.generateMipMaps;IA(i,t),i.getEngine().oQ(i,e),i.isReady=!0,i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),s&&s()})).catch((t=>{ki.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),i.isReady=!0,n&&n(t)}))}loadData(t,i,e){const s=i.getEngine().getCaps(),n={supportedCompressionFormats:{etc1:!!s.etc1,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,astc:!!s.astc,bc7:!!s.bptc}};TA(t,n).then((t=>{const s=t.fileInfo.images[0].levels[0],n=t.fileInfo.images[0].levels.length>1&&i.generateMipMaps;e(s.width,s.height,n,-1!==t.format,(()=>{IA(i,t)}))})).catch((t=>{ki.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),ki.Warn(`Failed to transcode Basis file: ${t}`),e(0,0,!1,!1,(()=>{}),!0)}))}});class _A extends br{constructor(t,i,e,s,n,r){const h=!(!n||!n.generateMipMaps)&&n.generateMipMaps,o=!(!n||!n.generateDepthTexture)&&n.generateDepthTexture,a=n&&n.depthTextureFormat?n.depthTextureFormat:15,l=!n||void 0===n.doNotChangeAspectRatio||n.doNotChangeAspectRatio,c=!(!n||!n.drawOnlyOnFirstAttachmentByDefault)&&n.drawOnlyOnFirstAttachmentByDefault;if(super(t,i,s,h,l,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported)return void this.dispose();const u=[],f=[],d=[];this.Wrt(e,u,f,d,n);const p=!n||void 0===n.generateDepthBuffer||n.generateDepthBuffer,m=!(!n||void 0===n.generateStencilBuffer)&&n.generateStencilBuffer;this.Qn=i,this.$rt={samplingModes:f,generateMipMaps:h,generateDepthBuffer:p,generateStencilBuffer:m,generateDepthTexture:o,depthTextureFormat:a,types:u,textureCount:e,useSRGBBuffers:d},this.Tl=e,this.Yrt=c,e>0&&(this.jrt(),this.Krt(r))}get isSupported(){var t,i;return null!==(i=null===(t=this.Ls)||void 0===t?void 0:t.getCaps().drawBuffersExtension)&&void 0!==i&&i}get textures(){return this.sx}get count(){return this.Tl}get depthTexture(){return this.sx[this.sx.length-1]}set wrapU(t){if(this.sx)for(let i=0;i<this.sx.length;i++)this.sx[i].wrapU=t}set wrapV(t){if(this.sx)for(let i=0;i<this.sx.length;i++)this.sx[i].wrapV=t}Wrt(t,i,e,s,n){for(let r=0;r<t;r++)n&&n.types&&void 0!==n.types[r]?i.push(n.types[r]):i.push(n&&n.defaultType?n.defaultType:0),n&&n.samplingModes&&void 0!==n.samplingModes[r]?e.push(n.samplingModes[r]):e.push(an.BILINEAR_SAMPLINGMODE),n&&n.useSRGBBuffers&&void 0!==n.useSRGBBuffers[r]?s.push(n.useSRGBBuffers[r]):s.push(!1)}br(t=!1,i){if(this.Tl<1)return;this.releaseInternalTextures(),this.jrt(),t&&(this.qrt(),this.Krt(i));const e=this.rO.textures;for(let t=0;t<e.length;t++){this.sx[t].Lb=e[t]}1!==this.samples&&this.rO.setSamples(this.samples,!this.Yrt,!0)}jrt(){this.rO=this.qb().createMultipleRenderTarget(this.Qn,this.$rt,!this.Yrt),this.Lb=this.rO.texture}qrt(){if(this.sx)for(let t=0;t<this.sx.length;t++)this.sx[t].Lb=null,this.sx[t].dispose()}Krt(t){const i=this.rO.textures;this.sx=[];for(let e=0;e<i.length;e++){const s=new an(null,this.getScene());(null==t?void 0:t[e])&&(s.name=t[e]),s.Lb=i[e],this.sx.push(s)}}setInternalTexture(t,i,e=!0){this.renderTarget&&(0===i&&(this.Lb=t),this.renderTarget.setTexture(t,i,e),this.textures[i]||(this.textures[i]=new an(null,this.getScene())),this.textures[i].Lb=t,this.Tl=this.renderTarget.textures?this.renderTarget.textures.length:0,this.$rt.types&&(this.$rt.types[i]=t.type),this.$rt.samplingModes&&(this.$rt.samplingModes[i]=t.samplingMode),this.$rt.useSRGBBuffers&&(this.$rt.useSRGBBuffers[i]=t.ur))}get samples(){return this.dw}set samples(t){this.rO?this.dw=this.rO.setSamples(t):this.dw=t}resize(t){this.Qn=t,this.br()}updateCount(t,i,e){this.$rt.textureCount=t,this.Tl=t;const s=[],n=[],r=[];this.Wrt(t,s,n,r,i),this.$rt.types=s,this.$rt.samplingModes=n,this.$rt.useSRGBBuffers=r,this.br(!0,e)}yO(t,i){this.rO&&t.unBindMultiColorAttachmentFramebuffer(this.rO,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(i)}))}dispose(t=!1){this.qrt(),t?this.Lb=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){var t,i;const e=null===(t=this.rO)||void 0===t?void 0:t.textures;if(e){for(let t=e.length-1;t>=0;t--)this.sx[t].Lb=null;null===(i=this.rO)||void 0===i||i.dispose(),this.rO=null}}}class yA{constructor(t,i,e){this.id=t,this.scale=i,this.offset=e}}class NA{constructor(t,i,e,s){var n,r,h,o,a,l,c,u,f,d,p,m,v;return this.name=t,this.meshes=i,this.scene=s,this.options=e,this.options.map=null!==(n=this.options.map)&&void 0!==n?n:["ambientTexture","bumpTexture","diffuseTexture","emissiveTexture","lightmapTexture","opacityTexture","reflectionTexture","refractionTexture","specularTexture"],this.options.uvsIn=null!==(r=this.options.uvsIn)&&void 0!==r?r:he.UVKind,this.options.uvsOut=null!==(h=this.options.uvsOut)&&void 0!==h?h:he.UVKind,this.options.layout=null!==(o=this.options.layout)&&void 0!==o?o:NA.LAYOUT_STRIP,this.options.layout===NA.LAYOUT_COLNUM&&(this.options.colnum=null!==(a=this.options.colnum)&&void 0!==a?a:8),this.options.updateInputMeshes=null===(l=this.options.updateInputMeshes)||void 0===l||l,this.options.disposeSources=null===(c=this.options.disposeSources)||void 0===c||c,this.Qrt=0,this.options.fillBlanks=null===(u=this.options.fillBlanks)||void 0===u||u,!0===this.options.fillBlanks&&(this.options.customFillColor=null!==(f=this.options.customFillColor)&&void 0!==f?f:"black"),this.options.frameSize=null!==(d=this.options.frameSize)&&void 0!==d?d:256,this.options.paddingRatio=null!==(p=this.options.paddingRatio)&&void 0!==p?p:.0115,this.Zrt=Math.ceil(this.options.frameSize*this.options.paddingRatio),this.Zrt%2!=0&&this.Zrt++,this.options.paddingMode=null!==(m=this.options.paddingMode)&&void 0!==m?m:NA.SUBUV_WRAP,this.options.paddingMode===NA.SUBUV_COLOR&&(this.options.paddingColor=null!==(v=this.options.paddingColor)&&void 0!==v?v:new y(0,0,0,1)),this.sets={},this.frames=[],this}Jrt(t){const i=this.tht(),e=new C(1,1).divide(i);let s=0;const n=this.Qrt,r=this.meshes.length,h=Object.keys(this.sets);for(let t=0;t<h.length;t++){const e=h[t],s=new nc(this.name+".TexturePack."+e+"Set",{width:i.x,height:i.y},this.scene,!0,an.TRILINEAR_SAMPLINGMODE,Rs.TEXTUREFORMAT_RGBA),n=s.getContext();n.fillStyle="rgba(0,0,0,0)",n.fillRect(0,0,i.x,i.y),s.update(!1),this.sets[e]=s}const o=this.options.frameSize||256,a=this.Zrt,l=o+2*a,c=()=>{this.iht(o,a,i,e,this.options.updateInputMeshes||!1)};for(let e=0;e<r;e++){const r=this.meshes[e].material;for(let u=0;u<h.length;u++){const f=new nc("temp",l,this.scene,!0),d=f.getContext(),p=this.eht(e),m=()=>{s++,f.update(!1);const e=d.getImageData(0,0,l,l),r=this.sets[v];if(r.getContext().putImageData(e,i.x*p.x,i.y*p.y),f.dispose(),r.update(!1),s==n)return c(),void t()},v=h[u]||"_blank";if(r&&null!==r[v]){const t=r[v],i=new Image;i.src=t instanceof nc?t.getContext().canvas.toDataURL("image/png"):t.url,ki.SetCorsBehavior(i.src,i),i.onload=()=>{d.fillStyle="rgba(0,0,0,0)",d.fillRect(0,0,l,l),f.update(!1),d.setTransform(1,0,0,-1,0,0);const t=[0,0,1,0,1,1,0,1,-1,1,-1,0,-2,0,-1,1,-1];switch(this.options.paddingMode){case 0:for(let e=0;e<9;e++)d.drawImage(i,0,0,i.width,i.height,a+o*t[e],a+o*t[e+1]-l,o,o);break;case 1:for(let e=0;e<a;e++)d.drawImage(i,0,0,i.width,i.height,e+o*t[0],a-l,o,o),d.drawImage(i,0,0,i.width,i.height,2*a-e,a-l,o,o),d.drawImage(i,0,0,i.width,i.height,a,e-l,o,o),d.drawImage(i,0,0,i.width,i.height,a,2*a-e-l,o,o);d.drawImage(i,0,0,i.width,i.height,a+o*t[0],a+o*t[1]-l,o,o);break;case 2:d.fillStyle=(this.options.paddingColor||_.Black()).toHexString(),d.fillRect(0,0,l,-l),d.clearRect(a,a,o,o),d.drawImage(i,0,0,i.width,i.height,a+o*t[0],a+o*t[1]-l,o,o)}d.setTransform(1,0,0,1,0,0),m()}}else d.fillStyle="rgba(0,0,0,0)",this.options.fillBlanks&&(d.fillStyle=this.options.customFillColor),d.fillRect(0,0,l,l),m()}}}tht(){const t=this.meshes.length||0,i=this.options.frameSize||0,e=this.Zrt||0;switch(this.options.layout){case 0:return new C(i*t+2*e*t,i+2*e);case 1:{const s=Math.max(2,Math.ceil(Math.sqrt(t))),n=i*s+2*e*s;return new C(n,n)}case 2:{const s=this.options.colnum||1,n=Math.max(1,Math.ceil(t/s));return new C(i*s+2*e*s,i*n+2*e*n)}}return C.Zero()}iht(t,i,e,s,n){const r=this.meshes.length;for(let h=0;h<r;h++){const r=this.meshes[h],o=new C(t/e.x,t/e.y),a=s.clone().scale(i),l=this.eht(h).add(a),c=new yA(h,o,l);this.frames.push(c),n&&(this.sht(r,h),this.nht(r))}}eht(t){const i=this.meshes.length;let e,s,n;switch(this.options.layout){case 0:return e=1/i,new C(t*e,0);case 1:{const r=Math.max(2,Math.ceil(Math.sqrt(i)));return s=Math.floor(t/r),n=t-s*r,e=1/r,new C(n*e,s*e)}case 2:{const r=this.options.colnum||1,h=Math.max(1,Math.ceil(i/r));return n=Math.floor(t/h),s=t-n*h,e=new C(1/r,1/h),new C(n*e.x,s*e.y)}}return C.Zero()}sht(t,i){const e=this.frames[i],s=t.getVerticesData(this.options.uvsIn||he.UVKind),n=[];let r=0;s.length&&(r=s.length||0);for(let t=0;t<r;t+=2)n.push(s[t]*e.scale.x+e.offset.x,s[t+1]*e.scale.y+e.offset.y);t.setVerticesData(this.options.uvsOut||he.UVKind,n)}nht(t,i=!1){const e=t.material,s=Object.keys(this.sets),n=t=>{t.dispose&&t.dispose()};for(let t=0;t<s.length;t++){const r=s[t];if(i)null!==e[r]&&n(e[r]),e[r]=this.sets[r];else{if(!e)return;null!==e[r]&&(n(e[r]),e[r]=this.sets[r])}}}setMeshToFrame(t,i,e=!1){this.sht(t,i),e&&this.nht(t,!0)}processAsync(){return new Promise(((t,i)=>{try{if(0===this.meshes.length)return void t();let i=0;const e=e=>{if(i++,this.options.map){for(let t=0;t<this.options.map.length;t++){null!==e[this.options.map[t]]&&(this.sets[this.options.map[t]]||(this.sets[this.options.map[t]]=!0),this.Qrt++)}i===this.meshes.length&&this.Jrt(t)}};for(let s=0;s<this.meshes.length;s++){const n=this.meshes[s],r=n.material;if(r)r.forceCompilationAsync(n).then((()=>{e(r)}));else if(i++,i===this.meshes.length)return this.Jrt(t)}}catch(t){return i(t)}}))}dispose(){const t=Object.keys(this.sets);for(let i=0;i<t.length;i++){const e=t[i];this.sets[e].dispose()}}download(t="png",i=1){setTimeout((()=>{const e={name:this.name,sets:{},options:{},frames:[]},s=Object.keys(this.sets),n=Object.keys(this.options);try{for(let n=0;n<s.length;n++){const r=s[n],h=this.sets[r];e.sets[r]=h.getContext().canvas.toDataURL("image/"+t,i)}for(let t=0;t<n.length;t++){const i=n[t];e.options[i]=this.options[i]}for(let t=0;t<this.frames.length;t++){const i=this.frames[t];e.frames.push(i.scale.x,i.scale.y,i.offset.x,i.offset.y)}}catch(t){return void F.Warn("Unable to download: "+t)}const r="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e,null,4)),h=document.createElement("a");h.setAttribute("href",r),h.setAttribute("download",this.name+"_texurePackage.json"),document.body.appendChild(h),h.click(),h.remove()}),0)}updateFromJSON(t){try{const i=JSON.parse(t);this.name=i.name;const e=Object.keys(i.options);for(let t=0;t<e.length;t++)this.options[e[t]]=i.options[e[t]];for(let t=0;t<i.frames.length;t+=4){const e=new yA(t/4,new C(i.frames[t],i.frames[t+1]),new C(i.frames[t+2],i.frames[t+3]));this.frames.push(e)}const s=Object.keys(i.sets);for(let t=0;t<s.length;t++){const e=new an(i.sets[s[t]],this.scene,!1,!1);this.sets[s[t]]=e}}catch(t){F.Warn("Unable to update from JSON: "+t)}}}NA.LAYOUT_STRIP=0,NA.LAYOUT_POWER2=1,NA.LAYOUT_COLNUM=2,NA.SUBUV_WRAP=0,NA.SUBUV_EXTEND=1,NA.SUBUV_COLOR=2;const PA="noisePixelShader",DA="uniform float brightness;\nuniform float persistence;\nuniform float timeScale;\nvarying vec2 vUV;\nvec2 hash22(vec2 p)\n{\np=p*mat2(127.1,311.7,269.5,183.3);\np=-1.0+2.0*fract(sin(p)*43758.5453123);\nreturn sin(p*6.283+timeScale);\n}\nfloat interpolationNoise(vec2 p)\n{\nvec2 pi=floor(p);\nvec2 pf=p-pi;\nvec2 w=pf*pf*(3.-2.*pf);\nfloat f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));\nfloat f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));\nfloat f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));\nfloat f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));\nfloat xm1=mix(f00,f10,w.x);\nfloat xm2=mix(f01,f11,w.x);\nfloat ym=mix(xm1,xm2,w.y); \nreturn ym;\n}\nfloat perlinNoise2D(float x,float y)\n{\nfloat sum=0.0;\nfloat frequency=0.0;\nfloat amplitude=0.0;\nfor(int i=0; i<OCTAVES; i++)\n{\nfrequency=pow(2.0,float(i));\namplitude=pow(persistence,float(i));\nsum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;\n}\nreturn sum;\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat x=abs(vUV.x);\nfloat y=abs(vUV.y);\nfloat noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);\ngl_FragColor=vec4(noise,noise,noise,1.0);\n}\n";ii.ShadersStore[PA]=DA;class LA extends Pr{constructor(t,i=256,e=E.LastCreatedScene,s,n){super(t,i,"noise",e,s,n),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this.rht()}rht(){const t=this.getScene();t&&(this.time+=t.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}ZO(){return"#define OCTAVES "+(0|this.octaves)}render(t){this.rht(),super.render(t)}serialize(){const t={customType:"BABYLON.NoiseProceduralTexture"};return t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.size=this.getSize().width,t.generateMipMaps=this.uO,t.time=this.time,t}clone(){const t=this.getSize(),i=new LA(this.name,t.width,this.getScene(),this.YO?this.YO:void 0,this.uO);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,i.brightness=this.brightness,i.octaves=this.octaves,i.persistence=this.persistence,i.animationSpeedFactor=this.animationSpeedFactor,i.time=this.time,i}static Parse(t,i){var e;const s=new LA(t.name,t.size,i,void 0,t.generateMipMaps);return s.brightness=t.brightness,s.octaves=t.octaves,s.persistence=t.persistence,s.animationSpeedFactor=t.animationSpeedFactor,s.time=null!==(e=t.time)&&void 0!==e?e:0,s}}v("BABYLON.NoiseProceduralTexture",LA);class OA extends Vn{constructor(t,i,e,s,n){super(t,i,e),this.hht=s,this.oht=n,this.needDualDirectionValidation=!0}checkCompatibilityState(t){return t instanceof OA&&t.oht===this.oht?_n.Compatible:_n.TypeIncompatible}createCustomInputBlock(){return[new this.hht(this.oht),this.name]}}v("BABYLON.BonesBlock",class extends kn{constructor(t){super(t,bn.Vertex),this.registerInput("matricesIndices",Mn.Vector4),this.registerInput("matricesWeights",Mn.Vector4),this.registerInput("matricesIndicesExtra",Mn.Vector4,!0),this.registerInput("matricesWeightsExtra",Mn.Vector4,!0),this.registerInput("world",Mn.Matrix),this.registerOutput("output",Mn.Matrix)}initialize(t){t.AP("boneSampler"),t.AP("boneTextureWidth"),t.AP("mBones"),t.AP("BonesPerMesh")}getClassName(){return"BonesBlock"}get matricesIndices(){return this.xd[0]}get matricesWeights(){return this.xd[1]}get matricesIndicesExtra(){return this.xd[2]}get matricesWeightsExtra(){return this.xd[3]}get world(){return this.xd[4]}get output(){return this.YP[0]}autoConfigure(t){if(!this.matricesIndices.isConnected){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"matricesIndices"===t.name));i||(i=new jn("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"matricesWeights"===t.name));i||(i=new jn("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.World));i||(i=new jn("world"),i.setAsSystemValue(Dn.World)),i.output.connectTo(this.world)}}provideFallbacks(t,i){t&&t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&i.addCPUSkinningFallback(0,t)}bind(t,i,e){Fs.BindBonesParameters(e,t)}prepareDefines(t,i,e){e.bl&&Fs.PrepareDefinesForBones(t,e)}tD(t){super.tD(t),t.sharedData.blocksWithFallbacks.push(this),t.sharedData.forcedBindableBlocks.push(this),t.sharedData.blocksWithDefines.push(this),t.uniforms.push("boneTextureWidth"),t.uniforms.push("mBones"),t.samplers.push("boneSampler");const i=`//${this.name}`;t.IP("bonesDeclaration",i,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const e=t.SP("influence");t.compilationString+=t.RP("bonesVertex",i,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:e}]});const s=this.YP[0],n=this.world;return t.compilationString+="#if NUM_BONE_INFLUENCERS>0\r\n",t.compilationString+=this.QP(s,t)+` = ${n.associatedVariableName} * ${e};\r\n`,t.compilationString+="#else\r\n",t.compilationString+=this.QP(s,t)+` = ${n.associatedVariableName};\r\n`,t.compilationString+="#endif\r\n",this}});v("BABYLON.InstancesBlock",class extends kn{constructor(t){super(t,bn.Vertex),this.registerInput("world0",Mn.Vector4),this.registerInput("world1",Mn.Vector4),this.registerInput("world2",Mn.Vector4),this.registerInput("world3",Mn.Vector4),this.registerInput("world",Mn.Matrix,!0),this.registerOutput("output",Mn.Matrix),this.registerOutput("instanceID",Mn.Float)}getClassName(){return"InstancesBlock"}get world0(){return this.xd[0]}get world1(){return this.xd[1]}get world2(){return this.xd[2]}get world3(){return this.xd[3]}get world(){return this.xd[4]}get output(){return this.YP[0]}get instanceID(){return this.YP[1]}autoConfigure(t){if(!this.world0.connectedPoint){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"world0"===t.name));i||(i=new jn("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"world1"===t.name));i||(i=new jn("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"world2"===t.name));i||(i=new jn("world2"),i.setAsAttribute("world2")),i.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"world3"===t.name));i||(i=new jn("world3"),i.setAsAttribute("world3")),i.output.connectTo(this.world3)}if(!this.world.connectedPoint){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"world"===t.name));i||(i=new jn("world"),i.setAsSystemValue(Dn.World)),i.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(t,i,e,s=!1,n){let r=!1;e.INSTANCES!==s&&(e.setValue("INSTANCES",s),r=!0),n&&e.THIN_INSTANCES!==!!(null==n?void 0:n.getRenderingMesh().hasThinInstances)&&(e.setValue("THIN_INSTANCES",!!(null==n?void 0:n.getRenderingMesh().hasThinInstances)),r=!0),r&&e.markAsUnprocessed()}tD(t){super.tD(t);const i=t.sharedData.scene.getEngine();t.sharedData.blocksWithDefines.push(this);const e=this.YP[0],s=this.YP[1],n=this.world0,r=this.world1,h=this.world2,o=this.world3;return t.compilationString+="#ifdef INSTANCES\r\n",t.compilationString+=this.QP(e,t)+` = mat4(${n.associatedVariableName}, ${r.associatedVariableName}, ${h.associatedVariableName}, ${o.associatedVariableName});\r\n`,t.compilationString+="#ifdef THIN_INSTANCES\r\n",t.compilationString+=`${e.associatedVariableName} = ${this.world.associatedVariableName} * ${e.associatedVariableName};\r\n`,t.compilationString+="#endif\r\n",i.po.canUseGLInstanceID?t.compilationString+=this.QP(s,t)+" = float(gl_InstanceID);\r\n":t.compilationString+=this.QP(s,t)+" = 0.0;\r\n",t.compilationString+="#else\r\n",t.compilationString+=this.QP(e,t)+` = ${this.world.associatedVariableName};\r\n`,t.compilationString+=this.QP(s,t)+" = 0.0;\r\n",t.compilationString+="#endif\r\n",this}});v("BABYLON.MorphTargetsBlock",class extends kn{constructor(t){super(t,bn.Vertex),this.registerInput("position",Mn.Vector3),this.registerInput("normal",Mn.Vector3),this.registerInput("tangent",Mn.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(Mn.Color4|Mn.Vector4|Mn.Vector3),this.registerInput("uv",Mn.Vector2),this.registerOutput("positionOutput",Mn.Vector3),this.registerOutput("normalOutput",Mn.Vector3),this.registerOutput("tangentOutput",Mn.Vector4),this.registerOutput("uvOutput",Mn.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this.xd[0]}get normal(){return this.xd[1]}get tangent(){return this.xd[2]}get uv(){return this.xd[3]}get positionOutput(){return this.YP[0]}get normalOutput(){return this.YP[1]}get tangentOutput(){return this.YP[2]}get uvOutput(){return this.YP[3]}initialize(t){t.AP("morphTargetInfluences")}autoConfigure(t){if(!this.position.isConnected){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"position"===t.name));i||(i=new jn("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.normal.isConnected){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"normal"===t.name));i||(i=new jn("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"tangent"===t.name));i||(i=new jn("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}if(!this.uv.isConnected){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"uv"===t.name));i||(i=new jn("uv"),i.setAsAttribute("uv")),i.output.connectTo(this.uv)}}prepareDefines(t,i,e){if(t.morphTargetManager){const i=t.morphTargetManager;(null==i?void 0:i.isUsingTextureForTargets)&&i.numInfluencers!==e.NUM_MORPH_INFLUENCERS&&e.markAsAttributesDirty()}e.bl&&Fs.PrepareDefinesForMorphTargets(t,e)}bind(t,i,e){e&&e.morphTargetManager&&e.morphTargetManager.numInfluencers>0&&(Fs.BindMorphTargetParameters(e,t),e.morphTargetManager.isUsingTextureForTargets&&e.morphTargetManager.$C(t))}replaceRepeatableContent(t,i,e,s){const n=this.position,r=this.normal,h=this.tangent,o=this.uv,a=this.positionOutput,l=this.normalOutput,c=this.tangentOutput,u=this.uvOutput,f=t,d=s.NUM_MORPH_INFLUENCERS,p=e.morphTargetManager,m=p&&p.supportsNormals&&s.NORMAL,v=p&&p.supportsTangents&&s.TANGENT,g=p&&p.supportsUVs&&s.UV1;let S="";(null==p?void 0:p.isUsingTextureForTargets)&&d>0&&(S+="float vertexID;\r\n");for(let t=0;t<d;t++)S+="#ifdef MORPHTARGETS\r\n",(null==p?void 0:p.isUsingTextureForTargets)?(S+="vertexID = float(gl_VertexID) * morphTargetTextureInfo.x;\r\n",S+=`${a.associatedVariableName} += (readVector3FromRawSampler(${t}, vertexID) - ${n.associatedVariableName}) * morphTargetInfluences[${t}];\r\n`,S+="vertexID += 1.0;\r\n"):S+=`${a.associatedVariableName} += (position${t} - ${n.associatedVariableName}) * morphTargetInfluences[${t}];\r\n`,m&&(S+="#ifdef MORPHTARGETS_NORMAL\r\n",(null==p?void 0:p.isUsingTextureForTargets)?(S+=`${l.associatedVariableName} += (readVector3FromRawSampler(${t}, vertexID) - ${r.associatedVariableName}) * morphTargetInfluences[${t}];\r\n`,S+="vertexID += 1.0;\r\n"):S+=`${l.associatedVariableName} += (normal${t} - ${r.associatedVariableName}) * morphTargetInfluences[${t}];\r\n`,S+="#endif\r\n"),g&&(S+="#ifdef MORPHTARGETS_UV\r\n",(null==p?void 0:p.isUsingTextureForTargets)?(S+=`${u.associatedVariableName} += (readVector3FromRawSampler(${t}, vertexID).xy - ${o.associatedVariableName}) * morphTargetInfluences[${t}];\r\n`,S+="vertexID += 1.0;\r\n"):S+=`${u.associatedVariableName}.xy += (uv_${t} - ${o.associatedVariableName}.xy) * morphTargetInfluences[${t}];\r\n`,S+="#endif\r\n"),v&&(S+="#ifdef MORPHTARGETS_TANGENT\r\n",(null==p?void 0:p.isUsingTextureForTargets)?S+=`${c.associatedVariableName}.xyz += (readVector3FromRawSampler(${t}, vertexID) - ${h.associatedVariableName}.xyz) * morphTargetInfluences[${t}];\r\n`:S+=`${c.associatedVariableName}.xyz += (tangent${t} - ${h.associatedVariableName}.xyz) * morphTargetInfluences[${t}];\r\n`,h.type===Mn.Vector4?S+=`${c.associatedVariableName}.w = ${h.associatedVariableName}.w;\r\n`:S+=`${c.associatedVariableName}.w = 1.;\r\n`,S+="#endif\r\n"),S+="#endif\r\n";if(f.compilationString=f.compilationString.replace(this.gP,S),d>0)for(let t=0;t<d;t++)f.attributes.push(he.PositionKind+t),m&&f.attributes.push(he.NormalKind+t),v&&f.attributes.push(he.TangentKind+t),g&&f.attributes.push(he.UVKind+"_"+t)}tD(t){super.tD(t),t.sharedData.blocksWithDefines.push(this),t.sharedData.bindableBlocks.push(this),t.sharedData.repeatableContentBlocks.push(this);const i=this.position,e=this.normal,s=this.tangent,n=this.uv,r=this.positionOutput,h=this.normalOutput,o=this.tangentOutput,a=this.uvOutput,l=`//${this.name}`;return t.uniforms.push("morphTargetInfluences"),t.uniforms.push("morphTargetTextureInfo"),t.uniforms.push("morphTargetTextureIndices"),t.samplers.push("morphTargets"),t.IP("morphTargetsVertexGlobalDeclaration",l),t.IP("morphTargetsVertexDeclaration",l,{repeatKey:"maxSimultaneousMorphTargets"}),t.compilationString+=`${this.QP(r,t)} = ${i.associatedVariableName};\r\n`,t.compilationString+="#ifdef NORMAL\r\n",t.compilationString+=`${this.QP(h,t)} = ${e.associatedVariableName};\r\n`,t.compilationString+="#else\r\n",t.compilationString+=`${this.QP(h,t)} = vec3(0., 0., 0.);\r\n`,t.compilationString+="#endif\r\n",t.compilationString+="#ifdef TANGENT\r\n",t.compilationString+=`${this.QP(o,t)} = ${s.associatedVariableName};\r\n`,t.compilationString+="#else\r\n",t.compilationString+=`${this.QP(o,t)} = vec4(0., 0., 0., 0.);\r\n`,t.compilationString+="#endif\r\n",t.compilationString+="#ifdef UV1\r\n",t.compilationString+=`${this.QP(a,t)} = ${n.associatedVariableName};\r\n`,t.compilationString+="#else\r\n",t.compilationString+=`${this.QP(a,t)} = vec2(0., 0.);\r\n`,t.compilationString+="#endif\r\n",this.gP=t.gP,t.compilationString+=this.gP,this}});v("BABYLON.LightInformationBlock",class extends kn{constructor(t){super(t,bn.Vertex),this.registerInput("worldPosition",Mn.Vector4,!1,bn.Vertex),this.registerOutput("direction",Mn.Vector3),this.registerOutput("color",Mn.Color3),this.registerOutput("intensity",Mn.Float),this.registerOutput("shadowBias",Mn.Float),this.registerOutput("shadowNormalBias",Mn.Float),this.registerOutput("shadowDepthScale",Mn.Float),this.registerOutput("shadowDepthRange",Mn.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this.xd[0]}get direction(){return this.YP[0]}get color(){return this.YP[1]}get intensity(){return this.YP[2]}get shadowBias(){return this.YP[3]}get shadowNormalBias(){return this.YP[4]}get shadowDepthScale(){return this.YP[5]}get shadowDepthRange(){return this.YP[6]}bind(t,i,e){if(!e)return;this.light&&this.light.isDisposed()&&(this.light=null);let s=this.light;const n=i.getScene();if(!s&&n.lights.length&&(s=this.light=n.lights[0],this.aht=!0),!s||!s.isEnabled)return t.setFloat3(this.lht,0,0,0),void t.setFloat4(this.cht,0,0,0,0);s.transferToNodeMaterialEffect(t,this.lht),t.setColor4(this.cht,s.diffuse,s.intensity);const r=s.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(r?t.setFloat3(this.uht,r.bias,r.normalBias,r.depthScale):t.setFloat3(this.uht,0,0,0)),this.shadowDepthRange)if(r&&n.activeCamera){const i=s;t.setFloat2(this.fht,i.getDepthMinZ(n.activeCamera),i.getDepthMinZ(n.activeCamera)+i.getDepthMaxZ(n.activeCamera))}else t.setFloat2(this.fht,0,0)}prepareDefines(t,i,e){if(!e.Il&&!this.aht)return;this.aht=!1;const s=this.light;e.setValue(this.dht,!!(s&&s instanceof LE),!0)}tD(t){super.tD(t),t.sharedData.bindableBlocks.push(this),t.sharedData.blocksWithDefines.push(this);const i=this.direction,e=this.color,s=this.intensity,n=this.shadowBias,r=this.shadowNormalBias,h=this.shadowDepthScale,o=this.shadowDepthRange;return this.lht=t.SP("lightData"),this.cht=t.SP("lightColor"),this.uht=t.SP("shadowData"),this.fht=t.SP("shadowExtraData"),this.dht=t.EP("LIGHTPOINTTYPE"),t._P(this.lht,"vec3"),t._P(this.cht,"vec4"),t.compilationString+=`#ifdef ${this.dht}\r\n`,t.compilationString+=this.QP(i,t)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${this.lht});\r\n`,t.compilationString+="#else\r\n",t.compilationString+=this.QP(i,t)+` = ${this.lht};\r\n`,t.compilationString+="#endif\r\n",t.compilationString+=this.QP(e,t)+` = ${this.cht}.rgb;\r\n`,t.compilationString+=this.QP(s,t)+` = ${this.cht}.a;\r\n`,(n.hasEndpoints||r.hasEndpoints||h.hasEndpoints)&&(t._P(this.uht,"vec3"),n.hasEndpoints&&(t.compilationString+=this.QP(n,t)+` = ${this.uht}.x;\r\n`),r.hasEndpoints&&(t.compilationString+=this.QP(r,t)+` = ${this.uht}.y;\r\n`),h.hasEndpoints&&(t.compilationString+=this.QP(h,t)+` = ${this.uht}.z;\r\n`)),o.hasEndpoints&&(t._P(this.fht,"vec2"),t.compilationString+=this.QP(o,t)+` = ${this.uht};\r\n`),this}serialize(){const t=super.serialize();return this.light&&(t.lightId=this.light.id),t}uD(t,i,e){super.uD(t,i,e),t.lightId&&(this.light=i.getLightById(t.lightId))}});class FA extends kn{constructor(t){super(t,bn.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",Mn.AutoDetect),this.registerOutput("output",Mn.Color4),this.registerOutput("rgb",Mn.Color3),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Color4|Mn.Vector3|Mn.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this.xd[0]}get output(){return this.YP[0]}get rgb(){return this.YP[1]}initialize(t){t.AP("exposureLinear"),t.AP("contrast"),t.AP("vInverseScreenSize"),t.AP("vignetteSettings1"),t.AP("vignetteSettings2"),t.AP("vCameraColorCurveNegative"),t.AP("vCameraColorCurveNeutral"),t.AP("vCameraColorCurvePositive"),t.AP("txColorTransform"),t.AP("colorTransformSettings"),t.AP("ditherIntensity")}isReady(t,i,e){return!(e.Dl&&i.imageProcessingConfiguration&&!i.imageProcessingConfiguration.isReady())}prepareDefines(t,i,e){e.Dl&&i.imageProcessingConfiguration&&i.imageProcessingConfiguration.prepareDefines(e)}bind(t,i,e){e&&i.imageProcessingConfiguration&&i.imageProcessingConfiguration.bind(t)}tD(t){var i;super.tD(t),t.sharedData.blocksWithDefines.push(this),t.sharedData.blockingBlocks.push(this),t.sharedData.bindableBlocks.push(this),t.uniforms.push("exposureLinear"),t.uniforms.push("contrast"),t.uniforms.push("vInverseScreenSize"),t.uniforms.push("vignetteSettings1"),t.uniforms.push("vignetteSettings2"),t.uniforms.push("vCameraColorCurveNegative"),t.uniforms.push("vCameraColorCurveNeutral"),t.uniforms.push("vCameraColorCurvePositive"),t.uniforms.push("txColorTransform"),t.uniforms.push("colorTransformSettings"),t.uniforms.push("ditherIntensity");const e=this.color,s=this.YP[0],n=`//${this.name}`;return t.IP("helperFunctions",n),t.IP("imageProcessingDeclaration",n),t.IP("imageProcessingFunctions",n),(null===(i=e.connectedPoint)||void 0===i?void 0:i.isConnected)&&(e.connectedPoint.type===Mn.Color4||e.connectedPoint.type===Mn.Vector4?t.compilationString+=`${this.QP(s,t)} = ${e.associatedVariableName};\r\n`:t.compilationString+=`${this.QP(s,t)} = vec4(${e.associatedVariableName}, 1.0);\r\n`,t.compilationString+="#ifdef IMAGEPROCESSINGPOSTPROCESS\r\n",this.convertInputToLinearSpace&&(t.compilationString+=`${s.associatedVariableName}.rgb = toLinearSpace(${e.associatedVariableName}.rgb);\r\n`),t.compilationString+="#else\r\n",t.compilationString+="#ifdef IMAGEPROCESSING\r\n",this.convertInputToLinearSpace&&(t.compilationString+=`${s.associatedVariableName}.rgb = toLinearSpace(${e.associatedVariableName}.rgb);\r\n`),t.compilationString+=`${s.associatedVariableName} = applyImageProcessing(${s.associatedVariableName});\r\n`,t.compilationString+="#endif\r\n",t.compilationString+="#endif\r\n",this.rgb.hasEndpoints&&(t.compilationString+=this.QP(this.rgb,t)+` = ${this.output.associatedVariableName}.xyz;\r\n`)),this}aD(){let t=super.aD();return t+=`${this.$P}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};\r\n`,t}serialize(){const t=super.serialize();return t.convertInputToLinearSpace=this.convertInputToLinearSpace,t}uD(t,i,e){var s;super.uD(t,i,e),this.convertInputToLinearSpace=null===(s=t.convertInputToLinearSpace)||void 0===s||s}}ut([Hn("Convert input to linear space",Nn.Boolean,"ADVANCED")],FA.prototype,"convertInputToLinearSpace",void 0),v("BABYLON.ImageProcessingBlock",FA);class BA extends kn{constructor(t){super(t,bn.Fragment,!0),this.registerInput("normal",Mn.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(Mn.Color4|Mn.Vector4|Mn.Vector3),this.registerInput("tangent",Mn.Vector4,!1),this.registerInput("world",Mn.Matrix,!1),this.registerOutput("TBN",Mn.Object,bn.Fragment,new OA("TBN",this,yn.Output,BA,"TBNBlock")),this.registerOutput("row0",Mn.Vector3,bn.Fragment),this.registerOutput("row1",Mn.Vector3,bn.Fragment),this.registerOutput("row2",Mn.Vector3,bn.Fragment)}getClassName(){return"TBNBlock"}initialize(t){t.AP("tbnNormal"),t.AP("tbnTangent"),t.AP("tbnBitangent"),t.AP("TBN")}get normal(){return this.xd[0]}get tangent(){return this.xd[1]}get world(){return this.xd[2]}get TBN(){return this.YP[0]}get row0(){return this.YP[1]}get row1(){return this.YP[2]}get row2(){return this.YP[3]}get target(){return bn.Fragment}set target(t){}autoConfigure(t){if(!this.world.isConnected){let i=t.getInputBlockByPredicate((t=>t.isSystemValue&&t.systemValue===Dn.World));i||(i=new jn("world"),i.setAsSystemValue(Dn.World)),i.output.connectTo(this.world)}if(!this.normal.isConnected){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"normal"===t.name));i||(i=new jn("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"tangent"===t.name&&t.type===Mn.Vector4));i||(i=new jn("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}}prepareDefines(t,i,e){var s,n,r,h;const o=this.normal,a=this.tangent;let l=o.isConnected;(null===(s=o.connectInputBlock)||void 0===s?void 0:s.isAttribute)&&!t.isVerticesDataPresent(null===(n=o.connectInputBlock)||void 0===n?void 0:n.name)&&(l=!1);let c=a.isConnected;(null===(r=a.connectInputBlock)||void 0===r?void 0:r.isAttribute)&&!t.isVerticesDataPresent(null===(h=a.connectInputBlock)||void 0===h?void 0:h.name)&&(c=!1);const u=l&&c;e.setValue("TBNBLOCK",u,!0)}tD(t){super.tD(t);const i=this.normal,e=this.tangent,s=this.world,n=this.TBN,r=this.row0,h=this.row1,o=this.row2;return t.target===bn.Fragment&&(t.compilationString+=`\n                // ${this.name}\n                vec3 tbnNormal = normalize(${i.associatedVariableName}).xyz;\n                vec3 tbnTangent = normalize(${e.associatedVariableName}.xyz);\n                vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${e.associatedVariableName}.w;\n                mat3 ${n.associatedVariableName} = mat3(${s.associatedVariableName}) * mat3(tbnTangent, tbnBitangent, tbnNormal);\n            `,r.hasEndpoints&&(t.compilationString+=this.QP(r,t)+` = vec3(${n.associatedVariableName}[0][0], ${n.associatedVariableName}[0][1], ${n.associatedVariableName}[0][2]);\r\n`),h.hasEndpoints&&(t.compilationString+=this.QP(h,t)+` = vec3(${n.associatedVariableName}[1[0], ${n.associatedVariableName}[1][1], ${n.associatedVariableName}[1][2]);\r\n`),o.hasEndpoints&&(t.compilationString+=this.QP(o,t)+` = vec3(${n.associatedVariableName}[2][0], ${n.associatedVariableName}[2][1], ${n.associatedVariableName}[2][2]);\r\n`),t.sharedData.blocksWithDefines.push(this)),this}}v("BABYLON.TBNBlock",BA);class UA extends kn{constructor(t){super(t,bn.Fragment),this.pht="",this.mht="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.WP=!0,this.registerInput("worldPosition",Mn.Vector4,!1),this.registerInput("worldNormal",Mn.Vector4,!1),this.registerInput("worldTangent",Mn.Vector4,!0),this.registerInput("uv",Mn.Vector2,!1),this.registerInput("normalMapColor",Mn.Color3,!1),this.registerInput("strength",Mn.Float,!1),this.registerInput("viewDirection",Mn.Vector3,!0),this.registerInput("parallaxScale",Mn.Float,!0),this.registerInput("parallaxHeight",Mn.Float,!0),this.registerInput("TBN",Mn.Object,!0,bn.VertexAndFragment,new OA("TBN",this,yn.Input,BA,"TBNBlock")),this.registerOutput("output",Mn.Vector4),this.registerOutput("uvOffset",Mn.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this.xd[0]}get worldNormal(){return this.xd[1]}get worldTangent(){return this.xd[2]}get uv(){return this.xd[3]}get normalMapColor(){return this.xd[4]}get strength(){return this.xd[5]}get viewDirection(){return this.xd[6]}get parallaxScale(){return this.xd[7]}get parallaxHeight(){return this.xd[8]}get TBN(){return this.xd[9]}get output(){return this.YP[0]}get uvOffset(){return this.YP[1]}prepareDefines(t,i,e){const s=this.normalMapColor.connectedPoint.kP.samplerName,n=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&s||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);e.setValue("BUMP",!0),e.setValue("PARALLAX",n,!0),e.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0)}bind(t,i,e){i.getScene().Ag?t.setFloat2(this.pht,this.invertX?1:-1,this.invertY?1:-1):t.setFloat2(this.pht,this.invertX?-1:1,this.invertY?-1:1),e&&t.setFloat(this.mht,e.getWorldMatrix().determinant()<0?-1:1)}autoConfigure(t){if(!this.uv.isConnected){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"uv"===t.name));i||(i=new jn("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){const t=new jn("strength");t.value=1,t.output.connectTo(this.strength)}}tD(t){super.tD(t);const i=`//${this.name}`,e=this.uv,s=this.worldPosition,n=this.worldNormal,r=this.worldTangent;t.sharedData.blocksWithDefines.push(this),t.sharedData.bindableBlocks.push(this),this.pht=t.EP("tangentSpaceParameter"),t._P(this.pht,"vec2"),this.mht=t.EP("tangentCorrectionFactor"),t._P(this.mht,"float");let h=null;this.normalMapColor.connectedPoint&&(h=this.normalMapColor.connectedPoint.kP.samplerName);const o=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&h||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),a=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?t.yP(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",l=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\r\n#if !defined(NORMALXYSCALE)\r\n1.0/\r\n#endif\r\n${t.yP(this.strength.connectInputBlock.value)}`:`\r\n#if !defined(NORMALXYSCALE)\r\n1.0/\r\n#endif\r\n${this.strength.associatedVariableName}`;t.xP("derivatives","#extension GL_OES_standard_derivatives : enable");const c={search:/defined\(TANGENT\)/g,replace:r.isConnected?"defined(TANGENT)":"defined(IGNORE)"},u=this.TBN;u.isConnected?t.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${u.associatedVariableName};\n            #endif\n            `:r.isConnected&&(t.compilationString+=`vec3 tbnNormal = normalize(${n.associatedVariableName}.xyz);\r\n`,t.compilationString+=`vec3 tbnTangent = normalize(${r.associatedVariableName}.xyz);\r\n`,t.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this.mht};\r\n`,t.compilationString+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r\n"),t.IP("bumpFragmentMainFunctions",i,{replaceStrings:[c,{search:/varying mat3 vTBN/g,replace:""}]}),t.IP("bumpFragmentFunctions",i,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,replace:"#define inline\r\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)"},{search:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g,replace:"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)"},{search:/texture2D\(bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const f=o&&h?`texture2D(${h}, ${e.associatedVariableName} + uvOffset).xyz`:this.normalMapColor.associatedVariableName;return t.compilationString+=this.QP(this.output,t)+" = vec4(0.);\r\n",t.compilationString+=t.RP("bumpFragment",i,{replaceStrings:[{search:/perturbNormal\(TBN,texture2D\(bumpSampler,vBumpUV\+uvOffset\).xyz,vBumpInfos.y\)/g,replace:`perturbNormal(TBN, ${f}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${o&&this.useParallaxOcclusion?h:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${o?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vTangentSpaceParams/g,replace:this.pht},{search:/vBumpInfos.y/g,replace:l},{search:/vBumpInfos.z/g,replace:a},{search:/vBumpUV/g,replace:e.associatedVariableName},{search:/vPositionW/g,replace:s.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:n.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:o?this.viewDirection.associatedVariableName:"vec3(0.)"},c]}),this}aD(){let t=super.aD()+`${this.$P}.invertX = ${this.invertX};\r\n`;return t+=`${this.$P}.invertY = ${this.invertY};\r\n`,t+=`${this.$P}.useParallaxOcclusion = ${this.useParallaxOcclusion};\r\n`,t}serialize(){const t=super.serialize();return t.invertX=this.invertX,t.invertY=this.invertY,t.useParallaxOcclusion=this.useParallaxOcclusion,t}uD(t,i,e){super.uD(t,i,e),this.invertX=t.invertX,this.invertY=t.invertY,this.useParallaxOcclusion=!!t.useParallaxOcclusion}}ut([Hn("Invert X axis",Nn.Boolean,"PROPERTIES",{notifiers:{update:!1}})],UA.prototype,"invertX",void 0),ut([Hn("Invert Y axis",Nn.Boolean,"PROPERTIES",{notifiers:{update:!1}})],UA.prototype,"invertY",void 0),ut([Hn("Use parallax occlusion",Nn.Boolean)],UA.prototype,"useParallaxOcclusion",void 0),v("BABYLON.PerturbNormalBlock",UA);v("BABYLON.DiscardBlock",class extends kn{constructor(t){super(t,bn.Fragment,!0),this.registerInput("value",Mn.Float,!0),this.registerInput("cutoff",Mn.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this.xd[0]}get cutoff(){return this.xd[1]}tD(t){if(super.tD(t),t.sharedData.hints.needAlphaTesting=!0,this.cutoff.isConnected&&this.value.isConnected)return t.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) discard;\r\n`,this}});v("BABYLON.FrontFacingBlock",class extends kn{constructor(t){super(t,bn.Fragment),this.registerOutput("output",Mn.Float,bn.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this.YP[0]}tD(t){if(super.tD(t),t.target===bn.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";const i=this.YP[0];return t.compilationString+=this.QP(i,t)+" = gl_FrontFacing ? 1.0 : 0.0;\r\n",this}});v("BABYLON.DerivativeBlock",class extends kn{constructor(t){super(t,bn.Fragment),this.registerInput("input",Mn.AutoDetect,!1),this.registerOutput("dx",Mn.BasedOnInput),this.registerOutput("dy",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.YP[1].DP=this.xd[0]}getClassName(){return"DerivativeBlock"}get input(){return this.xd[0]}get dx(){return this.YP[0]}get dy(){return this.YP[1]}tD(t){super.tD(t);const i=this.YP[0],e=this.YP[1];return t.xP("derivatives","#extension GL_OES_standard_derivatives : enable"),i.hasEndpoints&&(t.compilationString+=this.QP(i,t)+` = dFdx(${this.input.associatedVariableName});\r\n`),e.hasEndpoints&&(t.compilationString+=this.QP(e,t)+` = dFdy(${this.input.associatedVariableName});\r\n`),this}});v("BABYLON.FragCoordBlock",class extends kn{constructor(t){super(t,bn.Fragment),this.registerOutput("xy",Mn.Vector2,bn.Fragment),this.registerOutput("xyz",Mn.Vector3,bn.Fragment),this.registerOutput("xyzw",Mn.Vector4,bn.Fragment),this.registerOutput("x",Mn.Float,bn.Fragment),this.registerOutput("y",Mn.Float,bn.Fragment),this.registerOutput("z",Mn.Float,bn.Fragment),this.registerOutput("w",Mn.Float,bn.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this.YP[0]}get xyz(){return this.YP[1]}get xyzw(){return this.YP[2]}get x(){return this.YP[3]}get y(){return this.YP[4]}get z(){return this.YP[5]}get output(){return this.YP[6]}writeOutputs(t){let i="";for(const e of this.YP)e.hasEndpoints&&(i+=`${this.QP(e,t)} = gl_FragCoord.${e.name};\r\n`);return i}tD(t){if(super.tD(t),t.target===bn.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return t.compilationString+=this.writeOutputs(t),this}});v("BABYLON.ScreenSizeBlock",class extends kn{constructor(t){super(t,bn.Fragment),this.registerOutput("xy",Mn.Vector2,bn.Fragment),this.registerOutput("x",Mn.Float,bn.Fragment),this.registerOutput("y",Mn.Float,bn.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this.YP[0]}get x(){return this.YP[1]}get y(){return this.YP[2]}bind(t){const i=this.Kt.getEngine();t.setFloat2(this.vht,i.getRenderWidth(),i.getRenderHeight())}writeOutputs(t,i){let e="";for(const s of this.YP)s.hasEndpoints&&(e+=`${this.QP(s,t)} = ${i}.${s.name};\r\n`);return e}tD(t){if(super.tD(t),this.Kt=t.sharedData.scene,t.target===bn.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return t.sharedData.bindableBlocks.push(this),this.vht=t.SP("screenSize"),t._P(this.vht,"vec2"),t.compilationString+=this.writeOutputs(t,this.vht),this}});v("BABYLON.ScreenSpaceBlock",class extends kn{constructor(t){super(t,bn.Fragment),this.registerInput("vector",Mn.AutoDetect),this.registerInput("worldViewProjection",Mn.Matrix),this.registerOutput("output",Mn.Vector2),this.registerOutput("x",Mn.Float),this.registerOutput("y",Mn.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Vector3|Mn.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this.xd[0]}get worldViewProjection(){return this.xd[1]}get output(){return this.YP[0]}get x(){return this.YP[1]}get y(){return this.YP[2]}autoConfigure(t){if(!this.worldViewProjection.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.WorldViewProjection));i||(i=new jn("worldViewProjection"),i.setAsSystemValue(Dn.WorldViewProjection)),i.output.connectTo(this.worldViewProjection)}}tD(t){super.tD(t);const i=this.vector,e=this.worldViewProjection;if(!i.connectedPoint)return;const s=e.associatedVariableName,n=t.SP("screenSpaceTemp");switch(i.connectedPoint.type){case Mn.Vector3:t.compilationString+=`vec4 ${n} = ${s} * vec4(${i.associatedVariableName}, 1.0);\r\n`;break;case Mn.Vector4:t.compilationString+=`vec4 ${n} = ${s} * ${i.associatedVariableName};\r\n`}return t.compilationString+=`${n}.xy /= ${n}.w;`,t.compilationString+=`${n}.xy = ${n}.xy * 0.5 + vec2(0.5, 0.5);`,this.output.hasEndpoints&&(t.compilationString+=this.QP(this.output,t)+` = ${n}.xy;\r\n`),this.x.hasEndpoints&&(t.compilationString+=this.QP(this.x,t)+` = ${n}.x;\r\n`),this.y.hasEndpoints&&(t.compilationString+=this.QP(this.y,t)+` = ${n}.y;\r\n`),this}});v("BABYLON.TwirlBlock",class extends kn{constructor(t){super(t,bn.Fragment),this.registerInput("input",Mn.Vector2),this.registerInput("strength",Mn.Float),this.registerInput("center",Mn.Vector2),this.registerInput("offset",Mn.Vector2),this.registerOutput("output",Mn.Vector2),this.registerOutput("x",Mn.Float),this.registerOutput("y",Mn.Float)}getClassName(){return"TwirlBlock"}get input(){return this.xd[0]}get strength(){return this.xd[1]}get center(){return this.xd[2]}get offset(){return this.xd[3]}get output(){return this.YP[0]}get x(){return this.YP[1]}get y(){return this.YP[2]}autoConfigure(){if(!this.center.isConnected){const t=new jn("center");t.value=new C(.5,.5),t.output.connectTo(this.center)}if(!this.strength.isConnected){const t=new jn("strength");t.value=1,t.output.connectTo(this.strength)}if(!this.offset.isConnected){const t=new jn("offset");t.value=new C(0,0),t.output.connectTo(this.offset)}}tD(t){super.tD(t);const i=t.SP("delta"),e=t.SP("angle"),s=t.SP("x"),n=t.SP("y"),r=t.SP("result");return t.compilationString+=`\n            vec2 ${i} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};\n            float ${e} = ${this.strength.associatedVariableName} * length(${i});\n            float ${s} = cos(${e}) * ${i}.x - sin(${e}) * ${i}.y;\n            float ${n} = sin(${e}) * ${i}.x + cos(${e}) * ${i}.y;\n            vec2 ${r} = vec2(${s} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${n} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);\n        `,this.output.hasEndpoints&&(t.compilationString+=this.QP(this.output,t)+` = ${r};\r\n`),this.x.hasEndpoints&&(t.compilationString+=this.QP(this.x,t)+` = ${r}.x;\r\n`),this.y.hasEndpoints&&(t.compilationString+=this.QP(this.y,t)+` = ${r}.y;\r\n`),this}});class VA extends kn{constructor(t){super(t,bn.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",Mn.Float),this.registerInput("worldPosition",Mn.Vector3),this.registerInput("worldNormal",Mn.Vector3),this.registerInput("worldTangent",Mn.AutoDetect,!0),this.registerOutput("output",Mn.Vector4),this.registerOutput("xyz",Mn.Vector3),this.xd[3].addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Vector3|Mn.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this.xd[0]}get worldPosition(){return this.xd[1]}get worldNormal(){return this.xd[2]}get worldTangent(){return this.xd[3]}get output(){return this.YP[0]}get xyz(){return this.YP[1]}tD(t){super.tD(t);const i=this.YP[0];this.generateInWorldSpace||this.worldTangent.isConnected||console.error(`You must connect the 'worldTangent' input of the ${this.name} block!`);const e=this.generateInWorldSpace?"":"\n            vec3 biTangent = cross(normal, tangent);\n            mat3 TBN = mat3(tangent, biTangent, normal);\n            ",s=this.generateInWorldSpace?"":"\n            result = TBN * result;\n            result = result * vec3(0.5) + vec3(0.5);\n            ",n=`\n            vec4 heightToNormal(in float height, in vec3 position, in vec3 tangent, in vec3 normal) {\n                ${e}\n                ${this.automaticNormalizationTangent?"tangent = normalize(tangent);":""}\n                ${this.automaticNormalizationNormal?"normal = normalize(normal);":""}\n                vec3 worlddX = dFdx(position);\n                vec3 worlddY = dFdy(position);\n                vec3 crossX = cross(normal, worlddX);\n                vec3 crossY = cross(normal, worlddY);\n                float d = abs(dot(crossY, worlddX));\n                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));\n                inToNormal.y *= -1.0;\n                vec3 result = normalize((d * normal) - inToNormal);\n                ${s}\n                return vec4(result, 0.);\n            }`;return t.xP("derivatives","#extension GL_OES_standard_derivatives : enable"),t.TP("heightToNormal",n,"// heightToNormal"),t.compilationString+=this.QP(i,t)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:"vec3(0.)"}.xyz, ${this.worldNormal.associatedVariableName});\r\n`,this.xyz.hasEndpoints&&(t.compilationString+=this.QP(this.xyz,t)+` = ${this.output.associatedVariableName}.xyz;\r\n`),this}aD(){let t=super.aD();return t+=`${this.$P}.generateInWorldSpace = ${this.generateInWorldSpace};\r\n`,t+=`${this.$P}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};\r\n`,t+=`${this.$P}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};\r\n`,t}serialize(){const t=super.serialize();return t.generateInWorldSpace=this.generateInWorldSpace,t.automaticNormalizationNormal=this.automaticNormalizationNormal,t.automaticNormalizationTangent=this.automaticNormalizationTangent,t}uD(t,i,e){super.uD(t,i,e),this.generateInWorldSpace=t.generateInWorldSpace,this.automaticNormalizationNormal=t.automaticNormalizationNormal,this.automaticNormalizationTangent=t.automaticNormalizationTangent}}ut([Hn("Generate in world space instead of tangent space",Nn.Boolean,"PROPERTIES",{notifiers:{update:!0}})],VA.prototype,"generateInWorldSpace",void 0),ut([Hn("Force normalization for the worldNormal input",Nn.Boolean,"PROPERTIES",{notifiers:{update:!0}})],VA.prototype,"automaticNormalizationNormal",void 0),ut([Hn("Force normalization for the worldTangent input",Nn.Boolean,"PROPERTIES",{notifiers:{update:!0}})],VA.prototype,"automaticNormalizationTangent",void 0),v("BABYLON.HeightToNormalBlock",VA);v("BABYLON.FragDepthBlock",class extends kn{constructor(t){super(t,bn.Fragment,!0),this.registerInput("depth",Mn.Float,!0),this.registerInput("worldPos",Mn.Vector4,!0),this.registerInput("viewProjection",Mn.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this.xd[0]}get worldPos(){return this.xd[1]}get viewProjection(){return this.xd[2]}tD(t){return super.tD(t),this.depth.isConnected?t.compilationString+=`gl_FragDepth = ${this.depth.associatedVariableName};\r\n`:this.worldPos.isConnected&&this.viewProjection.isConnected?t.compilationString+=`\n                vec4 p = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};\n                float v = p.z / p.w;\n                #ifndef IS_NDC_HALF_ZRANGE\n                    v = v * 0.5 + 0.5;\n                #endif\n                gl_FragDepth = v;\n    \n            `:console.warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}});v("BABYLON.ShadowMapBlock",class extends kn{constructor(t){super(t,bn.Fragment),this.registerInput("worldPosition",Mn.Vector4,!1),this.registerInput("viewProjection",Mn.Matrix,!1),this.registerInput("worldNormal",Mn.AutoDetect,!0),this.registerOutput("depth",Mn.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Vector3|Mn.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(t){t.AP("vPositionWSM"),t.AP("lightDataSM"),t.AP("biasAndScaleSM"),t.AP("depthValuesSM"),t.AP("clipPos"),t.AP("worldPos"),t.AP("zSM")}get worldPosition(){return this.xd[0]}get viewProjection(){return this.xd[1]}get worldNormal(){return this.xd[2]}get depth(){return this.YP[0]}tD(t){super.tD(t);const i=`//${this.name}`;return t._P("biasAndScaleSM","vec3"),t._P("lightDataSM","vec3"),t._P("depthValuesSM","vec2"),t.IP("packingFunctions",i),t.compilationString+=`vec4 worldPos = ${this.worldPosition.associatedVariableName};\r\n`,t.compilationString+="vec3 vPositionWSM;\r\n",t.compilationString+="float vDepthMetricSM = 0.0;\r\n",t.compilationString+="float zSM;\r\n",this.worldNormal.isConnected&&(t.compilationString+=`vec3 vNormalW = ${this.worldNormal.associatedVariableName}.xyz;\r\n`,t.compilationString+=t.RP("shadowMapVertexNormalBias",i)),t.compilationString+=`vec4 clipPos = ${this.viewProjection.associatedVariableName} * worldPos;\r\n`,t.compilationString+=t.RP("shadowMapVertexMetric",i,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"}]}),t.compilationString+=t.RP("shadowMapFragment",i,{replaceStrings:[{search:/return;/g,replace:""}]}),t.compilationString+="\n            #if SM_DEPTHTEXTURE == 1\n                #ifdef IS_NDC_HALF_ZRANGE\n                    gl_FragDepth = (clipPos.z / clipPos.w);\n                #else\n                    gl_FragDepth = (clipPos.z / clipPos.w) * 0.5 + 0.5;\n                #endif\n            #endif\n        ",t.compilationString+=`${this.QP(this.depth,t)} = vec3(depthSM, 1., 1.);\r\n`,this}});v("BABYLON.FogBlock",class extends kn{constructor(t){super(t,bn.VertexAndFragment,!1),this.registerInput("worldPosition",Mn.Vector4,!1,bn.Vertex),this.registerInput("view",Mn.Matrix,!1,bn.Vertex),this.registerInput("input",Mn.AutoDetect,!1,bn.Fragment),this.registerInput("fogColor",Mn.AutoDetect,!1,bn.Fragment),this.registerOutput("output",Mn.Color3,bn.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Vector3|Mn.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Vector3|Mn.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this.xd[0]}get view(){return this.xd[1]}get input(){return this.xd[2]}get fogColor(){return this.xd[3]}get output(){return this.YP[0]}autoConfigure(t){if(!this.view.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.View));i||(i=new jn("view"),i.setAsSystemValue(Dn.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.FogColor));i||(i=new jn("fogColor",void 0,Mn.Color3),i.setAsSystemValue(Dn.FogColor)),i.output.connectTo(this.fogColor)}}prepareDefines(t,i,e){const s=t.getScene();e.setValue("FOG",i.fogEnabled&&Fs.GetFogState(t,s))}bind(t,i,e){if(!e)return;const s=e.getScene();t.setFloat4(this.ght,s.fogMode,s.fogStart,s.fogEnd,s.fogDensity)}tD(t){if(super.tD(t),t.target===bn.Fragment){t.sharedData.blocksWithDefines.push(this),t.sharedData.bindableBlocks.push(this),t.IP("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});const i=t.SP("fog"),e=this.input,s=this.fogColor;this.ght=t.SP("fogParameters");const n=this.YP[0];t._P(this.ght,"vec4"),t.compilationString+="#ifdef FOG\r\n",t.compilationString+=`float ${i} = CalcFogFactor(${this.Sht}, ${this.ght});\r\n`,t.compilationString+=this.QP(n,t)+` = ${i} * ${e.associatedVariableName}.rgb + (1.0 - ${i}) * ${s.associatedVariableName}.rgb;\r\n`,t.compilationString+=`#else\r\n${this.QP(n,t)} =  ${e.associatedVariableName}.rgb;\r\n`,t.compilationString+="#endif\r\n"}else{const i=this.worldPosition,e=this.view;this.Sht=t.SP("vFogDistance"),t.bP(this.Sht,"vec3"),t.compilationString+=`${this.Sht} = (${e.associatedVariableName} * ${i.associatedVariableName}).xyz;\r\n`}return this}});class kA extends kn{constructor(t){super(t,bn.VertexAndFragment),this.Eht=0,this.generateOnlyFragmentCode=!1,this.WP=!0,this.registerInput("worldPosition",Mn.Vector4,!1,bn.Vertex),this.registerInput("worldNormal",Mn.Vector4,!1,bn.Fragment),this.registerInput("cameraPosition",Mn.Vector3,!1,bn.Fragment),this.registerInput("glossiness",Mn.Float,!0,bn.Fragment),this.registerInput("glossPower",Mn.Float,!0,bn.Fragment),this.registerInput("diffuseColor",Mn.Color3,!0,bn.Fragment),this.registerInput("specularColor",Mn.Color3,!0,bn.Fragment),this.registerInput("view",Mn.Matrix,!0),this.registerOutput("diffuseOutput",Mn.Color3,bn.Fragment),this.registerOutput("specularOutput",Mn.Color3,bn.Fragment),this.registerOutput("shadow",Mn.Float,bn.Fragment)}static Aht(t,i){const e=t;return e.worldPosition.isConnected?(e.generateOnlyFragmentCode=!e.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(e.Cht(),!0)}Cht(){this.qP(this.generateOnlyFragmentCode?bn.Fragment:bn.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?bn.Fragment:bn.Vertex}getClassName(){return"LightBlock"}get worldPosition(){return this.xd[0]}get worldNormal(){return this.xd[1]}get cameraPosition(){return this.xd[2]}get glossiness(){return this.xd[3]}get glossPower(){return this.xd[4]}get diffuseColor(){return this.xd[5]}get specularColor(){return this.xd[6]}get view(){return this.xd[7]}get diffuseOutput(){return this.YP[0]}get specularOutput(){return this.YP[1]}get shadow(){return this.YP[2]}autoConfigure(t){if(!this.cameraPosition.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.CameraPosition));i||(i=new jn("cameraPosition"),i.setAsSystemValue(Dn.CameraPosition)),i.output.connectTo(this.cameraPosition)}}prepareDefines(t,i,e){if(!e.Il)return;const s=t.getScene();if(this.light){const i={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Fs.PrepareDefinesForLight(s,t,this.light,this.Eht,e,!0,i),i.needRebuild&&e.rebuild()}else Fs.PrepareDefinesForLights(s,t,e,!0,i.maxSimultaneousLights)}updateUniformsAndSamples(t,i,e,s){for(let n=0;n<i.maxSimultaneousLights&&e["LIGHT"+n];n++){const i=t.uniforms.indexOf("vLightData"+n)>=0;Fs.PrepareUniformsAndSamplersForLight(n,t.uniforms,t.samplers,e["PROJECTEDLIGHTTEXTURE"+n],s,i)}}bind(t,i,e){if(!e)return;const s=e.getScene();this.light?Fs.BindLight(this.light,this.Eht,s,t,!0):Fs.BindLights(s,e,t,!0,i.maxSimultaneousLights)}MD(t){const i=this.worldPosition,e=`//${this.name}`;this.light?(this.Eht=(void 0!==t.counters.lightCounter?t.counters.lightCounter:-1)+1,t.counters.lightCounter=this.Eht,t.IP(t.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",e,{replaceStrings:[{search:/{X}/g,replace:this.Eht.toString()}]},this.Eht.toString())):(t.IP(t.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",e,{repeatKey:"maxSimultaneousLights"}),this.Eht=0,t.sharedData.dynamicUniformBlocks.push(this));const s="v_"+i.associatedVariableName;t.bP(s,"vec4")&&(t.compilationString+=`${s} = ${i.associatedVariableName};\r\n`),this.light?t.compilationString+=t.RP("shadowsVertex",e,{replaceStrings:[{search:/{X}/g,replace:this.Eht.toString()},{search:/worldPos/g,replace:i.associatedVariableName}]}):(t.compilationString+=`vec4 worldPos = ${i.associatedVariableName};\r\n`,this.view.isConnected&&(t.compilationString+=`mat4 view = ${this.view.associatedVariableName};\r\n`),t.compilationString+=t.RP("shadowsVertex",e,{repeatKey:"maxSimultaneousLights"}))}tD(t){if(super.tD(t),t.target!==bn.Fragment)return void this.MD(t);this.generateOnlyFragmentCode&&t.sharedData.dynamicUniformBlocks.push(this),t.sharedData.forcedBindableBlocks.push(this),t.sharedData.blocksWithDefines.push(this);const i=`//${this.name}`,e=this.worldPosition;let s=e.associatedVariableName;this.generateOnlyFragmentCode?(s=t.SP("globalWorldPos"),t.TP("light_globalworldpos",`vec3 ${s};\r\n`,i),t.compilationString+=`${s} = ${e.associatedVariableName}.xyz;\r\n`,t.compilationString+=t.RP("shadowsVertex",i,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${e.associatedVariableName}`:void 0})):s="v_"+s+".xyz",t.IP("helperFunctions",i),t.IP("lightsFragmentFunctions",i,{replaceStrings:[{search:/vPositionW/g,replace:s}]}),t.IP("shadowsFragmentFunctions",i,{replaceStrings:[{search:/vPositionW/g,replace:s}]}),this.light?t.IP(t.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this.Eht.toString()}]},this.Eht.toString()):t.IP(t.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),0===this.Eht&&(t.MP("viewDirectionW")&&(t.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${s});\r\n`),t.compilationString+="lightingInfo info;\r\n",t.compilationString+="float shadow = 1.;\r\n",t.compilationString+=`float glossiness = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};\r\n`,t.compilationString+="vec3 diffuseBase = vec3(0., 0., 0.);\r\n",t.compilationString+="vec3 specularBase = vec3(0., 0., 0.);\r\n",t.compilationString+=`vec3 normalW = ${this.worldNormal.associatedVariableName}.xyz;\r\n`),this.light?t.compilationString+=t.RP("lightFragment",i,{replaceStrings:[{search:/{X}/g,replace:this.Eht.toString()}]}):t.compilationString+=t.RP("lightFragment",i,{repeatKey:"maxSimultaneousLights"});const n=this.diffuseOutput,r=this.specularOutput;return t.compilationString+=this.QP(n,t)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};\r\n`,r.hasEndpoints&&(t.compilationString+=this.QP(r,t)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};\r\n`),this.shadow.hasEndpoints&&(t.compilationString+=this.QP(this.shadow,t)+" = shadow;\r\n"),this}serialize(){const t=super.serialize();return t.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(t.lightId=this.light.id),t}uD(t,i,e){super.uD(t,i,e),t.lightId&&(this.light=i.getLightById(t.lightId)),this.generateOnlyFragmentCode=t.generateOnlyFragmentCode,this.Cht()}}ut([Hn("Generate only fragment code",Nn.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:kA.Aht}})],kA.prototype,"generateOnlyFragmentCode",void 0),v("BABYLON.LightBlock",kA);class GA extends kn{constructor(t){super(t,bn.VertexAndFragment),this.registerOutput("source",Mn.Object,bn.VertexAndFragment,new OA("source",this,yn.Output,GA,"ImageSourceBlock"))}get texture(){return this.Lb}set texture(t){var i;if(this.Lb===t)return;const e=null!==(i=null==t?void 0:t.getScene())&&void 0!==i?i:E.LastCreatedScene;!t&&e&&e.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this.Lb))),this.Lb=t,t&&e&&e.markAllMaterialsAsDirty(1,(i=>i.hasTexture(t)))}get samplerName(){return this.ID}bind(t){this.texture&&t.setTexture(this.ID,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this.YP[0]}tD(t){return super.tD(t),t.target===bn.Vertex&&(this.ID=t.SP(this.name+"Sampler"),t.sharedData.blockingBlocks.push(this),t.sharedData.textureBlocks.push(this),t.sharedData.bindableBlocks.push(this)),t.CP(this.ID),this}aD(){let t=super.aD();return this.texture?(t+=`${this.$P}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r\n`,t+=`${this.$P}.texture.wrapU = ${this.texture.wrapU};\r\n`,t+=`${this.$P}.texture.wrapV = ${this.texture.wrapV};\r\n`,t+=`${this.$P}.texture.uAng = ${this.texture.uAng};\r\n`,t+=`${this.$P}.texture.vAng = ${this.texture.vAng};\r\n`,t+=`${this.$P}.texture.wAng = ${this.texture.wAng};\r\n`,t+=`${this.$P}.texture.uOffset = ${this.texture.uOffset};\r\n`,t+=`${this.$P}.texture.vOffset = ${this.texture.vOffset};\r\n`,t+=`${this.$P}.texture.uScale = ${this.texture.uScale};\r\n`,t+=`${this.$P}.texture.vScale = ${this.texture.vScale};\r\n`,t+=`${this.$P}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`,t):t}serialize(){const t=super.serialize();return this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(t.texture=this.texture.serialize()),t}uD(t,i,e){super.uD(t,i,e),t.texture&&!Br.IgnoreTexturesAtLoadTime&&void 0!==t.texture.url&&(e=0===t.texture.url.indexOf("data:")?"":e,this.texture=an.Parse(t.texture,i,e))}}v("BABYLON.ImageSourceBlock",GA);v("BABYLON.TextureBlock",class extends kn{constructor(t,i=!1){super(t,i?bn.Fragment:bn.VertexAndFragment),this.wht=!1,this.xht=!1,this.disableLevelMultiplication=!1,this.Tht=i,this.registerInput("uv",Mn.AutoDetect,!1,bn.VertexAndFragment),this.registerInput("source",Mn.Object,!0,bn.VertexAndFragment,new OA("source",this,yn.Input,GA,"ImageSourceBlock")),this.registerOutput("rgba",Mn.Color4,bn.Neutral),this.registerOutput("rgb",Mn.Color3,bn.Neutral),this.registerOutput("r",Mn.Float,bn.Neutral),this.registerOutput("g",Mn.Float,bn.Neutral),this.registerOutput("b",Mn.Float,bn.Neutral),this.registerOutput("a",Mn.Float,bn.Neutral),this.registerOutput("level",Mn.Float,bn.Neutral),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Vector2|Mn.Vector3|Mn.Vector4),this.xd[0].VP=!i}get texture(){var t;return this.source.isConnected?(null===(t=this.source.connectedPoint)||void 0===t?void 0:t.ownerBlock).texture:this.Lb}set texture(t){var i;if(this.Lb===t)return;const e=null!==(i=null==t?void 0:t.getScene())&&void 0!==i?i:E.LastCreatedScene;!t&&e&&e.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this.Lb))),this.Lb=t,t&&e&&e.markAllMaterialsAsDirty(1,(i=>i.hasTexture(t)))}get samplerName(){return this.Rht?this.Rht.samplerName:this.ID}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(t){var i;if(t!==this.wht&&(this.wht=t,this.texture)){const t=null!==(i=this.texture.getScene())&&void 0!==i?i:E.LastCreatedScene;null==t||t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this.texture)))}}get convertToGammaSpace(){return this.wht}set convertToLinearSpace(t){var i;if(t!==this.xht&&(this.xht=t,this.texture)){const t=null!==(i=this.texture.getScene())&&void 0!==i?i:E.LastCreatedScene;null==t||t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this.texture)))}}get convertToLinearSpace(){return this.xht}getClassName(){return"TextureBlock"}get uv(){return this.xd[0]}get source(){return this.xd[1]}get rgba(){return this.YP[0]}get rgb(){return this.YP[1]}get r(){return this.YP[2]}get g(){return this.YP[3]}get b(){return this.YP[4]}get a(){return this.YP[5]}get level(){return this.YP[6]}get target(){if(this.Tht)return bn.Fragment;if(!this.uv.isConnected)return bn.VertexAndFragment;if(this.uv.sourceBlock.isInput)return bn.VertexAndFragment;let t=this.uv.connectedPoint;for(;t;){if(t.target===bn.Fragment)return bn.Fragment;if(t.target===bn.Vertex)return bn.VertexAndFragment;if(t.target===bn.Neutral||t.target===bn.VertexAndFragment){const i=t.ownerBlock;if(i.target===bn.Fragment)return bn.Fragment;t=null;for(const e of i.inputs)if(e.connectedPoint){t=e.connectedPoint;break}}}return bn.VertexAndFragment}set target(t){}autoConfigure(t){if(!this.uv.isConnected)if(t.mode===ar.PostProcess){const i=t.getBlockByPredicate((t=>"uv"===t.name));i&&i.connectTo(this)}else{const i=t.mode===ar.Particle?"particle_uv":"uv";let e=t.getInputBlockByPredicate((t=>t.isAttribute&&t.name===i));e||(e=new jn("uv"),e.setAsAttribute(i)),e.output.connectTo(this.uv)}}initializeDefines(t,i,e){e._l&&void 0!==this.Iht&&e.setValue(this.Iht,!1,!0)}prepareDefines(t,i,e){if(!e._l)return;if(!this.texture||!this.texture.getTextureMatrix)return void(this.Mht&&(e.setValue(this.bht,!1,!0),e.setValue(this.Iht,!0,!0)));const s=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,n=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;e.setValue(this.mD,s,!0),e.setValue(this.vD,n,!0),this.Mht&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(e.setValue(this.bht,!1,!0),e.setValue(this.Iht,!0,!0)):(e.setValue(this.bht,!0),null==e[this.Iht]&&e.setValue(this.Iht,!1,!0)))}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(t){this.texture&&(this.Mht&&(t.setFloat(this._ht,this.texture.level),t.setMatrix(this.yht,this.texture.getTextureMatrix())),this.Rht||t.setTexture(this.ID,this.texture))}get Mht(){return this.target!==bn.Fragment}MD(t){const i=this.uv;if(this.bht=t.EP("UVTRANSFORM"),this.Iht="VMAIN"+i.associatedVariableName.toUpperCase(),this.bD="vMain"+i.associatedVariableName,this.Nht=t.SP("transformedUV"),this.yht=t.SP("textureTransform"),this._ht=t.SP("textureInfoName"),this.level.associatedVariableName=this._ht,t.bP(this.Nht,"vec2",this.bht),t.bP(this.bD,"vec2",this.Iht),t._P(this.yht,"mat4",this.bht),t.compilationString+=`#ifdef ${this.bht}\r\n`,t.compilationString+=`${this.Nht} = vec2(${this.yht} * vec4(${i.associatedVariableName}.xy, 1.0, 0.0));\r\n`,t.compilationString+=`#elif defined(${this.Iht})\r\n`,t.compilationString+=`${this.bD} = ${i.associatedVariableName}.xy;\r\n`,t.compilationString+="#endif\r\n",this.YP.some((t=>t.isConnectedInVertexShader))){this._D(t,!0);for(const i of this.YP)i.hasEndpoints&&"level"!==i.name&&this.yD(t,i,i.name,!0)}}Pht(t){const i=this.samplerName;t.compilationString+=`#ifdef ${this.bht}\r\n`,t.compilationString+=`vec4 ${this.ND} = texture2D(${i}, ${this.Nht});\r\n`,t.compilationString+=`#elif defined(${this.Iht})\r\n`,t.compilationString+=`vec4 ${this.ND} = texture2D(${i}, ${this.bD?this.bD:this.uv.associatedVariableName});\r\n`,t.compilationString+="#endif\r\n"}_D(t,i=!1){const e=this.uv;if(i){if(t.target===bn.Fragment)return;this.Pht(t)}else this.uv.ownerBlock.target!==bn.Fragment?this.Pht(t):t.compilationString+=`vec4 ${this.ND} = texture2D(${this.samplerName}, ${e.associatedVariableName});\r\n`}Dht(t,i,e){"a"!==e&&(this.texture&&this.texture.gammaSpace||(t.compilationString+=`#ifdef ${this.mD}\n                    ${i.associatedVariableName} = toGammaSpace(${i.associatedVariableName});\n                    #endif\n                `),t.compilationString+=`#ifdef ${this.vD}\n                ${i.associatedVariableName} = toLinearSpace(${i.associatedVariableName});\n                #endif\n            `)}yD(t,i,e,s=!1){if(s){if(t.target===bn.Fragment)return;return t.compilationString+=`${this.QP(i,t)} = ${this.ND}.${e};\r\n`,void this.Dht(t,i,e)}if(this.uv.ownerBlock.target===bn.Fragment)return t.compilationString+=`${this.QP(i,t)} = ${this.ND}.${e};\r\n`,void this.Dht(t,i,e);let n="";this.disableLevelMultiplication||(n=` * ${this._ht}`),t.compilationString+=`${this.QP(i,t)} = ${this.ND}.${e}${n};\r\n`,this.Dht(t,i,e)}tD(t){if(super.tD(t),this.source.isConnected?this.Rht=this.source.connectedPoint.ownerBlock:this.Rht=null,(t.target===bn.Vertex||this.Tht||t.target===bn.Fragment)&&(this.ND=t.SP("tempTextureRead"),this.mD=t.EP("ISLINEAR"),this.vD=t.EP("ISGAMMA")),(!this.Mht&&t.target===bn.Fragment||this.Mht&&t.target===bn.Vertex)&&(this.Rht||(this.ID=t.SP(this.name+"Sampler"),t.CP(this.ID)),t.sharedData.blockingBlocks.push(this),t.sharedData.textureBlocks.push(this),t.sharedData.blocksWithDefines.push(this),t.sharedData.bindableBlocks.push(this)),t.target!==bn.Fragment)return void this.MD(t);if(!this.YP.some((t=>t.isConnectedInFragmentShader)))return;this.Mht&&!this.Rht&&t.CP(this.ID);const i=`//${this.name}`;t.IP("helperFunctions",i),this.Mht&&t._P(this._ht,"float"),this._D(t);for(const i of this.YP)i.hasEndpoints&&"level"!==i.name&&this.yD(t,i,i.name);return this}aD(){let t=super.aD();return t+=`${this.$P}.convertToGammaSpace = ${this.convertToGammaSpace};\r\n`,t+=`${this.$P}.convertToLinearSpace = ${this.convertToLinearSpace};\r\n`,t+=`${this.$P}.disableLevelMultiplication = ${this.disableLevelMultiplication};\r\n`,this.texture?(t+=`${this.$P}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r\n`,t+=`${this.$P}.texture.wrapU = ${this.texture.wrapU};\r\n`,t+=`${this.$P}.texture.wrapV = ${this.texture.wrapV};\r\n`,t+=`${this.$P}.texture.uAng = ${this.texture.uAng};\r\n`,t+=`${this.$P}.texture.vAng = ${this.texture.vAng};\r\n`,t+=`${this.$P}.texture.wAng = ${this.texture.wAng};\r\n`,t+=`${this.$P}.texture.uOffset = ${this.texture.uOffset};\r\n`,t+=`${this.$P}.texture.vOffset = ${this.texture.vOffset};\r\n`,t+=`${this.$P}.texture.uScale = ${this.texture.uScale};\r\n`,t+=`${this.$P}.texture.vScale = ${this.texture.vScale};\r\n`,t+=`${this.$P}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`,t):t}serialize(){const t=super.serialize();return t.convertToGammaSpace=this.convertToGammaSpace,t.convertToLinearSpace=this.convertToLinearSpace,t.fragmentOnly=this.Tht,t.disableLevelMultiplication=this.disableLevelMultiplication,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(t.texture=this.texture.serialize()),t}uD(t,i,e){super.uD(t,i,e),this.convertToGammaSpace=t.convertToGammaSpace,this.convertToLinearSpace=!!t.convertToLinearSpace,this.Tht=!!t.fragmentOnly,this.disableLevelMultiplication=!!t.disableLevelMultiplication,t.texture&&!Br.IgnoreTexturesAtLoadTime&&void 0!==t.texture.url&&(e=0===t.texture.url.indexOf("data:")?"":e,this.texture=an.Parse(t.texture,i,e))}});class zA extends kn{constructor(t){super(t,bn.VertexAndFragment),this.generateOnlyFragmentCode=!1}get texture(){return this.Lb}set texture(t){var i;if(this.Lb===t)return;const e=null!==(i=null==t?void 0:t.getScene())&&void 0!==i?i:E.LastCreatedScene;!t&&e&&e.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this.Lb))),this.Lb=t,t&&e&&e.markAllMaterialsAsDirty(1,(i=>i.hasTexture(t)))}static Aht(t,i){return t.Lht()}Lht(){return this.Cht(),!0}Cht(){this.qP(this.generateOnlyFragmentCode?bn.Fragment:bn.VertexAndFragment)}getClassName(){return"ReflectionTextureBaseBlock"}Oht(){return this.texture}autoConfigure(t){if(!this.position.isConnected){let i=t.getInputBlockByPredicate((t=>t.isAttribute&&"position"===t.name));i||(i=new jn("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.world.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.World));i||(i=new jn("world"),i.setAsSystemValue(Dn.World)),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.View));i||(i=new jn("view"),i.setAsSystemValue(Dn.View)),i.output.connectTo(this.view)}}prepareDefines(t,i,e){if(!e._l)return;const s=this.Oht();s&&s.getTextureMatrix&&(e.setValue(this.Fht,s.isCube,!0),e.setValue(this.Bht,!!s.boundingBoxSize,!0),e.setValue(this.Uht,0===s.coordinatesMode,!0),e.setValue(this.Vht,5===s.coordinatesMode,!0),e.setValue(this.kht,3===s.coordinatesMode||6===s.coordinatesMode,!0),e.setValue("INVERTCUBICMAP",6===s.coordinatesMode,!0),e.setValue(this.Ght,1===s.coordinatesMode,!0),e.setValue(this.zht,2===s.coordinatesMode,!0),e.setValue(this.Hht,4===s.coordinatesMode,!0),e.setValue(this.Xht,7===s.coordinatesMode,!0),e.setValue(this.Wht,8===s.coordinatesMode,!0),e.setValue(this.$ht,9===s.coordinatesMode,!0))}isReady(){const t=this.Oht();return!(t&&!t.isReadyOrNotBlocking())}bind(t,i,e){const s=this.Oht();if(e&&s&&(t.setMatrix(this.Yht,s.getReflectionTextureMatrix()),s.isCube?t.setTexture(this.jht,s):t.setTexture(this.Kht,s),s.boundingBoxSize)){const i=s;t.setVector3(this.qht,i.boundingBoxPosition),t.setVector3(this.Qht,i.boundingBoxSize)}}handleVertexSide(t){if(this.generateOnlyFragmentCode&&t.target===bn.Vertex)return"";this.Fht=t.EP("REFLECTIONMAP_3D"),this.kht=t.EP("REFLECTIONMAP_CUBIC"),this.Ght=t.EP("REFLECTIONMAP_SPHERICAL"),this.zht=t.EP("REFLECTIONMAP_PLANAR"),this.Hht=t.EP("REFLECTIONMAP_PROJECTION"),this.Uht=t.EP("REFLECTIONMAP_EXPLICIT"),this.Xht=t.EP("REFLECTIONMAP_EQUIRECTANGULAR"),this.Bht=t.EP("USE_LOCAL_REFLECTIONMAP_CUBIC"),this.$ht=t.EP("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this.Wht=t.EP("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this.Vht=t.EP("REFLECTIONMAP_SKYBOX"),this.Zht=t.EP("REFLECTIONMAP_OPPOSITEZ"),this.Yht=t.SP("reflectionMatrix"),t._P(this.Yht,"mat4");let i="";this.Jht=t.SP("worldPosition");const e=this.generateOnlyFragmentCode?this.Jht:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||t.bP(e,"vec4"))&&(i+=`${this.generateOnlyFragmentCode?"vec4 ":""}${e} = ${this.worldPosition.associatedVariableName};\r\n`),this.tot=t.SP("positionUVW"),this.iot=t.SP("directionW"),(this.generateOnlyFragmentCode||t.bP(this.tot,"vec3",this.Vht))&&(i+=`#ifdef ${this.Vht}\r\n`,i+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this.tot} = ${this.position.associatedVariableName}.xyz;\r\n`,i+="#endif\r\n"),(this.generateOnlyFragmentCode||t.bP(this.iot,"vec3",`defined(${this.Wht}) || defined(${this.$ht})`))&&(i+=`#if defined(${this.Wht}) || defined(${this.$ht})\r\n`,i+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this.iot} = normalize(vec3(${this.world.associatedVariableName} * vec4(${this.position.associatedVariableName}.xyz, 0.0)));\r\n`,i+="#endif\r\n"),i}handleFragmentSideInits(t){t.sharedData.blockingBlocks.push(this),t.sharedData.textureBlocks.push(this),this.jht=t.SP(this.name+"CubeSampler"),t.samplers.push(this.jht),this.Kht=t.SP(this.name+"2DSampler"),t.samplers.push(this.Kht),t.fP+=`#ifdef ${this.Fht}\r\n`,t.fP+=`uniform samplerCube ${this.jht};\r\n`,t.fP+="#else\r\n",t.fP+=`uniform sampler2D ${this.Kht};\r\n`,t.fP+="#endif\r\n",t.sharedData.blocksWithDefines.push(this),t.sharedData.bindableBlocks.push(this);const i=`//${this.name}`;t.TP("ReciprocalPI","#define RECIPROCAL_PI2 0.15915494",""),t.IP("helperFunctions",i),t.IP("reflectionFunction",i,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this.eot=t.SP("reflectionColor"),this.sot=t.SP("reflectionUVW"),this.hot=t.SP("reflectionCoords"),this.qht=t.SP("vReflectionPosition"),t._P(this.qht,"vec3"),this.Qht=t.SP("vReflectionPosition"),t._P(this.Qht,"vec3")}handleFragmentSideCodeReflectionCoords(t,i,e=!1,s=!1){i||(i=this.generateOnlyFragmentCode?this.Jht:`v_${this.worldPosition.associatedVariableName}`);const n=this.Yht,r=`normalize(${this.iot})`,h=`${this.tot}`,o=`${this.cameraPosition.associatedVariableName}`,a=`${this.view.associatedVariableName}`;t+=".xyz";let l=`\n            #ifdef ${this.$ht}\n                vec3 ${this.sot} = computeMirroredFixedEquirectangularCoords(${i}, ${t}, ${r});\n            #endif\n\n            #ifdef ${this.Wht}\n                vec3 ${this.sot} = computeFixedEquirectangularCoords(${i}, ${t}, ${r});\n            #endif\n\n            #ifdef ${this.Xht}\n                vec3 ${this.sot} = computeEquirectangularCoords(${i}, ${t}, ${o}.xyz, ${n});\n            #endif\n\n            #ifdef ${this.Ght}\n                vec3 ${this.sot} = computeSphericalCoords(${i}, ${t}, ${a}, ${n});\n            #endif\n\n            #ifdef ${this.zht}\n                vec3 ${this.sot} = computePlanarCoords(${i}, ${t}, ${o}.xyz, ${n});\n            #endif\n\n            #ifdef ${this.kht}\n                #ifdef ${this.Bht}\n                    vec3 ${this.sot} = computeCubicLocalCoords(${i}, ${t}, ${o}.xyz, ${n}, ${this.Qht}, ${this.qht});\n                #else\n                vec3 ${this.sot} = computeCubicCoords(${i}, ${t}, ${o}.xyz, ${n});\n                #endif\n            #endif\n\n            #ifdef ${this.Hht}\n                vec3 ${this.sot} = computeProjectionCoords(${i}, ${a}, ${n});\n            #endif\n\n            #ifdef ${this.Vht}\n                vec3 ${this.sot} = computeSkyBoxCoords(${h}, ${n});\n            #endif\n\n            #ifdef ${this.Uht}\n                vec3 ${this.sot} = vec3(0, 0, 0);\n            #endif\r\n`;return s||(l+=`#ifdef ${this.Zht}\n                ${this.sot}.z *= -1.0;\n            #endif\r\n`),e||(l+=`\n                #ifdef ${this.Fht}\n                    vec3 ${this.hot} = ${this.sot};\n                #else\n                    vec2 ${this.hot} = ${this.sot}.xy;\n                    #ifdef ${this.Hht}\n                        ${this.hot} /= ${this.sot}.z;\n                    #endif\n                    ${this.hot}.y = 1.0 - ${this.hot}.y;\n                #endif\r\n`),l}handleFragmentSideCodeReflectionColor(t,i=".rgb"){let e=`${"vec"+(0===i.length?"4":i.length-1)} ${this.eot};\n            #ifdef ${this.Fht}\r\n`;return e+=t?`${this.eot} = textureCubeLodEXT(${this.jht}, ${this.sot}, ${t})${i};\r\n`:`${this.eot} = textureCube(${this.jht}, ${this.sot})${i};\r\n`,e+="\n            #else\r\n",e+=t?`${this.eot} = texture2DLodEXT(${this.Kht}, ${this.hot}, ${t})${i};\r\n`:`${this.eot} = texture2D(${this.Kht}, ${this.hot})${i};\r\n`,e+="#endif\r\n",e}writeOutputs(t,i){let e="";if(t.target===bn.Fragment)for(const s of this.YP)s.hasEndpoints&&(e+=`${this.QP(s,t)} = ${i}.${s.name};\r\n`);return e}tD(t){return super.tD(t),this}aD(){let t=super.aD();if(!this.texture)return t;if(this.texture.isCube){const i=this.texture.forcedExtension;t+=`${this.$P}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture.Wb}, ${i?'"'+i+'"':"null"});\r\n`}else t+=`${this.$P}.texture = new BABYLON.Texture("${this.texture.name}", null);\r\n`;return t+=`${this.$P}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`,t}serialize(){const t=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(t.texture=this.texture.serialize()),t.generateOnlyFragmentCode=this.generateOnlyFragmentCode,t}uD(t,i,e){super.uD(t,i,e),t.texture&&!Br.IgnoreTexturesAtLoadTime&&(e=0===t.texture.url.indexOf("data:")?"":e,t.texture.isCube?this.texture=Rm.Parse(t.texture,i,e):this.texture=an.Parse(t.texture,i,e)),this.generateOnlyFragmentCode=t.generateOnlyFragmentCode,this.Cht()}}ut([Hn("Generate only fragment code",Nn.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:zA.Aht}})],zA.prototype,"generateOnlyFragmentCode",void 0),v("BABYLON.ReflectionTextureBaseBlock",zA);v("BABYLON.ReflectionTextureBlock",class extends zA{Lht(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(this.Cht(),!0)}Cht(){super.Cht(),this.getInputByName("position").target=this.generateOnlyFragmentCode?bn.Fragment:bn.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?bn.Fragment:bn.Vertex}constructor(t){super(t),this.registerInput("position",Mn.AutoDetect,!1,bn.Vertex),this.registerInput("worldPosition",Mn.Vector4,!1,bn.Vertex),this.registerInput("worldNormal",Mn.Vector4,!1,bn.Fragment),this.registerInput("world",Mn.Matrix,!1,bn.Vertex),this.registerInput("cameraPosition",Mn.Vector3,!1,bn.Fragment),this.registerInput("view",Mn.Matrix,!1,bn.Fragment),this.registerOutput("rgb",Mn.Color3,bn.Fragment),this.registerOutput("rgba",Mn.Color4,bn.Fragment),this.registerOutput("r",Mn.Float,bn.Fragment),this.registerOutput("g",Mn.Float,bn.Fragment),this.registerOutput("b",Mn.Float,bn.Fragment),this.registerOutput("a",Mn.Float,bn.Fragment),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Vector3|Mn.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this.xd[0]}get worldPosition(){return this.xd[1]}get worldNormal(){return this.xd[2]}get world(){return this.xd[3]}get cameraPosition(){return this.xd[4]}get view(){return this.xd[5]}get rgb(){return this.YP[0]}get rgba(){return this.YP[1]}get r(){return this.YP[2]}get g(){return this.YP[3]}get b(){return this.YP[4]}get a(){return this.YP[5]}autoConfigure(t){if(super.autoConfigure(t),!this.cameraPosition.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.CameraPosition));i||(i=new jn("cameraPosition"),i.setAsSystemValue(Dn.CameraPosition)),i.output.connectTo(this.cameraPosition)}}tD(t){if(super.tD(t),!this.texture)return t.compilationString+=this.writeOutputs(t,"vec4(0.)"),this;if(t.target!==bn.Fragment)return t.compilationString+=this.handleVertexSide(t),this;this.generateOnlyFragmentCode&&(t.compilationString+=this.handleVertexSide(t)),this.handleFragmentSideInits(t);const i=t.SP("normalWUnit");return t.compilationString+=`vec4 ${i} = normalize(${this.worldNormal.associatedVariableName});\r\n`,t.compilationString+=this.handleFragmentSideCodeReflectionCoords(i),t.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),t.compilationString+=this.writeOutputs(t,this.eot),this}});class HA extends kn{constructor(t){super(t,bn.VertexAndFragment),this.useNonLinearDepth=!1,this.force32itsFloat=!1,this.WP=!0,this.registerInput("uv",Mn.AutoDetect,!1,bn.VertexAndFragment),this.registerOutput("depth",Mn.Float,bn.Neutral),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Vector2|Mn.Vector3|Mn.Vector4),this.xd[0].VP=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this.xd[0]}get depth(){return this.YP[0]}initialize(t){t.AP("textureSampler")}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?bn.VertexAndFragment:bn.Fragment:bn.VertexAndFragment}Oht(t){return t.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat).getDepthMap()}bind(t,i){const e=this.Oht(i.getScene());t.setTexture(this.ID,e)}MD(t){const i=this.uv;if(i.connectedPoint.ownerBlock.isInput){i.connectedPoint.ownerBlock.isAttribute||t._P(i.associatedVariableName,"vec"+(i.type===Mn.Vector3?"3":i.type===Mn.Vector4?"4":"2"))}if(this.bD="vMain"+i.associatedVariableName,t.bP(this.bD,"vec2"),t.compilationString+=`${this.bD} = ${i.associatedVariableName}.xy;\r\n`,this.YP.some((t=>t.isConnectedInVertexShader))){this._D(t,!0);for(const i of this.YP)i.hasEndpoints&&this.yD(t,i,"r",!0)}}_D(t,i=!1){const e=this.uv;if(i){if(t.target===bn.Fragment)return;t.compilationString+=`vec4 ${this.ND} = texture2D(${this.ID}, ${e.associatedVariableName}.xy);\r\n`}else this.uv.ownerBlock.target!==bn.Fragment?t.compilationString+=`vec4 ${this.ND} = texture2D(${this.ID}, ${this.bD});\r\n`:t.compilationString+=`vec4 ${this.ND} = texture2D(${this.ID}, ${e.associatedVariableName}.xy);\r\n`}yD(t,i,e,s=!1){if(s){if(t.target===bn.Fragment)return;t.compilationString+=`${this.QP(i,t)} = ${this.ND}.${e};\r\n`}else this.uv.ownerBlock.target,bn.Fragment,t.compilationString+=`${this.QP(i,t)} = ${this.ND}.${e};\r\n`}tD(t){if(super.tD(t),this.ID=t.SP(this.name+"Sampler"),this.ND=t.SP("tempTextureRead"),t.sharedData.bindableBlocks.indexOf(this)<0&&t.sharedData.bindableBlocks.push(this),t.target!==bn.Fragment)return t.CP(this.ID),void this.MD(t);if(this.YP.some((t=>t.isConnectedInFragmentShader))){t.CP(this.ID),this._D(t);for(const i of this.YP)i.hasEndpoints&&this.yD(t,i,"r");return this}}serialize(){const t=super.serialize();return t.useNonLinearDepth=this.useNonLinearDepth,t.force32itsFloat=this.force32itsFloat,t}uD(t,i,e){super.uD(t,i,e),this.useNonLinearDepth=t.useNonLinearDepth,this.force32itsFloat=t.force32itsFloat}}ut([Hn("Use non linear depth",Nn.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:t=>t.disableDepthRenderer()}})],HA.prototype,"useNonLinearDepth",void 0),ut([Hn("Force 32 bits float",Nn.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:t=>t.disableDepthRenderer()}})],HA.prototype,"force32itsFloat",void 0),v("BABYLON.SceneDepthBlock",HA);v("BABYLON.ClipPlanesBlock",class extends kn{constructor(t){super(t,bn.VertexAndFragment,!0),this.registerInput("worldPosition",Mn.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(t){t.AP("vClipPlane"),t.AP("fClipDistance"),t.AP("vClipPlane2"),t.AP("fClipDistance2"),t.AP("vClipPlane3"),t.AP("fClipDistance3"),t.AP("vClipPlane4"),t.AP("fClipDistance4"),t.AP("vClipPlane5"),t.AP("fClipDistance5"),t.AP("vClipPlane6"),t.AP("fClipDistance6")}get worldPosition(){return this.xd[0]}get target(){return bn.VertexAndFragment}set target(t){}prepareDefines(t,i,e){var s,n,r,h,o,a;const l=t.getScene(),c=!!(null!==(s=i.clipPlane)&&void 0!==s?s:l.clipPlane),u=!!(null!==(n=i.clipPlane2)&&void 0!==n?n:l.clipPlane2),f=!!(null!==(r=i.clipPlane3)&&void 0!==r?r:l.clipPlane3),d=!!(null!==(h=i.clipPlane4)&&void 0!==h?h:l.clipPlane4),p=!!(null!==(o=i.clipPlane5)&&void 0!==o?o:l.clipPlane5),m=!!(null!==(a=i.clipPlane6)&&void 0!==a?a:l.clipPlane6);e.setValue("CLIPPLANE",c,!0),e.setValue("CLIPPLANE2",u,!0),e.setValue("CLIPPLANE3",f,!0),e.setValue("CLIPPLANE4",d,!0),e.setValue("CLIPPLANE5",p,!0),e.setValue("CLIPPLANE6",m,!0)}bind(t,i,e){if(!e)return;Ds(t,i,e.getScene())}tD(t){super.tD(t);const i=`//${this.name}`;if(t.target!==bn.Fragment){const e=this.worldPosition;return t.IP("clipPlaneVertexDeclaration",i,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),t.compilationString+=t.RP("clipPlaneVertex",i,{replaceStrings:[{search:/worldPos/g,replace:e.associatedVariableName}]}),t._P("vClipPlane","vec4"),t._P("vClipPlane2","vec4"),t._P("vClipPlane3","vec4"),t._P("vClipPlane4","vec4"),t._P("vClipPlane5","vec4"),void t._P("vClipPlane6","vec4")}return t.sharedData.bindableBlocks.push(this),t.sharedData.blocksWithDefines.push(this),t.IP("clipPlaneFragmentDeclaration",i),t.compilationString+=t.RP("clipPlaneFragment",i),this}});v("BABYLON.AddBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1)}getClassName(){return"AddBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};\r\n`,this}});v("BABYLON.ScaleBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("input",Mn.AutoDetect),this.registerInput("factor",Mn.Float),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0]}getClassName(){return"ScaleBlock"}get input(){return this.xd[0]}get factor(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};\r\n`,this}});class XA extends kn{constructor(t){super(t,bn.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0]}getClassName(){return"ClampBlock"}get value(){return this.xd[0]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = clamp(${this.value.associatedVariableName}, ${this.JP(this.minimum)}, ${this.JP(this.maximum)});\r\n`,this}aD(){let t=super.aD()+`${this.$P}.minimum = ${this.minimum};\r\n`;return t+=`${this.$P}.maximum = ${this.maximum};\r\n`,t}serialize(){const t=super.serialize();return t.minimum=this.minimum,t.maximum=this.maximum,t}uD(t,i,e){super.uD(t,i,e),this.minimum=t.minimum,this.maximum=t.maximum}}ut([Hn("Minimum",Nn.Float)],XA.prototype,"minimum",void 0),ut([Hn("Maximum",Nn.Float)],XA.prototype,"maximum",void 0),v("BABYLON.ClampBlock",XA);v("BABYLON.CrossBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerOutput("output",Mn.Vector3),this.iD(0,1),this.xd[0].excludedConnectionPointTypes.push(Mn.Float),this.xd[0].excludedConnectionPointTypes.push(Mn.Matrix),this.xd[0].excludedConnectionPointTypes.push(Mn.Vector2),this.xd[1].excludedConnectionPointTypes.push(Mn.Float),this.xd[1].excludedConnectionPointTypes.push(Mn.Matrix),this.xd[1].excludedConnectionPointTypes.push(Mn.Vector2)}getClassName(){return"CrossBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);\r\n`,this}});v("BABYLON.CustomBlock",class extends kn{constructor(t){super(t)}get options(){return this.wb}set options(t){this.oot(t)}getClassName(){return"CustomBlock"}tD(t){super.tD(t);let i=this.aot,e=this.wb.functionName;this.xd.forEach((s=>{const n=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),r=t.wP(s.type);i=i.replace(n,r),e=e.replace(n,r)})),this.YP.forEach((s=>{const n=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),r=t.wP(s.type);i=i.replace(n,r),e=e.replace(n,r)})),t.TP(e,i,""),this.YP.forEach((i=>{t.compilationString+=this.QP(i,t)+";\r\n"})),t.compilationString+=e+"(";let s=!1;return this.xd.forEach(((i,e)=>{e>0&&(t.compilationString+=", "),t.compilationString+=i.associatedVariableName,s=!0})),this.YP.forEach(((i,e)=>{(e>0||s)&&(t.compilationString+=", "),t.compilationString+=i.associatedVariableName})),t.compilationString+=");\r\n",this}aD(){let t=super.aD();return t+=`${this.$P}.options = ${JSON.stringify(this.wb)};\r\n`,t}serialize(){const t=super.serialize();return t.options=this.wb,t}uD(t,i,e){this.oot(t.options),super.uD(t,i,e)}oot(t){var i,e,s;this.wb=t,this.aot=t.code.join("\r\n")+"\r\n",this.name=this.name||t.name,this.target=bn[t.target],null===(i=t.inParameters)||void 0===i||i.forEach(((t,i)=>{const e=Mn[t.type];this.registerInput(t.name,e),Object.defineProperty(this,t.name,{get:function(){return this.xd[i]},enumerable:!0,configurable:!0})})),null===(e=t.outParameters)||void 0===e||e.forEach(((t,i)=>{this.registerOutput(t.name,Mn[t.type]),Object.defineProperty(this,t.name,{get:function(){return this.YP[i]},enumerable:!0,configurable:!0}),"BasedOnInput"===t.type&&(this.YP[i].DP=this.lot(t.typeFromInput)[0])})),null===(s=t.inLinkedConnectionTypes)||void 0===s||s.forEach((t=>{this.iD(this.lot(t.input1)[1],this.lot(t.input2)[1])}))}lot(t){if(!t)return null;for(let i=0;i<this.xd.length;i++)if(this.xd[i].name===t)return[this.xd[i],i];return null}});v("BABYLON.DotBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerOutput("output",Mn.Float),this.iD(0,1),this.xd[0].excludedConnectionPointTypes.push(Mn.Float),this.xd[0].excludedConnectionPointTypes.push(Mn.Matrix),this.xd[1].excludedConnectionPointTypes.push(Mn.Float),this.xd[1].excludedConnectionPointTypes.push(Mn.Matrix)}getClassName(){return"DotBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}});v("BABYLON.NormalizeBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("input",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.xd[0].excludedConnectionPointTypes.push(Mn.Float),this.xd[0].excludedConnectionPointTypes.push(Mn.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this.xd[0]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0],e=this.xd[0];return t.compilationString+=this.QP(i,t)+` = normalize(${e.associatedVariableName});\r\n`,this}});v("BABYLON.ColorMergerBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",Mn.Color3,!0),this.registerInput("r",Mn.Float,!0),this.registerInput("g",Mn.Float,!0),this.registerInput("b",Mn.Float,!0),this.registerInput("a",Mn.Float,!0),this.registerOutput("rgba",Mn.Color4),this.registerOutput("rgb",Mn.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this.xd[0]}get r(){return this.xd[1]}get g(){return this.xd[2]}get b(){return this.xd[3]}get a(){return this.xd[4]}get rgba(){return this.YP[0]}get rgbOut(){return this.YP[1]}get rgb(){return this.rgbOut}hD(t){return"rgb "===t?"rgbIn":t}EL(t){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substr(0,t)}tD(t){super.tD(t);const i=this.r,e=this.g,s=this.b,n=this.a,r=this.rgbIn,h=this.YP[0],o=this.YP[1];return r.isConnected?(h.hasEndpoints&&(t.compilationString+=this.QP(h,t)+` = vec4(${r.associatedVariableName}, ${n.isConnected?this.ZP(n):"0.0"})${this.EL(4)};\r\n`),o.hasEndpoints&&(t.compilationString+=this.QP(o,t)+` = ${r.associatedVariableName}${this.EL(3)};\r\n`)):(h.hasEndpoints&&(t.compilationString+=this.QP(h,t)+` = vec4(${i.isConnected?this.ZP(i):"0.0"}, ${e.isConnected?this.ZP(e):"0.0"}, ${s.isConnected?this.ZP(s):"0.0"}, ${n.isConnected?this.ZP(n):"0.0"})${this.EL(4)};\r\n`),o.hasEndpoints&&(t.compilationString+=this.QP(o,t)+` = vec3(${i.isConnected?this.ZP(i):"0.0"}, ${e.isConnected?this.ZP(e):"0.0"}, ${s.isConnected?this.ZP(s):"0.0"})${this.EL(3)};\r\n`)),this}serialize(){const t=super.serialize();return t.rSwizzle=this.rSwizzle,t.gSwizzle=this.gSwizzle,t.bSwizzle=this.bSwizzle,t.aSwizzle=this.aSwizzle,t}uD(t,i,e){var s,n,r,h;super.uD(t,i,e),this.rSwizzle=null!==(s=t.rSwizzle)&&void 0!==s?s:"r",this.gSwizzle=null!==(n=t.gSwizzle)&&void 0!==n?n:"g",this.bSwizzle=null!==(r=t.bSwizzle)&&void 0!==r?r:"b",this.aSwizzle=null!==(h=t.aSwizzle)&&void 0!==h?h:"a"}aD(){let t=super.aD();return t+=`${this.$P}.rSwizzle = "${this.rSwizzle}";\r\n`,t+=`${this.$P}.gSwizzle = "${this.gSwizzle}";\r\n`,t+=`${this.$P}.bSwizzle = "${this.bSwizzle}";\r\n`,t+=`${this.$P}.aSwizzle = "${this.aSwizzle}";\r\n`,t}});v("BABYLON.VectorSplitterBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("xyzw",Mn.Vector4,!0),this.registerInput("xyz ",Mn.Vector3,!0),this.registerInput("xy ",Mn.Vector2,!0),this.registerOutput("xyz",Mn.Vector3),this.registerOutput("xy",Mn.Vector2),this.registerOutput("zw",Mn.Vector2),this.registerOutput("x",Mn.Float),this.registerOutput("y",Mn.Float),this.registerOutput("z",Mn.Float),this.registerOutput("w",Mn.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this.xd[0]}get xyzIn(){return this.xd[1]}get xyIn(){return this.xd[2]}get xyzOut(){return this.YP[0]}get xyOut(){return this.YP[1]}get zw(){return this.YP[2]}get x(){return this.YP[3]}get y(){return this.YP[4]}get z(){return this.YP[5]}get w(){return this.YP[6]}hD(t){switch(t){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return t}}oD(t){switch(t){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return t}}tD(t){super.tD(t);const i=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,e=this.YP[0],s=this.YP[1],n=this.YP[2],r=this.YP[3],h=this.YP[4],o=this.YP[5],a=this.YP[6];return e.hasEndpoints&&(i===this.xyIn?t.compilationString+=this.QP(e,t)+` = vec3(${i.associatedVariableName}, 0.0);\r\n`:t.compilationString+=this.QP(e,t)+` = ${i.associatedVariableName}.xyz;\r\n`),n.hasEndpoints&&this.xyzw.isConnected&&(t.compilationString+=this.QP(n,t)+` = ${this.xyzw.associatedVariableName}.zw;\r\n`),s.hasEndpoints&&(t.compilationString+=this.QP(s,t)+` = ${i.associatedVariableName}.xy;\r\n`),r.hasEndpoints&&(t.compilationString+=this.QP(r,t)+` = ${i.associatedVariableName}.x;\r\n`),h.hasEndpoints&&(t.compilationString+=this.QP(h,t)+` = ${i.associatedVariableName}.y;\r\n`),o.hasEndpoints&&(t.compilationString+=this.QP(o,t)+` = ${i.associatedVariableName}.z;\r\n`),a.hasEndpoints&&(t.compilationString+=this.QP(a,t)+` = ${i.associatedVariableName}.w;\r\n`),this}});v("BABYLON.LerpBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerInput("gradient",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1),this.iD(1,2,!0),this.xd[2].acceptedConnectionPointTypes.push(Mn.Float)}getClassName(){return"LerpBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get gradient(){return this.xd[2]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});\r\n`,this}});v("BABYLON.DivideBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1)}getClassName(){return"DivideBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};\r\n`,this}});v("BABYLON.SubtractBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1)}getClassName(){return"SubtractBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};\r\n`,this}});v("BABYLON.StepBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("value",Mn.Float),this.registerInput("edge",Mn.Float),this.registerOutput("output",Mn.Float)}getClassName(){return"StepBlock"}get value(){return this.xd[0]}get edge(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});\r\n`,this}});class WA extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("input",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.YP[0].excludedConnectionPointTypes.push(Mn.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this.xd[0]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = 1. - ${this.input.associatedVariableName};\r\n`,this}}v("BABYLON.OneMinusBlock",WA),v("BABYLON.OppositeBlock",WA);class $A extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("worldPosition",Mn.Vector4),this.registerInput("cameraPosition",Mn.Vector3),this.registerOutput("output",Mn.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this.xd[0]}get cameraPosition(){return this.xd[1]}get output(){return this.YP[0]}autoConfigure(t){if(!this.cameraPosition.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.CameraPosition));i||(i=new jn("cameraPosition"),i.setAsSystemValue(Dn.CameraPosition)),i.output.connectTo(this.cameraPosition)}}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);\r\n`,this}}v("BABYLON.ViewDirectionBlock",$A);v("BABYLON.FresnelBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("worldNormal",Mn.Vector4),this.registerInput("viewDirection",Mn.Vector3),this.registerInput("bias",Mn.Float),this.registerInput("power",Mn.Float),this.registerOutput("fresnel",Mn.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this.xd[0]}get viewDirection(){return this.xd[1]}get bias(){return this.xd[2]}get power(){return this.xd[3]}get fresnel(){return this.YP[0]}autoConfigure(t){if(!this.viewDirection.isConnected){const i=new $A("View direction");i.output.connectTo(this.viewDirection),i.autoConfigure(t)}if(!this.bias.isConnected){const t=new jn("bias");t.value=0,t.output.connectTo(this.bias)}if(!this.power.isConnected){const t=new jn("power");t.value=1,t.output.connectTo(this.power)}}tD(t){super.tD(t);const i=`//${this.name}`;return t.IP("fresnelFunction",i,{removeIfDef:!0}),t.compilationString+=this.QP(this.fresnel,t)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});\r\n`,this}});v("BABYLON.MaxBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1)}getClassName(){return"MaxBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}});v("BABYLON.MinBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1)}getClassName(){return"MinBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}});v("BABYLON.DistanceBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerOutput("output",Mn.Float),this.iD(0,1),this.xd[0].excludedConnectionPointTypes.push(Mn.Float),this.xd[0].excludedConnectionPointTypes.push(Mn.Matrix),this.xd[1].excludedConnectionPointTypes.push(Mn.Float),this.xd[1].excludedConnectionPointTypes.push(Mn.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});\r\n`,this}});v("BABYLON.LengthBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("value",Mn.AutoDetect),this.registerOutput("output",Mn.Float),this.xd[0].excludedConnectionPointTypes.push(Mn.Float),this.xd[0].excludedConnectionPointTypes.push(Mn.Matrix)}getClassName(){return"LengthBlock"}get value(){return this.xd[0]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = length(${this.value.associatedVariableName});\r\n`,this}});v("BABYLON.NegateBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("value",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0]}getClassName(){return"NegateBlock"}get value(){return this.xd[0]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = -1.0 * ${this.value.associatedVariableName};\r\n`,this}});v("BABYLON.PowBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("value",Mn.AutoDetect),this.registerInput("power",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1)}getClassName(){return"PowBlock"}get value(){return this.xd[0]}get power(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = pow(${this.value.associatedVariableName}, ${this.power.associatedVariableName});\r\n`,this}});v("BABYLON.RandomNumberBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("seed",Mn.AutoDetect),this.registerOutput("output",Mn.Float),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Vector2|Mn.Vector3|Mn.Vector4|Mn.Color3|Mn.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this.xd[0]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0],e=`//${this.name}`;return t.IP("helperFunctions",e),t.compilationString+=this.QP(i,t)+` = getRand(${this.seed.associatedVariableName}.xy);\r\n`,this}});v("BABYLON.ArcTan2Block",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("x",Mn.Float),this.registerInput("y",Mn.Float),this.registerOutput("output",Mn.Float)}getClassName(){return"ArcTan2Block"}get x(){return this.xd[0]}get y(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = atan(${this.x.associatedVariableName}, ${this.y.associatedVariableName});\r\n`,this}});v("BABYLON.SmoothStepBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("value",Mn.AutoDetect),this.registerInput("edge0",Mn.Float),this.registerInput("edge1",Mn.Float),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0]}getClassName(){return"SmoothStepBlock"}get value(){return this.xd[0]}get edge0(){return this.xd[1]}get edge1(){return this.xd[2]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = smoothstep(${this.edge0.associatedVariableName}, ${this.edge1.associatedVariableName}, ${this.value.associatedVariableName});\r\n`,this}});v("BABYLON.ReciprocalBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("input",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0]}getClassName(){return"ReciprocalBlock"}get input(){return this.xd[0]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return this.input.type===Mn.Matrix?t.compilationString+=this.QP(i,t)+` = inverse(${this.input.associatedVariableName});\r\n`:t.compilationString+=this.QP(i,t)+` = 1. / ${this.input.associatedVariableName};\r\n`,this}});v("BABYLON.ReplaceColorBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("value",Mn.AutoDetect),this.registerInput("reference",Mn.AutoDetect),this.registerInput("distance",Mn.Float),this.registerInput("replacement",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1),this.iD(0,3),this.xd[0].excludedConnectionPointTypes.push(Mn.Float),this.xd[0].excludedConnectionPointTypes.push(Mn.Matrix),this.xd[1].excludedConnectionPointTypes.push(Mn.Float),this.xd[1].excludedConnectionPointTypes.push(Mn.Matrix),this.xd[3].excludedConnectionPointTypes.push(Mn.Float),this.xd[3].excludedConnectionPointTypes.push(Mn.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this.xd[0]}get reference(){return this.xd[1]}get distance(){return this.xd[2]}get replacement(){return this.xd[3]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+";\r\n",t.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {\r\n`,t.compilationString+=`${i.associatedVariableName} = ${this.replacement.associatedVariableName};\r\n`,t.compilationString+="} else {\r\n",t.compilationString+=`${i.associatedVariableName} = ${this.value.associatedVariableName};\r\n`,t.compilationString+="}\r\n",this}});var YA;v("BABYLON.PosterizeBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("value",Mn.AutoDetect),this.registerInput("steps",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1),this.xd[0].excludedConnectionPointTypes.push(Mn.Matrix),this.xd[1].excludedConnectionPointTypes.push(Mn.Matrix)}getClassName(){return"PosterizeBlock"}get value(){return this.xd[0]}get steps(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});\r\n`,this}}),function(t){t[t.SawTooth=0]="SawTooth",t[t.Square=1]="Square",t[t.Triangle=2]="Triangle"}(YA||(YA={}));v("BABYLON.WaveBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.kind=YA.SawTooth,this.registerInput("input",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.xd[0].excludedConnectionPointTypes.push(Mn.Matrix)}getClassName(){return"WaveBlock"}get input(){return this.xd[0]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];switch(this.kind){case YA.SawTooth:t.compilationString+=this.QP(i,t)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});\r\n`;break;case YA.Square:t.compilationString+=this.QP(i,t)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));\r\n`;break;case YA.Triangle:t.compilationString+=this.QP(i,t)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;\r\n`}return this}serialize(){const t=super.serialize();return t.kind=this.kind,t}uD(t,i,e){super.uD(t,i,e),this.kind=t.kind}});class jA{constructor(t,i){this.step=t,this.color=i}get step(){return this.wnt}set step(t){this.wnt=t}get color(){return this.cot}set color(t){this.cot=t}}v("BABYLON.GradientBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.colorSteps=[new jA(0,_.Black()),new jA(1,_.White())],this.onValueChangedObservable=new h,this.registerInput("gradient",Mn.AutoDetect),this.registerOutput("output",Mn.Color3),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Float|Mn.Vector2|Mn.Vector3|Mn.Vector4|Mn.Color3|Mn.Color4)}colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}getClassName(){return"GradientBlock"}get gradient(){return this.xd[0]}get output(){return this.YP[0]}uot(t){const i=this.colorSteps[t];return`vec3(${i.color.r}, ${i.color.g}, ${i.color.b})`}tD(t){super.tD(t);const i=this.YP[0];if(!this.colorSteps.length||!this.gradient.connectedPoint)return void(t.compilationString+=this.QP(i,t)+" = vec3(0., 0., 0.);\r\n");const e=t.SP("gradientTempColor"),s=t.SP("gradientTempPosition");t.compilationString+=`vec3 ${e} = ${this.uot(0)};\r\n`,t.compilationString+=`float ${s};\r\n`;let n=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==Mn.Float&&(n+=".x");for(let i=1;i<this.colorSteps.length;i++){const r=this.colorSteps[i],h=this.colorSteps[i-1];t.compilationString+=`${s} = clamp((${n} - ${t.yP(h.step)}) / (${t.yP(r.step)} -  ${t.yP(h.step)}), 0.0, 1.0) * step(${t.yP(i)}, ${t.yP(this.colorSteps.length-1)});\r\n`,t.compilationString+=`${e} = mix(${e}, ${this.uot(i)}, ${s});\r\n`}return t.compilationString+=this.QP(i,t)+` = ${e};\r\n`,this}serialize(){const t=super.serialize();t.colorSteps=[];for(const i of this.colorSteps)t.colorSteps.push({step:i.step,color:{r:i.color.r,g:i.color.g,b:i.color.b}});return t}uD(t,i,e){super.uD(t,i,e),this.colorSteps.length=0;for(const i of t.colorSteps)this.colorSteps.push(new jA(i.step,new _(i.color.r,i.color.g,i.color.b)))}aD(){let t=super.aD();t+=`${this.$P}.colorSteps = [];\r\n`;for(const i of this.colorSteps)t+=`${this.$P}.colorSteps.push(new BABYLON.GradientBlockColorStep(${i.step}, new BABYLON.Color3(${i.color.r}, ${i.color.g}, ${i.color.b})));\r\n`;return t}});v("BABYLON.NLerpBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerInput("gradient",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1),this.iD(1,2,!0),this.xd[2].acceptedConnectionPointTypes.push(Mn.Float)}getClassName(){return"NLerpBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get gradient(){return this.xd[2]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));\r\n`,this}});class KA extends kn{constructor(t){super(t,bn.Neutral),this.manhattanDistance=!1,this.registerInput("seed",Mn.Vector3),this.registerInput("jitter",Mn.Float),this.registerOutput("output",Mn.Vector2),this.registerOutput("x",Mn.Float),this.registerOutput("y",Mn.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this.xd[0]}get jitter(){return this.xd[1]}get output(){return this.YP[0]}get x(){return this.YP[1]}get y(){return this.YP[2]}tD(t){if(super.tD(t),!this.seed.isConnected)return;if(!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let i="vec3 permute(vec3 x){\r\n";i+="    return mod((34.0 * x + 1.0) * x, 289.0);\r\n",i+="}\r\n\r\n",i+="vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r\n",i+="    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r\n",i+="}\r\n\r\n",i+="vec2 worley(vec3 P, float jitter, bool manhattanDistance){\r\n",i+="    float K = 0.142857142857; // 1/7\r\n",i+="    float Ko = 0.428571428571; // 1/2-K/2\r\n",i+="    float  K2 = 0.020408163265306; // 1/(7*7)\r\n",i+="    float Kz = 0.166666666667; // 1/6\r\n",i+="    float Kzo = 0.416666666667; // 1/2-1/6*2\r\n",i+="\r\n",i+="    vec3 Pi = mod(floor(P), 289.0);\r\n",i+="    vec3 Pf = fract(P) - 0.5;\r\n",i+="\r\n",i+="    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r\n",i+="    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r\n",i+="    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r\n",i+="\r\n",i+="    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r\n",i+="    vec3 p1 = permute(p + Pi.y - 1.0);\r\n",i+="    vec3 p2 = permute(p + Pi.y);\r\n",i+="    vec3 p3 = permute(p + Pi.y + 1.0);\r\n",i+="\r\n",i+="    vec3 p11 = permute(p1 + Pi.z - 1.0);\r\n",i+="    vec3 p12 = permute(p1 + Pi.z);\r\n",i+="    vec3 p13 = permute(p1 + Pi.z + 1.0);\r\n",i+="\r\n",i+="    vec3 p21 = permute(p2 + Pi.z - 1.0);\r\n",i+="    vec3 p22 = permute(p2 + Pi.z);\r\n",i+="    vec3 p23 = permute(p2 + Pi.z + 1.0);\r\n",i+="\r\n",i+="    vec3 p31 = permute(p3 + Pi.z - 1.0);\r\n",i+="    vec3 p32 = permute(p3 + Pi.z);\r\n",i+="    vec3 p33 = permute(p3 + Pi.z + 1.0);\r\n",i+="\r\n",i+="    vec3 ox11 = fract(p11*K) - Ko;\r\n",i+="    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r\n",i+="    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r\n",i+="\r\n",i+="    vec3 ox12 = fract(p12*K) - Ko;\r\n",i+="    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r\n",i+="    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r\n",i+="\r\n",i+="    vec3 ox13 = fract(p13*K) - Ko;\r\n",i+="    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r\n",i+="    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r\n",i+="\r\n",i+="    vec3 ox21 = fract(p21*K) - Ko;\r\n",i+="    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r\n",i+="    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r\n",i+="\r\n",i+="    vec3 ox22 = fract(p22*K) - Ko;\r\n",i+="    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r\n",i+="    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r\n",i+="\r\n",i+="    vec3 ox23 = fract(p23*K) - Ko;\r\n",i+="    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r\n",i+="    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r\n",i+="\r\n",i+="    vec3 ox31 = fract(p31*K) - Ko;\r\n",i+="    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r\n",i+="    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r\n",i+="\r\n",i+="    vec3 ox32 = fract(p32*K) - Ko;\r\n",i+="    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r\n",i+="    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r\n",i+="\r\n",i+="    vec3 ox33 = fract(p33*K) - Ko;\r\n",i+="    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r\n",i+="    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r\n",i+="\r\n",i+="    vec3 dx11 = Pfx + jitter*ox11;\r\n",i+="    vec3 dy11 = Pfy.x + jitter*oy11;\r\n",i+="    vec3 dz11 = Pfz.x + jitter*oz11;\r\n",i+="\r\n",i+="    vec3 dx12 = Pfx + jitter*ox12;\r\n",i+="    vec3 dy12 = Pfy.x + jitter*oy12;\r\n",i+="    vec3 dz12 = Pfz.y + jitter*oz12;\r\n",i+="\r\n",i+="    vec3 dx13 = Pfx + jitter*ox13;\r\n",i+="    vec3 dy13 = Pfy.x + jitter*oy13;\r\n",i+="    vec3 dz13 = Pfz.z + jitter*oz13;\r\n",i+="\r\n",i+="    vec3 dx21 = Pfx + jitter*ox21;\r\n",i+="    vec3 dy21 = Pfy.y + jitter*oy21;\r\n",i+="    vec3 dz21 = Pfz.x + jitter*oz21;\r\n",i+="\r\n",i+="    vec3 dx22 = Pfx + jitter*ox22;\r\n",i+="    vec3 dy22 = Pfy.y + jitter*oy22;\r\n",i+="    vec3 dz22 = Pfz.y + jitter*oz22;\r\n",i+="\r\n",i+="    vec3 dx23 = Pfx + jitter*ox23;\r\n",i+="    vec3 dy23 = Pfy.y + jitter*oy23;\r\n",i+="    vec3 dz23 = Pfz.z + jitter*oz23;\r\n",i+="\r\n",i+="    vec3 dx31 = Pfx + jitter*ox31;\r\n",i+="    vec3 dy31 = Pfy.z + jitter*oy31;\r\n",i+="    vec3 dz31 = Pfz.x + jitter*oz31;\r\n",i+="\r\n",i+="    vec3 dx32 = Pfx + jitter*ox32;\r\n",i+="    vec3 dy32 = Pfy.z + jitter*oy32;\r\n",i+="    vec3 dz32 = Pfz.y + jitter*oz32;\r\n",i+="\r\n",i+="    vec3 dx33 = Pfx + jitter*ox33;\r\n",i+="    vec3 dy33 = Pfy.z + jitter*oy33;\r\n",i+="    vec3 dz33 = Pfz.z + jitter*oz33;\r\n",i+="\r\n",i+="    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r\n",i+="    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r\n",i+="    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r\n",i+="    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r\n",i+="    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r\n",i+="    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r\n",i+="    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r\n",i+="    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r\n",i+="    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r\n",i+="\r\n",i+="    vec3 d1a = min(d11, d12);\r\n",i+="    d12 = max(d11, d12);\r\n",i+="    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r\n",i+="    d13 = max(d1a, d13);\r\n",i+="    d12 = min(d12, d13); // 2nd smallest now not in d13\r\n",i+="    vec3 d2a = min(d21, d22);\r\n",i+="    d22 = max(d21, d22);\r\n",i+="    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r\n",i+="    d23 = max(d2a, d23);\r\n",i+="    d22 = min(d22, d23); // 2nd smallest now not in d23\r\n",i+="    vec3 d3a = min(d31, d32);\r\n",i+="    d32 = max(d31, d32);\r\n",i+="    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r\n",i+="    d33 = max(d3a, d33);\r\n",i+="    d32 = min(d32, d33); // 2nd smallest now not in d33\r\n",i+="    vec3 da = min(d11, d21);\r\n",i+="    d21 = max(d11, d21);\r\n",i+="    d11 = min(da, d31); // Smallest now in d11\r\n",i+="    d31 = max(da, d31); // 2nd smallest now not in d31\r\n",i+="    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r\n",i+="    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r\n",i+="    d12 = min(d12, d21); // 2nd smallest now not in d21\r\n",i+="    d12 = min(d12, d22); // nor in d22\r\n",i+="    d12 = min(d12, d31); // nor in d31\r\n",i+="    d12 = min(d12, d32); // nor in d32\r\n",i+="    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r\n",i+="    d11.y = min(d11.y,d12.z); // Only two more to go\r\n",i+="    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r\n",i+="    return sqrt(d11.xy); // F1, F2\r\n",i+="}\r\n\r\n",t.TP("worley3D","vec3 permute(vec3 x){\r\n    return mod((34.0 * x + 1.0) * x, 289.0);\r\n}\r\n\r\nvec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r\n    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r\n}\r\n\r\nvec2 worley(vec3 P, float jitter, bool manhattanDistance){\r\n    float K = 0.142857142857; // 1/7\r\n    float Ko = 0.428571428571; // 1/2-K/2\r\n    float  K2 = 0.020408163265306; // 1/(7*7)\r\n    float Kz = 0.166666666667; // 1/6\r\n    float Kzo = 0.416666666667; // 1/2-1/6*2\r\n\r\n    vec3 Pi = mod(floor(P), 289.0);\r\n    vec3 Pf = fract(P) - 0.5;\r\n\r\n    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r\n    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r\n    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r\n\r\n    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r\n    vec3 p1 = permute(p + Pi.y - 1.0);\r\n    vec3 p2 = permute(p + Pi.y);\r\n    vec3 p3 = permute(p + Pi.y + 1.0);\r\n\r\n    vec3 p11 = permute(p1 + Pi.z - 1.0);\r\n    vec3 p12 = permute(p1 + Pi.z);\r\n    vec3 p13 = permute(p1 + Pi.z + 1.0);\r\n\r\n    vec3 p21 = permute(p2 + Pi.z - 1.0);\r\n    vec3 p22 = permute(p2 + Pi.z);\r\n    vec3 p23 = permute(p2 + Pi.z + 1.0);\r\n\r\n    vec3 p31 = permute(p3 + Pi.z - 1.0);\r\n    vec3 p32 = permute(p3 + Pi.z);\r\n    vec3 p33 = permute(p3 + Pi.z + 1.0);\r\n\r\n    vec3 ox11 = fract(p11*K) - Ko;\r\n    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r\n    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r\n\r\n    vec3 ox12 = fract(p12*K) - Ko;\r\n    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r\n    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r\n\r\n    vec3 ox13 = fract(p13*K) - Ko;\r\n    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r\n    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r\n\r\n    vec3 ox21 = fract(p21*K) - Ko;\r\n    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r\n    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r\n\r\n    vec3 ox22 = fract(p22*K) - Ko;\r\n    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r\n    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r\n\r\n    vec3 ox23 = fract(p23*K) - Ko;\r\n    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r\n    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r\n\r\n    vec3 ox31 = fract(p31*K) - Ko;\r\n    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r\n    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r\n\r\n    vec3 ox32 = fract(p32*K) - Ko;\r\n    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r\n    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r\n\r\n    vec3 ox33 = fract(p33*K) - Ko;\r\n    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r\n    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r\n\r\n    vec3 dx11 = Pfx + jitter*ox11;\r\n    vec3 dy11 = Pfy.x + jitter*oy11;\r\n    vec3 dz11 = Pfz.x + jitter*oz11;\r\n\r\n    vec3 dx12 = Pfx + jitter*ox12;\r\n    vec3 dy12 = Pfy.x + jitter*oy12;\r\n    vec3 dz12 = Pfz.y + jitter*oz12;\r\n\r\n    vec3 dx13 = Pfx + jitter*ox13;\r\n    vec3 dy13 = Pfy.x + jitter*oy13;\r\n    vec3 dz13 = Pfz.z + jitter*oz13;\r\n\r\n    vec3 dx21 = Pfx + jitter*ox21;\r\n    vec3 dy21 = Pfy.y + jitter*oy21;\r\n    vec3 dz21 = Pfz.x + jitter*oz21;\r\n\r\n    vec3 dx22 = Pfx + jitter*ox22;\r\n    vec3 dy22 = Pfy.y + jitter*oy22;\r\n    vec3 dz22 = Pfz.y + jitter*oz22;\r\n\r\n    vec3 dx23 = Pfx + jitter*ox23;\r\n    vec3 dy23 = Pfy.y + jitter*oy23;\r\n    vec3 dz23 = Pfz.z + jitter*oz23;\r\n\r\n    vec3 dx31 = Pfx + jitter*ox31;\r\n    vec3 dy31 = Pfy.z + jitter*oy31;\r\n    vec3 dz31 = Pfz.x + jitter*oz31;\r\n\r\n    vec3 dx32 = Pfx + jitter*ox32;\r\n    vec3 dy32 = Pfy.z + jitter*oy32;\r\n    vec3 dz32 = Pfz.y + jitter*oz32;\r\n\r\n    vec3 dx33 = Pfx + jitter*ox33;\r\n    vec3 dy33 = Pfy.z + jitter*oy33;\r\n    vec3 dz33 = Pfz.z + jitter*oz33;\r\n\r\n    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r\n    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r\n    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r\n    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r\n    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r\n    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r\n    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r\n    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r\n    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r\n\r\n    vec3 d1a = min(d11, d12);\r\n    d12 = max(d11, d12);\r\n    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r\n    d13 = max(d1a, d13);\r\n    d12 = min(d12, d13); // 2nd smallest now not in d13\r\n    vec3 d2a = min(d21, d22);\r\n    d22 = max(d21, d22);\r\n    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r\n    d23 = max(d2a, d23);\r\n    d22 = min(d22, d23); // 2nd smallest now not in d23\r\n    vec3 d3a = min(d31, d32);\r\n    d32 = max(d31, d32);\r\n    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r\n    d33 = max(d3a, d33);\r\n    d32 = min(d32, d33); // 2nd smallest now not in d33\r\n    vec3 da = min(d11, d21);\r\n    d21 = max(d11, d21);\r\n    d11 = min(da, d31); // Smallest now in d11\r\n    d31 = max(da, d31); // 2nd smallest now not in d31\r\n    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r\n    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r\n    d12 = min(d12, d21); // 2nd smallest now not in d21\r\n    d12 = min(d12, d22); // nor in d22\r\n    d12 = min(d12, d31); // nor in d31\r\n    d12 = min(d12, d32); // nor in d32\r\n    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r\n    d11.y = min(d11.y,d12.z); // Only two more to go\r\n    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r\n    return sqrt(d11.xy); // F1, F2\r\n}\r\n\r\n","// Worley3D");const e=t.SP("worleyTemp");return t.compilationString+=`vec2 ${e} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});\r\n`,this.output.hasEndpoints&&(t.compilationString+=this.QP(this.output,t)+` = ${e};\r\n`),this.x.hasEndpoints&&(t.compilationString+=this.QP(this.x,t)+` = ${e}.x;\r\n`),this.y.hasEndpoints&&(t.compilationString+=this.QP(this.y,t)+` = ${e}.y;\r\n`),this}aD(){return super.aD()+`${this.$P}.manhattanDistance = ${this.manhattanDistance};\r\n`}serialize(){const t=super.serialize();return t.manhattanDistance=this.manhattanDistance,t}uD(t,i,e){super.uD(t,i,e),this.manhattanDistance=t.manhattanDistance}}ut([Hn("Use Manhattan Distance",Nn.Boolean,"PROPERTIES",{notifiers:{update:!1}})],KA.prototype,"manhattanDistance",void 0),v("BABYLON.WorleyNoise3DBlock",KA);v("BABYLON.SimplexPerlin3DBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("seed",Mn.Vector3),this.registerOutput("output",Mn.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this.xd[0]}get output(){return this.YP[0]}tD(t){if(super.tD(t),!this.seed.isConnected)return;if(!this.YP[0].hasEndpoints)return;let i="const float SKEWFACTOR = 1.0/3.0;\r\n";return i+="const float UNSKEWFACTOR = 1.0/6.0;\r\n",i+="const float SIMPLEX_CORNER_POS = 0.5;\r\n",i+="const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r\n",i+="float SimplexPerlin3D( vec3 P ){\r\n",i+="    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\r\n",i+="    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r\n",i+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",i+="    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r\n",i+="    vec3 g = step(x0.yzx, x0.xyz);\r\n",i+="    vec3 l = 1.0 - g;\r\n",i+="    vec3 Pi_1 = min( g.xyz, l.zxy );\r\n",i+="    vec3 Pi_2 = max( g.xyz, l.zxy );\r\n",i+="    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r\n",i+="    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r\n",i+="    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r\n",i+="    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r\n",i+="    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r\n",i+="    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r\n",i+="    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r\n",i+="    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r\n",i+="    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r\n",i+="    Pt *= Pt;\r\n",i+="    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r\n",i+="    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r\n",i+="    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r\n",i+="    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r\n",i+="    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r\n",i+="    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r\n",i+="    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r\n",i+="    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r\n",i+="    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r\n",i+="    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r\n",i+="    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r\n",i+="    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r\n",i+="    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r\n",i+="    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r\n",i+="    kernel_weights = max(0.5 - kernel_weights, 0.0);\r\n",i+="    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r\n",i+="    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r\n",i+="}\r\n",t.TP("SimplexPerlin3D","const float SKEWFACTOR = 1.0/3.0;\r\nconst float UNSKEWFACTOR = 1.0/6.0;\r\nconst float SIMPLEX_CORNER_POS = 0.5;\r\nconst float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r\nfloat SimplexPerlin3D( vec3 P ){\r\n    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\r\n    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r\n    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r\n    vec3 g = step(x0.yzx, x0.xyz);\r\n    vec3 l = 1.0 - g;\r\n    vec3 Pi_1 = min( g.xyz, l.zxy );\r\n    vec3 Pi_2 = max( g.xyz, l.zxy );\r\n    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r\n    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r\n    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r\n    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r\n    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r\n    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r\n    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r\n    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r\n    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r\n    Pt *= Pt;\r\n    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r\n    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r\n    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r\n    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r\n    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r\n    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r\n    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r\n    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r\n    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r\n    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r\n    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r\n    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r\n    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r\n    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r\n    kernel_weights = max(0.5 - kernel_weights, 0.0);\r\n    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r\n    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r\n}\r\n","// SimplexPerlin3D"),t.compilationString+=this.QP(this.YP[0],t)+` = SimplexPerlin3D(${this.seed.associatedVariableName});\r\n`,this}});v("BABYLON.NormalBlendBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("normalMap0",Mn.AutoDetect),this.registerInput("normalMap1",Mn.AutoDetect),this.registerOutput("output",Mn.Vector3),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Color4|Mn.Vector3|Mn.Vector4),this.xd[1].addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Color4|Mn.Vector3|Mn.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this.xd[0]}get normalMap1(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0],e=this.xd[0],s=this.xd[1],n=t.SP("stepR"),r=t.SP("stepG");return t.compilationString+=`float ${n} = step(0.5, ${e.associatedVariableName}.r);\r\n`,t.compilationString+=`float ${r} = step(0.5, ${e.associatedVariableName}.g);\r\n`,t.compilationString+=this.QP(i,t)+";\r\n",t.compilationString+=`${i.associatedVariableName}.r = (1.0 - ${n}) * ${e.associatedVariableName}.r * ${s.associatedVariableName}.r * 2.0 + ${n} * (1.0 - (1.0 - ${e.associatedVariableName}.r) * (1.0 - ${s.associatedVariableName}.r) * 2.0);\r\n`,t.compilationString+=`${i.associatedVariableName}.g = (1.0 - ${r}) * ${e.associatedVariableName}.g * ${s.associatedVariableName}.g * 2.0 + ${r} * (1.0 - (1.0 - ${e.associatedVariableName}.g) * (1.0 - ${s.associatedVariableName}.g) * 2.0);\r\n`,t.compilationString+=`${i.associatedVariableName}.b = ${e.associatedVariableName}.b * ${s.associatedVariableName}.b;\r\n`,this}});v("BABYLON.Rotate2dBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("input",Mn.Vector2),this.registerInput("angle",Mn.Float),this.registerOutput("output",Mn.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this.xd[0]}get angle(){return this.xd[1]}get output(){return this.YP[0]}autoConfigure(){if(!this.angle.isConnected){const t=new jn("angle");t.value=0,t.output.connectTo(this.angle)}}tD(t){super.tD(t);const i=this.YP[0],e=this.angle,s=this.input;return t.compilationString+=this.QP(i,t)+` = vec2(cos(${e.associatedVariableName}) * ${s.associatedVariableName}.x - sin(${e.associatedVariableName}) * ${s.associatedVariableName}.y, sin(${e.associatedVariableName}) * ${s.associatedVariableName}.x + cos(${e.associatedVariableName}) * ${s.associatedVariableName}.y);\r\n`,this}});v("BABYLON.ReflectBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("incident",Mn.AutoDetect),this.registerInput("normal",Mn.AutoDetect),this.registerOutput("output",Mn.Vector3),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Vector3|Mn.Vector4|Mn.Color3|Mn.Color4),this.xd[1].addExcludedConnectionPointFromAllowedTypes(Mn.Vector3|Mn.Vector4|Mn.Color3|Mn.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this.xd[0]}get normal(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);\r\n`,this}});v("BABYLON.RefractBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("incident",Mn.AutoDetect),this.registerInput("normal",Mn.AutoDetect),this.registerInput("ior",Mn.Float),this.registerOutput("output",Mn.Vector3),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Vector3|Mn.Vector4|Mn.Color3|Mn.Color4),this.xd[1].addExcludedConnectionPointFromAllowedTypes(Mn.Vector3|Mn.Vector4|Mn.Color3|Mn.Color4)}getClassName(){return"RefractBlock"}get incident(){return this.xd[0]}get normal(){return this.xd[1]}get ior(){return this.xd[2]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});\r\n`,this}});v("BABYLON.DesaturateBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("color",Mn.Color3),this.registerInput("level",Mn.Float),this.registerOutput("output",Mn.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this.xd[0]}get level(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0],e=this.color.associatedVariableName,s=t.SP("colorMin"),n=t.SP("colorMax"),r=t.SP("colorMerge");return t.compilationString+=`float ${s} = min(min(${e}.x, ${e}.y), ${e}.z);\r\n`,t.compilationString+=`float ${n} = max(max(${e}.x, ${e}.y), ${e}.z);\r\n`,t.compilationString+=`float ${r} = 0.5 * (${s} + ${n});\r\n`,t.compilationString+=this.QP(i,t)+` = mix(${e}, vec3(${r}, ${r}, ${r}), ${this.level.associatedVariableName});\r\n`,this}});class qA extends kn{constructor(t){super(t,bn.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this.WP=!0,this.registerInput("intensity",Mn.Float,!0,bn.Fragment),this.registerInput("color",Mn.Color3,!0,bn.Fragment),this.registerInput("roughness",Mn.Float,!0,bn.Fragment),this.registerOutput("sheen",Mn.Object,bn.Fragment,new OA("sheen",this,yn.Output,qA,"SheenBlock"))}initialize(t){t.AP("sheenOut"),t.AP("sheenMapData"),t.AP("vSheenColor"),t.AP("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this.xd[0]}get color(){return this.xd[1]}get roughness(){return this.xd[2]}get sheen(){return this.YP[0]}prepareDefines(t,i,e){super.prepareDefines(t,i,e),e.setValue("SHEEN",!0),e.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),e.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),e.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),e.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(t){let i="";return i=`#ifdef SHEEN\n            sheenOutParams sheenOut;\n\n            vec4 vSheenColor = vec4(${this.color.isConnected?this.color.associatedVariableName:"vec3(1.)"}, ${this.intensity.isConnected?this.intensity.associatedVariableName:"1."});\n\n            sheenBlock(\n                vSheenColor,\n            #ifdef SHEEN_ROUGHNESS\n                ${this.roughness.isConnected?this.roughness.associatedVariableName:"0."},\n            #endif\n                roughness,\n            #ifdef SHEEN_TEXTURE\n                vec4(0.),\n                1.0,\n            #endif\n                reflectance,\n            #ifdef SHEEN_LINKWITHALBEDO\n                baseColor,\n                surfaceAlbedo,\n            #endif\n            #ifdef ENVIRONMENTBRDF\n                NdotV,\n                environmentBrdf,\n            #endif\n            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n                AARoughnessFactors,\n                ${null==t?void 0:t.fot},\n                ${null==t?void 0:t.dot},\n                ${null==t?void 0:t.reflectionColor},\n                vLightingIntensity,\n                #ifdef ${null==t?void 0:t.Fht}\n                    ${null==t?void 0:t.jht},\n                #else\n                    ${null==t?void 0:t.Kht},\n                #endif\n                reflectionOut.reflectionCoords,\n                NdotVUnclamped,\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null==t?void 0:t.Fht}\n                        ${null==t?void 0:t.jht},\n                        ${null==t?void 0:t.jht},\n                    #else\n                        ${null==t?void 0:t.Kht},\n                        ${null==t?void 0:t.Kht},\n                    #endif\n                #endif\n                #if !defined(${null==t?void 0:t.Vht}) && defined(RADIANCEOCCLUSION)\n                    seo,\n                #endif\n                #if !defined(${null==t?void 0:t.Vht}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${null==t?void 0:t.Fht})\n                    eho,\n                #endif\n            #endif\n                sheenOut\n            );\n\n            #ifdef SHEEN_LINKWITHALBEDO\n                surfaceAlbedo = sheenOut.surfaceAlbedo;\n            #endif\n        #endif\r\n`,i}tD(t){return t.target===bn.Fragment&&t.sharedData.blocksWithDefines.push(this),this}aD(){let t=super.aD();return t+=`${this.$P}.albedoScaling = ${this.albedoScaling};\r\n`,t+=`${this.$P}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};\r\n`,t}serialize(){const t=super.serialize();return t.albedoScaling=this.albedoScaling,t.linkSheenWithAlbedo=this.linkSheenWithAlbedo,t}uD(t,i,e){super.uD(t,i,e),this.albedoScaling=t.albedoScaling,this.linkSheenWithAlbedo=t.linkSheenWithAlbedo}}ut([Hn("Albedo scaling",Nn.Boolean,"PROPERTIES",{notifiers:{update:!0}})],qA.prototype,"albedoScaling",void 0),ut([Hn("Link sheen with albedo",Nn.Boolean,"PROPERTIES",{notifiers:{update:!0}})],qA.prototype,"linkSheenWithAlbedo",void 0),v("BABYLON.SheenBlock",qA);class QA extends kn{constructor(t){super(t,bn.Fragment),this.mht="",this.WP=!0,this.registerInput("intensity",Mn.Float,!0,bn.Fragment),this.registerInput("direction",Mn.Vector2,!0,bn.Fragment),this.registerInput("uv",Mn.Vector2,!0),this.registerInput("worldTangent",Mn.Vector4,!0),this.registerInput("TBN",Mn.Object,!0,bn.VertexAndFragment,new OA("TBN",this,yn.Input,BA,"TBNBlock")),this.registerOutput("anisotropy",Mn.Object,bn.Fragment,new OA("anisotropy",this,yn.Output,QA,"AnisotropyBlock"))}initialize(t){t.AP("anisotropicOut"),t.AP("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this.xd[0]}get direction(){return this.xd[1]}get uv(){return this.xd[2]}get worldTangent(){return this.xd[3]}get TBN(){return this.xd[4]}get anisotropy(){return this.YP[0]}pot(t){let i="";const e=`//${this.name}`,s=this.uv,n=this.worldPositionConnectionPoint,r=this.worldNormalConnectionPoint,h=this.worldTangent;s.isConnected||console.error("You must connect the 'uv' input of the Anisotropy block!"),t.xP("derivatives","#extension GL_OES_standard_derivatives : enable");const o={search:/defined\(TANGENT\)/g,replace:h.isConnected?"defined(TANGENT)":"defined(IGNORE)"},a=this.TBN;return a.isConnected?t.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${a.associatedVariableName};\n            #endif\n            `:h.isConnected&&(i+=`vec3 tbnNormal = normalize(${r.associatedVariableName}.xyz);\r\n`,i+=`vec3 tbnTangent = normalize(${h.associatedVariableName}.xyz);\r\n`,i+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this.mht};\r\n`,i+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r\n"),i+=`\n            #if defined(${h.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                mat3 TBN = vTBN;\n            #else\n                mat3 TBN = cotangent_frame(${r.associatedVariableName+".xyz"}, ${"v_"+n.associatedVariableName+".xyz"}, ${s.isConnected?s.associatedVariableName:"vec2(0.)"}, vec2(1., 1.));\n            #endif\r\n`,t.IP("bumpFragmentMainFunctions",e,{replaceStrings:[o]}),i}getCode(t,i=!1){let e="";i&&(e+=this.pot(t));const s=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0";return e+=`anisotropicOutParams anisotropicOut;\n            anisotropicBlock(\n                vec3(${this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)"}, ${s}),\n            #ifdef ANISOTROPIC_TEXTURE\n                vec3(0.),\n            #endif\n                TBN,\n                normalW,\n                viewDirectionW,\n                anisotropicOut\n            );\r\n`,e}prepareDefines(t,i,e){super.prepareDefines(t,i,e),e.setValue("ANISOTROPIC",!0),e.setValue("ANISOTROPIC_TEXTURE",!1,!0)}bind(t,i,e){super.bind(t,i,e),e&&t.setFloat(this.mht,e.getWorldMatrix().determinant()<0?-1:1)}tD(t){return t.target===bn.Fragment&&(t.sharedData.blocksWithDefines.push(this),t.sharedData.bindableBlocks.push(this),this.mht=t.EP("tangentCorrectionFactor"),t._P(this.mht,"float")),this}}v("BABYLON.AnisotropyBlock",QA);class ZA extends zA{constructor(t){super(t),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this.WP=!0,this.registerInput("position",Mn.AutoDetect,!1,bn.Vertex),this.registerInput("world",Mn.Matrix,!1,bn.Vertex),this.registerInput("color",Mn.Color3,!0,bn.Fragment),this.registerOutput("reflection",Mn.Object,bn.Fragment,new OA("reflection",this,yn.Output,ZA,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Vector3|Mn.Vector4)}Lht(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The position input must not be connected to be able to switch!"),!1):(this.Cht(),!0)}Cht(){super.Cht(),this.getInputByName("position").target=this.generateOnlyFragmentCode?bn.Fragment:bn.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}getClassName(){return"ReflectionBlock"}get position(){return this.xd[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this.xd[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this.xd[2]}get reflection(){return this.YP[0]}get hasTexture(){return!!this.Oht()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}Oht(){return this.texture?this.texture:this.Kt.environmentTexture}prepareDefines(t,i,e){super.prepareDefines(t,i,e);const s=this.Oht(),n=s&&s.getTextureMatrix;e.setValue("REFLECTION",n,!0),n&&(e.setValue(this.mot,s.lodLevelInAlpha,!0),e.setValue(this.vot,s.linearSpecularLOD,!0),e.setValue(this.Zht,this.Kt.useRightHandedSystem?!s.invertZ:s.invertZ,!0),e.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),e.setValue("GAMMAREFLECTION",s.gammaSpace,!0),e.setValue("RGBDREFLECTION",s.isRGBD,!0),s&&s.coordinatesMode!==an.SKYBOX_MODE&&s.isCube&&(e.setValue("USESPHERICALFROMREFLECTIONMAP",!0),e.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this.Kt.getEngine().getCaps().maxVaryingVectors<=8?e.setValue("USESPHERICALINVERTEX",!1):e.setValue("USESPHERICALINVERTEX",!0)))}bind(t,i,e,s){super.bind(t,i,e);const n=this.Oht();if(!n||!s)return;n.isCube?t.setTexture(this.jht,n):t.setTexture(this.Kht,n);const r=n.getSize().width;t.setFloat3(this.fot,r,n.lodGenerationScale,n.lodGenerationOffset),t.setFloat2(this.got,r,o.Log2(r));const h=s.materialDefines,a=n.sphericalPolynomial;if(h.USESPHERICALFROMREFLECTIONMAP&&a)if(h.SPHERICAL_HARMONICS){const i=a.preScaledHarmonics;t.setVector3("vSphericalL00",i.l00),t.setVector3("vSphericalL1_1",i.l1_1),t.setVector3("vSphericalL10",i.l10),t.setVector3("vSphericalL11",i.l11),t.setVector3("vSphericalL2_2",i.l2_2),t.setVector3("vSphericalL2_1",i.l2_1),t.setVector3("vSphericalL20",i.l20),t.setVector3("vSphericalL21",i.l21),t.setVector3("vSphericalL22",i.l22)}else t.setFloat3("vSphericalX",a.x.x,a.x.y,a.x.z),t.setFloat3("vSphericalY",a.y.x,a.y.y,a.y.z),t.setFloat3("vSphericalZ",a.z.x,a.z.y,a.z.z),t.setFloat3("vSphericalXX_ZZ",a.xx.x-a.zz.x,a.xx.y-a.zz.y,a.xx.z-a.zz.z),t.setFloat3("vSphericalYY_ZZ",a.yy.x-a.zz.x,a.yy.y-a.zz.y,a.yy.z-a.zz.z),t.setFloat3("vSphericalZZ",a.zz.x,a.zz.y,a.zz.z),t.setFloat3("vSphericalXY",a.xy.x,a.xy.y,a.xy.z),t.setFloat3("vSphericalYZ",a.yz.x,a.yz.y,a.yz.z),t.setFloat3("vSphericalZX",a.zx.x,a.zx.y,a.zx.z)}handleVertexSide(t){let i=super.handleVertexSide(t);t.IP("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const e=t.SP("reflectionVector");return this.Sot=t.SP("vEnvironmentIrradiance"),t.bP(this.Sot,"vec3","defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),t._P("vSphericalL00","vec3","SPHERICAL_HARMONICS"),t._P("vSphericalL1_1","vec3","SPHERICAL_HARMONICS"),t._P("vSphericalL10","vec3","SPHERICAL_HARMONICS"),t._P("vSphericalL11","vec3","SPHERICAL_HARMONICS"),t._P("vSphericalL2_2","vec3","SPHERICAL_HARMONICS"),t._P("vSphericalL2_1","vec3","SPHERICAL_HARMONICS"),t._P("vSphericalL20","vec3","SPHERICAL_HARMONICS"),t._P("vSphericalL21","vec3","SPHERICAL_HARMONICS"),t._P("vSphericalL22","vec3","SPHERICAL_HARMONICS"),t._P("vSphericalX","vec3","SPHERICAL_HARMONICS",!0),t._P("vSphericalY","vec3","SPHERICAL_HARMONICS",!0),t._P("vSphericalZ","vec3","SPHERICAL_HARMONICS",!0),t._P("vSphericalXX_ZZ","vec3","SPHERICAL_HARMONICS",!0),t._P("vSphericalYY_ZZ","vec3","SPHERICAL_HARMONICS",!0),t._P("vSphericalZZ","vec3","SPHERICAL_HARMONICS",!0),t._P("vSphericalXY","vec3","SPHERICAL_HARMONICS",!0),t._P("vSphericalYZ","vec3","SPHERICAL_HARMONICS",!0),t._P("vSphericalZX","vec3","SPHERICAL_HARMONICS",!0),i+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n                vec3 ${e} = vec3(${this.Yht} * vec4(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;\n                #ifdef ${this.Zht}\n                    ${e}.z *= -1.0;\n                #endif\n                ${this.Sot} = computeEnvironmentIrradiance(${e});\n            #endif\r\n`,i}getCode(t,i){let e="";this.handleFragmentSideInits(t),t.IP("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),t.TP("sampleReflection",`\n            #ifdef ${this.Fht}\n                #define sampleReflection(s, c) textureCube(s, c)\n            #else\n                #define sampleReflection(s, c) texture2D(s, c)\n            #endif\r\n`,`//${this.name}`),t.TP("sampleReflectionLod",`\n            #ifdef ${this.Fht}\n                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)\n            #else\n                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)\n            #endif\r\n`,`//${this.name}`);const s=`\n            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {\n                ${this.handleFragmentSideCodeReflectionCoords("worldNormal","worldPos",!0,!0)}\n                return ${this.sot};\n            }\r\n`;return t.TP("computeReflectionCoordsPBR",s,`//${this.name}`),this.fot=t.SP("vReflectionMicrosurfaceInfos"),t._P(this.fot,"vec3"),this.dot=t.SP("vReflectionInfos"),this.got=t.SP("vReflectionFilteringInfo"),t._P(this.got,"vec2"),e+=`#ifdef REFLECTION\n            vec2 ${this.dot} = vec2(1., 0.);\n\n            reflectionOutParams reflectionOut;\n\n            reflectionBlock(\n                ${this.generateOnlyFragmentCode?this.Jht:"v_"+this.worldPosition.associatedVariableName}.xyz,\n                ${i},\n                alphaG,\n                ${this.fot},\n                ${this.dot},\n                ${this.reflectionColor},\n            #ifdef ANISOTROPIC\n                anisotropicOut,\n            #endif\n            #if defined(${this.mot}) && !defined(${this.Vht})\n                NdotVUnclamped,\n            #endif\n            #ifdef ${this.vot}\n                roughness,\n            #endif\n            #ifdef ${this.Fht}\n                ${this.jht},\n            #else\n                ${this.Kht},\n            #endif\n            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n                ${this.Sot},\n            #endif\n            #ifdef USESPHERICALFROMREFLECTIONMAP\n                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                    ${this.Yht},\n                #endif\n            #endif\n            #ifdef USEIRRADIANCEMAP\n                irradianceSampler, // ** not handled **\n            #endif\n            #ifndef LODBASEDMICROSFURACE\n                #ifdef ${this.Fht}\n                    ${this.jht},\n                    ${this.jht},\n                #else\n                    ${this.Kht},\n                    ${this.Kht},\n                #endif\n            #endif\n            #ifdef REALTIME_FILTERING\n                ${this.got},\n            #endif\n                reflectionOut\n            );\n        #endif\r\n`,e}tD(t){return this.Kt=t.sharedData.scene,t.target!==bn.Fragment&&(this.mot=t.EP("LODINREFLECTIONALPHA"),this.vot=t.EP("LINEARSPECULARREFLECTION")),this}aD(){let t=super.aD();return this.texture&&(t+=`${this.$P}.texture.gammaSpace = ${this.texture.gammaSpace};\r\n`),t+=`${this.$P}.useSphericalHarmonics = ${this.useSphericalHarmonics};\r\n`,t+=`${this.$P}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};\r\n`,t}serialize(){var t,i;const e=super.serialize();return e.useSphericalHarmonics=this.useSphericalHarmonics,e.forceIrradianceInFragment=this.forceIrradianceInFragment,e.gammaSpace=null===(i=null===(t=this.texture)||void 0===t?void 0:t.gammaSpace)||void 0===i||i,e}uD(t,i,e){super.uD(t,i,e),this.useSphericalHarmonics=t.useSphericalHarmonics,this.forceIrradianceInFragment=t.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=t.gammaSpace)}}ut([Hn("Spherical Harmonics",Nn.Boolean,"ADVANCED",{notifiers:{update:!0}})],ZA.prototype,"useSphericalHarmonics",void 0),ut([Hn("Force irradiance in fragment",Nn.Boolean,"ADVANCED",{notifiers:{update:!0}})],ZA.prototype,"forceIrradianceInFragment",void 0),v("BABYLON.ReflectionBlock",ZA);class JA extends kn{constructor(t){super(t,bn.Fragment),this.mht="",this.remapF0OnInterfaceChange=!0,this.WP=!0,this.registerInput("intensity",Mn.Float,!1,bn.Fragment),this.registerInput("roughness",Mn.Float,!0,bn.Fragment),this.registerInput("indexOfRefraction",Mn.Float,!0,bn.Fragment),this.registerInput("normalMapColor",Mn.Color3,!0,bn.Fragment),this.registerInput("uv",Mn.Vector2,!0,bn.Fragment),this.registerInput("tintColor",Mn.Color3,!0,bn.Fragment),this.registerInput("tintAtDistance",Mn.Float,!0,bn.Fragment),this.registerInput("tintThickness",Mn.Float,!0,bn.Fragment),this.registerInput("worldTangent",Mn.Vector4,!0),this.registerInput("worldNormal",Mn.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(Mn.Color4|Mn.Vector4|Mn.Vector3),this.registerInput("TBN",Mn.Object,!0,bn.VertexAndFragment,new OA("TBN",this,yn.Input,BA,"TBNBlock")),this.registerOutput("clearcoat",Mn.Object,bn.Fragment,new OA("clearcoat",this,yn.Output,JA,"ClearCoatBlock"))}initialize(t){t.AP("clearcoatOut"),t.AP("vClearCoatParams"),t.AP("vClearCoatTintParams"),t.AP("vClearCoatRefractionParams"),t.AP("vClearCoatTangentSpaceParams"),t.AP("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this.xd[0]}get roughness(){return this.xd[1]}get indexOfRefraction(){return this.xd[2]}get normalMapColor(){return this.xd[3]}get uv(){return this.xd[4]}get tintColor(){return this.xd[5]}get tintAtDistance(){return this.xd[6]}get tintThickness(){return this.xd[7]}get worldTangent(){return this.xd[8]}get worldNormal(){return this.xd[9]}get TBN(){return this.xd[10]}get clearcoat(){return this.YP[0]}autoConfigure(){if(!this.intensity.isConnected){const t=new jn("ClearCoat intensity",bn.Fragment,Mn.Float);t.value=1,t.output.connectTo(this.intensity)}}prepareDefines(t,i,e){super.prepareDefines(t,i,e),e.setValue("CLEARCOAT",!0),e.setValue("CLEARCOAT_TEXTURE",!1,!0),e.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),e.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),e.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),e.setValue("CLEARCOAT_DEFAULTIOR",!this.indexOfRefraction.isConnected||this.indexOfRefraction.connectInputBlock.value===Sg.P6,!0),e.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(t,i,e){var s,n;super.bind(t,i,e);const r=null!==(n=null===(s=this.indexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==n?n:Sg.P6,h=1-r,o=1+r,a=Math.pow(-h/o,2),l=1/r;t.setFloat4("vClearCoatRefractionParams",a,l,h,o);const c=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,u=(null==c?void 0:c.perturbedNormal.isConnected)?c.perturbedNormal.connectedPoint.ownerBlock:null;this.Kt.Ag?t.setFloat2("vClearCoatTangentSpaceParams",(null==u?void 0:u.invertX)?1:-1,(null==u?void 0:u.invertY)?1:-1):t.setFloat2("vClearCoatTangentSpaceParams",(null==u?void 0:u.invertX)?-1:1,(null==u?void 0:u.invertY)?-1:1),e&&t.setFloat(this.mht,e.getWorldMatrix().determinant()<0?-1:1)}pot(t,i,e){let s="";const n=`//${this.name}`,r=this.worldTangent;t.xP("derivatives","#extension GL_OES_standard_derivatives : enable");const h={search:/defined\(TANGENT\)/g,replace:r.isConnected?"defined(TANGENT)":"defined(IGNORE)"},o=this.TBN;return o.isConnected?t.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${o.associatedVariableName};\n            #endif\n            `:r.isConnected&&(s+=`vec3 tbnNormal = normalize(${e}.xyz);\r\n`,s+=`vec3 tbnTangent = normalize(${r.associatedVariableName}.xyz);\r\n`,s+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this.mht};\r\n`,s+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r\n"),t.IP("bumpFragmentMainFunctions",n,{replaceStrings:[h]}),s}static GetCode(t,i,e,s,n,r,h){let o="";const a=(null==i?void 0:i.intensity.isConnected)?i.intensity.associatedVariableName:"1.",l=(null==i?void 0:i.roughness.isConnected)?i.roughness.associatedVariableName:"0.",c=(null==i?void 0:i.normalMapColor.isConnected)?i.normalMapColor.associatedVariableName:"vec3(0.)",u=(null==i?void 0:i.uv.isConnected)?i.uv.associatedVariableName:"vec2(0.)",f=(null==i?void 0:i.tintColor.isConnected)?i.tintColor.associatedVariableName:"vec3(1.)",d=(null==i?void 0:i.tintThickness.isConnected)?i.tintThickness.associatedVariableName:"1.",p=(null==i?void 0:i.tintAtDistance.isConnected)?i.tintAtDistance.associatedVariableName:"1.";if(i){t._P("vClearCoatRefractionParams","vec4"),t._P("vClearCoatTangentSpaceParams","vec2");const e=i.worldNormal;o+=`vec3 vGeometricNormaClearCoatW = ${e.isConnected?"normalize("+e.associatedVariableName+".xyz)":"geometricNormalW"};\r\n`}else o+="vec3 vGeometricNormaClearCoatW = geometricNormalW;\r\n";return n&&i&&(o+=i.pot(t,s,h),r=i.worldTangent.isConnected),o+=`clearcoatOutParams clearcoatOut;\n\n        #ifdef CLEARCOAT\n            vec2 vClearCoatParams = vec2(${a}, ${l});\n            vec4 vClearCoatTintParams = vec4(${f}, ${d});\n\n            clearcoatBlock(\n                ${s}.xyz,\n                vGeometricNormaClearCoatW,\n                viewDirectionW,\n                vClearCoatParams,\n                specularEnvironmentR0,\n            #ifdef CLEARCOAT_TEXTURE\n                vec2(0.),\n            #endif\n            #ifdef CLEARCOAT_TINT\n                vClearCoatTintParams,\n                ${p},\n                vClearCoatRefractionParams,\n                #ifdef CLEARCOAT_TINT_TEXTURE\n                    vec4(0.),\n                #endif\n            #endif\n            #ifdef CLEARCOAT_BUMP\n                vec2(0., 1.),\n                vec4(${c}, 0.),\n                ${u},\n                #if defined(${r?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                    vTBN,\n                #else\n                    vClearCoatTangentSpaceParams,\n                #endif\n                #ifdef OBJECTSPACE_NORMALMAP\n                    normalMatrix,\n                #endif\n            #endif\n            #if defined(FORCENORMALFORWARD) && defined(NORMAL)\n                faceNormal,\n            #endif\n            #ifdef REFLECTION\n                ${null==e?void 0:e.fot},\n                ${null==e?void 0:e.dot},\n                ${null==e?void 0:e.reflectionColor},\n                vLightingIntensity,\n                #ifdef ${null==e?void 0:e.Fht}\n                    ${null==e?void 0:e.jht},\n                #else\n                    ${null==e?void 0:e.Kht},\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null==e?void 0:e.Fht}\n                        ${null==e?void 0:e.jht},\n                        ${null==e?void 0:e.jht},\n                    #else\n                        ${null==e?void 0:e.Kht},\n                        ${null==e?void 0:e.Kht},\n                    #endif\n                #endif\n            #endif\n            #if defined(ENVIRONMENTBRDF) && !defined(${null==e?void 0:e.Vht})\n                #ifdef RADIANCEOCCLUSION\n                    ambientMonochrome,\n                #endif\n            #endif\n            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n                (gl_FrontFacing ? 1. : -1.),\n            #endif\n                clearcoatOut\n            );\n        #else\n            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;\n        #endif\r\n`,o}tD(t){return this.Kt=t.sharedData.scene,t.target===bn.Fragment&&(t.sharedData.bindableBlocks.push(this),t.sharedData.blocksWithDefines.push(this),this.mht=t.EP("tangentCorrectionFactor"),t._P(this.mht,"float")),this}aD(){let t=super.aD();return t+=`${this.$P}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};\r\n`,t}serialize(){const t=super.serialize();return t.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,t}uD(t,i,e){var s;super.uD(t,i,e),this.remapF0OnInterfaceChange=null===(s=t.remapF0OnInterfaceChange)||void 0===s||s}}ut([Hn("Remap F0 on interface change",Nn.Boolean,"ADVANCED")],JA.prototype,"remapF0OnInterfaceChange",void 0),v("BABYLON.ClearCoatBlock",JA);class tC extends kn{constructor(t){super(t,bn.Fragment),this.WP=!0,this.registerInput("intensity",Mn.Float,!0,bn.Fragment),this.registerInput("indexOfRefraction",Mn.Float,!0,bn.Fragment),this.registerInput("thickness",Mn.Float,!0,bn.Fragment),this.registerOutput("iridescence",Mn.Object,bn.Fragment,new OA("iridescence",this,yn.Output,tC,"IridescenceBlock"))}initialize(t){t.AP("iridescenceOut"),t.AP("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this.xd[0]}get indexOfRefraction(){return this.xd[1]}get thickness(){return this.xd[2]}get iridescence(){return this.YP[0]}autoConfigure(){if(!this.intensity.isConnected){const t=new jn("Iridescence intensity",bn.Fragment,Mn.Float);t.value=1,t.output.connectTo(this.intensity);const i=new jn("Iridescence ior",bn.Fragment,Mn.Float);i.value=1.3,i.output.connectTo(this.indexOfRefraction);const e=new jn("Iridescence thickness",bn.Fragment,Mn.Float);e.value=400,e.output.connectTo(this.thickness)}}prepareDefines(t,i,e){super.prepareDefines(t,i,e),e.setValue("IRIDESCENCE",!0,!0),e.setValue("IRIDESCENCE_TEXTURE",!1,!0),e.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(t){let i="";return i+=`iridescenceOutParams iridescenceOut;\n\n        #ifdef IRIDESCENCE\n            iridescenceBlock(\n                vec4(${(null==t?void 0:t.intensity.isConnected)?t.intensity.associatedVariableName:"1."}, ${(null==t?void 0:t.indexOfRefraction.isConnected)?t.indexOfRefraction.associatedVariableName:Ag.P6}, 1., ${(null==t?void 0:t.thickness.isConnected)?t.thickness.associatedVariableName:Ag.k6}),\n                NdotV,\n                specularEnvironmentR0,\n                #ifdef CLEARCOAT\n                    NdotVUnclamped,\n                #endif\n                iridescenceOut\n            );\n\n            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;\n            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;\n        #endif\r\n`,i}tD(t){return t.target===bn.Fragment&&(t.sharedData.bindableBlocks.push(this),t.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}uD(t,i,e){super.uD(t,i,e)}}v("BABYLON.IridescenceBlock",tC);class iC extends kn{constructor(t){super(t,bn.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this.WP=!0,this.registerInput("intensity",Mn.Float,!1,bn.Fragment),this.registerInput("tintAtDistance",Mn.Float,!0,bn.Fragment),this.registerInput("volumeIndexOfRefraction",Mn.Float,!0,bn.Fragment),this.registerOutput("refraction",Mn.Object,bn.Fragment,new OA("refraction",this,yn.Output,iC,"RefractionBlock"))}initialize(t){t.AP("vRefractionPosition"),t.AP("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this.xd[0]}get tintAtDistance(){return this.xd[1]}get volumeIndexOfRefraction(){return this.xd[2]}get view(){return this.viewConnectionPoint}get refraction(){return this.YP[0]}get hasTexture(){return!!this.Oht()}Oht(){return this.texture?this.texture:this.Kt.environmentTexture}autoConfigure(t){if(!this.intensity.isConnected){const t=new jn("Refraction intensity",bn.Fragment,Mn.Float);t.value=1,t.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.View));i||(i=new jn("view"),i.setAsSystemValue(Dn.View)),i.output.connectTo(this.view)}}prepareDefines(t,i,e){super.prepareDefines(t,i,e);const s=this.Oht(),n=s&&s.getTextureMatrix;e.setValue("SS_REFRACTION",n,!0),n&&(e.setValue(this.Fht,s.isCube,!0),e.setValue(this.Eot,s.lodLevelInAlpha,!0),e.setValue(this.Aot,s.linearSpecularLOD,!0),e.setValue(this.Zht,this.Kt.useRightHandedSystem?!s.invertZ:s.invertZ,!0),e.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),e.setValue("SS_GAMMAREFRACTION",s.gammaSpace,!0),e.setValue("SS_RGBDREFRACTION",s.isRGBD,!0),e.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!s.boundingBoxSize,!0),e.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const t=this.Oht();return!(t&&!t.isReadyOrNotBlocking())}bind(t,i,e){var s,n,r,h;super.bind(t,i,e);const a=this.Oht();if(!a)return;a.isCube?t.setTexture(this.jht,a):t.setTexture(this.Kht,a),t.setMatrix(this.Cot,a.getReflectionTextureMatrix());let l=1;a.isCube||a.depth&&(l=a.depth);const c=null!==(h=null!==(n=null===(s=this.volumeIndexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==n?n:null===(r=this.indexOfRefractionConnectionPoint.connectInputBlock)||void 0===r?void 0:r.value)&&void 0!==h?h:1.5;t.setFloat4(this.wot,a.level,1/c,l,this.invertRefractionY?-1:1),t.setFloat4(this.xot,a.getSize().width,a.lodGenerationScale,a.lodGenerationOffset,1/c);const u=a.getSize().width;if(t.setFloat2(this.Tot,u,o.Log2(u)),a.boundingBoxSize){const i=a;t.setVector3("vRefractionPosition",i.boundingBoxPosition),t.setVector3("vRefractionSize",i.boundingBoxSize)}}getCode(t){return t.sharedData.blockingBlocks.push(this),t.sharedData.textureBlocks.push(this),this.jht=t.SP(this.name+"CubeSampler"),t.samplers.push(this.jht),this.Kht=t.SP(this.name+"2DSampler"),t.samplers.push(this.Kht),this.Fht=t.EP("SS_REFRACTIONMAP_3D"),t.fP+=`#ifdef ${this.Fht}\r\n`,t.fP+=`uniform samplerCube ${this.jht};\r\n`,t.fP+="#else\r\n",t.fP+=`uniform sampler2D ${this.Kht};\r\n`,t.fP+="#endif\r\n",t.sharedData.blocksWithDefines.push(this),t.sharedData.bindableBlocks.push(this),this.Eot=t.EP("SS_LODINREFRACTIONALPHA"),this.Aot=t.EP("SS_LINEARSPECULARREFRACTION"),this.Zht=t.EP("SS_REFRACTIONMAP_OPPOSITEZ"),this.Cot=t.SP("refractionMatrix"),t._P(this.Cot,"mat4"),t.TP("sampleRefraction",`\n            #ifdef ${this.Fht}\n                #define sampleRefraction(s, c) textureCube(s, c)\n            #else\n                #define sampleRefraction(s, c) texture2D(s, c)\n            #endif\r\n`,`//${this.name}`),t.TP("sampleRefractionLod",`\n            #ifdef ${this.Fht}\n                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)\n            #else\n                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)\n            #endif\r\n`,`//${this.name}`),this.xot=t.SP("vRefractionMicrosurfaceInfos"),t._P(this.xot,"vec4"),this.wot=t.SP("vRefractionInfos"),t._P(this.wot,"vec4"),this.Tot=t.SP("vRefractionFilteringInfo"),t._P(this.Tot,"vec2"),t._P("vRefractionPosition","vec3"),t._P("vRefractionSize","vec3"),""}tD(t){return this.Kt=t.sharedData.scene,this}aD(){let t=super.aD();return this.texture&&(t=this.texture.isCube?`${this.$P}.texture = new BABYLON.CubeTexture("${this.texture.name}");\r\n`:`${this.$P}.texture = new BABYLON.Texture("${this.texture.name}");\r\n`,t+=`${this.$P}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`),t+=`${this.$P}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};\r\n`,t+=`${this.$P}.invertRefractionY = ${this.invertRefractionY};\r\n`,t+=`${this.$P}.useThicknessAsDepth = ${this.useThicknessAsDepth};\r\n`,t}serialize(){const t=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(t.texture=this.texture.serialize()),t.linkRefractionWithTransparency=this.linkRefractionWithTransparency,t.invertRefractionY=this.invertRefractionY,t.useThicknessAsDepth=this.useThicknessAsDepth,t}uD(t,i,e){super.uD(t,i,e),t.texture&&(e=0===t.texture.url.indexOf("data:")?"":e,t.texture.isCube?this.texture=Rm.Parse(t.texture,i,e):this.texture=an.Parse(t.texture,i,e)),this.linkRefractionWithTransparency=t.linkRefractionWithTransparency,this.invertRefractionY=t.invertRefractionY,this.useThicknessAsDepth=!!t.useThicknessAsDepth}}ut([Hn("Link refraction to transparency",Nn.Boolean,"ADVANCED",{notifiers:{update:!0}})],iC.prototype,"linkRefractionWithTransparency",void 0),ut([Hn("Invert refraction Y",Nn.Boolean,"ADVANCED",{notifiers:{update:!0}})],iC.prototype,"invertRefractionY",void 0),ut([Hn("Use thickness as depth",Nn.Boolean,"ADVANCED",{notifiers:{update:!0}})],iC.prototype,"useThicknessAsDepth",void 0),v("BABYLON.RefractionBlock",iC);class eC extends kn{constructor(t){super(t,bn.Fragment),this.WP=!0,this.registerInput("thickness",Mn.Float,!1,bn.Fragment),this.registerInput("tintColor",Mn.Color3,!0,bn.Fragment),this.registerInput("translucencyIntensity",Mn.Float,!0,bn.Fragment),this.registerInput("translucencyDiffusionDist",Mn.Color3,!0,bn.Fragment),this.registerInput("refraction",Mn.Object,!0,bn.Fragment,new OA("refraction",this,yn.Input,iC,"RefractionBlock")),this.registerOutput("subsurface",Mn.Object,bn.Fragment,new OA("subsurface",this,yn.Output,eC,"SubSurfaceBlock"))}initialize(t){t.AP("subSurfaceOut"),t.AP("vThicknessParam"),t.AP("vTintColor"),t.AP("vSubSurfaceIntensity")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this.xd[0]}get tintColor(){return this.xd[1]}get translucencyIntensity(){return this.xd[2]}get translucencyDiffusionDist(){return this.xd[3]}get refraction(){return this.xd[4]}get subsurface(){return this.YP[0]}autoConfigure(){if(!this.thickness.isConnected){const t=new jn("SubSurface thickness",bn.Fragment,Mn.Float);t.value=0,t.output.connectTo(this.thickness)}}prepareDefines(t,i,e){super.prepareDefines(t,i,e);const s=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;e.setValue("SUBSURFACE",s||this.refraction.isConnected,!0),e.setValue("SS_TRANSLUCENCY",s,!0),e.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),e.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),e.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),e.setValue("SS_MASK_FROM_THICKNESS_TEXTURE",!1,!0),e.setValue("SS_USE_GLTF_TEXTURES",!1,!0)}static GetCode(t,i,e,s){var n,r,h,o,a,l,c,u,f,d,p,m,v,g,S,E;let A="";const C=(null==i?void 0:i.thickness.isConnected)?i.thickness.associatedVariableName:"0.",w=(null==i?void 0:i.tintColor.isConnected)?i.tintColor.associatedVariableName:"vec3(1.)",x=(null==i?void 0:i.translucencyIntensity.isConnected)?null==i?void 0:i.translucencyIntensity.associatedVariableName:"1.",T=(null==i?void 0:i.translucencyDiffusionDist.isConnected)?null==i?void 0:i.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",R=(null==i?void 0:i.refraction.isConnected)?null===(n=null==i?void 0:i.refraction.connectedPoint)||void 0===n?void 0:n.ownerBlock:null,I=(null==R?void 0:R.tintAtDistance.isConnected)?R.tintAtDistance.associatedVariableName:"1.",M=(null==R?void 0:R.intensity.isConnected)?R.intensity.associatedVariableName:"1.",b=(null==R?void 0:R.view.isConnected)?R.view.associatedVariableName:"";return A+=null!==(r=null==R?void 0:R.getCode(t))&&void 0!==r?r:"",A+=`subSurfaceOutParams subSurfaceOut;\n\n        #ifdef SUBSURFACE\n            vec2 vThicknessParam = vec2(0., ${C});\n            vec4 vTintColor = vec4(${w}, ${I});\n            vec3 vSubSurfaceIntensity = vec3(${M}, ${x}, 0.);\n\n            subSurfaceBlock(\n                vSubSurfaceIntensity,\n                vThicknessParam,\n                vTintColor,\n                normalW,\n                specularEnvironmentReflectance,\n            #ifdef SS_THICKNESSANDMASK_TEXTURE\n                vec4(0.),\n            #endif\n            #ifdef REFLECTION\n                #ifdef SS_TRANSLUCENCY\n                    ${null==e?void 0:e.Yht},\n                    #ifdef USESPHERICALFROMREFLECTIONMAP\n                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                            reflectionOut.irradianceVector,\n                        #endif\n                        #if defined(REALTIME_FILTERING)\n                            ${null==e?void 0:e.jht},\n                            ${null==e?void 0:e.got},\n                        #endif\n                        #endif\n                    #ifdef USEIRRADIANCEMAP\n                        irradianceSampler,\n                    #endif\n                #endif\n            #endif\n            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n                surfaceAlbedo,\n            #endif\n            #ifdef SS_REFRACTION\n                ${s}.xyz,\n                viewDirectionW,\n                ${b},\n                ${null!==(h=null==R?void 0:R.wot)&&void 0!==h?h:""},\n                ${null!==(o=null==R?void 0:R.Cot)&&void 0!==o?o:""},\n                ${null!==(a=null==R?void 0:R.xot)&&void 0!==a?a:""},\n                vLightingIntensity,\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha,\n                #endif\n                #ifdef ${null!==(l=null==R?void 0:R.Eot)&&void 0!==l?l:"IGNORE"}\n                    NdotVUnclamped,\n                #endif\n                #ifdef ${null!==(c=null==R?void 0:R.Aot)&&void 0!==c?c:"IGNORE"}\n                    roughness,\n                #endif\n                alphaG,\n                #ifdef ${null!==(u=null==R?void 0:R.Fht)&&void 0!==u?u:"IGNORE"}\n                    ${null!==(f=null==R?void 0:R.jht)&&void 0!==f?f:""},\n                #else\n                    ${null!==(d=null==R?void 0:R.Kht)&&void 0!==d?d:""},\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null!==(p=null==R?void 0:R.Fht)&&void 0!==p?p:"IGNORE"}\n                        ${null!==(m=null==R?void 0:R.jht)&&void 0!==m?m:""},\n                        ${null!==(v=null==R?void 0:R.jht)&&void 0!==v?v:""},\n                    #else\n                        ${null!==(g=null==R?void 0:R.Kht)&&void 0!==g?g:""},\n                        ${null!==(S=null==R?void 0:R.Kht)&&void 0!==S?S:""},\n                    #endif\n                #endif\n                #ifdef ANISOTROPIC\n                    anisotropicOut,\n                #endif\n                #ifdef REALTIME_FILTERING\n                    ${null!==(E=null==R?void 0:R.Tot)&&void 0!==E?E:""},\n                #endif\n                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n                    vRefractionPosition,\n                    vRefractionSize,\n                #endif\n            #endif\n            #ifdef SS_TRANSLUCENCY\n                ${T},\n            #endif\n                subSurfaceOut\n            );\n\n            #ifdef SS_REFRACTION\n                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha = subSurfaceOut.alpha;\n                #endif\n            #endif\n        #else\n            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;\n        #endif\r\n`,A}tD(t){return t.target===bn.Fragment&&t.sharedData.blocksWithDefines.push(this),this}}v("BABYLON.SubSurfaceBlock",eC);const sC={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["shadow",""],alpha:["alpha",""]};class nC extends kn{constructor(t){super(t,bn.VertexAndFragment),this.X8=null,this.v8=_.White(),this.m8=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this.WP=!0,this.registerInput("worldPosition",Mn.Vector4,!1,bn.Vertex),this.registerInput("worldNormal",Mn.Vector4,!1,bn.Fragment),this.registerInput("view",Mn.Matrix,!1),this.registerInput("cameraPosition",Mn.Vector3,!1,bn.Fragment),this.registerInput("perturbedNormal",Mn.Vector4,!0,bn.Fragment),this.registerInput("baseColor",Mn.Color3,!0,bn.Fragment),this.registerInput("metallic",Mn.Float,!1,bn.Fragment),this.registerInput("roughness",Mn.Float,!1,bn.Fragment),this.registerInput("ambientOcc",Mn.Float,!0,bn.Fragment),this.registerInput("opacity",Mn.Float,!0,bn.Fragment),this.registerInput("indexOfRefraction",Mn.Float,!0,bn.Fragment),this.registerInput("ambientColor",Mn.Color3,!0,bn.Fragment),this.registerInput("reflection",Mn.Object,!0,bn.Fragment,new OA("reflection",this,yn.Input,ZA,"ReflectionBlock")),this.registerInput("clearcoat",Mn.Object,!0,bn.Fragment,new OA("clearcoat",this,yn.Input,JA,"ClearCoatBlock")),this.registerInput("sheen",Mn.Object,!0,bn.Fragment,new OA("sheen",this,yn.Input,qA,"SheenBlock")),this.registerInput("subsurface",Mn.Object,!0,bn.Fragment,new OA("subsurface",this,yn.Input,eC,"SubSurfaceBlock")),this.registerInput("anisotropy",Mn.Object,!0,bn.Fragment,new OA("anisotropy",this,yn.Input,QA,"AnisotropyBlock")),this.registerInput("iridescence",Mn.Object,!0,bn.Fragment,new OA("iridescence",this,yn.Input,tC,"IridescenceBlock")),this.registerOutput("ambientClr",Mn.Color3,bn.Fragment),this.registerOutput("diffuseDir",Mn.Color3,bn.Fragment),this.registerOutput("specularDir",Mn.Color3,bn.Fragment),this.registerOutput("clearcoatDir",Mn.Color3,bn.Fragment),this.registerOutput("sheenDir",Mn.Color3,bn.Fragment),this.registerOutput("diffuseInd",Mn.Color3,bn.Fragment),this.registerOutput("specularInd",Mn.Color3,bn.Fragment),this.registerOutput("clearcoatInd",Mn.Color3,bn.Fragment),this.registerOutput("sheenInd",Mn.Color3,bn.Fragment),this.registerOutput("refraction",Mn.Color3,bn.Fragment),this.registerOutput("lighting",Mn.Color3,bn.Fragment),this.registerOutput("shadow",Mn.Float,bn.Fragment),this.registerOutput("alpha",Mn.Float,bn.Fragment)}static Aht(t,i){const e=t;return e.worldPosition.isConnected?(e.generateOnlyFragmentCode=!e.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(e.Cht(),!0)}Cht(){this.qP(this.generateOnlyFragmentCode?bn.Fragment:bn.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?bn.Fragment:bn.Vertex}initialize(t){t.AP("vLightingIntensity"),t.AP("geometricNormalW"),t.AP("normalW"),t.AP("faceNormal"),t.AP("albedoOpacityOut"),t.AP("surfaceAlbedo"),t.AP("alpha"),t.AP("aoOut"),t.AP("baseColor"),t.AP("reflectivityOut"),t.AP("microSurface"),t.AP("roughness"),t.AP("NdotVUnclamped"),t.AP("NdotV"),t.AP("alphaG"),t.AP("AARoughnessFactors"),t.AP("environmentBrdf"),t.AP("ambientMonochrome"),t.AP("seo"),t.AP("eho"),t.AP("environmentRadiance"),t.AP("irradianceVector"),t.AP("environmentIrradiance"),t.AP("diffuseBase"),t.AP("specularBase"),t.AP("preInfo"),t.AP("info"),t.AP("shadow"),t.AP("finalDiffuse"),t.AP("finalAmbient"),t.AP("ambientOcclusionForDirectDiffuse"),t.AP("finalColor"),t.AP("vClipSpacePosition"),t.AP("vDebugMode")}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this.xd[0]}get worldNormal(){return this.xd[1]}get view(){return this.xd[2]}get cameraPosition(){return this.xd[3]}get perturbedNormal(){return this.xd[4]}get baseColor(){return this.xd[5]}get metallic(){return this.xd[6]}get roughness(){return this.xd[7]}get ambientOcc(){return this.xd[8]}get opacity(){return this.xd[9]}get indexOfRefraction(){return this.xd[10]}get ambientColor(){return this.xd[11]}get reflection(){return this.xd[12]}get clearcoat(){return this.xd[13]}get sheen(){return this.xd[14]}get subsurface(){return this.xd[15]}get anisotropy(){return this.xd[16]}get iridescence(){return this.xd[17]}get ambientClr(){return this.YP[0]}get diffuseDir(){return this.YP[1]}get specularDir(){return this.YP[2]}get clearcoatDir(){return this.YP[3]}get sheenDir(){return this.YP[4]}get diffuseInd(){return this.YP[5]}get specularInd(){return this.YP[6]}get clearcoatInd(){return this.YP[7]}get sheenInd(){return this.YP[8]}get refraction(){return this.YP[9]}get lighting(){return this.YP[10]}get shadow(){return this.YP[11]}get alpha(){return this.YP[12]}autoConfigure(t){if(!this.cameraPosition.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.CameraPosition));i||(i=new jn("cameraPosition"),i.setAsSystemValue(Dn.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let i=t.getInputBlockByPredicate((t=>t.systemValue===Dn.View));i||(i=new jn("view"),i.setAsSystemValue(Dn.View)),i.output.connectTo(this.view)}}prepareDefines(t,i,e){e.setValue("PBR",!0),e.setValue("METALLICWORKFLOW",!0),e.setValue("DEBUGMODE",this.debugMode,!0),e.setValue("NORMALXYSCALE",!0),e.setValue("BUMP",this.perturbedNormal.isConnected,!0),e.setValue("LODBASEDMICROSFURACE",this.Kt.getEngine().getCaps().textureLOD),e.setValue("ALBEDO",!1,!0),e.setValue("OPACITY",this.opacity.isConnected,!0),e.setValue("AMBIENT",!0,!0),e.setValue("AMBIENTINGRAYSCALE",!1,!0),e.setValue("REFLECTIVITY",!1,!0),e.setValue("AOSTOREINMETALMAPRED",!1,!0),e.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),e.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),e.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===_g.LIGHTFALLOFF_STANDARD?(e.setValue("USEPHYSICALLIGHTFALLOFF",!1),e.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===_g.LIGHTFALLOFF_GLTF?(e.setValue("USEPHYSICALLIGHTFALLOFF",!1),e.setValue("USEGLTFLIGHTFALLOFF",!0)):(e.setValue("USEPHYSICALLIGHTFALLOFF",!0),e.setValue("USEGLTFLIGHTFALLOFF",!1));const s=this.alphaTestCutoff.toString();e.setValue("ALPHABLEND",this.useAlphaBlending,!0),e.setValue("ALPHAFROMALBEDO",!1,!0),e.setValue("ALPHATEST",this.useAlphaTest,!0),e.setValue("ALPHATESTVALUE",s.indexOf(".")<0?s+".":s,!0),e.setValue("OPACITYRGB",!1,!0),e.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),e.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),e.setValue("SPECULARAA",this.Kt.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),e.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const n=t.getScene();if(n.getEngine().hs.needTypeSuffixInShaderConstants?e.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):e.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),e.setValue("BRDF_V_HEIGHT_CORRELATED",!0),e.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),e.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),e.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),e.setValue("UNLIT",this.unlit,!0),e.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this.X8&&Bo.ReflectionTextureEnabled?(e.setValue("ENVIRONMENTBRDF",!0),e.setValue("ENVIRONMENTBRDF_RGBD",this.X8.isRGBD,!0)):(e.setValue("ENVIRONMENTBRDF",!1),e.setValue("ENVIRONMENTBRDF_RGBD",!1)),e.Dl&&i.imageProcessingConfiguration&&i.imageProcessingConfiguration.prepareDefines(e),e.Il)if(this.light){const i={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Fs.PrepareDefinesForLight(n,t,this.light,this.Eht,e,!0,i),i.needRebuild&&e.rebuild()}else Fs.PrepareDefinesForLights(n,t,e,!0,i.maxSimultaneousLights),e.Fl=!0,Fs.PrepareDefinesForMultiview(n,e)}updateUniformsAndSamples(t,i,e,s){for(let n=0;n<i.maxSimultaneousLights&&e["LIGHT"+n];n++){const i=t.uniforms.indexOf("vLightData"+n)>=0;Fs.PrepareUniformsAndSamplersForLight(n,t.uniforms,t.samplers,e["PROJECTEDLIGHTTEXTURE"+n],s,i)}}isReady(t,i,e){return!(this.X8&&!this.X8.isReady())&&!(e.Dl&&i.imageProcessingConfiguration&&!i.imageProcessingConfiguration.isReady())}bind(t,i,e){var s,n;if(!e)return;const r=e.getScene();this.light?Fs.BindLight(this.light,this.Eht,r,t,!0):Fs.BindLights(r,e,t,!0,i.maxSimultaneousLights),t.setTexture(this.Rot,this.X8),t.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const h=this.Kt.ambientColor;h&&t.setColor3("ambientFromScene",h);const o=r.useRightHandedSystem===(null!=r.Ag);t.setFloat(this.Iot,o?-1:1),t.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this.Kt.environmentIntensity,this.specularIntensity);const a=null!==(n=null===(s=this.indexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==n?n:1.5,l=Math.pow((a-1)/(a+1),2);this.v8.scaleToRef(l*this.m8,N.Color3[0]);const c=this.m8;t.setColor4(this.Mot,N.Color3[0],c),i.imageProcessingConfiguration&&i.imageProcessingConfiguration.bind(t)}MD(t){var i,e;const s=this.worldPosition,n=`//${this.name}`;this.light?(this.Eht=(void 0!==t.counters.lightCounter?t.counters.lightCounter:-1)+1,t.counters.lightCounter=this.Eht,t.IP(t.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",n,{replaceStrings:[{search:/{X}/g,replace:this.Eht.toString()}]},this.Eht.toString())):(t.IP(t.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",n,{repeatKey:"maxSimultaneousLights"}),this.Eht=0,t.sharedData.dynamicUniformBlocks.push(this));const r="v_"+s.associatedVariableName;t.bP(r,"vec4")&&(t.compilationString+=`${r} = ${s.associatedVariableName};\r\n`);const h=this.reflection.isConnected?null===(i=this.reflection.connectedPoint)||void 0===i?void 0:i.ownerBlock:null;h&&(h.viewConnectionPoint=this.view),t.compilationString+=null!==(e=null==h?void 0:h.handleVertexSide(t))&&void 0!==e?e:"",t.bP("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(t.pP+="#if DEBUGMODE > 0\r\n",t.pP+="vClipSpacePosition = gl_Position;\r\n",t.pP+="#endif\r\n"),this.light?t.compilationString+=t.RP("shadowsVertex",n,{replaceStrings:[{search:/{X}/g,replace:this.Eht.toString()},{search:/worldPos/g,replace:s.associatedVariableName}]}):(t.compilationString+=`vec4 worldPos = ${s.associatedVariableName};\r\n`,this.view.isConnected&&(t.compilationString+=`mat4 view = ${this.view.associatedVariableName};\r\n`),t.compilationString+=t.RP("shadowsVertex",n,{repeatKey:"maxSimultaneousLights"}))}bot(){let t="albedoOpacityOutParams albedoOpacityOut;\r\n";return t+=`albedoOpacityBlock(\n                vec4(${this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)"}, 1.),\n            #ifdef ALBEDO\n                vec4(1.),\n                vec2(1., 1.),\n            #endif\n            #ifdef OPACITY\n                vec4(${this.opacity.isConnected?this.opacity.associatedVariableName:"1."}),\n                vec2(1., 1.),\n            #endif\n                albedoOpacityOut\n            );\n\n            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;\n            float alpha = albedoOpacityOut.alpha;\r\n`,t}_ot(){let t="ambientOcclusionOutParams aoOut;\r\n";return t+=`ambientOcclusionBlock(\n            #ifdef AMBIENT\n                vec3(${this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1."}),\n                vec4(0., 1.0, 1.0, 0.),\n            #endif\n                aoOut\n            );\r\n`,t}yot(t){let i="reflectivityOutParams reflectivityOut;\r\n";return this.Mot=t.SP("vMetallicReflectanceFactors"),t._P(this.Mot,"vec4"),i+=`vec3 baseColor = surfaceAlbedo;\n\n            reflectivityBlock(\n                vec4(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.),\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo,\n                ${this.Mot},\n            #endif\n            #ifdef REFLECTIVITY\n                vec3(0., 0., 1.),\n                vec4(1.),\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor,\n            #endif\n            #ifdef MICROSURFACEMAP\n                microSurfaceTexel, <== not handled!\n            #endif\n                reflectivityOut\n            );\n\n            float microSurface = reflectivityOut.microSurface;\n            float roughness = reflectivityOut.roughness;\n\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo = reflectivityOut.surfaceAlbedo;\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;\n            #endif\r\n`,i}tD(t){var i,e,s,n,r,h,o,a,l,c,u,f,d,p,m,v,g,S,E,A,C,w,x,T,R,I,M,b,_,y,N,P,D,L,O,F,B,U,V,k,G;super.tD(t),this.Kt=t.sharedData.scene,this.X8||(this.X8=zm(this.Kt));const z=this.reflection.isConnected?null===(i=this.reflection.connectedPoint)||void 0===i?void 0:i.ownerBlock:null;if(z&&(z.worldPositionConnectionPoint=this.worldPosition,z.cameraPositionConnectionPoint=this.cameraPosition,z.worldNormalConnectionPoint=this.worldNormal,z.viewConnectionPoint=this.view),t.target!==bn.Fragment)return this.MD(t),this;t.sharedData.forcedBindableBlocks.push(this),t.sharedData.blocksWithDefines.push(this),t.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&t.sharedData.dynamicUniformBlocks.push(this);const H=`//${this.name}`,X=this.perturbedNormal;let W=this.worldPosition.associatedVariableName;this.generateOnlyFragmentCode?(W=t.SP("globalWorldPos"),t.TP("pbr_globalworldpos",`vec3 ${W};\r\n`,H),t.compilationString+=`${W} = ${this.worldPosition.associatedVariableName}.xyz;\r\n`,t.compilationString+=t.RP("shadowsVertex",H,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),t.compilationString+="#if DEBUGMODE > 0\r\n",t.compilationString+="vec4 vClipSpacePosition = vec4((vec2(gl_FragCoord.xy) / vec2(1.0)) * 2.0 - 1.0, 0.0, 1.0);\r\n",t.compilationString+="#endif\r\n"):W="v_"+W,this.Rot=t.SP("environmentBrdfSampler"),t.CP(this.Rot),t.sharedData.hints.needAlphaBlending=t.sharedData.hints.needAlphaBlending||this.useAlphaBlending,t.sharedData.hints.needAlphaTesting=t.sharedData.hints.needAlphaTesting||this.useAlphaTest,t.xP("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),t.xP("derivatives","#extension GL_OES_standard_derivatives : enable"),t._P("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),t._P("ambientFromScene","vec3"),t.uniforms.push("exposureLinear"),t.uniforms.push("contrast"),t.uniforms.push("vInverseScreenSize"),t.uniforms.push("vignetteSettings1"),t.uniforms.push("vignetteSettings2"),t.uniforms.push("vCameraColorCurveNegative"),t.uniforms.push("vCameraColorCurveNeutral"),t.uniforms.push("vCameraColorCurvePositive"),t.uniforms.push("txColorTransform"),t.uniforms.push("colorTransformSettings"),t.uniforms.push("ditherIntensity"),this.light?t.IP(t.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",H,{replaceStrings:[{search:/{X}/g,replace:this.Eht.toString()}]},this.Eht.toString()):t.IP(t.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",H,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),t.IP("helperFunctions",H),t.IP("importanceSampling",H),t.IP("pbrHelperFunctions",H),t.IP("imageProcessingDeclaration",H),t.IP("imageProcessingFunctions",H),t.IP("shadowsFragmentFunctions",H,{replaceStrings:[{search:/vPositionW/g,replace:W+".xyz"}]}),t.IP("pbrDirectLightingSetupFunctions",H,{replaceStrings:[{search:/vPositionW/g,replace:W+".xyz"}]}),t.IP("pbrDirectLightingFalloffFunctions",H),t.IP("pbrBRDFFunctions",H,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(e=null==z?void 0:z.Vht)&&void 0!==e?e:"REFLECTIONMAP_SKYBOX"}]}),t.IP("hdrFilteringFunctions",H),t.IP("pbrDirectLightingFunctions",H,{replaceStrings:[{search:/vPositionW/g,replace:W+".xyz"}]}),t.IP("pbrIBLFunctions",H),t.IP("pbrBlockAlbedoOpacity",H),t.IP("pbrBlockReflectivity",H),t.IP("pbrBlockAmbientOcclusion",H),t.IP("pbrBlockAlphaFresnel",H),t.IP("pbrBlockAnisotropic",H),t._P("vLightingIntensity","vec4"),(null==z?void 0:z.generateOnlyFragmentCode)&&(t.compilationString+=z.handleVertexSide(t)),this.Not=t.SP("vNormalW"),t.compilationString+=`vec4 ${this.Not} = normalize(${this.worldNormal.associatedVariableName});\r\n`,t.MP("viewDirectionW")&&(t.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${W}.xyz);\r\n`),t.compilationString+=`vec3 geometricNormalW = ${this.Not}.xyz;\r\n`,t.compilationString+=`vec3 normalW = ${X.isConnected?"normalize("+X.associatedVariableName+".xyz)":"geometricNormalW"};\r\n`,this.Iot=t.SP("invertNormal"),t._P(this.Iot,"float"),t.compilationString+=t.RP("pbrBlockNormalFinal",H,{replaceStrings:[{search:/vPositionW/g,replace:W+".xyz"},{search:/vEyePosition.w/g,replace:this.Iot}]}),t.compilationString+=this.bot(),t.compilationString+=t.RP("depthPrePass",H),t.compilationString+=this._ot(),t.compilationString+=t.RP("pbrBlockLightmapInit",H),t.compilationString+="#ifdef UNLIT\n                vec3 diffuseBase = vec3(1., 1., 1.);\n            #else\r\n",t.compilationString+=this.yot(t),t.compilationString+=t.RP("pbrBlockGeometryInfo",H,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(s=null==z?void 0:z.Vht)&&void 0!==s?s:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(n=null==z?void 0:z.Fht)&&void 0!==n?n:"REFLECTIONMAP_3D"}]});const $=this.anisotropy.isConnected?null===(r=this.anisotropy.connectedPoint)||void 0===r?void 0:r.ownerBlock:null;$&&($.worldPositionConnectionPoint=this.worldPosition,$.worldNormalConnectionPoint=this.worldNormal,t.compilationString+=$.getCode(t,!this.perturbedNormal.isConnected)),z&&z.hasTexture&&(t.compilationString+=z.getCode(t,$?"anisotropicOut.anisotropicNormal":"normalW")),t.IP("pbrBlockReflection",H,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(h=null==z?void 0:z.Fht)&&void 0!==h?h:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(o=null==z?void 0:z.Zht)&&void 0!==o?o:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(a=null==z?void 0:z.Hht)&&void 0!==a?a:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(l=null==z?void 0:z.Vht)&&void 0!==l?l:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(c=null==z?void 0:z.mot)&&void 0!==c?c:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(u=null==z?void 0:z.vot)&&void 0!==u?u:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:null!==(f=null==z?void 0:z.got)&&void 0!==f?f:"vReflectionFilteringInfo"}]}),t.compilationString+=t.RP("pbrBlockReflectance0",H,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this.Mot}]});const Y=this.sheen.isConnected?null===(d=this.sheen.connectedPoint)||void 0===d?void 0:d.ownerBlock:null;Y&&(t.compilationString+=Y.getCode(z)),t.IP("pbrBlockSheen",H,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(p=null==z?void 0:z.Fht)&&void 0!==p?p:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(m=null==z?void 0:z.Vht)&&void 0!==m?m:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(v=null==z?void 0:z.mot)&&void 0!==v?v:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(g=null==z?void 0:z.vot)&&void 0!==g?g:"LINEARSPECULARREFLECTION"}]});const j=this.iridescence.isConnected?null===(S=this.iridescence.connectedPoint)||void 0===S?void 0:S.ownerBlock:null;t.compilationString+=tC.GetCode(j),t.IP("pbrBlockIridescence",H,{replaceStrings:[]});const K=this.clearcoat.isConnected?null===(E=this.clearcoat.connectedPoint)||void 0===E?void 0:E.ownerBlock:null,q=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,Q=this.perturbedNormal.isConnected&&(null===(C=(null===(A=this.perturbedNormal.connectedPoint)||void 0===A?void 0:A.ownerBlock).worldTangent)||void 0===C?void 0:C.isConnected),Z=this.anisotropy.isConnected&&(null===(w=this.anisotropy.connectedPoint)||void 0===w?void 0:w.ownerBlock).worldTangent.isConnected;let J=Q||!this.perturbedNormal.isConnected&&Z;t.compilationString+=JA.GetCode(t,K,z,W,q,J,this.worldNormal.associatedVariableName),q&&(J=null!==(x=null==K?void 0:K.worldTangent.isConnected)&&void 0!==x&&x),t.IP("pbrBlockClearcoat",H,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(T=null==z?void 0:z.Fht)&&void 0!==T?T:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(R=null==z?void 0:z.Zht)&&void 0!==R?R:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(I=null==z?void 0:z.Hht)&&void 0!==I?I:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(M=null==z?void 0:z.Vht)&&void 0!==M?M:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(b=null==z?void 0:z.mot)&&void 0!==b?b:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(_=null==z?void 0:z.vot)&&void 0!==_?_:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:J?"defined(TANGENT)":"defined(IGNORE)"}]}),t.compilationString+=t.RP("pbrBlockReflectance",H,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(y=null==z?void 0:z.Vht)&&void 0!==y?y:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(N=null==z?void 0:z.Fht)&&void 0!==N?N:"REFLECTIONMAP_3D"}]});const tt=this.subsurface.isConnected?null===(P=this.subsurface.connectedPoint)||void 0===P?void 0:P.ownerBlock:null,it=this.subsurface.isConnected?null===(L=(null===(D=this.subsurface.connectedPoint)||void 0===D?void 0:D.ownerBlock).refraction.connectedPoint)||void 0===L?void 0:L.ownerBlock:null;it&&(it.viewConnectionPoint=this.view,it.indexOfRefractionConnectionPoint=this.indexOfRefraction),t.compilationString+=eC.GetCode(t,tt,z,W),t.IP("pbrBlockSubSurface",H,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(O=null==z?void 0:z.Fht)&&void 0!==O?O:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(F=null==z?void 0:z.Zht)&&void 0!==F?F:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(B=null==z?void 0:z.Hht)&&void 0!==B?B:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:null!==(U=null==it?void 0:it.Fht)&&void 0!==U?U:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:null!==(V=null==it?void 0:it.Eot)&&void 0!==V?V:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:null!==(k=null==it?void 0:it.Aot)&&void 0!==k?k:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:null!==(G=null==it?void 0:it.Zht)&&void 0!==G?G:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),t.compilationString+=t.RP("pbrBlockDirectLighting",H),this.light?t.compilationString+=t.RP("lightFragment",H,{replaceStrings:[{search:/{X}/g,replace:this.Eht.toString()}]}):t.compilationString+=t.RP("lightFragment",H,{repeatKey:"maxSimultaneousLights"}),t.compilationString+=t.RP("pbrBlockFinalLitComponents",H),t.compilationString+="#endif\r\n";const et=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)";let st=_g.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();-1===st.indexOf(".")&&(st+="."),t.compilationString+=t.RP("pbrBlockFinalUnlitComponents",H,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:et+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:st}]}),t.compilationString+=t.RP("pbrBlockFinalColorComposition",H,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),t.compilationString+=t.RP("pbrBlockImageProcessing",H,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),t.compilationString+=t.RP("pbrDebug",H,{replaceStrings:[{search:/vNormalW/g,replace:this.Not},{search:/vPositionW/g,replace:W},{search:/albedoTexture\.rgb;/g,replace:"vec3(1.);\r\ngl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\r\n"}]});for(const i of this.YP)if(i.hasEndpoints){const e=sC[i.name];if(e){const[s,n]=e;n&&(t.compilationString+=`#if ${n}\r\n`),t.compilationString+=`${this.QP(i,t)} = ${s};\r\n`,n&&(t.compilationString+="#else\r\n",t.compilationString+=`${this.QP(i,t)} = vec3(0.);\r\n`,t.compilationString+="#endif\r\n")}else console.error(`There's no remapping for the ${i.name} end point! No code generated`)}return this}aD(){let t=super.aD();return t+=`${this.$P}.lightFalloff = ${this.lightFalloff};\r\n`,t+=`${this.$P}.useAlphaTest = ${this.useAlphaTest};\r\n`,t+=`${this.$P}.alphaTestCutoff = ${this.alphaTestCutoff};\r\n`,t+=`${this.$P}.useAlphaBlending = ${this.useAlphaBlending};\r\n`,t+=`${this.$P}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};\r\n`,t+=`${this.$P}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};\r\n`,t+=`${this.$P}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};\r\n`,t+=`${this.$P}.realTimeFiltering = ${this.realTimeFiltering};\r\n`,t+=`${this.$P}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};\r\n`,t+=`${this.$P}.useEnergyConservation = ${this.useEnergyConservation};\r\n`,t+=`${this.$P}.useRadianceOcclusion = ${this.useRadianceOcclusion};\r\n`,t+=`${this.$P}.useHorizonOcclusion = ${this.useHorizonOcclusion};\r\n`,t+=`${this.$P}.unlit = ${this.unlit};\r\n`,t+=`${this.$P}.forceNormalForward = ${this.forceNormalForward};\r\n`,t+=`${this.$P}.debugMode = ${this.debugMode};\r\n`,t+=`${this.$P}.debugLimit = ${this.debugLimit};\r\n`,t+=`${this.$P}.debugFactor = ${this.debugFactor};\r\n`,t}serialize(){const t=super.serialize();return this.light&&(t.lightId=this.light.id),t.lightFalloff=this.lightFalloff,t.useAlphaTest=this.useAlphaTest,t.alphaTestCutoff=this.alphaTestCutoff,t.useAlphaBlending=this.useAlphaBlending,t.useRadianceOverAlpha=this.useRadianceOverAlpha,t.useSpecularOverAlpha=this.useSpecularOverAlpha,t.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,t.realTimeFiltering=this.realTimeFiltering,t.realTimeFilteringQuality=this.realTimeFilteringQuality,t.useEnergyConservation=this.useEnergyConservation,t.useRadianceOcclusion=this.useRadianceOcclusion,t.useHorizonOcclusion=this.useHorizonOcclusion,t.unlit=this.unlit,t.forceNormalForward=this.forceNormalForward,t.debugMode=this.debugMode,t.debugLimit=this.debugLimit,t.debugFactor=this.debugFactor,t.generateOnlyFragmentCode=this.generateOnlyFragmentCode,t}uD(t,i,e){var s,n;super.uD(t,i,e),t.lightId&&(this.light=i.getLightById(t.lightId)),this.lightFalloff=null!==(s=t.lightFalloff)&&void 0!==s?s:0,this.useAlphaTest=t.useAlphaTest,this.alphaTestCutoff=t.alphaTestCutoff,this.useAlphaBlending=t.useAlphaBlending,this.useRadianceOverAlpha=t.useRadianceOverAlpha,this.useSpecularOverAlpha=t.useSpecularOverAlpha,this.enableSpecularAntiAliasing=t.enableSpecularAntiAliasing,this.realTimeFiltering=!!t.realTimeFiltering,this.realTimeFilteringQuality=null!==(n=t.realTimeFilteringQuality)&&void 0!==n?n:8,this.useEnergyConservation=t.useEnergyConservation,this.useRadianceOcclusion=t.useRadianceOcclusion,this.useHorizonOcclusion=t.useHorizonOcclusion,this.unlit=t.unlit,this.forceNormalForward=!!t.forceNormalForward,this.debugMode=t.debugMode,this.debugLimit=t.debugLimit,this.debugFactor=t.debugFactor,this.generateOnlyFragmentCode=!!t.generateOnlyFragmentCode,this.Cht()}}ut([Hn("Direct lights",Nn.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],nC.prototype,"directIntensity",void 0),ut([Hn("Environment lights",Nn.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],nC.prototype,"environmentIntensity",void 0),ut([Hn("Specular highlights",Nn.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],nC.prototype,"specularIntensity",void 0),ut([Hn("Light falloff",Nn.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:_g.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:_g.LIGHTFALLOFF_GLTF},{label:"Standard",value:_g.LIGHTFALLOFF_STANDARD}]})],nC.prototype,"lightFalloff",void 0),ut([Hn("Alpha Testing",Nn.Boolean,"OPACITY")],nC.prototype,"useAlphaTest",void 0),ut([Hn("Alpha CutOff",Nn.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],nC.prototype,"alphaTestCutoff",void 0),ut([Hn("Alpha blending",Nn.Boolean,"OPACITY")],nC.prototype,"useAlphaBlending",void 0),ut([Hn("Radiance over alpha",Nn.Boolean,"RENDERING",{notifiers:{update:!0}})],nC.prototype,"useRadianceOverAlpha",void 0),ut([Hn("Specular over alpha",Nn.Boolean,"RENDERING",{notifiers:{update:!0}})],nC.prototype,"useSpecularOverAlpha",void 0),ut([Hn("Specular anti-aliasing",Nn.Boolean,"RENDERING",{notifiers:{update:!0}})],nC.prototype,"enableSpecularAntiAliasing",void 0),ut([Hn("Realtime filtering",Nn.Boolean,"RENDERING",{notifiers:{update:!0}})],nC.prototype,"realTimeFiltering",void 0),ut([Hn("Realtime filtering quality",Nn.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],nC.prototype,"realTimeFilteringQuality",void 0),ut([Hn("Energy Conservation",Nn.Boolean,"ADVANCED",{notifiers:{update:!0}})],nC.prototype,"useEnergyConservation",void 0),ut([Hn("Radiance occlusion",Nn.Boolean,"ADVANCED",{notifiers:{update:!0}})],nC.prototype,"useRadianceOcclusion",void 0),ut([Hn("Horizon occlusion",Nn.Boolean,"ADVANCED",{notifiers:{update:!0}})],nC.prototype,"useHorizonOcclusion",void 0),ut([Hn("Unlit",Nn.Boolean,"ADVANCED",{notifiers:{update:!0}})],nC.prototype,"unlit",void 0),ut([Hn("Force normal forward",Nn.Boolean,"ADVANCED",{notifiers:{update:!0}})],nC.prototype,"forceNormalForward",void 0),ut([Hn("Generate only fragment code",Nn.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:nC.Aht}})],nC.prototype,"generateOnlyFragmentCode",void 0),ut([Hn("Debug mode",Nn.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],nC.prototype,"debugMode",void 0),ut([Hn("Split position",Nn.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],nC.prototype,"debugLimit",void 0),ut([Hn("Output factor",Nn.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],nC.prototype,"debugFactor",void 0),v("BABYLON.PBRMetallicRoughnessBlock",nC);v("BABYLON.ModBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("left",Mn.AutoDetect),this.registerInput("right",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0],this.iD(0,1)}getClassName(){return"ModBlock"}get left(){return this.xd[0]}get right(){return this.xd[1]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0];return t.compilationString+=this.QP(i,t)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}});var rC;v("BABYLON.MatrixBuilder",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("row0",Mn.Vector4),this.registerInput("row1",Mn.Vector4),this.registerInput("row2",Mn.Vector4),this.registerInput("row3",Mn.Vector4),this.registerOutput("output",Mn.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this.xd[0]}get row1(){return this.xd[1]}get row2(){return this.xd[2]}get row3(){return this.xd[3]}get output(){return this.YP[0]}autoConfigure(){if(!this.row0.isConnected){const t=new jn("row0");t.value=new x(1,0,0,0),t.output.connectTo(this.row0)}if(!this.row1.isConnected){const t=new jn("row1");t.value=new x(0,1,0,0),t.output.connectTo(this.row1)}if(!this.row2.isConnected){const t=new jn("row2");t.value=new x(0,0,1,0),t.output.connectTo(this.row2)}if(!this.row3.isConnected){const t=new jn("row3");t.value=new x(0,0,0,1),t.output.connectTo(this.row3)}}tD(t){super.tD(t);const i=this.YP[0],e=this.row0,s=this.row1,n=this.row2,r=this.row3;return t.compilationString+=this.QP(i,t)+` = mat4(${e.associatedVariableName}, ${s.associatedVariableName}, ${n.associatedVariableName}, ${r.associatedVariableName});\r\n`,this}}),function(t){t[t.Equal=0]="Equal",t[t.NotEqual=1]="NotEqual",t[t.LessThan=2]="LessThan",t[t.GreaterThan=3]="GreaterThan",t[t.LessOrEqual=4]="LessOrEqual",t[t.GreaterOrEqual=5]="GreaterOrEqual",t[t.Xor=6]="Xor",t[t.Or=7]="Or",t[t.And=8]="And"}(rC||(rC={}));v("BABYLON.ConditionalBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.condition=rC.LessThan,this.registerInput("a",Mn.Float),this.registerInput("b",Mn.Float),this.registerInput("true",Mn.AutoDetect,!0),this.registerInput("false",Mn.AutoDetect,!0),this.registerOutput("output",Mn.BasedOnInput),this.iD(2,3),this.YP[0].DP=this.xd[2],this.YP[0].LP=Mn.Float}getClassName(){return"ConditionalBlock"}get a(){return this.xd[0]}get b(){return this.xd[1]}get true(){return this.xd[2]}get false(){return this.xd[3]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.YP[0],e=this.true.isConnected?this.true.associatedVariableName:"1.0",s=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case rC.Equal:t.compilationString+=this.QP(i,t)+` = ${this.a.associatedVariableName} == ${this.b.associatedVariableName} ? ${e} : ${s};\r\n`;break;case rC.NotEqual:t.compilationString+=this.QP(i,t)+` = ${this.a.associatedVariableName} != ${this.b.associatedVariableName} ? ${e} : ${s};\r\n`;break;case rC.LessThan:t.compilationString+=this.QP(i,t)+` = ${this.a.associatedVariableName} < ${this.b.associatedVariableName} ? ${e} : ${s};\r\n`;break;case rC.LessOrEqual:t.compilationString+=this.QP(i,t)+` = ${this.a.associatedVariableName} <= ${this.b.associatedVariableName} ? ${e} : ${s};\r\n`;break;case rC.GreaterThan:t.compilationString+=this.QP(i,t)+` = ${this.a.associatedVariableName} > ${this.b.associatedVariableName} ? ${e} : ${s};\r\n`;break;case rC.GreaterOrEqual:t.compilationString+=this.QP(i,t)+` = ${this.a.associatedVariableName} >= ${this.b.associatedVariableName} ? ${e} : ${s};\r\n`;break;case rC.Xor:t.compilationString+=this.QP(i,t)+` = (mod(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 2.0) > 0.0) ? ${e} : ${s};\r\n`;break;case rC.Or:t.compilationString+=this.QP(i,t)+` = (min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0) ? ${e} : ${s};\r\n`;break;case rC.And:t.compilationString+=this.QP(i,t)+` = (${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)  ? ${e} : ${s};\r\n`}return this}serialize(){const t=super.serialize();return t.condition=this.condition,t}uD(t,i,e){super.uD(t,i,e),this.condition=t.condition}aD(){return super.aD()+`${this.$P}.condition = BABYLON.ConditionalBlockConditions.${rC[this.condition]};\r\n`}});class hC extends kn{constructor(t){super(t,bn.Neutral),this.octaves=6,this.registerInput("seed",Mn.AutoDetect),this.registerInput("chaos",Mn.AutoDetect,!0),this.registerInput("offsetX",Mn.Float,!0),this.registerInput("offsetY",Mn.Float,!0),this.registerInput("offsetZ",Mn.Float,!0),this.registerOutput("output",Mn.Float),this.xd[0].acceptedConnectionPointTypes.push(Mn.Vector2),this.xd[0].acceptedConnectionPointTypes.push(Mn.Vector3),this.iD(0,1)}getClassName(){return"CloudBlock"}get seed(){return this.xd[0]}get chaos(){return this.xd[1]}get offsetX(){return this.xd[2]}get offsetY(){return this.xd[3]}get offsetZ(){return this.xd[4]}get output(){return this.YP[0]}tD(t){var i,e;if(super.tD(t),!this.seed.isConnected)return;if(!this.YP[0].hasEndpoints)return;const s="\n        float fbm(in vec2 st, in vec2 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = .5;\n            float frequency = 0.;\n\n            // Loop of octaves\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise(st, chaos);\n                st *= 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }\n\n        float fbm(in vec3 x, in vec3 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = 0.5;\n            for (int i = 0; i < OCTAVES; ++i) {\n                value += amplitude * cloudNoise(x, chaos);\n                x = x * 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }",n=`fbm${this.octaves}`;t.TP("CloudBlockCode","\n\n        float cloudRandom(in float p) { p = fract(p * 0.011); p *= p + 7.5; p *= p + p; return fract(p); }\n\n        // Based on Morgan McGuire @morgan3d\n        // https://www.shadertoy.com/view/4dS3Wd\n        float cloudNoise(in vec2 x, in vec2 chaos) {\n            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);\n\n            vec2 i = floor(x);\n            vec2 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec2 u = f * f * (3.0 - 2.0 * f);\n            return mix(\n                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),\n                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),\n                    u.y\n                );\n        }\n\n        float cloudNoise(in vec3 x, in vec3 chaos) {\n            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);\n\n            vec3 i = floor(x);\n            vec3 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec3 u = f * f * (3.0 - 2.0 * f);\n            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),\n                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);\n        }","// CloudBlockCode"),t.TP("CloudBlockCodeFBM"+this.octaves,s.replace(/fbm/gi,n).replace(/OCTAVES/gi,(0|this.octaves).toString()),"// CloudBlockCode FBM");const r=t.SP("st"),h=(null===(i=this.seed.connectedPoint)||void 0===i?void 0:i.type)===Mn.Vector2?"vec2":"vec3";t.compilationString+=`${h} ${r} = ${this.seed.associatedVariableName};\r\n`,this.offsetX.isConnected&&(t.compilationString+=`${r}.x += 0.1 * ${this.offsetX.associatedVariableName};\r\n`),this.offsetY.isConnected&&(t.compilationString+=`${r}.y += 0.1 * ${this.offsetY.associatedVariableName};\r\n`),this.offsetZ.isConnected&&"vec3"===h&&(t.compilationString+=`${r}.z += 0.1 * ${this.offsetZ.associatedVariableName};\r\n`);let o="";return o=this.chaos.isConnected?this.chaos.associatedVariableName:(null===(e=this.seed.connectedPoint)||void 0===e?void 0:e.type)===Mn.Vector2?"vec2(0., 0.)":"vec3(0., 0., 0.)",t.compilationString+=this.QP(this.YP[0],t)+` = ${n}(${r}, ${o});\r\n`,this}aD(){return super.aD()+`${this.$P}.octaves = ${this.octaves};\r\n`}serialize(){const t=super.serialize();return t.octaves=this.octaves,t}uD(t,i,e){super.uD(t,i,e),this.octaves=t.octaves}}ut([Hn("Octaves",Nn.Int)],hC.prototype,"octaves",void 0),v("BABYLON.CloudBlock",hC);v("BABYLON.VoronoiNoiseBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("seed",Mn.Vector2),this.registerInput("offset",Mn.Float),this.registerInput("density",Mn.Float),this.registerOutput("output",Mn.Float),this.registerOutput("cells",Mn.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this.xd[0]}get offset(){return this.xd[1]}get density(){return this.xd[2]}get output(){return this.YP[0]}get cells(){return this.YP[1]}tD(t){if(super.tD(t),!this.seed.isConnected)return;let i="vec2 voronoiRandom(vec2 seed, float offset){\n            mat2 m = mat2(15.27, 47.63, 99.41, 89.98);\n            vec2 uv = fract(sin(m * seed) * 46839.32);\n            return vec2(sin(uv.y * offset) * 0.5 + 0.5, cos(uv.x * offset) * 0.5 + 0.5);\n        }\n        ";t.TP("voronoiRandom",i,"// Voronoi random generator"),i="void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){\n            vec2 g = floor(seed * density);\n            vec2 f = fract(seed * density);\n            float t = 8.0;\n            vec3 res = vec3(8.0, 0.0, 0.0);\n\n            for(int y=-1; y<=1; y++)\n            {\n                for(int x=-1; x<=1; x++)\n                {\n                    vec2 lattice = vec2(x,y);\n                    vec2 randomOffset = voronoiRandom(lattice + g, offset);\n                    float d = distance(lattice + randomOffset, f);\n                    if(d < res.x)\n                    {\n                        res = vec3(d, randomOffset.x, randomOffset.y);\n                        outValue = res.x;\n                        cells = res.y;\n                    }\n                }\n            }\n        }\n        ",t.TP("voronoi",i,"// Voronoi");const e=t.SP("tempOutput"),s=t.SP("tempCells");return t.compilationString+=`float ${e} = 0.0;\r\n`,t.compilationString+=`float ${s} = 0.0;\r\n`,t.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${e}, ${s});\r\n`,this.output.hasEndpoints&&(t.compilationString+=this.QP(this.output,t)+` = ${e};\r\n`),this.cells.hasEndpoints&&(t.compilationString+=this.QP(this.cells,t)+` = ${s};\r\n`),this}});v("BABYLON.ElbowBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("input",Mn.AutoDetect),this.registerOutput("output",Mn.BasedOnInput),this.YP[0].DP=this.xd[0]}getClassName(){return"ElbowBlock"}get input(){return this.xd[0]}get output(){return this.YP[0]}get target(){const t=this.xd[0];if(t.isConnected){const i=t.connectedPoint.ownerBlock;if(i.target!==bn.VertexAndFragment)return i.target;if(t.connectedPoint.target!==bn.VertexAndFragment)return t.connectedPoint.target}return this.Pt}set target(t){0==(this.Pt&t)&&(this.Pt=t)}tD(t){super.tD(t);const i=this.YP[0],e=this.xd[0];return t.compilationString+=this.QP(i,t)+` = ${e.associatedVariableName};\r\n`,this}});class oC extends kn{constructor(t,i=!1){super(t,bn.Neutral),this.wht=!1,this.xht=!1,this.disableLevelMultiplication=!1,this.registerInput("position",Mn.AutoDetect,!1),this.registerInput("normal",Mn.AutoDetect,!1),this.registerInput("sharpness",Mn.Float,!0),this.registerInput("source",Mn.Object,!0,bn.VertexAndFragment,new OA("source",this,yn.Input,GA,"ImageSourceBlock")),this.registerInput("sourceY",Mn.Object,!0,bn.VertexAndFragment,new OA("sourceY",this,yn.Input,GA,"ImageSourceBlock")),i||this.registerInput("sourceZ",Mn.Object,!0,bn.VertexAndFragment,new OA("sourceZ",this,yn.Input,GA,"ImageSourceBlock")),this.registerOutput("rgba",Mn.Color4,bn.Neutral),this.registerOutput("rgb",Mn.Color3,bn.Neutral),this.registerOutput("r",Mn.Float,bn.Neutral),this.registerOutput("g",Mn.Float,bn.Neutral),this.registerOutput("b",Mn.Float,bn.Neutral),this.registerOutput("a",Mn.Float,bn.Neutral),this.registerOutput("level",Mn.Float,bn.Neutral),this.xd[0].addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Vector3|Mn.Vector4),this.xd[1].addExcludedConnectionPointFromAllowedTypes(Mn.Color3|Mn.Vector3|Mn.Vector4)}get texture(){var t;return this.source.isConnected?(null===(t=this.source.connectedPoint)||void 0===t?void 0:t.ownerBlock).texture:this.Lb}set texture(t){var i;if(this.Lb===t)return;const e=null!==(i=null==t?void 0:t.getScene())&&void 0!==i?i:E.LastCreatedScene;!t&&e&&e.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this.Lb))),this.Lb=t,t&&e&&e.markAllMaterialsAsDirty(1,(i=>i.hasTexture(t)))}get textureY(){var t;return this.sourceY.isConnected?(null===(t=this.sourceY.connectedPoint)||void 0===t?void 0:t.ownerBlock).texture:null}get textureZ(){var t,i;return(null===(t=this.sourceZ)||void 0===t?void 0:t.isConnected)?(null===(i=this.sourceY.connectedPoint)||void 0===i?void 0:i.ownerBlock).texture:null}Pot(t){return(null==t?void 0:t.isConnected)?t.connectedPoint.ownerBlock:null}get samplerName(){const t=this.Pot(this.source);return t?t.samplerName:this.ID}get samplerYName(){var t,i;return null!==(i=null===(t=this.Pot(this.sourceY))||void 0===t?void 0:t.samplerName)&&void 0!==i?i:null}get samplerZName(){var t,i;return null!==(i=null===(t=this.Pot(this.sourceZ))||void 0===t?void 0:t.samplerName)&&void 0!==i?i:null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(t){var i;if(t!==this.wht&&(this.wht=t,this.texture)){const t=null!==(i=this.texture.getScene())&&void 0!==i?i:E.LastCreatedScene;null==t||t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this.texture)))}}get convertToGammaSpace(){return this.wht}set convertToLinearSpace(t){var i;if(t!==this.xht&&(this.xht=t,this.texture)){const t=null!==(i=this.texture.getScene())&&void 0!==i?i:E.LastCreatedScene;null==t||t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(this.texture)))}}get convertToLinearSpace(){return this.xht}getClassName(){return"TriPlanarBlock"}get position(){return this.xd[0]}get normal(){return this.xd[1]}get sharpness(){return this.xd[2]}get source(){return this.xd[3]}get sourceY(){return this.xd[4]}get sourceZ(){return this.xd[5]}get rgba(){return this.YP[0]}get rgb(){return this.YP[1]}get r(){return this.YP[2]}get g(){return this.YP[3]}get b(){return this.YP[4]}get a(){return this.YP[5]}get level(){return this.YP[6]}prepareDefines(t,i,e){if(!e._l)return;const s=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,n=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;e.setValue(this.mD,s,!0),e.setValue(this.vD,n,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(t){this.texture&&(t.setFloat(this._ht,this.texture.level),this.Rht||t.setTexture(this.ID,this.texture))}Pht(t){var i,e;const s=this.samplerName,n=null!==(i=this.samplerYName)&&void 0!==i?i:s,r=null!==(e=this.samplerZName)&&void 0!==e?e:s,h=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",o=t.SP("x"),a=t.SP("y"),l=t.SP("z"),c=t.SP("z");t.compilationString+=`\n            vec4 ${o} = texture2D(${s}, ${this.position.associatedVariableName}.yz);\n            vec4 ${a} = texture2D(${n}, ${this.position.associatedVariableName}.zx);\n            vec4 ${l} = texture2D(${r}, ${this.position.associatedVariableName}.xy);\n            \n            // blend weights\n            vec3 ${c} = pow(abs(${this.normal.associatedVariableName}.xyz), vec3(${h}));\n\n            // blend and return\n            vec4 ${this.ND} = (${o}*${c}.x + ${a}*${c}.y + ${l}*${c}.z) / (${c}.x + ${c}.y + ${c}.z);        \n        `}Dht(t,i,e){"a"!==e&&(this.texture&&this.texture.gammaSpace||(t.compilationString+=`#ifdef ${this.mD}\n                    ${i.associatedVariableName} = toGammaSpace(${i.associatedVariableName});\n                    #endif\n                `),t.compilationString+=`#ifdef ${this.vD}\n                ${i.associatedVariableName} = toLinearSpace(${i.associatedVariableName});\n                #endif\n            `)}yD(t,i,e){let s="";this.disableLevelMultiplication||(s=` * ${this._ht}`),t.compilationString+=`${this.QP(i,t)} = ${this.ND}.${e}${s};\r\n`,this.Dht(t,i,e)}tD(t){super.tD(t),this.source.isConnected?this.Rht=this.source.connectedPoint.ownerBlock:this.Rht=null,this._ht=t.SP("textureInfoName"),this.level.associatedVariableName=this._ht,this.ND=t.SP("tempTextureRead"),this.mD=t.EP("ISLINEAR"),this.vD=t.EP("ISGAMMA"),this.Rht||(this.ID=t.SP(this.name+"Sampler"),t.CP(this.ID)),t.sharedData.blockingBlocks.push(this),t.sharedData.textureBlocks.push(this),t.sharedData.blocksWithDefines.push(this),t.sharedData.bindableBlocks.push(this);const i=`//${this.name}`;t.IP("helperFunctions",i),t._P(this._ht,"float"),this.Pht(t);for(const i of this.YP)i.hasEndpoints&&"level"!==i.name&&this.yD(t,i,i.name);return this}aD(){let t=super.aD();return t+=`${this.$P}.convertToGammaSpace = ${this.convertToGammaSpace};\r\n`,t+=`${this.$P}.convertToLinearSpace = ${this.convertToLinearSpace};\r\n`,t+=`${this.$P}.disableLevelMultiplication = ${this.disableLevelMultiplication};\r\n`,this.texture?(t+=`${this.$P}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r\n`,t+=`${this.$P}.texture.wrapU = ${this.texture.wrapU};\r\n`,t+=`${this.$P}.texture.wrapV = ${this.texture.wrapV};\r\n`,t+=`${this.$P}.texture.uAng = ${this.texture.uAng};\r\n`,t+=`${this.$P}.texture.vAng = ${this.texture.vAng};\r\n`,t+=`${this.$P}.texture.wAng = ${this.texture.wAng};\r\n`,t+=`${this.$P}.texture.uOffset = ${this.texture.uOffset};\r\n`,t+=`${this.$P}.texture.vOffset = ${this.texture.vOffset};\r\n`,t+=`${this.$P}.texture.uScale = ${this.texture.uScale};\r\n`,t+=`${this.$P}.texture.vScale = ${this.texture.vScale};\r\n`,t+=`${this.$P}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`,t):t}serialize(){const t=super.serialize();return t.convertToGammaSpace=this.convertToGammaSpace,t.convertToLinearSpace=this.convertToLinearSpace,t.disableLevelMultiplication=this.disableLevelMultiplication,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(t.texture=this.texture.serialize()),t}uD(t,i,e){super.uD(t,i,e),this.convertToGammaSpace=t.convertToGammaSpace,this.convertToLinearSpace=!!t.convertToLinearSpace,this.disableLevelMultiplication=!!t.disableLevelMultiplication,t.texture&&!Br.IgnoreTexturesAtLoadTime&&void 0!==t.texture.url&&(e=0===t.texture.url.indexOf("data:")?"":e,this.texture=an.Parse(t.texture,i,e))}}v("BABYLON.TriPlanarBlock",oC);v("BABYLON.BiPlanarBlock",class extends oC{constructor(t){super(t,!0)}getClassName(){return"BiPlanarBlock"}Pht(t){var i;const e=this.samplerName,s=null!==(i=this.samplerYName)&&void 0!==i?i:this.samplerName,n=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",r=t.SP("dpdx"),h=t.SP("dpdy"),o=t.SP("n"),a=t.SP("ma"),l=t.SP("mi"),c=t.SP("me"),u=t.SP("x"),f=t.SP("y"),d=t.SP("y");t.compilationString+=`\n            // grab coord derivatives for texturing\n            vec3 ${r} = dFdx(${this.position.associatedVariableName}.xyz);\n            vec3 ${h} = dFdy(${this.position.associatedVariableName}.xyz);\n            vec3 ${o} = abs(${this.normal.associatedVariableName}.xyz);\n        \n            // determine major axis (in x; yz are following axis)\n            ivec3 ${a} = (${o}.x>${o}.y && ${o}.x>${o}.z) ? ivec3(0,1,2) :\n                    (${o}.y>${o}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine minor axis (in x; yz are following axis)\n            ivec3 ${l} = (${o}.x<${o}.y && ${o}.x<${o}.z) ? ivec3(0,1,2) :\n                    (${o}.y<${o}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine median axis (in x;  yz are following axis)\n            ivec3 ${c} = ivec3(3) - ${l} - ${a};\n            \n            // project+fetch\n            vec4 ${u} = textureGrad( ${e}, vec2(   ${this.position.associatedVariableName}[${a}.y],   ${this.position.associatedVariableName}[${a}.z]), \n                                    vec2(${r}[${a}.y],${r}[${a}.z]), \n                                    vec2(${h}[${a}.y],${h}[${a}.z]) );\n            vec4 ${f} = textureGrad( ${s}, vec2(   ${this.position.associatedVariableName}[${c}.y],   ${this.position.associatedVariableName}[${c}.z]), \n                                    vec2(${r}[${c}.y],${r}[${c}.z]),\n                                    vec2(${h}[${c}.y],${h}[${c}.z]) );\n            \n            // blend factors\n            vec2 ${d} = vec2(${o}[${a}.x],${o}[${c}.x]);\n            // make local support\n            ${d} = clamp( (${d}-0.5773)/(1.0-0.5773), 0.0, 1.0 );\n            // shape transition\n            ${d} = pow( ${d}, vec2(${n}/8.0) );\n            // blend and return\n            vec4 ${this.ND} = (${u}*${d}.x + ${f}*${d}.y) / (${d}.x + ${d}.y);\n        `}});v("BABYLON.MatrixDeterminantBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("input",Mn.Matrix),this.registerOutput("output",Mn.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this.xd[0]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.output,e=this.input;return t.compilationString+=this.QP(i,t)+`${i.associatedVariableName} = determinant(${e.associatedVariableName});\r\n`,this}});v("BABYLON.MatrixTransposeBlock",class extends kn{constructor(t){super(t,bn.Neutral),this.registerInput("input",Mn.Matrix),this.registerOutput("output",Mn.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this.xd[0]}get output(){return this.YP[0]}tD(t){super.tD(t);const i=this.output,e=this.input;return t.compilationString+=this.QP(i,t)+`${i.associatedVariableName} = transpose(${e.associatedVariableName});\r\n`,this}});function aC(t,i,e,s,n,r){const h=new t.DecoderBuffer;h.Init(i,i.byteLength);const o=new t.Decoder;let a,l;try{const i=o.GetEncodedGeometryType(h);switch(i){case t.TRIANGULAR_MESH:a=new t.Mesh,l=o.DecodeBufferToMesh(h,a);break;case t.POINT_CLOUD:a=new t.PointCloud,l=o.DecodeBufferToPointCloud(h,a);break;default:throw new Error(`Invalid geometry type ${i}`)}if(!l.ok()||!a.ptr)throw new Error(l.error_msg());if(i===t.TRIANGULAR_MESH){const i=3*a.num_faces(),e=4*i,n=t.Lot(e);try{o.GetTrianglesUInt32Array(a,e,n);const r=new Uint32Array(i);r.set(new Uint32Array(t.HEAPF32.buffer,n,i)),s(r)}finally{t.Oot(n)}}const c=(i,e,s=1)=>{const r=e.num_components(),h=a.num_points(),l=h*r,c=l*Float32Array.BYTES_PER_ELEMENT,u=t.Lot(c);try{o.GetAttributeDataArrayForAllPoints(a,e,t.DT_FLOAT32,c,u);const f=new Float32Array(t.HEAPF32.buffer,u,l);if("color"===i&&3===r){const t=new Float32Array(4*h);for(let i=0,e=0;i<t.length;i+=4,e+=r)t[i+0]=f[e+0],t[i+1]=f[e+1],t[i+2]=f[e+2],t[i+3]=1;n(i,t)}else{const e=new Float32Array(l);if(e.set(new Float32Array(t.HEAPF32.buffer,u,l)),1!==s)for(let t=0;t<e.length;t++)e[t]=e[t]/s;n(i,e)}}finally{t.Oot(u)}};if(e)for(const t in e){const i=e[t],s=o.GetAttributeByUniqueId(a,i);c(t,s,r&&r[t]||1)}else{const i={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(const e in i){const s=o.GetAttributeId(a,t[i[e]]);if(-1!==s){c(e,o.GetAttribute(a,s))}}}}finally{a&&t.destroy(a),t.destroy(o),t.destroy(h)}}function lC(){let t;onmessage=i=>{const e=i.data;switch(e.id){case"init":{const i=e.decoder;i.url&&(importScripts(i.url),t=DracoDecoderModule({wasmBinary:i.wasmBinary})),postMessage("done");break}case"decodeMesh":if(!t)throw new Error("Draco decoder module is not available");t.then((t=>{aC(t,e.dataView,e.attributes,(t=>{postMessage({id:"indices",value:t},[t.buffer])}),((t,i)=>{postMessage({id:t,value:i},[i.buffer])})),postMessage("done")}))}}}class cC{constructor(t=cC.DefaultNumWorkers){const i=cC.Configuration.decoder,e=i.wasmUrl&&i.wasmBinaryUrl&&"object"==typeof WebAssembly?{url:ki.GetAbsoluteUrl(i.wasmUrl),wasmBinaryPromise:ki.LoadFileAsync(ki.GetAbsoluteUrl(i.wasmBinaryUrl))}:{url:ki.GetAbsoluteUrl(i.fallbackUrl),wasmBinaryPromise:Promise.resolve(void 0)};t&&"function"==typeof Worker&&"function"==typeof URL?this.Fot=e.wasmBinaryPromise.then((i=>{const s=`${aC}(${lC})()`,n=URL.createObjectURL(new Blob([s],{type:"application/javascript"}));return new Gg(t,(()=>new Promise(((t,s)=>{const r=new Worker(n),h=t=>{r.removeEventListener("error",h),r.removeEventListener("message",o),s(t)},o=i=>{"done"===i.data&&(r.removeEventListener("error",h),r.removeEventListener("message",o),t(r))};r.addEventListener("error",h),r.addEventListener("message",o),r.postMessage({id:"init",decoder:{url:e.url,wasmBinary:i}})}))))})):this.Bot=e.wasmBinaryPromise.then((t=>{if(!e.url)throw new Error("Draco decoder module is not available");return ki.LoadScriptAsync(e.url).then((()=>{return i=t,new Promise((t=>{DracoDecoderModule({wasmBinary:i}).then((i=>{t({module:i})}))}));var i}))}))}static get DecoderAvailable(){const t=cC.Configuration.decoder;return!!(t.wasmUrl&&t.wasmBinaryUrl&&"object"==typeof WebAssembly||t.fallbackUrl)}static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static get Default(){return cC.Uot||(cC.Uot=new cC),cC.Uot}dispose(){this.Fot&&this.Fot.then((t=>{t.dispose()})),delete this.Fot,delete this.Bot}whenReadyAsync(){return this.Fot?this.Fot.then((()=>{})):this.Bot?this.Bot.then((()=>{})):Promise.resolve()}decodeMeshAsync(t,i,e){const s=t instanceof ArrayBuffer?new Uint8Array(t):t;if(this.Fot)return this.Fot.then((t=>new Promise(((n,r)=>{t.push(((t,h)=>{const o=new os,a=i=>{t.removeEventListener("error",a),t.removeEventListener("message",l),r(i),h()},l=i=>{if("done"===i.data)t.removeEventListener("error",a),t.removeEventListener("message",l),n(o),h();else if("indices"===i.data.id)o.indices=i.data.value;else{const t=e&&e[i.data.id]?e[i.data.id]:1;if(1!==t)for(let e=0;e<i.data.value.length;e++)i.data.value[e]=i.data.value[e]/t;o.set(i.data.value,i.data.id)}};t.addEventListener("error",a),t.addEventListener("message",l);const c=new Uint8Array(s.byteLength);c.set(new Uint8Array(s.buffer,s.byteOffset,s.byteLength)),t.postMessage({id:"decodeMesh",dataView:c,attributes:i},[c.buffer])}))}))));if(this.Bot)return this.Bot.then((t=>{const n=new os;return aC(t.module,s,i,(t=>{n.indices=t}),((t,i)=>{n.set(i,t)}),e),n}));throw new Error("Draco decoder module is not available")}}cC.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}},cC.DefaultNumWorkers=cC.GetDefaultNumWorkers(),cC.Uot=null;class uC{constructor(){const t=uC.Configuration.decoder;this.Bot=ki.LoadScriptAsync(ki.GetAbsoluteUrl(t.url)).then((()=>MeshoptDecoder.ready))}static get Default(){return uC.Uot||(uC.Uot=new uC),uC.Uot}dispose(){delete this.Bot}decodeGltfBufferAsync(t,i,e,s,n){return this.Bot.then((()=>{const r=new Uint8Array(i*e);return MeshoptDecoder.decodeGltfBuffer(r,i,e,t,s,n),r}))}}uC.Configuration={decoder:{url:"https://preview.babylonjs.com/meshopt_decoder.js"}},uC.Uot=null;class fC{constructor(t,i){this.normal=t,this.w=i}static FromPoints(t,i,e){const s=e.subtract(t),n=i.subtract(t);if(0===s.lengthSquared()||0===n.lengthSquared())return null;const r=w.Normalize(w.Cross(s,n));return new fC(r,w.Dot(r,t))}clone(){return new fC(this.normal.clone(),this.w)}flip(){this.normal.scaleInPlace(-1),this.w=-this.w}splitPolygon(t,i,e,s,n){let r=0;const h=[];let o,a;for(o=0;o<t.vertices.length;o++){a=w.Dot(this.normal,t.vertices[o].pos)-this.w;const i=a<-fC.EPSILON?2:a>fC.EPSILON?1:0;r|=i,h.push(i)}switch(r){case 0:(w.Dot(this.normal,t.plane.normal)>0?i:e).push(t);break;case 1:s.push(t);break;case 2:n.push(t);break;case 3:{const i=[],e=[];for(o=0;o<t.vertices.length;o++){const s=(o+1)%t.vertices.length,n=h[o],r=h[s],l=t.vertices[o],c=t.vertices[s];if(2!==n&&i.push(l),1!==n&&e.push(2!==n?l.clone():l),3==(n|r)){a=(this.w-w.Dot(this.normal,l.pos))/w.Dot(this.normal,c.pos.subtract(l.pos));const t=l.interpolate(c,a);i.push(t),e.push(t.clone())}}let r;i.length>=3&&(r=new dC(i,t.shared),r.plane&&s.push(r)),e.length>=3&&(r=new dC(e,t.shared),r.plane&&n.push(r));break}}}}fC.EPSILON=1e-5;class dC{constructor(t,i){this.vertices=t,this.shared=i,this.plane=fC.FromPoints(t[0].pos,t[1].pos,t[2].pos)}clone(){const t=this.vertices.map((t=>t.clone()));return new dC(t,this.shared)}flip(){this.vertices.reverse().map((t=>{t.flip()})),this.plane.flip()}}Ys.pM=(t,i)=>pC.Parse(t,i);class pC extends Ys{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(t,i){return void 0===i?(t>this.goldbergData.nbUnsharedFaces-1&&(F.Warn("Maximum number of unshared faces used"),t=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+t):(t>11&&(F.Warn("Last pole used"),t=11),i>this.goldbergData.nbFacesAtPole-1&&(F.Warn("Maximum number of faces at a pole used"),i=this.goldbergData.nbFacesAtPole-1),12+t*this.goldbergData.nbFacesAtPole+i)}Vot(t){for(let i=0;i<t.length;i++){const e=t[i][0],s=t[i][1],n=t[i][2];for(let t=e;t<s+1;t++)this.goldbergData.faceColors[t]=n}const i=[];for(let t=0;t<12;t++)for(let e=0;e<5;e++)i.push(this.goldbergData.faceColors[t].r,this.goldbergData.faceColors[t].g,this.goldbergData.faceColors[t].b,this.goldbergData.faceColors[t].a);for(let t=12;t<this.goldbergData.faceColors.length;t++)for(let e=0;e<6;e++)i.push(this.goldbergData.faceColors[t].r,this.goldbergData.faceColors[t].g,this.goldbergData.faceColors[t].b,this.goldbergData.faceColors[t].a);return i}setGoldbergFaceColors(t){const i=this.Vot(t);this.setVerticesData(he.ColorKind,i)}updateGoldbergFaceColors(t){const i=this.Vot(t);this.updateVerticesData(he.ColorKind,i)}kot(t){const i=this.getVerticesData(he.UVKind);for(let e=0;e<t.length;e++){const s=t[e][0],n=t[e][1],r=t[e][2],h=t[e][3],o=t[e][4],a=[],l=[];let c,u;for(let t=0;t<5;t++)c=r.x+h*Math.cos(o+t*Math.PI/2.5),u=r.y+h*Math.sin(o+t*Math.PI/2.5),c<0&&(c=0),c>1&&(c=1),a.push(c,u);for(let t=0;t<6;t++)c=r.x+h*Math.cos(o+t*Math.PI/3),u=r.y+h*Math.sin(o+t*Math.PI/3),c<0&&(c=0),c>1&&(c=1),l.push(c,u);for(let t=s;t<Math.min(12,n+1);t++)for(let e=0;e<5;e++)i[10*t+2*e]=a[2*e],i[10*t+2*e+1]=a[2*e+1];for(let t=Math.max(12,s);t<n+1;t++)for(let e=0;e<6;e++)i[12*t-24+2*e]=l[2*e],i[12*t-23+2*e]=l[2*e+1]}return i}setGoldbergFaceUVs(t){const i=this.kot(t);this.setVerticesData(he.UVKind,i)}updateGoldbergFaceUVs(t){const i=this.kot(t);this.updateVerticesData(he.UVKind,i)}placeOnGoldbergFaceAt(t,i,e){const s=w.RotationFromAxis(this.goldbergData.faceXaxis[i],this.goldbergData.faceYaxis[i],this.goldbergData.faceZaxis[i]);t.rotation=s,t.position=this.goldbergData.faceCenters[i].add(this.goldbergData.faceXaxis[i].scale(e.x)).add(this.goldbergData.faceYaxis[i].scale(e.y)).add(this.goldbergData.faceZaxis[i].scale(e.z))}serialize(t){super.serialize(t),t.type="GoldbergMesh";const i={};if(i.adjacentFaces=this.goldbergData.adjacentFaces,i.nbSharedFaces=this.goldbergData.nbSharedFaces,i.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,i.nbFaces=this.goldbergData.nbFaces,i.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){i.faceColors=[];for(const t of this.goldbergData.faceColors)i.faceColors.push(t.asArray())}if(this.goldbergData.faceCenters){i.faceCenters=[];for(const t of this.goldbergData.faceCenters)i.faceCenters.push(t.asArray())}if(this.goldbergData.faceZaxis){i.faceZaxis=[];for(const t of this.goldbergData.faceZaxis)i.faceZaxis.push(t.asArray())}if(this.goldbergData.faceYaxis){i.faceYaxis=[];for(const t of this.goldbergData.faceYaxis)i.faceYaxis.push(t.asArray())}if(this.goldbergData.faceXaxis){i.faceXaxis=[];for(const t of this.goldbergData.faceXaxis)i.faceXaxis.push(t.asArray())}t.goldbergData=i}static Parse(t,i){const e=t.goldbergData;e.faceColors=e.faceColors.map((t=>y.FromArray(t))),e.faceCenters=e.faceCenters.map((t=>w.FromArray(t))),e.faceZaxis=e.faceZaxis.map((t=>w.FromArray(t))),e.faceXaxis=e.faceXaxis.map((t=>w.FromArray(t))),e.faceYaxis=e.faceYaxis.map((t=>w.FromArray(t)));const s=new pC(t.name,i);return s.goldbergData=e,s}}function mC(t){const i=t.pattern||Ys.NO_FLIP,e=t.tileWidth||t.tileSize||1,s=t.tileHeight||t.tileSize||1,n=t.alignHorizontal||0,r=t.alignVertical||0,h=t.width||t.size||1,o=Math.floor(h/e);let a=h-o*e;const l=t.height||t.size||1,c=Math.floor(l/s);let u=l-c*s;const f=e*o/2,d=s*c/2;let p=0,m=0,v=0,g=0,S=0,E=0;if(a>0||u>0){switch(v=-f,g=-d,S=f,E=d,n){case Ys.CENTER:a/=2,v-=a,S+=a;break;case Ys.LEFT:S+=a,p=-a/2;break;case Ys.RIGHT:v-=a,p=a/2}switch(r){case Ys.CENTER:u/=2,g-=u,E+=u;break;case Ys.BOTTOM:E+=u,m=-u/2;break;case Ys.TOP:g-=u,m=u/2}}const A=[],C=[],w=[];w[0]=[0,0,1,0,1,1,0,1],w[1]=[0,0,1,0,1,1,0,1],i!==Ys.ROTATE_TILE&&i!==Ys.ROTATE_ROW||(w[1]=[1,1,0,1,0,0,1,0]),i!==Ys.FLIP_TILE&&i!==Ys.FLIP_ROW||(w[1]=[1,0,0,0,0,1,1,1]),i!==Ys.FLIP_N_ROTATE_TILE&&i!==Ys.FLIP_N_ROTATE_ROW||(w[1]=[0,1,1,1,1,0,0,0]);let x=[];const T=[],R=[];let I=0;for(let t=0;t<c;t++)for(let n=0;n<o;n++)A.push(n*e-f+p,t*s-d+m,0),A.push((n+1)*e-f+p,t*s-d+m,0),A.push((n+1)*e-f+p,(t+1)*s-d+m,0),A.push(n*e-f+p,(t+1)*s-d+m,0),R.push(I,I+1,I+3,I+1,I+2,I+3),x=i===Ys.FLIP_TILE||i===Ys.ROTATE_TILE||i===Ys.FLIP_N_ROTATE_TILE?x.concat(w[(n%2+t%2)%2]):i===Ys.FLIP_ROW||i===Ys.ROTATE_ROW||i===Ys.FLIP_N_ROTATE_ROW?x.concat(w[t%2]):x.concat(w[0]),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),I+=4;if(a>0||u>0){const t=u>0&&(r===Ys.CENTER||r===Ys.TOP),h=u>0&&(r===Ys.CENTER||r===Ys.BOTTOM),l=a>0&&(n===Ys.CENTER||n===Ys.RIGHT),w=a>0&&(n===Ys.CENTER||n===Ys.LEFT);let M,b,_,y,N=[];if(t&&l&&(A.push(v+p,g+m,0),A.push(-f+p,g+m,0),A.push(-f+p,g+u+m,0),A.push(v+p,g+u+m,0),R.push(I,I+1,I+3,I+1,I+2,I+3),I+=4,M=1-a/e,b=1-u/s,_=1,y=1,N=[M,b,_,b,_,y,M,y],i===Ys.ROTATE_ROW&&(N=[1-M,1-b,1-_,1-b,1-_,1-y,1-M,1-y]),i===Ys.FLIP_ROW&&(N=[1-M,b,1-_,b,1-_,y,1-M,y]),i===Ys.FLIP_N_ROTATE_ROW&&(N=[M,1-b,_,1-b,_,1-y,M,1-y]),x=x.concat(N),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),t&&w&&(A.push(f+p,g+m,0),A.push(S+p,g+m,0),A.push(S+p,g+u+m,0),A.push(f+p,g+u+m,0),R.push(I,I+1,I+3,I+1,I+2,I+3),I+=4,M=0,b=1-u/s,_=a/e,y=1,N=[M,b,_,b,_,y,M,y],(i===Ys.ROTATE_ROW||i===Ys.ROTATE_TILE&&o%2==0)&&(N=[1-M,1-b,1-_,1-b,1-_,1-y,1-M,1-y]),(i===Ys.FLIP_ROW||i===Ys.FLIP_TILE&&o%2==0)&&(N=[1-M,b,1-_,b,1-_,y,1-M,y]),(i===Ys.FLIP_N_ROTATE_ROW||i===Ys.FLIP_N_ROTATE_TILE&&o%2==0)&&(N=[M,1-b,_,1-b,_,1-y,M,1-y]),x=x.concat(N),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),h&&l&&(A.push(v+p,d+m,0),A.push(-f+p,d+m,0),A.push(-f+p,E+m,0),A.push(v+p,E+m,0),R.push(I,I+1,I+3,I+1,I+2,I+3),I+=4,M=1-a/e,b=0,_=1,y=u/s,N=[M,b,_,b,_,y,M,y],(i===Ys.ROTATE_ROW&&c%2==1||i===Ys.ROTATE_TILE&&c%1==0)&&(N=[1-M,1-b,1-_,1-b,1-_,1-y,1-M,1-y]),(i===Ys.FLIP_ROW&&c%2==1||i===Ys.FLIP_TILE&&c%2==0)&&(N=[1-M,b,1-_,b,1-_,y,1-M,y]),(i===Ys.FLIP_N_ROTATE_ROW&&c%2==1||i===Ys.FLIP_N_ROTATE_TILE&&c%2==0)&&(N=[M,1-b,_,1-b,_,1-y,M,1-y]),x=x.concat(N),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),h&&w&&(A.push(f+p,d+m,0),A.push(S+p,d+m,0),A.push(S+p,E+m,0),A.push(f+p,E+m,0),R.push(I,I+1,I+3,I+1,I+2,I+3),I+=4,M=0,b=0,_=a/e,y=u/s,N=[M,b,_,b,_,y,M,y],(i===Ys.ROTATE_ROW&&c%2==1||i===Ys.ROTATE_TILE&&(c+o)%2==1)&&(N=[1-M,1-b,1-_,1-b,1-_,1-y,1-M,1-y]),(i===Ys.FLIP_ROW&&c%2==1||i===Ys.FLIP_TILE&&(c+o)%2==1)&&(N=[1-M,b,1-_,b,1-_,y,1-M,y]),(i===Ys.FLIP_N_ROTATE_ROW&&c%2==1||i===Ys.FLIP_N_ROTATE_TILE&&(c+o)%2==1)&&(N=[M,1-b,_,1-b,_,1-y,M,1-y]),x=x.concat(N),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),t){const t=[];M=0,b=1-u/s,_=1,y=1,t[0]=[M,b,_,b,_,y,M,y],t[1]=[M,b,_,b,_,y,M,y],i!==Ys.ROTATE_TILE&&i!==Ys.ROTATE_ROW||(t[1]=[1-M,1-b,1-_,1-b,1-_,1-y,1-M,1-y]),i!==Ys.FLIP_TILE&&i!==Ys.FLIP_ROW||(t[1]=[1-M,b,1-_,b,1-_,y,1-M,y]),i!==Ys.FLIP_N_ROTATE_TILE&&i!==Ys.FLIP_N_ROTATE_ROW||(t[1]=[M,1-b,_,1-b,_,1-y,M,1-y]);for(let s=0;s<o;s++)A.push(s*e-f+p,g+m,0),A.push((s+1)*e-f+p,g+m,0),A.push((s+1)*e-f+p,g+u+m,0),A.push(s*e-f+p,g+u+m,0),R.push(I,I+1,I+3,I+1,I+2,I+3),I+=4,x=i===Ys.FLIP_TILE||i===Ys.ROTATE_TILE||i===Ys.FLIP_N_ROTATE_TILE?x.concat(t[(s+1)%2]):i===Ys.FLIP_ROW||i===Ys.ROTATE_ROW||i===Ys.FLIP_N_ROTATE_ROW?x.concat(t[1]):x.concat(t[0]),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(h){const t=[];M=0,b=0,_=1,y=u/s,t[0]=[M,b,_,b,_,y,M,y],t[1]=[M,b,_,b,_,y,M,y],i!==Ys.ROTATE_TILE&&i!==Ys.ROTATE_ROW||(t[1]=[1-M,1-b,1-_,1-b,1-_,1-y,1-M,1-y]),i!==Ys.FLIP_TILE&&i!==Ys.FLIP_ROW||(t[1]=[1-M,b,1-_,b,1-_,y,1-M,y]),i!==Ys.FLIP_N_ROTATE_TILE&&i!==Ys.FLIP_N_ROTATE_ROW||(t[1]=[M,1-b,_,1-b,_,1-y,M,1-y]);for(let s=0;s<o;s++)A.push(s*e-f+p,E-u+m,0),A.push((s+1)*e-f+p,E-u+m,0),A.push((s+1)*e-f+p,E+m,0),A.push(s*e-f+p,E+m,0),R.push(I,I+1,I+3,I+1,I+2,I+3),I+=4,x=i===Ys.FLIP_TILE||i===Ys.ROTATE_TILE||i===Ys.FLIP_N_ROTATE_TILE?x.concat(t[(s+c)%2]):i===Ys.FLIP_ROW||i===Ys.ROTATE_ROW||i===Ys.FLIP_N_ROTATE_ROW?x.concat(t[c%2]):x.concat(t[0]),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(l){const t=[];M=1-a/e,b=0,_=1,y=1,t[0]=[M,b,_,b,_,y,M,y],t[1]=[M,b,_,b,_,y,M,y],i!==Ys.ROTATE_TILE&&i!==Ys.ROTATE_ROW||(t[1]=[1-M,1-b,1-_,1-b,1-_,1-y,1-M,1-y]),i!==Ys.FLIP_TILE&&i!==Ys.FLIP_ROW||(t[1]=[1-M,b,1-_,b,1-_,y,1-M,y]),i!==Ys.FLIP_N_ROTATE_TILE&&i!==Ys.FLIP_N_ROTATE_ROW||(t[1]=[M,1-b,_,1-b,_,1-y,M,1-y]);for(let e=0;e<c;e++)A.push(v+p,e*s-d+m,0),A.push(v+a+p,e*s-d+m,0),A.push(v+a+p,(e+1)*s-d+m,0),A.push(v+p,(e+1)*s-d+m,0),R.push(I,I+1,I+3,I+1,I+2,I+3),I+=4,x=i===Ys.FLIP_TILE||i===Ys.ROTATE_TILE||i===Ys.FLIP_N_ROTATE_TILE?x.concat(t[(e+1)%2]):i===Ys.FLIP_ROW||i===Ys.ROTATE_ROW||i===Ys.FLIP_N_ROTATE_ROW?x.concat(t[e%2]):x.concat(t[0]),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(w){const t=[];M=0,b=0,_=a/s,y=1,t[0]=[M,b,_,b,_,y,M,y],t[1]=[M,b,_,b,_,y,M,y],i!==Ys.ROTATE_TILE&&i!==Ys.ROTATE_ROW||(t[1]=[1-M,1-b,1-_,1-b,1-_,1-y,1-M,1-y]),i!==Ys.FLIP_TILE&&i!==Ys.FLIP_ROW||(t[1]=[1-M,b,1-_,b,1-_,y,1-M,y]),i!==Ys.FLIP_N_ROTATE_TILE&&i!==Ys.FLIP_N_ROTATE_ROW||(t[1]=[M,1-b,_,1-b,_,1-y,M,1-y]);for(let e=0;e<c;e++)A.push(S-a+p,e*s-d+m,0),A.push(S+p,e*s-d+m,0),A.push(S+p,(e+1)*s-d+m,0),A.push(S-a+p,(e+1)*s-d+m,0),R.push(I,I+1,I+3,I+1,I+2,I+3),I+=4,x=i===Ys.FLIP_TILE||i===Ys.ROTATE_TILE||i===Ys.FLIP_N_ROTATE_TILE?x.concat(t[(e+o)%2]):i===Ys.FLIP_ROW||i===Ys.ROTATE_ROW||i===Ys.FLIP_N_ROTATE_ROW?x.concat(t[e%2]):x.concat(t[0]),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}const M=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE;os.JA(M,A,R,C,x,t.frontUVs,t.backUVs);const b=new os;b.indices=R,b.positions=A,b.normals=C,b.uvs=x;const _=M===os.DOUBLESIDE?T.concat(T):T;return b.colors=_,b}function vC(t){const i=t.faceUV||new Array(6),e=t.faceColors,s=t.pattern||Ys.NO_FLIP,n=t.width||t.size||1,r=t.height||t.size||1,h=t.depth||t.size||1,o=t.tileWidth||t.tileSize||1,a=t.tileHeight||t.tileSize||1,l=t.alignHorizontal||0,c=t.alignVertical||0,u=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE;for(let t=0;t<6;t++)void 0===i[t]&&(i[t]=new x(0,0,1,1)),e&&void 0===e[t]&&(e[t]=new y(1,1,1,1));const f=n/2,d=r/2,p=h/2,m=[];for(let t=0;t<2;t++)m[t]=mC({pattern:s,tileWidth:o,tileHeight:a,width:n,height:r,alignVertical:c,alignHorizontal:l,sideOrientation:u});for(let t=2;t<4;t++)m[t]=mC({pattern:s,tileWidth:o,tileHeight:a,width:h,height:r,alignVertical:c,alignHorizontal:l,sideOrientation:u});let v=c;c===Ys.BOTTOM?v=Ys.TOP:c===Ys.TOP&&(v=Ys.BOTTOM);for(let t=4;t<6;t++)m[t]=mC({pattern:s,tileWidth:o,tileHeight:a,width:n,height:h,alignVertical:v,alignHorizontal:l,sideOrientation:u});let g=[],S=[],E=[],A=[];const C=[],T=[],I=[],M=[];let b=0,_=0;for(let t=0;t<6;t++){const s=m[t].positions.length;T[t]=[],I[t]=[];for(let i=0;i<s/3;i++)T[t].push(new w(m[t].positions[3*i],m[t].positions[3*i+1],m[t].positions[3*i+2])),I[t].push(new w(m[t].normals[3*i],m[t].normals[3*i+1],m[t].normals[3*i+2]));b=m[t].uvs.length,M[t]=[];for(let e=0;e<b;e+=2)M[t][e]=i[t].x+(i[t].z-i[t].x)*m[t].uvs[e],M[t][e+1]=i[t].y+(i[t].w-i[t].y)*m[t].uvs[e+1],As.UseOpenGLOrientationForUV&&(M[t][e+1]=1-M[t][e+1]);if(E=E.concat(M[t]),A=A.concat(m[t].indices.map((t=>t+_))),_+=T[t].length,e)for(let i=0;i<4;i++)C.push(e[t].r,e[t].g,e[t].b,e[t].a)}const N=new w(0,0,p),P=R.RotationY(Math.PI);g=T[0].map((t=>w.TransformNormal(t,P).add(N))).map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[]),S=I[0].map((t=>w.TransformNormal(t,P))).map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[]),g=g.concat(T[1].map((t=>t.subtract(N))).map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[])),S=S.concat(I[1].map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[]));const D=new w(f,0,0),L=R.RotationY(-Math.PI/2);g=g.concat(T[2].map((t=>w.TransformNormal(t,L).add(D))).map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[])),S=S.concat(I[2].map((t=>w.TransformNormal(t,L))).map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[]));const O=R.RotationY(Math.PI/2);g=g.concat(T[3].map((t=>w.TransformNormal(t,O).subtract(D))).map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[])),S=S.concat(I[3].map((t=>w.TransformNormal(t,O))).map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[]));const F=new w(0,d,0),B=R.RotationX(Math.PI/2);g=g.concat(T[4].map((t=>w.TransformNormal(t,B).add(F))).map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[])),S=S.concat(I[4].map((t=>w.TransformNormal(t,B))).map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[]));const U=R.RotationX(-Math.PI/2);g=g.concat(T[5].map((t=>w.TransformNormal(t,U).subtract(F))).map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[])),S=S.concat(I[5].map((t=>w.TransformNormal(t,U))).map((t=>[t.x,t.y,t.z])).reduce(((t,i)=>t.concat(i)),[])),os.JA(u,g,A,S,E);const V=new os;if(V.indices=A,V.positions=g,V.normals=S,V.uvs=E,e){const t=u===os.DOUBLESIDE?C.concat(C):C;V.colors=t}return V}os.CreateTiledPlane=mC;function gC(t){const i=new Array,e=new Array,s=new Array,n=new Array,r=t.radius||2,h=t.tube||.5,o=t.radialSegments||32,a=t.tubularSegments||32,l=t.p||2,c=t.q||3,u=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE,f=t=>{const i=Math.cos(t),e=Math.sin(t),s=c/l*t,n=Math.cos(s),h=r*(2+n)*.5*i,o=r*(2+n)*e*.5,a=r*Math.sin(s)*.5;return new w(h,o,a)};let d,p;for(d=0;d<=o;d++){const t=d%o/o*2*l*Math.PI,i=f(t),s=f(t+.01),r=s.subtract(i);let c=s.add(i);const u=w.Cross(r,c);for(c=w.Cross(u,r),u.normalize(),c.normalize(),p=0;p<a;p++){const t=p%a/a*2*Math.PI,s=-h*Math.cos(t),r=h*Math.sin(t);e.push(i.x+s*c.x+r*u.x),e.push(i.y+s*c.y+r*u.y),e.push(i.z+s*c.z+r*u.z),n.push(d/o),n.push(As.UseOpenGLOrientationForUV?1-p/a:p/a)}}for(d=0;d<o;d++)for(p=0;p<a;p++){const t=(p+1)%a,e=d*a+p,s=(d+1)*a+p,n=(d+1)*a+t,r=d*a+t;i.push(r),i.push(s),i.push(e),i.push(r),i.push(n),i.push(s)}os.ComputeNormals(e,i,s),os.JA(u,e,i,s,n,t.frontUVs,t.backUVs);const m=new os;return m.indices=i,m.positions=e,m.normals=s,m.uvs=n,m}function SC(t,i={},e){const s=new Ys(t,e);i.sideOrientation=Ys.OI(i.sideOrientation),s.yI=i.sideOrientation;return gC(i).applyToMesh(s,i.updatable),s}os.CreateTiledBox=vC;os.CreateTorusKnot=gC,Ys.CreateTorusKnot=(t,i,e,s,n,r,h,o,a,l)=>SC(t,{radius:i,tube:e,radialSegments:s,tubularSegments:n,p:r,q:h,sideOrientation:l,updatable:a},o);class EC extends C{constructor(t,i){super(t.x,t.y),this.index=i}}class AC{constructor(){this.elements=new Array}add(t){const i=new Array;return t.forEach((t=>{const e=new EC(t,this.elements.length);i.push(e),this.elements.push(e)})),i}computeBounds(){const t=new C(this.elements[0].x,this.elements[0].y),i=new C(this.elements[0].x,this.elements[0].y);return this.elements.forEach((e=>{e.x<t.x?t.x=e.x:e.x>i.x&&(i.x=e.x),e.y<t.y?t.y=e.y:e.y>i.y&&(i.y=e.y)})),{min:t,max:i,width:i.x-t.x,height:i.y-t.y}}}class CC{constructor(t,i,e,s=earcut){let n;this._E=new AC,this.Got=new AC,this.zot=new Array,this.Hot=new Array,this.Xot=new Array,this.bjsEarcut=s,this.hn=t,this.Kt=e||E.LastCreatedScene,n=i instanceof $e?i.getPoints():i,this.Wot(n),this._E.add(n),this.Got.add(n),void 0===this.bjsEarcut&&F.Warn("Earcut was not found, the polygon will not be built.")}Wot(t){for(const i of t)this.Hot.push(i.x,i.y)}addHole(t){this._E.add(t);const i=new AC;return i.add(t),this.zot.push(i),this.Xot.push(this.Hot.length/2),this.Wot(t),this}build(t=!1,i=0,e=2){const s=new Ys(this.hn,this.Kt),n=this.buildVertexData(i,e);return s.setVerticesData(he.PositionKind,n.positions,t),s.setVerticesData(he.NormalKind,n.normals,t),s.setVerticesData(he.UVKind,n.uvs,t),s.setIndices(n.indices),s}buildVertexData(t=0,i=2){const e=new os,s=new Array,n=new Array,r=new Array,h=this._E.computeBounds();this._E.elements.forEach((t=>{s.push(0,1,0),n.push(t.x,0,t.y),r.push((t.x-h.min.x)/h.width,(t.y-h.min.y)/h.height)}));const o=new Array,a=this.bjsEarcut(this.Hot,this.Xot,2);for(let t=0;t<a.length;t++)o.push(a[t]);if(t>0){const e=n.length/3;this._E.elements.forEach((i=>{s.push(0,-1,0),n.push(i.x,-t,i.y),r.push(1-(i.x-h.min.x)/h.width,1-(i.y-h.min.y)/h.height)}));const a=o.length;for(let t=0;t<a;t+=3){const i=o[t+0],s=o[t+1],n=o[t+2];o.push(n+e),o.push(s+e),o.push(i+e)}this.$ot(n,s,r,o,h,this.Got,t,!1,i),this.zot.forEach((e=>{this.$ot(n,s,r,o,h,e,t,!0,i)}))}return e.indices=o,e.positions=n,e.normals=s,e.uvs=r,e}$ot(t,i,e,s,n,r,h,o,a){let l=t.length/3,c=0;for(let u=0;u<r.elements.length;u++){const f=r.elements[u],d=r.elements[(u+1)%r.elements.length];t.push(f.x,0,f.y),t.push(f.x,-h,f.y),t.push(d.x,0,d.y),t.push(d.x,-h,d.y);const p=r.elements[(u+r.elements.length-1)%r.elements.length],m=r.elements[(u+2)%r.elements.length];let v=new w(-(d.y-f.y),0,d.x-f.x),g=new w(-(f.y-p.y),0,f.x-p.x),S=new w(-(m.y-d.y),0,m.x-d.x);o||(v=v.scale(-1),g=g.scale(-1),S=S.scale(-1));const E=v.normalizeToNew();let A=g.normalizeToNew(),C=S.normalizeToNew();const x=w.Dot(A,E);A=x>a?x<-.999?new w(f.x,0,f.y).subtract(new w(d.x,0,d.y)).normalize():g.add(v).normalize():E;const T=w.Dot(S,v);C=T>a?T<-.999?new w(d.x,0,d.y).subtract(new w(f.x,0,f.y)).normalize():S.add(v).normalize():E,e.push(c/n.width,0),e.push(c/n.width,1),c+=v.length(),e.push(c/n.width,0),e.push(c/n.width,1),i.push(A.x,A.y,A.z),i.push(A.x,A.y,A.z),i.push(C.x,C.y,C.z),i.push(C.x,C.y,C.z),o?(s.push(l),s.push(l+2),s.push(l+1),s.push(l+1),s.push(l+2),s.push(l+3)):(s.push(l),s.push(l+1),s.push(l+2),s.push(l+1),s.push(l+3),s.push(l+2)),l+=4}}}function wC(t,i,e,s,n,r,h){const o=e||new Array(3),a=s,l=[],c=h||!1;for(let t=0;t<3;t++)void 0===o[t]&&(o[t]=new x(0,0,1,1)),a&&void 0===a[t]&&(a[t]=new y(1,1,1,1));const u=t.getVerticesData(he.PositionKind),f=t.getVerticesData(he.NormalKind),d=t.getVerticesData(he.UVKind),p=t.getIndices(),m=u.length/9;let v=0,g=0,S=0,E=0,A=0;const C=[0];if(c)for(let t=m;t<u.length/3;t+=4)g=u[3*(t+2)]-u[3*t],S=u[3*(t+2)+2]-u[3*t+2],E=Math.sqrt(g*g+S*S),A+=E,C.push(A);let w=0,T=0;for(let t=0;t<f.length;t+=3)Math.abs(f[t+1])<.001&&(T=1),Math.abs(f[t+1]-1)<.001&&(T=0),Math.abs(f[t+1]+1)<.001&&(T=2),w=t/3,1===T?(v=w-m,d[2*w]=v%4<1.5?c?o[T].x+(o[T].z-o[T].x)*C[Math.floor(v/4)]/A:o[T].x:c?o[T].x+(o[T].z-o[T].x)*C[Math.floor(v/4)+1]/A:o[T].z,d[2*w+1]=v%2==0?As.UseOpenGLOrientationForUV?1-o[T].w:o[T].w:As.UseOpenGLOrientationForUV?1-o[T].y:o[T].y):(d[2*w]=(1-d[2*w])*o[T].x+d[2*w]*o[T].z,d[2*w+1]=(1-d[2*w+1])*o[T].y+d[2*w+1]*o[T].w,As.UseOpenGLOrientationForUV&&(d[2*w+1]=1-d[2*w+1])),a&&l.push(a[T].r,a[T].g,a[T].b,a[T].a);os.JA(i,u,p,f,d,n,r);const R=new os;if(R.indices=p,R.positions=u,R.normals=f,R.uvs=d,a){const t=i===os.DOUBLESIDE?l.concat(l):l;R.colors=t}return R}function xC(t,i,e=null,s=earcut){i.sideOrientation=Ys.OI(i.sideOrientation);const n=i.shape,r=i.holes||[],h=i.depth||0,o=i.smoothingThreshold||2,a=[];let l=[];for(let t=0;t<n.length;t++)a[t]=new C(n[t].x,n[t].z);a[0].equalsWithEpsilon(a[a.length-1],1e-8)&&a.pop();const c=new CC(t,a,e||E.LastCreatedScene,s);for(let t=0;t<r.length;t++){l=[];for(let i=0;i<r[t].length;i++)l.push(new C(r[t][i].x,r[t][i].z));c.addHole(l)}const u=c.build(!1,h,o);u.yI=i.sideOrientation;return wC(u,i.sideOrientation,i.faceUV,i.faceColors,i.frontUVs,i.backUVs,i.wrap).applyToMesh(u,i.updatable),u}function TC(t,i,e=null,s=earcut){return xC(t,i,e,s)}function RC(t,i,e=null){const s=i.arc?i.arc<=0||i.arc>1?1:i.arc:1,n=void 0===i.closed||i.closed,r=i.shape,h=i.radius||1,o=i.tessellation||64,a=i.clip||0,l=i.updatable,c=Ys.OI(i.sideOrientation),u=i.cap||Ys.NO_CAP,f=2*Math.PI,d=new Array,p=i.invertUV||!1;let m=0,v=0;const g=f/o*s;let S,E;for(m=0;m<=o-a;m++){for(E=[],u!=Ys.CAP_START&&u!=Ys.CAP_ALL||(E.push(new w(0,r[0].y,0)),E.push(new w(Math.cos(m*g)*r[0].x*h,r[0].y,Math.sin(m*g)*r[0].x*h))),v=0;v<r.length;v++)S=new w(Math.cos(m*g)*r[v].x*h,r[v].y,Math.sin(m*g)*r[v].x*h),E.push(S);u!=Ys.CAP_END&&u!=Ys.CAP_ALL||(E.push(new w(Math.cos(m*g)*r[r.length-1].x*h,r[r.length-1].y,Math.sin(m*g)*r[r.length-1].x*h)),E.push(new w(0,r[r.length-1].y,0))),d.push(E)}return mu(t,{pathArray:d,closeArray:n,sideOrientation:c,updatable:l,invertUV:p,frontUVs:i.frontUVs,backUVs:i.backUVs},e)}os.CreatePolygon=wC,Ys.CreatePolygon=(t,i,e,s,n,r,h=earcut)=>xC(t,{shape:i,holes:s,updatable:n,sideOrientation:r},e,h),Ys.ExtrudePolygon=(t,i,e,s,n,r,h,o=earcut)=>TC(t,{shape:i,holes:n,depth:e,updatable:r,sideOrientation:h},s,o);function IC(t,i,e=null){const s=i.path;let n=i.instance,r=1;void 0!==i.radius?r=i.radius:n&&(r=n.MI.radius);const h=i.tessellation||64,o=i.radiusFunction||null;let a=i.cap||Ys.NO_CAP;const l=i.invertUV||!1,c=i.updatable,u=Ys.OI(i.sideOrientation);i.arc=i.arc&&(i.arc<=0||i.arc>1)?1:i.arc||1;const f=(t,i,e,s,n,r,h,o)=>{const a=i.getTangents(),l=i.getNormals(),c=i.getDistances(),u=2*Math.PI/n*o,f=r||(()=>s);let d,p,m,v;const g=M.Matrix[0];let S=h===Ys.NO_CAP||h===Ys.CAP_END?0:2;for(let i=0;i<t.length;i++){p=f(i,c[i]),d=Array(),m=l[i];for(let e=0;e<n;e++)R.RotationAxisToRef(a[i],u*e,g),v=d[e]?d[e]:w.Zero(),w.TransformCoordinatesToRef(m,g,v),v.scaleInPlace(p).addInPlace(t[i]),d[e]=v;e[S]=d,S++}const E=(i,e)=>{const s=Array();for(let n=0;n<i;n++)s.push(t[e]);return s};switch(h){case Ys.NO_CAP:break;case Ys.CAP_START:e[0]=E(n,0),e[1]=e[2].slice(0);break;case Ys.CAP_END:e[S]=e[S-1].slice(0),e[S+1]=E(n,t.length-1);break;case Ys.CAP_ALL:e[0]=E(n,0),e[1]=e[2].slice(0),e[S]=e[S-1].slice(0),e[S+1]=E(n,t.length-1)}return e};let d,p;if(n){const t=n.MI,e=i.arc||t.arc;return d=t.path3D.update(s),p=f(s,d,t.pathArray,r,t.tessellation,o,t.cap,e),n=mu("",{pathArray:p,instance:n}),t.path3D=d,t.pathArray=p,t.arc=e,t.radius=r,n}d=new Ye(s);a=a<0||a>3?0:a,p=f(s,d,new Array,r,h,o,a,i.arc);const m=mu(t,{pathArray:p,closePath:!0,closeArray:!1,updatable:c,sideOrientation:u,invertUV:l,frontUVs:i.frontUVs,backUVs:i.backUVs},e);return m.MI.pathArray=p,m.MI.path3D=d,m.MI.tessellation=h,m.MI.cap=a,m.MI.arc=i.arc,m.MI.radius=r,m}Ys.CreateLathe=(t,i,e,s,n,r,h)=>RC(t,{shape:i,radius:e,tessellation:s,sideOrientation:h,updatable:r},n);Ys.CreateTube=(t,i,e,s,n,r,h,o,a,l)=>IC(t,{path:i,radius:e,tessellation:s,radiusFunction:n,arc:1,cap:r,updatable:o,sideOrientation:a,instance:l},h);const MC=new w(1,0,0),bC=new w(-1,0,0),_C=new w(0,1,0),yC=new w(0,-1,0),NC=new w(0,0,1),PC=new w(0,0,-1);class DC{constructor(t=w.Zero(),i=w.Up(),e=C.Zero(),s=0,n=0,r=null,h=null,o=null,a=null){this.position=t,this.normal=i,this.uv=e,this.vertexIdx=s,this.vertexIdxForBones=n,this.localPositionOverride=r,this.localNormalOverride=h,this.matrixIndicesOverride=o,this.matrixWeightsOverride=a}clone(){var t,i,e,s;return new DC(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,null===(t=this.localPositionOverride)||void 0===t?void 0:t.slice(),null===(i=this.localNormalOverride)||void 0===i?void 0:i.slice(),null===(e=this.matrixIndicesOverride)||void 0===e?void 0:e.slice(),null===(s=this.matrixWeightsOverride)||void 0===s?void 0:s.slice())}}function LC(t,i,e){const s=!!i.skeleton,n=e.localMode||s,r=null!==i.overrideMaterialSideOrientation&&void 0!==i.overrideMaterialSideOrientation,h=i.getIndices(),a=s?i.getPositionData(!0,!0):i.getVerticesData(he.PositionKind),l=s?i.getNormalsData(!0,!0):i.getVerticesData(he.NormalKind),c=n?s?i.getVerticesData(he.PositionKind):a:null,u=n?s?i.getVerticesData(he.NormalKind):l:null,f=i.getVerticesData(he.UVKind),d=s?i.getVerticesData(he.MatricesIndicesKind):null,p=s?i.getVerticesData(he.MatricesWeightsKind):null,m=s?i.getVerticesData(he.MatricesIndicesExtraKind):null,v=s?i.getVerticesData(he.MatricesWeightsExtraKind):null,g=e.position||w.Zero();let S=e.normal||w.Up();const E=e.size||w.One(),A=e.angle||0;if(!S){const t=new w(0,0,1),e=i.getScene().activeCamera,s=w.TransformCoordinates(t,e.getWorldMatrix());S=e.globalPosition.subtract(s)}const x=-Math.atan2(S.z,S.x)-Math.PI/2,T=Math.sqrt(S.x*S.x+S.z*S.z),I=Math.atan2(S.y,T),M=R.RotationYawPitchRoll(x,I,A).multiply(R.Translation(g.x,g.y,g.z)),b=R.Invert(M),_=i.getWorldMatrix().multiply(b),y=new os;y.indices=[],y.positions=[],y.normals=[],y.uvs=[],y.matricesIndices=s?[]:null,y.matricesWeights=s?[]:null,y.matricesIndicesExtra=m?[]:null,y.matricesWeightsExtra=v?[]:null;let N=0;const P=t=>{const i=new DC;if(!h||!a||!l)return i;const s=h[t];if(i.vertexIdx=3*s,i.vertexIdxForBones=4*s,i.position=new w(a[3*s],a[3*s+1],a[3*s+2]),w.TransformCoordinatesToRef(i.position,_,i.position),i.normal=new w(l[3*s],l[3*s+1],l[3*s+2]),w.TransformNormalToRef(i.normal,_,i.normal),e.captureUVS&&f){const t=f[2*s+1];i.uv=new C(f[2*s],As.UseOpenGLOrientationForUV?1-t:t)}return i},D=[0,0,0,0],L=(t,i)=>{if(0===t.length)return t;const e=.5*Math.abs(w.Dot(E,i)),s=(t,i,e,s)=>{for(let n=0;n<s;++n)if(t[e+n]===i)return e+n;return-1},n=(t,n)=>{var r,h,a,l,f,m,v,g,S,E,A,x,T,R,I,M;const b=w.GetClipFactor(t.position,n.position,i,e);let _=D,y=D;if(d&&p){const i=t.matrixIndicesOverride?0:t.vertexIdxForBones,e=null!==(r=t.matrixIndicesOverride)&&void 0!==r?r:d,c=null!==(h=t.matrixWeightsOverride)&&void 0!==h?h:p,u=n.matrixIndicesOverride?0:n.vertexIdxForBones,f=null!==(a=n.matrixIndicesOverride)&&void 0!==a?a:d,m=null!==(l=n.matrixWeightsOverride)&&void 0!==l?l:p;_=[0,0,0,0],y=[0,0,0,0];let v=0;for(let t=0;t<4;++t)if(c[i+t]>0){const n=s(f,e[i+t],u,4);_[v]=e[i+t],y[v]=o.Lerp(c[i+t],n>=0?m[n]:0,b),v++}for(let t=0;t<4&&v<4;++t){const n=f[u+t];-1===s(e,n,i,4)&&(_[v]=n,y[v]=o.Lerp(0,m[u+t],b),v++)}const g=y[0]+y[1]+y[2]+y[3];y[0]/=g,y[1]/=g,y[2]/=g,y[3]/=g}const N=t.localPositionOverride?t.localPositionOverride[0]:null!==(f=null==c?void 0:c[t.vertexIdx])&&void 0!==f?f:0,P=t.localPositionOverride?t.localPositionOverride[1]:null!==(m=null==c?void 0:c[t.vertexIdx+1])&&void 0!==m?m:0,L=t.localPositionOverride?t.localPositionOverride[2]:null!==(v=null==c?void 0:c[t.vertexIdx+2])&&void 0!==v?v:0,O=n.localPositionOverride?n.localPositionOverride[0]:null!==(g=null==c?void 0:c[n.vertexIdx])&&void 0!==g?g:0,F=n.localPositionOverride?n.localPositionOverride[1]:null!==(S=null==c?void 0:c[n.vertexIdx+1])&&void 0!==S?S:0,B=n.localPositionOverride?n.localPositionOverride[2]:null!==(E=null==c?void 0:c[n.vertexIdx+2])&&void 0!==E?E:0,U=t.localNormalOverride?t.localNormalOverride[0]:null!==(A=null==u?void 0:u[t.vertexIdx])&&void 0!==A?A:0,V=t.localNormalOverride?t.localNormalOverride[1]:null!==(x=null==u?void 0:u[t.vertexIdx+1])&&void 0!==x?x:0,k=t.localNormalOverride?t.localNormalOverride[2]:null!==(T=null==u?void 0:u[t.vertexIdx+2])&&void 0!==T?T:0,G=U+((n.localNormalOverride?n.localNormalOverride[0]:null!==(R=null==u?void 0:u[n.vertexIdx])&&void 0!==R?R:0)-U)*b,z=V+((n.localNormalOverride?n.localNormalOverride[1]:null!==(I=null==u?void 0:u[n.vertexIdx+1])&&void 0!==I?I:0)-V)*b,H=k+((n.localNormalOverride?n.localNormalOverride[2]:null!==(M=null==u?void 0:u[n.vertexIdx+2])&&void 0!==M?M:0)-k)*b,X=Math.sqrt(G*G+z*z+H*H);return new DC(w.Lerp(t.position,n.position,b),w.Lerp(t.normal,n.normal,b).normalize(),C.Lerp(t.uv,n.uv,b),-1,-1,c?[N+(O-N)*b,P+(F-P)*b,L+(B-L)*b]:null,u?[G/X,z/X,H/X]:null,_,y)};let r=null;t.length>3&&(r=new Array);for(let s=0;s<t.length;s+=3){let h=0,o=null,a=null,l=null,c=null;const u=w.Dot(t[s].position,i)-e>0,f=w.Dot(t[s+1].position,i)-e>0,d=w.Dot(t[s+2].position,i)-e>0;switch(h=(u?1:0)+(f?1:0)+(d?1:0),h){case 0:t.length>3?(r.push(t[s]),r.push(t[s+1]),r.push(t[s+2])):r=t;break;case 1:if(r=null!=r?r:new Array,u&&(o=t[s+1],a=t[s+2],l=n(t[s],o),c=n(t[s],a)),f){o=t[s],a=t[s+2],l=n(t[s+1],o),c=n(t[s+1],a),r.push(l),r.push(a.clone()),r.push(o.clone()),r.push(a.clone()),r.push(l.clone()),r.push(c);break}d&&(o=t[s],a=t[s+1],l=n(t[s+2],o),c=n(t[s+2],a)),o&&a&&l&&c&&(r.push(o.clone()),r.push(a.clone()),r.push(l),r.push(c),r.push(l.clone()),r.push(a.clone()));break;case 2:r=null!=r?r:new Array,u||(o=t[s].clone(),a=n(o,t[s+1]),l=n(o,t[s+2]),r.push(o),r.push(a),r.push(l)),f||(o=t[s+1].clone(),a=n(o,t[s+2]),l=n(o,t[s]),r.push(o),r.push(a),r.push(l)),d||(o=t[s+2].clone(),a=n(o,t[s]),l=n(o,t[s+1]),r.push(o),r.push(a),r.push(l))}}return r},O=new Array(3);for(let t=0;t<h.length;t+=3){let i=O;if(i[0]=P(t),r&&n?(i[1]=P(t+2),i[2]=P(t+1)):(i[1]=P(t+1),i[2]=P(t+2)),!(e.cullBackFaces&&-i[0].normal.z<=0&&-i[1].normal.z<=0&&-i[2].normal.z<=0)&&(i=L(i,MC),i&&(i=L(i,bC),i&&(i=L(i,_C),i&&(i=L(i,yC),i&&(i=L(i,NC),i&&(i=L(i,PC),i)))))))for(let t=0;t<i.length;t++){const s=i[t];if(y.indices.push(N),n?(s.localPositionOverride?(y.positions[3*N]=s.localPositionOverride[0],y.positions[3*N+1]=s.localPositionOverride[1],y.positions[3*N+2]=s.localPositionOverride[2]):c&&(y.positions[3*N]=c[s.vertexIdx],y.positions[3*N+1]=c[s.vertexIdx+1],y.positions[3*N+2]=c[s.vertexIdx+2]),s.localNormalOverride?(y.normals[3*N]=s.localNormalOverride[0],y.normals[3*N+1]=s.localNormalOverride[1],y.normals[3*N+2]=s.localNormalOverride[2]):u&&(y.normals[3*N]=u[s.vertexIdx],y.normals[3*N+1]=u[s.vertexIdx+1],y.normals[3*N+2]=u[s.vertexIdx+2])):(s.position.toArray(y.positions,3*N),s.normal.toArray(y.normals,3*N)),y.matricesIndices&&y.matricesWeights&&(s.matrixIndicesOverride?(y.matricesIndices[4*N]=s.matrixIndicesOverride[0],y.matricesIndices[4*N+1]=s.matrixIndicesOverride[1],y.matricesIndices[4*N+2]=s.matrixIndicesOverride[2],y.matricesIndices[4*N+3]=s.matrixIndicesOverride[3]):(d&&(y.matricesIndices[4*N]=d[s.vertexIdxForBones],y.matricesIndices[4*N+1]=d[s.vertexIdxForBones+1],y.matricesIndices[4*N+2]=d[s.vertexIdxForBones+2],y.matricesIndices[4*N+3]=d[s.vertexIdxForBones+3]),m&&y.matricesIndicesExtra&&(y.matricesIndicesExtra[4*N]=m[s.vertexIdxForBones],y.matricesIndicesExtra[4*N+1]=m[s.vertexIdxForBones+1],y.matricesIndicesExtra[4*N+2]=m[s.vertexIdxForBones+2],y.matricesIndicesExtra[4*N+3]=m[s.vertexIdxForBones+3])),s.matrixWeightsOverride?(y.matricesWeights[4*N]=s.matrixWeightsOverride[0],y.matricesWeights[4*N+1]=s.matrixWeightsOverride[1],y.matricesWeights[4*N+2]=s.matrixWeightsOverride[2],y.matricesWeights[4*N+3]=s.matrixWeightsOverride[3]):(p&&(y.matricesWeights[4*N]=p[s.vertexIdxForBones],y.matricesWeights[4*N+1]=p[s.vertexIdxForBones+1],y.matricesWeights[4*N+2]=p[s.vertexIdxForBones+2],y.matricesWeights[4*N+3]=p[s.vertexIdxForBones+3]),v&&y.matricesWeightsExtra&&(y.matricesWeightsExtra[4*N]=v[s.vertexIdxForBones],y.matricesWeightsExtra[4*N+1]=v[s.vertexIdxForBones+1],y.matricesWeightsExtra[4*N+2]=v[s.vertexIdxForBones+2],y.matricesWeightsExtra[4*N+3]=v[s.vertexIdxForBones+3]))),e.captureUVS)s.uv.toArray(y.uvs,2*N);else{y.uvs.push(.5+s.position.x/E.x);const t=.5+s.position.y/E.y;y.uvs.push(As.UseOpenGLOrientationForUV?1-t:t)}N++}}const F=new Ys(t,i.getScene());return y.applyToMesh(F),n?(F.skeleton=i.skeleton,F.parent=i):(F.position=g.clone(),F.rotation=new w(I,x,A)),F.computeWorldMatrix(!0),F.refreshBoundingInfo(!0,!0),F}Ys.CreateDecal=(t,i,e,s,n,r)=>LC(t,i,{position:e,normal:s,size:n,angle:r});class OC{constructor(t=0,i=0){this.x=t,this.y=i,t!==Math.floor(t)&&(Math.floor(t),F.Warn("x is not an integer, floor(x) used")),i!==Math.floor(i)&&(Math.floor(i),F.Warn("y is not an integer, floor(y) used"))}clone(){return new OC(this.x,this.y)}rotate60About(t){const i=this.x;return this.x=t.x+t.y-this.y,this.y=i+this.y-t.x,this}rotateNeg60About(t){const i=this.x;return this.x=i+this.y-t.y,this.y=t.x+t.y-i,this}rotate120(t,i){t!==Math.floor(t)&&(Math.floor(t),F.Warn("m not an integer only floor(m) used")),i!==Math.floor(i)&&(Math.floor(i),F.Warn("n not an integer only floor(n) used"));const e=this.x;return this.x=t-e-this.y,this.y=i+e,this}rotateNeg120(t,i){t!==Math.floor(t)&&(Math.floor(t),F.Warn("m is not an integer, floor(m) used")),i!==Math.floor(i)&&(Math.floor(i),F.Warn("n is not an integer,   floor(n) used"));const e=this.x;return this.x=this.y-i,this.y=t+i-e-this.y,this}toCartesianOrigin(t,i){const e=w.Zero();return e.x=t.x+2*this.x*i+this.y*i,e.y=t.y+Math.sqrt(3)*this.y*i,e}static Zero(){return new OC(0,0)}}class FC{constructor(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new BC("icosahedron","Regular",[[0,c,-1],[-c,1,0],[-1,0,-c],[1,0,-c],[c,1,0],[0,c,1],[-1,0,c],[-c,-1,0],[0,-c,-1],[c,-1,0],[1,0,c],[0,-c,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}setIndices(){let t=12;const i={},e=this.m,s=this.n;let n,r,h,a,l,c=e,u=1,f=0;0!==s&&(c=o.HCF(e,s)),u=e/c,f=s/c;const d=OC.Zero(),p=new OC(e,s),m=new OC(-s,e+s),v=OC.Zero(),g=OC.Zero(),S=OC.Zero();let E,A,C,w,x=[];const T=[],R=this.vertByDist,I=(e,s,n,r)=>{E=e+"|"+n,A=s+"|"+r,E in i||A in i?E in i&&!(A in i)?i[A]=i[E]:A in i&&!(E in i)&&(i[E]=i[A]):(i[E]=t,i[A]=t,t++),R[n][0]>2?T[i[E]]=[-R[n][0],R[n][1],i[E]]:T[i[E]]=[x[R[n][0]],R[n][1],i[E]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(let o=0;o<20;o++){if(x=this.IDATA.face[o],h=x[2],a=x[1],l=x[0],C=d.x+"|"+d.y,E=o+"|"+C,E in i||(i[E]=h,T[h]=[x[R[C][0]],R[C][1]]),C=p.x+"|"+p.y,E=o+"|"+C,E in i||(i[E]=a,T[a]=[x[R[C][0]],R[C][1]]),C=m.x+"|"+m.y,E=o+"|"+C,E in i||(i[E]=l,T[l]=[x[R[C][0]],R[C][1]]),n=this.IDATA.edgematch[o][0],r=this.IDATA.edgematch[o][1],"B"===r)for(let t=1;t<c;t++)g.x=e-t*(u+f),g.y=s+t*u,S.x=-t*f,S.y=t*(u+f),C=g.x+"|"+g.y,w=S.x+"|"+S.y,I(o,n,C,w);if("O"===r)for(let t=1;t<c;t++)S.x=-t*f,S.y=t*(u+f),v.x=t*u,v.y=t*f,C=S.x+"|"+S.y,w=v.x+"|"+v.y,I(o,n,C,w);if(n=this.IDATA.edgematch[o][2],r=this.IDATA.edgematch[o][3],r&&"A"===r)for(let t=1;t<c;t++)v.x=t*u,v.y=t*f,g.x=e-(c-t)*(u+f),g.y=s+(c-t)*u,C=v.x+"|"+v.y,w=g.x+"|"+g.y,I(o,n,C,w);for(let e=0;e<this.vertices.length;e++)C=this.vertices[e].x+"|"+this.vertices[e].y,E=o+"|"+C,E in i||(i[E]=t++,R[C][0]>2?T[i[E]]=[-R[C][0],R[C][1],i[E]]:T[i[E]]=[x[R[C][0]],R[C][1],i[E]])}this.closestTo=T,this.vecToidx=i}calcCoeffs(){const t=this.m,i=this.n,e=Math.sqrt(3)/3,s=t*t+i*i+t*i;this.coau=(t+i)/s,this.cobu=-i/s,this.coav=-e*(t-i)/s,this.cobv=e*(2*t+i)/s}createInnerFacets(){const t=this.m,i=this.n;for(let e=0;e<i+t+1;e++)for(let t=this.min[e];t<this.max[e]+1;t++)t<this.max[e]&&t<this.max[e+1]+1&&this.innerFacets.push(["|"+t+"|"+e,"|"+t+"|"+(e+1),"|"+(t+1)+"|"+e]),e>0&&t<this.max[e-1]&&t+1<this.max[e]+1&&this.innerFacets.push(["|"+t+"|"+e,"|"+(t+1)+"|"+e,"|"+(t+1)+"|"+(e-1)])}edgeVecsABOB(){const t=this.m,i=this.n,e=new OC(-i,t+i);for(let s=1;s<t+i;s++){const t=new OC(this.min[s],s),i=new OC(this.min[s-1],s-1),n=new OC(this.min[s+1],s+1),r=t.clone(),h=i.clone(),o=n.clone();r.rotate60About(e),h.rotate60About(e),o.rotate60About(e);const a=new OC(this.max[r.y],r.y),l=new OC(this.max[r.y-1],r.y-1),c=new OC(this.max[r.y-1]-1,r.y-1);r.x===a.x&&r.y===a.y||(r.x!==l.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([t,l,c]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([t,c,a])):r.y===o.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([t,i,l]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([t,l,n])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([t,i,l]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([t,l,a])))}}mapABOBtoOBOA(){const t=new OC(0,0);for(let i=0;i<this.isoVecsABOB.length;i++){const e=[];for(let s=0;s<3;s++)t.x=this.isoVecsABOB[i][s].x,t.y=this.isoVecsABOB[i][s].y,0===this.vertexTypes[i][s]&&t.rotateNeg120(this.m,this.n),e.push(t.clone());this.isoVecsOBOA.push(e)}}mapABOBtoBAOA(){const t=new OC(0,0);for(let i=0;i<this.isoVecsABOB.length;i++){const e=[];for(let s=0;s<3;s++)t.x=this.isoVecsABOB[i][s].x,t.y=this.isoVecsABOB[i][s].y,1===this.vertexTypes[i][s]&&t.rotate120(this.m,this.n),e.push(t.clone());this.isoVecsBAOA.push(e)}}MapToFace(t,i){const e=this.IDATA.face[t],s=e[2],n=e[1],r=e[0],h=w.FromArray(this.IDATA.vertex[s]),o=w.FromArray(this.IDATA.vertex[n]),a=w.FromArray(this.IDATA.vertex[r]),l=o.subtract(h),c=a.subtract(h),u=l.scale(this.coau).add(c.scale(this.cobu)),f=l.scale(this.coav).add(c.scale(this.cobv)),d=[];let p,m=M.Vector3[0];for(let e=0;e<this.cartesian.length;e++)m=u.scale(this.cartesian[e].x).add(f.scale(this.cartesian[e].y)).add(h),d[e]=[m.x,m.y,m.z],p=t+"|"+this.vertices[e].x+"|"+this.vertices[e].y,i.vertex[this.vecToidx[p]]=[m.x,m.y,m.z]}build(t,i){const e=new Array,s=OC.Zero(),n=new OC(t,i),r=new OC(-i,t+i);e.push(s,n,r);for(let s=i;s<t+1;s++)for(let i=0;i<t+1-s;i++)e.push(new OC(i,s));if(i>0){const s=o.HCF(t,i),n=t/s,r=i/s;for(let h=1;h<s;h++)e.push(new OC(h*n,h*r)),e.push(new OC(-h*r,h*(n+r))),e.push(new OC(t-h*(n+r),i+h*n));const h=t/i;for(let s=1;s<i;s++)for(let n=0;n<s*h;n++)e.push(new OC(n,s)),e.push(new OC(n,s).rotate120(t,i)),e.push(new OC(n,s).rotateNeg120(t,i))}e.sort(((t,i)=>t.x-i.x)),e.sort(((t,i)=>t.y-i.y));const h=new Array(t+i+1),a=new Array(t+i+1);for(let t=0;t<h.length;t++)h[t]=1/0,a[t]=-1/0;let l=0,c=0;const u=e.length;for(let t=0;t<u;t++)c=e[t].x,l=e[t].y,h[l]=Math.min(c,h[l]),a[l]=Math.max(c,a[l]);const f=(e,s)=>{const n=e.clone();return"A"===s&&n.rotateNeg120(t,i),"B"===s&&n.rotate120(t,i),n.x<0?n.y:n.x+n.y},d=[],p=[],m=[],v=[],g={},S=[];let E=-1,A=-1;for(let t=0;t<u;t++)d[t]=e[t].toCartesianOrigin(new OC(0,0),.5),p[t]=f(e[t],"O"),m[t]=f(e[t],"A"),v[t]=f(e[t],"B"),p[t]===m[t]&&m[t]===v[t]?(E=3,A=p[t]):p[t]===m[t]?(E=4,A=p[t]):m[t]===v[t]?(E=5,A=m[t]):v[t]===p[t]&&(E=6,A=p[t]),p[t]<m[t]&&p[t]<v[t]&&(E=2,A=p[t]),m[t]<p[t]&&m[t]<v[t]&&(E=1,A=m[t]),v[t]<m[t]&&v[t]<p[t]&&(E=0,A=v[t]),S.push([E,A,e[t].x,e[t].y]);S.sort(((t,i)=>t[2]-i[2])),S.sort(((t,i)=>t[3]-i[3])),S.sort(((t,i)=>t[1]-i[1])),S.sort(((t,i)=>t[0]-i[0]));for(let t=0;t<S.length;t++)g[S[t][2]+"|"+S[t][3]]=[S[t][0],S[t][1],t];return this.m=t,this.n=i,this.vertices=e,this.vertByDist=g,this.cartesian=d,this.min=h,this.max=a,this}}class BC{constructor(t,i,e,s){this.name=t,this.category=i,this.vertex=e,this.face=s}}class UC extends BC{innerToData(t,i){for(let e=0;e<i.innerFacets.length;e++)this.face.push(i.innerFacets[e].map((e=>i.vecToidx[t+e])))}mapABOBtoDATA(t,i){const e=i.IDATA.edgematch[t][0];for(let s=0;s<i.isoVecsABOB.length;s++){const n=[];for(let r=0;r<3;r++)0===i.vertexTypes[s][r]?n.push(t+"|"+i.isoVecsABOB[s][r].x+"|"+i.isoVecsABOB[s][r].y):n.push(e+"|"+i.isoVecsABOB[s][r].x+"|"+i.isoVecsABOB[s][r].y);this.face.push([i.vecToidx[n[0]],i.vecToidx[n[1]],i.vecToidx[n[2]]])}}mapOBOAtoDATA(t,i){const e=i.IDATA.edgematch[t][0];for(let s=0;s<i.isoVecsOBOA.length;s++){const n=[];for(let r=0;r<3;r++)1===i.vertexTypes[s][r]?n.push(t+"|"+i.isoVecsOBOA[s][r].x+"|"+i.isoVecsOBOA[s][r].y):n.push(e+"|"+i.isoVecsOBOA[s][r].x+"|"+i.isoVecsOBOA[s][r].y);this.face.push([i.vecToidx[n[0]],i.vecToidx[n[1]],i.vecToidx[n[2]]])}}mapBAOAtoDATA(t,i){const e=i.IDATA.edgematch[t][2];for(let s=0;s<i.isoVecsBAOA.length;s++){const n=[];for(let r=0;r<3;r++)1===i.vertexTypes[s][r]?n.push(t+"|"+i.isoVecsBAOA[s][r].x+"|"+i.isoVecsBAOA[s][r].y):n.push(e+"|"+i.isoVecsBAOA[s][r].x+"|"+i.isoVecsBAOA[s][r].y);this.face.push([i.vecToidx[n[0]],i.vecToidx[n[1]],i.vecToidx[n[2]]])}}orderData(t){const i=[];for(let t=0;t<13;t++)i[t]=[];const e=t.closestTo;for(let t=0;t<e.length;t++)e[t][0]>-1?e[t][1]>0&&i[e[t][0]].push([t,e[t][1]]):i[12].push([t,e[t][0]]);const s=[];for(let t=0;t<12;t++)s[t]=t;let n=12;for(let t=0;t<12;t++){i[t].sort(((t,i)=>t[1]-i[1]));for(let e=0;e<i[t].length;e++)s[i[t][e][0]]=n++}for(let t=0;t<i[12].length;t++)s[i[12][t][0]]=n++;for(let t=0;t<this.vertex.length;t++)this.vertex[t].push(s[t]);this.vertex.sort(((t,i)=>t[3]-i[3]));for(let t=0;t<this.vertex.length;t++)this.vertex[t].pop();for(let t=0;t<this.face.length;t++)for(let i=0;i<this.face[t].length;i++)this.face[t][i]=s[this.face[t][i]];this.sharedNodes=i[12].length,this.poleNodes=this.vertex.length-this.sharedNodes}setOrder(t,i){const e=[],s=[];let n=i.pop();s.push(n);let r=this.face[n].indexOf(t);r=(r+2)%3;let h=this.face[n][r];e.push(h);let o=0;for(;i.length>0;)n=i[o],this.face[n].indexOf(h)>-1?(r=(this.face[n].indexOf(h)+1)%3,h=this.face[n][r],e.push(h),s.push(n),i.splice(o,1),o=0):o++;return this.adjacentFaces.push(e),s}toGoldbergPolyhedronData(){const t=new BC("GeoDual","Goldberg",[],[]);t.name="GD dual";const i=this.vertex.length,e=new Array(i);for(let t=0;t<i;t++)e[t]=[];for(let t=0;t<this.face.length;t++)for(let i=0;i<3;i++)e[this.face[t][i]].push(t);let s=0,n=0,r=0,h=[],o=[];this.adjacentFaces=[];for(let i=0;i<e.length;i++)t.face[i]=this.setOrder(i,e[i].concat([])),e[i].forEach((i=>{s=0,n=0,r=0,h=this.face[i];for(let t=0;t<3;t++)o=this.vertex[h[t]],s+=o[0],n+=o[1],r+=o[2];t.vertex[i]=[s/3,n/3,r/3]}));return t}static BuildGeodesicData(t){const i=new UC("Geodesic-m-n","Geodesic",[[0,c,-1],[-c,1,0],[-1,0,-c],[1,0,-c],[c,1,0],[0,c,1],[-1,0,c],[-c,-1,0],[0,-c,-1],[c,-1,0],[1,0,c],[0,-c,1]],[]);t.setIndices(),t.calcCoeffs(),t.createInnerFacets(),t.edgeVecsABOB(),t.mapABOBtoOBOA(),t.mapABOBtoBAOA();for(let e=0;e<t.IDATA.face.length;e++)t.MapToFace(e,i),i.innerToData(e,t),"B"===t.IDATA.edgematch[e][1]&&i.mapABOBtoDATA(e,t),"O"===t.IDATA.edgematch[e][1]&&i.mapOBOAtoDATA(e,t),"A"===t.IDATA.edgematch[e][3]&&i.mapBAOAtoDATA(e,t);i.orderData(t);return i.vertex=i.vertex.map((function(t){const i=t[0],e=t[1],s=t[2],n=Math.sqrt(i*i+e*e+s*s);return t[0]*=1/n,t[1]*=1/n,t[2]*=1/n,t})),i}}function VC(t,i,e=null){const s=i.size,n=i.sizeX||s||1,r=i.sizeY||s||1,h=i.sizeZ||s||1;let o=i.m||1;o!==Math.floor(o)&&(Math.floor(o),F.Warn("m not an integer only floor(m) used"));let a=i.n||0;if(a!==Math.floor(a)&&(Math.floor(a),F.Warn("n not an integer only floor(n) used")),a>o){const t=a;a=o,o=t,F.Warn("n > m therefore m and n swapped")}const l=new FC;l.build(o,a);const c=UC.BuildGeodesicData(l),u=c.toGoldbergPolyhedronData(),f=new pC(t,e);i.sideOrientation=Ys.OI(i.sideOrientation),f.yI=i.sideOrientation;const d=function(t,i){const e=t.size,s=t.sizeX||e||1,n=t.sizeY||e||1,r=t.sizeZ||e||1,h=0===t.sideOrientation?0:t.sideOrientation||os.DEFAULTSIDE,o=new Array,a=new Array,l=new Array,c=new Array;let u=1/0,f=-1/0,d=1/0,p=-1/0;for(let t=0;t<i.vertex.length;t++)u=Math.min(u,i.vertex[t][0]*s),f=Math.max(f,i.vertex[t][0]*s),d=Math.min(d,i.vertex[t][1]*n),p=Math.max(p,i.vertex[t][1]*n);let m=0;for(let t=0;t<i.face.length;t++){const e=i.face[t],h=w.FromArray(i.vertex[e[0]]),v=w.FromArray(i.vertex[e[2]]),g=w.FromArray(i.vertex[e[1]]),S=v.subtract(h),E=g.subtract(h),A=w.Cross(E,S).normalize();for(let t=0;t<e.length;t++){l.push(A.x,A.y,A.z);const h=i.vertex[e[t]];o.push(h[0]*s,h[1]*n,h[2]*r);const a=(h[1]*n-d)/(p-d);c.push((h[0]*s-u)/(f-u),As.UseOpenGLOrientationForUV?1-a:a)}for(let t=0;t<e.length-2;t++)a.push(m,m+t+2,m+t+1);m+=e.length}os.JA(h,o,a,l,c);const v=new os;return v.positions=o,v.indices=a,v.normals=l,v.uvs=c,v}(i,u);d.applyToMesh(f,i.updatable),f.goldbergData.nbSharedFaces=c.sharedNodes,f.goldbergData.nbUnsharedFaces=c.poleNodes,f.goldbergData.adjacentFaces=c.adjacentFaces,f.goldbergData.nbFaces=f.goldbergData.nbSharedFaces+f.goldbergData.nbUnsharedFaces,f.goldbergData.nbFacesAtPole=(f.goldbergData.nbUnsharedFaces-12)/12;for(let t=0;t<c.vertex.length;t++)f.goldbergData.faceCenters.push(w.FromArray(c.vertex[t])),f.goldbergData.faceCenters[t].x*=n,f.goldbergData.faceCenters[t].y*=r,f.goldbergData.faceCenters[t].z*=h,f.goldbergData.faceColors.push(new y(1,1,1,1));for(let t=0;t<u.face.length;t++){const i=u.face[t],e=w.FromArray(u.vertex[i[0]]),s=w.FromArray(u.vertex[i[2]]),n=w.FromArray(u.vertex[i[1]]),r=s.subtract(e),h=n.subtract(e),o=w.Cross(h,r).normalize(),a=w.Cross(h,o).normalize();f.goldbergData.faceXaxis.push(h.normalize()),f.goldbergData.faceYaxis.push(o),f.goldbergData.faceZaxis.push(a)}return f}Ys.CreateGoldberg=VC;class kC{constructor(){this.running=!1,this.Yot=[]}addTask(t){this.Yot.push(t)}executeNext(){const t=this.Yot.pop();t?(this.running=!0,this.runSimplification(t)):this.running=!1}runSimplification(t){if(t.parallelProcessing)t.settings.forEach((i=>{this.jot(t).simplify(i,(e=>{void 0!==i.distance&&t.mesh.addLODLevel(i.distance,e),e.isVisible=!0,i.quality===t.settings[t.settings.length-1].quality&&t.successCallback&&t.successCallback(),this.executeNext()}))}));else{const i=this.jot(t),e=(e,s)=>{i.simplify(e,(i=>{void 0!==e.distance&&t.mesh.addLODLevel(e.distance,i),i.isVisible=!0,s()}))};Gi.Run(t.settings.length,(i=>{e(t.settings[i.index],(()=>{i.executeNext()}))}),(()=>{t.successCallback&&t.successCallback(),this.executeNext()}))}}jot(t){return t.simplificationType,GC.QUADRATIC,new $C(t.mesh)}}var GC;!function(t){t[t.QUADRATIC=0]="QUADRATIC"}(GC||(GC={}));class zC{constructor(t){this.Kot=t,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class HC{constructor(t,i){this.position=t,this.id=i,this.isBorder=!0,this.q=new XC,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(t){this.position.copyFrom(t)}}class XC{constructor(t){this.data=new Array(10);for(let i=0;i<10;++i)t&&t[i]?this.data[i]=t[i]:this.data[i]=0}det(t,i,e,s,n,r,h,o,a){return this.data[t]*this.data[n]*this.data[a]+this.data[e]*this.data[s]*this.data[o]+this.data[i]*this.data[r]*this.data[h]-this.data[e]*this.data[n]*this.data[h]-this.data[t]*this.data[r]*this.data[o]-this.data[i]*this.data[s]*this.data[a]}addInPlace(t){for(let i=0;i<10;++i)this.data[i]+=t.data[i]}addArrayInPlace(t){for(let i=0;i<10;++i)this.data[i]+=t[i]}add(t){const i=new XC;for(let e=0;e<10;++e)i.data[e]=this.data[e]+t.data[e];return i}static FromData(t,i,e,s){return new XC(XC.DataFromNumbers(t,i,e,s))}static DataFromNumbers(t,i,e,s){return[t*t,t*i,t*e,t*s,i*i,i*e,i*s,e*e,e*s,s*s]}}class WC{constructor(t,i){this.vertexId=t,this.triangleId=i}}class $C{constructor(t){this.fC=t,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=u}simplify(t,i){this.qot(),Gi.Run(this.fC.subMeshes.length,(i=>{this.Qot(i.index,(()=>{this.Zot(t,i.index,(()=>{i.executeNext()}))}),t.optimizeMesh)}),(()=>{setTimeout((()=>{i(this.Jot)}),0)}))}Zot(t,i,e){const s=~~(this.tat.length*t.quality);let n=0;const r=this.tat.length,h=(t,i)=>{setTimeout((()=>{t%5==0&&this.iat(0===t);for(let t=0;t<this.tat.length;++t)this.tat[t].isDirty=!1;const e=1e-9*Math.pow(t+3,this.aggressiveness);Gi.SyncAsyncForLoop(this.tat.length,this.syncIterations,(t=>{const i=~~((this.tat.length/2+t)%this.tat.length),s=this.tat[i];if(s&&!(s.error[3]>e||s.deleted||s.isDirty))for(let t=0;t<3;++t)if(s.error[t]<e){const i=[],e=[],r=s.Kot[t],h=s.Kot[(t+1)%3];if(r.isBorder||h.isBorder)continue;const o=w.Zero();this.eat(r,h,o);const a=new Array;if(this.sat(r,h,o,i,a))continue;if(this.sat(h,r,o,e,a))continue;if(i.indexOf(!0)<0||e.indexOf(!0)<0)continue;const l=new Array;if(a.forEach((t=>{-1===l.indexOf(t)&&(t.deletePending=!0,l.push(t))})),l.length%2!=0)continue;r.q=h.q.add(r.q),r.updatePosition(o);const c=this.Cr.length;n=this.nat(r,r,i,n),n=this.nat(r,h,e,n);const u=this.Cr.length-c;if(u<=r.triangleCount){if(u)for(let t=0;t<u;t++)this.Cr[r.triangleStart+t]=this.Cr[c+t]}else r.triangleStart=c;r.triangleCount=u;break}}),i,(()=>r-n<=s))}),0)};Gi.Run(this.decimationIterations,(t=>{r-n<=s?t.breakLoop():h(t.index,(()=>{t.executeNext()}))}),(()=>{setTimeout((()=>{this.rat(i),e()}),0)}))}Qot(t,i,e){this.Kot=[],this.tat=[];const s=this.fC.getVerticesData(he.PositionKind),n=this.fC.getIndices(),r=this.fC.subMeshes[t],h=t=>{if(e)for(let i=0;i<this.Kot.length;++i)if(this.Kot[i].position.equalsWithEpsilon(t,1e-4))return this.Kot[i];return null},o=[],a=r.verticesCount;Gi.SyncAsyncForLoop(a,this.syncIterations/4>>0,(t=>{if(!s)return;const i=t+r.verticesStart,e=w.FromArray(s,3*i),n=h(e)||new HC(e,this.Kot.length);n.originalOffsets.push(i),n.id===this.Kot.length&&this.Kot.push(n),o.push(n.id)}),(()=>{Gi.SyncAsyncForLoop(r.indexCount/3,this.syncIterations,(t=>{if(!n)return;const i=3*(r.indexStart/3+t),e=n[i+0],s=n[i+1],h=n[i+2],a=this.Kot[o[e-r.verticesStart]],l=this.Kot[o[s-r.verticesStart]],c=this.Kot[o[h-r.verticesStart]],u=new zC([a,l,c]);u.originalOffset=i,this.tat.push(u)}),(()=>{this.YN(i)}))}))}YN(t){Gi.SyncAsyncForLoop(this.tat.length,this.syncIterations,(t=>{const i=this.tat[t];i.normal=w.Cross(i.Kot[1].position.subtract(i.Kot[0].position),i.Kot[2].position.subtract(i.Kot[0].position)).normalize();for(let t=0;t<3;t++)i.Kot[t].q.addArrayInPlace(XC.DataFromNumbers(i.normal.x,i.normal.y,i.normal.z,-w.Dot(i.normal,i.Kot[0].position)))}),(()=>{Gi.SyncAsyncForLoop(this.tat.length,this.syncIterations,(t=>{const i=this.tat[t];for(let t=0;t<3;++t)i.error[t]=this.eat(i.Kot[t],i.Kot[(t+1)%3]);i.error[3]=Math.min(i.error[0],i.error[1],i.error[2])}),(()=>{t()}))}))}rat(t){const i=[];let e,s,n;for(e=0;e<this.Kot.length;++e)this.Kot[e].triangleCount=0;for(e=0;e<this.tat.length;++e)if(!this.tat[e].deleted){for(s=this.tat[e],n=0;n<3;++n)s.Kot[n].triangleCount=1;i.push(s)}const r=this.Jot.getVerticesData(he.PositionKind)||[],h=this.Jot.getVerticesData(he.NormalKind)||[],o=this.Jot.getVerticesData(he.UVKind)||[],a=this.Jot.getVerticesData(he.ColorKind)||[],l=this.fC.getVerticesData(he.NormalKind),c=this.fC.getVerticesData(he.UVKind),u=this.fC.getVerticesData(he.ColorKind);let f=0;for(e=0;e<this.Kot.length;++e){const t=this.Kot[e];t.id=f,t.triangleCount&&t.originalOffsets.forEach((i=>{r.push(t.position.x),r.push(t.position.y),r.push(t.position.z),l&&l.length&&(h.push(l[3*i]),h.push(l[3*i+1]),h.push(l[3*i+2])),c&&c.length&&(o.push(c[2*i]),o.push(c[2*i+1])),u&&u.length&&(a.push(u[4*i]),a.push(u[4*i+1]),a.push(u[4*i+2]),a.push(u[4*i+3])),++f}))}const d=this.Jot.getTotalIndices(),p=this.Jot.getTotalVertices(),m=this.Jot.subMeshes;this.Jot.subMeshes=[];const v=this.Jot.getIndices(),g=this.fC.getIndices();for(e=0;e<i.length;++e)s=i[e],[0,1,2].forEach((t=>{const i=g[s.originalOffset+t];let e=s.Kot[t].originalOffsets.indexOf(i);e<0&&(e=0),v.push(s.Kot[t].id+e+p)}));this.Jot.setIndices(v),this.Jot.setVerticesData(he.PositionKind,r),h.length>0&&this.Jot.setVerticesData(he.NormalKind,h),o.length>0&&this.Jot.setVerticesData(he.UVKind,o),a.length>0&&this.Jot.setVerticesData(he.ColorKind,a);const S=this.fC.subMeshes[t];t>0&&(this.Jot.subMeshes=[],m.forEach((t=>{Ss.AddToMesh(t.materialIndex,t.verticesStart,t.verticesCount,t.indexStart,t.indexCount,t.getMesh())})),Ss.AddToMesh(S.materialIndex,p,f,d,3*i.length,this.Jot))}qot(){this.Jot=new Ys(this.fC.name+"Decimated",this.fC.getScene()),this.Jot.material=this.fC.material,this.Jot.parent=this.fC.parent,this.Jot.isVisible=!1,this.Jot.renderingGroupId=this.fC.renderingGroupId}sat(t,i,e,s,n){for(let r=0;r<t.triangleCount;++r){const h=this.tat[this.Cr[t.triangleStart+r].triangleId];if(h.deleted)continue;const o=this.Cr[t.triangleStart+r].vertexId,a=h.Kot[(o+1)%3],l=h.Kot[(o+2)%3];if(a===i||l===i){s[r]=!0,n.push(h);continue}let c=a.position.subtract(e);c=c.normalize();let u=l.position.subtract(e);if(u=u.normalize(),Math.abs(w.Dot(c,u))>.999)return!0;const f=w.Cross(c,u).normalize();if(s[r]=!1,w.Dot(f,h.normal)<.2)return!0}return!1}nat(t,i,e,s){let n=s;for(let s=0;s<i.triangleCount;++s){const r=this.Cr[i.triangleStart+s],h=this.tat[r.triangleId];h.deleted||(e[s]&&h.deletePending?(h.deleted=!0,n++):(h.Kot[r.vertexId]=t,h.isDirty=!0,h.error[0]=this.eat(h.Kot[0],h.Kot[1])+h.borderFactor/2,h.error[1]=this.eat(h.Kot[1],h.Kot[2])+h.borderFactor/2,h.error[2]=this.eat(h.Kot[2],h.Kot[0])+h.borderFactor/2,h.error[3]=Math.min(h.error[0],h.error[1],h.error[2]),this.Cr.push(r)))}return n}hat(){for(let t=0;t<this.Kot.length;++t){const i=[],e=[],s=this.Kot[t];let n;for(n=0;n<s.triangleCount;++n){const t=this.tat[this.Cr[s.triangleStart+n].triangleId];for(let s=0;s<3;s++){let n=0;const r=t.Kot[s];for(;n<i.length&&e[n]!==r.id;)++n;n===i.length?(i.push(1),e.push(r.id)):i[n]++}}for(n=0;n<i.length;++n)1===i[n]?this.Kot[e[n]].isBorder=!0:this.Kot[e[n]].isBorder=!1}}iat(t=!1){let i,e,s,n;if(!t){const t=[];for(i=0;i<this.tat.length;++i)this.tat[i].deleted||t.push(this.tat[i]);this.tat=t}for(i=0;i<this.Kot.length;++i)this.Kot[i].triangleCount=0,this.Kot[i].triangleStart=0;for(i=0;i<this.tat.length;++i)for(e=this.tat[i],s=0;s<3;++s)n=e.Kot[s],n.triangleCount++;let r=0;for(i=0;i<this.Kot.length;++i)this.Kot[i].triangleStart=r,r+=this.Kot[i].triangleCount,this.Kot[i].triangleCount=0;const h=new Array(3*this.tat.length);for(i=0;i<this.tat.length;++i)for(e=this.tat[i],s=0;s<3;++s)n=e.Kot[s],h[n.triangleStart+n.triangleCount]=new WC(s,i),n.triangleCount++;this.Cr=h,t&&this.hat()}oat(t,i){const e=i.x,s=i.y,n=i.z;return t.data[0]*e*e+2*t.data[1]*e*s+2*t.data[2]*e*n+2*t.data[3]*e+t.data[4]*s*s+2*t.data[5]*s*n+2*t.data[6]*s+t.data[7]*n*n+2*t.data[8]*n+t.data[9]}eat(t,i,e){const s=t.q.add(i.q),n=t.isBorder&&i.isBorder;let r=0;const h=s.det(0,1,2,1,4,5,2,5,7);if(0===h||n){const n=t.position.add(i.position).divide(new w(2,2,2)),h=this.oat(s,t.position),o=this.oat(s,i.position),a=this.oat(s,n);r=Math.min(h,o,a),r===h?e&&e.copyFrom(t.position):r===o?e&&e.copyFrom(i.position):e&&e.copyFrom(n)}else e||(e=w.Zero()),e.x=-1/h*s.det(1,2,3,4,5,6,5,7,8),e.y=1/h*s.det(0,2,3,1,5,6,2,7,8),e.z=-1/h*s.det(0,1,3,1,4,6,2,5,8),r=this.oat(s,e);return r}}Object.defineProperty(ke.prototype,"simplificationQueue",{get:function(){if(!this.aat){this.aat=new kC;let t=this.Mg(fe.NAME_SIMPLIFICATIONQUEUE);t||(t=new YC(this),this.Ig(t))}return this.aat},set:function(t){this.aat=t},enumerable:!0,configurable:!0}),Ys.prototype.simplify=function(t,i=!0,e=GC.QUADRATIC,s){return this.getScene().simplificationQueue.addTask({settings:t,parallelProcessing:i,mesh:this,simplificationType:e,successCallback:s}),this};class YC{constructor(t){this.name=fe.NAME_SIMPLIFICATIONQUEUE,this.scene=t}register(){this.scene.Vv.registerStep(fe.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this.Gz)}rebuild(){}dispose(){}Gz(){this.scene.aat&&!this.scene.aat.running&&this.scene.aat.executeNext()}}Ys.prototype.thinInstanceAdd=function(t,i=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return F.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this.lat("matrix",Array.isArray(t)?t.length:1);const e=this._I.instancesCount;if(Array.isArray(t))for(let e=0;e<t.length;++e)this.thinInstanceSetMatrixAt(this._I.instancesCount++,t[e],e===t.length-1&&i);else this.thinInstanceSetMatrixAt(this._I.instancesCount++,t,i);return e},Ys.prototype.thinInstanceAddSelf=function(t=!0){return this.thinInstanceAdd(R.IdentityReadOnly,t)},Ys.prototype.thinInstanceRegisterAttribute=function(t,i){t===he.ColorKind&&(t=he.ColorInstanceKind),this.removeVerticesData(t),this.cat(),this.uM.strides[t]=i,this.uM.sizes[t]=i*Math.max(32,this._I.instancesCount),this.uM.data[t]=new Float32Array(this.uM.sizes[t]),this.uM.vertexBuffers[t]=new he(this.getEngine(),this.uM.data[t],t,!0,!1,i,!0),this.setVerticesBuffer(this.uM.vertexBuffers[t])},Ys.prototype.thinInstanceSetMatrixAt=function(t,i,e=!0){if(!this._I.matrixData||t>=this._I.instancesCount)return!1;const s=this._I.matrixData;return i.copyToArray(s,16*t),this._I.worldMatrices&&(this._I.worldMatrices[t]=i),e&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0},Ys.prototype.thinInstanceSetAttributeAt=function(t,i,e,s=!0){return t===he.ColorKind&&(t=he.ColorInstanceKind),!(!this.uM||!this.uM.data[t]||i>=this._I.instancesCount)&&(this.lat(t,0),this.uM.data[t].set(e,i*this.uM.strides[t]),s&&this.thinInstanceBufferUpdated(t),!0)},Object.defineProperty(Ys.prototype,"thinInstanceCount",{get:function(){return this._I.instancesCount},set:function(t){var i,e;const s=null!==(i=this._I.matrixData)&&void 0!==i?i:null===(e=this.source)||void 0===e?void 0:e._I.matrixData;t<=(s?s.length/16:0)&&(this._I.instancesCount=t)},enumerable:!0,configurable:!0}),Ys.prototype.iM=function(t,i,e=!1){t===he.ColorKind&&(t=he.ColorInstanceKind);const s=new re(this.getEngine(),i,!e,16,!1,!0);for(let i=0;i<4;i++)this.setVerticesBuffer(s.createVertexBuffer(t+i,4*i,4));return s},Ys.prototype.thinInstanceSetBuffer=function(t,i,e=0,s=!1){var n,r,h;e=e||16,"matrix"===t?(null===(n=this._I.matrixBuffer)||void 0===n||n.dispose(),this._I.matrixBuffer=null,this._I.matrixBufferSize=i?i.length:32*e,this._I.matrixData=i,this._I.worldMatrices=null,null!==i?(this._I.instancesCount=i.length/e,this._I.matrixBuffer=this.iM("world",i,s),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._I.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):"previousMatrix"===t?(null===(r=this._I.previousMatrixBuffer)||void 0===r||r.dispose(),this._I.previousMatrixBuffer=null,this._I.previousMatrixData=i,null!==i&&(this._I.previousMatrixBuffer=this.iM("previousWorld",i,s))):(t===he.ColorKind&&(t=he.ColorInstanceKind),null===i?(null===(h=this.uM)||void 0===h?void 0:h.data[t])&&(this.removeVerticesData(t),delete this.uM.data[t],delete this.uM.strides[t],delete this.uM.sizes[t],delete this.uM.vertexBuffers[t]):(this.cat(),this.uM.data[t]=i,this.uM.strides[t]=e,this.uM.sizes[t]=i.length,this.uM.vertexBuffers[t]=new he(this.getEngine(),i,t,!s,!1,e,!0),this.setVerticesBuffer(this.uM.vertexBuffers[t])))},Ys.prototype.thinInstanceBufferUpdated=function(t){var i,e,s;"matrix"===t?null===(i=this._I.matrixBuffer)||void 0===i||i.updateDirectly(this._I.matrixData,0,this._I.instancesCount):"previousMatrix"===t?null===(e=this._I.previousMatrixBuffer)||void 0===e||e.updateDirectly(this._I.previousMatrixData,0,this._I.instancesCount):(t===he.ColorKind&&(t=he.ColorInstanceKind),(null===(s=this.uM)||void 0===s?void 0:s.vertexBuffers[t])&&this.uM.vertexBuffers[t].updateDirectly(this.uM.data[t],0))},Ys.prototype.thinInstancePartialBufferUpdate=function(t,i,e){var s;"matrix"===t?this._I.matrixBuffer&&this._I.matrixBuffer.updateDirectly(i,e):(t===he.ColorKind&&(t=he.ColorInstanceKind),(null===(s=this.uM)||void 0===s?void 0:s.vertexBuffers[t])&&this.uM.vertexBuffers[t].updateDirectly(i,e))},Ys.prototype.thinInstanceGetWorldMatrices=function(){if(!this._I.matrixData||!this._I.matrixBuffer)return[];const t=this._I.matrixData;if(!this._I.worldMatrices){this._I.worldMatrices=new Array;for(let i=0;i<this._I.instancesCount;++i)this._I.worldMatrices[i]=R.FromArray(t,16*i)}return this._I.worldMatrices},Ys.prototype.thinInstanceRefreshBoundingInfo=function(t=!1,i=!1,e=!1){if(!this._I.matrixData||!this._I.matrixBuffer)return;const s=this._I.boundingVectors;t&&(s.length=0,this.refreshBoundingInfo(i,e));const n=this.getBoundingInfo(),r=this._I.matrixData;if(0===s.length)for(let t=0;t<n.boundingBox.vectors.length;++t)s.push(n.boundingBox.vectors[t].clone());M.Vector3[0].setAll(Number.POSITIVE_INFINITY),M.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let t=0;t<this._I.instancesCount;++t){R.FromArrayToRef(r,16*t,M.Matrix[0]);for(let t=0;t<s.length;++t)w.TransformCoordinatesToRef(s[t],M.Matrix[0],M.Vector3[2]),M.Vector3[0].minimizeInPlace(M.Vector3[2]),M.Vector3[1].maximizeInPlace(M.Vector3[2])}n.reConstruct(M.Vector3[0],M.Vector3[1]),this.VC()},Ys.prototype.lat=function(t,i=1){var e,s,n;t===he.ColorKind&&(t=he.ColorInstanceKind);const r="matrix"===t;if(!(r||this.uM&&this.uM.strides[t]))return;const h=r?16:this.uM.strides[t],o=r?this._I.matrixBufferSize:this.uM.sizes[t];let a=r?this._I.matrixData:this.uM.data[t];const l=(this._I.instancesCount+i)*h;let c=o;for(;c<l;)c*=2;if(!a||o!=c){if(a){const t=new Float32Array(c);t.set(a,0),a=t}else a=new Float32Array(c);r?(null===(e=this._I.matrixBuffer)||void 0===e||e.dispose(),this._I.matrixBuffer=this.iM("world",a,!1),this._I.matrixData=a,this._I.matrixBufferSize=c,this.Kt.needsPreviousWorldMatrices&&!this._I.previousMatrixData&&(null===(s=this._I.previousMatrixBuffer)||void 0===s||s.dispose(),this._I.previousMatrixBuffer=this.iM("previousWorld",a,!1))):(null===(n=this.uM.vertexBuffers[t])||void 0===n||n.dispose(),this.uM.data[t]=a,this.uM.sizes[t]=c,this.uM.vertexBuffers[t]=new he(this.getEngine(),a,t,!0,!1,h,!0),this.setVerticesBuffer(this.uM.vertexBuffers[t]))}},Ys.prototype.cat=function(){this.uM||(this.uM={data:{},sizes:{},vertexBuffers:{},strides:{}})},Ys.prototype.aM=function(){var t;(null===(t=this._I)||void 0===t?void 0:t.matrixBuffer)&&(this._I.matrixBuffer.dispose(),this._I.matrixBuffer=null)};Rs.OfflineProviderFactory=(t,i,e=!1)=>new jC(t,i,e);class jC{constructor(t,i,e=!1){this.uat="undefined"!=typeof indexedDB?indexedDB:void 0,this.fat=jC.dat(t),this.pat=null,this.mat=!1,this.vat=!1,this.gat=0,this.Sat=!1,this.Eat=!1,jC.IDBStorageEnabled?e?(this.mat=!0,this.vat=!0,this.gat=1,ki.SetImmediate((()=>{i(!0)}))):this.Aat(i):i(!0)}get enableSceneOffline(){return this.mat}get enableTexturesOffline(){return this.vat}Aat(t){const i=()=>{this.mat=!1,this.vat=!1,t(!1)},e=()=>{try{if("function"==typeof URL&&0===this.fat.indexOf("http")){const t=new URL(this.fat);return t.pathname+=".manifest",t.toString()}}catch(t){}return`${this.fat}.manifest`};let s=!1,n=e();const r=new mt;navigator.onLine&&(s=!0,n=n+(null==n.match(/\?/)?"?":"&")+Date.now()),r.open("GET",n),r.addEventListener("load",(()=>{if(200===r.status||jC.Cat(r,1))try{const i=JSON.parse(r.response);this.mat=i.enableSceneOffline,this.vat=i.enableTexturesOffline&&jC.wat,i.version&&!isNaN(parseInt(i.version))&&(this.gat=i.version),t(!0)}catch(t){i()}else i()}),!1),r.addEventListener("error",(()=>{if(s){s=!1;const t=e();r.open("GET",t),r.send()}else i()}),!1);try{r.send()}catch(i){F.Error("Error on XHR send request."),t(!1)}}open(t,i){const e=()=>{this.xat=!1,i&&i()};if(this.uat&&(this.mat||this.vat))if(this.pat)t&&t();else{this.Eat=!1,this.xat=!0;const i=this.uat.open("babylonjs",1);i.onerror=()=>{e()},i.onblocked=()=>{F.Error("IDB request blocked. Please reload the page."),e()},i.onsuccess=()=>{this.pat=i.result,t()},i.onupgradeneeded=t=>{if(this.pat=t.target.result,this.pat)try{this.pat.createObjectStore("scenes",{keyPath:"sceneUrl"}),this.pat.createObjectStore("versions",{keyPath:"sceneUrl"}),this.pat.createObjectStore("textures",{keyPath:"textureUrl"})}catch(t){F.Error("Error while creating object stores. Exception: "+t.message),e()}}}else this.xat=!1,i&&i()}loadImage(t,i){const e=jC.dat(t),s=()=>{this.Eat||null===this.pat?i.src=t:this.Tat(e,i)};this.Sat?s():this.Rat(e,i,s)}Rat(t,i,e){if(this.xat&&null!==this.pat){let s;const n=this.pat.transaction(["textures"]);n.onabort=()=>{i.src=t},n.oncomplete=()=>{let n;s&&"function"==typeof URL?(n=URL.createObjectURL(s.data),i.onerror=()=>{F.Error("Error loading image from blob URL: "+n+" switching back to web url: "+t),i.src=t},i.src=n):e()};const r=n.objectStore("textures").get(t);r.onsuccess=t=>{s=t.target.result},r.onerror=()=>{F.Error("Error loading texture "+t+" from DB."),i.src=t}}else F.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i.src=t}Tat(t,i){let e;if(this.xat){const s=()=>{let t;if(e&&"function"==typeof URL)try{t=URL.createObjectURL(e)}catch(i){t=URL.createObjectURL(e)}t&&(i.src=t)};if(jC.wat){const n=new mt;n.open("GET",t),n.responseType="blob",n.addEventListener("load",(()=>{if(200===n.status&&this.pat){e=n.response;const r=this.pat.transaction(["textures"],"readwrite");r.onabort=t=>{try{const i=t.target.error;i&&"QuotaExceededError"===i.name&&(this.Eat=!0)}catch(t){}s()},r.oncomplete=()=>{s()};const h={textureUrl:t,data:e};try{const t=r.objectStore("textures").put(h);t.onsuccess=()=>{},t.onerror=()=>{s()}}catch(e){25===e.code&&(jC.wat=!1,this.vat=!1),i.src=t}}else i.src=t}),!1),n.addEventListener("error",(()=>{F.Error("Error in XHR request in BABYLON.Database."),i.src=t}),!1),n.send()}else i.src=t}else F.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),i.src=t}Iat(t,i){this.Mat(t,i,(()=>{this.bat(t,i)}))}Mat(t,i,e){if(this.xat&&this.pat){let s;try{const n=this.pat.transaction(["versions"]);n.oncomplete=()=>{s?this.gat!==s.data?(this.Sat=!0,e()):i(s.data):(this.Sat=!0,e())},n.onabort=()=>{i(-1)};const r=n.objectStore("versions").get(t);r.onsuccess=t=>{s=t.target.result},r.onerror=()=>{F.Error("Error loading version for scene "+t+" from DB."),i(-1)}}catch(t){F.Error("Error while accessing 'versions' object store (READ OP). Exception: "+t.message),i(-1)}}else F.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),i(-1)}bat(t,i){if(this.xat&&!this.Eat&&this.pat)try{const e=this.pat.transaction(["versions"],"readwrite");e.onabort=t=>{try{const i=t.target.error;i&&"QuotaExceededError"===i.name&&(this.Eat=!0)}catch(t){}i(-1)},e.oncomplete=()=>{i(this.gat)};const s={sceneUrl:t,data:this.gat},n=e.objectStore("versions").put(s);n.onsuccess=()=>{},n.onerror=()=>{F.Error("Error in DB add version request in BABYLON.Database.")}}catch(t){F.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+t.message),i(-1)}else i(-1)}loadFile(t,i,e,s,n){const r=jC.dat(t),h=()=>{this._at(r,i,e,n,s)};this.Iat(r,(t=>{-1!==t?this.Sat?this._at(r,i,e,n,s):this.OS(r,i,h):s&&s()}))}OS(t,i,e){if(this.xat&&this.pat){let s,n;s=-1!==t.indexOf(".babylon")?"scenes":"textures";const r=this.pat.transaction([s]);r.oncomplete=()=>{n?i(n.data):e()},r.onabort=()=>{e()};const h=r.objectStore(s).get(t);h.onsuccess=t=>{n=t.target.result},h.onerror=()=>{F.Error("Error loading file "+t+" from DB."),e()}}else F.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i()}_at(t,i,e,s,n){if(this.xat){let r;r=-1!==t.indexOf(".babylon")?"scenes":"textures";const h=new mt;let o;h.open("GET",t+(null==t.match(/\?/)?"?":"&")+Date.now()),s&&(h.responseType="arraybuffer"),e&&(h.onprogress=e),h.addEventListener("load",(()=>{if(200===h.status||h.status<400&&jC.Cat(h,s?6:1))if(o=s?h.response:h.responseText,!this.Eat&&this.pat){const e=this.pat.transaction([r],"readwrite");let s;e.onabort=t=>{try{const i=t.target.error;i&&"QuotaExceededError"===i.name&&(this.Eat=!0)}catch(t){}i(o)},e.oncomplete=()=>{i(o)},s="scenes"===r?{sceneUrl:t,data:o,version:this.gat}:{textureUrl:t,data:o};try{const t=e.objectStore(r).put(s);t.onsuccess=()=>{},t.onerror=()=>{F.Error("Error in DB add file request in BABYLON.Database.")}}catch(t){i(o)}}else i(o);else h.status>=400&&n?n(h):i()}),!1),h.addEventListener("error",(()=>{F.Error("error on XHR request."),n&&n()}),!1),h.send()}else F.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),n&&n()}static Cat(t,i=7){try{if(1&i){if(t.responseText&&t.responseText.length>0)return!0;if(1===i)return!1}if(2&i){const e=vA(t.response);if(e.width&&e.height&&e.width>0&&e.height>0)return!0;if(2===i)return!1}if(4&i){const i=new Uint8Array(t.response,0,3);return 68===i[0]&&68===i[1]&&83===i[2]}}catch(t){}return!1}}jC.wat=!0,jC.IDBStorageEnabled=!1,jC.yat=t=>{document.createElement("a").href=t;const i=t.substring(0,t.lastIndexOf("#")),e=t.substring(i.lastIndexOf("/")+1,t.length);return t.substring(0,t.indexOf(e,0))},jC.dat=t=>-1===t.indexOf("http:/")&&-1===t.indexOf("https:/")&&"undefined"!=typeof window?jC.yat(window.location.href)+t:t;class KC{constructor(t){this.Nat(t)?(this.setMatrix3x3=t.updateMatrix3x3.bind(t),this.setMatrix2x2=t.updateMatrix2x2.bind(t),this.setFloat=t.updateFloat.bind(t),this.setFloat2=t.updateFloat2.bind(t),this.setFloat3=t.updateFloat3.bind(t),this.setFloat4=t.updateFloat4.bind(t),this.setFloatArray=t.updateFloatArray.bind(t),this.setArray=t.updateArray.bind(t),this.setIntArray=t.updateIntArray.bind(t),this.setMatrix=t.updateMatrix.bind(t),this.setMatrices=t.updateMatrices.bind(t),this.setVector3=t.updateVector3.bind(t),this.setVector4=t.updateVector4.bind(t),this.setColor3=t.updateColor3.bind(t),this.setColor4=t.updateColor4.bind(t),this.setDirectColor4=t.updateDirectColor4.bind(t),this.setInt=t.updateInt.bind(t),this.setInt2=t.updateInt2.bind(t),this.setInt3=t.updateInt3.bind(t),this.setInt4=t.updateInt4.bind(t)):(this.setMatrix3x3=t.setMatrix3x3.bind(t),this.setMatrix2x2=t.setMatrix2x2.bind(t),this.setFloat=t.setFloat.bind(t),this.setFloat2=t.setFloat2.bind(t),this.setFloat3=t.setFloat3.bind(t),this.setFloat4=t.setFloat4.bind(t),this.setFloatArray=t.setFloatArray.bind(t),this.setArray=t.setArray.bind(t),this.setIntArray=t.setIntArray.bind(t),this.setMatrix=t.setMatrix.bind(t),this.setMatrices=t.setMatrices.bind(t),this.setVector3=t.setVector3.bind(t),this.setVector4=t.setVector4.bind(t),this.setColor3=t.setColor3.bind(t),this.setColor4=t.setColor4.bind(t),this.setDirectColor4=t.setDirectColor4.bind(t),this.setInt=t.setInt.bind(t),this.setInt2=t.setInt2.bind(t),this.setInt3=t.setInt3.bind(t),this.setInt4=t.setInt4.bind(t))}Nat(t){return void 0!==t.addUniform}}const qC="gpuUpdateParticlesPixelShader",QC="#version 300 es\nvoid main() {\ndiscard;\n}\n";ii.ShadersStore[qC]=QC;const ZC="gpuUpdateParticlesVertexShader",JC="#version 300 es\n#define PI 3.14159\nuniform float currentCount;\nuniform float timeDelta;\nuniform float stopFactor;\n#ifndef LOCAL\nuniform mat4 emitterWM;\n#endif\nuniform vec2 lifeTime;\nuniform vec2 emitPower;\nuniform vec2 sizeRange;\nuniform vec4 scaleRange;\n#ifndef COLORGRADIENTS\nuniform vec4 color1;\nuniform vec4 color2;\n#endif\nuniform vec3 gravity;\nuniform sampler2D randomSampler;\nuniform sampler2D randomSampler2;\nuniform vec4 angleRange;\n#ifdef BOXEMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\nuniform vec3 minEmitBox;\nuniform vec3 maxEmitBox;\n#endif\n#ifdef POINTEMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\n#endif\n#ifdef HEMISPHERICEMITTER\nuniform float radius;\nuniform float radiusRange;\nuniform float directionRandomizer;\n#endif\n#ifdef SPHEREEMITTER\nuniform float radius;\nuniform float radiusRange;\n#ifdef DIRECTEDSPHEREEMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CYLINDEREMITTER\nuniform float radius;\nuniform float height;\nuniform float radiusRange;\n#ifdef DIRECTEDCYLINDEREMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CONEEMITTER\nuniform vec2 radius;\nuniform float coneAngle;\nuniform vec2 height;\nuniform float directionRandomizer;\n#endif\nin vec3 position;\n#ifdef CUSTOMEMITTER\nin vec3 initialPosition;\n#endif\nin float age;\nin float life;\nin vec4 seed;\nin vec3 size;\n#ifndef COLORGRADIENTS\nin vec4 color;\n#endif\nin vec3 direction;\n#ifndef BILLBOARD\nin vec3 initialDirection;\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nin float angle;\n#else\nin vec2 angle;\n#endif\n#ifdef ANIMATESHEET\nin float cellIndex;\n#ifdef ANIMATESHEETRANDOMSTART\nin float cellStartOffset;\n#endif\n#endif\n#ifdef NOISE\nin vec3 noiseCoordinates1;\nin vec3 noiseCoordinates2;\n#endif\nout vec3 outPosition;\n#ifdef CUSTOMEMITTER\nout vec3 outInitialPosition;\n#endif\nout float outAge;\nout float outLife;\nout vec4 outSeed;\nout vec3 outSize;\n#ifndef COLORGRADIENTS\nout vec4 outColor;\n#endif\nout vec3 outDirection;\n#ifndef BILLBOARD\nout vec3 outInitialDirection;\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nout float outAngle;\n#else\nout vec2 outAngle;\n#endif\n#ifdef ANIMATESHEET\nout float outCellIndex;\n#ifdef ANIMATESHEETRANDOMSTART\nout float outCellStartOffset;\n#endif\n#endif\n#ifdef NOISE\nout vec3 outNoiseCoordinates1;\nout vec3 outNoiseCoordinates2;\n#endif\n#ifdef SIZEGRADIENTS\nuniform sampler2D sizeGradientSampler;\n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nuniform sampler2D angularSpeedGradientSampler;\n#endif \n#ifdef VELOCITYGRADIENTS\nuniform sampler2D velocityGradientSampler;\n#endif\n#ifdef LIMITVELOCITYGRADIENTS\nuniform sampler2D limitVelocityGradientSampler;\nuniform float limitVelocityDamping;\n#endif\n#ifdef DRAGGRADIENTS\nuniform sampler2D dragGradientSampler;\n#endif\n#ifdef NOISE\nuniform vec3 noiseStrength;\nuniform sampler2D noiseSampler;\n#endif\n#ifdef ANIMATESHEET\nuniform vec4 cellInfos;\n#endif\nvec3 getRandomVec3(float offset) {\nreturn texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;\n}\nvec4 getRandomVec4(float offset) {\nreturn texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));\n}\nvoid main() {\nfloat newAge=age+timeDelta; \nif (newAge>=life && stopFactor != 0.) {\nvec3 newPosition;\nvec3 newDirection;\nvec4 randoms=getRandomVec4(seed.x);\noutLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;\noutAge=newAge-life;\noutSeed=seed;\n#ifdef SIZEGRADIENTS \noutSize.x=texture(sizeGradientSampler,vec2(0,0)).r;\n#else\noutSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;\n#endif\noutSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;\noutSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; \n#ifndef COLORGRADIENTS\noutColor=color1+(color2-color1)*randoms.b;\n#endif\n#ifndef ANGULARSPEEDGRADIENTS \noutAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;\noutAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;\n#else\noutAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;\n#endif \n#ifdef POINTEMITTER\nvec3 randoms2=getRandomVec3(seed.y);\nvec3 randoms3=getRandomVec3(seed.z);\nnewPosition=vec3(0,0,0);\nnewDirection=direction1+(direction2-direction1)*randoms3;\n#elif defined(BOXEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);\nvec3 randoms3=getRandomVec3(seed.z);\nnewPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;\nnewDirection=direction1+(direction2-direction1)*randoms3; \n#elif defined(HEMISPHERICEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);\nvec3 randoms3=getRandomVec3(seed.z);\nfloat phi=2.0*PI*randoms2.x;\nfloat theta=acos(2.0*randoms2.y-1.0);\nfloat randX=cos(phi)*sin(theta);\nfloat randY=cos(theta);\nfloat randZ=sin(phi)*sin(theta);\nnewPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);\nnewDirection=newPosition+directionRandomizer*randoms3; \n#elif defined(SPHEREEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);\nvec3 randoms3=getRandomVec3(seed.z);\nfloat phi=2.0*PI*randoms2.x;\nfloat theta=acos(2.0*randoms2.y-1.0);\nfloat randX=cos(phi)*sin(theta);\nfloat randY=cos(theta);\nfloat randZ=sin(phi)*sin(theta);\nnewPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\nnewDirection=normalize(direction1+(direction2-direction1)*randoms3);\n#else\nnewDirection=normalize(newPosition+directionRandomizer*randoms3);\n#endif\n#elif defined(CYLINDEREMITTER)\nvec3 randoms2=getRandomVec3(seed.y);\nvec3 randoms3=getRandomVec3(seed.z);\nfloat yPos=(randoms2.x-0.5)*height;\nfloat angle=randoms2.y*PI*2.;\nfloat inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));\nfloat positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));\nfloat xPos=positionRadius*cos(angle);\nfloat zPos=positionRadius*sin(angle);\nnewPosition=vec3(xPos,yPos,zPos);\n#ifdef DIRECTEDCYLINDEREMITTER\nnewDirection=direction1+(direction2-direction1)*randoms3;\n#else\nangle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;\nnewDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));\nnewDirection=normalize(newDirection);\n#endif\n#elif defined(CONEEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);\nfloat s=2.0*PI*randoms2.x;\n#ifdef CONEEMITTERSPAWNPOINT\nfloat h=0.0001;\n#else\nfloat h=randoms2.y*height.y;\nh=1.-h*h; \n#endif\nfloat lRadius=radius.x-radius.x*randoms2.z*radius.y;\nlRadius=lRadius*h;\nfloat randX=lRadius*sin(s);\nfloat randZ=lRadius*cos(s);\nfloat randY=h *height.x;\nnewPosition=vec3(randX,randY,randZ); \nif (abs(cos(coneAngle))==1.0) {\nnewDirection=vec3(0.,1.0,0.);\n} else {\nvec3 randoms3=getRandomVec3(seed.z);\nnewDirection=normalize(newPosition+directionRandomizer*randoms3); \n}\n#elif defined(CUSTOMEMITTER)\nnewPosition=initialPosition;\noutInitialPosition=initialPosition;\n#else \nnewPosition=vec3(0.,0.,0.);\nnewDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));\n#endif\nfloat power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;\n#ifdef LOCAL\noutPosition=newPosition;\n#else\noutPosition=(emitterWM*vec4(newPosition,1.)).xyz;\n#endif\n#ifdef CUSTOMEMITTER\noutDirection=direction;\n#ifndef BILLBOARD \noutInitialDirection=direction;\n#endif\n#else\n#ifdef LOCAL\nvec3 initial=newDirection;\n#else \nvec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;\n#endif\noutDirection=initial*power;\n#ifndef BILLBOARD \noutInitialDirection=initial;\n#endif\n#endif\n#ifdef ANIMATESHEET \noutCellIndex=cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\noutCellStartOffset=randoms.a*outLife;\n#endif \n#endif\n#ifdef NOISE\noutNoiseCoordinates1=noiseCoordinates1;\noutNoiseCoordinates2=noiseCoordinates2;\n#endif\n} else {\nfloat directionScale=timeDelta;\noutAge=newAge;\nfloat ageGradient=newAge/life;\n#ifdef VELOCITYGRADIENTS\ndirectionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;\n#endif\n#ifdef DRAGGRADIENTS\ndirectionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;\n#endif\n#if defined(CUSTOMEMITTER)\noutPosition=position+(direction-position)*ageGradient; \noutInitialPosition=initialPosition;\n#else\noutPosition=position+direction*directionScale;\n#endif\noutLife=life;\noutSeed=seed;\n#ifndef COLORGRADIENTS \noutColor=color;\n#endif\n#ifdef SIZEGRADIENTS\noutSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;\noutSize.yz=size.yz;\n#else\noutSize=size;\n#endif \n#ifndef BILLBOARD \noutInitialDirection=initialDirection;\n#endif\n#ifdef CUSTOMEMITTER\noutDirection=direction;\n#else\nvec3 updatedDirection=direction+gravity*timeDelta;\n#ifdef LIMITVELOCITYGRADIENTS\nfloat limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;\nfloat currentVelocity=length(updatedDirection);\nif (currentVelocity>limitVelocity) {\nupdatedDirection=updatedDirection*limitVelocityDamping;\n}\n#endif\noutDirection=updatedDirection;\n#ifdef NOISE\nfloat fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;\nfloat fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;\nfloat fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;\nvec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;\noutDirection=outDirection+force*timeDelta;\noutNoiseCoordinates1=noiseCoordinates1;\noutNoiseCoordinates2=noiseCoordinates2;\n#endif \n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nfloat angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;\noutAngle=angle+angularSpeed*timeDelta;\n#else\noutAngle=vec2(angle.x+angle.y*timeDelta,angle.y);\n#endif\n#ifdef ANIMATESHEET \nfloat offsetAge=outAge;\nfloat dist=cellInfos.y-cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\noutCellStartOffset=cellStartOffset;\noffsetAge+=cellStartOffset;\n#else\nfloat cellStartOffset=0.;\n#endif \nfloat ratio=0.;\nif (cellInfos.w==1.0) {\nratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);\n}\nelse {\nratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);\n}\noutCellIndex=float(int(cellInfos.x+ratio*dist));\n#endif\n}\n}";ii.ShadersStore[ZC]=JC;v("BABYLON.WebGL2ParticleSystem",class{constructor(t,i){this.Pat=[],this.Dat=[],this.alignDataInBuffer=!1,this.jt=t,this.Ls=i,this.Lat={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}isUpdateBufferCreated(){return!!this.Oat}isUpdateBufferReady(){var t,i;return null!==(i=null===(t=this.Oat)||void 0===t?void 0:t.isReady())&&void 0!==i&&i}createUpdateBuffer(t){return this.Lat.transformFeedbackVaryings=["outPosition"],this.Lat.transformFeedbackVaryings.push("outAge"),this.Lat.transformFeedbackVaryings.push("outSize"),this.Lat.transformFeedbackVaryings.push("outLife"),this.Lat.transformFeedbackVaryings.push("outSeed"),this.Lat.transformFeedbackVaryings.push("outDirection"),this.jt.particleEmitterType instanceof gr&&this.Lat.transformFeedbackVaryings.push("outInitialPosition"),this.jt.Fat||this.Lat.transformFeedbackVaryings.push("outColor"),this.jt.kL||this.Lat.transformFeedbackVaryings.push("outInitialDirection"),this.jt.noiseTexture&&(this.Lat.transformFeedbackVaryings.push("outNoiseCoordinates1"),this.Lat.transformFeedbackVaryings.push("outNoiseCoordinates2")),this.Lat.transformFeedbackVaryings.push("outAngle"),this.jt.isAnimationSheetEnabled&&(this.Lat.transformFeedbackVaryings.push("outCellIndex"),this.jt.spriteRandomStartCell&&this.Lat.transformFeedbackVaryings.push("outCellStartOffset")),this.Lat.defines=t,this.Oat=new ei("gpuUpdateParticles",this.Lat,this.Ls),new KC(this.Oat)}createVertexBuffers(t,i){this.Dat.push(this.Bat(t)),this.Pat.push(this.Ls.recordVertexArrayObject(i,null,this.jt.Uat(this.jt.blendMode).effect)),this.Ls.bindArrayBuffer(null)}createParticleBuffer(t){return t}bindDrawBuffers(t){this.Ls.bindVertexArrayObject(this.Pat[t],null)}preUpdateParticleBuffer(){const t=this.Ls;if(this.Ls.enableEffect(this.Oat),!t.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(t,i,e){this.Oat.setTexture("randomSampler",this.jt.Vat),this.Oat.setTexture("randomSampler2",this.jt.kat),this.jt.Gat&&this.Oat.setTexture("sizeGradientSampler",this.jt.Gat),this.jt.zat&&this.Oat.setTexture("angularSpeedGradientSampler",this.jt.zat),this.jt.Hat&&this.Oat.setTexture("velocityGradientSampler",this.jt.Hat),this.jt.Xat&&this.Oat.setTexture("limitVelocityGradientSampler",this.jt.Xat),this.jt.Wat&&this.Oat.setTexture("dragGradientSampler",this.jt.Wat),this.jt.noiseTexture&&this.Oat.setTexture("noiseSampler",this.jt.noiseTexture),this.Ls.bindVertexArrayObject(this.Dat[t],null);const s=this.Ls;s.bindTransformFeedbackBuffer(i.getBuffer()),s.setRasterizerState(!1),s.beginTransformFeedback(!0),s.drawArraysType(3,0,e),s.endTransformFeedback(),s.setRasterizerState(!0),s.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let t=0;t<this.Dat.length;t++)this.Ls.releaseVertexArrayObject(this.Dat[t]);this.Dat.length=0;for(let t=0;t<this.Pat.length;t++)this.Ls.releaseVertexArrayObject(this.Pat[t]);this.Pat.length=0}Bat(t){const i={};i.position=t.createVertexBuffer("position",0,3);let e=3;i.age=t.createVertexBuffer("age",e,1),e+=1,i.size=t.createVertexBuffer("size",e,3),e+=3,i.life=t.createVertexBuffer("life",e,1),e+=1,i.seed=t.createVertexBuffer("seed",e,4),e+=4,i.direction=t.createVertexBuffer("direction",e,3),e+=3,this.jt.particleEmitterType instanceof gr&&(i.initialPosition=t.createVertexBuffer("initialPosition",e,3),e+=3),this.jt.Fat||(i.color=t.createVertexBuffer("color",e,4),e+=4),this.jt.kL||(i.initialDirection=t.createVertexBuffer("initialDirection",e,3),e+=3),this.jt.noiseTexture&&(i.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",e,3),e+=3,i.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",e,3),e+=3),this.jt.zat?(i.angle=t.createVertexBuffer("angle",e,1),e+=1):(i.angle=t.createVertexBuffer("angle",e,2),e+=2),this.jt.XL&&(i.cellIndex=t.createVertexBuffer("cellIndex",e,1),e+=1,this.jt.spriteRandomStartCell&&(i.cellStartOffset=t.createVertexBuffer("cellStartOffset",e,1),e+=1));const s=this.Ls.recordVertexArrayObject(i,null,this.Oat);return this.Ls.bindArrayBuffer(null),s}});const tw="gpuUpdateParticlesComputeShader",iw="struct Particle {\nposition : vec3<f32>,\nage : f32,\nsize : vec3<f32>,\nlife : f32,\nseed : vec4<f32>,\ndirection : vec3<f32>,\ndummy0: f32,\n#ifdef CUSTOMEMITTER\ninitialPosition : vec3<f32>,\ndummy1: f32,\n#endif\n#ifndef COLORGRADIENTS\ncolor : vec4<f32>,\n#endif\n#ifndef BILLBOARD\ninitialDirection : vec3<f32>,\ndummy2: f32,\n#endif\n#ifdef NOISE\nnoiseCoordinates1 : vec3<f32>,\ndummy3: f32,\nnoiseCoordinates2 : vec3<f32>,\ndummy4: f32,\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nangle : f32,\n#else\nangle : vec2<f32>,\n#endif\n#ifdef ANIMATESHEET\ncellIndex : f32,\n#ifdef ANIMATESHEETRANDOMSTART\ncellStartOffset : f32,\n#endif\n#endif\n};\nstruct Particles {\nparticles : array<Particle>,\n};\nstruct SimParams {\ncurrentCount : f32,\ntimeDelta : f32,\nstopFactor : f32,\nrandomTextureSize: i32,\nlifeTime : vec2<f32>,\nemitPower : vec2<f32>,\n#ifndef COLORGRADIENTS\ncolor1 : vec4<f32>,\ncolor2 : vec4<f32>,\n#endif\nsizeRange : vec2<f32>,\nscaleRange : vec4<f32>,\nangleRange : vec4<f32>,\ngravity : vec3<f32>,\n#ifdef LIMITVELOCITYGRADIENTS\nlimitVelocityDamping : f32,\n#endif\n#ifdef ANIMATESHEET\ncellInfos : vec4<f32>,\n#endif\n#ifdef NOISE\nnoiseStrength : vec3<f32>,\n#endif\n#ifndef LOCAL\nemitterWM : mat4x4<f32>,\n#endif\n#ifdef BOXEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\nminEmitBox : vec3<f32>,\nmaxEmitBox : vec3<f32>,\n#endif\n#ifdef CONEEMITTER\nradius : vec2<f32>,\nconeAngle : f32,\nheight : vec2<f32>,\ndirectionRandomizer : f32,\n#endif\n#ifdef CYLINDEREMITTER\nradius : f32,\nheight : f32,\nradiusRange : f32,\n#ifdef DIRECTEDCYLINDEREMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n#ifdef HEMISPHERICEMITTER\nradius : f32,\nradiusRange : f32,\ndirectionRandomizer : f32,\n#endif\n#ifdef POINTEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#endif\n#ifdef SPHEREEMITTER\nradius : f32,\nradiusRange : f32,\n#ifdef DIRECTEDSPHEREEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n};\n@binding(0) @group(0) var<uniform> params : SimParams;\n@binding(1) @group(0) var<storage,read> particlesIn : Particles;\n@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;\n@binding(3) @group(0) var randomTexture : texture_2d<f32>;\n@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;\n#ifdef SIZEGRADIENTS\n@binding(0) @group(1) var sizeGradientSampler : sampler;\n@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;\n#endif \n#ifdef ANGULARSPEEDGRADIENTS\n@binding(2) @group(1) var angularSpeedGradientSampler : sampler;\n@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;\n#endif \n#ifdef VELOCITYGRADIENTS\n@binding(4) @group(1) var velocityGradientSampler : sampler;\n@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;\n#endif\n#ifdef LIMITVELOCITYGRADIENTS\n@binding(6) @group(1) var limitVelocityGradientSampler : sampler;\n@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;\n#endif\n#ifdef DRAGGRADIENTS\n@binding(8) @group(1) var dragGradientSampler : sampler;\n@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;\n#endif\n#ifdef NOISE\n@binding(10) @group(1) var noiseSampler : sampler;\n@binding(11) @group(1) var noiseTexture : texture_2d<f32>;\n#endif\nfn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {\nreturn textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;\n}\nfn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {\nreturn textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);\n}\n@stage(compute) @workgroup_size(64)\nfn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {\nlet index : u32=GlobalInvocationID.x;\nlet vertexID : f32=f32(index);\nif (index>=u32(params.currentCount)) {\nreturn;\n}\nlet PI : f32=3.14159;\nlet timeDelta : f32=params.timeDelta;\nlet newAge : f32=particlesIn.particles[index].age+timeDelta;\nlet life : f32=particlesIn.particles[index].life;\nlet seed : vec4<f32>=particlesIn.particles[index].seed;\nlet direction : vec3<f32>=particlesIn.particles[index].direction;\nif (newAge>=life && params.stopFactor != 0.) {\nvar newPosition : vec3<f32>;\nvar newDirection : vec3<f32>;\nlet randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);\nlet outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;\nparticlesOut.particles[index].life=outLife;\nparticlesOut.particles[index].age=newAge-life;\nparticlesOut.particles[index].seed=seed;\nvar sizex : f32;\n#ifdef SIZEGRADIENTS \nsizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;\n#else\nsizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;\n#endif\nparticlesOut.particles[index].size=vec3<f32>(\nsizex,\nparams.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,\nparams.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);\n#ifndef COLORGRADIENTS\nparticlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;\n#endif\n#ifndef ANGULARSPEEDGRADIENTS \nparticlesOut.particles[index].angle=vec2<f32>(\nparams.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,\nparams.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);\n#else\nparticlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;\n#endif \n#if defined(POINTEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nnewPosition=vec3<f32>(0.,0.,0.);\nnewDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#elif defined(BOXEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nnewPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;\nnewDirection=params.direction1+(params.direction2-params.direction1)*randoms3; \n#elif defined(HEMISPHERICEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nlet phi : f32=2.0*PI*randoms2.x;\nlet theta : f32=acos(-1.0+2.0*randoms2.y);\nlet randX : f32=cos(phi)*sin(theta);\nlet randY : f32=cos(theta);\nlet randZ : f32=sin(phi)*sin(theta);\nnewPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);\nnewDirection=normalize(newPosition+params.directionRandomizer*randoms3);\n#elif defined(SPHEREEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nlet phi : f32=2.0*PI*randoms2.x;\nlet theta : f32=acos(-1.0+2.0*randoms2.y);\nlet randX : f32=cos(phi)*sin(theta);\nlet randY : f32=cos(theta);\nlet randZ : f32=sin(phi)*sin(theta);\nnewPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\nnewDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);\n#else\nnewDirection=normalize(newPosition+params.directionRandomizer*randoms3);\n#endif\n#elif defined(CYLINDEREMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nlet yPos : f32=(-0.5+randoms2.x)*params.height;\nvar angle : f32=randoms2.y*PI*2.;\nlet inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);\nlet positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));\nlet xPos : f32=positionRadius*cos(angle);\nlet zPos : f32=positionRadius*sin(angle);\nnewPosition=vec3<f32>(xPos,yPos,zPos);\n#ifdef DIRECTEDCYLINDEREMITTER\nnewDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#else\nangle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;\nnewDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));\nnewDirection=normalize(newDirection);\n#endif\n#elif defined(CONEEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet s : f32=2.0*PI*randoms2.x;\n#ifdef CONEEMITTERSPAWNPOINT\nlet h : f32=0.0001;\n#else\nvar h : f32=randoms2.y*params.height.y;\nh=1.-h*h; \n#endif\nvar lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;\nlRadius=lRadius*h;\nlet randX : f32=lRadius*sin(s);\nlet randZ : f32=lRadius*cos(s);\nlet randY : f32=h *params.height.x;\nnewPosition=vec3<f32>(randX,randY,randZ); \nif (abs(cos(params.coneAngle))==1.0) {\nnewDirection=vec3<f32>(0.,1.0,0.);\n} else {\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nnewDirection=normalize(newPosition+params.directionRandomizer*randoms3); \n}\n#elif defined(CUSTOMEMITTER)\nnewPosition=particlesIn.particles[index].initialPosition;\nparticlesOut.particles[index].initialPosition=newPosition;\n#else \nnewPosition=vec3<f32>(0.,0.,0.);\nnewDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));\n#endif\nlet power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;\n#ifdef LOCAL\nparticlesOut.particles[index].position=newPosition;\n#else\nparticlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;\n#endif\n#ifdef CUSTOMEMITTER\nparticlesOut.particles[index].direction=direction;\n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=direction;\n#endif\n#else\n#ifdef LOCAL\nlet initial : vec3<f32>=newDirection;\n#else \nlet initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;\n#endif\nparticlesOut.particles[index].direction=initial*power;\n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=initial;\n#endif\n#endif\n#ifdef ANIMATESHEET \nparticlesOut.particles[index].cellIndex=params.cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\nparticlesOut.particles[index].cellStartOffset=randoms.a*outLife;\n#endif \n#endif\n#ifdef NOISE\nparticlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;\nparticlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;\n#endif\n} else {\nvar directionScale : f32=timeDelta;\nparticlesOut.particles[index].age=newAge;\nlet ageGradient : f32=newAge/life;\n#ifdef VELOCITYGRADIENTS\ndirectionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;\n#endif\n#ifdef DRAGGRADIENTS\ndirectionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);\n#endif\nlet position : vec3<f32>=particlesIn.particles[index].position;\n#if defined(CUSTOMEMITTER)\nparticlesOut.particles[index].position=position+(direction-position)*ageGradient; \nparticlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;\n#else\nparticlesOut.particles[index].position=position+direction*directionScale;\n#endif\nparticlesOut.particles[index].life=life;\nparticlesOut.particles[index].seed=seed;\n#ifndef COLORGRADIENTS \nparticlesOut.particles[index].color=particlesIn.particles[index].color;\n#endif\n#ifdef SIZEGRADIENTS\nparticlesOut.particles[index].size=vec3<f32>(\ntextureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,\nparticlesIn.particles[index].size.yz);\n#else\nparticlesOut.particles[index].size=particlesIn.particles[index].size;\n#endif \n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;\n#endif\n#ifdef CUSTOMEMITTER\nparticlesOut.particles[index].direction=direction;\n#else\nvar updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;\n#ifdef LIMITVELOCITYGRADIENTS\nlet limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;\nlet currentVelocity : f32=length(updatedDirection);\nif (currentVelocity>limitVelocity) {\nupdatedDirection=updatedDirection*params.limitVelocityDamping;\n}\n#endif\nparticlesOut.particles[index].direction=updatedDirection;\n#ifdef NOISE\nlet noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;\nlet noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;\nlet fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;\nlet fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;\nlet fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;\nlet force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;\nparticlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;\nparticlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;\nparticlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;\n#endif \n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nlet angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;\nparticlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;\n#else\nlet angle : vec2<f32>=particlesIn.particles[index].angle;\nparticlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);\n#endif\n#ifdef ANIMATESHEET \nvar offsetAge : f32=particlesOut.particles[index].age;\nlet dist : f32=params.cellInfos.y-params.cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\nlet cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;\nparticlesOut.particles[index].cellStartOffset=cellStartOffset;\noffsetAge=offsetAge+cellStartOffset;\n#else\nlet cellStartOffset : f32=0.;\n#endif \nvar ratio : f32;\nif (params.cellInfos.w==1.0) {\nratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);\n}\nelse {\nratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);\n}\nparticlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));\n#endif\n}\n}\n";ii.ShadersStoreWGSL[tw]=iw;v("BABYLON.ComputeShaderParticleSystem",class{constructor(t,i){this.$at=[],this.Yat=[],this.alignDataInBuffer=!0,this.jt=t,this.Ls=i}isUpdateBufferCreated(){return!!this.jat}isUpdateBufferReady(){var t,i;return null!==(i=null===(t=this.jat)||void 0===t?void 0:t.isReady())&&void 0!==i&&i}createUpdateBuffer(t){var i;const e={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this.jt.Gat&&(e.sizeGradientTexture={group:1,binding:1}),this.jt.zat&&(e.angularSpeedGradientTexture={group:1,binding:3}),this.jt.Hat&&(e.velocityGradientTexture={group:1,binding:5}),this.jt.Xat&&(e.limitVelocityGradientTexture={group:1,binding:7}),this.jt.Wat&&(e.dragGradientTexture={group:1,binding:9}),this.jt.noiseTexture&&(e.noiseTexture={group:1,binding:11}),this.jat=new Gc("updateParticles",this.Ls,"gpuUpdateParticles",{bindingsMapping:e,defines:t.split("\n")}),null===(i=this.Kat)||void 0===i||i.dispose(),this.Kat=new ne(this.Ls),this.Kat.addUniform("currentCount",1),this.Kat.addUniform("timeDelta",1),this.Kat.addUniform("stopFactor",1),this.Kat.addUniform("randomTextureSize",1),this.Kat.addUniform("lifeTime",2),this.Kat.addUniform("emitPower",2),this.jt.Fat||(this.Kat.addUniform("color1",4),this.Kat.addUniform("color2",4)),this.Kat.addUniform("sizeRange",2),this.Kat.addUniform("scaleRange",4),this.Kat.addUniform("angleRange",4),this.Kat.addUniform("gravity",3),this.jt.Xat&&this.Kat.addUniform("limitVelocityDamping",1),this.jt.isAnimationSheetEnabled&&this.Kat.addUniform("cellInfos",4),this.jt.noiseTexture&&this.Kat.addUniform("noiseStrength",3),this.jt.isLocal||this.Kat.addUniform("emitterWM",16),this.jt.particleEmitterType&&this.jt.particleEmitterType.buildUniformLayout(this.Kat),this.jat.setUniformBuffer("params",this.Kat),new KC(this.Kat)}createVertexBuffers(t,i){this.Yat.push(i)}createParticleBuffer(t){const i=new Zr(this.Ls,4*t.length,11);return i.update(t),this.$at.push(i),i.getBuffer()}bindDrawBuffers(t,i){this.Ls.bindBuffers(this.Yat[t],null,i)}preUpdateParticleBuffer(){}updateParticleBuffer(t,i,e){this.Kat.update(),this.jat.setTexture("randomTexture",this.jt.Vat,!1),this.jat.setTexture("randomTexture2",this.jt.kat,!1),this.jt.Gat&&this.jat.setTexture("sizeGradientTexture",this.jt.Gat),this.jt.zat&&this.jat.setTexture("angularSpeedGradientTexture",this.jt.zat),this.jt.Hat&&this.jat.setTexture("velocityGradientTexture",this.jt.Hat),this.jt.Xat&&this.jat.setTexture("limitVelocityGradientTexture",this.jt.Xat),this.jt.Wat&&this.jat.setTexture("dragGradientTexture",this.jt.Wat),this.jt.noiseTexture&&this.jat.setTexture("noiseTexture",this.jt.noiseTexture),this.jat.setStorageBuffer("particlesIn",this.$at[t]),this.jat.setStorageBuffer("particlesOut",this.$at[1^t]),this.jat.dispatch(Math.ceil(e/64))}releaseBuffers(){var t;for(let t=0;t<this.$at.length;++t)this.$at[t].dispose();this.$at.length=0,null===(t=this.Kat)||void 0===t||t.dispose(),this.Kat=null,this.jat=null}releaseVertexBuffers(){this.Yat.length=0}});class ew{constructor(t,i,e){this.gradient=t,this.color1=i,this.color2=e}getColorToRef(t){this.color2?y.LerpToRef(this.color1,this.color2,Math.random(),t):t.copyFrom(this.color1)}}class sw{constructor(t,i){this.gradient=t,this.color=i}}class nw{constructor(t,i,e){this.gradient=t,this.factor1=i,this.factor2=e}getFactor(){return void 0===this.factor2||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}}class rw{static GetCurrentGradient(t,i,e){if(i[0].gradient>t)return void e(i[0],i[0],1);for(let s=0;s<i.length-1;s++){const n=i[s],r=i[s+1];if(t>=n.gradient&&t<=r.gradient){return void e(n,r,(t-n.gradient)/(r.gradient-n.gradient))}}const s=i.length-1;e(i[s],i[s],1)}}class hw{constructor(t){this.particleSystem=t,this.position=w.Zero(),this.direction=w.Zero(),this.color=new y(0,0,0,0),this.colorStep=new y(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new C(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this.qat=null,this.Qat=new y(0,0,0,0),this.Zat=new y(0,0,0,0),this.Jat=0,this.tlt=0,this.ilt=0,this.elt=0,this.slt=0,this.nlt=0,this.rlt=0,this.hlt=0,this.olt=0,this.llt=0,this.id=hw.clt++,this.particleSystem.isAnimationSheetEnabled&&this.ult()}ult(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let t=this.age,i=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(void 0===this.flt&&(this.flt=Math.random()*this.lifeTime),0===i?(i=1,t=this.flt):t+=this.flt);const e=this.dlt-this.plt;let s;s=this.mlt?o.Clamp(t*i%this.lifeTime/this.lifeTime):o.Clamp(t*i/this.lifeTime),this.cellIndex=this.plt+s*e|0}vlt(t){if(t.particleSystem.emitter.position){const i=t.particleSystem.emitter;if(i.position.copyFrom(this.position),t.inheritDirection){const t=M.Vector3[0];this.direction.normalizeToRef(t),i.setDirection(t,0,Math.PI/2)}}else{t.particleSystem.emitter.copyFrom(this.position)}this.direction.scaleToRef(t.inheritedVelocityAmount/2,M.Vector3[0]),t.particleSystem.glt.copyFrom(M.Vector3[0])}Slt(){this.qat&&this.qat.length>0&&this.qat.forEach((t=>{this.vlt(t)}))}HL(){this.age=0,this.id=hw.clt++,this.Elt=null,this.Alt=null,this.Clt=null,this.wlt=null,this.xlt=null,this.Tlt=null,this.cellIndex=this.particleSystem.startSpriteCellID,this.flt=void 0}copyTo(t){t.position.copyFrom(this.position),this.Rlt?t.Rlt?t.Rlt.copyFrom(this.Rlt):t.Rlt=this.Rlt.clone():t.Rlt=null,t.direction.copyFrom(this.direction),this.rE&&(t.rE?t.rE.copyFrom(this.rE):t.rE=this.rE.clone()),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.lifeTime=this.lifeTime,t.age=this.age,t.flt=this.flt,t.size=this.size,t.scale.copyFrom(this.scale),t.angle=this.angle,t.angularSpeed=this.angularSpeed,t.particleSystem=this.particleSystem,t.cellIndex=this.cellIndex,t.id=this.id,t.qat=this.qat,this.Elt&&(t.Elt=this.Elt,t.Qat.copyFrom(this.Qat),t.Zat.copyFrom(this.Zat)),this.Alt&&(t.Alt=this.Alt,t.Jat=this.Jat,t.tlt=this.tlt),this.Clt&&(t.Clt=this.Clt,t.ilt=this.ilt,t.elt=this.elt),this.wlt&&(t.wlt=this.wlt,t.slt=this.slt,t.nlt=this.nlt),this.xlt&&(t.xlt=this.xlt,t.rlt=this.rlt,t.hlt=this.hlt),this.Tlt&&(t.Tlt=this.Tlt,t.olt=this.olt,t.llt=this.llt),this.particleSystem.isAnimationSheetEnabled&&(t.plt=this.plt,t.dlt=this.dlt,t.mlt=this.mlt),this.particleSystem.useRampGradients&&(t.remapData&&this.remapData?t.remapData.copyFrom(this.remapData):t.remapData=new x(0,0,0,0)),this.Ilt&&(t.Ilt?(t.Ilt.copyFrom(this.Ilt),t.Mlt.copyFrom(this.Mlt)):(t.Ilt=this.Ilt.clone(),t.Mlt=this.Mlt.clone()))}}var ow;hw.clt=0,function(t){t[t.ATTACHED=0]="ATTACHED",t[t.END=1]="END"}(ow||(ow={}));class aw{constructor(t){if(this.particleSystem=t,this.type=ow.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!t.emitter||!t.emitter.dispose){const i=g("BABYLON.AbstractMesh");t.emitter=new i("SubemitterSystemEmitter",t.getScene()),t.blt=!0}}clone(){let t=this.particleSystem.emitter;if(t){if(t instanceof w)t=t.clone();else if(-1!==t.getClassName().indexOf("Mesh")){t=new(g("BABYLON.Mesh"))("",t.getScene()),t.isVisible=!1}}else t=new w;const i=new aw(this.particleSystem.clone(this.particleSystem.name,t));return i.particleSystem.name+="Clone",i.type=this.type,i.inheritDirection=this.inheritDirection,i.inheritedVelocityAmount=this.inheritedVelocityAmount,i.particleSystem.blt=!0,i.particleSystem.disposeOnStop=!0,i}serialize(t=!1){const i={};return i.type=this.type,i.inheritDirection=this.inheritDirection,i.inheritedVelocityAmount=this.inheritedVelocityAmount,i.particleSystem=this.particleSystem.serialize(t),i}static _lt(t,i,e,s=!1){throw X("ParseParticle")}static Parse(t,i,e){const s=t.particleSystem,n=new aw(aw._lt(s,i,e,!0));return n.type=t.type,n.inheritDirection=t.inheritDirection,n.inheritedVelocityAmount=t.inheritedVelocityAmount,n.particleSystem.VL=!0,n}dispose(){this.particleSystem.dispose()}}const lw="particlesPixelShader",cw="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nvarying vec2 vUV;\nvarying vec4 vColor;\nuniform vec4 textureMask;\nuniform sampler2D diffuseSampler;\n#include<clipPlaneFragmentDeclaration>\n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#ifdef RAMPGRADIENT\nvarying vec4 remapRanges;\nuniform sampler2D rampSampler;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec4 textureColor=texture2D(diffuseSampler,vUV);\nvec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;\n#ifdef RAMPGRADIENT\nfloat alpha=baseColor.a;\nfloat remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);\nvec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));\nbaseColor.rgb*=rampColor.rgb;\nfloat finalAlpha=baseColor.a;\nbaseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);\n#endif\n#ifdef BLENDMULTIPLYMODE\nfloat sourceAlpha=vColor.a*textureColor.a;\nbaseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);\n#endif\n#include<logDepthFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\nbaseColor.rgb=toLinearSpace(baseColor.rgb);\n#else\n#ifdef IMAGEPROCESSING\nbaseColor.rgb=toLinearSpace(baseColor.rgb);\nbaseColor=applyImageProcessing(baseColor);\n#endif\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";ii.ShadersStore[lw]=cw;const uw="particlesVertexShader",fw="attribute vec3 position;\nattribute vec4 color;\nattribute float angle;\nattribute vec2 size;\n#ifdef ANIMATESHEET\nattribute float cellIndex;\n#endif\n#ifndef BILLBOARD\nattribute vec3 direction;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute vec3 direction;\n#endif\n#ifdef RAMPGRADIENT\nattribute vec4 remapData;\n#endif\nattribute vec2 offset;\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec2 translationPivot;\n#ifdef ANIMATESHEET\nuniform vec3 particlesInfos; \n#endif\nvarying vec2 vUV;\nvarying vec4 vColor;\nvarying vec3 vPositionW;\n#ifdef RAMPGRADIENT\nvarying vec4 remapRanges;\n#endif\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform mat4 invView;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<logDepthDeclaration>\n#ifdef BILLBOARD\nuniform vec3 eyePosition;\n#endif\nvec3 rotate(vec3 yaxis,vec3 rotatedCorner) {\nvec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));\nvec3 zaxis=normalize(cross(yaxis,xaxis));\nvec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);\nvec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);\nvec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);\nmat3 rotMatrix= mat3(row0,row1,row2);\nvec3 alignedCorner=rotMatrix*rotatedCorner;\nreturn position+alignedCorner;\n}\n#ifdef BILLBOARDSTRETCHED\nvec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {\nvec3 normalizedToCamera=normalize(toCamera);\nvec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));\nvec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);\nvec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);\n#ifdef BILLBOARDSTRETCHED_LOCAL\nvec3 row1=direction;\n#else\nvec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));\nvec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);\n#endif\nmat3 rotMatrix= mat3(row0,row1,row2);\nvec3 alignedCorner=rotMatrix*rotatedCorner;\nreturn position+alignedCorner;\n}\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 cornerPos;\ncornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size+translationPivot;\n#ifdef BILLBOARD\nvec3 rotatedCorner;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.y=0.;\nvec3 yaxis=position-eyePosition;\nyaxis.y=0.;\nvPositionW=rotate(normalize(yaxis),rotatedCorner);\nvec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\nvec3 toCamera=position-eyePosition;\nvPositionW=rotateAlign(toCamera,rotatedCorner);\nvec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;\n#else\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\nvec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;\nvPositionW=(invView*vec4(viewPos,1)).xyz;\n#endif\n#ifdef RAMPGRADIENT\nremapRanges=remapData;\n#endif\ngl_Position=projection*vec4(viewPos,1.0);\n#else\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.y=0.;\nvec3 yaxis=normalize(direction);\nvPositionW=rotate(yaxis,rotatedCorner);\ngl_Position=projection*view*vec4(vPositionW,1.0);\n#endif\nvColor=color;\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex*particlesInfos.z);\nfloat columnOffset=cellIndex-rowOffset/particlesInfos.z;\nvec2 uvScale=particlesInfos.xy;\nvec2 uvOffset=vec2(offset.x ,1.0-offset.y);\nvUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=offset;\n#endif\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvec4 worldPos=vec4(vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[uw]=fw;class dw extends Er{constructor(t,i,e,s=null,n=!1,r=.01){super(t),this.ylt=R.Identity(),this.glt=new w,this.onDisposeObservable=new h,this.onStoppedObservable=new h,this.Nlt=new Array,this.Plt=new Array,this.Dlt=0,this.ff={},this.Llt=new y(0,0,0,0),this.Olt=new y(0,0,0,0),this.Flt=w.Zero(),this.Blt=w.Zero(),this.Ai=-1,this.K0=!1,this.Ult=!1,this.pe=!1,this.Vlt=0,this.klt=0,this.Glt=0,this.zlt=0,this.Hlt=0,this.updateInAnimate=!0,this.Xlt=256,this.Wlt=!1,this.blt=!1,this.isLocal=!1,this.isGPU=!1,this.$lt=null,this.recycleParticle=t=>{const i=this.Nlt.pop();i!==t&&i.copyTo(t),this.Plt.push(i)},this.Ylt=()=>{let t;if(0!==this.Plt.length?(t=this.Plt.pop(),t.HL()):t=new hw(this),this.jlt&&this.jlt.length>0){const i=this.jlt[Math.floor(Math.random()*this.jlt.length)];t.qat=[],i.forEach((i=>{if(i.type===ow.ATTACHED){const e=i.clone();t.qat.push(e),e.particleSystem.start()}}))}return t},this.Klt=t=>{if(!this.jlt||0===this.jlt.length)return;const i=Math.floor(Math.random()*this.jlt.length);this.jlt[i].forEach((i=>{if(i.type===ow.END){const e=i.clone();t.vlt(e),e.particleSystem.qlt=this,this.activeSubSystems.push(e.particleSystem),e.particleSystem.start()}}))},this.lK=i,this.Oj=r,this.XL=n,e&&"Scene"!==e.getClassName()?(this.Ls=e,this.defaultProjectionMatrix=R.PerspectiveFovLH(.8,1,.1,100,this.Ls.isNDCHalfZRange)):(this.Kt=e||E.LastCreatedScene,this.Ls=this.Kt.getEngine(),this.uniqueId=this.Kt.getUniqueId(),this.Kt.particleSystems.push(this)),this.Ls.getCaps().vertexArrayObject&&(this.Qlt=null),this.$L(null),this.Zlt={0:new vi(this.Ls)},this.Zlt[0].effect=s,this.vC=[],this.K0=this.Ls.getCaps().instancedArrays,this.KO(),this.Jlt(),this.particleEmitterType=new lr;let a=null;this.updateFunction=t=>{var i;let e=null;this.noiseTexture&&(e=this.noiseTexture.getSize(),null===(i=this.noiseTexture.getContent())||void 0===i||i.then((t=>{a=t})));for(let i=0;i<t.length;i++){const s=t[i];let n=this.tct;const r=s.age;if(s.age+=n,s.age>s.lifeTime){const t=s.age-r;n=(s.lifeTime-r)*n/t,s.age=s.lifeTime}const h=s.age/s.lifeTime;this.ML&&this.ML.length>0?rw.GetCurrentGradient(h,this.ML,((t,i,e)=>{t!==s.Elt&&(s.Qat.copyFrom(s.Zat),i.getColorToRef(s.Zat),s.Elt=t),y.LerpToRef(s.Qat,s.Zat,e,s.color)})):(s.colorStep.scaleToRef(n,this.Llt),s.color.addInPlace(this.Llt),s.color.a<0&&(s.color.a=0)),this.yL&&this.yL.length>0&&rw.GetCurrentGradient(h,this.yL,((t,i,e)=>{t!==s.Clt&&(s.ilt=s.elt,s.elt=i.getFactor(),s.Clt=t),s.angularSpeed=o.Lerp(s.ilt,s.elt,e)})),s.angle+=s.angularSpeed*n;let l=n;if(this.NL&&this.NL.length>0&&rw.GetCurrentGradient(h,this.NL,((t,i,e)=>{t!==s.wlt&&(s.slt=s.nlt,s.nlt=i.getFactor(),s.wlt=t),l*=o.Lerp(s.slt,s.nlt,e)})),s.direction.scaleToRef(l,this.Flt),this.PL&&this.PL.length>0&&rw.GetCurrentGradient(h,this.PL,((t,i,e)=>{t!==s.xlt&&(s.rlt=s.hlt,s.hlt=i.getFactor(),s.xlt=t);const n=o.Lerp(s.rlt,s.hlt,e);s.direction.length()>n&&s.direction.scaleInPlace(this.limitVelocityDamping)})),this.DL&&this.DL.length>0&&rw.GetCurrentGradient(h,this.DL,((t,i,e)=>{t!==s.Tlt&&(s.olt=s.llt,s.llt=i.getFactor(),s.Tlt=t);const n=o.Lerp(s.olt,s.llt,e);this.Flt.scaleInPlace(1-n)})),this.isLocal&&s.rE?(s.rE.addInPlace(this.Flt),w.TransformCoordinatesToRef(s.rE,this.ict,s.position)):s.position.addInPlace(this.Flt),a&&e&&s.Ilt){const t=this.ect(s.Ilt.x,s.Ilt.y,e.width,e.height,a),i=this.ect(s.Ilt.z,s.Mlt.x,e.width,e.height,a),r=this.ect(s.Mlt.y,s.Mlt.z,e.width,e.height,a),h=M.Vector3[0],o=M.Vector3[1];h.copyFromFloats((2*t-1)*this.noiseStrength.x,(2*i-1)*this.noiseStrength.y,(2*r-1)*this.noiseStrength.z),h.scaleToRef(n,o),s.direction.addInPlace(o)}this.gravity.scaleToRef(n,this.Blt),s.direction.addInPlace(this.Blt),this.bL&&this.bL.length>0&&rw.GetCurrentGradient(h,this.bL,((t,i,e)=>{t!==s.Alt&&(s.Jat=s.tlt,s.tlt=i.getFactor(),s.Alt=t),s.size=o.Lerp(s.Jat,s.tlt,e)})),this.Wlt&&(this.BL&&this.BL.length>0&&rw.GetCurrentGradient(h,this.BL,((t,i,e)=>{const n=o.Lerp(t.factor1,i.factor1,e),r=o.Lerp(t.factor2,i.factor2,e);s.remapData.x=n,s.remapData.y=r-n})),this.UL&&this.UL.length>0&&rw.GetCurrentGradient(h,this.UL,((t,i,e)=>{const n=o.Lerp(t.factor1,i.factor1,e),r=o.Lerp(t.factor2,i.factor2,e);s.remapData.z=n,s.remapData.w=r-n}))),this.XL&&s.updateCellIndex(),s.Slt(),s.age>=s.lifeTime&&(this.Klt(s),s.qat&&(s.qat.forEach((t=>{t.particleSystem.disposeOnStop=!0,t.particleSystem.stop()})),s.qat=null),this.recycleParticle(s),i--)}}}set onDispose(t){this.Li&&this.onDisposeObservable.remove(this.Li),this.Li=this.onDisposeObservable.add(t)}get useRampGradients(){return this.Wlt}set useRampGradients(t){this.Wlt!==t&&(this.Wlt=t,this.sct())}get particles(){return this.Nlt}getActiveCount(){return this.Nlt.length}getClassName(){return"ParticleSystem"}isStopping(){return this.pe&&this.isAlive()}getCustomEffect(t=0){var i,e;return null!==(e=null===(i=this.Zlt[t])||void 0===i?void 0:i.effect)&&void 0!==e?e:this.Zlt[0].effect}nct(t=0){var i;return null!==(i=this.Zlt[t])&&void 0!==i?i:this.Zlt[0]}setCustomEffect(t,i=0){this.Zlt[i]=new vi(this.Ls),this.Zlt[i].effect=t,this.Zlt[i].drawContext&&(this.Zlt[i].drawContext.useInstancing=this.K0)}get onBeforeDrawParticlesObservable(){return this.$lt||(this.$lt=new h),this.$lt}get vertexShaderName(){return"particles"}get vertexBuffers(){return this.ff}get indexBuffer(){return this.Xu}rct(t,i,e,s){const n=new nw(i,e,s);t.push(n),t.sort(((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0))}hct(t,i){if(!t)return;let e=0;for(const s of t){if(s.gradient===i){t.splice(e,1);break}e++}}addLifeTimeGradient(t,i,e){return this._L||(this._L=[]),this.rct(this._L,t,i,e),this}removeLifeTimeGradient(t){return this.hct(this._L,t),this}addSizeGradient(t,i,e){return this.bL||(this.bL=[]),this.rct(this.bL,t,i,e),this}removeSizeGradient(t){return this.hct(this.bL,t),this}addColorRemapGradient(t,i,e){return this.BL||(this.BL=[]),this.rct(this.BL,t,i,e),this}removeColorRemapGradient(t){return this.hct(this.BL,t),this}addAlphaRemapGradient(t,i,e){return this.UL||(this.UL=[]),this.rct(this.UL,t,i,e),this}removeAlphaRemapGradient(t){return this.hct(this.UL,t),this}addAngularSpeedGradient(t,i,e){return this.yL||(this.yL=[]),this.rct(this.yL,t,i,e),this}removeAngularSpeedGradient(t){return this.hct(this.yL,t),this}addVelocityGradient(t,i,e){return this.NL||(this.NL=[]),this.rct(this.NL,t,i,e),this}removeVelocityGradient(t){return this.hct(this.NL,t),this}addLimitVelocityGradient(t,i,e){return this.PL||(this.PL=[]),this.rct(this.PL,t,i,e),this}removeLimitVelocityGradient(t){return this.hct(this.PL,t),this}addDragGradient(t,i,e){return this.DL||(this.DL=[]),this.rct(this.DL,t,i,e),this}removeDragGradient(t){return this.hct(this.DL,t),this}addEmitRateGradient(t,i,e){return this.LL||(this.LL=[]),this.rct(this.LL,t,i,e),this}removeEmitRateGradient(t){return this.hct(this.LL,t),this}addStartSizeGradient(t,i,e){return this.OL||(this.OL=[]),this.rct(this.OL,t,i,e),this}removeStartSizeGradient(t){return this.hct(this.OL,t),this}oct(){if(!this.FL||!this.FL.length||this.act||!this.Kt)return;const t=new Uint8Array(4*this.Xlt),i=N.Color3[0];for(let e=0;e<this.Xlt;e++){const s=e/this.Xlt;rw.GetCurrentGradient(s,this.FL,((s,n,r)=>{_.LerpToRef(s.color,n.color,r,i),t[4*e]=255*i.r,t[4*e+1]=255*i.g,t[4*e+2]=255*i.b,t[4*e+3]=255}))}this.act=fn.CreateRGBATexture(t,this.Xlt,1,this.Kt,!1,!1,1)}getRampGradients(){return this.FL}forceRefreshGradients(){this.lct()}lct(){this.FL&&(this.FL.sort(((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0)),this.act&&(this.act.dispose(),this.act=null),this.oct())}addRampGradient(t,i){this.FL||(this.FL=[]);const e=new sw(t,i);return this.FL.push(e),this.lct(),this}removeRampGradient(t){return this.YL(t,this.FL,this.act),this.act=null,this.FL&&this.FL.length>0&&this.oct(),this}addColorGradient(t,i,e){this.ML||(this.ML=[]);const s=new ew(t,i,e);return this.ML.push(s),this.ML.sort(((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0)),this}removeColorGradient(t){if(!this.ML)return this;let i=0;for(const e of this.ML){if(e.gradient===t){this.ML.splice(i,1);break}i++}return this}resetDrawCache(){for(const t of this.vC)if(t)for(const i of t)null==i||i.dispose();this.vC=[]}ect(t,i,e,s,n){return n[4*(((t=.5*Math.abs(t)+.5)*e%e|0)+((i=.5*Math.abs(i)+.5)*s%s|0)*e)]/255}HL(){this.sct()}sct(){this.cct&&(this.cct.dispose(),this.cct=null),this.uct&&(this.uct.dispose(),this.uct=null),this.Qlt&&(this.Ls.releaseVertexArrayObject(this.Qlt),this.Qlt=null),this.Jlt()}Jlt(){this.fct=this.K0?10:12,this.XL&&(this.fct+=1),this.kL&&this.billboardMode!==dw.BILLBOARDMODE_STRETCHED&&this.billboardMode!==dw.BILLBOARDMODE_STRETCHED_LOCAL||(this.fct+=3),this.Wlt&&(this.fct+=4);const t=this.Ls,i=this.fct*(this.K0?1:4);this.dct=new Float32Array(this.lK*i),this.cct=new re(t,this.dct,!0,i);let e=0;const s=this.cct.createVertexBuffer(he.PositionKind,e,3,this.fct,this.K0);this.ff[he.PositionKind]=s,e+=3;const n=this.cct.createVertexBuffer(he.ColorKind,e,4,this.fct,this.K0);this.ff[he.ColorKind]=n,e+=4;const r=this.cct.createVertexBuffer("angle",e,1,this.fct,this.K0);this.ff.angle=r,e+=1;const h=this.cct.createVertexBuffer("size",e,2,this.fct,this.K0);if(this.ff.size=h,e+=2,this.XL){const t=this.cct.createVertexBuffer("cellIndex",e,1,this.fct,this.K0);this.ff.cellIndex=t,e+=1}if(!this.kL||this.billboardMode===dw.BILLBOARDMODE_STRETCHED||this.billboardMode===dw.BILLBOARDMODE_STRETCHED_LOCAL){const t=this.cct.createVertexBuffer("direction",e,3,this.fct,this.K0);this.ff.direction=t,e+=3}if(this.Wlt){const t=this.cct.createVertexBuffer("remapData",e,4,this.fct,this.K0);this.ff.remapData=t,e+=4}let o;if(this.K0){const i=new Float32Array([0,0,1,0,0,1,1,1]);this.uct=new re(t,i,!1,2),o=this.uct.createVertexBuffer("offset",0,2)}else o=this.cct.createVertexBuffer("offset",e,2,this.fct,this.K0),e+=2;this.ff.offset=o,this.resetDrawCache()}KO(){if(this.K0)return;const t=[];let i=0;for(let e=0;e<this.lK;e++)t.push(i),t.push(i+1),t.push(i+2),t.push(i),t.push(i+2),t.push(i+3),i+=4;this.Xu=this.Ls.createIndexBuffer(t)}getCapacity(){return this.lK}isAlive(){return this.pct}isStarted(){return this.Ult}mct(){this.jlt=new Array,this.subEmitters&&this.subEmitters.forEach((t=>{t instanceof dw?this.jlt.push([new aw(t)]):t instanceof aw?this.jlt.push([t]):t instanceof Array&&this.jlt.push(t)}))}start(t=this.startDelay){var i;if(!this.targetStopDuration&&this.WL())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(t)setTimeout((()=>{this.start(0)}),t);else{if(this.mct(),this.Ult=!0,this.pe=!1,this.Vlt=0,this.jlt&&0!=this.jlt.length&&(this.activeSubSystems=new Array),this.LL&&(this.LL.length>0&&(this.vct=this.LL[0],this.klt=this.vct.getFactor(),this.Glt=this.klt),this.LL.length>1&&(this.Glt=this.LL[1].getFactor())),this.OL&&(this.OL.length>0&&(this.gct=this.OL[0],this.zlt=this.gct.getFactor(),this.Hlt=this.zlt),this.OL.length>1&&(this.Hlt=this.OL[1].getFactor())),this.preWarmCycles){-1!==(null===(i=this.emitter)||void 0===i?void 0:i.getClassName().indexOf("Mesh"))&&this.emitter.computeWorldMatrix(!0);const t=this.noiseTexture;if(t&&t.onGeneratedObservable)t.onGeneratedObservable.addOnce((()=>{setTimeout((()=>{for(let i=0;i<this.preWarmCycles;i++)this.animate(!0),t.render()}))}));else for(let t=0;t<this.preWarmCycles;t++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this.Kt&&this.Kt.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}}stop(t=!0){this.pe||(this.onStoppedObservable.notifyObservers(this),this.pe=!0,t&&this.Sct())}reset(){this.Plt.length=0,this.Nlt.length=0}Ect(t,i,e,s){let n=t*this.fct;if(this.dct[n++]=i.position.x+this.worldOffset.x,this.dct[n++]=i.position.y+this.worldOffset.y,this.dct[n++]=i.position.z+this.worldOffset.z,this.dct[n++]=i.color.r,this.dct[n++]=i.color.g,this.dct[n++]=i.color.b,this.dct[n++]=i.color.a,this.dct[n++]=i.angle,this.dct[n++]=i.scale.x*i.size,this.dct[n++]=i.scale.y*i.size,this.XL&&(this.dct[n++]=i.cellIndex),this.kL)this.billboardMode!==dw.BILLBOARDMODE_STRETCHED&&this.billboardMode!==dw.BILLBOARDMODE_STRETCHED_LOCAL||(this.dct[n++]=i.direction.x,this.dct[n++]=i.direction.y,this.dct[n++]=i.direction.z);else if(i.Rlt){let t=i.Rlt;this.isLocal&&(w.TransformNormalToRef(t,this.ict,M.Vector3[0]),t=M.Vector3[0]),0===t.x&&0===t.z&&(t.x=.001),this.dct[n++]=t.x,this.dct[n++]=t.y,this.dct[n++]=t.z}else{let t=i.direction;this.isLocal&&(w.TransformNormalToRef(t,this.ict,M.Vector3[0]),t=M.Vector3[0]),0===t.x&&0===t.z&&(t.x=.001),this.dct[n++]=t.x,this.dct[n++]=t.y,this.dct[n++]=t.z}this.Wlt&&i.remapData&&(this.dct[n++]=i.remapData.x,this.dct[n++]=i.remapData.y,this.dct[n++]=i.remapData.z,this.dct[n++]=i.remapData.w),this.K0||(this.XL&&(0===e?e=this.Oj:1===e&&(e=1-this.Oj),0===s?s=this.Oj:1===s&&(s=1-this.Oj)),this.dct[n++]=e,this.dct[n++]=s)}Sct(){this.activeSubSystems&&(this.activeSubSystems.forEach((t=>{t.stop(!0)})),this.activeSubSystems=new Array)}Act(){if(!this.qlt)return;const t=this.qlt.activeSubSystems.indexOf(this);-1!==t&&this.qlt.activeSubSystems.splice(t,1),this.qlt=null}HA(t){if(this.pct=this.Nlt.length>0,this.emitter.position){const t=this.emitter;this.ict=t.getWorldMatrix()}else{const t=this.emitter;this.ict=R.Translation(t.x,t.y,t.z)}let i;this.ict.invertToRef(this.ylt),this.updateFunction(this.Nlt);for(let e=0;e<t&&this.Nlt.length!==this.lK;e++){if(i=this.Ylt(),this.Nlt.push(i),this.targetStopDuration&&this._L&&this._L.length>0){const t=o.Clamp(this.Vlt/this.targetStopDuration);rw.GetCurrentGradient(t,this._L,((e,s)=>{const n=e,r=s,h=n.getFactor(),a=r.getFactor(),l=(t-n.gradient)/(r.gradient-n.gradient);i.lifeTime=o.Lerp(h,a,l)}))}else i.lifeTime=o.RandomRange(this.minLifeTime,this.maxLifeTime);const t=o.RandomRange(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction?this.startPositionFunction(this.ict,i.position,i,this.isLocal):this.particleEmitterType.startPositionFunction(this.ict,i.position,i,this.isLocal),this.isLocal&&(i.rE?i.rE.copyFrom(i.position):i.rE=i.position.clone(),w.TransformCoordinatesToRef(i.rE,this.ict,i.position)),this.startDirectionFunction?this.startDirectionFunction(this.ict,i.direction,i,this.isLocal):this.particleEmitterType.startDirectionFunction(this.ict,i.direction,i,this.isLocal,this.ylt),0===t?i.Rlt?i.Rlt.copyFrom(i.direction):i.Rlt=i.direction.clone():i.Rlt=null,i.direction.scaleInPlace(t),this.bL&&0!==this.bL.length?(i.Alt=this.bL[0],i.Jat=i.Alt.getFactor(),i.size=i.Jat,this.bL.length>1?i.tlt=this.bL[1].getFactor():i.tlt=i.Jat):i.size=o.RandomRange(this.minSize,this.maxSize),i.scale.copyFromFloats(o.RandomRange(this.minScaleX,this.maxScaleX),o.RandomRange(this.minScaleY,this.maxScaleY)),this.OL&&this.OL[0]&&this.targetStopDuration){const t=this.Vlt/this.targetStopDuration;rw.GetCurrentGradient(t,this.OL,((t,e,s)=>{t!==this.gct&&(this.zlt=this.Hlt,this.Hlt=e.getFactor(),this.gct=t);const n=o.Lerp(this.zlt,this.Hlt,s);i.scale.scaleInPlace(n)}))}if(this.yL&&0!==this.yL.length?(i.Clt=this.yL[0],i.angularSpeed=i.Clt.getFactor(),i.ilt=i.angularSpeed,this.yL.length>1?i.elt=this.yL[1].getFactor():i.elt=i.ilt):i.angularSpeed=o.RandomRange(this.minAngularSpeed,this.maxAngularSpeed),i.angle=o.RandomRange(this.minInitialRotation,this.maxInitialRotation),this.NL&&this.NL.length>0&&(i.wlt=this.NL[0],i.slt=i.wlt.getFactor(),this.NL.length>1?i.nlt=this.NL[1].getFactor():i.nlt=i.slt),this.PL&&this.PL.length>0&&(i.xlt=this.PL[0],i.rlt=i.xlt.getFactor(),this.PL.length>1?i.hlt=this.PL[1].getFactor():i.hlt=i.rlt),this.DL&&this.DL.length>0&&(i.Tlt=this.DL[0],i.olt=i.Tlt.getFactor(),this.DL.length>1?i.llt=this.DL[1].getFactor():i.llt=i.olt),this.ML&&0!==this.ML.length)i.Elt=this.ML[0],i.Elt.getColorToRef(i.color),i.Qat.copyFrom(i.color),this.ML.length>1?this.ML[1].getColorToRef(i.Zat):i.Zat.copyFrom(i.color);else{const t=o.RandomRange(0,1);y.LerpToRef(this.color1,this.color2,t,i.color),this.colorDead.subtractToRef(i.color,this.Olt),this.Olt.scaleToRef(1/i.lifeTime,i.colorStep)}this.XL&&(i.plt=this.startSpriteCellID,i.dlt=this.endSpriteCellID,i.mlt=this.spriteCellLoop),i.direction.addInPlace(this.glt),this.Wlt&&(i.remapData=new x(0,1,0,1)),this.noiseTexture&&(i.Ilt?(i.Ilt.copyFromFloats(Math.random(),Math.random(),Math.random()),i.Mlt.copyFromFloats(Math.random(),Math.random(),Math.random())):(i.Ilt=new w(Math.random(),Math.random(),Math.random()),i.Mlt=new w(Math.random(),Math.random(),Math.random()))),i.Slt()}}static Cct(t=!1,i=!1,e=!1){const s=[he.PositionKind,he.ColorKind,"angle","offset","size"];return t&&s.push("cellIndex"),i||s.push("direction"),e&&s.push("remapData"),s}static wct(t=!1,i=!1){const e=["invView","view","projection","textureMask","translationPivot","eyePosition"];return Ns(e),t&&e.push("particlesInfos"),i&&e.push("logarithmicDepthConstant"),e}fillDefines(t,i){if(this.Kt&&Ps(this,this.Kt,t),this.XL&&t.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&t.push("#define LOGARITHMICDEPTH"),i===dw.BLENDMODE_MULTIPLY&&t.push("#define BLENDMULTIPLYMODE"),this.Wlt&&t.push("#define RAMPGRADIENT"),this.kL)switch(t.push("#define BILLBOARD"),this.billboardMode){case dw.BILLBOARDMODE_Y:t.push("#define BILLBOARDY");break;case dw.BILLBOARDMODE_STRETCHED:case dw.BILLBOARDMODE_STRETCHED_LOCAL:t.push("#define BILLBOARDSTRETCHED"),this.billboardMode===dw.BILLBOARDMODE_STRETCHED_LOCAL&&t.push("#define BILLBOARDSTRETCHED_LOCAL");break;case dw.BILLBOARDMODE_ALL:t.push("#define BILLBOARDMODE_ALL")}this.Sg&&(this.Sg.prepareDefines(this.GL),t.push(this.GL.toString()))}fillUniformsAttributesAndSamplerNames(t,i,e){i.push(...dw.Cct(this.XL,this.kL&&this.billboardMode!==dw.BILLBOARDMODE_STRETCHED&&this.billboardMode!==dw.BILLBOARDMODE_STRETCHED_LOCAL,this.Wlt)),t.push(...dw.wct(this.XL,this.useLogarithmicDepth)),e.push("diffuseSampler","rampSampler"),this.Sg&&(ji.PrepareUniforms(t,this.GL),ji.PrepareSamplers(e,this.GL))}Uat(t){const i=this.nct(t);if(null==i?void 0:i.effect)return i;const e=[];this.fillDefines(e,t);const s=this.Ls.hs.supportRenderPasses?this.Ls.currentRenderPassId:0;let n=this.vC[s];n||(n=this.vC[s]=[]);let r=n[t];r||(r=new vi(this.Ls),r.drawContext&&(r.drawContext.useInstancing=this.K0),n[t]=r);const h=e.join("\n");if(r.defines!==h){const t=[],i=[],e=[];this.fillUniformsAttributesAndSamplerNames(i,t,e),r.setEffect(this.Ls.createEffect("particles",t,i,e,h),h)}return r}animate(t=!1){var i;if(!this.Ult)return;if(!t&&this.Kt){if(!this.isReady())return;if(this.Ai===this.Kt.getFrameId())return;this.Ai=this.Kt.getFrameId()}let e;if(this.tct=this.updateSpeed*(t?this.preWarmStepOffset:(null===(i=this.Kt)||void 0===i?void 0:i.getAnimationRatio())||1),this.manualEmitCount>-1)e=this.manualEmitCount,this.Dlt=0,this.manualEmitCount=0;else{let t=this.emitRate;if(this.LL&&this.LL.length>0&&this.targetStopDuration){const i=this.Vlt/this.targetStopDuration;rw.GetCurrentGradient(i,this.LL,((i,e,s)=>{i!==this.vct&&(this.klt=this.Glt,this.Glt=e.getFactor(),this.vct=i),t=o.Lerp(this.klt,this.Glt,s)}))}e=t*this.tct>>0,this.Dlt+=t*this.tct-e}if(this.Dlt>1&&(e+=this.Dlt>>0,this.Dlt-=this.Dlt>>0),this.pct=!1,this.pe?e=0:(this.Vlt+=this.tct,this.targetStopDuration&&this.Vlt>=this.targetStopDuration&&this.stop()),this.HA(e),this.pe&&(this.pct||(this.Ult=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this.Kt&&this.Kt.Tv.push(this))),!t){let t=0;for(let i=0;i<this.Nlt.length;i++){const e=this.Nlt[i];this.xct(t,e),t+=this.K0?1:4}this.cct&&this.cct.updateDirectly(this.dct,0,this.Nlt.length)}0===this.manualEmitCount&&this.disposeOnStop&&this.stop()}xct(t,i){this.Ect(t++,i,0,0),this.K0||(this.Ect(t++,i,1,0),this.Ect(t++,i,1,1),this.Ect(t++,i,0,1))}rebuild(){var t,i;this.Ls.getCaps().vertexArrayObject&&(this.Qlt=null),this.KO(),null===(t=this.uct)||void 0===t||t.br(),null===(i=this.cct)||void 0===i||i.br();for(const t in this.ff)this.ff[t].br();this.resetDrawCache()}isReady(){if(!this.emitter||this.Sg&&!this.Sg.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==dw.BLENDMODE_MULTIPLYADD){if(!this.Uat(this.blendMode).effect.isReady())return!1}else{if(!this.Uat(dw.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this.Uat(dw.BLENDMODE_ADD).effect.isReady())return!1}return!0}IO(t){var i,e;const s=this.Uat(t),n=s.effect,r=this.Ls;r.enableEffect(s);const h=null!==(i=this.defaultViewMatrix)&&void 0!==i?i:this.Kt.getViewMatrix();if(n.setTexture("diffuseSampler",this.particleTexture),n.setMatrix("view",h),n.setMatrix("projection",null!==(e=this.defaultProjectionMatrix)&&void 0!==e?e:this.Kt.getProjectionMatrix()),this.XL&&this.particleTexture){const t=this.particleTexture.getBaseSize();n.setFloat3("particlesInfos",this.spriteCellWidth/t.width,this.spriteCellHeight/t.height,this.spriteCellWidth/t.width)}if(n.setVector2("translationPivot",this.translationPivot),n.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this.kL&&this.Kt){const t=this.Kt.activeCamera;n.setVector3("eyePosition",t.globalPosition)}this.act&&(this.FL&&this.FL.length||(this.act.dispose(),this.act=null),n.setTexture("rampSampler",this.act));const o=n.defines;switch(this.Kt&&Ds(n,this,this.Kt),o.indexOf("#define BILLBOARDMODE_ALL")>=0&&(h.invertToRef(M.Matrix[0]),n.setMatrix("invView",M.Matrix[0])),void 0!==this.Qlt?(this.Qlt||(this.Qlt=this.Ls.recordVertexArrayObject(this.ff,this.Xu,n)),this.Ls.bindVertexArrayObject(this.Qlt,this.Xu)):r.bindBuffers(this.ff,this.Xu,n),this.useLogarithmicDepth&&this.Kt&&Fs.BindLogDepth(o,n,this.Kt),this.Sg&&!this.Sg.applyByPostProcess&&this.Sg.bind(n),t){case dw.BLENDMODE_ADD:r.setAlphaMode(1);break;case dw.BLENDMODE_ONEONE:r.setAlphaMode(6);break;case dw.BLENDMODE_STANDARD:r.setAlphaMode(2);break;case dw.BLENDMODE_MULTIPLY:r.setAlphaMode(4)}return this.$lt&&this.$lt.notifyObservers(n),this.K0?r.drawArraysType(7,0,4,this.Nlt.length):r.drawElementsType(0,0,6*this.Nlt.length),this.Nlt.length}render(){if(!this.isReady()||!this.Nlt.length)return 0;const t=this.Ls;t.setState&&(t.setState(!1),this.forceDepthWrite&&t.setDepthWrite(!0));let i=0;return i=this.blendMode===dw.BLENDMODE_MULTIPLYADD?this.IO(dw.BLENDMODE_MULTIPLY)+this.IO(dw.BLENDMODE_ADD):this.IO(this.blendMode),this.Ls.unbindInstanceAttributes(),this.Ls.setAlphaMode(0),i}dispose(t=!0){if(this.resetDrawCache(),this.cct&&(this.cct.dispose(),this.cct=null),this.uct&&(this.uct.dispose(),this.uct=null),this.Xu&&(this.Ls.ca(this.Xu),this.Xu=null),this.Qlt&&(this.Ls.releaseVertexArrayObject(this.Qlt),this.Qlt=null),t&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),t&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.act&&(this.act.dispose(),this.act=null),this.Act(),this.subEmitters&&!this.jlt&&this.mct(),this.jlt&&this.jlt.length){for(let t=0;t<this.jlt.length;t++)for(const i of this.jlt[t])i.dispose();this.jlt=[],this.subEmitters=[]}if(this.blt&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this.$lt&&this.$lt.clear(),this.Kt){const t=this.Kt.particleSystems.indexOf(this);t>-1&&this.Kt.particleSystems.splice(t,1),this.Kt.Nv.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()}clone(t,i,e=!1){const s={...this.Zlt};let n=null;const r=this.Ls;if(r.createEffectForParticles&&null!=this.customShader){n=this.customShader;const t=n.shaderOptions.defines.length>0?n.shaderOptions.defines.join("\n"):"",i=r.createEffectForParticles(n.shaderPath.fragmentElement,n.shaderOptions.uniforms,n.shaderOptions.samplers,t);s[0]?s[0].effect=i:this.setCustomEffect(i,0)}const h=this.serialize(e),o=dw.Parse(h,this.Kt||this.Ls,this.RL);return o.name=t,o.customShader=n,o.Zlt=s,void 0===i&&(i=this.emitter),this.noiseTexture&&(o.noiseTexture=this.noiseTexture.clone()),o.emitter=i,this.preventAutoStart||o.start(),o}serialize(t=!1){const i={};if(dw.Tct(i,this,t),i.textureMask=this.textureMask.asArray(),i.customShader=this.customShader,i.preventAutoStart=this.preventAutoStart,this.subEmitters){i.subEmitters=[],this.jlt||this.mct();for(const e of this.jlt){const s=[];for(const i of e)s.push(i.serialize(t));i.subEmitters.push(s)}}return i}static Tct(t,i,e){if(t.name=i.name,t.id=i.id,t.capacity=i.getCapacity(),t.disposeOnStop=i.disposeOnStop,t.manualEmitCount=i.manualEmitCount,i.emitter.position){const e=i.emitter;t.emitterId=e.id}else{const e=i.emitter;t.emitter=e.asArray()}i.particleEmitterType&&(t.particleEmitterType=i.particleEmitterType.serialize()),i.particleTexture&&(e?t.texture=i.particleTexture.serialize():(t.textureName=i.particleTexture.name,t.invertY=!!i.particleTexture.t_)),t.isLocal=i.isLocal,ot.AppendSerializedAnimations(i,t),t.beginAnimationOnStart=i.beginAnimationOnStart,t.beginAnimationFrom=i.beginAnimationFrom,t.beginAnimationTo=i.beginAnimationTo,t.beginAnimationLoop=i.beginAnimationLoop,t.startDelay=i.startDelay,t.renderingGroupId=i.renderingGroupId,t.isBillboardBased=i.isBillboardBased,t.billboardMode=i.billboardMode,t.minAngularSpeed=i.minAngularSpeed,t.maxAngularSpeed=i.maxAngularSpeed,t.minSize=i.minSize,t.maxSize=i.maxSize,t.minScaleX=i.minScaleX,t.maxScaleX=i.maxScaleX,t.minScaleY=i.minScaleY,t.maxScaleY=i.maxScaleY,t.minEmitPower=i.minEmitPower,t.maxEmitPower=i.maxEmitPower,t.minLifeTime=i.minLifeTime,t.maxLifeTime=i.maxLifeTime,t.emitRate=i.emitRate,t.gravity=i.gravity.asArray(),t.noiseStrength=i.noiseStrength.asArray(),t.color1=i.color1.asArray(),t.color2=i.color2.asArray(),t.colorDead=i.colorDead.asArray(),t.updateSpeed=i.updateSpeed,t.targetStopDuration=i.targetStopDuration,t.blendMode=i.blendMode,t.preWarmCycles=i.preWarmCycles,t.preWarmStepOffset=i.preWarmStepOffset,t.minInitialRotation=i.minInitialRotation,t.maxInitialRotation=i.maxInitialRotation,t.startSpriteCellID=i.startSpriteCellID,t.spriteCellLoop=i.spriteCellLoop,t.endSpriteCellID=i.endSpriteCellID,t.spriteCellChangeSpeed=i.spriteCellChangeSpeed,t.spriteCellWidth=i.spriteCellWidth,t.spriteCellHeight=i.spriteCellHeight,t.spriteRandomStartCell=i.spriteRandomStartCell,t.isAnimationSheetEnabled=i.isAnimationSheetEnabled,t.useLogarithmicDepth=i.useLogarithmicDepth;const s=i.getColorGradients();if(s){t.colorGradients=[];for(const i of s){const e={gradient:i.gradient,color1:i.color1.asArray()};i.color2?e.color2=i.color2.asArray():e.color2=i.color1.asArray(),t.colorGradients.push(e)}}const n=i.getRampGradients();if(n){t.rampGradients=[];for(const i of n){const e={gradient:i.gradient,color:i.color.asArray()};t.rampGradients.push(e)}t.useRampGradients=i.useRampGradients}const r=i.getColorRemapGradients();if(r){t.colorRemapGradients=[];for(const i of r){const e={gradient:i.gradient,factor1:i.factor1};void 0!==i.factor2?e.factor2=i.factor2:e.factor2=i.factor1,t.colorRemapGradients.push(e)}}const h=i.getAlphaRemapGradients();if(h){t.alphaRemapGradients=[];for(const i of h){const e={gradient:i.gradient,factor1:i.factor1};void 0!==i.factor2?e.factor2=i.factor2:e.factor2=i.factor1,t.alphaRemapGradients.push(e)}}const o=i.getSizeGradients();if(o){t.sizeGradients=[];for(const i of o){const e={gradient:i.gradient,factor1:i.factor1};void 0!==i.factor2?e.factor2=i.factor2:e.factor2=i.factor1,t.sizeGradients.push(e)}}const a=i.getAngularSpeedGradients();if(a){t.angularSpeedGradients=[];for(const i of a){const e={gradient:i.gradient,factor1:i.factor1};void 0!==i.factor2?e.factor2=i.factor2:e.factor2=i.factor1,t.angularSpeedGradients.push(e)}}const l=i.getVelocityGradients();if(l){t.velocityGradients=[];for(const i of l){const e={gradient:i.gradient,factor1:i.factor1};void 0!==i.factor2?e.factor2=i.factor2:e.factor2=i.factor1,t.velocityGradients.push(e)}}const c=i.getDragGradients();if(c){t.dragGradients=[];for(const i of c){const e={gradient:i.gradient,factor1:i.factor1};void 0!==i.factor2?e.factor2=i.factor2:e.factor2=i.factor1,t.dragGradients.push(e)}}const u=i.getEmitRateGradients();if(u){t.emitRateGradients=[];for(const i of u){const e={gradient:i.gradient,factor1:i.factor1};void 0!==i.factor2?e.factor2=i.factor2:e.factor2=i.factor1,t.emitRateGradients.push(e)}}const f=i.getStartSizeGradients();if(f){t.startSizeGradients=[];for(const i of f){const e={gradient:i.gradient,factor1:i.factor1};void 0!==i.factor2?e.factor2=i.factor2:e.factor2=i.factor1,t.startSizeGradients.push(e)}}const d=i.getLifeTimeGradients();if(d){t.lifeTimeGradients=[];for(const i of d){const e={gradient:i.gradient,factor1:i.factor1};void 0!==i.factor2?e.factor2=i.factor2:e.factor2=i.factor1,t.lifeTimeGradients.push(e)}}const p=i.getLimitVelocityGradients();if(p){t.limitVelocityGradients=[];for(const i of p){const e={gradient:i.gradient,factor1:i.factor1};void 0!==i.factor2?e.factor2=i.factor2:e.factor2=i.factor1,t.limitVelocityGradients.push(e)}t.limitVelocityDamping=i.limitVelocityDamping}i.noiseTexture&&(t.noiseTexture=i.noiseTexture.serialize())}static SL(t,i,e,s){var n,r,h;let o;o=e instanceof Ei?null:e;const a=g("BABYLON.Texture");if(a&&o&&(t.texture?i.particleTexture=a.Parse(t.texture,o,s):t.textureName&&(i.particleTexture=new a(s+t.textureName,o,!1,void 0===t.invertY||t.invertY),i.particleTexture.name=t.textureName)),t.emitterId||0===t.emitterId||void 0!==t.emitter?t.emitterId&&o?i.emitter=o.getLastMeshById(t.emitterId):i.emitter=w.FromArray(t.emitter):i.emitter=w.Zero(),i.isLocal=!!t.isLocal,void 0!==t.renderingGroupId&&(i.renderingGroupId=t.renderingGroupId),void 0!==t.isBillboardBased&&(i.isBillboardBased=t.isBillboardBased),void 0!==t.billboardMode&&(i.billboardMode=t.billboardMode),void 0!==t.useLogarithmicDepth&&(i.useLogarithmicDepth=t.useLogarithmicDepth),t.animations){for(let e=0;e<t.animations.length;e++){const s=t.animations[e],n=g("BABYLON.Animation");n&&i.animations.push(n.Parse(s))}i.beginAnimationOnStart=t.beginAnimationOnStart,i.beginAnimationFrom=t.beginAnimationFrom,i.beginAnimationTo=t.beginAnimationTo,i.beginAnimationLoop=t.beginAnimationLoop}if(t.autoAnimate&&o&&o.beginAnimation(i,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),i.startDelay=0|t.startDelay,i.minAngularSpeed=t.minAngularSpeed,i.maxAngularSpeed=t.maxAngularSpeed,i.minSize=t.minSize,i.maxSize=t.maxSize,t.minScaleX&&(i.minScaleX=t.minScaleX,i.maxScaleX=t.maxScaleX,i.minScaleY=t.minScaleY,i.maxScaleY=t.maxScaleY),void 0!==t.preWarmCycles&&(i.preWarmCycles=t.preWarmCycles,i.preWarmStepOffset=t.preWarmStepOffset),void 0!==t.minInitialRotation&&(i.minInitialRotation=t.minInitialRotation,i.maxInitialRotation=t.maxInitialRotation),i.minLifeTime=t.minLifeTime,i.maxLifeTime=t.maxLifeTime,i.minEmitPower=t.minEmitPower,i.maxEmitPower=t.maxEmitPower,i.emitRate=t.emitRate,i.gravity=w.FromArray(t.gravity),t.noiseStrength&&(i.noiseStrength=w.FromArray(t.noiseStrength)),i.color1=y.FromArray(t.color1),i.color2=y.FromArray(t.color2),i.colorDead=y.FromArray(t.colorDead),i.updateSpeed=t.updateSpeed,i.targetStopDuration=t.targetStopDuration,i.blendMode=t.blendMode,t.colorGradients)for(const e of t.colorGradients)i.addColorGradient(e.gradient,y.FromArray(e.color1),e.color2?y.FromArray(e.color2):void 0);if(t.rampGradients){for(const e of t.rampGradients)i.addRampGradient(e.gradient,_.FromArray(e.color));i.useRampGradients=t.useRampGradients}if(t.colorRemapGradients)for(const e of t.colorRemapGradients)i.addColorRemapGradient(e.gradient,void 0!==e.factor1?e.factor1:e.factor,e.factor2);if(t.alphaRemapGradients)for(const e of t.alphaRemapGradients)i.addAlphaRemapGradient(e.gradient,void 0!==e.factor1?e.factor1:e.factor,e.factor2);if(t.sizeGradients)for(const e of t.sizeGradients)i.addSizeGradient(e.gradient,void 0!==e.factor1?e.factor1:e.factor,e.factor2);if(t.angularSpeedGradients)for(const e of t.angularSpeedGradients)i.addAngularSpeedGradient(e.gradient,void 0!==e.factor1?e.factor1:e.factor,e.factor2);if(t.velocityGradients)for(const e of t.velocityGradients)i.addVelocityGradient(e.gradient,void 0!==e.factor1?e.factor1:e.factor,e.factor2);if(t.dragGradients)for(const e of t.dragGradients)i.addDragGradient(e.gradient,void 0!==e.factor1?e.factor1:e.factor,e.factor2);if(t.emitRateGradients)for(const e of t.emitRateGradients)i.addEmitRateGradient(e.gradient,void 0!==e.factor1?e.factor1:e.factor,e.factor2);if(t.startSizeGradients)for(const e of t.startSizeGradients)i.addStartSizeGradient(e.gradient,void 0!==e.factor1?e.factor1:e.factor,e.factor2);if(t.lifeTimeGradients)for(const e of t.lifeTimeGradients)i.addLifeTimeGradient(e.gradient,void 0!==e.factor1?e.factor1:e.factor,e.factor2);if(t.limitVelocityGradients){for(const e of t.limitVelocityGradients)i.addLimitVelocityGradient(e.gradient,void 0!==e.factor1?e.factor1:e.factor,e.factor2);i.limitVelocityDamping=t.limitVelocityDamping}if(t.noiseTexture&&o){const e=g("BABYLON.ProceduralTexture");i.noiseTexture=e.Parse(t.noiseTexture,o,s)}let l;if(t.particleEmitterType){switch(t.particleEmitterType.type){case"SphereParticleEmitter":l=new mr;break;case"SphereDirectedParticleEmitter":l=new vr;break;case"ConeEmitter":case"ConeParticleEmitter":l=new cr;break;case"CylinderParticleEmitter":l=new ur;break;case"CylinderDirectedParticleEmitter":l=new fr;break;case"HemisphericParticleEmitter":l=new dr;break;case"PointParticleEmitter":l=new pr;break;case"MeshParticleEmitter":l=new Sr;break;default:l=new lr}l.parse(t.particleEmitterType,o)}else l=new lr,l.parse(t,o);i.particleEmitterType=l,i.startSpriteCellID=t.startSpriteCellID,i.endSpriteCellID=t.endSpriteCellID,i.spriteCellLoop=null===(n=t.spriteCellLoop)||void 0===n||n,i.spriteCellWidth=t.spriteCellWidth,i.spriteCellHeight=t.spriteCellHeight,i.spriteCellChangeSpeed=t.spriteCellChangeSpeed,i.spriteRandomStartCell=t.spriteRandomStartCell,i.disposeOnStop=null!==(r=t.disposeOnStop)&&void 0!==r&&r,i.manualEmitCount=null!==(h=t.manualEmitCount)&&void 0!==h?h:-1}static Parse(t,i,e,s=!1,n){const r=t.name;let h,o,a=null,l=null;if(i instanceof Ei?h=i:(o=i,h=o.getEngine()),t.customShader&&h.createEffectForParticles){l=t.customShader;const i=l.shaderOptions.defines.length>0?l.shaderOptions.defines.join("\n"):"";a=h.createEffectForParticles(l.shaderPath.fragmentElement,l.shaderOptions.uniforms,l.shaderOptions.samplers,i)}const c=new dw(r,n||t.capacity,i,a,t.isAnimationSheetEnabled);if(c.customShader=l,c.RL=e,t.id&&(c.id=t.id),t.subEmitters){c.subEmitters=[];for(const s of t.subEmitters){const t=[];for(const n of s)t.push(aw.Parse(n,i,e));c.subEmitters.push(t)}}return dw.SL(t,c,i,e),t.textureMask&&(c.textureMask=y.FromArray(t.textureMask)),t.preventAutoStart&&(c.preventAutoStart=t.preventAutoStart),s||c.preventAutoStart||c.start(),c}}dw.BILLBOARDMODE_Y=2,dw.BILLBOARDMODE_ALL=7,dw.BILLBOARDMODE_STRETCHED=8,dw.BILLBOARDMODE_STRETCHED_LOCAL=9,aw._lt=dw.Parse;const pw="clipPlaneFragmentDeclaration2",mw="#ifdef CLIPPLANE\nin float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nin float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nin float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nin float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nin float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nin float fClipDistance6;\n#endif\n";ii.IncludesShadersStore[pw]=mw;const vw="gpuRenderParticlesPixelShader",gw="precision highp float;\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform sampler2D diffuseSampler;\nvarying vec2 vUV;\nvarying vec4 vColor;\n#include<clipPlaneFragmentDeclaration2> \n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\nvoid main() {\n#include<clipPlaneFragment> \nvec4 textureColor=texture2D(diffuseSampler,vUV);\ngl_FragColor=textureColor*vColor;\n#ifdef BLENDMULTIPLYMODE\nfloat alpha=vColor.a*textureColor.a;\ngl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);\n#endif \n#include<logDepthFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);\n#else\n#ifdef IMAGEPROCESSING\ngl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);\ngl_FragColor=applyImageProcessing(gl_FragColor);\n#endif\n#endif\n}\n";ii.ShadersStore[vw]=gw;const Sw="clipPlaneVertexDeclaration2",Ew="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nout float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;\nout float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;\nout float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;\nout float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;\nout float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;\nout float fClipDistance6;\n#endif\n";ii.IncludesShadersStore[Sw]=Ew;const Aw="gpuRenderParticlesVertexShader",Cw="precision highp float;\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec2 translationPivot;\nuniform vec3 worldOffset;\n#ifdef LOCAL\nuniform mat4 emitterWM;\n#endif\nattribute vec3 position;\nattribute float age;\nattribute float life;\nattribute vec3 size;\n#ifndef BILLBOARD\nattribute vec3 initialDirection;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute vec3 direction;\n#endif\nattribute float angle;\n#ifdef ANIMATESHEET\nattribute float cellIndex;\n#endif\nattribute vec2 offset;\nattribute vec2 uv;\nvarying vec2 vUV;\nvarying vec4 vColor;\nvarying vec3 vPositionW;\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform mat4 invView;\n#endif\n#include<clipPlaneVertexDeclaration2>\n#include<logDepthDeclaration>\n#ifdef COLORGRADIENTS\nuniform sampler2D colorGradientSampler;\n#else\nuniform vec4 colorDead;\nattribute vec4 color;\n#endif\n#ifdef ANIMATESHEET\nuniform vec3 sheetInfos;\n#endif\n#ifdef BILLBOARD\nuniform vec3 eyePosition;\n#endif\nvec3 rotate(vec3 yaxis,vec3 rotatedCorner) {\nvec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));\nvec3 zaxis=normalize(cross(yaxis,xaxis));\nvec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);\nvec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);\nvec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);\nmat3 rotMatrix= mat3(row0,row1,row2);\nvec3 alignedCorner=rotMatrix*rotatedCorner;\n#ifdef LOCAL\nreturn ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;\n#else\nreturn (position+worldOffset)+alignedCorner;\n#endif\n}\n#ifdef BILLBOARDSTRETCHED\nvec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {\nvec3 normalizedToCamera=normalize(toCamera);\nvec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));\nvec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));\nvec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);\nvec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);\nvec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);\nmat3 rotMatrix= mat3(row0,row1,row2);\nvec3 alignedCorner=rotMatrix*rotatedCorner;\n#ifdef LOCAL\nreturn ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;\n#else\nreturn (position+worldOffset)+alignedCorner;\n#endif\n}\n#endif\nvoid main() {\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex/sheetInfos.z);\nfloat columnOffset=cellIndex-rowOffset*sheetInfos.z;\nvec2 uvScale=sheetInfos.xy;\nvec2 uvOffset=vec2(uv.x ,1.0-uv.y);\nvUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=uv;\n#endif\nfloat ratio=age/life;\n#ifdef COLORGRADIENTS\nvColor=texture2D(colorGradientSampler,vec2(ratio,0));\n#else\nvColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);\n#endif\nvec2 cornerPos=(offset-translationPivot)*size.yz*size.x+translationPivot;\n#ifdef BILLBOARD\nvec4 rotatedCorner;\nrotatedCorner.w=0.;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.y=0.;\nvec3 yaxis=(position+worldOffset)-eyePosition;\nyaxis.y=0.;\nvPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);\nvec4 viewPosition=(view*vec4(vPositionW,1.0));\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\nvec3 toCamera=(position+worldOffset)-eyePosition;\nvPositionW=rotateAlign(toCamera,rotatedCorner.xyz);\nvec4 viewPosition=(view*vec4(vPositionW,1.0));\n#else\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n#ifdef LOCAL\nvec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;\n#else\nvec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;\n#endif\nvPositionW=(invView*viewPosition).xyz;\n#endif\n#else\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=0.;\nrotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nvec3 yaxis=normalize(initialDirection);\nvPositionW=rotate(yaxis,rotatedCorner);\nvec4 viewPosition=view*vec4(vPositionW,1.0);\n#endif\ngl_Position=projection*viewPosition;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvec4 worldPos=vec4(vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}";ii.ShadersStore[Aw]=Cw;class ww extends Er{constructor(t,i,e,s=null,n=!1){if(super(t),this.layerMask=268435455,this.Rct=0,this.Yat=[],this.Ict=0,this.Ai=-1,this.Mct=-1,this.Ult=!1,this.pe=!1,this.bct=0,this.updateInAnimate=!1,this.Vlt=0,this.Xlt=256,this.onDisposeObservable=new h,this.onStoppedObservable=new h,this.forceDepthWrite=!1,this._ct=!1,this.isLocal=!1,this.isGPU=!0,this.$lt=null,e&&"Scene"!==e.getClassName()?(this.Ls=e,this.defaultProjectionMatrix=R.PerspectiveFovLH(.8,1,.1,100,this.Ls.isNDCHalfZRange)):(this.Kt=e||E.LastCreatedScene,this.Ls=this.Kt.getEngine(),this.uniqueId=this.Kt.getUniqueId(),this.Kt.particleSystems.push(this)),this.Ls.getCaps().supportComputeShaders){if(!g("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this.yct=new(g("BABYLON.ComputeShaderParticleSystem"))(this,this.Ls)}else{if(!g("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this.yct=new(g("BABYLON.WebGL2ParticleSystem"))(this,this.Ls)}this.Zlt={0:new vi(this.Ls)},this.Zlt[0].effect=s,this.vC={0:new vi(this.Ls)},this.vC[0].drawContext&&(this.vC[0].drawContext.useInstancing=!0),this.$L(null),(i=null!=i?i:{}).randomTextureSize||delete i.randomTextureSize;const r={capacity:5e4,randomTextureSize:this.Ls.getCaps().maxTextureSize,...i},o=i;isFinite(o)&&(r.capacity=o),this.lK=r.capacity,this.Nct=r.capacity,this.Pct=0,this.XL=n,this.particleEmitterType=new lr;const a=Math.min(this.Ls.getCaps().maxTextureSize,r.randomTextureSize);let l=[];for(let t=0;t<a;++t)l.push(Math.random()),l.push(Math.random()),l.push(Math.random()),l.push(Math.random());this.Vat=new fn(new Float32Array(l),a,1,5,e,!1,!1,1,1),this.Vat.name="GPUParticleSystem_random1",this.Vat.wrapU=1,this.Vat.wrapV=1,l=[];for(let t=0;t<a;++t)l.push(Math.random()),l.push(Math.random()),l.push(Math.random()),l.push(Math.random());this.kat=new fn(new Float32Array(l),a,1,5,e,!1,!1,1,1),this.kat.name="GPUParticleSystem_random2",this.kat.wrapU=1,this.kat.wrapV=1,this.Dct=a}static get IsSupported(){if(!E.LastCreatedEngine)return!1;const t=E.LastCreatedEngine.getCaps();return t.supportTransformFeedbacks||t.supportComputeShaders}getCapacity(){return this.lK}get activeParticleCount(){return this.Nct}set activeParticleCount(t){this.Nct=Math.min(t,this.lK)}isReady(){if(!this.emitter||this.Sg&&!this.Sg.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==dw.BLENDMODE_MULTIPLYADD){if(!this.Uat(this.blendMode).effect.isReady())return!1}else{if(!this.Uat(dw.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this.Uat(dw.BLENDMODE_ADD).effect.isReady())return!1}return this.yct.isUpdateBufferCreated()?this.yct.isUpdateBufferReady():(this.Lct(),!1)}isStarted(){return this.Ult}isStopped(){return this.pe}isStopping(){return!1}getActiveCount(){return this.Pct}start(t=this.startDelay){if(!this.targetStopDuration&&this.WL())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";t?setTimeout((()=>{this.start(0)}),t):(this.Ult=!0,this.pe=!1,this._ct=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this.Kt&&this.Kt.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop))}stop(){this.pe||(this.pe=!0)}reset(){this.Oct(),this.yct.releaseVertexBuffers(),this.Pct=0,this.Ict=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(t=0){var i,e;return null!==(e=null===(i=this.Zlt[t])||void 0===i?void 0:i.effect)&&void 0!==e?e:this.Zlt[0].effect}nct(t=0){var i;return null!==(i=this.Zlt[t])&&void 0!==i?i:this.Zlt[0]}setCustomEffect(t,i=0){this.Zlt[i]=new vi(this.Ls),this.Zlt[i].effect=t}get onBeforeDrawParticlesObservable(){return this.$lt||(this.$lt=new h),this.$lt}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this.Yat[1^this.Ict]}get indexBuffer(){return null}YL(t,i,e){return super.YL(t,i,e),this.Oct(),this}addColorGradient(t,i){this.ML||(this.ML=[]);const e=new ew(t,i);return this.ML.push(e),this.Fct(!0),this.Oct(),this}Fct(t=!1){this.ML&&(t&&this.ML.sort(((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0)),this.Fat&&(this.Fat.dispose(),this.Fat=null))}forceRefreshGradients(){this.Fct(),this.Bct(this.bL,"_sizeGradientsTexture"),this.Bct(this.yL,"_angularSpeedGradientsTexture"),this.Bct(this.NL,"_velocityGradientsTexture"),this.Bct(this.PL,"_limitVelocityGradientsTexture"),this.Bct(this.DL,"_dragGradientsTexture"),this.reset()}removeColorGradient(t){return this.YL(t,this.ML,this.Fat),this.Fat=null,this}resetDrawCache(){var t;for(const i in this.vC){null===(t=this.vC[i].drawContext)||void 0===t||t.reset()}}rct(t,i,e){const s=new nw(i,e);t.push(s),this.Oct()}addSizeGradient(t,i){return this.bL||(this.bL=[]),this.rct(this.bL,t,i),this.Bct(this.bL,"_sizeGradientsTexture",!0),this.Oct(),this}removeSizeGradient(t){return this.YL(t,this.bL,this.Gat),this.Gat=null,this}Bct(t,i,e=!1){if(!t)return;e&&t.sort(((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0));const s=this;s[i]&&(s[i].dispose(),s[i]=null)}addAngularSpeedGradient(t,i){return this.yL||(this.yL=[]),this.rct(this.yL,t,i),this.Bct(this.yL,"_angularSpeedGradientsTexture",!0),this.Oct(),this}removeAngularSpeedGradient(t){return this.YL(t,this.yL,this.zat),this.zat=null,this}addVelocityGradient(t,i){return this.NL||(this.NL=[]),this.rct(this.NL,t,i),this.Bct(this.NL,"_velocityGradientsTexture",!0),this.Oct(),this}removeVelocityGradient(t){return this.YL(t,this.NL,this.Hat),this.Hat=null,this}addLimitVelocityGradient(t,i){return this.PL||(this.PL=[]),this.rct(this.PL,t,i),this.Bct(this.PL,"_limitVelocityGradientsTexture",!0),this.Oct(),this}removeLimitVelocityGradient(t){return this.YL(t,this.PL,this.Xat),this.Xat=null,this}addDragGradient(t,i){return this.DL||(this.DL=[]),this.rct(this.DL,t,i),this.Bct(this.DL,"_dragGradientsTexture",!0),this.Oct(),this}removeDragGradient(t){return this.YL(t,this.DL,this.Wat),this.Wat=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(t){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}HL(){this.Oct()}Jlt(t,i,e){const s={};s.position=i.createVertexBuffer("position",0,3,this.Uct,!0);let n=3;s.age=i.createVertexBuffer("age",n,1,this.Uct,!0),n+=1,s.size=i.createVertexBuffer("size",n,3,this.Uct,!0),n+=3,s.life=i.createVertexBuffer("life",n,1,this.Uct,!0),n+=1,n+=4,this.billboardMode===dw.BILLBOARDMODE_STRETCHED&&(s.direction=i.createVertexBuffer("direction",n,3,this.Uct,!0)),n+=3,this.yct.alignDataInBuffer&&(n+=1),this.particleEmitterType instanceof gr&&(n+=3,this.yct.alignDataInBuffer&&(n+=1)),this.Fat||(s.color=i.createVertexBuffer("color",n,4,this.Uct,!0),n+=4),this.kL||(s.initialDirection=i.createVertexBuffer("initialDirection",n,3,this.Uct,!0),n+=3,this.yct.alignDataInBuffer&&(n+=1)),this.noiseTexture&&(s.noiseCoordinates1=i.createVertexBuffer("noiseCoordinates1",n,3,this.Uct,!0),n+=3,this.yct.alignDataInBuffer&&(n+=1),s.noiseCoordinates2=i.createVertexBuffer("noiseCoordinates2",n,3,this.Uct,!0),n+=3,this.yct.alignDataInBuffer&&(n+=1)),s.angle=i.createVertexBuffer("angle",n,1,this.Uct,!0),this.zat?n++:n+=2,this.XL&&(s.cellIndex=i.createVertexBuffer("cellIndex",n,1,this.Uct,!0),n+=1,this.spriteRandomStartCell&&(s.cellStartOffset=i.createVertexBuffer("cellStartOffset",n,1,this.Uct,!0),n+=1)),s.offset=e.createVertexBuffer("offset",0,2),s.uv=e.createVertexBuffer("uv",2,2),this.Yat.push(s),this.yct.createVertexBuffers(t,s),this.resetDrawCache()}yj(t=!1){if(this.Vct&&!t)return;const i=this.Ls,e=new Array;this.Uct=21,this.Ict=0,this.yct.alignDataInBuffer&&(this.Uct+=1),this.particleEmitterType instanceof gr&&(this.Uct+=3,this.yct.alignDataInBuffer&&(this.Uct+=1)),this.isBillboardBased||(this.Uct+=3,this.yct.alignDataInBuffer&&(this.Uct+=1)),this.Fat&&(this.Uct-=4),this.zat&&(this.Uct-=1),this.XL&&(this.Uct+=1,this.spriteRandomStartCell&&(this.Uct+=1)),this.noiseTexture&&(this.Uct+=6,this.yct.alignDataInBuffer&&(this.Uct+=2)),this.yct.alignDataInBuffer&&(this.Uct+=3-(this.Uct+3&3));const s=this.particleEmitterType instanceof gr,n=M.Vector3[0];let r=0;for(let t=0;t<this.lK;t++)if(e.push(0),e.push(0),e.push(0),e.push(0),e.push(0),e.push(0),e.push(0),e.push(0),e.push(Math.random()),e.push(Math.random()),e.push(Math.random()),e.push(Math.random()),s?(this.particleEmitterType.particleDestinationGenerator(t,null,n),e.push(n.x),e.push(n.y),e.push(n.z)):(e.push(0),e.push(0),e.push(0)),this.yct.alignDataInBuffer&&e.push(0),r+=16,s&&(this.particleEmitterType.particlePositionGenerator(t,null,n),e.push(n.x),e.push(n.y),e.push(n.z),this.yct.alignDataInBuffer&&e.push(0),r+=4),this.Fat||(e.push(0),e.push(0),e.push(0),e.push(0),r+=4),this.isBillboardBased||(e.push(0),e.push(0),e.push(0),this.yct.alignDataInBuffer&&e.push(0),r+=4),this.noiseTexture&&(e.push(Math.random()),e.push(Math.random()),e.push(Math.random()),this.yct.alignDataInBuffer&&e.push(0),e.push(Math.random()),e.push(Math.random()),e.push(Math.random()),this.yct.alignDataInBuffer&&e.push(0),r+=8),e.push(0),r+=1,this.zat||(e.push(0),r+=1),this.XL&&(e.push(0),r+=1,this.spriteRandomStartCell&&(e.push(0),r+=1)),this.yct.alignDataInBuffer){let t=3-(r+3&3);for(r+=t;t-- >0;)e.push(0)}const h=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),o=this.yct.createParticleBuffer(e),a=this.yct.createParticleBuffer(e);this.Vct=new re(i,o,!1,this.Uct),this.kct=new re(i,a,!1,this.Uct),this.uct=new re(i,h,!1,4),this.Yat=[],this.Jlt(this.Vct,this.kct,this.uct),this.Jlt(this.kct,this.Vct,this.uct),this.Gct=this.Vct,this.zct=this.kct}Lct(){let t=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this.kL&&(t+="\n#define BILLBOARD"),this.Fat&&(t+="\n#define COLORGRADIENTS"),this.Gat&&(t+="\n#define SIZEGRADIENTS"),this.zat&&(t+="\n#define ANGULARSPEEDGRADIENTS"),this.Hat&&(t+="\n#define VELOCITYGRADIENTS"),this.Xat&&(t+="\n#define LIMITVELOCITYGRADIENTS"),this.Wat&&(t+="\n#define DRAGGRADIENTS"),this.isAnimationSheetEnabled&&(t+="\n#define ANIMATESHEET",this.spriteRandomStartCell&&(t+="\n#define ANIMATESHEETRANDOMSTART")),this.noiseTexture&&(t+="\n#define NOISE"),this.isLocal&&(t+="\n#define LOCAL"),!(!this.yct.isUpdateBufferCreated()||this.Hct!==t)||(this.Hct=t,this.Xct=this.yct.createUpdateBuffer(t),this.yct.isUpdateBufferReady())}Uat(t){const i=this.nct(t);if(null==i?void 0:i.effect)return i;const e=[];this.fillDefines(e,t);let s=this.vC[t];s||(s=new vi(this.Ls),s.drawContext&&(s.drawContext.useInstancing=!0),this.vC[t]=s);const n=e.join("\n");if(s.defines!==n){const t=[],i=[],e=[];this.fillUniformsAttributesAndSamplerNames(i,t,e),s.setEffect(this.Ls.createEffect("gpuRenderParticles",t,i,e,n),n)}return s}static Cct(t=!1,i=!1,e=!1,s=!1){const n=[he.PositionKind,"age","life","size","angle"];return t||n.push(he.ColorKind),i&&n.push("cellIndex"),e||n.push("initialDirection"),s||n.push("direction"),n.push("offset",he.UVKind),n}static wct(t=!1,i=!1){const e=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return Ns(e),t&&e.push("sheetInfos"),i&&e.push("logarithmicDepthConstant"),e}fillDefines(t,i=0){if(this.Kt&&Ps(this,this.Kt,t),i===dw.BLENDMODE_MULTIPLY&&t.push("#define BLENDMULTIPLYMODE"),this.isLocal&&t.push("#define LOCAL"),this.useLogarithmicDepth&&t.push("#define LOGARITHMICDEPTH"),this.kL)switch(t.push("#define BILLBOARD"),this.billboardMode){case dw.BILLBOARDMODE_Y:t.push("#define BILLBOARDY");break;case dw.BILLBOARDMODE_STRETCHED:t.push("#define BILLBOARDSTRETCHED");break;case dw.BILLBOARDMODE_ALL:t.push("#define BILLBOARDMODE_ALL")}this.Fat&&t.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&t.push("#define ANIMATESHEET"),this.Sg&&(this.Sg.prepareDefines(this.GL),t.push(""+this.GL.toString()))}fillUniformsAttributesAndSamplerNames(t,i,e){i.push(...ww.Cct(!!this.Fat,this.XL,this.kL,this.kL&&this.billboardMode===dw.BILLBOARDMODE_STRETCHED)),t.push(...ww.wct(this.XL,this.useLogarithmicDepth)),e.push("diffuseSampler","colorGradientSampler"),this.Sg&&(ji.PrepareUniforms(t,this.GL),ji.PrepareSamplers(e,this.GL))}animate(t=!1){var i;this.bct=this.updateSpeed*(t?this.preWarmStepOffset:(null===(i=this.Kt)||void 0===i?void 0:i.getAnimationRatio())||1),this.Vlt+=this.bct,this.pe||this.targetStopDuration&&this.Vlt>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this.HA()}Wct(t,i){const e=this[i];if(!t||!t.length||e)return;const s=new Float32Array(this.Xlt);for(let i=0;i<this.Xlt;i++){const e=i/this.Xlt;rw.GetCurrentGradient(e,t,((t,e,n)=>{s[i]=o.Lerp(t.factor1,e.factor1,n)}))}this[i]=fn.CreateRTexture(s,this.Xlt,1,this.Kt||this.Ls,!1,!1,1)}$ct(){this.Wct(this.bL,"_sizeGradientsTexture")}Yct(){this.Wct(this.yL,"_angularSpeedGradientsTexture")}jct(){this.Wct(this.NL,"_velocityGradientsTexture")}Kct(){this.Wct(this.PL,"_limitVelocityGradientsTexture")}qct(){this.Wct(this.DL,"_dragGradientsTexture")}Qct(){if(!this.ML||!this.ML.length||this.Fat)return;const t=new Uint8Array(4*this.Xlt),i=N.Color4[0];for(let e=0;e<this.Xlt;e++){const s=e/this.Xlt;rw.GetCurrentGradient(s,this.ML,((s,n,r)=>{y.LerpToRef(s.color1,n.color1,r,i),t[4*e]=255*i.r,t[4*e+1]=255*i.g,t[4*e+2]=255*i.b,t[4*e+3]=255*i.a}))}this.Fat=fn.CreateRGBATexture(t,this.Xlt,1,this.Kt,!1,!1,1)}IO(t,i){var e,s;const n=this.Uat(t),r=n.effect;this.Ls.enableEffect(n);const h=(null===(e=this.Kt)||void 0===e?void 0:e.getViewMatrix())||R.IdentityReadOnly;if(r.setMatrix("view",h),r.setMatrix("projection",null!==(s=this.defaultProjectionMatrix)&&void 0!==s?s:this.Kt.getProjectionMatrix()),r.setTexture("diffuseSampler",this.particleTexture),r.setVector2("translationPivot",this.translationPivot),r.setVector3("worldOffset",this.worldOffset),this.isLocal&&r.setMatrix("emitterWM",i),this.Fat?r.setTexture("colorGradientSampler",this.Fat):r.setDirectColor4("colorDead",this.colorDead),this.XL&&this.particleTexture){const t=this.particleTexture.getBaseSize();r.setFloat3("sheetInfos",this.spriteCellWidth/t.width,this.spriteCellHeight/t.height,t.width/this.spriteCellWidth)}if(this.kL&&this.Kt){const t=this.Kt.activeCamera;r.setVector3("eyePosition",t.globalPosition)}const o=r.defines;if(this.Kt&&Ds(r,this,this.Kt),o.indexOf("#define BILLBOARDMODE_ALL")>=0){const t=h.clone();t.invert(),r.setMatrix("invView",t)}switch(this.useLogarithmicDepth&&this.Kt&&Fs.BindLogDepth(o,r,this.Kt),this.Sg&&!this.Sg.applyByPostProcess&&this.Sg.bind(r),t){case dw.BLENDMODE_ADD:this.Ls.setAlphaMode(1);break;case dw.BLENDMODE_ONEONE:this.Ls.setAlphaMode(6);break;case dw.BLENDMODE_STANDARD:this.Ls.setAlphaMode(2);break;case dw.BLENDMODE_MULTIPLY:this.Ls.setAlphaMode(4)}return this.yct.bindDrawBuffers(this.Ict,r),this.$lt&&this.$lt.notifyObservers(r),this.Ls.drawArraysType(7,0,4,this.Pct),this.Ls.setAlphaMode(0),this.Pct}HA(t){if(!this.emitter)return;if(!this.Lct())return;if(this.emitter.position){t=this.emitter.getWorldMatrix()}else{const i=this.emitter;t=M.Matrix[0],R.TranslationToRef(i.x,i.y,i.z,t)}this.yct.preUpdateParticleBuffer(),this.Xct.setFloat("currentCount",this.Pct),this.Xct.setFloat("timeDelta",this.bct),this.Xct.setFloat("stopFactor",this.pe?0:1),this.Xct.setInt("randomTextureSize",this.Dct),this.Xct.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this.Xct.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this.Fat||(this.Xct.setDirectColor4("color1",this.color1),this.Xct.setDirectColor4("color2",this.color2)),this.Xct.setFloat2("sizeRange",this.minSize,this.maxSize),this.Xct.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this.Xct.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this.Xct.setVector3("gravity",this.gravity),this.Xat&&this.Xct.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this.Xct),this.XL&&this.Xct.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this.Xct.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this.Xct.setMatrix("emitterWM",t),this.yct.updateParticleBuffer(this.Ict,this.zct,this.Pct),this.Ict++,2===this.Ict&&(this.Ict=0);const i=this.Gct;this.Gct=this.zct,this.zct=i}render(t=!1,i=!1){if(!this.Ult)return 0;if(this.Qct(),this.$ct(),this.Yct(),this.jct(),this.Kct(),this.qct(),!this.isReady())return 0;if(!t&&this.Kt){if(!this._ct&&this.preWarmCycles){for(let t=0;t<this.preWarmCycles;t++)this.animate(!0),this.render(!0,!0);this._ct=!0}if(this.Ai===this.Kt.getFrameId()&&(!this.Kt.activeCamera||this.Kt.activeCamera&&this.Mct===this.Kt.activeCamera.uniqueId))return 0;this.Ai=this.Kt.getFrameId(),this.Kt.activeCamera&&(this.Mct=this.Kt.activeCamera.uniqueId)}if(this.yj(),this.Rct+=this.emitRate*this.bct,this.Rct>1){const t=0|this.Rct;this.Rct-=t,this.Pct=Math.min(this.Nct,this.Pct+t)}if(!this.Pct)return 0;let e;if(this.emitter.position){e=this.emitter.getWorldMatrix()}else{const t=this.emitter;e=M.Matrix[0],R.TranslationToRef(t.x,t.y,t.z,e)}const s=this.Ls;this.updateInAnimate||this.HA(e);let n=0;return t||i||(s.setState(!1),this.forceDepthWrite&&s.setDepthWrite(!0),n=this.blendMode===dw.BLENDMODE_MULTIPLYADD?this.IO(dw.BLENDMODE_MULTIPLY,e)+this.IO(dw.BLENDMODE_ADD,e):this.IO(this.blendMode,e),this.Ls.setAlphaMode(0)),n}rebuild(){this.yj(!0)}Oct(){this.Vct&&(this.Vct.dispose(),this.Vct=null),this.kct&&(this.kct.dispose(),this.kct=null),this.uct&&(this.uct.dispose(),this.uct=null),this.yct.releaseBuffers()}dispose(t=!0){for(const t in this.vC){this.vC[t].dispose()}if(this.vC={},this.Kt){const t=this.Kt.particleSystems.indexOf(this);t>-1&&this.Kt.particleSystems.splice(t,1)}this.Oct(),this.yct.releaseVertexBuffers();for(let t=0;t<this.Yat.length;++t){const i=this.Yat[t];for(const t in i)i[t].dispose()}this.Yat=[],this.Fat&&(this.Fat.dispose(),this.Fat=null),this.Gat&&(this.Gat.dispose(),this.Gat=null),this.zat&&(this.zat.dispose(),this.zat=null),this.Hat&&(this.Hat.dispose(),this.Hat=null),this.Xat&&(this.Xat.dispose(),this.Xat=null),this.Wat&&(this.Wat.dispose(),this.Wat=null),this.Vat&&(this.Vat.dispose(),this.Vat=null),this.kat&&(this.kat.dispose(),this.kat=null),t&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),t&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(t,i,e=!1){const s={...this.Zlt};let n=null;const r=this.Ls;if(r.createEffectForParticles&&null!=this.customShader){n=this.customShader;const t=n.shaderOptions.defines.length>0?n.shaderOptions.defines.join("\n"):"";s[0]=r.createEffectForParticles(n.shaderPath.fragmentElement,n.shaderOptions.uniforms,n.shaderOptions.samplers,t,void 0,void 0,void 0,this)}const h=this.serialize(e),o=ww.Parse(h,this.Kt||this.Ls,this.RL);return o.name=t,o.customShader=n,o.Zlt=s,void 0===i&&(i=this.emitter),this.noiseTexture&&(o.noiseTexture=this.noiseTexture.clone()),o.emitter=i,o}serialize(t=!1){const i={};return dw.Tct(i,this,t),i.activeParticleCount=this.activeParticleCount,i.randomTextureSize=this.Dct,i.customShader=this.customShader,i}static Parse(t,i,e,s=!1,n){const r=t.name;let h,o;i instanceof Ei?h=i:(o=i,h=o.getEngine());const a=new ww(r,{capacity:n||t.capacity,randomTextureSize:t.randomTextureSize},i,null,t.isAnimationSheetEnabled);if(a.RL=e,t.customShader&&h.createEffectForParticles){const i=t.customShader,e=i.shaderOptions.defines.length>0?i.shaderOptions.defines.join("\n"):"",s=h.createEffectForParticles(i.shaderPath.fragmentElement,i.shaderOptions.uniforms,i.shaderOptions.samplers,e,void 0,void 0,void 0,a);a.setCustomEffect(s,0),a.customShader=i}return t.id&&(a.id=t.id),t.activeParticleCount&&(a.activeParticleCount=t.activeParticleCount),dw.SL(t,a,i,e),t.preventAutoStart&&(a.preventAutoStart=t.preventAutoStart),s||a.preventAutoStart||a.start(),a}}class xw{constructor(){this.Zct=!0,this.systems=new Array}get emitterNode(){return this.Jct}set emitterNode(t){this.Zct&&this.Jct&&(this.Jct.dispose&&this.Jct.dispose(),this.Zct=!1);for(const i of this.systems)i.emitter=t;this.Jct=t}setEmitterAsSphere(t,i,e){this.Zct&&this.Jct&&this.Jct.dispose&&this.Jct.dispose(),this.Zct=!0,this.tut={kind:"Sphere",options:t,renderingGroupId:i};const s=Qc("emitterSphere",{diameter:t.diameter,segments:t.segments},e);s.renderingGroupId=i;const n=new sc("emitterSphereMaterial",e);n.emissiveColor=t.color,s.material=n;for(const t of this.systems)t.emitter=s;this.Jct=s}start(t){for(const i of this.systems)t&&(i.emitter=t),i.start()}dispose(){for(const t of this.systems)t.dispose();this.systems.length=0,this.Jct&&(this.Jct.dispose&&this.Jct.dispose(),this.Jct=null)}serialize(t=!1){const i={systems:[]};for(const e of this.systems)i.systems.push(e.serialize(t));return this.Jct&&(i.emitter=this.tut),i}static Parse(t,i,e=!1,s){const n=new xw,r=this.BaseAssetsUrl+"/textures/";i=i||E.LastCreatedScene;for(const h of t.systems)n.systems.push(e?ww.Parse(h,i,r,!0,s):dw.Parse(h,i,r,!0,s));if(t.emitter){const e=t.emitter.options;if("Sphere"===t.emitter.kind)n.setEmitterAsSphere({diameter:e.diameter,segments:e.segments,color:_.FromArray(e.color)},t.emitter.renderingGroupId,i)}return n}}xw.BaseAssetsUrl="https://assets.babylonjs.com/particles";class Tw{static CreateDefault(t,i=500,e,s=!1){let n;return n=s?new ww("default system",{capacity:i},e):new dw("default system",i,e),n.emitter=t,n.particleTexture=new an("https://assets.babylonjs.com/textures/flare.png",n.getScene()),n.createConeEmitter(.1,Math.PI/4),n.color1=new y(1,1,1,1),n.color2=new y(1,1,1,1),n.colorDead=new y(1,1,1,0),n.minSize=.1,n.maxSize=.1,n.minEmitPower=2,n.maxEmitPower=2,n.updateSpeed=1/60,n.emitRate=30,n}static CreateAsync(t,i,e=!1,s){i||(i=E.LastCreatedScene);const n={};return i.addPendingData(n),new Promise(((r,h)=>{if(e&&!ww.IsSupported)return i.removePendingData(n),h("Particle system with GPU is not supported.");ki.LoadFile(`${Tw.BaseAssetsUrl}/systems/${t}.json`,(t=>{i.removePendingData(n);const h=JSON.parse(t.toString());return r(xw.Parse(h,i,e,s))}),void 0,void 0,void 0,(()=>(i.removePendingData(n),h(`An error occurred with the creation of your particle system. Check if your type '${t}' exists.`))))}))}static ExportSet(t){const i=new xw;for(const e of t)i.systems.push(e);return i}static ParseFromFileAsync(t,i,e,s=!1,n="",r){return new Promise(((h,o)=>{const a=new mt;a.addEventListener("readystatechange",(()=>{if(4==a.readyState)if(200==a.status){const i=JSON.parse(a.responseText);let o;o=s?ww.Parse(i,e,n,!1,r):dw.Parse(i,e,n,!1,r),t&&(o.name=t),h(o)}else o("Unable to load the particle system")})),a.open("GET",i),a.send()}))}static ParseFromSnippetAsync(t,i,e=!1,s="",n){if("_BLANK"===t){const t=this.CreateDefault(null);return t.start(),Promise.resolve(t)}return new Promise(((r,h)=>{const o=new mt;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const h=JSON.parse(JSON.parse(o.responseText).jsonPayload),a=JSON.parse(h.particleSystem);let l;l=e?ww.Parse(a,i,s,!1,n):dw.Parse(a,i,s,!1,n),l.snippetId=t,r(l)}else h("Unable to load the snippet "+t)})),o.open("GET",this.SnippetUrl+"/"+t.replace(/#/g,"/")),o.send()}))}}Tw.BaseAssetsUrl=xw.BaseAssetsUrl,Tw.SnippetUrl="https://snippet.babylonjs.com",Tw.CreateFromSnippetAsync=Tw.ParseFromSnippetAsync,e.AddParser(fe.NAME_PARTICLESYSTEM,((t,i,s,n)=>{const r=e.GetIndividualParser(fe.NAME_PARTICLESYSTEM);if(r&&void 0!==t.particleSystems&&null!==t.particleSystems)for(let e=0,h=t.particleSystems.length;e<h;e++){const h=t.particleSystems[e];s.particleSystems.push(r(h,i,n))}})),e.AddIndividualParser(fe.NAME_PARTICLESYSTEM,((t,i,e)=>{if(t.activeParticleCount){return ww.Parse(t,i,e)}return dw.Parse(t,i,e)})),Rs.prototype.createEffectForParticles=function(t,i=[],e=[],s="",n,r,h,o){var a;let l=[],c=[];const u=[];return o?o.fillUniformsAttributesAndSamplerNames(c,l,u):(l=dw.Cct(),c=dw.wct()),-1===s.indexOf(" BILLBOARD")&&(s+="\n#define BILLBOARD\n"),-1===e.indexOf("diffuseSampler")&&e.push("diffuseSampler"),this.createEffect({vertex:null!==(a=null==o?void 0:o.vertexShaderName)&&void 0!==a?a:"particles",fragmentElement:t},l,c.concat(i),u.concat(e),s,n,r,h)},Ys.prototype.getEmittedParticleSystems=function(){const t=new Array;for(let i=0;i<this.getScene().particleSystems.length;i++){const e=this.getScene().particleSystems[i];e.emitter===this&&t.push(e)}return t},Ys.prototype.getHierarchyEmittedParticleSystems=function(){const t=new Array,i=this.getDescendants();i.push(this);for(let e=0;e<this.getScene().particleSystems.length;e++){const s=this.getScene().particleSystems[e],n=s.emitter;n.position&&-1!==i.indexOf(n)&&t.push(s)}return t};var Rw,Iw,Mw,bw,_w,yw,Nw,Pw;!function(t){t[t.Color=2]="Color",t[t.UV=1]="UV",t[t.Random=0]="Random",t[t.Stated=3]="Stated"}(Rw||(Rw={}));Object.defineProperty(ys.prototype,"physicsImpostor",{get:function(){return this.iut},set:function(t){this.iut!==t&&(this.eut&&this.onDisposeObservable.remove(this.eut),this.iut=t,t&&(this.eut=this.onDisposeObservable.add((()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)}))))},enumerable:!0,configurable:!0}),ys.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},ys.prototype.applyImpulse=function(t,i){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(t,i),this):this},ys.prototype.setPhysicsLinkWith=function(t,i,e,s){return this.physicsImpostor&&t.physicsImpostor?(this.physicsImpostor.createJoint(t.physicsImpostor,Tn.HingeJoint,{mainPivot:i,connectedPivot:e,nativeParams:s}),this):this};!function(t){t[t.Constant=0]="Constant",t[t.Linear=1]="Linear"}(Iw||(Iw={})),function(t){t[t.Center=0]="Center",t[t.Perpendicular=1]="Perpendicular"}(Mw||(Mw={}));class Dw{constructor(t,i=Dw.DefaultPluginFactory()){this.LN=i,this.sut=[],this.Ant=0,t=t||new w(0,-9.807,0),this.setGravity(t),this.setTimeStep()}getPluginVersion(){return this.LN.getPluginVersion()}static DefaultPluginFactory(){throw X("")}setGravity(t){this.gravity=t,this.LN.setGravity(this.gravity)}setTimeStep(t=1/60){this.LN.setTimeStep(t)}getTimeStep(){return this.LN.getTimeStep()}setSubTimeStep(t=0){this.Ant=t}getSubTimeStep(){return this.Ant}dispose(){this.LN.dispose()}getPhysicsPluginName(){return this.LN.name}wnt(t){t>.1?t=.1:t<=0&&(t=1/60),this.LN.executeStep(t,this.sut)}addBody(t){this.sut.push(t)}removeBody(t){const i=this.sut.indexOf(t);i>-1&&this.sut.splice(i,1)}getPhysicsPlugin(){return this.LN}raycastToRef(t,i,e){this.LN.raycast(t,i,e)}raycast(t,i){const e=new YE;return this.LN.raycast(t,i,e),e}}!function(t){t[t.FREE=0]="FREE",t[t.LIMITED=1]="LIMITED",t[t.LOCKED=2]="LOCKED",t[t.NONE=3]="NONE"}(bw||(bw={})),function(t){t[t.LINEAR_X=0]="LINEAR_X",t[t.LINEAR_Y=1]="LINEAR_Y",t[t.LINEAR_Z=2]="LINEAR_Z",t[t.ANGULAR_X=3]="ANGULAR_X",t[t.ANGULAR_Y=4]="ANGULAR_Y",t[t.ANGULAR_Z=5]="ANGULAR_Z",t[t.LINEAR_DISTANCE=6]="LINEAR_DISTANCE"}(_w||(_w={})),function(t){t[t.BALL_AND_SOCKET=0]="BALL_AND_SOCKET",t[t.DISTANCE=1]="DISTANCE",t[t.HINGE=2]="HINGE",t[t.SLIDER=3]="SLIDER",t[t.LOCK=4]="LOCK"}(yw||(yw={})),function(t){t[t.SPHERE=0]="SPHERE",t[t.CAPSULE=1]="CAPSULE",t[t.CYLINDER=2]="CYLINDER",t[t.BOX=3]="BOX",t[t.CONVEX_HULL=4]="CONVEX_HULL",t[t.CONTAINER=5]="CONTAINER",t[t.MESH=6]="MESH",t[t.HEIGHTFIELD=7]="HEIGHTFIELD"}(Nw||(Nw={})),function(t){t[t.NONE=0]="NONE",t[t.VELOCITY=1]="VELOCITY",t[t.POSITION=2]="POSITION"}(Pw||(Pw={}));ke.prototype.getPhysicsEngine=function(){return this.HN},ke.prototype.enablePhysics=function(t=null,i){if(this.HN)return!0;let e=this.Mg(fe.NAME_PHYSICSENGINE);e||(e=new Lw(this),this.Ig(e));try{if(i&&1!==(null==i?void 0:i.getPluginVersion())){if(2!==(null==i?void 0:i.getPluginVersion()))throw new Error("Unsupported Physics plugin version.");this.HN=new Dw(t,i)}else this.HN=new jE(t,i);return this.nut=0,!0}catch(t){return F.Error(t.message),!1}},ke.prototype.disablePhysicsEngine=function(){this.HN&&(this.HN.dispose(),this.HN=null)},ke.prototype.isPhysicsEnabled=function(){return void 0!==this.HN},ke.prototype.deleteCompoundImpostor=function(t){const i=t.parts[0].mesh;i.physicsImpostor&&(i.physicsImpostor.dispose(),i.physicsImpostor=null)},ke.prototype.MS=function(t){if(this.HN){const i=this.HN.getSubTimeStep();if(i>0)for(this.nut+=t;this.nut>i;)this.onBeforePhysicsObservable.notifyObservers(this),this.HN.wnt(i/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this.nut-=i;else this.onBeforePhysicsObservable.notifyObservers(this),this.HN.wnt(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class Lw{constructor(t){this.name=fe.NAME_PHYSICSENGINE,this.scene=t,this.scene.onBeforePhysicsObservable=new h,this.scene.onAfterPhysicsObservable=new h,this.scene.getDeterministicFrameTime=()=>this.scene.HN?1e3*this.scene.HN.getTimeStep():1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene.HN&&this.scene.disablePhysicsEngine()}}const Ow="blackAndWhitePixelShader",Fw="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float degree;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nvec3 color=texture2D(textureSampler,vUV).rgb;\nfloat luminance=dot(color,vec3(0.3,0.59,0.11)); \nvec3 blackAndWhite=vec3(luminance,luminance,luminance);\ngl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);\n}";ii.ShadersStore[Ow]=Fw;class Bw extends nr{constructor(t,i,e,s,n,r){super(t,"blackAndWhite",["degree"],null,i,e,s,n,r),this.degree=1,this.onApplyObservable.add((t=>{t.setFloat("degree",this.degree)}))}getClassName(){return"BlackAndWhitePostProcess"}static SL(t,i,e,s){return ot.Parse((()=>new Bw(t.name,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.reusable)),t,e,s)}}ut([Q()],Bw.prototype,"degree",void 0),v("BABYLON.BlackAndWhitePostProcess",Bw);class Uw{constructor(t,i,e,s){this.hn=i,this.rut=s||!0,this.hut=e,this.out={},this.aut={},this.vf={}}get isSupported(){for(const t in this.vf)if(Object.prototype.hasOwnProperty.call(this.vf,t)){const i=this.vf[t];for(let t=0;t<i.length;t++)if(!i[t].isSupported)return!1}return!0}HA(){}lut(t){let i;const e=ki.MakeArray(t||this.out);if(e)for(let t=0;t<e.length;t++){const s=e[t];if(!s)continue;const n=s.name;if(i=this.rut?0:n,!this.vf[i]){const t=this.hut();t&&(this.vf[i]=Array.isArray(t)?t:[t])}this.aut[n]||(this.aut[n]=[]),this.vf[i].forEach((t=>{const i=s.attachPostProcess(t);this.aut[n].push(i)})),this.out[n]||(this.out[n]=s)}}cut(t){const i=ki.MakeArray(t||this.out);if(i)for(let t=0;t<i.length;t++){const e=i[t],s=e.name,n=this.vf[this.rut?0:s];n&&n.forEach((t=>{e.detachPostProcess(t)})),this.out[s]&&(this.out[s]=null)}}iW(t){const i=ki.MakeArray(t||this.out);if(i)for(let t=0;t<i.length;t++){const e=i[t],s=e.name;for(let n=0;n<this.aut[s].length;n++)void 0!==e.vf[this.aut[s][n]]&&null!==e.vf[this.aut[s][n]]||this.vf[this.rut?0:s].forEach((e=>{i[t].attachPostProcess(e,this.aut[s][n])}))}}uut(t){const i=ki.MakeArray(t||this.out);if(i)for(let t=0;t<i.length;t++){const e=i[t],s=e.name;this.vf[this.rut?0:s].forEach((t=>{e.detachPostProcess(t)}))}}getPostProcesses(t){return this.rut?this.vf[0]:t?this.vf[t.name]:null}}const Vw="extractHighlightsPixelShader",kw="#include<helperFunctions>\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float threshold;\nuniform float exposure;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\nfloat luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);\ngl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;\n}";ii.ShadersStore[Vw]=kw;class Gw extends nr{constructor(t,i,e,s,n,r,h=0,o=!1){super(t,"extractHighlights",["threshold","exposure"],null,i,e,s,n,r,null,h,void 0,null,o),this.threshold=.9,this.Ec=1,this.fut=null,this.onApplyObservable.add((t=>{this.externalTextureSamplerBinding=!!this.fut,this.fut&&t.setTextureFromPostProcess("textureSampler",this.fut),t.setFloat("threshold",Math.pow(this.threshold,a)),t.setFloat("exposure",this.Ec)}))}getClassName(){return"ExtractHighlightsPostProcess"}}ut([Q()],Gw.prototype,"threshold",void 0),v("BABYLON.ExtractHighlightsPostProcess",Gw);const zw="bloomMergePixelShader",Hw="uniform sampler2D textureSampler;\nuniform sampler2D bloomBlur;\nvarying vec2 vUV;\nuniform float bloomWeight;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\ngl_FragColor=texture2D(textureSampler,vUV);\nvec3 blurred=texture2D(bloomBlur,vUV).rgb;\ngl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); \n}\n";ii.ShadersStore[zw]=Hw;class Xw extends nr{constructor(t,i,e,s,n,r,h,o,a,l=0,c=!1){super(t,"bloomMerge",["bloomWeight"],["bloomBlur"],n,r,h,o,a,null,l,void 0,null,!0),this.weight=1,this.weight=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((t=>{t.setTextureFromPostProcess("textureSampler",i),t.setTextureFromPostProcessOutput("bloomBlur",e),t.setFloat("bloomWeight",this.weight)})),c||this.updateEffect()}getClassName(){return"BloomMergePostProcess"}}ut([Q()],Xw.prototype,"weight",void 0),v("BABYLON.BloomMergePostProcess",Xw);class Ww extends Uw{constructor(t,i,e,s,n=0,r=!1){super(t.getEngine(),"bloom",(()=>this.dut),!0),this.mut=i,this.dut=[],this.vut=new Gw("highlights",1,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,n,r),this.x5=new xm("horizontal blur",new C(1,0),10,i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,n,void 0,r),this.x5.alwaysForcePOT=!0,this.x5.autoClear=!1,this.T5=new xm("vertical blur",new C(0,1),10,i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,n,void 0,r),this.T5.alwaysForcePOT=!0,this.T5.autoClear=!1,this.kernel=s,this.dut=[this.vut,this.x5,this.T5],this.gut=new Xw("bloomMerge",this.vut,this.T5,e,i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,n,r),this.gut.autoClear=!1,this.dut.push(this.gut)}get threshold(){return this.vut.threshold}set threshold(t){this.vut.threshold=t}get weight(){return this.gut.weight}set weight(t){this.gut.weight=t}get kernel(){return this.x5.kernel/this.mut}set kernel(t){this.x5.kernel=t*this.mut,this.T5.kernel=t*this.mut}disposeEffects(t){for(let i=0;i<this.dut.length;i++)this.dut[i].dispose(t)}Sut(){for(let t=0;t<this.dut.length;t++)this.dut[t].updateEffect()}di(){for(let t=0;t<this.dut.length;t++)if(!this.dut[t].isReady())return!1;return!0}}const $w="chromaticAberrationPixelShader",Yw="uniform sampler2D textureSampler; \nuniform float chromatic_aberration;\nuniform float radialIntensity;\nuniform vec2 direction;\nuniform vec2 centerPosition;\nuniform float screen_width;\nuniform float screen_height;\nvarying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);\nvec2 directionOfEffect=direction;\nif(directionOfEffect.x==0. && directionOfEffect.y==0.){\ndirectionOfEffect=normalize(centered_screen_pos);\n}\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+ centered_screen_pos.y*centered_screen_pos.y;\nfloat radius=sqrt(radius2);\nvec4 original=texture2D(textureSampler,vUV);\nvec3 ref_indices=vec3(-0.3,0.0,0.3);\nfloat ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;\nfloat ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;\nvec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);\nvec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);\nvec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);\noriginal.r=texture2D(textureSampler,ref_coords_r).r;\noriginal.g=texture2D(textureSampler,ref_coords_g).g;\noriginal.b=texture2D(textureSampler,ref_coords_b).b;\noriginal.a=clamp(texture2D(textureSampler,ref_coords_r).a+texture2D(textureSampler,ref_coords_g).a+texture2D(textureSampler,ref_coords_b).a,0.,1.);\ngl_FragColor=original;\n}";ii.ShadersStore[$w]=Yw;class jw extends nr{constructor(t,i,e,s,n,r,h,o,a=0,l=!1){super(t,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],s,n,r,h,o,null,a,void 0,null,l),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new C(.707,.707),this.centerPosition=new C(.5,.5),this.screenWidth=i,this.screenHeight=e,this.onApplyObservable.add((t=>{t.setFloat("chromatic_aberration",this.aberrationAmount),t.setFloat("screen_width",i),t.setFloat("screen_height",e),t.setFloat("radialIntensity",this.radialIntensity),t.setFloat2("direction",this.direction.x,this.direction.y),t.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)}))}getClassName(){return"ChromaticAberrationPostProcess"}static SL(t,i,e,s){return ot.Parse((()=>new jw(t.name,t.screenWidth,t.screenHeight,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.reusable,t.textureType,!1)),t,e,s)}}ut([Q()],jw.prototype,"aberrationAmount",void 0),ut([Q()],jw.prototype,"radialIntensity",void 0),ut([Q()],jw.prototype,"direction",void 0),ut([Q()],jw.prototype,"centerPosition",void 0),ut([Q()],jw.prototype,"screenWidth",void 0),ut([Q()],jw.prototype,"screenHeight",void 0),v("BABYLON.ChromaticAberrationPostProcess",jw);const Kw="circleOfConfusionPixelShader",qw="uniform sampler2D depthSampler;\nvarying vec2 vUV;\nuniform vec2 cameraMinMaxZ;\nuniform float focusDistance;\nuniform float cocPrecalculation;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat depth=texture2D(depthSampler,vUV).r;\n#define CUSTOM_COC_DEPTH\nfloat pixelDistance=(cameraMinMaxZ.x+cameraMinMaxZ.y*depth)*1000.0; \n#define CUSTOM_COC_PIXELDISTANCE\nfloat coc=abs(cocPrecalculation*((focusDistance-pixelDistance)/pixelDistance));\ncoc=clamp(coc,0.0,1.0);\ngl_FragColor=vec4(coc,coc,coc,1.0);\n}\n";ii.ShadersStore[Kw]=qw;class Qw extends nr{constructor(t,i,e,s,n,r,h,o=0,a=!1){super(t,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],e,s,n,r,h,null,o,void 0,null,a),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50,this.t3=null,this.t3=i,this.onApplyObservable.add((t=>{if(!this.t3)return void F.Warn("No depth texture set on CircleOfConfusionPostProcess");t.setTexture("depthSampler",this.t3);const i=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);t.setFloat("focusDistance",this.focusDistance),t.setFloat("cocPrecalculation",i);const e=this.t3.activeCamera;t.setFloat2("cameraMinMaxZ",e.minZ,e.maxZ-e.minZ)}))}getClassName(){return"CircleOfConfusionPostProcess"}set depthTexture(t){this.t3=t}}ut([Q()],Qw.prototype,"lensSize",void 0),ut([Q()],Qw.prototype,"fStop",void 0),ut([Q()],Qw.prototype,"focusDistance",void 0),ut([Q()],Qw.prototype,"focalLength",void 0),v("BABYLON.CircleOfConfusionPostProcess",Qw);const Zw="colorCorrectionPixelShader",Jw="uniform sampler2D textureSampler; \nuniform sampler2D colorTable; \nvarying vec2 vUV;\nconst float SLICE_COUNT=16.0; \nvec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {\nfloat sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);\nfloat zSlice1=min(zSlice0+1.0,width-1.0);\nfloat xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;\nfloat s0=xOffset+(zSlice0*sliceSize);\nfloat s1=xOffset+(zSlice1*sliceSize);\nvec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));\nvec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));\nfloat zOffset=mod(uv.z*width,1.0);\nvec4 result=mix(slice0Color,slice1Color,zOffset);\nreturn result;\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 screen_color=texture2D(textureSampler,vUV);\ngl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);\n}";ii.ShadersStore[Zw]=Jw;class tx extends nr{constructor(t,i,e,s,n,r,h){super(t,"colorCorrection",null,["colorTable"],e,s,n,r,h);const o=(null==s?void 0:s.getScene())||null;this.Eut=new an(i,o,!0,!1,an.TRILINEAR_SAMPLINGMODE),this.Eut.anisotropicFilteringLevel=1,this.Eut.wrapU=an.CLAMP_ADDRESSMODE,this.Eut.wrapV=an.CLAMP_ADDRESSMODE,this.colorTableUrl=i,this.onApply=t=>{t.setTexture("colorTable",this.Eut)}}getClassName(){return"ColorCorrectionPostProcess"}static SL(t,i,e,s){return ot.Parse((()=>new tx(t.name,t.colorTableUrl,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.reusable)),t,e,s)}}ut([Q()],tx.prototype,"colorTableUrl",void 0),v("BABYLON.ColorCorrectionPostProcess",tx);const ix="convolutionPixelShader",ex="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform float kernel[9];\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec2 onePixel=vec2(1.0,1.0)/screenSize;\nvec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];\nfloat kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];\nif (kernelWeight<=0.0) {\nkernelWeight=1.0;\n}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);\n}";ii.ShadersStore[ix]=ex;class sx extends nr{constructor(t,i,e,s,n,r,h,o=0){super(t,"convolution",["kernel","screenSize"],null,e,s,n,r,h,null,o),this.kernel=i,this.onApply=t=>{t.setFloat2("screenSize",this.width,this.height),t.setArray("kernel",this.kernel)}}getClassName(){return"ConvolutionPostProcess"}static SL(t,i,e,s){return ot.Parse((()=>new sx(t.name,t.kernel,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.reusable,t.textureType)),t,e,s)}}sx.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],sx.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],sx.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],sx.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],sx.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],sx.GaussianKernel=[0,1,0,1,1,1,0,1,0],ut([Q()],sx.prototype,"kernel",void 0),v("BABYLON.ConvolutionPostProcess",sx);class nx extends xm{constructor(t,i,e,s,n,r,h,o=null,a=an.BILINEAR_SAMPLINGMODE,l,c,u=0,f=!1,d=5){super(t,e,s,n,r,2,l,c,u,"#define DOF 1\r\n",f,d),this.direction=e,this.externalTextureSamplerBinding=!!o,this.onApplyObservable.add((t=>{null!=o&&t.setTextureFromPostProcess("textureSampler",o),t.setTextureFromPostProcessOutput("circleOfConfusionSampler",h)}))}getClassName(){return"DepthOfFieldBlurPostProcess"}}ut([Q()],nx.prototype,"direction",void 0),v("BABYLON.DepthOfFieldBlurPostProcess",nx);const rx="depthOfFieldMergePixelShader",hx="uniform sampler2D textureSampler;\nvarying vec2 vUV;\nuniform sampler2D circleOfConfusionSampler;\nuniform sampler2D blurStep0;\n#if BLUR_LEVEL>0\nuniform sampler2D blurStep1;\n#endif\n#if BLUR_LEVEL>1\nuniform sampler2D blurStep2;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat coc=texture2D(circleOfConfusionSampler,vUV).r;\n#if BLUR_LEVEL==0\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred0=texture2D(blurStep0,vUV);\ngl_FragColor=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL==1\nif(coc<0.5){\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(original,blurred1,coc/0.5);\n}else{\nvec4 blurred0=texture2D(blurStep0,vUV);\nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);\n}\n#endif\n#if BLUR_LEVEL==2\nif(coc<0.33){\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred2=texture2D(blurStep2,vUV);\ngl_FragColor=mix(original,blurred2,coc/0.33);\n}else if(coc<0.66){\nvec4 blurred1=texture2D(blurStep1,vUV);\nvec4 blurred2=texture2D(blurStep2,vUV);\ngl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);\n}else{\nvec4 blurred0=texture2D(blurStep0,vUV);\nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);\n}\n#endif\n}\n";ii.ShadersStore[rx]=hx;class ox extends nr{constructor(t,i,e,s,n,r,h,o,a,l=0,c=!1){super(t,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],n,r,h,o,a,null,l,void 0,null,!0),this.Aut=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((t=>{t.setTextureFromPostProcess("textureSampler",i),t.setTextureFromPostProcessOutput("circleOfConfusionSampler",e),s.forEach(((i,e)=>{t.setTextureFromPostProcessOutput("blurStep"+(s.length-e-1),i)}))})),c||this.updateEffect()}getClassName(){return"DepthOfFieldMergePostProcess"}updateEffect(t=null,i=null,e=null,s,n,r){t||(t="",t+="#define BLUR_LEVEL "+(this.Aut.length-1)+"\n"),super.updateEffect(t,i,e,s,n,r)}}var ax;!function(t){t[t.Low=0]="Low",t[t.Medium=1]="Medium",t[t.High=2]="High"}(ax||(ax={}));class lx extends Uw{constructor(t,i,e=ax.Low,s=0,n=!1){super(t.getEngine(),"depth of field",(()=>this.dut),!0),this.dut=[];const r=t.getEngine(),h=r.isWebGPU||r.webGLVersion>1?6:5;this.Cut=new Qw("circleOfConfusion",i,1,null,an.BILINEAR_SAMPLINGMODE,r,!1,s,n),this.wut=[],this.xut=[];let o=1,a=15;switch(e){case ax.High:o=3,a=51;break;case ax.Medium:o=2,a=31;break;default:a=15,o=1}const l=a/Math.pow(2,o-1);let c=1;for(let i=0;i<o;i++){const e=new nx("vertical blur",t,new C(0,1),l,c,null,this.Cut,0==i?this.Cut:null,an.BILINEAR_SAMPLINGMODE,r,!1,s,n,0==i?h:5);e.autoClear=!1,c=.75/Math.pow(2,i);const o=new nx("horizontal blur",t,new C(1,0),l,c,null,this.Cut,null,an.BILINEAR_SAMPLINGMODE,r,!1,s,n);o.autoClear=!1,this.wut.push(e),this.xut.push(o)}this.dut=[this.Cut];for(let t=0;t<this.xut.length;t++)this.dut.push(this.wut[t]),this.dut.push(this.xut[t]);this.Tut=new ox("dofMerge",this.Cut,this.Cut,this.xut,c,null,an.BILINEAR_SAMPLINGMODE,r,!1,s,n),this.Tut.autoClear=!1,this.dut.push(this.Tut)}set focalLength(t){this.Cut.focalLength=t}get focalLength(){return this.Cut.focalLength}set fStop(t){this.Cut.fStop=t}get fStop(){return this.Cut.fStop}set focusDistance(t){this.Cut.focusDistance=t}get focusDistance(){return this.Cut.focusDistance}set lensSize(t){this.Cut.lensSize=t}get lensSize(){return this.Cut.lensSize}getClassName(){return"DepthOfFieldEffect"}set depthTexture(t){this.Cut.depthTexture=t}disposeEffects(t){for(let i=0;i<this.dut.length;i++)this.dut[i].dispose(t)}Sut(){for(let t=0;t<this.dut.length;t++)this.dut[t].updateEffect()}di(){for(let t=0;t<this.dut.length;t++)if(!this.dut[t].isReady())return!1;return!0}}const cx="displayPassPixelShader",ux="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D passSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\ngl_FragColor=texture2D(passSampler,vUV);\n}";ii.ShadersStore[cx]=ux;class fx extends nr{getClassName(){return"DisplayPassPostProcess"}constructor(t,i,e,s,n,r){super(t,"displayPass",["passSampler"],["passSampler"],i,e,s,n,r)}static SL(t,i,e,s){return ot.Parse((()=>new fx(t.name,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.reusable)),t,e,s)}}v("BABYLON.DisplayPassPostProcess",fx);const dx="filterPixelShader",px="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform mat4 kernelMatrix;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec3 baseColor=texture2D(textureSampler,vUV).rgb;\nvec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;\ngl_FragColor=vec4(updatedColor,1.0);\n}";ii.ShadersStore[dx]=px;class mx extends nr{constructor(t,i,e,s,n,r,h){super(t,"filter",["kernelMatrix"],null,e,s,n,r,h),this.kernelMatrix=i,this.onApply=t=>{t.setMatrix("kernelMatrix",this.kernelMatrix)}}getClassName(){return"FilterPostProcess"}static SL(t,i,e,s){return ot.Parse((()=>new mx(t.name,t.kernelMatrix,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.reusable)),t,e,s)}}ut([ht()],mx.prototype,"kernelMatrix",void 0),v("BABYLON.FilterPostProcess",mx);const vx="fxaaPixelShader",gx="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nuniform sampler2D textureSampler;\nuniform vec2 texelSize;\nvarying vec2 vUV;\nvarying vec2 sampleCoordS;\nvarying vec2 sampleCoordE;\nvarying vec2 sampleCoordN;\nvarying vec2 sampleCoordW;\nvarying vec2 sampleCoordNW;\nvarying vec2 sampleCoordSE;\nvarying vec2 sampleCoordNE;\nvarying vec2 sampleCoordSW;\nconst float fxaaQualitySubpix=1.0;\nconst float fxaaQualityEdgeThreshold=0.166;\nconst float fxaaQualityEdgeThresholdMin=0.0833;\nconst vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);\n#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)\nvoid main(){\nvec2 posM;\nposM.x=vUV.x;\nposM.y=vUV.y;\nvec4 rgbyM=TEXTUREFUNC(textureSampler,vUV,0.0);\nfloat lumaM=FxaaLuma(rgbyM);\nfloat lumaS=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordS,0.0));\nfloat lumaE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordE,0.0));\nfloat lumaN=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordN,0.0));\nfloat lumaW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordW,0.0));\nfloat maxSM=max(lumaS,lumaM);\nfloat minSM=min(lumaS,lumaM);\nfloat maxESM=max(lumaE,maxSM);\nfloat minESM=min(lumaE,minSM);\nfloat maxWN=max(lumaN,lumaW);\nfloat minWN=min(lumaN,lumaW);\nfloat rangeMax=max(maxWN,maxESM);\nfloat rangeMin=min(minWN,minESM);\nfloat rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;\nfloat range=rangeMax-rangeMin;\nfloat rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\n#ifndef MALI\nif(range<rangeMaxClamped) \n{\ngl_FragColor=rgbyM;\nreturn;\n}\n#endif\nfloat lumaNW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNW,0.0));\nfloat lumaSE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSE,0.0));\nfloat lumaNE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNE,0.0));\nfloat lumaSW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSW,0.0));\nfloat lumaNS=lumaN+lumaS;\nfloat lumaWE=lumaW+lumaE;\nfloat subpixRcpRange=1.0/range;\nfloat subpixNSWE=lumaNS+lumaWE;\nfloat edgeHorz1=(-2.0*lumaM)+lumaNS;\nfloat edgeVert1=(-2.0*lumaM)+lumaWE;\nfloat lumaNESE=lumaNE+lumaSE;\nfloat lumaNWNE=lumaNW+lumaNE;\nfloat edgeHorz2=(-2.0*lumaE)+lumaNESE;\nfloat edgeVert2=(-2.0*lumaN)+lumaNWNE;\nfloat lumaNWSW=lumaNW+lumaSW;\nfloat lumaSWSE=lumaSW+lumaSE;\nfloat edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);\nfloat edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);\nfloat edgeHorz3=(-2.0*lumaW)+lumaNWSW;\nfloat edgeVert3=(-2.0*lumaS)+lumaSWSE;\nfloat edgeHorz=abs(edgeHorz3)+edgeHorz4;\nfloat edgeVert=abs(edgeVert3)+edgeVert4;\nfloat subpixNWSWNESE=lumaNWSW+lumaNESE;\nfloat lengthSign=texelSize.x;\nbool horzSpan=edgeHorz>=edgeVert;\nfloat subpixA=subpixNSWE*2.0+subpixNWSWNESE;\nif (!horzSpan)\n{\nlumaN=lumaW;\n}\nif (!horzSpan) \n{\nlumaS=lumaE;\n}\nif (horzSpan) \n{\nlengthSign=texelSize.y;\n}\nfloat subpixB=(subpixA*(1.0/12.0))-lumaM;\nfloat gradientN=lumaN-lumaM;\nfloat gradientS=lumaS-lumaM;\nfloat lumaNN=lumaN+lumaM;\nfloat lumaSS=lumaS+lumaM;\nbool pairN=abs(gradientN)>=abs(gradientS);\nfloat gradient=max(abs(gradientN),abs(gradientS));\nif (pairN)\n{\nlengthSign=-lengthSign;\n}\nfloat subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);\nvec2 posB;\nposB.x=posM.x;\nposB.y=posM.y;\nvec2 offNP;\noffNP.x=(!horzSpan) ? 0.0 : texelSize.x;\noffNP.y=(horzSpan) ? 0.0 : texelSize.y;\nif (!horzSpan) \n{\nposB.x+=lengthSign*0.5;\n}\nif (horzSpan)\n{\nposB.y+=lengthSign*0.5;\n}\nvec2 posN;\nposN.x=posB.x-offNP.x*1.5;\nposN.y=posB.y-offNP.y*1.5;\nvec2 posP;\nposP.x=posB.x+offNP.x*1.5;\nposP.y=posB.y+offNP.y*1.5;\nfloat subpixD=((-2.0)*subpixC)+3.0;\nfloat lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN,0.0));\nfloat subpixE=subpixC*subpixC;\nfloat lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP,0.0));\nif (!pairN) \n{\nlumaNN=lumaSS;\n}\nfloat gradientScaled=gradient*1.0/4.0;\nfloat lumaMM=lumaM-lumaNN*0.5;\nfloat subpixF=subpixD*subpixE;\nbool lumaMLTZero=lumaMM<0.0;\nlumaEndN-=lumaNN*0.5;\nlumaEndP-=lumaNN*0.5;\nbool doneN=abs(lumaEndN)>=gradientScaled;\nbool doneP=abs(lumaEndP)>=gradientScaled;\nif (!doneN) \n{\nposN.x-=offNP.x*3.0;\n}\nif (!doneN) \n{\nposN.y-=offNP.y*3.0;\n}\nbool doneNP=(!doneN) || (!doneP);\nif (!doneP) \n{\nposP.x+=offNP.x*3.0;\n}\nif (!doneP)\n{\nposP.y+=offNP.y*3.0;\n}\nif (doneNP)\n{\nif (!doneN) lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN.xy,0.0));\nif (!doneP) lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP.xy,0.0));\nif (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;\nif (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;\ndoneN=abs(lumaEndN)>=gradientScaled;\ndoneP=abs(lumaEndP)>=gradientScaled;\nif (!doneN) posN.x-=offNP.x*12.0;\nif (!doneN) posN.y-=offNP.y*12.0;\ndoneNP=(!doneN) || (!doneP);\nif (!doneP) posP.x+=offNP.x*12.0;\nif (!doneP) posP.y+=offNP.y*12.0;\n}\nfloat dstN=posM.x-posN.x;\nfloat dstP=posP.x-posM.x;\nif (!horzSpan)\n{\ndstN=posM.y-posN.y;\n}\nif (!horzSpan) \n{\ndstP=posP.y-posM.y;\n}\nbool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;\nfloat spanLength=(dstP+dstN);\nbool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;\nfloat spanLengthRcp=1.0/spanLength;\nbool directionN=dstN<dstP;\nfloat dst=min(dstN,dstP);\nbool goodSpan=directionN ? goodSpanN : goodSpanP;\nfloat subpixG=subpixF*subpixF;\nfloat pixelOffset=(dst*(-spanLengthRcp))+0.5;\nfloat subpixH=subpixG*fxaaQualitySubpix;\nfloat pixelOffsetGood=goodSpan ? pixelOffset : 0.0;\nfloat pixelOffsetSubpix=max(pixelOffsetGood,subpixH);\nif (!horzSpan)\n{\nposM.x+=pixelOffsetSubpix*lengthSign;\n}\nif (horzSpan)\n{\nposM.y+=pixelOffsetSubpix*lengthSign;\n}\n#ifdef MALI\nif(range<rangeMaxClamped) \n{\ngl_FragColor=rgbyM;\n}\nelse\n{\ngl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);\n}\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);\n#endif\n}";ii.ShadersStore[vx]=gx;const Sx="fxaaVertexShader",Ex="attribute vec2 position;\nuniform vec2 texelSize;\nvarying vec2 vUV;\nvarying vec2 sampleCoordS;\nvarying vec2 sampleCoordE;\nvarying vec2 sampleCoordN;\nvarying vec2 sampleCoordW;\nvarying vec2 sampleCoordNW;\nvarying vec2 sampleCoordSE;\nvarying vec2 sampleCoordNE;\nvarying vec2 sampleCoordSW;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd);\nsampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;\nsampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;\nsampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;\nsampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;\nsampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;\nsampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;\nsampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;\nsampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[Sx]=Ex;class Ax extends nr{getClassName(){return"FxaaPostProcess"}constructor(t,i,e=null,s,n,r,h=0){super(t,"fxaa",["texelSize"],null,i,e,s||an.BILINEAR_SAMPLINGMODE,n,r,null,h,"fxaa",void 0,!0);const o=this.ZO();this.updateEffect(o),this.onApplyObservable.add((t=>{const i=this.texelSize;t.setFloat2("texelSize",i.x,i.y)}))}ZO(){const t=this.getEngine();if(!t)return null;const i=t.getGlInfo();return i&&i.renderer&&i.renderer.toLowerCase().indexOf("mali")>-1?"#define MALI 1\n":null}static SL(t,i,e,s){return ot.Parse((()=>new Ax(t.name,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.reusable)),t,e,s)}}v("BABYLON.FxaaPostProcess",Ax);const Cx="grainPixelShader",wx="#include<helperFunctions>\nuniform sampler2D textureSampler; \nuniform float intensity;\nuniform float animatedSeed;\nvarying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\ngl_FragColor=texture2D(textureSampler,vUV);\nvec2 seed=vUV*(animatedSeed);\nfloat grain=dither(seed,intensity);\nfloat lum=getLuminance(gl_FragColor.rgb);\nfloat grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;\ngl_FragColor.rgb+=grain*grainAmount;\ngl_FragColor.rgb=max(gl_FragColor.rgb,0.0);\n}";ii.ShadersStore[Cx]=wx;class xx extends nr{constructor(t,i,e,s,n,r,h=0,o=!1){super(t,"grain",["intensity","animatedSeed"],[],i,e,s,n,r,null,h,void 0,null,o),this.intensity=30,this.animated=!1,this.onApplyObservable.add((t=>{t.setFloat("intensity",this.intensity),t.setFloat("animatedSeed",this.animated?Math.random()+1:1)}))}getClassName(){return"GrainPostProcess"}static SL(t,i,e,s){return ot.Parse((()=>new xx(t.name,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.reusable)),t,e,s)}}ut([Q()],xx.prototype,"intensity",void 0),ut([Q()],xx.prototype,"animated",void 0),v("BABYLON.GrainPostProcess",xx);const Tx="highlightsPixelShader",Rx="varying vec2 vUV;\nuniform sampler2D textureSampler;\nconst vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nvec4 tex=texture2D(textureSampler,vUV);\nvec3 c=tex.rgb;\nfloat luma=dot(c.rgb,RGBLuminanceCoefficients);\ngl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); \n}";ii.ShadersStore[Tx]=Rx;const Ix="mrtFragmentDeclaration",Mx="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n";ii.IncludesShadersStore[Ix]=Mx;const bx="geometryPixelShader",_x="#extension GL_EXT_draw_buffers : require\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n#ifdef BUMP\nvarying mat4 vWorldView;\nvarying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#ifdef VELOCITY\nvarying vec4 vCurrentPosition;\nvarying vec4 vPreviousPosition;\n#endif\n#ifdef NEED_UV\nvarying vec2 vUV;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nuniform sampler2D reflectivitySampler;\nvarying vec2 vReflectivityUV;\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vec2 vAlbedoUV;\nuniform sampler2D albedoSampler;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform vec3 reflectivityColor;\n#endif\n#ifdef ALBEDOCOLOR\nuniform vec3 albedoColor;\n#endif\n#ifdef METALLIC\nuniform float metallic;\n#endif\n#ifdef ROUGHNESS\nuniform float glossiness;\n#endif\n#endif\n#ifdef ALPHATEST\nuniform sampler2D diffuseSampler;\n#endif\n#include<mrtFragmentDeclaration>[RENDER_TARGET_COUNT]\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\nvoid main() {\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nvec3 normalOutput;\n#ifdef BUMP\nvec3 normalW=normalize(vNormalW);\n#include<bumpFragment>\nnormalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));\n#else\nnormalOutput=normalize(vNormalV);\n#endif\n#ifdef PREPASS\n#ifdef PREPASS_DEPTH\ngl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef PREPASS_NORMAL\ngl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);\n#endif\n#else\ngl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\ngl_FragData[1]=vec4(normalOutput,1.0);\n#endif\n#ifdef POSITION\ngl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;\nvec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;\nvec2 velocity=abs(a-b);\nvelocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;\ngl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvec4 reflectivity=vec4(1.0,1.0,1.0,1.0);\n#ifdef METALLICWORKFLOW\nfloat metal=1.0;\nfloat roughness=1.0;\n#ifdef ORMTEXTURE\nmetal*=texture2D(reflectivitySampler,vReflectivityUV).b;\nroughness*=texture2D(reflectivitySampler,vReflectivityUV).g;\n#endif\n#ifdef METALLIC\nmetal*=metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-glossiness); \n#endif\nreflectivity.a-=roughness;\nvec3 color=vec3(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=texture2D(albedoSampler,vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpace(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=albedoColor.xyz;\n#endif\nreflectivity.rgb=mix(vec3(0.04),color,metal);\n#else\n#ifdef SPECULARGLOSSINESSTEXTURE\nreflectivity=texture2D(reflectivitySampler,vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity.rgb=toLinearSpace(reflectivity.rgb);\n#endif\n#ifdef GLOSSINESSS\nreflectivity.a*=glossiness;\n#endif\n#else \n#ifdef REFLECTIVITYTEXTURE\nreflectivity.rbg=texture2D(reflectivitySampler,vReflectivityUV).rbg;\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity.rgb=toLinearSpace(reflectivity.rgb);\n#endif\n#else\n#ifdef REFLECTIVITYCOLOR\nreflectivity.rgb=reflectivityColor.xyz;\nreflectivity.a=1.0;\n#endif\n#endif \n#ifdef GLOSSINESSS\nreflectivity.a=glossiness; \n#else\nreflectivity.a=1.0; \n#endif\n#endif\n#endif\nreflectivity.rgb=toGammaSpace(reflectivity.rgb); \ngl_FragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n}\n";ii.ShadersStore[bx]=_x;const yx="geometryVertexDeclaration",Nx="uniform mat4 viewProjection;\nuniform mat4 view;";ii.IncludesShadersStore[yx]=Nx;const Px="geometryUboDeclaration",Dx="#include<sceneUboDeclaration>\n";ii.IncludesShadersStore[Px]=Dx;const Lx="geometryVertexShader",Ox="precision highp float;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<__decl__geometryVertex>\nattribute vec3 position;\nattribute vec3 normal;\n#ifdef NEED_UV\nvarying vec2 vUV;\n#ifdef ALPHATEST\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef BUMP\nuniform mat4 bumpMatrix;\nvarying vec2 vBumpUV;\n#endif\n#ifdef REFLECTIVITY\nuniform mat4 reflectivityMatrix;\nuniform mat4 albedoMatrix;\nvarying vec2 vReflectivityUV;\nvarying vec2 vAlbedoUV;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef BUMP\nvarying mat4 vWorldView;\n#endif\n#ifdef BUMP\nvarying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#ifdef VELOCITY\nuniform mat4 previousViewProjection;\nvarying vec4 vCurrentPosition;\nvarying vec4 vPreviousPosition;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\nvec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 pos=vec4(finalWorld*vec4(positionUpdated,1.0));\n#ifdef BUMP\nvWorldView=view*finalWorld;\nvNormalW=normalUpdated;\n#else\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));\n#endif\nvViewPos=view*pos;\n#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;\npreviousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvPositionW=pos.xyz/pos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#else\nvUV=uv;\n#endif\n#ifdef BUMP_UV1\nvBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV1\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV1\nvAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#else\nvUV=uv2;\n#endif\n#ifdef BUMP_UV2\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV2\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV2\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";ii.ShadersStore[Lx]=Ox;class Fx{constructor(t,i=1,e=15){this.Rut={},this.Iut={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.cO=null,this.Mut=!1,this.but=!1,this._ut=!1,this.yut=-1,this.Nut=-1,this.Put=-1,this.Dut=-1,this.Lut=-1,this.Out=!1,this.Kt=t,this.Fut=i,this.But=t.getEngine().supportsUniformBuffers,this.Uut=e,Fx.qM(this.Kt),this.Vut()}kut(t){this.Out=!0,this.Gut=t,this.zut&&(this.zut.onClearObservable.clear(),this.zut.onClearObservable.add((()=>{})))}Hut(){this.Out=!1,this.Vut()}Xut(){this.Mut=!1,this._ut=!1,this.but=!1,this.OD=[]}Wut(t,i){t===Fx.POSITION_TEXTURE_TYPE?(this.yut=i,this.Mut=!0):t===Fx.VELOCITY_TEXTURE_TYPE?(this.Nut=i,this.but=!0):t===Fx.REFLECTIVITY_TEXTURE_TYPE?(this.Put=i,this._ut=!0):t===Fx.DEPTH_TEXTURE_TYPE?this.Dut=i:t===Fx.NORMAL_TEXTURE_TYPE&&(this.Lut=i)}$ut(t){this.OD=t}Yut(t){this.zut.setInternalTexture(t,0,!1)}get renderList(){return this.zut.renderList}set renderList(t){this.zut.renderList=t}get isSupported(){return this.zut.isSupported}getTextureIndex(t){switch(t){case Fx.POSITION_TEXTURE_TYPE:return this.yut;case Fx.VELOCITY_TEXTURE_TYPE:return this.Nut;case Fx.REFLECTIVITY_TEXTURE_TYPE:return this.Put;default:return-1}}get enablePosition(){return this.Mut}set enablePosition(t){this.Mut=t,this.Out||(this.dispose(),this.Vut())}get enableVelocity(){return this.but}set enableVelocity(t){this.but=t,t||(this.Rut={}),this.Out||(this.dispose(),this.Vut()),this.Kt.needsPreviousWorldMatrices=t}get enableReflectivity(){return this._ut}set enableReflectivity(t){this._ut=t,this.Out||(this.dispose(),this.Vut())}get scene(){return this.Kt}get ratio(){return this.Fut}isReady(t,i){const e=t.getMaterial();if(e&&e.disableDepthWrite)return!1;const s=[],n=[he.PositionKind,he.NormalKind],r=t.getMesh();if(e){let t=!1;if(e.needAlphaTesting()&&e.getAlphaTestTexture()&&(s.push("#define ALPHATEST"),s.push(`#define ALPHATEST_UV${e.getAlphaTestTexture().coordinatesIndex+1}`),t=!0),e.bumpTexture&&Bo.BumpTextureEnabled&&(s.push("#define BUMP"),s.push(`#define BUMP_UV${e.bumpTexture.coordinatesIndex+1}`),t=!0),this._ut){let i=!1;"PBRMetallicRoughnessMaterial"===e.getClassName()?(null!==e.metallicRoughnessTexture&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${e.metallicRoughnessTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),t=!0,i=!0),null!==e.metallic&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),i=!0),null!==e.roughness&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),i=!0),i&&(null!==e.baseTexture&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${e.baseTexture.coordinatesIndex+1}`),e.baseTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),t=!0),null!==e.baseColor&&s.push("#define ALBEDOCOLOR"))):"PBRSpecularGlossinessMaterial"===e.getClassName()?(null!==e.specularGlossinessTexture?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${e.specularGlossinessTexture.coordinatesIndex+1}`),t=!0,e.specularGlossinessTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE")):null!==e.specularColor&&s.push("#define REFLECTIVITYCOLOR"),null!==e.glossiness&&s.push("#define GLOSSINESSS")):"PBRMaterial"===e.getClassName()?(null!==e.metallicTexture&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${e.metallicTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),t=!0,i=!0),null!==e.metallic&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),i=!0),null!==e.roughness&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),i=!0),i?(null!==e.albedoTexture&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${e.albedoTexture.coordinatesIndex+1}`),e.albedoTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),t=!0),null!==e.albedoColor&&s.push("#define ALBEDOCOLOR")):(null!==e.reflectivityTexture?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${e.reflectivityTexture.coordinatesIndex+1}`),e.reflectivityTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),t=!0):null!==e.reflectivityColor&&s.push("#define REFLECTIVITYCOLOR"),null!==e.microSurface&&s.push("#define GLOSSINESSS"))):"StandardMaterial"===e.getClassName()&&(null!==e.specularTexture&&(s.push("#define REFLECTIVITYTEXTURE"),s.push(`#define REFLECTIVITY_UV${e.specularTexture.coordinatesIndex+1}`),e.specularTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),t=!0),null!==e.specularColor&&s.push("#define REFLECTIVITYCOLOR"))}t&&(s.push("#define NEED_UV"),r.isVerticesDataPresent(he.UVKind)&&(n.push(he.UVKind),s.push("#define UV1")),r.isVerticesDataPresent(he.UV2Kind)&&(n.push(he.UV2Kind),s.push("#define UV2")))}this.Out&&(s.push("#define PREPASS"),-1!==this.Dut&&(s.push("#define DEPTH_INDEX "+this.Dut),s.push("#define PREPASS_DEPTH")),-1!==this.Lut&&(s.push("#define NORMAL_INDEX "+this.Lut),s.push("#define PREPASS_NORMAL"))),this.Mut&&(s.push("#define POSITION"),s.push("#define POSITION_INDEX "+this.yut)),this.but&&(s.push("#define VELOCITY"),s.push("#define VELOCITY_INDEX "+this.Nut),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(r)&&s.push("#define BONES_VELOCITY_ENABLED")),this._ut&&(s.push("#define REFLECTIVITY"),s.push("#define REFLECTIVITY_INDEX "+this.Put)),r.useBones&&r.computeBonesUsingShaders?(n.push(he.MatricesIndicesKind),n.push(he.MatricesWeightsKind),r.numBoneInfluencers>4&&(n.push(he.MatricesIndicesExtraKind),n.push(he.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),s.push("#define BonesPerMesh "+(r.skeleton?r.skeleton.bones.length+1:0))):s.push("#define NUM_BONE_INFLUENCERS 0");const h=r.morphTargetManager;let o=0;h&&h.numInfluencers>0&&(o=h.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+o),h.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),Fs.PrepareAttributesForMorphTargetsInfluencers(n,r,o)),i&&(s.push("#define INSTANCES"),Fs.PushAttributesForInstances(n,this.but),t.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES")),this.Out?s.push("#define RENDER_TARGET_COUNT "+this.OD.length):s.push("#define RENDER_TARGET_COUNT "+this.zut.textures.length);const a=this.Kt.getEngine(),l=t.mC(void 0,!0),c=l.defines,u=s.join("\n");return c!==u&&l.setEffect(a.createEffect("geometry",{attributes:n,uniformsNames:["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"],samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets"],defines:u,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this.zut.textures.length-1,maxSimultaneousMorphTargets:o}},a),u),l.effect.isReady()}getGBuffer(){return this.zut}get samples(){return this.zut.samples}set samples(t){this.zut.samples=t}dispose(){if(this.cO){this.Kt.getEngine().onResizeObservable.remove(this.cO),this.cO=null}this.getGBuffer().dispose()}jut(){const t=[];let i=2;return t.push("gBuffer_Depth","gBuffer_Normal"),this.Mut&&(this.yut=i,i++,t.push("gBuffer_Position")),this.but&&(this.Nut=i,i++,t.push("gBuffer_Velocity")),this._ut&&(this.Put=i,i++,t.push("gBuffer_Reflectivity")),[i,t]}Vut(){const t=this.Kt.getEngine(),[i,e]=this.jut();let s=0;if(t.po.textureFloat&&t.po.textureFloatLinearFiltering?s=1:t.po.textureHalfFloat&&t.po.textureHalfFloatLinearFiltering&&(s=2),this.zut=new _A("gBuffer",{width:t.getRenderWidth()*this.Fut,height:t.getRenderHeight()*this.Fut},i,this.Kt,{generateMipMaps:!1,generateDepthTexture:!0,defaultType:s,depthTextureFormat:this.Uut},e.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this.zut.wrapU=an.CLAMP_ADDRESSMODE,this.zut.wrapV=an.CLAMP_ADDRESSMODE,this.zut.refreshRate=1,this.zut.renderParticles=!1,this.zut.renderList=null,this.zut.onClearObservable.add((t=>{t.clear(new y(0,0,0,0),!0,!0,!0)})),this.cO=t.onResizeObservable.add((()=>{this.zut&&this.zut.resize({width:t.getRenderWidth()*this.Fut,height:t.getRenderHeight()*this.Fut})}));const n=t=>{const i=t.getRenderingMesh(),e=t.getEffectiveMesh(),s=this.Kt,n=s.getEngine(),r=t.getMaterial();if(!r)return;if(e._m.ET=!1,this.but&&!this.Rut[e.uniqueId]&&(this.Rut[e.uniqueId]={world:R.Identity(),viewProjection:s.getTransformMatrix()},i.skeleton)){const t=i.skeleton.getTransformMatrices(i);this.Iut[i.uniqueId]=this.Kut(t,new Float32Array(t.length))}const h=i.KI(t.Al,!!t.getReplacementMesh());if(h.mustReturn)return;const o=n.getCaps().instancedArrays&&(null!==h.visibleInstances[t.Al]||i.hasThinInstances),a=e.getWorldMatrix();if(this.isReady(t,o)){const l=t.mC();if(!l)return;const c=l.effect;if(n.enableEffect(l),o||i.$C(t,c,r.fillMode),this.But?(Fs.BindSceneUniformBuffer(c,this.Kt.getSceneUniformBuffer()),this.Kt.finalizeSceneUbo()):(c.setMatrix("viewProjection",s.getTransformMatrix()),c.setMatrix("view",s.getViewMatrix())),r){let t;const n=i.bI;if(n.isFrozen||!r.backFaceCulling&&null===i.overrideMaterialSideOrientation)t=n.sideOrientation;else{const s=e.zi();t=i.overrideMaterialSideOrientation,null===t&&(t=r.sideOrientation),s<0&&(t=t===Vs.ClockWiseSideOrientation?Vs.CounterClockWiseSideOrientation:Vs.ClockWiseSideOrientation)}if(r.QR(l,t),r.needAlphaTesting()){const t=r.getAlphaTestTexture();t&&(c.setTexture("diffuseSampler",t),c.setMatrix("diffuseMatrix",t.getTextureMatrix()))}r.bumpTexture&&s.getEngine().getCaps().standardDerivatives&&Bo.BumpTextureEnabled&&(c.setFloat3("vBumpInfos",r.bumpTexture.coordinatesIndex,1/r.bumpTexture.level,r.parallaxScaleBias),c.setMatrix("bumpMatrix",r.bumpTexture.getTextureMatrix()),c.setTexture("bumpSampler",r.bumpTexture),c.setFloat2("vTangentSpaceParams",r.invertNormalMapX?-1:1,r.invertNormalMapY?-1:1)),this._ut&&("PBRMetallicRoughnessMaterial"===r.getClassName()?(null!==r.metallicRoughnessTexture&&(c.setTexture("reflectivitySampler",r.metallicRoughnessTexture),c.setMatrix("reflectivityMatrix",r.metallicRoughnessTexture.getTextureMatrix())),null!==r.metallic&&c.setFloat("metallic",r.metallic),null!==r.roughness&&c.setFloat("glossiness",1-r.roughness),null!==r.baseTexture&&(c.setTexture("albedoSampler",r.baseTexture),c.setMatrix("albedoMatrix",r.baseTexture.getTextureMatrix())),null!==r.baseColor&&c.setColor3("albedoColor",r.baseColor)):"PBRSpecularGlossinessMaterial"===r.getClassName()?(null!==r.specularGlossinessTexture?(c.setTexture("reflectivitySampler",r.specularGlossinessTexture),c.setMatrix("reflectivityMatrix",r.specularGlossinessTexture.getTextureMatrix())):null!==r.specularColor&&c.setColor3("reflectivityColor",r.specularColor),null!==r.glossiness&&c.setFloat("glossiness",r.glossiness)):"PBRMaterial"===r.getClassName()?(null!==r.metallicTexture&&(c.setTexture("reflectivitySampler",r.metallicTexture),c.setMatrix("reflectivityMatrix",r.metallicTexture.getTextureMatrix())),null!==r.metallic&&c.setFloat("metallic",r.metallic),null!==r.roughness&&c.setFloat("glossiness",1-r.roughness),null!==r.roughness||null!==r.metallic||null!==r.metallicTexture?(null!==r.albedoTexture&&(c.setTexture("albedoSampler",r.albedoTexture),c.setMatrix("albedoMatrix",r.albedoTexture.getTextureMatrix())),null!==r.albedoColor&&c.setColor3("albedoColor",r.albedoColor)):(null!==r.reflectivityTexture?(c.setTexture("reflectivitySampler",r.reflectivityTexture),c.setMatrix("reflectivityMatrix",r.reflectivityTexture.getTextureMatrix())):null!==r.reflectivityColor&&c.setColor3("reflectivityColor",r.reflectivityColor),null!==r.microSurface&&c.setFloat("glossiness",r.microSurface))):"StandardMaterial"===r.getClassName()&&(null!==r.specularTexture&&(c.setTexture("reflectivitySampler",r.specularTexture),c.setMatrix("reflectivityMatrix",r.specularTexture.getTextureMatrix())),null!==r.specularColor&&c.setColor3("reflectivityColor",r.specularColor)))}i.useBones&&i.computeBonesUsingShaders&&i.skeleton&&(c.setMatrices("mBones",i.skeleton.getTransformMatrices(i)),this.but&&c.setMatrices("mPreviousBones",this.Iut[i.uniqueId])),Fs.BindMorphTargetParameters(i,c),i.morphTargetManager&&i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager.$C(c),this.but&&(c.setMatrix("previousWorld",this.Rut[e.uniqueId].world),c.setMatrix("previousViewProjection",this.Rut[e.uniqueId].viewProjection)),o&&i.hasThinInstances&&c.setMatrix("world",a),i.eM(e,t,c,r.fillMode,h,o,((t,i)=>{t||c.setMatrix("world",i)}))}this.but&&(this.Rut[e.uniqueId].world=a.clone(),this.Rut[e.uniqueId].viewProjection=this.Kt.getTransformMatrix().clone(),i.skeleton&&this.Kut(i.skeleton.getTransformMatrices(i),this.Iut[e.uniqueId]))};this.zut.customIsReadyFunction=(i,e,s)=>{if((s||0===e)&&i.subMeshes)for(let e=0;e<i.subMeshes.length;++e){const s=i.subMeshes[e],n=s.getMaterial(),r=s.getRenderingMesh();if(!n)continue;const h=r.KI(s.Al,!!s.getReplacementMesh()),o=t.getCaps().instancedArrays&&(null!==h.visibleInstances[s.Al]||r.hasThinInstances);if(!this.isReady(s,o))return!1}return!0},this.zut.customRenderFunction=(i,e,s,r)=>{let h;if(this.Out){if(!this.Gut.enabled)return;this.Kt.getEngine().bindAttachments(this.OD)}if(r.length){for(t.setColorWrite(!1),h=0;h<r.length;h++)n(r.data[h]);t.setColorWrite(!0)}for(h=0;h<i.length;h++)n(i.data[h]);for(t.setDepthWrite(!1),h=0;h<e.length;h++)n(e.data[h]);if(this.renderTransparentMeshes)for(h=0;h<s.length;h++)n(s.data[h]);t.setDepthWrite(!0)}}Kut(t,i){for(let e=0;e<t.length;e++)i[e]=t[e];return i}}Fx.DEPTH_TEXTURE_TYPE=0,Fx.NORMAL_TEXTURE_TYPE=1,Fx.POSITION_TEXTURE_TYPE=2,Fx.VELOCITY_TEXTURE_TYPE=3,Fx.REFLECTIVITY_TEXTURE_TYPE=4,Fx.qM=t=>{throw X("GeometryBufferRendererSceneComponent")};class Bx{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}Object.defineProperty(ke.prototype,"geometryBufferRenderer",{get:function(){return this.qut},set:function(t){t&&t.isSupported&&(this.qut=t)},enumerable:!0,configurable:!0}),ke.prototype.enableGeometryBufferRenderer=function(t=1,i=15){return this.qut||(this.qut=new Fx(this,t,i),this.qut.isSupported||(this.qut=null)),this.qut},ke.prototype.disableGeometryBufferRenderer=function(){this.qut&&(this.qut.dispose(),this.qut=null)};class Ux{constructor(t){this.name=fe.NAME_GEOMETRYBUFFERRENDERER,this.scene=t}register(){this.scene.zv.registerStep(fe.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this.xst)}rebuild(){}dispose(){}xst(t){this.scene.qut&&t.push(this.scene.qut.getGBuffer())}}Fx.qM=t=>{let i=t.Mg(fe.NAME_GEOMETRYBUFFERRENDERER);i||(i=new Ux(t),t.Ig(i))};const Vx="motionBlurPixelShader",kx="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float motionStrength;\nuniform float motionScale;\nuniform vec2 screenSize;\n#ifdef OBJECT_BASED\nuniform sampler2D velocitySampler;\n#else\nuniform sampler2D depthSampler;\nuniform mat4 inverseViewProjection;\nuniform mat4 prevViewProjection;\nuniform mat4 projection;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#ifdef GEOMETRY_SUPPORTED\n#ifdef OBJECT_BASED\nvec2 texelSize=1.0/screenSize;\nvec4 velocityColor=texture2D(velocitySampler,vUV);\nvelocityColor.rg=velocityColor.rg*2.0-vec2(1.0);\nvec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;\nvelocity*=motionScale*motionStrength;\nfloat speed=length(velocity/texelSize);\nint samplesCount=int(clamp(speed,1.0,SAMPLES));\nvelocity=normalize(velocity)*texelSize;\nfloat hlim=float(-samplesCount)*0.5+0.5;\nvec4 result=texture2D(textureSampler,vUV);\nfor (int i=1; i<int(SAMPLES); ++i)\n{\nif (i>=samplesCount)\nbreak;\nvec2 offset=vUV+velocity*(hlim+float(i));\nresult+=texture2D(textureSampler,offset);\n}\ngl_FragColor=result/float(samplesCount);\ngl_FragColor.a=1.0;\n#else\nvec2 texelSize=1.0/screenSize;\nfloat depth=texture2D(depthSampler,vUV).r;\ndepth=projection[2].z+projection[3].z/depth; \nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);\ncpos=inverseViewProjection*cpos;\ncpos/=cpos.w;\nvec4 ppos=prevViewProjection*cpos;\nppos/=ppos.w;\nppos.xy=ppos.xy*0.5+0.5;\nvec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;\nfloat speed=length(velocity/texelSize);\nint nSamples=int(clamp(speed,1.0,SAMPLES));\nvec4 result=texture2D(textureSampler,vUV);\nfor (int i=1; i<int(SAMPLES); ++i) {\nif (i>=nSamples)\nbreak;\nvec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\nresult+=texture2D(textureSampler,offset1);\n}\ngl_FragColor=result/float(nSamples);\n#endif\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";ii.ShadersStore[Vx]=kx;class Gx extends nr{constructor(t,i,e,s,n,r,h,o=0,a=!1,l=!1){super(t,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"],["velocitySampler","depthSampler"],e,s,n,r,h,"#define GEOMETRY_SUPPORTED\n#define SAMPLES 64.0\n#define OBJECT_BASED",o,void 0,null,a),this.motionStrength=1,this.Qut=32,this.Zut=!0,this.Jut=!1,this.tft=null,this.ift=null,this.Jut=l,this.Jut?(i.enableGeometryBufferRenderer(),this.qut&&(this.qut.enableVelocity=!0)):(i.enablePrePassRenderer(),this.Gut&&(this.Gut.markAsDirty(),this.gL=new Bx)),this.eft()}get motionBlurSamples(){return this.Qut}set motionBlurSamples(t){this.Qut=t,this.Oat()}get isObjectBased(){return this.Zut}set isObjectBased(t){this.Zut!==t&&(this.Zut=t,this.eft())}get qut(){return this.Jut?this.Kt.geometryBufferRenderer:null}get Gut(){return this.Jut?null:this.Kt.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}excludeSkinnedMesh(t){if(t.skeleton){let i;if(this.qut)i=this.qut.excludedSkinnedMeshesFromVelocity;else{if(!this.Gut)return;i=this.Gut.excludedSkinnedMesh}i.push(t)}}removeExcludedSkinnedMesh(t){if(t.skeleton){let i;if(this.qut)i=this.qut.excludedSkinnedMeshesFromVelocity;else{if(!this.Gut)return;i=this.Gut.excludedSkinnedMesh}const e=i.indexOf(t);-1!==e&&i.splice(e,1)}}dispose(t){this.qut&&(this.qut.Rut={},this.qut.Iut={},this.qut.excludedSkinnedMeshesFromVelocity=[]),super.dispose(t)}eft(){if(!this.qut&&!this.Gut)return F.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this.Oat(),this.tft=null,this.ift=null,this.isObjectBased?(this.Gut&&this.gL&&(this.gL.texturesRequired[0]=2),this.onApply=t=>this.sft(t)):(this.tft=R.Identity(),this.ift=this.Kt.getTransformMatrix().clone(),this.Gut&&this.gL&&(this.gL.texturesRequired[0]=5),this.onApply=t=>this.nft(t))}sft(t){if(t.setVector2("screenSize",new C(this.width,this.height)),t.setFloat("motionScale",this.Kt.getAnimationRatio()),t.setFloat("motionStrength",this.motionStrength),this.qut){const i=this.qut.getTextureIndex(Fx.VELOCITY_TEXTURE_TYPE);t.setTexture("velocitySampler",this.qut.getGBuffer().textures[i])}else if(this.Gut){const i=this.Gut.getIndex(2);t.setTexture("velocitySampler",this.Gut.getRenderTarget().textures[i])}}nft(t){const i=M.Matrix[0];if(i.copyFrom(this.Kt.getTransformMatrix()),i.invertToRef(this.tft),t.setMatrix("inverseViewProjection",this.tft),t.setMatrix("prevViewProjection",this.ift),this.ift.copyFrom(i),t.setMatrix("projection",this.Kt.getProjectionMatrix()),t.setVector2("screenSize",new C(this.width,this.height)),t.setFloat("motionScale",this.Kt.getAnimationRatio()),t.setFloat("motionStrength",this.motionStrength),this.qut){const i=this.qut.getTextureIndex(Fx.DEPTH_TEXTURE_TYPE);t.setTexture("depthSampler",this.qut.getGBuffer().textures[i])}else if(this.Gut){const i=this.Gut.getIndex(5);t.setTexture("depthSampler",this.Gut.getRenderTarget().textures[i])}}Oat(){if(this.qut||this.Gut){const t=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this.Qut.toFixed(1),this.Zut?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(t.join("\n"))}}static SL(t,i,e,s){return ot.Parse((()=>new Gx(t.name,e,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.reusable,t.textureType,!1)),t,e,s)}}ut([Q()],Gx.prototype,"motionStrength",void 0),ut([Q()],Gx.prototype,"motionBlurSamples",null),ut([Q()],Gx.prototype,"isObjectBased",null),v("BABYLON.MotionBlurPostProcess",Gx);const zx="refractionPixelShader",Hx="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D refractionSampler;\nuniform vec3 baseColor;\nuniform float depth;\nuniform float colorLevel;\nvoid main() {\nfloat ref=1.0-texture2D(refractionSampler,vUV).r;\nvec2 uv=vUV-vec2(0.5);\nvec2 offset=uv*depth*ref;\nvec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;\ngl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);\n}";ii.ShadersStore[zx]=Hx;class Xx extends nr{constructor(t,i,e,s,n,r,h,o,a,l){super(t,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],r,h,o,a,l),this.rft=!0,this.color=e,this.depth=s,this.colorLevel=n,this.refractionTextureUrl=i,this.onActivateObservable.add((t=>{this.hft=this.hft||new an(i,t.getScene())})),this.onApplyObservable.add((t=>{t.setColor3("baseColor",this.color),t.setFloat("depth",this.depth),t.setFloat("colorLevel",this.colorLevel),t.setTexture("refractionSampler",this.hft)}))}get refractionTexture(){return this.hft}set refractionTexture(t){this.hft&&this.rft&&this.hft.dispose(),this.hft=t,this.rft=!1}getClassName(){return"RefractionPostProcess"}dispose(t){this.hft&&this.rft&&(this.hft.dispose(),this.hft=null),super.dispose(t)}static SL(t,i,e,s){return ot.Parse((()=>new Xx(t.name,t.refractionTextureUrl,t.color,t.depth,t.colorLevel,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.reusable)),t,e,s)}}ut([Q()],Xx.prototype,"color",void 0),ut([Q()],Xx.prototype,"depth",void 0),ut([Q()],Xx.prototype,"colorLevel",void 0),ut([Q()],Xx.prototype,"refractionTextureUrl",void 0),v("BABYLON.RefractionPostProcess",Xx);const Wx="sharpenPixelShader",$x="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform vec2 sharpnessAmounts;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec2 onePixel=vec2(1.0,1.0)/screenSize;\nvec4 color=texture2D(textureSampler,vUV);\nvec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1)) -\ncolor*4.0;\ngl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);\n}";ii.ShadersStore[Wx]=$x;class Yx extends nr{constructor(t,i,e,s,n,r,h=0,o=!1){super(t,"sharpen",["sharpnessAmounts","screenSize"],null,i,e,s,n,r,null,h,void 0,null,o),this.colorAmount=1,this.edgeAmount=.3,this.onApply=t=>{t.setFloat2("screenSize",this.width,this.height),t.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}getClassName(){return"SharpenPostProcess"}static SL(t,i,e,s){return ot.Parse((()=>new Yx(t.name,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.textureType,t.reusable)),t,e,s)}}ut([Q()],Yx.prototype,"colorAmount",void 0),ut([Q()],Yx.prototype,"edgeAmount",void 0),v("BABYLON.SharpenPostProcess",Yx);class jx{constructor(t,i){this.Ls=t,this.hn=i,this.fit={},this.oft=new Array,this.out=[]}get name(){return this.hn}get cameras(){return this.out}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const t in this.fit)if(Object.prototype.hasOwnProperty.call(this.fit,t)&&!this.fit[t].isSupported)return!1;return!0}addEffect(t){this.fit[t.hn]=t}br(){}aft(t,i){const e=this.fit[t];e&&e.iW(ki.MakeArray(i||this.out))}lft(t,i){const e=this.fit[t];e&&e.uut(ki.MakeArray(i||this.out))}lut(t,i){const e=ki.MakeArray(t||this.out);if(!e)return;const s=[];let n;for(n=0;n<e.length;n++){const t=e[n];t&&(-1===this.out.indexOf(t)?this.out.push(t):i&&s.push(n))}for(n=0;n<s.length;n++)e.splice(s[n],1);for(const t in this.fit)Object.prototype.hasOwnProperty.call(this.fit,t)&&this.fit[t].lut(e)}cut(t){const i=ki.MakeArray(t||this.out);if(i){for(const t in this.fit)Object.prototype.hasOwnProperty.call(this.fit,t)&&this.fit[t].cut(i);for(let t=0;t<i.length;t++)this.out.splice(this.out.indexOf(i[t]),1)}}HA(){for(const t in this.fit)Object.prototype.hasOwnProperty.call(this.fit,t)&&this.fit[t].HA();for(let t=0;t<this.out.length;t++){if(!this.out[t])continue;const i=this.out[t].name;this.oft[i]&&this.oft[i].HA()}}HL(){this.fit={},this.oft=new Array}cft(t){if(!this.Ls.hs.supportMSAA)return!1;const i=Object.keys(this.fit);if(i.length>0){const e=this.fit[i[0]].getPostProcesses();e&&(e[0].samples=t)}return!0}setPrePassRenderer(t){return!1}dispose(){}}ut([Q()],jx.prototype,"_name",void 0);class Kx{constructor(){this.uft={}}get supportedPipelines(){const t=[];for(const i in this.uft)if(Object.prototype.hasOwnProperty.call(this.uft,i)){const e=this.uft[i];e.isSupported&&t.push(e)}return t}addPipeline(t){this.uft[t.hn]=t}attachCamerasToRenderPipeline(t,i,e=!1){const s=this.uft[t];s&&s.lut(i,e)}detachCamerasFromRenderPipeline(t,i){const e=this.uft[t];e&&e.cut(i)}enableEffectInPipeline(t,i,e){const s=this.uft[t];s&&s.aft(i,e)}disableEffectInPipeline(t,i,e){const s=this.uft[t];s&&s.lft(i,e)}update(){for(const t in this.uft)if(Object.prototype.hasOwnProperty.call(this.uft,t)){const i=this.uft[t];i.isSupported?i.HA():(i.dispose(),delete this.uft[t])}}br(){for(const t in this.uft)if(Object.prototype.hasOwnProperty.call(this.uft,t)){this.uft[t].br()}}dispose(){for(const t in this.uft)if(Object.prototype.hasOwnProperty.call(this.uft,t)){this.uft[t].dispose()}}}Object.defineProperty(ke.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this.fft){let t=this.Mg(fe.NAME_POSTPROCESSRENDERPIPELINEMANAGER);t||(t=new qx(this),this.Ig(t)),this.fft=new Kx}return this.fft},enumerable:!0,configurable:!0});class qx{constructor(t){this.name=fe.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=t}register(){this.scene.zv.registerStep(fe.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this.xst)}rebuild(){this.scene.fft&&this.scene.fft.br()}dispose(){this.scene.fft&&this.scene.fft.dispose()}xst(){this.scene.fft&&this.scene.fft.update()}}class Qx extends jx{constructor(t="",i=!0,e=E.LastCreatedScene,s,n=!0){super(e.getEngine(),t),this.dft=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this.pft=null,this.animations=[],this.mft=null,this.vft=!1,this.gft=!1,this.Sft=!1,this.Eft=ax.Low,this.Aft=!1,this.Cft=!0,this.mut=.5,this.wft=!1,this.xft=!1,this.Tft=!0,this.onBuildObservable=new h,this.cO=null,this.Rft=1,this.Ift=64,this.Mft=.15,this.bft=.9,this.dw=1,this._ft=!1,this.yft=null,this.Nft=null,this.Pft=null,this.Dft=null,this.Lft=null,this.out=s||e.cameras,this.out=this.out.slice(),this.dft=this.out.slice(),this.Tft=n,this.Kt=e;const r=this.Kt.getEngine().getCaps();this.Oft=i&&(r.textureHalfFloatRender||r.textureFloatRender),this.Oft?r.textureHalfFloatRender?this.Fft=2:r.textureFloatRender&&(this.Fft=1):this.Fft=0,e.postProcessRenderPipelineManager.addPipeline(this);const o=this.Kt.getEngine();this.sharpen=new Yx("sharpen",1,null,an.BILINEAR_SAMPLINGMODE,o,!1,this.Fft,!0),this.Bft=new Uw(o,this.SharpenPostProcessId,(()=>this.sharpen),!0),this.depthOfField=new lx(this.Kt,null,this.Eft,this.Fft,!0),this.Rft=o.getHardwareScalingLevel(),this.cO=o.onResizeObservable.add((()=>{this.Rft=o.getHardwareScalingLevel(),this.bloomKernel=this.Ift})),this.bloom=new Ww(this.Kt,this.mut,this.Mft,this.bloomKernel/this.Rft,this.Fft,!0),this.chromaticAberration=new jw("ChromaticAberration",o.getRenderWidth(),o.getRenderHeight(),1,null,an.BILINEAR_SAMPLINGMODE,o,!1,this.Fft,!0),this.Uft=new Uw(o,this.ChromaticAberrationPostProcessId,(()=>this.chromaticAberration),!0),this.grain=new xx("Grain",1,null,an.BILINEAR_SAMPLINGMODE,o,!1,this.Fft,!0),this.Vft=new Uw(o,this.GrainPostProcessId,(()=>this.grain),!0),this.mft=this.Kt.imageProcessingConfiguration.onUpdateParameters.add((()=>{this.bloom.vut.Ec=this.Kt.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this.Kt.imageProcessingConfiguration.isEnabled&&(this.Cft=this.Kt.imageProcessingConfiguration.isEnabled,this.kft())})),this.kft()}get automaticBuild(){return this.Tft}set automaticBuild(t){this.Tft=t}get scene(){return this.Kt}set sharpenEnabled(t){this.vft!==t&&(this.vft=t,this.kft())}get sharpenEnabled(){return this.vft}get bloomKernel(){return this.Ift}set bloomKernel(t){this.Ift=t,this.bloom.kernel=t/this.Rft}set bloomWeight(t){this.Mft!==t&&(this.bloom.weight=t,this.Mft=t)}get bloomWeight(){return this.Mft}set bloomThreshold(t){this.bft!==t&&(this.bloom.threshold=t,this.bft=t)}get bloomThreshold(){return this.bft}set bloomScale(t){this.mut!==t&&(this.mut=t,this.Gft(),this.kft())}get bloomScale(){return this.mut}set bloomEnabled(t){this.gft!==t&&(this.gft=t,this.kft())}get bloomEnabled(){return this.gft}Gft(){const t=this.bloom;this.bloom=new Ww(this.Kt,this.bloomScale,this.Mft,this.bloomKernel/this.Rft,this.Fft,!1),this.bloom.threshold=t.threshold;for(let i=0;i<this.out.length;i++)t.disposeEffects(this.out[i])}get depthOfFieldEnabled(){return this.Sft}set depthOfFieldEnabled(t){this.Sft!==t&&(this.Sft=t,this.kft())}get depthOfFieldBlurLevel(){return this.Eft}set depthOfFieldBlurLevel(t){if(this.Eft===t)return;this.Eft=t;const i=this.depthOfField;this.depthOfField=new lx(this.Kt,null,this.Eft,this.Fft,!1),this.depthOfField.focalLength=i.focalLength,this.depthOfField.focusDistance=i.focusDistance,this.depthOfField.fStop=i.fStop,this.depthOfField.lensSize=i.lensSize;for(let t=0;t<this.out.length;t++)i.disposeEffects(this.out[t]);this.kft()}set fxaaEnabled(t){this.Aft!==t&&(this.Aft=t,this.kft())}get fxaaEnabled(){return this.Aft}set samples(t){this.dw!==t&&(this.dw=t,this.kft())}get samples(){return this.dw}set imageProcessingEnabled(t){this.Cft!==t&&(this.Kt.imageProcessingConfiguration.isEnabled=t)}get imageProcessingEnabled(){return this.Cft}set glowLayerEnabled(t){t&&!this.pft?this.pft=new MS("",this.Kt):!t&&this.pft&&(this.pft.dispose(),this.pft=null)}get glowLayerEnabled(){return null!=this.pft}get glowLayer(){return this.pft}set chromaticAberrationEnabled(t){this.wft!==t&&(this.wft=t,this.kft())}get chromaticAberrationEnabled(){return this.wft}set grainEnabled(t){this.xft!==t&&(this.xft=t,this.kft())}get grainEnabled(){return this.xft}getClassName(){return"DefaultRenderingPipeline"}prepare(){const t=this.Tft;this.Tft=!0,this.kft(),this.Tft=t}zft(t,i=!1){this._ft?t.autoClear=!1:(t.autoClear=!0,this.Kt.autoClear=!1,this._ft=!0),i||(this.Nft?t.shareOutputWith(this.Nft):t.useOwnOutput(),this.yft&&(this.Nft=this.yft),this.yft=t)}kft(){if(!this.Tft)return;this.Kt.autoClear=!0;const t=this.Kt.getEngine();if(this.Hft(),null!==this.out&&(this.Kt.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.hn,this.out),this.out=this.dft.slice()),this.HL(),this.yft=null,this.Nft=null,this._ft=!1,this.depthOfFieldEnabled){if(this.out.length>1){for(const t of this.out){this.Kt.enableDepthRenderer(t).useOnlyInActiveCamera=!0}this.Pft=this.Kt.onAfterRenderTargetsRenderObservable.add((t=>{this.out.indexOf(t.activeCamera)>-1&&(this.depthOfField.depthTexture=t.enableDepthRenderer(t.activeCamera).getDepthMap())}))}else{this.Kt.onAfterRenderTargetsRenderObservable.remove(this.Pft);const t=this.Kt.enableDepthRenderer(this.out[0]);this.depthOfField.depthTexture=t.getDepthMap()}this.depthOfField.di()||this.depthOfField.Sut(),this.addEffect(this.depthOfField),this.zft(this.depthOfField.dut[0],!0)}else this.Kt.onAfterRenderTargetsRenderObservable.remove(this.Pft);this.bloomEnabled&&(this.bloom.di()||this.bloom.Sut(),this.addEffect(this.bloom),this.zft(this.bloom.dut[0],!0)),this.Cft&&(this.imageProcessing=new oc("imageProcessing",1,null,an.BILINEAR_SAMPLINGMODE,t,!1,this.Fft,this.scene.imageProcessingConfiguration),this.Oft?(this.addEffect(new Uw(t,this.ImageProcessingPostProcessId,(()=>this.imageProcessing),!0)),this.zft(this.imageProcessing)):this.Kt.imageProcessingConfiguration.applyByPostProcess=!1,this.out&&0!==this.out.length||(this.Kt.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._c()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this.Bft),this.zft(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this.Vft),this.zft(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this.Uft),this.zft(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new Ax("fxaa",1,null,an.BILINEAR_SAMPLINGMODE,t,!1,this.Fft),this.addEffect(new Uw(t,this.FxaaPostProcessId,(()=>this.fxaa),!0)),this.zft(this.fxaa,!0)),null!==this.out&&this.Kt.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this.hn,this.out),(this.Kt.activeCameras&&this.Kt.activeCameras.length>1||this.Kt.activeCamera&&-1===this.out.indexOf(this.Kt.activeCamera))&&(this.Kt.autoClear=!0),this.Dft||(this.Dft=this.Kt.onActiveCameraChanged.add((()=>{this.Kt.activeCamera&&-1===this.out.indexOf(this.Kt.activeCamera)&&(this.Kt.autoClear=!0)}))),this.Lft||(this.Lft=this.Kt.onActiveCamerasChanged.add((()=>{this.Kt.activeCameras&&this.Kt.activeCameras.length>1&&(this.Kt.autoClear=!0)}))),!this.cft(this.samples)&&this.samples>1&&F.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}Hft(t=!1){for(let i=0;i<this.out.length;i++){const e=this.out[i];this.imageProcessing&&this.imageProcessing.dispose(e),this.fxaa&&this.fxaa.dispose(e),t&&(this.sharpen&&this.sharpen.dispose(e),this.depthOfField&&(this.Kt.onAfterRenderTargetsRenderObservable.remove(this.Pft),this.depthOfField.disposeEffects(e)),this.bloom&&this.bloom.disposeEffects(e),this.chromaticAberration&&this.chromaticAberration.dispose(e),this.grain&&this.grain.dispose(e),this.pft&&this.pft.dispose())}this.imageProcessing=null,this.fxaa=null,t&&(this.sharpen=null,this.Bft=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this.Uft=null,this.grain=null,this.Vft=null,this.pft=null)}addCamera(t){this.dft.push(t),this.kft()}removeCamera(t){const i=this.dft.indexOf(t);this.dft.splice(i,1),this.kft()}dispose(){this.onBuildObservable.clear(),this.Hft(!0),this.Kt.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.hn,this.out),this.Kt.autoClear=!0,this.cO&&(this.Kt.getEngine().onResizeObservable.remove(this.cO),this.cO=null),this.Kt.onActiveCameraChanged.remove(this.Dft),this.Kt.onActiveCamerasChanged.remove(this.Lft),this.Kt.imageProcessingConfiguration.onUpdateParameters.remove(this.mft),super.dispose()}serialize(){const t=ot.Serialize(this);return t.customType="DefaultRenderingPipeline",t}static Parse(t,i,e){return ot.Parse((()=>new Qx(t.hn,t.hn.Oft,i)),t,i,e)}}ut([Q()],Qx.prototype,"sharpenEnabled",null),ut([Q()],Qx.prototype,"bloomKernel",null),ut([Q()],Qx.prototype,"_bloomWeight",void 0),ut([Q()],Qx.prototype,"_bloomThreshold",void 0),ut([Q()],Qx.prototype,"_hdr",void 0),ut([Q()],Qx.prototype,"bloomWeight",null),ut([Q()],Qx.prototype,"bloomThreshold",null),ut([Q()],Qx.prototype,"bloomScale",null),ut([Q()],Qx.prototype,"bloomEnabled",null),ut([Q()],Qx.prototype,"depthOfFieldEnabled",null),ut([Q()],Qx.prototype,"depthOfFieldBlurLevel",null),ut([Q()],Qx.prototype,"fxaaEnabled",null),ut([Q()],Qx.prototype,"samples",null),ut([Q()],Qx.prototype,"imageProcessingEnabled",null),ut([Q()],Qx.prototype,"glowLayerEnabled",null),ut([Q()],Qx.prototype,"chromaticAberrationEnabled",null),ut([Q()],Qx.prototype,"grainEnabled",null),v("BABYLON.DefaultRenderingPipeline",Qx);const Zx="lensHighlightsPixelShader",Jx="uniform sampler2D textureSampler; \nuniform float gain;\nuniform float threshold;\nuniform float screen_width;\nuniform float screen_height;\nvarying vec2 vUV;\nvec4 highlightColor(vec4 color) {\nvec4 highlight=color;\nfloat luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));\nfloat lum_threshold;\nif (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);\nhighlight*=luminance*gain;\nhighlight.a=1.0;\nreturn highlight;\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 original=texture2D(textureSampler,vUV);\nif (gain==-1.0) {\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\nreturn;\n}\nfloat w=2.0/screen_width;\nfloat h=2.0/screen_height;\nfloat weight=1.0;\nvec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;\ngl_FragColor=blurred;\n}";ii.ShadersStore[Zx]=Jx;const tT="depthOfFieldPixelShader",iT="uniform sampler2D textureSampler;\nuniform sampler2D highlightsSampler;\nuniform sampler2D depthSampler;\nuniform sampler2D grainSampler;\nuniform float grain_amount;\nuniform bool blur_noise;\nuniform float screen_width;\nuniform float screen_height;\nuniform float distortion;\nuniform bool dof_enabled;\nuniform float screen_distance; \nuniform float aperture;\nuniform float darken;\nuniform float edge_blur;\nuniform bool highlights;\nuniform float near;\nuniform float far;\nvarying vec2 vUV;\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \nvec2 centered_screen_pos;\nvec2 distorted_coords;\nfloat radius2;\nfloat radius;\nvec2 rand(vec2 co)\n{\nfloat noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));\nfloat noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));\nreturn clamp(vec2(noise1,noise2),0.0,1.0);\n}\nvec2 getDistortedCoords(vec2 coords) {\nif (distortion==0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);\nvec2 dist_coords=vec2(0.5,0.5);\ndist_coords.x=0.5+direction.x*radius2*1.0;\ndist_coords.y=0.5+direction.y*radius2*1.0;\nfloat dist_amount=clamp(distortion*0.23,0.0,1.0);\ndist_coords=mix(coords,dist_coords,dist_amount);\nreturn dist_coords;\n}\nfloat sampleScreen(inout vec4 color,in vec2 offset,in float weight) {\nvec2 coords=distorted_coords;\nfloat angle=rand(coords*100.0).x*TWOPI;\ncoords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));\ncolor+=texture2D(textureSampler,coords)*weight;\nreturn weight;\n}\nfloat getBlurLevel(float size) {\nreturn min(3.0,ceil(size/1.0));\n}\nvec4 getBlurColor(float size) {\nvec4 col=texture2D(textureSampler,distorted_coords);\nfloat blur_level=getBlurLevel(size);\nfloat w=(size/screen_width);\nfloat h=(size/screen_height);\nfloat total_weight=1.0;\nvec2 sample_coords;\ntotal_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);\ntotal_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);\ntotal_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);\ntotal_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);\ntotal_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);\ntotal_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);\ntotal_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);\ntotal_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);\ntotal_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);\nif (blur_level>1.0) {\ntotal_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);\ntotal_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);\ntotal_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);\ntotal_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);\ntotal_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);\ntotal_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);\ntotal_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);\ntotal_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);\ntotal_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);\n}\nif (blur_level>2.0) {\ntotal_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);\ntotal_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);\ntotal_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);\ntotal_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);\ntotal_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);\ntotal_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);\ntotal_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);\ntotal_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);\ntotal_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);\n}\ncol/=total_weight; \nif (darken>0.0) {\ncol.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);\n}\nreturn col;\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\ncentered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);\nradius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;\nradius=sqrt(radius2);\ndistorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));\nif (dof_enabled==false || coc<0.07) { coc=0.0; }\nfloat edge_blur_amount=0.0;\nif (edge_blur>0.0) {\nedge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;\n}\nfloat blur_amount=max(edge_blur_amount,coc);\nif (blur_amount==0.0) {\ngl_FragColor=texture2D(textureSampler,distorted_coords);\n}\nelse {\ngl_FragColor=getBlurColor(blur_amount*1.7);\nif (highlights) {\ngl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;\n}\nif (blur_noise) {\nvec2 noise=rand(distorted_coords)*0.01*blur_amount;\nvec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);\ngl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;\n}\n}\nif (grain_amount>0.0) {\nvec4 grain_color=texture2D(grainSampler,texels_coords*0.003);\ngl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;\n}\n}\n";ii.ShadersStore[tT]=iT;class eT{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}const sT="ssao2PixelShader",nT="precision highp float;\nuniform sampler2D textureSampler;\nuniform float near;\nuniform float far;\nuniform float radius;\nfloat scales[16]=float[16](\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);\nvarying vec2 vUV;\nfloat perspectiveDepthToViewZ(in float invClipZ,in float near,in float far ) {\nreturn ( near*far )/( ( far-near )*invClipZ-far );\n}\nfloat viewZToPerspectiveDepth( in float viewZ,in float near,in float far ) {\nreturn ( near*far/viewZ+far)/( far-near );\n}\nfloat viewZToOrthographicDepth( in float viewZ,in float near,in float far ) {\nreturn ( viewZ+near )/( near-far );\n}\n#ifdef SSAO\nuniform sampler2D randomSampler;\nuniform sampler2D depthSampler;\nuniform sampler2D normalSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float base;\nuniform float xViewport;\nuniform float yViewport;\nuniform mat3 depthProjection;\nuniform float maxZ;\nuniform float minZAspect;\nuniform vec2 texelSize;\nuniform mat4 projection;\nvoid main()\n{\nvec3 random=texture2D(randomSampler,vUV*randTextureTiles).rgb;\nfloat depth=texture2D(depthSampler,vUV).r;\nfloat depthSign=depth/abs(depth);\ndepth=depth*depthSign;\nvec3 normal=texture2D(normalSampler,vUV).rgb;\nfloat occlusion=0.0;\nfloat correctedRadius=min(radius,minZAspect*depth/near);\nvec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);\nvec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);\nvec3 origin=vViewRay*vDepthFactor;\nvec3 rvec=random*2.0-1.0;\nrvec.z=0.0;\nfloat dotProduct=dot(rvec,normal);\nrvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);\nvec3 tangent=normalize(rvec-normal*dot(rvec,normal));\nvec3 bitangent=cross(normal,tangent);\nmat3 tbn=mat3(tangent,bitangent,normal);\nfloat difference;\nfor (int i=0; i<SAMPLES; ++i) {\nvec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];\nsamplePosition=samplePosition*correctedRadius+origin;\nvec4 offset=vec4(samplePosition,1.0);\noffset=projection*offset;\noffset.xyz/=offset.w;\noffset.xy=offset.xy*0.5+0.5;\nif (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {\ncontinue;\n}\nfloat sampleDepth=abs(texture2D(depthSampler,offset.xy).r);\ndifference=depthSign*samplePosition.z-sampleDepth;\nfloat rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);\nocclusion+=(difference>=0.0 ? 1.0 : 0.0)*rangeCheck;\n}\nocclusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor=vec4(vec3(result),1.0);\n}\n#endif\n#ifdef BILATERAL_BLUR\nuniform sampler2D depthSampler;\nuniform float outSize;\nuniform float samplerOffsets[SAMPLES];\nvec4 blur9(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.3846153846)*direction;\nvec2 off2=vec2(3.2307692308)*direction;\ncolor+=texture2D(image,uv)*0.2270270270;\ncolor+=texture2D(image,uv+(off1/resolution))*0.3162162162;\ncolor+=texture2D(image,uv-(off1/resolution))*0.3162162162;\ncolor+=texture2D(image,uv+(off2/resolution))*0.0702702703;\ncolor+=texture2D(image,uv-(off2/resolution))*0.0702702703;\nreturn color;\n}\nvec4 blur13(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.411764705882353)*direction;\nvec2 off2=vec2(3.2941176470588234)*direction;\nvec2 off3=vec2(5.176470588235294)*direction;\ncolor+=texture2D(image,uv)*0.1964825501511404;\ncolor+=texture2D(image,uv+(off1/resolution))*0.2969069646728344;\ncolor+=texture2D(image,uv-(off1/resolution))*0.2969069646728344;\ncolor+=texture2D(image,uv+(off2/resolution))*0.09447039785044732;\ncolor+=texture2D(image,uv-(off2/resolution))*0.09447039785044732;\ncolor+=texture2D(image,uv+(off3/resolution))*0.010381362401148057;\ncolor+=texture2D(image,uv-(off3/resolution))*0.010381362401148057;\nreturn color;\n}\nvec4 blur13Bilateral(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.411764705882353)*direction;\nvec2 off2=vec2(3.2941176470588234)*direction;\nvec2 off3=vec2(5.176470588235294)*direction;\nfloat compareDepth=abs(texture2D(depthSampler,uv).r);\nfloat sampleDepth;\nfloat weight;\nfloat weightSum=30.0;\ncolor+=texture2D(image,uv)*30.0;\nsampleDepth=abs(texture2D(depthSampler,uv+(off1/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+= weight;\ncolor+=texture2D(image,uv+(off1/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off1/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+= weight;\ncolor+=texture2D(image,uv-(off1/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv+(off2/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv+(off2/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off2/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv-(off2/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv+(off3/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv+(off3/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off3/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv-(off3/resolution))*weight;\nreturn color/weightSum;\n}\nvoid main()\n{\n#if EXPENSIVE\nfloat compareDepth=abs(texture2D(depthSampler,vUV).r);\nfloat texelsize=1.0/outSize;\nfloat result=0.0;\nfloat weightSum=0.0;\nfor (int i=0; i<SAMPLES; ++i)\n{\n#ifdef BILATERAL_BLUR_H\nvec2 direction=vec2(1.0,0.0);\nvec2 sampleOffset=vec2(texelsize*samplerOffsets[i],0.0);\n#else\nvec2 direction=vec2(0.0,1.0);\nvec2 sampleOffset=vec2(0.0,texelsize*samplerOffsets[i]);\n#endif\nvec2 samplePos=vUV+sampleOffset;\nfloat sampleDepth=abs(texture2D(depthSampler,samplePos).r);\nfloat weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30000.0);\nresult+=texture2D(textureSampler,samplePos).r*weight;\nweightSum+=weight;\n}\nresult/=weightSum;\ngl_FragColor.rgb=vec3(result);\ngl_FragColor.a=1.0;\n#else\nvec4 color;\n#ifdef BILATERAL_BLUR_H\nvec2 direction=vec2(1.0,0.0);\ncolor=blur13Bilateral(textureSampler,vUV,outSize,direction);\n#else\nvec2 direction=vec2(0.0,1.0);\ncolor=blur13Bilateral(textureSampler,vUV,outSize,direction);\n#endif\ngl_FragColor.rgb=vec3(color.r);\ngl_FragColor.a=1.0;\n#endif\n}\n#endif\n";ii.ShadersStore[sT]=nT;const rT="ssaoCombinePixelShader",hT="uniform sampler2D textureSampler;\nuniform sampler2D originalColor;\nuniform vec4 viewport;\nvarying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);\nvec4 sceneColor=texture2D(originalColor,vUV);\ngl_FragColor=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";ii.ShadersStore[rT]=hT;class oT extends jx{constructor(t,i,e,s,n=!1,r=0){if(super(i.getEngine(),t),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this.dw=8,this.Xft=1,this.Jut=!1,this.Wft=!0,this.radius=2,this.base=0,this.$ft=new Uint32Array(1),this.Kt=i,this.Fut=e,this.Jut=n,!this.isSupported)return void F.Error("The current engine does not support SSAO 2.");const h=this.Fut.ssaoRatio||e,o=this.Fut.blurRatio||e;this.Jut?i.enableGeometryBufferRenderer():i.enablePrePassRenderer(),this.Yft(),this.jft=new Zh("SSAOOriginalSceneColor",1,null,an.BILINEAR_SAMPLINGMODE,i.getEngine(),void 0,r),this.jft.samples=this.textureSamples,this.Kft(1,r),this.qft(h,o,r),this.Qft(o,r),this.addEffect(new Uw(i.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this.jft),!0)),this.addEffect(new Uw(i.getEngine(),this.SSAORenderEffect,(()=>this.Zft),!0)),this.addEffect(new Uw(i.getEngine(),this.SSAOBlurHRenderEffect,(()=>this.Jft),!0)),this.addEffect(new Uw(i.getEngine(),this.SSAOBlurVRenderEffect,(()=>this.tdt),!0)),this.addEffect(new Uw(i.getEngine(),this.SSAOCombineRenderEffect,(()=>this.idt),!0)),i.postProcessRenderPipelineManager.addPipeline(this),s&&i.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(t,s)}set samples(t){this.dw=t,this.Zft.updateEffect(this.edt()),this.sdt=this.ndt()}get samples(){return this.dw}set textureSamples(t){this.Xft=t,this.Gut?this.Gut.samples=t:this.jft.samples=t}get textureSamples(){return this.Xft}get qut(){return this.Jut?this.Kt.geometryBufferRenderer:null}get Gut(){return this.Jut?null:this.Kt.prePassRenderer}set expensiveBlur(t){this.Jft.updateEffect("#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE "+(t?"1":"0")+"\n",null,["textureSampler","depthSampler"]),this.tdt.updateEffect("#define BILATERAL_BLUR\n#define SAMPLES 16\n#define EXPENSIVE "+(t?"1":"0")+"\n",null,["textureSampler","depthSampler"]),this.Wft=t}get expensiveBlur(){return this.Wft}static get IsSupported(){const t=E.LastCreatedEngine;return!!t&&t.hs.supportSSAO2}get scene(){return this.Kt}getClassName(){return"SSAO2RenderingPipeline"}dispose(t=!1){for(let t=0;t<this.Kt.cameras.length;t++){const i=this.Kt.cameras[t];this.jft.dispose(i),this.Zft.dispose(i),this.Jft.dispose(i),this.tdt.dispose(i),this.idt.dispose(i)}this.Vat.dispose(),t&&this.Kt.disableGeometryBufferRenderer(),this.Kt.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.hn,this.Kt.cameras),super.dispose()}qft(t,i,e){this.rdt=[];const s=this.expensiveBlur;for(let t=-8;t<8;t++)this.rdt.push(2*t+.5);this.Jft=new nr("BlurH","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],t,null,an.TRILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE "+(s?"1":"0")+"\n",e),this.Jft.onApply=t=>{this.Kt.activeCamera&&(t.setFloat("outSize",this.idt.width>0?this.idt.width:this.jft.width),t.setFloat("near",this.Kt.activeCamera.minZ),t.setFloat("far",this.Kt.activeCamera.maxZ),t.setFloat("radius",this.radius),this.qut?t.setTexture("depthSampler",this.qut.getGBuffer().textures[0]):this.Gut&&t.setTexture("depthSampler",this.Gut.getRenderTarget().textures[this.Gut.getIndex(5)]),t.setArray("samplerOffsets",this.rdt))},this.tdt=new nr("BlurV","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],i,null,an.TRILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_V\n#define SAMPLES 16\n#define EXPENSIVE "+(s?"1":"0")+"\n",e),this.tdt.onApply=t=>{this.Kt.activeCamera&&(t.setFloat("outSize",this.idt.height>0?this.idt.height:this.jft.height),t.setFloat("near",this.Kt.activeCamera.minZ),t.setFloat("far",this.Kt.activeCamera.maxZ),t.setFloat("radius",this.radius),this.qut?t.setTexture("depthSampler",this.qut.getGBuffer().textures[0]):this.Gut&&t.setTexture("depthSampler",this.Gut.getRenderTarget().textures[this.Gut.getIndex(5)]),t.setArray("samplerOffsets",this.rdt))},this.Jft.samples=this.textureSamples,this.tdt.samples=this.textureSamples}br(){super.br()}hdt(t){return this.$ft[0]=t,this.$ft[0]=(this.$ft[0]<<16|this.$ft[0]>>16)>>>0,this.$ft[0]=(1431655765&this.$ft[0])<<1|(2863311530&this.$ft[0])>>>1>>>0,this.$ft[0]=(858993459&this.$ft[0])<<2|(3435973836&this.$ft[0])>>>2>>>0,this.$ft[0]=(252645135&this.$ft[0])<<4|(4042322160&this.$ft[0])>>>4>>>0,this.$ft[0]=(16711935&this.$ft[0])<<8|(4278255360&this.$ft[0])>>>8>>>0,2.3283064365386963e-10*this.$ft[0]}odt(t,i){return[t/i,this.hdt(t)]}adt(t,i){const e=2*i*Math.PI,s=1-.85*t,n=Math.sqrt(1-s*s);return new w(Math.cos(e)*n,Math.sin(e)*n,s)}ndt(){const t=this.samples,i=[];let e,s=0;for(;s<t;){if(t<16)e=this.adt(Math.random(),Math.random());else{const i=this.odt(s,t);e=this.adt(i[0],i[1])}i.push(e.x,e.y,e.z),s++}return i}edt(){return"#define SAMPLES "+this.samples+"\n#define SSAO"}Kft(t,i){this.sdt=this.ndt();const e=this.edt();this.Zft=new nr("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","far","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],["randomSampler","depthSampler","normalSampler"],t,null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,e,i),this.Zft.onApply=t=>{var i,e,s,n;if(this.Kt.activeCamera){if(t.setArray3("sampleSphere",this.sdt),t.setFloat("randTextureTiles",32),t.setFloat("samplesFactor",1/this.samples),t.setFloat("totalStrength",this.totalStrength),t.setFloat2("texelSize",1/this.Zft.width,1/this.Zft.height),t.setFloat("radius",this.radius),t.setFloat("maxZ",this.maxZ),t.setFloat("minZAspect",this.minZAspect),t.setFloat("base",this.base),t.setFloat("near",this.Kt.activeCamera.minZ),t.setFloat("far",this.Kt.activeCamera.maxZ),this.Kt.activeCamera.mode===hs.PERSPECTIVE_CAMERA)t.setMatrix3x3("depthProjection",oT.PERSPECTIVE_DEPTH_PROJECTION),t.setFloat("xViewport",Math.tan(this.Kt.activeCamera.fov/2)*this.Kt.getEngine().getAspectRatio(this.Kt.activeCamera,!0)),t.setFloat("yViewport",Math.tan(this.Kt.activeCamera.fov/2));else{const r=this.Kt.getEngine().getRenderWidth()/2,h=this.Kt.getEngine().getRenderHeight()/2,o=null!==(i=this.Kt.activeCamera.orthoLeft)&&void 0!==i?i:-r,a=null!==(e=this.Kt.activeCamera.orthoRight)&&void 0!==e?e:r,l=null!==(s=this.Kt.activeCamera.orthoBottom)&&void 0!==s?s:-h,c=null!==(n=this.Kt.activeCamera.orthoTop)&&void 0!==n?n:h;t.setMatrix3x3("depthProjection",oT.ORTHO_DEPTH_PROJECTION),t.setFloat("xViewport",.5*(a-o)),t.setFloat("yViewport",.5*(c-l))}t.setMatrix("projection",this.Kt.getProjectionMatrix()),this.qut?(t.setTexture("depthSampler",this.qut.getGBuffer().textures[0]),t.setTexture("normalSampler",this.qut.getGBuffer().textures[1])):this.Gut&&(t.setTexture("depthSampler",this.Gut.getRenderTarget().textures[this.Gut.getIndex(5)]),t.setTexture("normalSampler",this.Gut.getRenderTarget().textures[this.Gut.getIndex(6)])),t.setTexture("randomSampler",this.Vat)}},this.Zft.samples=this.textureSamples,this.Jut||(this.Zft.gL=new eT)}Qft(t,i){this.idt=new nr("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],t,null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,void 0,i),this.idt.onApply=t=>{const i=this.Kt.activeCamera.viewport;t.setVector4("viewport",M.Vector4[0].copyFromFloats(i.x,i.y,i.width,i.height)),t.setTextureFromPostProcessOutput("originalColor",this.jft)},this.idt.samples=this.textureSamples}Yft(){this.Vat=new nc("SSAORandomTexture",128,this.Kt,!1,an.TRILINEAR_SAMPLINGMODE),this.Vat.wrapU=an.WRAP_ADDRESSMODE,this.Vat.wrapV=an.WRAP_ADDRESSMODE;const t=this.Vat.getContext(),i=(t,i)=>Math.random()*(i-t)+t,e=w.Zero();for(let s=0;s<128;s++)for(let n=0;n<128;n++)e.x=i(0,1),e.y=i(0,1),e.z=0,e.normalize(),e.scaleInPlace(255),e.x=Math.floor(e.x),e.y=Math.floor(e.y),t.fillStyle="rgb("+e.x+", "+e.y+", "+e.z+")",t.fillRect(s,n,1,1);this.Vat.update(!1)}serialize(){const t=ot.Serialize(this);return t.customType="SSAO2RenderingPipeline",t}static Parse(t,i,e){return ot.Parse((()=>new oT(t.hn,i,t.Fut)),t,i,e)}}oT.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],oT.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],ut([Q()],oT.prototype,"totalStrength",void 0),ut([Q()],oT.prototype,"maxZ",void 0),ut([Q()],oT.prototype,"minZAspect",void 0),ut([Q("samples")],oT.prototype,"_samples",void 0),ut([Q("textureSamples")],oT.prototype,"_textureSamples",void 0),ut([Q()],oT.prototype,"_ratio",void 0),ut([Q("expensiveBlur")],oT.prototype,"_expensiveBlur",void 0),ut([Q()],oT.prototype,"radius",void 0),ut([Q()],oT.prototype,"base",void 0),v("BABYLON.SSAO2RenderingPipeline",oT);const aT="ssaoPixelShader",lT="uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float radius;\nuniform float area;\nuniform float fallOff;\nuniform float base;\nvec3 normalFromDepth(float depth,vec2 coords)\n{\nvec2 offset1=vec2(0.0,radius);\nvec2 offset2=vec2(radius,0.0);\nfloat depth1=texture2D(textureSampler,coords+offset1).r;\nfloat depth2=texture2D(textureSampler,coords+offset2).r;\nvec3 p1=vec3(offset1,depth1-depth);\nvec3 p2=vec3(offset2,depth2-depth);\nvec3 normal=cross(p1,p2);\nnormal.z=-normal.z;\nreturn normalize(normal);\n}\nvoid main()\n{\nvec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);\nfloat depth=texture2D(textureSampler,vUV).r;\nvec3 position=vec3(vUV,depth);\nvec3 normal=normalFromDepth(depth,vUV);\nfloat radiusDepth=radius/depth;\nfloat occlusion=0.0;\nvec3 ray;\nvec3 hemiRay;\nfloat occlusionDepth;\nfloat difference;\nfor (int i=0; i<SAMPLES; i++)\n{\nray=radiusDepth*reflect(sampleSphere[i],random);\nhemiRay=position+sign(dot(ray,normal))*ray;\nocclusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;\ndifference=depth-occlusionDepth;\nocclusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));\n}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor.r=result;\ngl_FragColor.g=result;\ngl_FragColor.b=result;\ngl_FragColor.a=1.0;\n}\n#endif\n";ii.ShadersStore[aT]=lT;class cT extends jx{constructor(t,i,e,s){super(i.getEngine(),t),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this.ldt=!0,this.Kt=i,this.Yft();const n=e.ssaoRatio||e,r=e.combineRatio||e;this.jft=new Zh("SSAOOriginalSceneColor",r,null,an.BILINEAR_SAMPLINGMODE,i.getEngine(),!1),this.Kft(n),this.qft(n),this.Qft(r),this.addEffect(new Uw(i.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this.jft),!0)),this.addEffect(new Uw(i.getEngine(),this.SSAORenderEffect,(()=>this.Zft),!0)),this.addEffect(new Uw(i.getEngine(),this.SSAOBlurHRenderEffect,(()=>this.Jft),!0)),this.addEffect(new Uw(i.getEngine(),this.SSAOBlurVRenderEffect,(()=>this.tdt),!0)),this.addEffect(new Uw(i.getEngine(),this.SSAOCombineRenderEffect,(()=>this.idt),!0)),i.postProcessRenderPipelineManager.addPipeline(this),s&&i.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(t,s)}get scene(){return this.Kt}lut(t,i){super.lut(t,i);for(const t of this.out)this.Kt.enableDepthRenderer(t).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(t=!1){for(let t=0;t<this.Kt.cameras.length;t++){const i=this.Kt.cameras[t];this.jft.dispose(i),this.Zft.dispose(i),this.Jft.dispose(i),this.tdt.dispose(i),this.idt.dispose(i)}this.Vat.dispose(),t&&this.Kt.disableDepthRenderer(),this.Kt.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.hn,this.Kt.cameras),super.dispose()}qft(t){this.Jft=new xm("BlurH",new C(1,0),16,t,null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,0),this.tdt=new xm("BlurV",new C(0,1),16,t,null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,0),this.Jft.onActivateObservable.add((()=>{const t=this.Jft.width/this.Kt.getEngine().getRenderWidth();this.Jft.kernel=16*t})),this.tdt.onActivateObservable.add((()=>{const t=this.tdt.height/this.Kt.getEngine().getRenderHeight();this.tdt.kernel=16*t}))}br(){this.ldt=!0,super.br()}Kft(t){const i=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this.Zft=new nr("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],t,null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1,"#define SAMPLES 16\n#define SSAO"),this.Zft.externalTextureSamplerBinding=!0,this.Zft.onApply=t=>{this.ldt&&(t.setArray3("sampleSphere",i),t.setFloat("samplesFactor",.0625),t.setFloat("randTextureTiles",4)),t.setFloat("totalStrength",this.totalStrength),t.setFloat("radius",this.radius),t.setFloat("area",this.area),t.setFloat("fallOff",this.fallOff),t.setFloat("base",this.base),t.setTexture("textureSampler",this.Kt.enableDepthRenderer(this.Kt.activeCamera).getDepthMap()),t.setTexture("randomSampler",this.Vat)}}Qft(t){this.idt=new nr("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],t,null,an.BILINEAR_SAMPLINGMODE,this.Kt.getEngine(),!1),this.idt.onApply=t=>{t.setVector4("viewport",M.Vector4[0].copyFromFloats(0,0,1,1)),t.setTextureFromPostProcess("originalColor",this.jft)}}Yft(){this.Vat=new nc("SSAORandomTexture",512,this.Kt,!1,an.TRILINEAR_SAMPLINGMODE),this.Vat.wrapU=an.WRAP_ADDRESSMODE,this.Vat.wrapV=an.WRAP_ADDRESSMODE;const t=this.Vat.getContext(),i=(t,i)=>Math.random()*(i-t)+t,e=w.Zero();for(let s=0;s<512;s++)for(let n=0;n<512;n++)e.x=Math.floor(255*Math.max(0,i(-1,1))),e.y=Math.floor(255*Math.max(0,i(-1,1))),e.z=Math.floor(255*Math.max(0,i(-1,1))),t.fillStyle="rgb("+e.x+", "+e.y+", "+e.z+")",t.fillRect(s,n,1,1);this.Vat.update(!1)}}ut([Q()],cT.prototype,"totalStrength",void 0),ut([Q()],cT.prototype,"radius",void 0),ut([Q()],cT.prototype,"area",void 0),ut([Q()],cT.prototype,"fallOff",void 0),ut([Q()],cT.prototype,"base",void 0);class uT{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}const fT="screenSpaceReflectionPixelShader",dT="uniform sampler2D textureSampler;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;\nuniform sampler2D normalSampler;\nuniform sampler2D positionSampler;\n#endif\nuniform mat4 view;\nuniform mat4 projection;\nuniform float stepSize;\nuniform float strength;\nuniform float threshold;\nuniform float roughnessFactor;\nuniform float reflectionSpecularFalloffExponent;\nvarying vec2 vUV;\n#ifdef SSR_SUPPORTED\nstruct ReflectionInfo {\nvec3 color;\nvec4 coords;\n};\n/**\n* According to specular,see https:\n*/\nvec3 fresnelSchlick(float cosTheta,vec3 F0)\n{\nreturn F0+(1.0-F0)*pow(1.0-cosTheta,5.0);\n}\n/**\n* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit\n* by sampling multiple reflection pixels.\n*/\nReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)\n{\nReflectionInfo info;\ninfo.color=vec3(0.0);\nvec4 projectedCoord;\nfloat sampledDepth;\nfor(int i=0; i<SMOOTH_STEPS; i++)\n{\nprojectedCoord=projection*vec4(hitCoord,1.0);\nprojectedCoord.xy/=projectedCoord.w;\nprojectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);\nsampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;\nfloat depth=sampledDepth-hitCoord.z;\ndir*=0.5;\nif(depth>0.0)\nhitCoord-=dir;\nelse\nhitCoord+=dir;\ninfo.color+=texture2D(textureSampler,projectedCoord.xy).rgb;\n}\nprojectedCoord=projection*vec4(hitCoord,1.0);\nprojectedCoord.xy/=projectedCoord.w;\nprojectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);\ninfo.coords=vec4(projectedCoord.xy,sampledDepth,1.0);\ninfo.color+=texture2D(textureSampler,projectedCoord.xy).rgb;\ninfo.color/=float(SMOOTH_STEPS+1);\nreturn info;\n}\n/**\n* Tests the given world position (hitCoord) according to the given reflection vector (dir)\n* until it finds a collision (means that depth is enough close to say \"it's the pixel to sample!\").\n*/\nReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)\n{\nReflectionInfo info;\nvec4 projectedCoord;\nfloat sampledDepth;\ndir*=stepSize;\nfor(int i=0; i<REFLECTION_SAMPLES; i++)\n{\nhitCoord+=dir;\nprojectedCoord=projection*vec4(hitCoord,1.0);\nprojectedCoord.xy/=projectedCoord.w;\nprojectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);\nsampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;\nfloat depth=sampledDepth-hitCoord.z;\n#ifdef RIGHT_HANDED_SCENE\ndepth*=-1.0;\n#endif\nif(((depth-dir.z)<threshold) && depth<=0.0)\n{\n#ifdef ENABLE_SMOOTH_REFLECTIONS\nreturn smoothReflectionInfo(dir,hitCoord);\n#else\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;\ninfo.coords=vec4(projectedCoord.xy,sampledDepth,0.0);\nreturn info;\n#endif\n}\n}\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;\ninfo.coords=vec4(projectedCoord.xy,sampledDepth,0.0);\nreturn info;\n}\nvec3 hash(vec3 a)\n{\na=fract(a*0.8);\na+=dot(a,a.yxz+19.19);\nreturn fract((a.xxy+a.yxx)*a.zyx);\n}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 albedoFull=texture2D(textureSampler,vUV);\nvec3 albedo=albedoFull.rgb;\nfloat spec=texture2D(reflectivitySampler,vUV).r;\nif (spec==0.0) {\ngl_FragColor=albedoFull;\nreturn;\n}\nvec3 normal=(texture2D(normalSampler,vUV)).xyz;\nvec3 position=(view*texture2D(positionSampler,vUV)).xyz;\nvec3 reflected=normalize(reflect(normalize(position),normalize(normal)));\nfloat roughness=1.0-texture2D(reflectivitySampler,vUV).a;\nvec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;\nReflectionInfo info=getReflectionInfo(jitt+reflected,position);\nvec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));\nfloat screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);\nvec3 F0=vec3(0.04);\nF0 =mix(F0,albedo,spec);\nvec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);\n#ifdef RIGHT_HANDED_SCENE\nreflected.z*=-1.0;\n#endif\nfloat reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);\nfloat albedoMultiplier=1.0-reflectionMultiplier;\nvec3 SSR=info.color*fresnel;\ngl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";ii.ShadersStore[fT]=dT;class pT extends nr{constructor(t,i,e,s,n,r,h,o=0,a=!1,l=!1){if(super(t,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],e,s,n,r,h,"#define SSR_SUPPORTED\n#define REFLECTION_SAMPLES 64\n#define SMOOTH_STEPS 5\n",o,void 0,null,a),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this.Jut=!1,this.cdt=!1,this.udt=64,this.fdt=5,this.Jut=l,this.Jut){const t=i.enableGeometryBufferRenderer();t&&t.isSupported&&(t.enablePosition=!0,t.enableReflectivity=!0)}else{const t=i.enablePrePassRenderer();null==t||t.markAsDirty(),this.gL=new uT}this.ddt(),this.onApply=t=>{const e=this.qut,s=this.Gut;if(!s&&!e)return;if(e){const i=e.getTextureIndex(Fx.POSITION_TEXTURE_TYPE),s=e.getTextureIndex(Fx.REFLECTIVITY_TEXTURE_TYPE);t.setTexture("normalSampler",e.getGBuffer().textures[1]),t.setTexture("positionSampler",e.getGBuffer().textures[i]),t.setTexture("reflectivitySampler",e.getGBuffer().textures[s])}else if(s){const i=s.getIndex(1),e=s.getIndex(3),n=s.getIndex(6);t.setTexture("normalSampler",s.getRenderTarget().textures[n]),t.setTexture("positionSampler",s.getRenderTarget().textures[i]),t.setTexture("reflectivitySampler",s.getRenderTarget().textures[e])}const n=i.activeCamera;if(!n)return;const r=n.getViewMatrix(!0),h=n.getProjectionMatrix(!0);t.setMatrix("projection",h),t.setMatrix("view",r),t.setFloat("threshold",this.threshold),t.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),t.setFloat("strength",this.strength),t.setFloat("stepSize",this.step),t.setFloat("roughnessFactor",this.roughnessFactor)},this.pdt=i.useRightHandedSystem}get qut(){return this.Jut?this.Kt.geometryBufferRenderer:null}get Gut(){return this.Jut?null:this.Kt.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}get enableSmoothReflections(){return this.cdt}set enableSmoothReflections(t){t!==this.cdt&&(this.cdt=t,this.ddt())}get reflectionSamples(){return this.udt}set reflectionSamples(t){t!==this.udt&&(this.udt=t,this.ddt())}get smoothSteps(){return this.fdt}set smoothSteps(t){t!==this.fdt&&(this.fdt=t,this.ddt())}ddt(){const t=[];(this.qut||this.Gut)&&t.push("#define SSR_SUPPORTED"),this.cdt&&t.push("#define ENABLE_SMOOTH_REFLECTIONS"),this.pdt&&t.push("#define RIGHT_HANDED_SCENE"),t.push("#define REFLECTION_SAMPLES "+(this.udt>>0)),t.push("#define SMOOTH_STEPS "+(this.fdt>>0)),this.updateEffect(t.join("\n"))}static SL(t,i,e,s){return ot.Parse((()=>new pT(t.name,e,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.textureType,t.reusable)),t,e,s)}}ut([Q()],pT.prototype,"threshold",void 0),ut([Q()],pT.prototype,"strength",void 0),ut([Q()],pT.prototype,"reflectionSpecularFalloffExponent",void 0),ut([Q()],pT.prototype,"step",void 0),ut([Q()],pT.prototype,"roughnessFactor",void 0),ut([Q()],pT.prototype,"enableSmoothReflections",null),ut([Q()],pT.prototype,"reflectionSamples",null),ut([Q()],pT.prototype,"smoothSteps",null),v("BABYLON.ScreenSpaceReflectionPostProcess",pT);const mT="standardPixelShader",vT="uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{\nvec4 color=texture2D(textureSampler,vUV);\ngl_FragColor=color;\n}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+dsOffsets[0]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[1]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[2]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[3]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[4]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[5]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[6]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[7]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[8]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[9]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[10]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[11]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[12]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[13]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[14]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[15]);\naverage/=16.0;\ngl_FragColor=average;\n}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];\nuniform float brightThreshold;\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));\naverage*=0.25;\nfloat luminance=length(average.rgb);\nif (luminance<brightThreshold) {\naverage=vec4(0.0,0.0,0.0,1.0);\n}\ngl_FragColor=average;\n}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;\nuniform sampler2D lensSampler;\nuniform float exposure;\nvoid main(void)\n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\ncolour*=exposure;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\ncolour+=colour*texture2D(lensSampler,vUV).rgb;\nvec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);\ngl_FragColor=finalColor;\n}\n#endif\n#if defined(VLS)\n#define PI 3.1415926535897932384626433832795\nuniform mat4 shadowViewProjection;\nuniform mat4 lightWorld;\nuniform vec3 cameraPosition;\nuniform vec3 sunDirection;\nuniform vec3 sunColor;\nuniform vec2 depthValues;\nuniform float scatteringCoefficient;\nuniform float scatteringPower;\nuniform sampler2D shadowMapSampler;\nuniform sampler2D positionSampler;\nfloat computeScattering(float lightDotView)\n{\nfloat result=1.0-scatteringCoefficient*scatteringCoefficient;\nresult/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));\nreturn result;\n}\nvoid main(void)\n{\nvec3 worldPos=texture2D(positionSampler,vUV).rgb;\nvec3 startPosition=cameraPosition;\nvec3 rayVector=worldPos-startPosition;\nfloat rayLength=length(rayVector);\nvec3 rayDirection=rayVector/rayLength;\nfloat stepLength=rayLength/NB_STEPS;\nvec3 stepL=rayDirection*stepLength;\nvec3 currentPosition=startPosition;\nvec3 accumFog=vec3(0.0);\nfor (int i=0; i<int(NB_STEPS); i++)\n{\nvec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);\nfloat depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depthMetric,0.0,1.0);\nworldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;\nworldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);\nfloat shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;\nif (shadowMapValue>shadowPixelDepth)\naccumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));\ncurrentPosition+=stepL;\n}\naccumFog/=NB_STEPS;\nvec3 color=accumFog*scatteringPower;\ngl_FragColor=vec4(color*exp(color) ,1.0);\n}\n#endif\n#if defined(VLSMERGE)\nuniform sampler2D originalSampler;\nvoid main(void)\n{\ngl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);\n}\n#endif\n#if defined(LUMINANCE)\nuniform vec2 lumOffsets[4];\nvoid main()\n{\nfloat average=0.0;\nvec4 color=vec4(0.0);\nfloat maximum=-1e20;\nvec3 weight=vec3(0.299,0.587,0.114);\nfor (int i=0; i<4; i++)\n{\ncolor=texture2D(textureSampler,vUV+ lumOffsets[i]);\nfloat GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));\n#ifdef WEIGHTED_AVERAGE\nfloat GreyValue=dot(color.rgb,weight);\n#endif\n#ifdef BRIGHTNESS\nfloat GreyValue=max(color.r,max(color.g,color.b));\n#endif\n#ifdef HSL_COMPONENT\nfloat GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));\n#endif\n#ifdef MAGNITUDE\nfloat GreyValue=length(color.rgb);\n#endif\nmaximum=max(maximum,GreyValue);\naverage+=(0.25*log(1e-5+GreyValue));\n}\naverage=exp(average);\ngl_FragColor=vec4(average,maximum,0.0,1.0);\n}\n#endif\n#if defined(LUMINANCE_DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];\nuniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLER\n#include<packingFunctions>\n#endif\nvoid main()\n{\nvec4 color=vec4(0.0);\nfloat average=0.0;\nfor (int i=0; i<9; i++)\n{\ncolor=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);\naverage+=color.r;\n}\naverage/=9.0;\n#ifdef FINAL_DOWN_SAMPLER\ngl_FragColor=pack(average);\n#else\ngl_FragColor=vec4(average,average,0.0,1.0);\n#endif\n}\n#endif\n#if defined(HDR)\nuniform sampler2D textureAdderSampler;\nuniform float averageLuminance;\nvoid main()\n{\nvec4 color=texture2D(textureAdderSampler,vUV);\n#ifndef AUTO_EXPOSURE\nvec4 adjustedColor=color/averageLuminance;\ncolor=adjustedColor;\ncolor.a=1.0;\n#endif\ngl_FragColor=color;\n}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;\nuniform float strength;\nuniform float ghostDispersal;\nuniform float haloWidth;\nuniform vec2 resolution;\nuniform float distortionStrength;\nfloat hash(vec2 p)\n{\nfloat h=dot(p,vec2(127.1,311.7));\nreturn -1.0+2.0*fract(sin(h)*43758.5453123);\n}\nfloat noise(in vec2 p)\n{\nvec2 i=floor(p);\nvec2 f=fract(p);\nvec2 u=f*f*(3.0-2.0*f);\nreturn mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);\n}\nfloat fbm(vec2 p)\n{\nfloat f=0.0;\nf+=0.5000*noise(p); p*=2.02;\nf+=0.2500*noise(p); p*=2.03;\nf+=0.1250*noise(p); p*=2.01;\nf+=0.0625*noise(p); p*=2.04;\nf/=0.9375;\nreturn f;\n}\nvec3 pattern(vec2 uv)\n{\nvec2 p=-1.0+2.0*uv;\nfloat p2=dot(p,p);\nfloat f=fbm(vec2(15.0*p2))/2.0;\nfloat r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));\nfloat g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));\nfloat b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));\nreturn (1.0-f)*vec3(r,g,b);\n}\nfloat luminance(vec3 color)\n{\nreturn dot(color.rgb,vec3(0.2126,0.7152,0.0722));\n}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{\nreturn vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);\n}\nvoid main(void)\n{\nvec2 uv=-vUV+vec2(1.0);\nvec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;\nvec2 texelSize=1.0/resolution;\nvec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);\nvec4 result=vec4(0.0);\nfloat ghostIndice=1.0;\nfor (int i=0; i<GHOSTS; ++i)\n{\nvec2 offset=fract(uv+ghostDir*ghostIndice);\nfloat weight=length(vec2(0.5)-offset)/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;\nghostIndice+=1.0;\n}\nvec2 haloVec=normalize(ghostDir)*haloWidth;\nfloat weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;\nresult*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));\ngl_FragColor=result;\n}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;\nuniform sampler2D lensDirtSampler;\nuniform sampler2D lensStarSampler;\nuniform mat4 lensStarMatrix;\nvoid main(void)\n{\nvec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;\nvec4 lensMod=texture2D(lensDirtSampler,vUV);\nlensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);\nvec4 result=texture2D(textureSampler,vUV)*lensMod;\ngl_FragColor=texture2D(otherSampler,vUV)+result;\n}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;\nuniform sampler2D depthSampler;\nuniform float distance;\nvoid main(void)\n{\nvec4 sharp=texture2D(otherSampler,vUV);\nvec4 blur=texture2D(textureSampler,vUV);\nfloat dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);\nfloat factor=0.0;\nif (dist<0.05)\nfactor=1.0;\nelse if (dist<0.1)\nfactor=20.0*(0.1-dist);\nelse if (dist<0.5)\nfactor=0.0;\nelse\nfactor=2.0*(dist-0.5);\nfactor=clamp(factor,0.0,0.90);\ngl_FragColor=mix(sharp,blur,factor);\n}\n#endif\n#if defined(MOTION_BLUR)\nuniform mat4 inverseViewProjection;\nuniform mat4 prevViewProjection;\nuniform vec2 screenSize;\nuniform float motionScale;\nuniform float motionStrength;\nuniform sampler2D depthSampler;\nvoid main(void)\n{\nvec2 texelSize=1.0/screenSize;\nfloat depth=texture2D(depthSampler,vUV).r;\nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);\ncpos=cpos*inverseViewProjection;\nvec4 ppos=cpos*prevViewProjection;\nppos.xyz/=ppos.w;\nppos.xy=ppos.xy*0.5+0.5;\nvec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;\nfloat speed=length(velocity/texelSize);\nint nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));\nvec4 result=texture2D(textureSampler,vUV);\nfor (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {\nif (i>=nSamples)\nbreak;\nvec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\nresult+=texture2D(textureSampler,offset1);\n}\ngl_FragColor=result/float(nSamples);\n}\n#endif\n";ii.ShadersStore[mT]=vT;class gT extends jx{constructor(t,i,e,s=null,n){super(i.getEngine(),t),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this.mdt=null,this.vdt=1,this.gdt=1,this.Sdt=!1,this.Edt=1,this.Adt=1,this.Cdt=!1,this.dft=[],this.gft=!1,this.Sft=!1,this.wdt=!1,this.xdt=!1,this.Tdt=!1,this.Rdt=!1,this.Aft=!1,this.Idt=!1,this.Qut=64,this.Mdt=50,this.dw=1,this.out=n||i.cameras,this.out=this.out.slice(),this.dft=this.out.slice(),this.Kt=i,this.bdt=s,this.Fut=e,this._dt=i.getEngine().getCaps().textureFloatRender?1:2,i.postProcessRenderPipelineManager.addPipeline(this),this.kft()}get exposure(){return this.vdt}set exposure(t){this.vdt=t,this.gdt=t}get hdrAutoExposure(){return this.Sdt}set hdrAutoExposure(t){if(this.Sdt=t,this.hdrPostProcess){const i=["#define HDR"];t&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(i.join("\n"))}}get motionStrength(){return this.Adt}set motionStrength(t){this.Adt=t,this.Cdt&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=t)}get objectBasedMotionBlur(){return this.Cdt}set objectBasedMotionBlur(t){const i=this.Cdt!==t;this.Cdt=t,i&&this.kft()}get BloomEnabled(){return this.gft}set BloomEnabled(t){this.gft!==t&&(this.gft=t,this.kft())}get DepthOfFieldEnabled(){return this.Sft}set DepthOfFieldEnabled(t){this.Sft!==t&&(this.Sft=t,this.kft())}get LensFlareEnabled(){return this.xdt}set LensFlareEnabled(t){this.xdt!==t&&(this.xdt=t,this.kft())}get HDREnabled(){return this.Tdt}set HDREnabled(t){this.Tdt!==t&&(this.Tdt=t,this.kft())}get VLSEnabled(){return this.wdt}set VLSEnabled(t){if(this.wdt!==t){if(t){if(!this.Kt.enableGeometryBufferRenderer())return void F.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline")}this.wdt=t,this.kft()}}get MotionBlurEnabled(){return this.Rdt}set MotionBlurEnabled(t){this.Rdt!==t&&(this.Rdt=t,this.kft())}get fxaaEnabled(){return this.Aft}set fxaaEnabled(t){this.Aft!==t&&(this.Aft=t,this.kft())}get screenSpaceReflectionsEnabled(){return this.Idt}set screenSpaceReflectionsEnabled(t){this.Idt!==t&&(this.Idt=t,this.kft())}get volumetricLightStepsCount(){return this.Mdt}set volumetricLightStepsCount(t){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+t.toFixed(1)),this.Mdt=t}get motionBlurSamples(){return this.Qut}set motionBlurSamples(t){this.motionBlurPostProcess&&(this.Cdt?this.motionBlurPostProcess.motionBlurSamples=t:this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+t.toFixed(1))),this.Qut=t}get samples(){return this.dw}set samples(t){this.dw!==t&&(this.dw=t,this.kft())}kft(){const t=this.Fut,i=this.Kt;this.Hft(),null!==this.out&&(this.Kt.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.hn,this.out),this.out=this.dft.slice()),this.HL(),this.Idt&&(this.screenSpaceReflectionPostProcess=new pT("HDRPass",i,t,null,an.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,this._dt),this.screenSpaceReflectionPostProcess.onApplyObservable.add((()=>{this.mdt=this.screenSpaceReflectionPostProcess})),this.addEffect(new Uw(i.getEngine(),"HDRScreenSpaceReflections",(()=>this.screenSpaceReflectionPostProcess),!0))),this.bdt?this.originalPostProcess=this.bdt:this.originalPostProcess=new nr("HDRPass","standard",[],[],t,null,an.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,"#define PASS_POST_PROCESS",this._dt),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add((()=>{this.mdt=this.originalPostProcess})),this.addEffect(new Uw(i.getEngine(),"HDRPassPostProcess",(()=>this.originalPostProcess),!0)),this.gft&&(this.ydt(i,t/4),this.Ndt(i,t/4),this.Pdt(i,t/4,1),this.Ddt(i,t),this.textureAdderFinalPostProcess=new nr("HDRDepthOfFieldSource","standard",[],[],t,null,an.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Uw(i.getEngine(),"HDRBaseDepthOfFieldSource",(()=>this.textureAdderFinalPostProcess),!0))),this.wdt&&(this.Ldt(i,t),this.volumetricLightFinalPostProcess=new nr("HDRVLSFinal","standard",[],[],t,null,an.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Uw(i.getEngine(),"HDRVLSFinal",(()=>this.volumetricLightFinalPostProcess),!0))),this.xdt&&(this.Odt(i,t),this.lensFlareFinalPostProcess=new nr("HDRPostLensFlareDepthOfFieldSource","standard",[],[],t,null,an.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Uw(i.getEngine(),"HDRPostLensFlareDepthOfFieldSource",(()=>this.lensFlareFinalPostProcess),!0))),this.Tdt&&(this.Fdt(i,this._dt),this.Bdt(i,t),this.hdrFinalPostProcess=new nr("HDRPostHDReDepthOfFieldSource","standard",[],[],t,null,an.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Uw(i.getEngine(),"HDRPostHDReDepthOfFieldSource",(()=>this.hdrFinalPostProcess),!0))),this.Sft&&(this.Pdt(i,t/2,3,"depthOfFieldBlurWidth"),this.Udt(i,t)),this.Rdt&&this.Vdt(i,t),this.Aft&&(this.fxaaPostProcess=new Ax("fxaa",1,null,an.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,0),this.addEffect(new Uw(i.getEngine(),"HDRFxaa",(()=>this.fxaaPostProcess),!0))),null!==this.out&&this.Kt.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this.hn,this.out),!this.cft(this.dw)&&this.dw>1&&F.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}ydt(t,i){const e=new Array(32);this.downSampleX4PostProcess=new nr("HDRDownSampleX4","standard",["dsOffsets"],[],i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._dt),this.downSampleX4PostProcess.onApply=t=>{let i=0;const s=this.downSampleX4PostProcess.width,n=this.downSampleX4PostProcess.height;for(let t=-2;t<2;t++)for(let r=-2;r<2;r++)e[i]=(t+.5)*(1/s),e[i+1]=(r+.5)*(1/n),i+=2;t.setArray2("dsOffsets",e)},this.addEffect(new Uw(t.getEngine(),"HDRDownSampleX4",(()=>this.downSampleX4PostProcess),!0))}Ndt(t,i){const e=new Array(8);this.brightPassPostProcess=new nr("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define BRIGHT_PASS",this._dt),this.brightPassPostProcess.onApply=t=>{const i=1/this.brightPassPostProcess.width,s=1/this.brightPassPostProcess.height;e[0]=-.5*i,e[1]=.5*s,e[2]=.5*i,e[3]=.5*s,e[4]=-.5*i,e[5]=-.5*s,e[6]=.5*i,e[7]=-.5*s,t.setArray2("dsOffsets",e),t.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new Uw(t.getEngine(),"HDRBrightPass",(()=>this.brightPassPostProcess),!0))}Pdt(t,i,e,s="blurWidth"){const n=t.getEngine(),r=new xm("HDRBlurH_"+e,new C(1,0),this[s],i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._dt),h=new xm("HDRBlurV_"+e,new C(0,1),this[s],i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._dt);r.onActivateObservable.add((()=>{const t=r.width/n.getRenderWidth();r.kernel=this[s]*t})),h.onActivateObservable.add((()=>{const t=h.height/n.getRenderHeight();h.kernel=this.horizontalBlur?64*t:this[s]*t})),this.addEffect(new Uw(t.getEngine(),"HDRBlurH"+e,(()=>r),!0)),this.addEffect(new Uw(t.getEngine(),"HDRBlurV"+e,(()=>h),!0)),this.blurHPostProcesses.push(r),this.blurVPostProcesses.push(h)}Ddt(t,i){this.textureAdderPostProcess=new nr("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define TEXTURE_ADDER",this._dt),this.textureAdderPostProcess.onApply=t=>{t.setTextureFromPostProcess("otherSampler",this.wdt?this.mdt:this.originalPostProcess),t.setTexture("lensSampler",this.lensTexture),t.setFloat("exposure",this.gdt),this.mdt=this.textureAdderFinalPostProcess},this.addEffect(new Uw(t.getEngine(),"HDRTextureAdder",(()=>this.textureAdderPostProcess),!0))}Ldt(t,i){const e=t.enableGeometryBufferRenderer();e.enablePosition=!0;const s=e.getGBuffer();this.volumetricLightPostProcess=new nr("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],i/8,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define VLS\n#define NB_STEPS "+this.Mdt.toFixed(1));const n=C.Zero();this.volumetricLightPostProcess.onApply=t=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this.Kt.activeCamera){const i=this.sourceLight.getShadowGenerator();t.setTexture("shadowMapSampler",i.getShadowMap()),t.setTexture("positionSampler",s.textures[2]),t.setColor3("sunColor",this.sourceLight.diffuse),t.setVector3("sunDirection",this.sourceLight.getShadowDirection()),t.setVector3("cameraPosition",this.Kt.activeCamera.globalPosition),t.setMatrix("shadowViewProjection",i.getTransformMatrix()),t.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),t.setFloat("scatteringPower",this.volumetricLightPower),n.x=this.sourceLight.getDepthMinZ(this.Kt.activeCamera),n.y=this.sourceLight.getDepthMaxZ(this.Kt.activeCamera),t.setVector2("depthValues",n)}},this.addEffect(new Uw(t.getEngine(),"HDRVLS",(()=>this.volumetricLightPostProcess),!0)),this.Pdt(t,i/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new nr("HDRVLSMerge","standard",[],["originalSampler"],i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=t=>{t.setTextureFromPostProcess("originalSampler",this.gft?this.textureAdderFinalPostProcess:this.originalPostProcess),this.mdt=this.volumetricLightFinalPostProcess},this.addEffect(new Uw(t.getEngine(),"HDRVLSMerge",(()=>this.volumetricLightMergePostProces),!0))}Fdt(t,i){let e=Math.pow(3,gT.LuminanceSteps);this.luminancePostProcess=new nr("HDRLuminance","standard",["lumOffsets"],[],{width:e,height:e},null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define LUMINANCE",i);const s=[];this.luminancePostProcess.onApply=t=>{const i=1/this.luminancePostProcess.width,e=1/this.luminancePostProcess.height;s[0]=-.5*i,s[1]=.5*e,s[2]=.5*i,s[3]=.5*e,s[4]=-.5*i,s[5]=-.5*e,s[6]=.5*i,s[7]=-.5*e,t.setArray2("lumOffsets",s)},this.addEffect(new Uw(t.getEngine(),"HDRLuminance",(()=>this.luminancePostProcess),!0));for(let s=gT.LuminanceSteps-1;s>=0;s--){e=Math.pow(3,s);let n="#define LUMINANCE_DOWN_SAMPLE\n";0===s&&(n+="#define FINAL_DOWN_SAMPLER");const r=new nr("HDRLuminanceDownSample"+s,"standard",["dsOffsets","halfDestPixelSize"],[],{width:e,height:e},null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,n,i);this.luminanceDownSamplePostProcesses.push(r)}let n=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(((i,e)=>{const s=new Array(18);i.onApply=t=>{if(!n)return;let r=0;for(let t=-1;t<2;t++)for(let i=-1;i<2;i++)s[r]=t/n.width,s[r+1]=i/n.height,r+=2;t.setArray2("dsOffsets",s),t.setFloat("halfDestPixelSize",.5/n.width),n=e===this.luminanceDownSamplePostProcesses.length-1?this.luminancePostProcess:i},e===this.luminanceDownSamplePostProcesses.length-1&&(i.onAfterRender=()=>{const i=t.getEngine().readPixels(0,0,1,1),e=new x(1/16581375,1/65025,1/255,1);i.then((t=>{const i=new Uint8Array(t.buffer);this.Edt=(i[0]*e.x+i[1]*e.y+i[2]*e.z+i[3]*e.w)/100}))}),this.addEffect(new Uw(t.getEngine(),"HDRLuminanceDownSample"+e,(()=>i),!0))}))}Bdt(t,i){const e=["#define HDR"];this.Sdt&&e.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new nr("HDR","standard",["averageLuminance"],["textureAdderSampler"],i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,e.join("\n"),0);let s=1,n=0,r=0;this.hdrPostProcess.onApply=i=>{if(i.setTextureFromPostProcess("textureAdderSampler",this.mdt),n+=t.getEngine().getDeltaTime(),s<0)s=this.Edt;else{const t=(r-n)/1e3;this.Edt<s+this.hdrDecreaseRate*t?s+=this.hdrDecreaseRate*t:this.Edt>s-this.hdrIncreaseRate*t?s-=this.hdrIncreaseRate*t:s=this.Edt}this.hdrAutoExposure?this.gdt=this.vdt/s:(s=o.Clamp(s,this.hdrMinimumLuminance,1e20),i.setFloat("averageLuminance",s)),r=n,this.mdt=this.hdrFinalPostProcess},this.addEffect(new Uw(t.getEngine(),"HDR",(()=>this.hdrPostProcess),!0))}Odt(t,i){this.lensFlarePostProcess=new nr("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],i/2,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new Uw(t.getEngine(),"HDRLensFlare",(()=>this.lensFlarePostProcess),!0)),this.Pdt(t,i/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new nr("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new Uw(t.getEngine(),"HDRLensFlareCompose",(()=>this.lensFlareComposePostProcess),!0));const e=new C(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=t=>{t.setTextureFromPostProcess("textureSampler",this.gft?this.blurHPostProcesses[0]:this.originalPostProcess),t.setTexture("lensColorSampler",this.lensColorTexture),t.setFloat("strength",this.lensFlareStrength),t.setFloat("ghostDispersal",this.lensFlareGhostDispersal),t.setFloat("haloWidth",this.lensFlareHaloWidth),e.x=this.lensFlarePostProcess.width,e.y=this.lensFlarePostProcess.height,t.setVector2("resolution",e),t.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const s=R.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),n=R.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=t=>{if(!this.Kt.activeCamera)return;t.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),t.setTexture("lensDirtSampler",this.lensFlareDirtTexture),t.setTexture("lensStarSampler",this.lensStarTexture);const i=this.Kt.activeCamera.getViewMatrix().getRow(0),e=this.Kt.activeCamera.getViewMatrix().getRow(2);let r=w.Dot(i.toVector3(),new w(1,0,0))+w.Dot(e.toVector3(),new w(0,0,1));r*=4;const h=R.FromValues(.5*Math.cos(r),-Math.sin(r),0,0,Math.sin(r),.5*Math.cos(r),0,0,0,0,1,0,0,0,0,1),o=n.multiply(h).multiply(s);t.setMatrix("lensStarMatrix",o),this.mdt=this.lensFlareFinalPostProcess}}Udt(t,i){this.depthOfFieldPostProcess=new nr("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=t=>{t.setTextureFromPostProcess("otherSampler",this.mdt),t.setTexture("depthSampler",this.kdt()),t.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new Uw(t.getEngine(),"HDRDepthOfField",(()=>this.depthOfFieldPostProcess),!0))}Vdt(t,i){if(this.Cdt){const e=new Gx("HDRMotionBlur",t,i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0);e.motionStrength=this.motionStrength,e.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=e}else{this.motionBlurPostProcess=new nr("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],i,null,an.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),0);let e=0,s=R.Identity();const n=R.Identity();let r=R.Identity();const h=C.Zero();this.motionBlurPostProcess.onApply=i=>{r=t.getProjectionMatrix().multiply(t.getViewMatrix()),r.invertToRef(n),i.setMatrix("inverseViewProjection",n),i.setMatrix("prevViewProjection",s),s=r,h.x=this.motionBlurPostProcess.width,h.y=this.motionBlurPostProcess.height,i.setVector2("screenSize",h),e=t.getEngine().getFps()/60,i.setFloat("motionScale",e),i.setFloat("motionStrength",this.motionStrength),i.setTexture("depthSampler",this.kdt())}}this.addEffect(new Uw(t.getEngine(),"HDRMotionBlur",(()=>this.motionBlurPostProcess),!0))}kdt(){if(this.Kt.getEngine().getCaps().drawBuffersExtension){return this.Kt.enableGeometryBufferRenderer().getGBuffer().textures[0]}return this.Kt.enableDepthRenderer().getDepthMap()}Hft(){for(let t=0;t<this.out.length;t++){const i=this.out[t];this.originalPostProcess&&this.originalPostProcess.dispose(i),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(i),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(i),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(i),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(i),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(i),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(i),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(i),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(i),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(i),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(i),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(i);for(let t=0;t<this.luminanceDownSamplePostProcesses.length;t++)this.luminanceDownSamplePostProcesses[t].dispose(i);this.luminancePostProcess&&this.luminancePostProcess.dispose(i),this.hdrPostProcess&&this.hdrPostProcess.dispose(i),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(i),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(i),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(i),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(i);for(let t=0;t<this.blurHPostProcesses.length;t++)this.blurHPostProcesses[t].dispose(i);for(let t=0;t<this.blurVPostProcesses.length;t++)this.blurVPostProcesses[t].dispose(i)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this.Hft(),this.Kt.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.hn,this.out),super.dispose()}serialize(){const t=ot.Serialize(this);return this.sourceLight&&(t.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(t.screenSpaceReflectionPostProcess=ot.Serialize(this.screenSpaceReflectionPostProcess)),t.customType="StandardRenderingPipeline",t}static Parse(t,i,e){const s=ot.Parse((()=>new gT(t.hn,i,t.Fut)),t,i,e);return t.sourceLightId&&(s.sourceLight=i.getLightById(t.sourceLightId)),t.screenSpaceReflectionPostProcess&&ot.Parse((()=>s.screenSpaceReflectionPostProcess),t.screenSpaceReflectionPostProcess,i,e),s}}gT.LuminanceSteps=6,ut([Q()],gT.prototype,"brightThreshold",void 0),ut([Q()],gT.prototype,"blurWidth",void 0),ut([Q()],gT.prototype,"horizontalBlur",void 0),ut([Q()],gT.prototype,"exposure",null),ut([Z("lensTexture")],gT.prototype,"lensTexture",void 0),ut([Q()],gT.prototype,"volumetricLightCoefficient",void 0),ut([Q()],gT.prototype,"volumetricLightPower",void 0),ut([Q()],gT.prototype,"volumetricLightBlurScale",void 0),ut([Q()],gT.prototype,"hdrMinimumLuminance",void 0),ut([Q()],gT.prototype,"hdrDecreaseRate",void 0),ut([Q()],gT.prototype,"hdrIncreaseRate",void 0),ut([Q()],gT.prototype,"hdrAutoExposure",null),ut([Z("lensColorTexture")],gT.prototype,"lensColorTexture",void 0),ut([Q()],gT.prototype,"lensFlareStrength",void 0),ut([Q()],gT.prototype,"lensFlareGhostDispersal",void 0),ut([Q()],gT.prototype,"lensFlareHaloWidth",void 0),ut([Q()],gT.prototype,"lensFlareDistortionStrength",void 0),ut([Q()],gT.prototype,"lensFlareBlurWidth",void 0),ut([Z("lensStarTexture")],gT.prototype,"lensStarTexture",void 0),ut([Z("lensFlareDirtTexture")],gT.prototype,"lensFlareDirtTexture",void 0),ut([Q()],gT.prototype,"depthOfFieldDistance",void 0),ut([Q()],gT.prototype,"depthOfFieldBlurWidth",void 0),ut([Q()],gT.prototype,"motionStrength",null),ut([Q()],gT.prototype,"objectBasedMotionBlur",null),ut([Q()],gT.prototype,"_ratio",void 0),ut([Q()],gT.prototype,"BloomEnabled",null),ut([Q()],gT.prototype,"DepthOfFieldEnabled",null),ut([Q()],gT.prototype,"LensFlareEnabled",null),ut([Q()],gT.prototype,"HDREnabled",null),ut([Q()],gT.prototype,"VLSEnabled",null),ut([Q()],gT.prototype,"MotionBlurEnabled",null),ut([Q()],gT.prototype,"fxaaEnabled",null),ut([Q()],gT.prototype,"screenSpaceReflectionsEnabled",null),ut([Q()],gT.prototype,"volumetricLightStepsCount",null),ut([Q()],gT.prototype,"motionBlurSamples",null),ut([Q()],gT.prototype,"samples",null),v("BABYLON.StandardRenderingPipeline",gT);const ST="tonemapPixelShader",ET="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;\nconst float B=0.50;\nconst float C=0.10;\nconst float D=0.20;\nconst float E=0.02;\nconst float F=0.30;\nconst float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{\nreturn dot(c,vec3(0.22,0.707,0.071));\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;\nfloat scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nconst float ExposureBias=2.0;\nvec3 x=ExposureBias*colour;\nvec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\nx=vec3(W,W,W);\nvec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);\ncolour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);\n}";ii.ShadersStore[ST]=ET;var AT;!function(t){t[t.Hable=0]="Hable",t[t.Reinhard=1]="Reinhard",t[t.HejiDawson=2]="HejiDawson",t[t.Photographic=3]="Photographic"}(AT||(AT={}));const CT="volumetricLightScatteringPixelShader",wT="uniform sampler2D textureSampler;\nuniform sampler2D lightScatteringSampler;\nuniform float decay;\nuniform float exposure;\nuniform float weight;\nuniform float density;\nuniform vec2 meshPositionOnScreen;\nvarying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec2 tc=vUV;\nvec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);\ndeltaTexCoord*=1.0/float(NUM_SAMPLES)*density;\nfloat illuminationDecay=1.0;\nvec4 color=texture2D(lightScatteringSampler,tc)*0.4;\nfor(int i=0; i<NUM_SAMPLES; i++) {\ntc-=deltaTexCoord;\nvec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;\ndataSample*=illuminationDecay*weight;\ncolor+=dataSample;\nilluminationDecay*=decay;\n}\nvec4 realColor=texture2D(textureSampler,vUV);\ngl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";ii.ShadersStore[CT]=wT;const xT="volumetricLightScatteringPassVertexShader",TT="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nuniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n";ii.ShadersStore[xT]=TT;const RT="volumetricLightScatteringPassPixelShader",IT="#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);\nif (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\n}\n";ii.ShadersStore[RT]=IT;class MT extends nr{constructor(t,i,e,s,n=100,r=an.BILINEAR_SAMPLINGMODE,h,o,a){var l,c;super(t,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],i.postProcessRatio||i,e,r,h,o,"#define NUM_SAMPLES "+n),this.Gdt=C.Zero(),this.customMeshPosition=w.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=new Array,this.includedMeshes=new Array,this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,h=(a=null!==(c=null!==(l=null==e?void 0:e.getScene())&&void 0!==l?l:a)&&void 0!==c?c:this.Kt).getEngine(),this.zdt=new rs(0,0,1,1).toGlobal(h.getRenderWidth(),h.getRenderHeight()),this.mesh=null!=s?s:MT.CreateDefaultMesh("VolumetricLightScatteringMesh",a),this.Hdt(a,i.passRatio||i),this.onActivate=t=>{this.isSupported||this.dispose(t),this.onActivate=null},this.onApplyObservable.add((t=>{this.Xdt(a),t.setTexture("lightScatteringSampler",this.Wdt),t.setFloat("exposure",this.exposure),t.setFloat("decay",this.decay),t.setFloat("weight",this.weight),t.setFloat("density",this.density),t.setVector2("meshPositionOnScreen",this.Gdt)}))}get useDiffuseColor(){return F.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(t){F.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}getClassName(){return"VolumetricLightScatteringPostProcess"}di(t,i){var e;const s=t.getMesh();if(s===this.mesh&&s.material)return s.material.isReady(s);const n=null===(e=s._m.WT)||void 0===e?void 0:e[this.Kt.getEngine().currentRenderPassId];if(n)return n.isReadyForSubMesh(s,t,i);const r=[],h=[he.PositionKind],o=t.getMaterial();o&&(o.needAlphaTesting()&&r.push("#define ALPHATEST"),s.isVerticesDataPresent(he.UVKind)&&(h.push(he.UVKind),r.push("#define UV1")),s.isVerticesDataPresent(he.UV2Kind)&&(h.push(he.UV2Kind),r.push("#define UV2"))),s.useBones&&s.computeBonesUsingShaders?(h.push(he.MatricesIndicesKind),h.push(he.MatricesWeightsKind),r.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),r.push("#define BonesPerMesh "+(s.skeleton?s.skeleton.bones.length+1:0))):r.push("#define NUM_BONE_INFLUENCERS 0"),i&&(r.push("#define INSTANCES"),Fs.PushAttributesForInstances(h),t.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES"));const a=t.mC(void 0,!0),l=a.defines,c=r.join("\n");return l!==c&&a.setEffect(s.getScene().getEngine().createEffect("volumetricLightScatteringPass",h,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],c,void 0,void 0,void 0,{maxSimultaneousMorphTargets:s.numBoneInfluencers}),c),a.effect.isReady()}setCustomMeshPosition(t){this.customMeshPosition=t}getCustomMeshPosition(){return this.customMeshPosition}dispose(t){const i=t.getScene().customRenderTargets.indexOf(this.Wdt);-1!==i&&t.getScene().customRenderTargets.splice(i,1),this.Wdt.dispose(),super.dispose(t)}getPass(){return this.Wdt}$dt(t){return this.includedMeshes.length>0&&-1===this.includedMeshes.indexOf(t)||this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(t)}Hdt(t,i){const e=t.getEngine();this.Wdt=new br("volumetricLightScatteringMap",{width:e.getRenderWidth()*i,height:e.getRenderHeight()*i},t,!1,!0,0),this.Wdt.wrapU=an.CLAMP_ADDRESSMODE,this.Wdt.wrapV=an.CLAMP_ADDRESSMODE,this.Wdt.renderList=null,this.Wdt.renderParticles=!1,this.Wdt.ignoreCameraViewport=!0;const s=this.getCamera();s?s.customRenderTargets.push(this.Wdt):t.customRenderTargets.push(this.Wdt);const n=t=>{var i;const e=t.getRenderingMesh(),s=t.getEffectiveMesh();if(this.$dt(e))return;s._m.ET=!1;const n=t.getMaterial();if(!n)return;const r=e.getScene(),h=r.getEngine();h.setState(n.backFaceCulling,void 0,void 0,void 0,n.cullBackFaces);const o=e.KI(t.Al,!!t.getReplacementMesh());if(o.mustReturn)return;const a=h.getCaps().instancedArrays&&(null!==o.visibleInstances[t.Al]||e.hasThinInstances);if(this.di(t,a)){const l=null===(i=s._m.WT)||void 0===i?void 0:i[h.currentRenderPassId];let c=t.mC();if(e!==this.mesh||c||(c=n.mC()),!c)return;const u=c.effect;if(h.enableEffect(c),a||e.$C(t,u,n.fillMode),e===this.mesh)n.bind(s.getWorldMatrix(),e);else if(l)l.bindForSubMesh(s.getWorldMatrix(),s,t);else{if(u.setMatrix("viewProjection",r.getTransformMatrix()),n&&n.needAlphaTesting()){const t=n.getAlphaTestTexture();u.setTexture("diffuseSampler",t),t&&u.setMatrix("diffuseMatrix",t.getTextureMatrix())}e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&u.setMatrices("mBones",e.skeleton.getTransformMatrices(e))}a&&e.hasThinInstances&&u.setMatrix("world",s.getWorldMatrix()),e.eM(s,t,u,Vs.TriangleFillMode,o,a,((t,i)=>{t||u.setMatrix("world",i)}))}};let r;const h=new y(0,0,0,1);this.Wdt.onBeforeRenderObservable.add((()=>{r=t.clearColor,t.clearColor=h})),this.Wdt.onAfterRenderObservable.add((()=>{t.clearColor=r})),this.Wdt.customIsReadyFunction=(t,i,s)=>{if((s||0===i)&&t.subMeshes)for(let i=0;i<t.subMeshes.length;++i){const s=t.subMeshes[i],n=s.getMaterial(),r=s.getRenderingMesh();if(!n)continue;const h=r.KI(s.Al,!!s.getReplacementMesh()),o=e.getCaps().instancedArrays&&(null!==h.visibleInstances[s.Al]||r.hasThinInstances);if(!this.di(s,o))return!1}return!0},this.Wdt.customRenderFunction=(i,e,s,r)=>{const h=t.getEngine();let o;if(r.length){for(h.setColorWrite(!1),o=0;o<r.length;o++)n(r.data[o]);h.setColorWrite(!0)}for(o=0;o<i.length;o++)n(i.data[o]);for(o=0;o<e.length;o++)n(e.data[o]);if(s.length){for(o=0;o<s.length;o++){const i=s.data[o],e=i.getBoundingInfo();e&&t.activeCamera&&(i.Gf=i.getMesh().alphaIndex,i.zf=e.boundingSphere.centerWorld.subtract(t.activeCamera.position).length())}const i=s.data.slice(0,s.length);for(i.sort(((t,i)=>t.Gf>i.Gf?1:t.Gf<i.Gf?-1:t.zf<i.zf?1:t.zf>i.zf?-1:0)),h.setAlphaMode(2),o=0;o<i.length;o++)n(i[o]);h.setAlphaMode(0)}}}Xdt(t){const i=t.getTransformMatrix();let e;e=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const s=w.Project(e,R.Identity(),i,this.zdt);this.Gdt.x=s.x/this.zdt.width,this.Gdt.y=s.y/this.zdt.height,this.invert&&(this.Gdt.y=1-this.Gdt.y)}static CreateDefaultMesh(t,i){const e=En(t,{size:1},i);e.billboardMode=ys.BILLBOARDMODE_ALL;const s=new sc(t+"Material",i);return s.emissiveColor=new _(1,1,1),e.material=s,e}}ut([et()],MT.prototype,"customMeshPosition",void 0),ut([Q()],MT.prototype,"useCustomMeshPosition",void 0),ut([Q()],MT.prototype,"invert",void 0),ut([st()],MT.prototype,"mesh",void 0),ut([Q()],MT.prototype,"excludedMeshes",void 0),ut([Q()],MT.prototype,"includedMeshes",void 0),ut([Q()],MT.prototype,"exposure",void 0),ut([Q()],MT.prototype,"decay",void 0),ut([Q()],MT.prototype,"weight",void 0),ut([Q()],MT.prototype,"density",void 0),v("BABYLON.VolumetricLightScatteringPostProcess",MT);const bT="screenSpaceCurvaturePixelShader",_T="precision highp float;\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D normalSampler;\nuniform float curvature_ridge;\nuniform float curvature_valley;\n#ifndef CURVATURE_OFFSET\n#define CURVATURE_OFFSET 1\n#endif\nfloat curvature_soft_clamp(float curvature,float control)\n{\nif (curvature<0.5/control)\nreturn curvature*(1.0-curvature*control);\nreturn 0.25/control;\n}\nfloat calculate_curvature(ivec2 texel,float ridge,float valley)\n{\nvec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;\nvec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;\nvec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;\nvec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;\nfloat normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));\nif (normal_diff<0.0)\nreturn -2.0*curvature_soft_clamp(-normal_diff,valley);\nreturn 2.0*curvature_soft_clamp(normal_diff,ridge);\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nivec2 texel=ivec2(gl_FragCoord.xy);\nvec4 baseColor=texture2D(textureSampler,vUV);\nfloat curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);\nbaseColor.rgb*=curvature+1.0;\ngl_FragColor=baseColor;\n}";ii.ShadersStore[bT]=_T;class yT extends nr{constructor(t,i,e,s,n,r,h,o=0,a=!1){super(t,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],e,s,n,r,h,void 0,o,void 0,null,a),this.ridge=1,this.valley=1,this.qut=i.enableGeometryBufferRenderer(),this.qut?this.onApply=t=>{t.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),t.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));const i=this.qut.getGBuffer().textures[1];t.setTexture("normalSampler",i)}:F.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}getClassName(){return"ScreenSpaceCurvaturePostProcess"}static get IsSupported(){const t=E.LastCreatedEngine;return!!t&&t.getCaps().drawBuffersExtension}static SL(t,i,e,s){return ot.Parse((()=>new yT(t.name,e,t.options,i,t.renderTargetSamplingMode,e.getEngine(),t.textureType,t.reusable)),t,e,s)}}ut([Q()],yT.prototype,"ridge",void 0),ut([Q()],yT.prototype,"valley",void 0),v("BABYLON.ScreenSpaceCurvaturePostProcess",yT);const NT="boundingBoxRendererFragmentDeclaration",PT="uniform vec4 color;\n";ii.IncludesShadersStore[NT]=PT;const DT="boundingBoxRendererUboDeclaration",LT="#ifdef WEBGL2\nuniform vec4 color;\nuniform mat4 world;\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#else\nlayout(std140,column_major) uniform;\nuniform BoundingBoxRenderer {\nvec4 color;\nmat4 world;\nmat4 viewProjection;\nmat4 viewProjectionR;\n};\n#endif\n";ii.IncludesShadersStore[DT]=LT;const OT="boundingBoxRendererPixelShader",FT="#include<__decl__boundingBoxRendererFragment>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";ii.ShadersStore[OT]=FT;const BT="boundingBoxRendererVertexDeclaration",UT="uniform mat4 world;\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n";ii.IncludesShadersStore[BT]=UT;const VT="boundingBoxRendererVertexShader",kT="attribute vec3 position;\n#include<__decl__boundingBoxRendererVertex>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec4 worldPos=world*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n";ii.ShadersStore[VT]=kT;Object.defineProperty(ke.prototype,"forceShowBoundingBoxes",{get:function(){return this.Ydt||!1},set:function(t){this.Ydt=t,t&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0}),ke.prototype.getBoundingBoxRenderer=function(){return this.jdt||(this.jdt=new GT(this)),this.jdt},Object.defineProperty(ys.prototype,"showBoundingBox",{get:function(){return this.Kdt||!1},set:function(t){this.Kdt=t,t&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});class GT{constructor(t){this.name=fe.NAME_BOUNDINGBOXRENDERER,this.frontColor=new _(1,1,1),this.backColor=new _(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new h,this.onAfterBoxRenderingObservable=new h,this.onResourcesReadyObservable=new h,this.enabled=!0,this.renderList=new zi(32),this.ff={},this.qdt=null,this.Qdt=null,this.scene=t,t.Ig(this),this.Zdt=new ne(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!this.scene.getEngine().isWebGPU),this.kT(this.Zdt),this.Jdt=new ne(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!this.scene.getEngine().isWebGPU),this.kT(this.Jdt)}kT(t){t.addUniform("color",4),t.addUniform("world",16),t.addUniform("viewProjection",16),t.addUniform("viewProjectionR",16),t.create()}register(){this.scene.Wv.registerStep(fe.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene.Yv.registerStep(fe.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this.tpt),this.scene.$v.registerStep(fe.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this.qg),this.scene.ad.registerStep(fe.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}qg(t,i){if(t.showSubMeshesBoundingBox){const e=i.getBoundingInfo();null!=e&&(e.boundingBox.ipt=t.renderingGroupId,this.renderList.push(e.boundingBox))}}tpt(t){if(t.showBoundingBox||this.scene.forceShowBoundingBoxes){const i=t.getBoundingInfo();i.boundingBox.ipt=t.renderingGroupId,this.renderList.push(i.boundingBox)}}ept(){if(this.spt)return;this.spt=new eu("colorShader",this.scene,"boundingBoxRenderer",{attributes:[he.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!1),this.spt.doNotSerialize=!0,this.spt.reservedDataStore={hidden:!0},this.npt=new eu("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[he.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!0),this.npt.doNotSerialize=!0,this.npt.reservedDataStore={hidden:!0};const t=this.scene.getEngine(),i=jc({size:1});this.ff[he.PositionKind]=new he(t,i.positions,he.PositionKind,!1),this.KO(),this.Qdt=i.indices,this.onResourcesReadyObservable.notifyObservers(this)}KO(){const t=this.scene.getEngine();this.Xu=t.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){const t=this.ff[he.PositionKind];t&&t.br(),this.KO()}reset(){this.renderList.reset()}render(t){var i,e;if(0===this.renderList.length||!this.enabled)return;if(this.ept(),!this.spt.isReady())return;const s=this.scene.getEngine();s.setDepthWrite(!1);const n=this.frontColor.toColor4(),r=this.backColor.toColor4(),h=this.scene.getTransformMatrix();for(let o=0;o<this.renderList.length;o++){const a=this.renderList.data[o];if(a.ipt!==t)continue;this.rpt(a),this.onBeforeBoxRenderingObservable.notifyObservers(a);const l=a.minimum,c=a.maximum.subtract(l),u=l.add(c.scale(.5)),f=R.Scaling(c.x,c.y,c.z).multiply(R.Translation(u.x,u.y,u.z)).multiply(a.getWorldMatrix()),d=s.useReverseDepthBuffer;if(this.showBackLines){const t=null!==(i=a.iC)&&void 0!==i?i:this.spt.mC();this.spt.QR(t),s.bindBuffers(this.ff,this.Xu,this.spt.getEffect()),d?s.setDepthFunctionToLessOrEqual():s.setDepthFunctionToGreaterOrEqual(),this.Jdt.bindToEffect(t.effect,"BoundingBoxRenderer"),this.Jdt.updateDirectColor4("color",r),this.Jdt.updateMatrix("world",f),this.Jdt.updateMatrix("viewProjection",h),this.Jdt.update(),s.drawElementsType(Vs.LineListDrawMode,0,24)}const p=null!==(e=a.tC)&&void 0!==e?e:this.spt.mC();this.spt.QR(p),s.bindBuffers(this.ff,this.Xu,this.spt.getEffect()),d?s.setDepthFunctionToGreater():s.setDepthFunctionToLess(),this.Zdt.bindToEffect(p.effect,"BoundingBoxRenderer"),this.Zdt.updateDirectColor4("color",n),this.Zdt.updateMatrix("world",f),this.Zdt.updateMatrix("viewProjection",h),this.Zdt.update(),s.drawElementsType(Vs.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(a)}this.spt.unbind(),s.setDepthFunctionToLessOrEqual(),s.setDepthWrite(!0)}rpt(t){if(!t.tC){const i=this.scene.getEngine();t.tC=new vi(i),t.iC=new vi(i),t.tC.setEffect(this.spt.getEffect()),t.iC.setEffect(this.spt.getEffect())}}renderOcclusionBoundingBox(t){const i=this.scene.getEngine();void 0===this.hpt&&(this.hpt=i.createRenderPassId("Render pass for occlusion query"));const e=i.currentRenderPassId;i.currentRenderPassId=this.hpt,this.ept();const s=t.subMeshes[0];if(!this.npt.isReady(t,void 0,s)||!t.hasBoundingInfo)return void(i.currentRenderPassId=e);this.qdt||(this.qdt=i.createIndexBuffer(this.Qdt));const n=i.useReverseDepthBuffer;i.setDepthWrite(!1),i.setColorWrite(!1);const r=t.getBoundingInfo().boundingBox,h=r.minimum,o=r.maximum.subtract(h),a=h.add(o.scale(.5)),l=R.Scaling(o.x,o.y,o.z).multiply(R.Translation(a.x,a.y,a.z)).multiply(r.getWorldMatrix()),c=s.SC;this.npt.QR(c),i.bindBuffers(this.ff,this.qdt,c.effect),n?i.setDepthFunctionToGreater():i.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this.Zdt.bindToEffect(c.effect,"BoundingBoxRenderer"),this.Zdt.updateMatrix("world",l),this.Zdt.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this.Zdt.update(),i.drawElementsType(Vs.TriangleFillMode,0,36),this.npt.unbind(),i.setDepthFunctionToLessOrEqual(),i.setDepthWrite(!0),i.setColorWrite(!0),i.currentRenderPassId=e}dispose(){if(void 0!==this.hpt&&(this.scene.getEngine().releaseRenderPassId(this.hpt),this.hpt=void 0),!this.spt)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this.spt.dispose(),this.npt.dispose(),this.Zdt.dispose(),this.Jdt.dispose();const t=this.ff[he.PositionKind];t&&(t.dispose(),this.ff[he.PositionKind]=null),this.scene.getEngine().ca(this.Xu),this.qdt&&(this.scene.getEngine().ca(this.qdt),this.qdt=null)}}ke.prototype.enableDepthRenderer=function(t,i=!1,e=!1,s=3){if(!(t=t||this.activeCamera))throw"No camera available to enable depth renderer";if(this.Fet||(this.Fet={}),!this.Fet[t.id]){const n=!!this.getEngine().getCaps().textureFloatRender;let r=0;r=!this.getEngine().getCaps().textureHalfFloatRender||e&&n?n?1:0:2,this.Fet[t.id]=new wE(this,r,t,i,s)}return this.Fet[t.id]},ke.prototype.disableDepthRenderer=function(t){(t=t||this.activeCamera)&&this.Fet&&this.Fet[t.id]&&this.Fet[t.id].dispose()};class zT{constructor(t){this.name=fe.NAME_DEPTHRENDERER,this.scene=t}register(){this.scene.zv.registerStep(fe.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this.xst),this.scene.Hv.registerStep(fe.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this.opt)}rebuild(){}dispose(){for(const t in this.scene.Fet)this.scene.Fet[t].dispose()}xst(t){if(this.scene.Fet)for(const i in this.scene.Fet){const e=this.scene.Fet[i];e.enabled&&!e.useOnlyInActiveCamera&&t.push(e.getDepthMap())}}opt(t){if(this.scene.Fet)for(const i in this.scene.Fet){const e=this.scene.Fet[i];e.enabled&&e.useOnlyInActiveCamera&&this.scene.activeCamera.id===i&&t.push(e.getDepthMap())}}}wE.qM=t=>{let i=t.Mg(fe.NAME_DEPTHRENDERER);i||(i=new zT(t),t.Ig(i))};const HT="oitFinalPixelShader",XT="precision highp float;\nuniform sampler2D uFrontColor;\nuniform sampler2D uBackColor;\nvoid main() {\nivec2 fragCoord=ivec2(gl_FragCoord.xy);\nvec4 frontColor=texelFetch(uFrontColor,fragCoord,0);\nvec4 backColor=texelFetch(uBackColor,fragCoord,0);\nfloat alphaMultiplier=1.0-frontColor.a;\nglFragColor=vec4(\nfrontColor.rgb+alphaMultiplier*backColor.rgb,\nfrontColor.a+backColor.a\n);\n}";ii.ShadersStore[HT]=XT;const WT="oitBackBlendPixelShader",$T="precision highp float;\nuniform sampler2D uBackColor;\nvoid main() {\nglFragColor=texelFetch(uBackColor,ivec2(gl_FragCoord.xy),0);\nif (glFragColor.a==0.0) { \ndiscard;\n}\n}";ii.ShadersStore[WT]=$T;class YT{constructor(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}}class jT{constructor(t,i=5){if(this.apt=[],this.lpt=0,this.cpt=[[!0],[!0,!0],[!0,!0,!0]],this.upt=[],this.fpt=new zi(10),this.dpt=new zi(10),this.gH=[],this.ppt=[new y(jT.mpt,jT.mpt,0,0),new y(-jT.vpt,jT.gpt,0,0),new y(0,0,0,0)],this.Kt=t,this.Ls=t.getEngine(),this.Spt=i,t.enablePrePassRenderer()){for(let t=0;t<this.cpt.length;++t)this.upt[t]=this.Ls.buildTextureLayout(this.cpt[t]);this.oO=[],this.useRenderPasses=!1,this.gL=new YT,this.Krt(),this.Ept()}else F.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.")}get passCount(){return this.Spt}set passCount(t){this.Spt!==t&&(this.Spt=t,this.Apt())}get useRenderPasses(){return this.Cpt}set useRenderPasses(t){this.Cpt!==t&&(this.Cpt=t,this.Apt())}addExcludedMesh(t){-1===this.gH.indexOf(t.uniqueId)&&this.gH.push(t.uniqueId)}removeExcludedMesh(t){const i=this.gH.indexOf(t.uniqueId);-1!==i&&this.gH.splice(i,1)}Apt(){if(this.wpt(),this.Cpt)for(let t=0;t<this.Spt+1;++t)this.oO[t]||(this.oO[t]=this.Ls.createRenderPassId(`DepthPeelingRenderer - pass #${t}`))}wpt(){for(let t=0;t<this.oO.length;++t)this.Ls.releaseRenderPassId(this.oO[t]);this.oO=[]}Krt(){const t={width:this.Ls.getRenderWidth(),height:this.Ls.getRenderHeight()};this.xpt=[new _A("depthPeelingDepth0",t,3,this.Kt),new _A("depthPeelingDepth1",t,3,this.Kt)],this.Tpt=[new _A("depthPeelingColor0",t,2,this.Kt,{generateDepthBuffer:!1}),new _A("depthPeelingColor1",t,2,this.Kt,{generateDepthBuffer:!1})],this.Rpt=new _A("depthPeelingBack",t,1,this.Kt,{generateDepthBuffer:!1}),this.Ipt=new br("depthPeelingOutput",t,this.Kt,!1);const i=[{format:7,samplingMode:1,type:this.Ls.getCaps().textureFloatLinearFiltering?1:2},{format:5,samplingMode:1,type:2}];for(let e=0;e<2;e++){const s=this.Ls.Ta(t,i[0],!1),n=this.Ls.Ta(t,i[1],!1),r=this.Ls.Ta(t,i[1],!1);this.xpt[e].setInternalTexture(s,0),this.xpt[e].setInternalTexture(n,1),this.xpt[e].setInternalTexture(r,2),this.Tpt[e].setInternalTexture(n,0),this.Tpt[e].setInternalTexture(r,1),this.apt.push(new sn(s),new sn(n),new sn(r))}}uL(){for(let t=0;t<this.apt.length;t++)6!==t&&this.apt[t].dispose();for(let t=0;t<2;t++)this.xpt[t].dispose(!0),this.Tpt[t].dispose(!0),this.Rpt.dispose(!0);this.Ipt.dispose(),this.apt=[],this.Tpt=[],this.xpt=[]}Mpt(){return this.xpt[0].getSize().width===this.Ls.getRenderWidth()&&this.xpt[0].getSize().height===this.Ls.getRenderHeight()||(this.uL(),this.Krt()),this.nht()}nht(){var t;const i=this.Kt.prePassRenderer;if(!i)return!1;const e=i.getIndex(4),s=(null===(t=i.defaultRT.textures)||void 0===t?void 0:t.length)?i.defaultRT.textures[e].getInternalTexture():null;return!!s&&(this.bpt!==s&&(this.bpt=s,this.Rpt.setInternalTexture(this.bpt,0),this.apt[6]&&this.apt[6].dispose(),this.apt[6]=new sn(this.bpt),i.defaultRT.renderTarget.VD(this.xpt[0].renderTarget)),!0)}Ept(){this._pt=new xr({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this.Ls,samplerNames:["uBackColor"],uniformNames:[]}),this.ypt=new xr({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this.Ls,samplerNames:["uBackColor"],uniformNames:[]}),this.Npt=new xr({fragmentShader:"oitFinal",useShaderStore:!0,engine:this.Ls,samplerNames:["uFrontColor","uBackColor"],uniformNames:[]}),this.kst=new wr(this.Ls)}setPrePassRenderer(t){t.addEffectConfiguration(this.gL)}bind(t){t.setTexture("oitDepthSampler",this.apt[3*this.lpt]),t.setTexture("oitFrontColorSampler",this.apt[3*this.lpt+1])}Ppt(t){let i;this.Cpt&&(i={});for(let e=0;e<t.length;e++){const s=t.data[e].getMaterial();let n=!0,r=!1;const h=t.data[e];let o,a=!1;if(this.Cpt&&(o=h.mC(),a=!o),s&&(n=s.allowShaderHotSwapping,r=s.backFaceCulling,s.allowShaderHotSwapping=!1,s.backFaceCulling=!1),h.render(!1),a&&(o=h.mC(),o.materialContext)){let t=i[o.materialContext.uniqueId];t||(t=i[o.materialContext.uniqueId]=this.Ls.createMaterialContext()),h.mC().materialContext=t}s&&(s.allowShaderHotSwapping=n,s.backFaceCulling=r)}}Dpt(t){var i;(null===(i=this.Kt.prePassRenderer)||void 0===i?void 0:i.setCustomOutput(this.Ipt))?this.Ls.bindFramebuffer(this.Ipt.renderTarget):this.Ls.restoreDefaultFramebuffer(),this.Ls.setAlphaMode(0),this.Ls.applyStates(),this.Ls.enableEffect(this.Npt.SC),this.Npt.effect.setTexture("uFrontColor",this.apt[3*t+1]),this.Npt.effect.setTexture("uBackColor",this.apt[6]),this.kst.render(this.Npt)}render(t){if(this.fpt.length=0,this.dpt.length=0,!(this._pt.effect.isReady()&&this.ypt.effect.isReady()&&this.Npt.effect.isReady()&&this.Mpt()))return this.dpt;for(let i=0;i<t.length;i++){const e=t.data[i],s=e.getMaterial();!s||s.fillMode!==Vs.TriangleFanDrawMode&&s.fillMode!==Vs.TriangleFillMode&&s.fillMode!==Vs.TriangleStripDrawMode||-1!==this.gH.indexOf(e.getMesh().uniqueId)?this.dpt.push(e):this.fpt.push(e)}if(!this.fpt.length)return this.Ls.bindFramebuffer(this.Tpt[1].renderTarget),this.Ls.bindAttachments(this.upt[1]),this.Ls.clear(this.ppt[2],!0,!1,!1),this.Ls.unBindFramebuffer(this.Tpt[1].renderTarget),this.Dpt(1),this.dpt;const i=this.Ls.currentRenderPassId;this.Kt.prePassRenderer.ih=!1,this.Cpt&&(this.Ls.currentRenderPassId=this.oO[0]),this.Ls.bindFramebuffer(this.xpt[0].renderTarget),this.Ls.bindAttachments(this.upt[0]),this.Ls.clear(this.ppt[0],!0,!1,!1),this.Ls.unBindFramebuffer(this.xpt[0].renderTarget),this.Ls.bindFramebuffer(this.xpt[1].renderTarget),this.Ls.bindAttachments(this.upt[0]),this.Ls.clear(this.ppt[1],!0,!1,!1),this.Ls.unBindFramebuffer(this.xpt[1].renderTarget),this.Ls.bindFramebuffer(this.Tpt[0].renderTarget),this.Ls.bindAttachments(this.upt[1]),this.Ls.clear(this.ppt[2],!0,!1,!1),this.Ls.unBindFramebuffer(this.Tpt[0].renderTarget),this.Ls.bindFramebuffer(this.Tpt[1].renderTarget),this.Ls.bindAttachments(this.upt[1]),this.Ls.clear(this.ppt[2],!0,!1,!1),this.Ls.unBindFramebuffer(this.Tpt[1].renderTarget),this.Ls.bindFramebuffer(this.xpt[0].renderTarget),this.Ls.bindAttachments(this.upt[0]),this.Ls.setAlphaMode(11),this.Ls.setAlphaEquation(3),this.Ls.depthCullingState.depthMask=!1,this.Ls.depthCullingState.depthTest=!0,this.Ls.applyStates(),this.lpt=1,this.Ppt(this.fpt),this.Ls.unBindFramebuffer(this.xpt[0].renderTarget),this.Kt.resetCachedMaterial();let e=0,s=0;for(let t=0;t<this.Spt;t++){e=t%2,s=1-e,this.lpt=e,this.Cpt&&(this.Ls.currentRenderPassId=this.oO[t+1]),this.Ls.bindFramebuffer(this.xpt[s].renderTarget),this.Ls.bindAttachments(this.upt[0]),this.Ls.clear(this.ppt[0],!0,!1,!1),this.Ls.unBindFramebuffer(this.xpt[s].renderTarget),this.Ls.bindFramebuffer(this.Tpt[s].renderTarget),this.Ls.bindAttachments(this.upt[1]),this.Ls.clear(this.ppt[2],!0,!1,!1),this.Ls.unBindFramebuffer(this.Tpt[s].renderTarget),this.Ls.bindFramebuffer(this.xpt[s].renderTarget),this.Ls.bindAttachments(this.upt[2]),this.Ls.setAlphaMode(11),this.Ls.setAlphaEquation(3),this.Ls.depthCullingState.depthTest=!1,this.Ls.applyStates(),this.Ppt(this.fpt),this.Ls.unBindFramebuffer(this.xpt[s].renderTarget),this.Kt.resetCachedMaterial(),this.Ls.bindFramebuffer(this.Rpt.renderTarget),this.Ls.bindAttachments(this.upt[0]),this.Ls.setAlphaEquation(0),this.Ls.setAlphaMode(17),this.Ls.applyStates();const i=0!==s&&this.Cpt?this.ypt:this._pt;this.Ls.enableEffect(i.SC),i.effect.setTexture("uBackColor",this.apt[3*s+2]),this.kst.render(i),this.Ls.unBindFramebuffer(this.Rpt.renderTarget)}return this.Ls.currentRenderPassId=i,this.Dpt(s),this.Kt.prePassRenderer.ih=!0,this.Ls.depthCullingState.depthMask=!0,this.Ls.depthCullingState.depthTest=!0,this.dpt}dispose(){this.uL(),this._pt.dispose(),this.Npt.dispose(),this.kst.dispose(),this.wpt()}}jT.mpt=-99999,jT.vpt=0,jT.gpt=1,Object.defineProperty(ke.prototype,"depthPeelingRenderer",{get:function(){if(!this.Lpt){let t=this.Mg(fe.NAME_DEPTHPEELINGRENDERER);t||(t=new KT(this),this.Ig(t))}return this.Lpt},set:function(t){this.Lpt=t},enumerable:!0,configurable:!0}),Object.defineProperty(ke.prototype,"useOrderIndependentTransparency",{get:function(){return this.Opt},set:function(t){var i;this.Opt!==t&&(this.Opt=t,this.markAllMaterialsAsDirty(63),null===(i=this.prePassRenderer)||void 0===i||i.markAsDirty())},enumerable:!0,configurable:!0});class KT{constructor(t){this.name=fe.NAME_DEPTHPEELINGRENDERER,this.scene=t,t.depthPeelingRenderer=new jT(t)}register(){}rebuild(){}dispose(){var t;null===(t=this.scene.depthPeelingRenderer)||void 0===t||t.dispose(),this.scene.depthPeelingRenderer=null}}const qT="linePixelShader",QT="#include<clipPlaneFragmentDeclaration>\nuniform vec4 color;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";ii.ShadersStore[qT]=QT;const ZT="lineVertexShader",JT="#include<instancesDeclaration>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;\nattribute vec4 normal;\nuniform mat4 viewProjection;\nuniform float width;\nuniform float aspectRatio;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\nmat4 worldViewProjection=viewProjection*finalWorld;\nvec4 viewPosition=worldViewProjection*vec4(position,1.0);\nvec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);\nvec2 currentScreen=viewPosition.xy/viewPosition.w;\nvec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;\ncurrentScreen.x*=aspectRatio;\nnextScreen.x*=aspectRatio;\nvec2 dir=normalize(nextScreen-currentScreen);\nvec2 normalDir=vec2(-dir.y,dir.x);\nnormalDir*=width/2.0;\nnormalDir.x/=aspectRatio;\nvec4 offset=vec4(normalDir*normal.w,0.0,0.0);\ngl_Position=viewPosition+offset;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#include<clipPlaneVertex>\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[ZT]=JT;ys.prototype.disableEdgesRendering=function(){return this.$f&&(this.$f.dispose(),this.$f=null),this},ys.prototype.enableEdgesRendering=function(t=.95,i=!1,e){return this.disableEdgesRendering(),this.$f=new iR(this,t,i,!0,e),this},Object.defineProperty(ys.prototype,"edgesRenderer",{get:function(){return this.$f},enumerable:!0,configurable:!0}),ou.prototype.enableEdgesRendering=function(t=.95,i=!1){return this.disableEdgesRendering(),this.$f=new eR(this,t,i),this},au.prototype.enableEdgesRendering=function(t=.95,i=!1){return ou.prototype.enableEdgesRendering.apply(this,arguments),this};class tR{constructor(){this.edges=new Array,this.edgesConnectedCount=0}}class iR{constructor(t,i=.95,e=!1,s=!0,n){var r;this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this.Fpt=new Array,this.Bpt=new Array,this.Upt=new Array,this.kc={},this.Vpt={},this.kpt=!1,this.isEnabled=!0,this.customInstances=new zi(32),this.$n=t,this.kpt=e,this.wb=null!=n?n:null,this.Oj=i,this.$n.getScene().getEngine().isWebGPU&&(this.SC=new vi(t.getEngine())),this.Gpt(),s&&(null===(r=null==n?void 0:n.useAlternateEdgeFinder)||void 0===r||r?this.zpt():this.Hpt()),this.Xpt=this.$n.onRebuildObservable.add((()=>{this.br()})),this.Wpt=this.$n.onDisposeObservable.add((()=>{this.dispose()}))}get linesPositions(){return this.Fpt}get linesNormals(){return this.Bpt}get linesIndices(){return this.Upt}get lineShader(){return this.$pt}set lineShader(t){this.$pt=t}static Ypt(t){if(!t.jpt){const i=new eu("lineShader",t,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"]},!1);i.disableDepthWrite=!0,i.backFaceCulling=!1,i.checkReadyOnEveryCall=t.getEngine().isWebGPU,t.jpt=i}return t.jpt}Gpt(){this.$pt||(this.$pt=iR.Ypt(this.$n.getScene()))}br(){let t=this.kc[he.PositionKind];t&&t.br(),t=this.kc[he.NormalKind],t&&t.br();const i=this.$n.getScene().getEngine();this.Kpt=i.createIndexBuffer(this.Upt)}dispose(){var t;this.$n.onRebuildObservable.remove(this.Xpt),this.$n.onDisposeObservable.remove(this.Wpt);let i=this.kc[he.PositionKind];i&&(i.dispose(),this.kc[he.PositionKind]=null),i=this.kc[he.NormalKind],i&&(i.dispose(),this.kc[he.NormalKind]=null),this.Kpt&&this.$n.getScene().getEngine().ca(this.Kpt),this.$pt.dispose(),null===(t=this.SC)||void 0===t||t.dispose()}qpt(t,i,e,s,n){return t===e&&i===s||t===s&&i===e?0:t===s&&i===n||t===n&&i===s?1:t===n&&i===e||t===e&&i===n?2:-1}Qpt(t,i,e,s,n){const r=1e-10;return t.equalsWithEpsilon(e,r)&&i.equalsWithEpsilon(s,r)||t.equalsWithEpsilon(s,r)&&i.equalsWithEpsilon(e,r)?0:t.equalsWithEpsilon(s,r)&&i.equalsWithEpsilon(n,r)||t.equalsWithEpsilon(n,r)&&i.equalsWithEpsilon(s,r)?1:t.equalsWithEpsilon(n,r)&&i.equalsWithEpsilon(e,r)||t.equalsWithEpsilon(e,r)&&i.equalsWithEpsilon(n,r)?2:-1}Zpt(t,i,e,s,n){let r;if(void 0===i)r=!0;else{r=w.Dot(e[t],e[i])<this.Oj}r&&this.createLine(s,n,this.Fpt.length/3)}createLine(t,i,e){this.Fpt.push(t.x,t.y,t.z,t.x,t.y,t.z,i.x,i.y,i.z,i.x,i.y,i.z),this.Bpt.push(i.x,i.y,i.z,-1,i.x,i.y,i.z,1,t.x,t.y,t.z,-1,t.x,t.y,t.z,1),this.Upt.push(e,e+1,e+2,e,e+2,e+3)}Jpt(t,i,e,s){const n=(t,i,e)=>{e>=0&&i.push(e);for(let e=0;e<t.length;++e)i.push(t[e][0])};let r=0;t[1].length>=t[0].length&&t[1].length>=t[2].length?r=1:t[2].length>=t[0].length&&t[2].length>=t[1].length&&(r=2);for(let i=0;i<3;++i)i===r?t[i].sort(((t,i)=>t[1]<i[1]?-1:t[1]>i[1]?1:0)):t[i].sort(((t,i)=>t[1]>i[1]?-1:t[1]<i[1]?1:0));const h=[],o=[];n(t[r],h,-1);const a=h.length;for(let h=r+2;h>=r+1;--h)n(t[h%3],o,h!==r+2?s[e[i+(h+1)%3]]:-1);const l=o.length;e.push(s[e[i+r]],h[0],o[0]),e.push(s[e[i+(r+1)%3]],o[l-1],h[a-1]);const c=a<=l,u=c?a:l,f=c?l:a,d=c?a-1:l-1,p=c?0:1;let m=a+l-2,v=0,g=0;const S=c?h:o,E=c?o:h;let A=0;for(;m-- >0;){let t;p?e.push(S[v],E[g]):e.push(E[g],S[v]),A+=u,A>=f&&v<d?(t=S[++v],A-=f):t=E[++g],e.push(t)}e[i+0]=e[e.length-3],e[i+1]=e[e.length-2],e[i+2]=e[e.length-1],e.length=e.length-3}zpt(){var t,i,e,s,n,r,h,o,a,l;const c=this.$n.getVerticesData(he.PositionKind);let u=this.$n.getIndices();if(!u||!c)return;Array.isArray(u)||(u=Array.from(u));const f=null===(i=null===(t=this.wb)||void 0===t?void 0:t.useFastVertexMerger)||void 0===i||i,d=f?Math.round(-Math.log(null!==(s=null===(e=this.wb)||void 0===e?void 0:e.epsilonVertexMerge)&&void 0!==s?s:1e-6)/Math.log(10)):null!==(r=null===(n=this.wb)||void 0===n?void 0:n.epsilonVertexMerge)&&void 0!==r?r:1e-6,p=[],m=[];if(f){const t={};for(let i=0;i<c.length;i+=3){const e=c[i+0],s=c[i+1],n=c[i+2],r=e.toFixed(d)+"|"+s.toFixed(d)+"|"+n.toFixed(d);if(void 0!==t[r])p.push(t[r]);else{const e=i/3;t[r]=e,p.push(e),m.push(e)}}}else for(let t=0;t<c.length;t+=3){const i=c[t+0],e=c[t+1],s=c[t+2];let n=!1;for(let r=0;r<t&&!n;r+=3){const t=c[r+0],h=c[r+1],o=c[r+2];if(Math.abs(i-t)<d&&Math.abs(e-h)<d&&Math.abs(s-o)<d){p.push(r/3),n=!0;break}}n||(p.push(t/3),m.push(t/3))}if(null===(h=this.wb)||void 0===h?void 0:h.applyTessellation){const t=null!==(a=null===(o=this.wb)||void 0===o?void 0:o.epsilonVertexAligned)&&void 0!==a?a:1e-6,i=[];for(let e=0;e<u.length;e+=3){let s;for(let n=0;n<3;++n){const r=p[u[e+n]],h=p[u[e+(n+1)%3]],o=p[u[e+(n+2)%3]];if(r===h)continue;const a=c[3*r+0],l=c[3*r+1],f=c[3*r+2],d=c[3*h+0],v=c[3*h+1],g=c[3*h+2],S=Math.sqrt((d-a)*(d-a)+(v-l)*(v-l)+(g-f)*(g-f));for(let u=0;u<m.length-1;u++){const p=m[u];if(p===r||p===h||p===o)continue;const E=c[3*p+0],A=c[3*p+1],C=c[3*p+2],w=Math.sqrt((E-a)*(E-a)+(A-l)*(A-l)+(C-f)*(C-f)),x=Math.sqrt((E-d)*(E-d)+(A-v)*(A-v)+(C-g)*(C-g));Math.abs(w+x-S)<t&&(s||(s={index:e,edgesPoints:[[],[],[]]},i.push(s)),s.edgesPoints[n].push([p,w]))}}}for(let t=0;t<i.length;++t){const e=i[t];this.Jpt(e.edgesPoints,e.index,u,p)}i.length=0}const v={};for(let t=0;t<u.length;t+=3){let i;for(let e=0;e<3;++e){let s=p[u[t+e]],n=p[u[t+(e+1)%3]];const r=p[u[t+(e+2)%3]];if(s===n||(s===r||n===r)&&(null===(l=this.wb)||void 0===l?void 0:l.removeDegeneratedTriangles))continue;if(M.Vector3[0].copyFromFloats(c[3*s+0],c[3*s+1],c[3*s+2]),M.Vector3[1].copyFromFloats(c[3*n+0],c[3*n+1],c[3*n+2]),M.Vector3[2].copyFromFloats(c[3*r+0],c[3*r+1],c[3*r+2]),i||(M.Vector3[1].subtractToRef(M.Vector3[0],M.Vector3[3]),M.Vector3[2].subtractToRef(M.Vector3[1],M.Vector3[4]),i=w.Cross(M.Vector3[3],M.Vector3[4]),i.normalize()),s>n){const t=s;s=n,n=t}const h=s+"_"+n,o=v[h];if(o){if(!o.done){w.Dot(i,o.normal)<this.Oj&&this.createLine(M.Vector3[0],M.Vector3[1],this.Fpt.length/3),o.done=!0}}else v[h]={normal:i,done:!1,index:t,i:e}}}for(const t in v){const i=v[t];if(!i.done){const t=p[u[i.index+i.i]],e=p[u[i.index+(i.i+1)%3]];M.Vector3[0].copyFromFloats(c[3*t+0],c[3*t+1],c[3*t+2]),M.Vector3[1].copyFromFloats(c[3*e+0],c[3*e+1],c[3*e+2]),this.createLine(M.Vector3[0],M.Vector3[1],this.Fpt.length/3)}}const g=this.$n.getScene().getEngine();this.kc[he.PositionKind]=new he(g,this.Fpt,he.PositionKind,!1),this.kc[he.NormalKind]=new he(g,this.Bpt,he.NormalKind,!1,!1,4),this.Vpt[he.PositionKind]=this.kc[he.PositionKind],this.Vpt[he.NormalKind]=this.kc[he.NormalKind],this.Kpt=g.createIndexBuffer(this.Upt),this.tmt=this.Upt.length}Hpt(){const t=this.$n.getVerticesData(he.PositionKind),i=this.$n.getIndices();if(!i||!t)return;const e=new Array,s=new Array;let n,r;for(n=0;n<i.length;n+=3){r=new tR;const h=i[n],o=i[n+1],a=i[n+2];r.p0=new w(t[3*h],t[3*h+1],t[3*h+2]),r.p1=new w(t[3*o],t[3*o+1],t[3*o+2]),r.p2=new w(t[3*a],t[3*a+1],t[3*a+2]);const l=w.Cross(r.p1.subtract(r.p0),r.p2.subtract(r.p1));l.normalize(),s.push(l),e.push(r)}for(n=0;n<e.length;n++){r=e[n];for(let t=n+1;t<e.length;t++){const s=e[t];if(3===r.edgesConnectedCount)break;if(3===s.edgesConnectedCount)continue;const h=i[3*t],o=i[3*t+1],a=i[3*t+2];for(let e=0;e<3;e++){let l=0;if(void 0===r.edges[e]){switch(e){case 0:l=this.kpt?this.Qpt(r.p0,r.p1,s.p0,s.p1,s.p2):this.qpt(i[3*n],i[3*n+1],h,o,a);break;case 1:l=this.kpt?this.Qpt(r.p1,r.p2,s.p0,s.p1,s.p2):this.qpt(i[3*n+1],i[3*n+2],h,o,a);break;case 2:l=this.kpt?this.Qpt(r.p2,r.p0,s.p0,s.p1,s.p2):this.qpt(i[3*n+2],i[3*n],h,o,a)}if(-1!==l&&(r.edges[e]=t,s.edges[l]=n,r.edgesConnectedCount++,s.edgesConnectedCount++,3===r.edgesConnectedCount))break}}}}for(n=0;n<e.length;n++){const t=e[n];this.Zpt(n,t.edges[0],s,t.p0,t.p1),this.Zpt(n,t.edges[1],s,t.p1,t.p2),this.Zpt(n,t.edges[2],s,t.p2,t.p0)}const h=this.$n.getScene().getEngine();this.kc[he.PositionKind]=new he(h,this.Fpt,he.PositionKind,!1),this.kc[he.NormalKind]=new he(h,this.Bpt,he.NormalKind,!1,!1,4),this.Vpt[he.PositionKind]=this.kc[he.PositionKind],this.Vpt[he.NormalKind]=this.kc[he.NormalKind],this.Kpt=h.createIndexBuffer(this.Upt),this.tmt=this.Upt.length}isReady(){return this.$pt.isReady(this.$n,this.$n.hasInstances&&this.customInstances.length>0||this.$n.hasThinInstances)}render(){const t=this.$n.getScene(),i=this.$pt.mC();if(this.SC&&this.$pt.YR(this.SC),!this.isReady()||!t.activeCamera)return void this.$pt.YR(i);const e=this.$n.hasInstances&&this.customInstances.length>0,s=e||this.$n.hasThinInstances;let n=0;if(s)if(this.Vpt.world0=this.$n.getVertexBuffer("world0"),this.Vpt.world1=this.$n.getVertexBuffer("world1"),this.Vpt.world2=this.$n.getVertexBuffer("world2"),this.Vpt.world3=this.$n.getVertexBuffer("world3"),e){const t=this.$n.bI;if(n=this.customInstances.length,!t.instancesData)return void(this.$n.getScene().lg||this.customInstances.reset());if(!t.isFrozen){let i=0;for(let e=0;e<n;++e)this.customInstances.data[e].copyToArray(t.instancesData,i),i+=16;t.instancesBuffer.updateDirectly(t.instancesData,0,n)}}else n=this.$n.thinInstanceCount;const r=t.getEngine();this.$pt.QR(),1!==this.$n.edgesColor.a?r.setAlphaMode(2):r.setAlphaMode(0),r.bindBuffers(s?this.Vpt:this.kc,this.Kpt,this.$pt.getEffect()),t.resetCachedMaterial(),this.$pt.setColor4("color",this.$n.edgesColor),t.activeCamera.mode===hs.ORTHOGRAPHIC_CAMERA?this.$pt.setFloat("width",this.$n.edgesWidth/this.edgesWidthScalerForOrthographic):this.$pt.setFloat("width",this.$n.edgesWidth/this.edgesWidthScalerForPerspective),this.$pt.setFloat("aspectRatio",r.getAspectRatio(t.activeCamera)),this.$pt.bind(this.$n.getWorldMatrix()),r.drawElementsType(Vs.TriangleFillMode,0,this.tmt,n),this.$pt.unbind(),s&&r.unbindInstanceAttributes(),this.$n.getScene().lg||this.customInstances.reset(),this.$pt.YR(i)}}class eR extends iR{constructor(t,i=.95,e=!1){super(t,i,e,!1),this.Hpt()}Hpt(){const t=this.$n.getVerticesData(he.PositionKind),i=this.$n.getIndices();if(!i||!t)return;const e=M.Vector3[0],s=M.Vector3[1],n=i.length-1;for(let r=0,h=0;r<n;r+=2,h+=4)w.FromArrayToRef(t,3*i[r],e),w.FromArrayToRef(t,3*i[r+1],s),this.createLine(e,s,h);const r=this.$n.getScene().getEngine();this.kc[he.PositionKind]=new he(r,this.Fpt,he.PositionKind,!1),this.kc[he.NormalKind]=new he(r,this.Bpt,he.NormalKind,!1,!1,4),this.Kpt=r.createIndexBuffer(this.Upt),this.tmt=this.Upt.length}}class sR extends _A{constructor(t,i,e,s,n,r){super(t,e,s,n,r),this.imt=[],this.emt=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=i}smt(){this.imageProcessingPostProcess=new oc("prePassComposition",1,null,void 0,this.Ls),this.imageProcessingPostProcess._c()}nmt(){const t=this.Ls.getRenderWidth(!0),i=this.Ls.getRenderHeight(!0),e=this.getRenderWidth(),s=this.getRenderHeight();e===t&&s===i||(this.resize({width:t,height:i}),this.emt=!0)}updateCount(t,i,e){super.updateCount(t,i,e),this.emt=!0}rmt(){this.imt.length=0}dispose(){const t=this.Kt;if(super.dispose(),t&&t.prePassRenderer){const i=t.prePassRenderer.renderTargets.indexOf(this);-1!==i&&t.prePassRenderer.renderTargets.splice(i,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture.vO=null),this.hmt&&(this.hmt.autoClear=!0,this.hmt.restoreDefaultInputTexture())}}class nR{constructor(t){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this.UJ=[],this.omt=[],this.amt=[],this.lmt=[],this.F=!0,this.cmt=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this.Let=new y(0,0,0,0),this.ih=!1,this.umt=!1,this.disableGammaTransform=!1,this.Kt=t,this.Ls=t.getEngine(),nR.qM(this.Kt),this.defaultRT=this.Bst("sceneprePassRT",null),this.Ok=this.defaultRT}getIndex(t){return this.lmt[t]}get samples(){return this.defaultRT.samples}set samples(t){this.defaultRT.samples=t}getRenderTarget(){return this.Ok}fmt(t){t?this.Ok=t:(this.Ok=this.defaultRT,this.Ls.currentRenderPassId=this.Ok.renderPassId)}get currentRTisSceneRT(){return this.Ok===this.defaultRT}dmt(){if(this.doNotUseGeometryRendererFallback)this.pmt&&this.pmt.Hut(),this.pmt=null,this.Kt.disableGeometryBufferRenderer();else{if(this.pmt=this.Kt.enableGeometryBufferRenderer(),!this.pmt)return void(this.doNotUseGeometryRendererFallback=!0);this.pmt.kut(this)}}get enabled(){return this.ih}Bst(t,i){const e=new sR(t,i,{width:this.Ls.getRenderWidth(),height:this.Ls.getRenderHeight()},0,this.Kt,{generateMipMaps:!1,generateStencilBuffer:this.Ls.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(e),e}get isSupported(){return this.Kt.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(t,i){const e=i.getMaterial(),s=e&&e.isPrePassCapable,n=e&&-1!==this.excludedMaterials.indexOf(e);this.enabled&&this.Ok.enabled&&(t.gs&&s&&!n?this.Ls.bindAttachments(this.mmt):(this.Ls.zo?this.Ls.bindAttachments(this.P3):this.Ls.restoreSingleAttachment(),this.pmt&&this.currentRTisSceneRT&&!n&&this.pmt.renderList.push(i.getRenderingMesh())))}vmt(){const t=[],i=[!1],e=[!0];for(let s=0;s<this.mrtCount;s++)t.push(!0),s>0&&(i.push(!0),e.push(!1));this.mmt=this.Ls.buildTextureLayout(t),this.gmt=this.Ls.buildTextureLayout(i),this.P3=this.Ls.buildTextureLayout(e)}Xut(){for(let t=0;t<nR.Smt.length;t++)this.lmt[nR.Smt[t].type]=-1;this.lmt[4]=0,this.omt=[4],this.UJ=[nR.Smt[4].format],this.amt=[nR.Smt[4].name],this.mrtCount=1}Emt(){if(this.dmt(),this.pmt){this.pmt.Xut();const t=[];for(let i=0;i<this.omt.length;i++)t.push(!1);this.pmt.Yut(this.defaultRT.getInternalTexture());const i=[{prePassConstant:5,geometryBufferConstant:Fx.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:Fx.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:Fx.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:Fx.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:Fx.VELOCITY_TEXTURE_TYPE}];for(let e=0;e<i.length;e++){const s=this.omt.indexOf(i[e].prePassConstant);-1!==s&&(this.pmt.Wut(i[e].geometryBufferConstant,s),t[s]=!0)}this.pmt.$ut(this.Ls.buildTextureLayout(t))}}restoreAttachments(){this.enabled&&this.Ok.enabled&&this.P3&&(this.Ls.zo?this.Ls.bindAttachments(this.P3):this.Ls.restoreSingleAttachment())}Amt(t,i,e){this.F&&this.HA(),this.ih&&this.Ok.enabled&&(this.pmt&&(this.pmt.renderList=[]),this.Cmt(this.Ok,t))}mf(t,i,e){t.renderTargetTexture?t.renderTargetTexture.mf(this.Kt,i,e,t.renderTargetTexture.useCameraPostProcesses):this.wmt.length?this.Kt.postProcessManager.mf():this.Ls.restoreDefaultFramebuffer()}setCustomOutput(t){const i=this.wmt[0];return!!i&&(i.inputTexture=t.renderTarget,!0)}xmt(t,i){var e;const s=this.wmt[0],n=s?s.inputTexture:t.renderTargetTexture?t.renderTargetTexture.renderTarget:null;let r=this.Ok.imt;this.umt&&(r=r.concat([this.Ok.imageProcessingPostProcess])),r.length&&(this.Kt.postProcessManager.mf(null===(e=this.Ok.renderTarget)||void 0===e?void 0:e.texture,r),this.Kt.postProcessManager.directRender(r,n,!1,i))}Tmt(t,i){this.ih&&this.Ok.enabled&&(this.mf(this.Ok,t,i),this.xmt(this.Ok,t))}vS(){this.ih&&this.Ok.enabled&&(this.fS(this.Ok),this.Ls.bindAttachments(this.gmt),this.Ls.clear(this.Let,!0,!1,!1),this.Ls.bindAttachments(this.P3))}fS(t){if(this.ih&&this.Ok.enabled){this.Ok.nmt();const t=this.Ok.renderTarget;t&&this.Ls.bindFramebuffer(t)}}Rmt(t){this.ih=t}Imt(t,i){t.enabled=i,i||this.Mmt(t)}addEffectConfiguration(t){for(let i=0;i<this.cmt.length;i++)if(this.cmt[i].name===t.name)return this.cmt[i];return this.cmt.push(t),t}iW(){const t=this.mrtCount;for(let t=0;t<this.cmt.length;t++)this.cmt[t].enabled&&this.bmt(this.cmt[t].texturesRequired);for(let i=0;i<this.renderTargets.length;i++){this.mrtCount===t&&this.renderTargets[i].count===this.mrtCount||this.renderTargets[i].updateCount(this.mrtCount,{types:this.UJ},this.amt.concat("prePass_DepthBuffer")),this.renderTargets[i].rmt();for(let t=0;t<this.cmt.length;t++)this.cmt[t].enabled&&(!this.cmt[t].postProcess&&this.cmt[t].createPostProcess&&this.cmt[t].createPostProcess(),this.cmt[t].postProcess&&this.renderTargets[i].imt.push(this.cmt[t].postProcess))}this.vmt(),this.Rmt(!0),this.Emt()}uut(){this.Rmt(!1);for(let t=0;t<this.renderTargets.length;t++)this.Imt(this.renderTargets[t],!1);this.Xut();for(let t=0;t<this.cmt.length;t++)this.cmt[t].enabled=!1}_mt(t,i){if(i)return i.vf;if(t.renderTargetTexture){if(t.renderTargetTexture.useCameraPostProcesses){const i=t.renderTargetTexture.activeCamera?t.renderTargetTexture.activeCamera:this.Kt.activeCamera;return i?i.vf:[]}return t.renderTargetTexture.postProcesses?t.renderTargetTexture.postProcesses:[]}return this.Kt.activeCamera?this.Kt.activeCamera.vf:[]}Cmt(t,i){const e=i&&this.Kt.activeCameras&&!!this.Kt.activeCameras.length&&0!==this.Kt.activeCameras.indexOf(i);this.wmt=this._mt(t,i),this.wmt=this.wmt.filter((t=>null!=t)),this.Kt.autoClear=!0;const s=this.ymt(this.wmt);this.umt=!s&&!this.disableGammaTransform&&this.Nmt()&&!e;const n=this.bA(this.wmt),r=t.imt&&t.imt[0];let h=null;this.Kt.imageProcessingConfiguration.applyByPostProcess=this.umt||s,this.umt&&!t.imageProcessingPostProcess&&t.smt(),r?h=r:this.umt?h=t.imageProcessingPostProcess:n&&(h=n),this.fS(t),this.Yut(t,h)}Yut(t,i){i&&(i.autoClear=!1,i.inputTexture=t.renderTarget),t.hmt!==i&&(t.hmt&&this.Mmt(t),t.hmt=i),t.emt&&(this.Emt(),t.emt=!1)}Mmt(t){t.hmt&&(t.hmt.autoClear=!0,t.hmt.restoreDefaultInputTexture(),t.hmt=null)}Nmt(){for(let t=0;t<this.cmt.length;t++)if(this.cmt[t].enabled&&this.cmt[t].needsImageProcessing)return!0;return!1}ymt(t){var i;let e=!1;if(t)for(let s=0;s<t.length;s++)if("ImageProcessingPostProcess"===(null===(i=t[s])||void 0===i?void 0:i.getClassName())){e=!0;break}return e}bA(t){for(let i=0;i<t.length;i++)if(null!==t[i])return t[i];return null}markAsDirty(){this.F=!0}bmt(t){this.Kt.needsPreviousWorldMatrices=!1;for(let i=0;i<t.length;i++){const e=t[i];-1===this.lmt[e]&&(this.lmt[e]=this.omt.length,this.omt.push(e),this.UJ.push(nR.Smt[e].format),this.amt.push(nR.Smt[e].name),this.mrtCount++),2===e&&(this.Kt.needsPreviousWorldMatrices=!0)}}HA(){this.uut();let t,i=!1;this.Kt.imageProcessingConfiguration.applyByPostProcess=!1,this.Kt.Lpt&&this.Kt.useOrderIndependentTransparency&&(this.Kt.Lpt.setPrePassRenderer(this),i=!0);for(let t=0;t<this.Kt.materials.length;t++)this.Kt.materials[t].setPrePassRenderer(this)&&(i=!0);i&&this.Imt(this.defaultRT,!0);for(let e=0;e<this.renderTargets.length;e++){if(this.renderTargets[e].renderTargetTexture)t=this._mt(this.renderTargets[e]);else{const i=this.Kt.activeCamera;if(!i)continue;t=i.vf}if(t&&(t=t.filter((t=>null!=t)),t)){for(let s=0;s<t.length;s++)t[s].setPrePassRenderer(this)&&(this.Imt(this.renderTargets[e],!0),i=!0);this.ymt(t)&&(this.Kt.imageProcessingConfiguration.applyByPostProcess=!0)}}this.Pmt(),this.F=!1,i&&this.iW()}Pmt(){const t=this.Kt.materials;for(let i=0;i<t.length;i++)t[i].markAsDirty(Vs.PrePassDirtyFlag)}dispose(){for(let t=this.renderTargets.length-1;t>=0;t--)this.renderTargets[t].dispose();for(let t=0;t<this.cmt.length;t++)this.cmt[t].dispose&&this.cmt[t].dispose()}}nR.qM=t=>{throw X("PrePassRendererSceneComponent")},nR.Smt=[{type:0,format:2,name:"prePass_Irradiance"},{type:1,format:2,name:"prePass_Position"},{type:2,format:0,name:"prePass_Velocity"},{type:3,format:0,name:"prePass_Reflectivity"},{type:4,format:2,name:"prePass_Color"},{type:5,format:2,name:"prePass_Depth"},{type:6,format:2,name:"prePass_Normal"},{type:7,format:0,name:"prePass_Albedo"}],Object.defineProperty(ke.prototype,"prePassRenderer",{get:function(){return this.Gut},set:function(t){t&&t.isSupported&&(this.Gut=t)},enumerable:!0,configurable:!0}),ke.prototype.enablePrePassRenderer=function(){return this.Gut||(this.Gut=new nR(this),this.Gut.isSupported||(this.Gut=null,F.Error("PrePassRenderer needs WebGL 2 support.\nMaybe you tried to use the following features that need the PrePassRenderer :\n + Subsurface Scattering"))),this.Gut},ke.prototype.disablePrePassRenderer=function(){this.Gut&&(this.Gut.dispose(),this.Gut=null)};class rR{constructor(t){this.name=fe.NAME_PREPASSRENDERER,this.scene=t}register(){this.scene.Kv.registerStep(fe.STEP_BEFORECAMERADRAW_PREPASS,this,this.Dmt),this.scene.Jv.registerStep(fe.STEP_AFTERCAMERADRAW_PREPASS,this,this.Lmt),this.scene.qv.registerStep(fe.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this.Omt),this.scene.ig.registerStep(fe.STEP_AFTERCAMERADRAW_PREPASS,this,this.Fmt),this.scene.kv.registerStep(fe.STEP_BEFORECLEAR_PREPASS,this,this.kv),this.scene.Gv.registerStep(fe.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this.Gv),this.scene.Qv.registerStep(fe.STEP_BEFORERENDERINGMESH_PREPASS,this,this.Qv),this.scene.Zv.registerStep(fe.STEP_AFTERRENDERINGMESH_PREPASS,this,this.Zv)}Omt(t,i,e){this.scene.prePassRenderer&&(this.scene.prePassRenderer.fmt(t.vO),this.scene.prePassRenderer.Amt(void 0,i,e))}Fmt(t,i,e){this.scene.prePassRenderer&&this.scene.prePassRenderer.Tmt(i,e)}Gv(t){this.scene.prePassRenderer&&(t.vO||(t.vO=this.scene.prePassRenderer.Bst(t.name+"_prePassRTT",t)),this.scene.prePassRenderer.fmt(t.vO),this.scene.prePassRenderer.vS())}Dmt(t){this.scene.prePassRenderer&&(this.scene.prePassRenderer.fmt(null),this.scene.prePassRenderer.Amt(t))}Lmt(){this.scene.prePassRenderer&&this.scene.prePassRenderer.Tmt()}kv(){this.scene.prePassRenderer&&(this.scene.prePassRenderer.fmt(null),this.scene.prePassRenderer.vS())}Qv(t,i,e,s){if(!s)return;const n=t.getScene();n.prePassRenderer&&n.prePassRenderer.bindAttachmentsForEffect(s,i)}Zv(t){const i=t.getScene();i.prePassRenderer&&i.prePassRenderer.restoreAttachments()}rebuild(){this.scene.disablePrePassRenderer(),this.scene.enablePrePassRenderer()}dispose(){this.scene.disablePrePassRenderer()}}nR.qM=t=>{let i=t.Mg(fe.NAME_PREPASSRENDERER);i||(i=new rR(t),t.Ig(i))};const hR="fibonacci",oR="#define rcp(x) 1./x\n#define GOLDEN_RATIO 1.618033988749895\n#define TWO_PI 6.2831855\nvec2 Golden2dSeq(int i,float n)\n{\nreturn vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));\n}\nvec2 SampleDiskGolden(int i,int sampleCount)\n{\nvec2 f=Golden2dSeq(i,float(sampleCount));\nreturn vec2(sqrt(f.x),TWO_PI*f.y);\n}";ii.IncludesShadersStore[hR]=oR;const aR="diffusionProfile",lR="uniform vec3 diffusionS[5];\nuniform float diffusionD[5];\nuniform float filterRadii[5];";ii.IncludesShadersStore[aR]=lR;const cR="subSurfaceScatteringPixelShader",uR="#include<fibonacci>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<diffusionProfile>\nvarying vec2 vUV;\nuniform vec2 texelSize;\nuniform sampler2D textureSampler;\nuniform sampler2D irradianceSampler;\nuniform sampler2D depthSampler;\nuniform sampler2D albedoSampler;\nuniform vec2 viewportSize;\nuniform float metersPerUnit;\nconst float LOG2_E=1.4426950408889634;\nconst float SSS_PIXELS_PER_SAMPLE=4.;\nconst int _SssSampleBudget=40;\n#define rcp(x) 1./x\n#define Sq(x) x*x\n#define SSS_BILATERAL_FILTER true\nvec3 EvalBurleyDiffusionProfile(float r,vec3 S)\n{\nvec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); \nvec3 expSum=exp_13*(1.+exp_13*exp_13); \nreturn (S*rcp(8.*PI))*expSum; \n}\nvec2 SampleBurleyDiffusionProfile(float u,float rcpS)\n{\nu=1.-u; \nfloat g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));\nfloat n=exp2(log2(g)*(-1.0/3.0)); \nfloat p=(g*n)*n; \nfloat c=1.+p+n; \nfloat d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); \nfloat x=(3./LOG2_E)*log2(c)-d; \nfloat rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));\nfloat r=x*rcpS;\nfloat rcpPdf=(8.*PI*rcpS)*rcpExp; \nreturn vec2(r,rcpPdf);\n}\nvec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)\n{\n#ifndef SSS_BILATERAL_FILTER\nz=0.;\n#endif\nfloat r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));\nfloat area=rcpPdf;\n#if SSS_CLAMP_ARTIFACT\nreturn clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);\n#else\nreturn EvalBurleyDiffusionProfile(r,S)*area;\n#endif\n}\nvoid EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,\nfloat phase,inout vec3 totalIrradiance,inout vec3 totalWeight)\n{\nfloat scale =rcp(float(n));\nfloat offset=rcp(float(n))*0.5;\nfloat sinPhase,cosPhase;\nsinPhase=sin(phase);\ncosPhase=cos(phase);\nvec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);\nfloat r=bdp.x;\nfloat rcpPdf=bdp.y;\nfloat phi=SampleDiskGolden(i,n).y;\nfloat sinPhi,cosPhi;\nsinPhi=sin(phi);\ncosPhi=cos(phi);\nfloat sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; \nfloat cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; \nvec2 vec=r*vec2(cosPsi,sinPsi);\nvec2 position; \nfloat xy2;\nposition=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;\nxy2 =r*r;\nvec4 textureSample=texture2D(irradianceSampler,position);\nfloat viewZ=texture2D(depthSampler,position).r;\nvec3 irradiance =textureSample.rgb;\nif (testLightingForSSS(textureSample.a))\n{\nfloat relZ=viewZ-centerPosVS.z;\nvec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);\ntotalIrradiance+=weight*irradiance;\ntotalWeight +=weight;\n}\nelse\n{\n}\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nvec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);\nvec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;\nint diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));\nfloat centerDepth =0.;\nvec4 inputColor=texture2D(textureSampler,vUV);\nbool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);\nif (passedStencilTest)\n{\ncenterDepth=texture2D(depthSampler,vUV).r;\n}\nif (!passedStencilTest) { \ngl_FragColor=inputColor;\nreturn;\n}\nfloat distScale =1.;\nvec3 S =diffusionS[diffusionProfileIndex];\nfloat d =diffusionD[diffusionProfileIndex];\nfloat filterRadius=filterRadii[diffusionProfileIndex];\nvec2 centerPosNDC=vUV;\nvec2 cornerPosNDC=vUV+0.5*texelSize;\nvec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; \nvec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; \nfloat mmPerUnit =1000.*(metersPerUnit*rcp(distScale));\nfloat unitsPerMm=rcp(mmPerUnit);\nfloat unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);\nfloat pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;\nfloat filterArea =PI*Sq(filterRadius*pixelsPerMm);\nint sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));\nint sampleBudget=_SssSampleBudget;\nint texturingMode=0;\nvec3 albedo =texture2D(albedoSampler,vUV).rgb;\nif (distScale==0. || sampleCount<1)\n{\n#ifdef DEBUG_SSS_SAMPLES\nvec3 green=vec3(0.,1.,0.);\ngl_FragColor=vec4(green,1.0);\nreturn;\n#endif\ngl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);\nreturn;\n}\n#ifdef DEBUG_SSS_SAMPLES\nvec3 red =vec3(1.,0.,0.);\nvec3 blue=vec3(0.,0.,1.);\ngl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);\nreturn;\n#endif\nfloat phase=0.;\nint n=min(sampleCount,sampleBudget);\nvec3 centerWeight =vec3(0.); \nvec3 totalIrradiance=vec3(0.);\nvec3 totalWeight =vec3(0.);\nfor (int i=0; i<n; i++)\n{\nEvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,\nphase,totalIrradiance,totalWeight);\n}\ntotalWeight=max(totalWeight,HALF_MIN);\ngl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);\n}";ii.ShadersStore[cR]=uR;class fR extends nr{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(t,i,e,s=null,n,r,h,o=0){super(t,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],e,s,n||an.BILINEAR_SAMPLINGMODE,r,h,null,o,"postprocess",void 0,!0),this.Kt=i,this.updateEffect(),this.onApplyObservable.add((t=>{if(!i.prePassRenderer||!i.subSurfaceConfiguration)return void F.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");const e=this.texelSize;t.setFloat("metersPerUnit",i.subSurfaceConfiguration.metersPerUnit),t.setFloat2("texelSize",e.x,e.y),t.setTexture("irradianceSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(0)]),t.setTexture("depthSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(5)]),t.setTexture("albedoSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(7)]),t.setFloat2("viewportSize",Math.tan(i.activeCamera.fov/2)*i.getEngine().getAspectRatio(i.activeCamera,!0),Math.tan(i.activeCamera.fov/2)),t.setArray3("diffusionS",i.subSurfaceConfiguration.ssDiffusionS),t.setArray("diffusionD",i.subSurfaceConfiguration.ssDiffusionD),t.setArray("filterRadii",i.subSurfaceConfiguration.ssFilterRadii)}))}}class dR{constructor(t){this.Bmt=[],this.Umt=[],this.Vmt=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=fe.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new _(1,1,1)),this.Kt=t,dR.qM(this.Kt)}get ssDiffusionS(){return this.Bmt}get ssDiffusionD(){return this.Vmt}get ssFilterRadii(){return this.Umt}addDiffusionProfile(t){if(this.ssDiffusionD.length>=5)return F.Error("You already reached the maximum number of diffusion profiles."),0;for(let i=0;i<this.Bmt.length/3;i++)if(this.Bmt[3*i]===t.r&&this.Bmt[3*i+1]===t.g&&this.Bmt[3*i+2]===t.b)return i;return this.Bmt.push(t.r,t.b,t.g),this.Vmt.push(Math.max(Math.max(t.r,t.b),t.g)),this.Umt.push(this.getDiffusionProfileParameters(t)),this.ssDiffusionProfileColors.push(t),this.Vmt.length-1}createPostProcess(){return this.postProcess=new fR("subSurfaceScattering",this.Kt,1,null,void 0,this.Kt.getEngine()),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this.Vmt=[],this.Bmt=[],this.Umt=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(t){const i=Math.max(t.r,t.g,t.b);return this.kmt(.997,i)}kmt(t,i){const e=1+4*(t=1-t)*(2*t+Math.sqrt(1+4*t*t)),s=Math.pow(e,-1/3),n=1+e*s*s+s;return 3*Math.log(n/(4*t))*i}}dR.qM=t=>{throw X("SubSurfaceSceneComponent")},e.AddParser(fe.NAME_SUBSURFACE,((t,i)=>{if(void 0!==t.ssDiffusionProfileColors&&null!==t.ssDiffusionProfileColors&&(i.enableSubSurfaceForPrePass(),i.subSurfaceConfiguration))for(let e=0,s=t.ssDiffusionProfileColors.length;e<s;e++){const s=t.ssDiffusionProfileColors[e];i.subSurfaceConfiguration.addDiffusionProfile(new _(s.r,s.g,s.b))}})),Object.defineProperty(ke.prototype,"subSurfaceConfiguration",{get:function(){return this.Gmt},set:function(t){t&&this.enablePrePassRenderer()&&(this.Gmt=t)},enumerable:!0,configurable:!0}),ke.prototype.enableSubSurfaceForPrePass=function(){if(this.Gmt)return this.Gmt;const t=this.enablePrePassRenderer();return t?(this.Gmt=new dR(this),t.addEffectConfiguration(this.Gmt),this.Gmt):null},ke.prototype.disableSubSurfaceForPrePass=function(){this.Gmt&&(this.Gmt.dispose(),this.Gmt=null)};class pR{constructor(t){this.name=fe.NAME_PREPASSRENDERER,this.scene=t}register(){}serialize(t){if(!this.scene.subSurfaceConfiguration)return;const i=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;t.ssDiffusionProfileColors=[];for(let e=0;e<i.length;e++)t.ssDiffusionProfileColors.push({r:i[e].r,g:i[e].g,b:i[e].b})}addFromContainer(){}removeFromContainer(){this.scene.prePassRenderer&&this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}}dR.qM=t=>{let i=t.Mg(fe.NAME_SUBSURFACE);i||(i=new pR(t),t.Ig(i))};const mR="outlinePixelShader",vR="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#include<logDepthFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";ii.ShadersStore[mR]=vR;const gR="outlineVertexShader",SR="attribute vec3 position;\nattribute vec3 normal;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\nuniform float offset;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\nvec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\nvec3 offsetPosition=positionUpdated+(normalUpdated*offset);\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(offsetPosition,1.0);\ngl_Position=viewProjection*worldPos;\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}\n";ii.ShadersStore[gR]=SR;ke.prototype.getOutlineRenderer=function(){return this.zmt||(this.zmt=new ER(this)),this.zmt},Object.defineProperty(Ys.prototype,"renderOutline",{get:function(){return this.Hmt},set:function(t){t&&this.getScene().getOutlineRenderer(),this.Hmt=t},enumerable:!0,configurable:!0}),Object.defineProperty(Ys.prototype,"renderOverlay",{get:function(){return this.Xmt},set:function(t){t&&this.getScene().getOutlineRenderer(),this.Xmt=t},enumerable:!0,configurable:!0});class ER{constructor(t){this.name=fe.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this.scene=t,this.Ls=t.getEngine(),this.scene.Ig(this),this.Wmt=[];for(let t=0;t<4;++t)this.Wmt[t]=this.Ls.createRenderPassId(`Outline Renderer (${t})`)}register(){this.scene.Qv.registerStep(fe.STEP_BEFORERENDERINGMESH_OUTLINE,this,this.$mt),this.scene.Zv.registerStep(fe.STEP_AFTERRENDERINGMESH_OUTLINE,this,this.Ymt)}rebuild(){}dispose(){for(let t=0;t<this.Wmt.length;++t)this.Ls.releaseRenderPassId(this.Wmt[t])}render(t,i,e=!1,s){s=null!=s?s:this.Wmt[0];const n=this.scene,r=n.getEngine(),h=r.getCaps().instancedArrays&&(null!==i.visibleInstances[t.Al]&&void 0!==i.visibleInstances[t.Al]||t.getRenderingMesh().hasThinInstances);if(!this.isReady(t,h,s))return;const o=t.getMesh(),a=o._m.hS?o:null,l=t.getRenderingMesh(),c=a||l,u=t.getMaterial();if(!u||!n.activeCamera)return;const f=t.mC(s),d=vi.GetEffect(f);if(r.enableEffect(f),u.useLogarithmicDepth&&d.setFloat("logarithmicDepthConstant",2/(Math.log(n.activeCamera.maxZ+1)/Math.LN2)),d.setFloat("offset",e?0:l.outlineWidth),d.setColor4("color",e?l.overlayColor:l.outlineColor,e?l.overlayAlpha:u.alpha),d.setMatrix("viewProjection",n.getTransformMatrix()),d.setMatrix("world",c.getWorldMatrix()),l.useBones&&l.computeBonesUsingShaders&&l.skeleton&&d.setMatrices("mBones",l.skeleton.getTransformMatrices(l)),l.morphTargetManager&&l.morphTargetManager.isUsingTextureForTargets&&l.morphTargetManager.$C(d),Fs.BindMorphTargetParameters(l,d),h||l.$C(t,d,u.fillMode),u&&u.needAlphaTesting()){const t=u.getAlphaTestTexture();t&&(d.setTexture("diffuseSampler",t),d.setMatrix("diffuseMatrix",t.getTextureMatrix()))}Ds(d,u,n),r.setZOffset(-this.zOffset),r.setZOffsetUnits(-this.zOffsetUnits),l.eM(c,t,d,u.fillMode,i,h,((t,i)=>{d.setMatrix("world",i)})),r.setZOffset(0),r.setZOffsetUnits(0)}isReady(t,i,e){e=null!=e?e:this.Wmt[0];const s=[],n=[he.PositionKind,he.NormalKind],r=t.getMesh(),h=t.getMaterial();if(!h)return!1;const o=r.getScene();h.needAlphaTesting()&&(s.push("#define ALPHATEST"),r.isVerticesDataPresent(he.UVKind)&&(n.push(he.UVKind),s.push("#define UV1")),r.isVerticesDataPresent(he.UV2Kind)&&(n.push(he.UV2Kind),s.push("#define UV2"))),h.useLogarithmicDepth&&s.push("#define LOGARITHMICDEPTH"),Ps(h,o,s),r.useBones&&r.computeBonesUsingShaders?(n.push(he.MatricesIndicesKind),n.push(he.MatricesWeightsKind),r.numBoneInfluencers>4&&(n.push(he.MatricesIndicesExtraKind),n.push(he.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),s.push("#define BonesPerMesh "+(r.skeleton?r.skeleton.bones.length+1:0))):s.push("#define NUM_BONE_INFLUENCERS 0");const a=r.morphTargetManager;let l=0;a&&a.numInfluencers>0&&(l=a.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+l),a.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),Fs.PrepareAttributesForMorphTargetsInfluencers(n,r,l)),i&&(s.push("#define INSTANCES"),Fs.PushAttributesForInstances(n),t.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES"));const c=t.mC(e,!0),u=c.defines,f=s.join("\n");if(u!==f){const t=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];Ns(t),c.setEffect(this.scene.getEngine().createEffect("outline",n,t,["diffuseSampler","morphTargets"],f,void 0,void 0,void 0,{maxSimultaneousMorphTargets:l}),f)}return c.effect.isReady()}$mt(t,i,e){if(this.jmt=this.Ls.getDepthWrite(),t.renderOutline){const s=i.getMaterial();s&&s.needAlphaBlendingForMesh(t)&&(this.Ls.cacheStencilState(),this.Ls.setDepthWrite(!1),this.Ls.setColorWrite(!1),this.Ls.setStencilBuffer(!0),this.Ls.setStencilOperationPass(7681),this.Ls.setStencilFunction(519),this.Ls.setStencilMask(ER.Kmt),this.Ls.setStencilFunctionReference(ER.Kmt),this.Ls.stencilStateComposer.useStencilGlobalOnly=!0,this.render(i,e,!0,this.Wmt[1]),this.Ls.setColorWrite(!0),this.Ls.setStencilFunction(517)),this.Ls.setDepthWrite(!1),this.render(i,e,!1,this.Wmt[0]),this.Ls.setDepthWrite(this.jmt),s&&s.needAlphaBlendingForMesh(t)&&(this.Ls.stencilStateComposer.useStencilGlobalOnly=!1,this.Ls.restoreStencilState())}}Ymt(t,i,e){if(t.renderOverlay){const t=this.Ls.getAlphaMode(),s=this.Ls.alphaState.alphaBlend;this.Ls.setAlphaMode(2),this.render(i,e,!0,this.Wmt[3]),this.Ls.setAlphaMode(t),this.Ls.setDepthWrite(this.jmt),this.Ls.alphaState.alphaBlend=s}t.renderOutline&&this.jmt&&(this.Ls.setDepthWrite(!0),this.Ls.setColorWrite(!1),this.render(i,e,!1,this.Wmt[2]),this.Ls.setColorWrite(!0))}}ER.Kmt=4;class AR{constructor(t){this.priority=0,this.qmt=.1,this.onParticleSizeChanged=new h,this.particleThicknessAlpha=.05,this.Qmt=!1,this.Kt=t,this.Ls=t.getEngine(),this.Zmt=!0,this.Jmt=null,this.tvt=null}get particleSize(){return this.qmt}set particleSize(t){t!==this.qmt&&(this.qmt=t,this.onParticleSizeChanged.notifyObservers(this))}get useInstancing(){return!this.indexBuffer}get useVelocity(){return this.Qmt}set useVelocity(t){this.Qmt!==t&&this.ivt()&&(this.Qmt=t,this.Zmt=!0)}ivt(){var t;return!!(null===(t=this.vertexBuffers)||void 0===t?void 0:t.velocity)}get indexBuffer(){return null}getClassName(){return"FluidRenderingObject"}Ept(){const t=["view","projection","particleRadius","size"],i=["position","offset"],e=[];this.Zmt=!1,this.useVelocity&&(i.push("velocity"),e.push("#define FLUIDRENDERING_VELOCITY")),this.Jmt=new xr({engine:this.Ls,useShaderStore:!0,vertexShader:"fluidRenderingParticleDepth",fragmentShader:"fluidRenderingParticleDepth",attributeNames:i,uniformNames:t,samplerNames:[],defines:e}),t.push("particleAlpha"),this.tvt=new xr({engine:this.Ls,useShaderStore:!0,vertexShader:"fluidRenderingParticleThickness",fragmentShader:"fluidRenderingParticleThickness",attributeNames:["position","offset"],uniformNames:t,samplerNames:[]})}isReady(){if(this.Zmt&&this.Ept(),!this.Jmt||!this.tvt)return!1;const t=this.Jmt.SC.effect,i=this.tvt.SC.effect;return t.isReady()&&i.isReady()}renderDepthTexture(){const t=this.numParticles;if(!this.Jmt||0===t)return;const i=this.Jmt.SC,e=i.effect;this.Ls.enableEffect(i),this.Ls.bindBuffers(this.vertexBuffers,this.indexBuffer,e),e.setMatrix("view",this.Kt.getViewMatrix()),e.setMatrix("projection",this.Kt.getProjectionMatrix()),e.setFloat2("size",this.qmt,this.qmt),e.setFloat("particleRadius",this.qmt/2),this.useInstancing?this.Ls.drawArraysType(7,0,4,t):this.Ls.drawElementsType(0,0,t)}renderThicknessTexture(){const t=this.numParticles;if(!this.tvt||0===t)return;const i=this.tvt.SC,e=i.effect;this.Ls.setAlphaMode(6),this.Ls.setDepthWrite(!1),this.Ls.enableEffect(i),this.Ls.bindBuffers(this.vertexBuffers,this.indexBuffer,e),e.setMatrix("view",this.Kt.getViewMatrix()),e.setMatrix("projection",this.Kt.getProjectionMatrix()),e.setFloat("particleAlpha",this.particleThicknessAlpha),e.setFloat2("size",this.qmt,this.qmt),this.useInstancing?this.Ls.drawArraysType(7,0,4,t):this.Ls.drawElementsType(0,0,t),this.Ls.setDepthWrite(!0),this.Ls.setAlphaMode(0)}renderDiffuseTexture(){}dispose(){var t,i;null===(t=this.Jmt)||void 0===t||t.dispose(),null===(i=this.tvt)||void 0===i||i.dispose()}}class CR extends AR{constructor(t,i){super(t),this.evt=!0,this.svt=i,this.nvt=i.render.bind(i),this.rvt=i.blendMode,this.hvt=null,this.ovt=this.svt.updateInAnimate,this.svt.updateInAnimate=!0,this.svt.render=()=>0,this.particleSize=(i.minSize+i.maxSize)/2,this.useTrueRenderingForDiffuseTexture=!1}get particleSystem(){return this.svt}getClassName(){return"FluidRenderingObjectParticleSystem"}get useTrueRenderingForDiffuseTexture(){return this.evt}set useTrueRenderingForDiffuseTexture(t){this.evt!==t&&(this.evt=t,t?(this.svt.blendMode=this.rvt,this.svt.onBeforeDrawParticlesObservable.remove(this.hvt),this.hvt=null):(this.svt.blendMode=-1,this.hvt=this.svt.onBeforeDrawParticlesObservable.add((()=>{this.Ls.setAlphaMode(2)}))))}get vertexBuffers(){return this.svt.vertexBuffers}get indexBuffer(){return this.svt.indexBuffer}isReady(){return super.isReady()&&this.svt.isReady()}get numParticles(){return this.svt.getActiveCount()}renderDiffuseTexture(){this.nvt()}dispose(){super.dispose(),this.svt.onBeforeDrawParticlesObservable.remove(this.hvt),this.hvt=null,this.svt.render=this.nvt,this.svt.blendMode=this.rvt,this.svt.updateInAnimate=this.ovt}}class wR{constructor(t,i,e,s,n,r,o=1,a=6,l=1,c=6,u=!1,f=null,d=!0,p=1){this.enableBlur=!0,this.blurSizeDivisor=1,this.blurFilterSize=7,this.avt=3,this.blurMaxFilterSize=100,this.blurDepthScale=10,this.particleSize=.02,this.onDisposeObservable=new h,this.hn=t,this.Kt=i,this.JD=f,this.Ls=i.getEngine(),this.w$=e,this.wL=s,this.lvt=n,this.cvt=r,this.tL=o,this.iL=a,this.uvt=l,this.fvt=c,this.dvt=u,this.BD=d,this.dw=p,this.pvt=0,this.enableBlur=0!==n&&0!==r,this.mvt=null,this.Lb=null,this.vvt=null,this.gvt=null,this.wet=null}get blurNumIterations(){return this.avt}set blurNumIterations(t){if(this.avt!==t&&(this.avt=t,null!==this.wet)){const t=this.wet[0],i=this.wet[1];this.wet=[];for(let e=0;e<2*this.avt;++e)this.wet[e]=1&e?i:t}}get renderTarget(){return this.mvt}get renderTargetBlur(){return this.vvt}get texture(){return this.Lb}get textureBlur(){return this.gvt}initialize(){if(this.dispose(),this.Bst(),this.enableBlur&&this.Lb){const[t,i,e]=this.Pdt(this.Lb,this.uvt,this.fvt,this.blurSizeDivisor,this.hn,this.dvt);this.vvt=t,this.gvt=i,this.wet=e}}applyBlurPostProcesses(){this.enableBlur&&this.wet&&(this.pvt=0,this.Kt.postProcessManager.directRender(this.wet,this.vvt,!0),this.Ls.unBindFramebuffer(this.vvt))}Bst(){this.mvt=this.Ls.createRenderTargetTexture({width:this.w$,height:this.wL},{generateMipMaps:!1,type:this.tL,format:this.iL,samplingMode:1,generateDepthBuffer:this.BD,generateStencilBuffer:!1,samples:this.dw});const t=this.mvt.texture;t.incrementReferences(),this.Lb=new an(null,this.Kt),this.Lb.name="rtt"+this.hn,this.Lb.Lb=t,this.Lb.wrapU=an.CLAMP_ADDRESSMODE,this.Lb.wrapV=an.CLAMP_ADDRESSMODE,this.Lb.anisotropicFilteringLevel=1}Pdt(t,i,e,s,n,r=!1){const h=this.Kt.getEngine(),o=new C(Math.floor(this.lvt/s),Math.floor(this.cvt/s)),a=1===i&&h.getCaps().textureFloatLinearFiltering||2===i&&h.getCaps().textureHalfFloatLinearFiltering,l=this.Ls.createRenderTargetTexture({width:o.x,height:o.y},{generateMipMaps:!1,type:i,format:e,samplingMode:a?2:1,generateDepthBuffer:!1,generateStencilBuffer:!1,samples:this.dw}),c=l.texture;c.incrementReferences();const u=new an(null,this.Kt);if(u.name="rttBlurred"+n,u.Lb=c,u.wrapU=an.CLAMP_ADDRESSMODE,u.wrapV=an.CLAMP_ADDRESSMODE,u.anisotropicFilteringLevel=1,r){const s=new nr("BilateralBlurX","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,h,!0,null,i,void 0,void 0,void 0,e);s.samples=this.dw,s.externalTextureSamplerBinding=!0,s.onApplyObservable.add((i=>{0===this.pvt?i.setTexture("textureSampler",t):i.fn("textureSampler",s.inputTexture.texture),i.setInt("filterSize",this.blurFilterSize),i.setFloat2("blurDir",1/this.lvt,0),this.pvt++})),s.onSizeChangedObservable.add((()=>{s.sx.forEach((t=>{t.texture.wrapU=an.CLAMP_ADDRESSMODE,t.texture.wrapV=an.CLAMP_ADDRESSMODE}))})),this.Svt(s);const n=new nr("BilateralBlurY","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,h,!0,null,i,void 0,void 0,void 0,e);n.samples=this.dw,n.onApplyObservable.add((t=>{t.setInt("filterSize",this.blurFilterSize),t.setFloat2("blurDir",0,1/this.cvt),this.pvt++})),n.onSizeChangedObservable.add((()=>{n.sx.forEach((t=>{t.texture.wrapU=an.CLAMP_ADDRESSMODE,t.texture.wrapV=an.CLAMP_ADDRESSMODE}))})),this.Svt(n),s.autoClear=!1,n.autoClear=!1;const r=[];for(let t=0;t<2*this.avt;++t)r[t]=1&t?n:s;return[l,u,r]}{const s=["maxFilterSize","blurDir","projectedParticleConstant","depthThreshold"],n=new nr("BilateralBlurX","fluidRenderingBilateralBlur",s,null,1,null,1,h,!0,null,i,void 0,void 0,void 0,e);n.samples=this.dw,n.externalTextureSamplerBinding=!0,n.onApplyObservable.add((i=>{0===this.pvt?i.setTexture("textureSampler",t):i.fn("textureSampler",n.inputTexture.texture),i.setInt("maxFilterSize",this.blurMaxFilterSize),i.setFloat2("blurDir",1/this.lvt,0),i.setFloat("projectedParticleConstant",this.Evt()),i.setFloat("depthThreshold",this.Avt()),this.pvt++})),n.onSizeChangedObservable.add((()=>{n.sx.forEach((t=>{t.texture.wrapU=an.CLAMP_ADDRESSMODE,t.texture.wrapV=an.CLAMP_ADDRESSMODE}))})),this.Svt(n);const r=new nr("BilateralBlurY","fluidRenderingBilateralBlur",s,null,1,null,1,h,!0,null,i,void 0,void 0,void 0,e);r.samples=this.dw,r.onApplyObservable.add((t=>{t.setInt("maxFilterSize",this.blurMaxFilterSize),t.setFloat2("blurDir",0,1/this.cvt),t.setFloat("projectedParticleConstant",this.Evt()),t.setFloat("depthThreshold",this.Avt()),this.pvt++})),r.onSizeChangedObservable.add((()=>{r.sx.forEach((t=>{t.texture.wrapU=an.CLAMP_ADDRESSMODE,t.texture.wrapV=an.CLAMP_ADDRESSMODE}))})),this.Svt(r),n.autoClear=!1,r.autoClear=!1;const o=[];for(let t=0;t<2*this.avt;++t)o[t]=1&t?r:n;return[l,u,o]}}Svt(t){t.isReusable()&&(t.onActivateObservable.add((()=>{t.nx=(t.nx+1)%2})),t.onApplyObservable.add((()=>{t.nx=(t.nx+1)%2})))}Evt(){var t,i;return this.blurFilterSize*this.particleSize*.05*(this.wL/2)/Math.tan((null!==(i=null===(t=this.JD)||void 0===t?void 0:t.fov)&&void 0!==i?i:45*Math.PI/180)/2)}Avt(){return this.particleSize/2*this.blurDepthScale}dispose(){var t,i,e,s;this.onDisposeObservable.hasObservers()&&this.onDisposeObservable.notifyObservers(this),null===(t=this.mvt)||void 0===t||t.dispose(),this.mvt=null,null===(i=this.Lb)||void 0===i||i.dispose(),this.Lb=null,null===(e=this.vvt)||void 0===e||e.dispose(),this.vvt=null,null===(s=this.gvt)||void 0===s||s.dispose(),this.gvt=null,this.wet&&(this.wet[0].dispose(),this.wet[1].dispose()),this.wet=null}}var xR;!function(t){t[t.DepthTexture=0]="DepthTexture",t[t.DepthBlurredTexture=1]="DepthBlurredTexture",t[t.ThicknessTexture=2]="ThicknessTexture",t[t.ThicknessBlurredTexture=3]="ThicknessBlurredTexture",t[t.DiffuseTexture=4]="DiffuseTexture",t[t.Normals=5]="Normals",t[t.DiffuseRendering=6]="DiffuseRendering"}(xR||(xR={}));class TR{constructor(t,i){this.Cvt=!1,this.fluidColor=new _(.085,.6375,.765),this.density=2,this.refractionStrength=.1,this.fresnelClamp=1,this.specularPower=250,this.minimumThickness=0,this.dirLight=new w(-2,-1,1).normalize(),this.wvt=xR.DepthBlurredTexture,this.ist=!1,this.xvt=!0,this.Tvt=1,this.Rvt=7,this.Ivt=3,this.Mvt=100,this.bvt=10,this._vt=!0,this.yvt=1,this.Nvt=5,this.Pvt=1,this.Dvt=!1,this.Lvt=new h,this.Qmt=!1,this.Ovt=null,this.Fvt=null,this.Bvt=null,this.dw=1,this.Kt=t,this.Ls=t.getEngine(),this.JD=null!=i?i:t.activeCamera,this.Uvt=!0,this.Vvt=null,this.kvt=new R,this.Gvt=new y(1e6,1e6,1e6,1),this.zvt=new y(0,0,0,1),this.Hvt=null,this.Xvt=null,this.Wvt=null,this.$vt=null}get needInitialization(){return this.Uvt}get generateDiffuseTexture(){return this.Cvt}set generateDiffuseTexture(t){this.Cvt!==t&&(this.Cvt=t,this.Uvt=!0)}get debugFeature(){return this.wvt}set debugFeature(t){this.wvt!==t&&(this.Uvt=!0,this.wvt=t)}get debug(){return this.ist}set debug(t){this.ist!==t&&(this.ist=t,this.Uvt=!0)}get environmentMap(){return this.Yvt}set environmentMap(t){this.Yvt!==t&&(this.Uvt=!0,this.Yvt=t)}get enableBlurDepth(){return this.xvt}set enableBlurDepth(t){this.xvt!==t&&(this.xvt=t,this.Uvt=!0)}get blurDepthSizeDivisor(){return this.Tvt}set blurDepthSizeDivisor(t){this.Tvt!==t&&(this.Tvt=t,this.Uvt=!0)}get blurDepthFilterSize(){return this.Rvt}set blurDepthFilterSize(t){this.Rvt!==t&&(this.Rvt=t,this.jvt())}get blurDepthNumIterations(){return this.Ivt}set blurDepthNumIterations(t){this.Ivt!==t&&(this.Ivt=t,this.jvt())}get blurDepthMaxFilterSize(){return this.Mvt}set blurDepthMaxFilterSize(t){this.Mvt!==t&&(this.Mvt=t,this.jvt())}get blurDepthDepthScale(){return this.bvt}set blurDepthDepthScale(t){this.bvt!==t&&(this.bvt=t,this.jvt())}get enableBlurThickness(){return this._vt}set enableBlurThickness(t){this._vt!==t&&(this._vt=t,this.Uvt=!0)}get blurThicknessSizeDivisor(){return this.yvt}set blurThicknessSizeDivisor(t){this.yvt!==t&&(this.yvt=t,this.Uvt=!0)}get blurThicknessFilterSize(){return this.Nvt}set blurThicknessFilterSize(t){this.Nvt!==t&&(this.Nvt=t,this.jvt())}get blurThicknessNumIterations(){return this.Pvt}set blurThicknessNumIterations(t){this.Pvt!==t&&(this.Pvt=t,this.jvt())}get useFixedThickness(){return this.Dvt}set useFixedThickness(t){this.Dvt!==t&&(this.Dvt=t,this.Uvt=!0)}get useVelocity(){return this.Qmt}set useVelocity(t){this.Qmt!==t&&(this.Qmt=t,this.Uvt=!0,this.Lvt.notifyObservers(this))}get depthMapSize(){return this.Ovt}set depthMapSize(t){this.Ovt!==t&&(this.Ovt=t,this.Uvt=!0)}get thicknessMapSize(){return this.Fvt}set thicknessMapSize(t){this.Fvt!==t&&(this.Fvt=t,this.Uvt=!0)}get diffuseMapSize(){return this.Bvt}set diffuseMapSize(t){this.Bvt!==t&&(this.Bvt=t,this.Uvt=!0)}get samples(){return this.dw}set samples(t){this.dw!==t&&(this.dw=t,this.Uvt=!0)}get camera(){return this.JD}yj(){var t,i,e;this.dispose(),this.Uvt=!1;const s=null!==(t=this.Ovt)&&void 0!==t?t:this.Ls.getRenderWidth(),n=null!==this.Ovt?Math.round(this.Ovt*this.Ls.getRenderHeight()/this.Ls.getRenderWidth()):this.Ls.getRenderHeight();if(this.Hvt=new wR("Depth",this.Kt,s,n,s,n,1,7,1,7,!1,this.JD,!0,this.dw),this.Kvt(this.Hvt),this.generateDiffuseTexture){const t=null!==(i=this.Bvt)&&void 0!==i?i:this.Ls.getRenderWidth(),e=null!==this.Bvt?Math.round(this.Bvt*this.Ls.getRenderHeight()/this.Ls.getRenderWidth()):this.Ls.getRenderHeight();this.Xvt=new wR("Diffuse",this.Kt,t,e,0,0,0,5,0,5,!0,this.JD,!0,this.dw),this.Kvt(this.Xvt)}const r=null!==(e=this.Fvt)&&void 0!==e?e:this.Ls.getRenderWidth(),h=null!==this.Fvt?Math.round(this.Fvt*this.Ls.getRenderHeight()/this.Ls.getRenderWidth()):this.Ls.getRenderHeight();this.Dvt||(this.Wvt=new wR("Thickness",this.Kt,r,h,r,h,2,6,2,6,!0,this.JD,!1,this.dw),this.Kvt(this.Wvt)),this.qvt()}jvt(t=null){null!==t&&t!==this.Hvt||this.Qvt(),null!==t&&t!==this.Wvt||this.Zvt()}Qvt(){this.Hvt&&(this.Hvt.blurFilterSize=this.blurDepthFilterSize,this.Hvt.blurMaxFilterSize=this.blurDepthMaxFilterSize,this.Hvt.blurNumIterations=this.blurDepthNumIterations,this.Hvt.blurDepthScale=this.blurDepthDepthScale)}Zvt(){this.Wvt&&(this.Wvt.blurFilterSize=this.blurThicknessFilterSize,this.Wvt.blurNumIterations=this.blurThicknessNumIterations)}Kvt(t){t!==this.Xvt&&(t.enableBlur=t===this.Hvt?this.enableBlurDepth:this.enableBlurThickness,t.blurSizeDivisor=t===this.Hvt?this.blurDepthSizeDivisor:this.blurThicknessSizeDivisor),this.jvt(t),t.initialize()}qvt(){var t;const i=this.Kt.getEngine(),e=["viewMatrix","projectionMatrix","invProjectionMatrix","texelSize","dirLight","cameraFar","density","refractionStrength","fresnelClamp","specularPower"],s=["depthSampler"],n=[];if(this.dispose(!0),!this.JD)return;const r=this.Hvt.enableBlur?this.Hvt.textureBlur:this.Hvt.texture,h=new C(1/r.getSize().width,1/r.getSize().height);if(null!==this.Yvt){(null!==(t=this.Yvt)&&void 0!==t?t:this.Kt.environmentTexture)&&(s.push("reflectionSampler"),n.push("#define FLUIDRENDERING_ENVIRONMENT"))}this.Xvt?(s.push("diffuseSampler"),n.push("#define FLUIDRENDERING_DIFFUSETEXTURE")):e.push("diffuseColor"),this.Qmt&&(s.push("velocitySampler"),n.push("#define FLUIDRENDERING_VELOCITY")),this.Dvt?(e.push("thickness"),s.push("bgDepthSampler"),n.push("#define FLUIDRENDERING_FIXED_THICKNESS")):(e.push("minimumThickness"),s.push("thicknessSampler")),this.ist&&(n.push("#define FLUIDRENDERING_DEBUG"),this.wvt===xR.Normals?n.push("#define FLUIDRENDERING_DEBUG_SHOWNORMAL"):this.wvt===xR.DiffuseRendering?n.push("#define FLUIDRENDERING_DEBUG_DIFFUSERENDERING"):(n.push("#define FLUIDRENDERING_DEBUG_TEXTURE"),s.push("debugSampler"),this.wvt!==xR.DepthTexture&&this.wvt!==xR.DepthBlurredTexture||n.push("#define FLUIDRENDERING_DEBUG_DEPTH"))),this.$vt=new nr("FluidRendering","fluidRenderingRender",e,s,1,null,2,i,!1,null,0,void 0,void 0,!0,void 0),this.$vt.updateEffect(n.join("\n")),this.$vt.samples=this.dw,this.$vt.onApplyObservable.add((t=>{var e,s,n,r,o,a,l,c,u,f,d,p,m,v,g,S,E,A,C,w,x,T,R;if(this.kvt.copyFrom(this.Kt.getProjectionMatrix()),this.kvt.invert(),i.isWebGPU&&t.setTextureSampler("textureSamplerSampler",this.$vt.inputTexture.texture),this.Hvt.enableBlur?(t.setTexture("depthSampler",this.Hvt.textureBlur),i.isWebGPU&&t.setTextureSampler("depthSamplerSampler",null!==(r=null===(n=this.Hvt.textureBlur)||void 0===n?void 0:n.getInternalTexture())&&void 0!==r?r:null)):(t.setTexture("depthSampler",this.Hvt.texture),i.isWebGPU&&t.setTextureSampler("depthSamplerSampler",null!==(s=null===(e=this.Hvt.texture)||void 0===e?void 0:e.getInternalTexture())&&void 0!==s?s:null)),this.Xvt?this.Xvt.enableBlur?(t.setTexture("diffuseSampler",this.Xvt.textureBlur),i.isWebGPU&&t.setTextureSampler("diffuseSamplerSampler",null!==(c=null===(l=this.Xvt.textureBlur)||void 0===l?void 0:l.getInternalTexture())&&void 0!==c?c:null)):(t.setTexture("diffuseSampler",this.Xvt.texture),i.isWebGPU&&t.setTextureSampler("diffuseSamplerSampler",null!==(a=null===(o=this.Xvt.texture)||void 0===o?void 0:o.getInternalTexture())&&void 0!==a?a:null)):t.setColor3("diffuseColor",this.fluidColor),this.Dvt?(t.setFloat("thickness",this.minimumThickness),t.fn("bgDepthSampler",this.Vvt),i.isWebGPU&&t.setTextureSampler("bgDepthSamplerSampler",null!==(u=this.Vvt)&&void 0!==u?u:null)):(this.Wvt.enableBlur?(t.setTexture("thicknessSampler",this.Wvt.textureBlur),i.isWebGPU&&t.setTextureSampler("thicknessSamplerSampler",null!==(m=null===(p=this.Wvt.textureBlur)||void 0===p?void 0:p.getInternalTexture())&&void 0!==m?m:null)):(t.setTexture("thicknessSampler",this.Wvt.texture),i.isWebGPU&&t.setTextureSampler("thicknessSamplerSampler",null!==(d=null===(f=this.Wvt.texture)||void 0===f?void 0:f.getInternalTexture())&&void 0!==d?d:null)),t.setFloat("minimumThickness",this.minimumThickness)),null!==this.Yvt){const e=null!==(v=this.Yvt)&&void 0!==v?v:this.Kt.environmentTexture;e&&(t.setTexture("reflectionSampler",e),i.isWebGPU&&t.setTextureSampler("reflectionSamplerSampler",null!==(g=null==e?void 0:e.getInternalTexture())&&void 0!==g?g:null))}if(t.setMatrix("viewMatrix",this.Kt.getViewMatrix()),t.setMatrix("invProjectionMatrix",this.kvt),t.setMatrix("projectionMatrix",this.Kt.getProjectionMatrix()),t.setVector2("texelSize",h),t.setFloat("density",this.density),t.setFloat("refractionStrength",this.refractionStrength),t.setFloat("fresnelClamp",this.fresnelClamp),t.setFloat("specularPower",this.specularPower),t.setVector3("dirLight",this.dirLight),t.setFloat("cameraFar",this.JD.maxZ),this.ist){let e=null;switch(this.wvt){case xR.DepthTexture:e=this.Hvt.texture;break;case xR.DepthBlurredTexture:e=this.Hvt.enableBlur?this.Hvt.textureBlur:this.Hvt.texture;break;case xR.ThicknessTexture:e=null!==(E=null===(S=this.Wvt)||void 0===S?void 0:S.texture)&&void 0!==E?E:null;break;case xR.ThicknessBlurredTexture:e=(null===(A=this.Wvt)||void 0===A?void 0:A.enableBlur)?null!==(w=null===(C=this.Wvt)||void 0===C?void 0:C.textureBlur)&&void 0!==w?w:null:null!==(T=null===(x=this.Wvt)||void 0===x?void 0:x.texture)&&void 0!==T?T:null;break;case xR.DiffuseTexture:this.Xvt&&(e=this.Xvt.texture)}this.wvt!==xR.Normals&&(t.setTexture("debugSampler",e),i.isWebGPU&&t.setTextureSampler("debugSamplerSampler",null!==(R=null==e?void 0:e.getInternalTexture())&&void 0!==R?R:null))}}))}Jvt(){var t,i,e;(null===(t=this.Hvt)||void 0===t?void 0:t.renderTarget)&&(this.Ls.bindFramebuffer(this.Hvt.renderTarget),this.Ls.clear(this.Gvt,!0,!0,!1),this.Ls.unBindFramebuffer(this.Hvt.renderTarget)),(null===(i=this.Xvt)||void 0===i?void 0:i.renderTarget)&&(this.Ls.bindFramebuffer(this.Xvt.renderTarget),this.Ls.clear(this.zvt,!0,!0,!1),this.Ls.unBindFramebuffer(this.Xvt.renderTarget)),(null===(e=this.Wvt)||void 0===e?void 0:e.renderTarget)&&(this.Ls.bindFramebuffer(this.Wvt.renderTarget),this.Ls.clear(this.zvt,!0,!1,!1),this.Ls.unBindFramebuffer(this.Wvt.renderTarget))}IO(t){var i,e,s,n,r,h;if(this.Uvt||!t.isReady())return;const o=this.Ls.zo;this.Ls.setState(!1,void 0,void 0,void 0,!0),this.Ls.setDepthBuffer(!0),this.Ls.setDepthWrite(!0),this.Ls.setAlphaMode(0),(null===(i=this.Hvt)||void 0===i?void 0:i.renderTarget)&&(this.Ls.bindFramebuffer(this.Hvt.renderTarget),t.renderDepthTexture(),this.Ls.unbindInstanceAttributes(),this.Ls.unBindFramebuffer(this.Hvt.renderTarget)),(null===(e=this.Xvt)||void 0===e?void 0:e.renderTarget)&&(this.Ls.bindFramebuffer(this.Xvt.renderTarget),t.renderDiffuseTexture(),this.Ls.unbindInstanceAttributes(),this.Ls.unBindFramebuffer(this.Xvt.renderTarget)),(null===(s=this.Wvt)||void 0===s?void 0:s.renderTarget)&&(this.Ls.bindFramebuffer(this.Wvt.renderTarget),t.renderThicknessTexture(),this.Ls.unbindInstanceAttributes(),this.Ls.unBindFramebuffer(this.Wvt.renderTarget)),null===(n=this.Hvt)||void 0===n||n.applyBlurPostProcesses(),null===(r=this.Xvt)||void 0===r||r.applyBlurPostProcesses(),null===(h=this.Wvt)||void 0===h||h.applyBlurPostProcesses(),o&&this.Ls.bindFramebuffer(o)}dispose(t=!1){var i,e,s,n;t||(null===(i=this.Hvt)||void 0===i||i.dispose(),this.Hvt=null,null===(e=this.Xvt)||void 0===e||e.dispose(),this.Xvt=null,null===(s=this.Wvt)||void 0===s||s.dispose(),this.Wvt=null),this.$vt&&this.JD&&this.JD.detachPostProcess(this.$vt),null===(n=this.$vt)||void 0===n||n.dispose(),this.$vt=null,this.Uvt=!1}}class RR extends AR{constructor(t,i,e){super(t),this.tgt=e,this.igt=null,this.ff={},this.addBuffers(i)}getClassName(){return"FluidRenderingObjectCustomParticles"}get vertexBuffers(){return this.ff}addBuffers(t){for(const i in t){let e,s=!0;switch(i){case"velocity":e=3;break;case"offset":s=!1}this.ff[i]=new he(this.Ls,t[i],i,!0,!1,e,s)}}Ept(){super.Ept();this.igt=new xr({engine:this.Ls,useShaderStore:!0,vertexShader:"fluidRenderingParticleDiffuse",fragmentShader:"fluidRenderingParticleDiffuse",attributeNames:["position","offset","color"],uniformNames:["view","projection","size"],samplerNames:[]})}isReady(){var t,i;return this.ff.offset||(this.ff.offset=new he(this.Ls,[0,0,1,0,0,1,1,1],"offset",!1,!1,2)),super.isReady()&&null!==(i=null===(t=this.igt)||void 0===t?void 0:t.effect.isReady())&&void 0!==i&&i}get numParticles(){return this.tgt}setNumParticles(t){this.tgt=t}renderDiffuseTexture(){const t=this.numParticles;if(!this.igt||0===t)return;const i=this.igt.SC,e=i.effect;this.Ls.enableEffect(i),this.Ls.bindBuffers(this.vertexBuffers,this.indexBuffer,e),e.setMatrix("view",this.Kt.getViewMatrix()),e.setMatrix("projection",this.Kt.getProjectionMatrix()),null!==this.qmt&&e.setFloat2("size",this.qmt,this.qmt),this.useInstancing?this.Ls.drawArraysType(7,0,4,t):this.Ls.drawElementsType(0,0,t)}dispose(){var t;super.dispose(),null===(t=this.igt)||void 0===t||t.dispose();for(const t in this.ff)this.ff[t].dispose();this.ff={}}}const IR="copyTextureToTexturePixelShader",MR="uniform float conversion;\nuniform sampler2D textureSampler;\nvarying vec2 vUV;\n#include<helperFunctions>\nvoid main(void) \n{\nvec4 color=texture2D(textureSampler,vUV);\n#ifdef DEPTH_TEXTURE\ngl_FragDepth=color.r;\n#else\nif (conversion==1.) {\ncolor=toLinearSpace(color);\n} else if (conversion==2.) {\ncolor=toGammaSpace(color);\n}\ngl_FragColor=color;\n#endif\n}\n";ii.ShadersStore[IR]=MR;var bR;!function(t){t[t.None=0]="None",t[t.ToLinearSpace=1]="ToLinearSpace",t[t.ToGammaSpace=2]="ToGammaSpace"}(bR||(bR={}));class _R{constructor(t,i=!1){this.Ls=t,this.egt=i,this.sgt=new wr(t),this.Vst=new xr({engine:t,name:"CopyTextureToTexture",fragmentShader:"copyTextureToTexture",useShaderStore:!0,uniformNames:["conversion"],samplerNames:["textureSampler"],defines:i?["#define DEPTH_TEXTURE"]:[]}),this.Vst.onApplyObservable.add((()=>{i&&(t.setState(!1),t.setDepthBuffer(!0),t.depthCullingState.depthMask=!0,t.depthCullingState.depthFunc=519),this.ngt(this.$n)?this.Vst.effect.fn("textureSampler",this.$n):this.Vst.effect.setTexture("textureSampler",this.$n),this.Vst.effect.setFloat("conversion",this.rgt)}))}ngt(t){return void 0===t.getInternalTexture}isReady(){return this.Vst.effect.isReady()}copy(t,i,e=bR.None){if(!this.isReady())return!1;this.$n=t,this.rgt=e;const s=this.Ls.depthCullingState.depthFunc;return this.sgt.render(this.Vst,i),this.egt&&s&&(this.Ls.depthCullingState.depthFunc=s),!0}dispose(){this.Vst.dispose(),this.sgt.dispose()}}class yR{constructor(t,i,e,s=1){this.Ls=t,this.hgt=new _R(t,!0),this.ogt=this.Ls.createRenderTargetTexture({width:i,height:e},{generateMipMaps:!1,type:0,format:6,samplingMode:1,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:s,noColorAttachment:!0}),this.ogt.createDepthStencilTexture(0,!1,!1,1)}get depthRTWrapper(){return this.ogt}copy(t){return this.hgt.copy(t,this.ogt)}dispose(){this.ogt.dispose(),this.hgt.dispose()}}const NR="fluidRenderingParticleDepthVertexShader",PR="attribute vec3 position;\nattribute vec2 offset;\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec2 size;\nvarying vec2 uv;\nvarying vec3 viewPos;\nvarying float sphereRadius;\n#ifdef FLUIDRENDERING_VELOCITY\nattribute vec3 velocity;\nvarying float velocityNorm;\n#endif\nvoid main(void) {\nvec3 cornerPos;\ncornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;\ncornerPos.z=0.0;\nviewPos=(view*vec4(position,1.0)).xyz;\ngl_Position=projection*vec4(viewPos+cornerPos,1.0);\nuv=offset;\nsphereRadius=size.x/2.0;\n#ifdef FLUIDRENDERING_VELOCITY\nvelocityNorm=length(velocity);\n#endif\n}\n";ii.ShadersStore[NR]=PR;const DR="fluidRenderingParticleDepthPixelShader",LR="uniform mat4 projection;\nvarying vec2 uv;\nvarying vec3 viewPos;\nvarying float sphereRadius;\n#ifdef FLUIDRENDERING_VELOCITY\nvarying float velocityNorm;\n#endif\nvoid main(void) {\nvec3 normal;\nnormal.xy=uv*2.0-1.0;\nfloat r2=dot(normal.xy,normal.xy);\nif (r2>1.0) discard;\nnormal.z=-sqrt(1.0-r2);\nvec4 realViewPos=vec4(viewPos+normal*sphereRadius,1.0);\nvec4 clipSpacePos=projection*realViewPos;\n#ifdef WEBGPU\ngl_FragDepth=clipSpacePos.z/clipSpacePos.w;\n#else\ngl_FragDepth=(clipSpacePos.z/clipSpacePos.w)*0.5+0.5;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nglFragColor=vec4(realViewPos.z,velocityNorm,0.,1.);\n#else\nglFragColor=vec4(realViewPos.z,0.,0.,1.);\n#endif\n}\n";ii.ShadersStore[DR]=LR;const OR="fluidRenderingParticleThicknessVertexShader",FR="attribute vec3 position;\nattribute vec2 offset;\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec2 size;\nvarying vec2 uv;\nvoid main(void) {\nvec3 cornerPos;\ncornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;\ncornerPos.z=0.0;\nvec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;\ngl_Position=projection*vec4(viewPos,1.0);\nuv=offset;\n}\n";ii.ShadersStore[OR]=FR;const BR="fluidRenderingParticleThicknessPixelShader",UR="uniform float particleAlpha;\nvarying vec2 uv;\nvoid main(void) {\nvec3 normal;\nnormal.xy=uv*2.0-1.0;\nfloat r2=dot(normal.xy,normal.xy);\nif (r2>1.0) discard;\nfloat thickness=sqrt(1.0-r2);\nglFragColor=vec4(vec3(particleAlpha*thickness),1.0);\n}\n";ii.ShadersStore[BR]=UR;const VR="fluidRenderingParticleDiffuseVertexShader",kR="attribute vec3 position;\nattribute vec2 offset;\nattribute vec4 color;\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec2 size;\nvarying vec2 uv;\nvarying vec3 diffuseColor;\nvoid main(void) {\nvec3 cornerPos;\ncornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;\ncornerPos.z=0.0;\nvec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;\ngl_Position=projection*vec4(viewPos,1.0);\nuv=offset;\ndiffuseColor=color.rgb;\n}\n";ii.ShadersStore[VR]=kR;const GR="fluidRenderingParticleDiffusePixelShader",zR="uniform float particleAlpha;\nvarying vec2 uv;\nvarying vec3 diffuseColor;\nvoid main(void) {\nvec3 normal;\nnormal.xy=uv*2.0-1.0;\nfloat r2=dot(normal.xy,normal.xy);\nif (r2>1.0) discard;\nglFragColor=vec4(diffuseColor,1.0);\n}\n";ii.ShadersStore[GR]=zR;const HR="fluidRenderingBilateralBlurPixelShader",XR="uniform sampler2D textureSampler;\nuniform int maxFilterSize;\nuniform vec2 blurDir;\nuniform float projectedParticleConstant;\nuniform float depthThreshold;\nvarying vec2 vUV;\nvoid main(void) {\nfloat depth=textureLod(textureSampler,vUV,0.).x;\nif (depth>=1e6 || depth<=0.) {\nglFragColor=vec4(vec3(depth),1.);\nreturn;\n}\nint filterSize=min(maxFilterSize,int(ceil(projectedParticleConstant/depth)));\nfloat sigma=float(filterSize)/3.0;\nfloat two_sigma2=2.0*sigma*sigma;\nfloat sigmaDepth=depthThreshold/3.0;\nfloat two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;\nfloat sum=0.;\nfloat wsum=0.;\nfloat sumVel=0.;\nfor (int x=-filterSize; x<=filterSize; ++x) {\nvec2 coords=vec2(x);\nvec2 sampleDepthVel=textureLod(textureSampler,vUV+coords*blurDir,0.).rg;\nfloat r=dot(coords,coords);\nfloat w=exp(-r/two_sigma2);\nfloat rDepth=sampleDepthVel.r-depth;\nfloat wd=exp(-rDepth*rDepth/two_sigmaDepth2);\nsum+=sampleDepthVel.r*w*wd;\nsumVel+=sampleDepthVel.g*w*wd;\nwsum+=w*wd;\n}\nglFragColor=vec4(sum/wsum,sumVel/wsum,0.,1.);\n}\n";ii.ShadersStore[HR]=XR;const WR="fluidRenderingStandardBlurPixelShader",$R="uniform sampler2D textureSampler;\nuniform int filterSize;\nuniform vec2 blurDir;\nvarying vec2 vUV;\nvoid main(void) {\nvec4 s=textureLod(textureSampler,vUV,0.);\nif (s.r==0.) {\nglFragColor=vec4(0.,0.,0.,1.);\nreturn;\n}\nfloat sigma=float(filterSize)/3.0;\nfloat twoSigma2=2.0*sigma*sigma;\nvec4 sum=vec4(0.);\nfloat wsum=0.;\nfor (int x=-filterSize; x<=filterSize; ++x) {\nvec2 coords=vec2(x);\nvec4 sampl=textureLod(textureSampler,vUV+coords*blurDir,0.);\nfloat w=exp(-coords.x*coords.x/twoSigma2);\nsum+=sampl*w;\nwsum+=w;\n}\nsum/=wsum;\nglFragColor=vec4(sum.rgb,1.);\n}\n";ii.ShadersStore[WR]=$R;const YR="fluidRenderingRenderPixelShader",jR="#define IOR 1.333\n#define ETA 1.0/IOR\n#define F0 0.02\nuniform sampler2D textureSampler;\nuniform sampler2D depthSampler;\n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nuniform sampler2D diffuseSampler;\n#else\nuniform vec3 diffuseColor;\n#endif\n#ifdef FLUIDRENDERING_FIXED_THICKNESS\nuniform float thickness;\nuniform sampler2D bgDepthSampler;\n#else\nuniform float minimumThickness;\nuniform sampler2D thicknessSampler;\n#endif\n#ifdef FLUIDRENDERING_ENVIRONMENT\nuniform samplerCube reflectionSampler;\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nuniform sampler2D debugSampler;\n#endif\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 invProjectionMatrix;\nuniform vec2 texelSize;\nuniform vec3 dirLight;\nuniform float cameraFar;\nuniform float density;\nuniform float refractionStrength;\nuniform float fresnelClamp;\nuniform float specularPower;\nvarying vec2 vUV;\nvec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {\nvec4 ndc;\nndc.xy=texCoord*2.0-1.0;\nndc.z=projectionMatrix[2].z+projectionMatrix[3].z/depth;\nndc.w=1.0;\nvec4 eyePos=invProjectionMatrix*ndc;\neyePos.xyz/=eyePos.w;\nreturn eyePos.xyz;\n}\nvec3 getViewPosFromTexCoord(vec2 texCoord) {\nfloat depth=textureLod(depthSampler,texCoord,0.).x;\nreturn computeViewPosFromUVDepth(texCoord,depth);\n}\nvoid main(void) {\nvec2 texCoord=vUV;\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nvec4 color=texture2D(debugSampler,texCoord);\n#ifdef FLUIDRENDERING_DEBUG_DEPTH\nglFragColor=vec4(color.rgb/vec3(2.0),1.);\nif (color.r>0.999 && color.g>0.999) {\nglFragColor=texture2D(textureSampler,texCoord);\n}\n#else\nglFragColor=vec4(color.rgb,1.);\nif (color.r<0.001 && color.g<0.001 && color.b<0.001) {\nglFragColor=texture2D(textureSampler,texCoord);\n}\n#endif\nreturn;\n#endif\nvec2 depthVel=textureLod(depthSampler,texCoord,0.).rg;\nfloat depth=depthVel.r;\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nfloat thickness=texture2D(thicknessSampler,texCoord).x;\n#else\nfloat bgDepth=texture2D(bgDepthSampler,texCoord).x;\nfloat depthNonLinear=projectionMatrix[2].z+projectionMatrix[3].z/depth;\ndepthNonLinear=depthNonLinear*0.5+0.5;\n#endif\nvec3 backColor=texture2D(textureSampler,texCoord).rgb;\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nif (depth>=cameraFar || depth<=0. || thickness<=minimumThickness) {\n#else\nif (depth>=cameraFar || depth<=0. || bgDepth<=depthNonLinear) {\n#endif\nglFragColor=vec4(backColor,1.);\nreturn;\n}\nvec3 viewPos=computeViewPosFromUVDepth(texCoord,depth);\nvec3 ddx=getViewPosFromTexCoord(texCoord+vec2(texelSize.x,0.))-viewPos;\nvec3 ddy=getViewPosFromTexCoord(texCoord+vec2(0.,texelSize.y))-viewPos;\nvec3 ddx2=viewPos-getViewPosFromTexCoord(texCoord+vec2(-texelSize.x,0.));\nif (abs(ddx.z)>abs(ddx2.z)) {\nddx=ddx2;\n}\nvec3 ddy2=viewPos-getViewPosFromTexCoord(texCoord+vec2(0.,-texelSize.y));\nif (abs(ddy.z)>abs(ddy2.z)) {\nddy=ddy2;\n}\nvec3 normal=normalize(cross(ddy,ddx));\n#ifndef WEBGPU\nif(isnan(normal.x) || isnan(normal.y) || isnan(normal.z) || isinf(normal.x) || isinf(normal.y) || isinf(normal.z)) {\nnormal=vec3(0.,0.,-1.);\n}\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)\nglFragColor=vec4(normal*0.5+0.5,1.0);\nreturn;\n#endif\nvec3 rayDir=normalize(viewPos); \n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nvec3 diffuseColor=texture2D(diffuseSampler,texCoord).rgb;\n#endif\nvec3 lightDir=normalize(vec3(viewMatrix*vec4(-dirLight,0.)));\nvec3 H =normalize(lightDir-rayDir);\nfloat specular=pow(max(0.0,dot(H,normal)),specularPower);\n#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING\nfloat diffuse =max(0.0,dot(lightDir,normal))*1.0;\nglFragColor=vec4(vec3(0.1) /*ambient*/+vec3(0.42,0.50,1.00)*diffuse+vec3(0,0,0.2)+specular,1.);\nreturn;\n#endif\nvec3 refractionDir=refract(rayDir,normal,ETA);\nvec3 transmitted=(texture2D(textureSampler,vec2(texCoord+refractionDir.xy*thickness*refractionStrength)).rgb);\nvec3 transmittance=exp(-density*thickness*(1.0-diffuseColor)); \nvec3 refractionColor=transmitted*transmittance;\n#ifdef FLUIDRENDERING_ENVIRONMENT\nvec3 reflectionDir=reflect(rayDir,normal);\nvec3 reflectionColor=(textureCube(reflectionSampler,reflectionDir).rgb);\nfloat fresnel=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,fresnelClamp);\nvec3 finalColor=mix(refractionColor,reflectionColor,fresnel)+specular;\n#else\nvec3 finalColor=refractionColor+specular;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nfloat velocity=depthVel.g;\nfinalColor=mix(finalColor,vec3(1.0),smoothstep(0.3,1.0,velocity/6.0));\n#endif\nglFragColor=vec4(finalColor,1.);\n}\n";ii.ShadersStore[YR]=jR;function KR(t){return!!t.particleSystem}Object.defineProperty(ke.prototype,"fluidRenderer",{get:function(){return this.agt},set:function(t){this.agt=t},enumerable:!0,configurable:!0}),ke.prototype.enableFluidRenderer=function(){return this.agt||(this.agt=new QR(this)),this.agt},ke.prototype.disableFluidRenderer=function(){var t;null===(t=this.agt)||void 0===t||t.dispose(),this.agt=null};class qR{constructor(t){this.name=fe.NAME_FLUIDRENDERER,this.scene=t}register(){this.scene.Hv.registerStep(fe.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER,this,this.opt),this.scene.Jv.registerStep(fe.STEP_AFTERCAMERADRAW_FLUIDRENDERER,this,this.Lmt)}opt(t){var i;null===(i=this.scene.fluidRenderer)||void 0===i||i.lgt()}Lmt(t){var i;null===(i=this.scene.fluidRenderer)||void 0===i||i.IO(t)}rebuild(){this.scene.agt&&(this.scene.disableFluidRenderer(),this.scene.enableFluidRenderer())}dispose(){this.scene.disableFluidRenderer()}}class QR{constructor(t){this.Kt=t,this.Ls=t.getEngine(),this.cgt=null,this.renderObjects=[],this.targetRenderers=[],this.out=new Map,QR.qM(this.Kt),this.cgt=this.Ls.onResizeObservable.add((()=>{this.yj()}))}static qM(t){let i=t.Mg(fe.NAME_FLUIDRENDERER);i||(i=new qR(t),t.Ig(i))}recreate(){this.ugt(),this.yj()}getRenderObjectFromParticleSystem(t){const i=this.fgt(t);return-1!==i?this.renderObjects[i]:null}addParticleSystem(t,i,e,s){const n=new CR(this.Kt,t);n.onParticleSizeChanged.add(this.dgt.bind(this)),e||(e=new TR(this.Kt,s),this.targetRenderers.push(e)),e.Lvt.hasObservers()||e.Lvt.add(this.pgt.bind(this)),void 0!==i&&(e.generateDiffuseTexture=i);const r={object:n,targetRenderer:e};return this.renderObjects.push(r),this.ugt(),this.dgt(),r}addCustomParticles(t,i,e,s,n){const r=new RR(this.Kt,t,i);r.onParticleSizeChanged.add(this.dgt.bind(this)),s||(s=new TR(this.Kt,n),this.targetRenderers.push(s)),s.Lvt.hasObservers()||s.Lvt.add(this.pgt.bind(this)),void 0!==e&&(s.generateDiffuseTexture=e);const h={object:r,targetRenderer:s};return this.renderObjects.push(h),this.ugt(),this.dgt(),h}removeRenderObject(t,i=!0){const e=this.renderObjects.indexOf(t);return-1!==e&&(t.object.dispose(),this.renderObjects.splice(e,1),i&&this.mgt()?this.yj():this.dgt(),!0)}ugt(){this.renderObjects.sort(((t,i)=>t.object.priority<i.object.priority?-1:t.object.priority>i.object.priority?1:0))}mgt(){const t={};for(let i=0;i<this.renderObjects.length;++i){const e=this.renderObjects[i].targetRenderer;t[this.targetRenderers.indexOf(e)]=!0}let i=!1;const e=[];for(let s=0;s<this.targetRenderers.length;++s)t[s]?e.push(this.targetRenderers[s]):(this.targetRenderers[s].dispose(),i=!0);return i&&(this.targetRenderers.length=0,this.targetRenderers.push(...e)),i}fgt(t){for(let i=0;i<this.renderObjects.length;++i){const e=this.renderObjects[i].object;if(KR(e)&&e.particleSystem===t)return i}return-1}yj(){for(let t=0;t<this.targetRenderers.length;++t)this.targetRenderers[t].dispose();const t=new Map;for(let i=0;i<this.targetRenderers.length;++i){const e=this.targetRenderers[i];if(e.yj(),e.camera&&e.$vt){let s=t.get(e.camera);s||(s=[[],{}],t.set(e.camera,s)),s[0].push(e),e.camera.attachPostProcess(e.$vt,i)}}let i=t.keys();for(let e=i.next();!0!==e.done;e=i.next()){const i=e.value,s=t.get(i),n=i.bA();if(!n)continue;const[r,h]=s;n.onSizeChangedObservable.add((()=>{var t;n.inputTexture.depthStencilTexture||n.inputTexture.createDepthStencilTexture(0,!0,this.Ls.isStencilEnable,r[0].samples);for(const i of r){const e=null===(t=i.Wvt)||void 0===t?void 0:t.renderTarget,s=null==e?void 0:e.texture;if(e&&s){const t=s.width+"_"+s.height;let i=h[t];i||(i=h[t]=new yR(this.Ls,s.width,s.height)),i.depthRTWrapper.VD(e)}}}))}i=this.out.keys();for(let e=i.next();!0!==e.done;e=i.next()){const i=e.value,s=this.out.get(i)[1],n=t.get(i);if(n)for(const t in s)n[1][t]||s[t].dispose();else for(const t in s)s[t].dispose()}this.out.clear(),this.out=t,this.dgt()}dgt(){const t=new Map;for(let i=0;i<this.renderObjects.length;++i){const e=this.renderObjects[i];let s=t.get(e.targetRenderer);void 0===s&&(s=0),t.set(e.targetRenderer,Math.max(s,e.object.particleSize))}t.forEach(((t,i)=>{i.Hvt&&(i.Hvt.particleSize=t)}))}pgt(){for(const t of this.renderObjects)t.object.useVelocity=t.targetRenderer.useVelocity}lgt(){for(const t of this.targetRenderers)if(t.needInitialization)return void this.yj()}IO(t){var i;for(let i=0;i<this.targetRenderers.length;++i)t&&this.targetRenderers[i].camera!==t||this.targetRenderers[i].Jvt();const e=this.out.keys();for(let s=e.next();!0!==s.done;s=e.next()){const e=s.value,n=this.out.get(e);if(t&&e!==t)continue;const r=e.bA();if(!r)continue;const h=null===(i=r.inputTexture)||void 0===i?void 0:i.depthStencilTexture;if(h){const[t,i]=n;for(const i of t)i.Vvt=h;for(const t in i)i[t].copy(h)}}for(let i=0;i<this.renderObjects.length;++i){const e=this.renderObjects[i];t&&e.targetRenderer.camera!==t||e.targetRenderer.IO(e.object)}}dispose(){this.Ls.onResizeObservable.remove(this.cgt),this.cgt=null;for(let t=0;t<this.renderObjects.length;++t)this.renderObjects[t].object.dispose();for(let t=0;t<this.targetRenderers.length;++t)this.targetRenderers[t].dispose();this.out.forEach((t=>{const i=t[1];for(const t in i)i[t].dispose()})),this.renderObjects=[],this.targetRenderers=[],this.out.clear()}}class ZR{constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this.vgt=!1,this.QE=!1,this.ggt=0,this.Sgt=0,this.Egt=0,this.GP=1,this.Agt=0,this.Cgt=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}get animationStarted(){return this.vgt}get fromIndex(){return this.ggt}get toIndex(){return this.Sgt}get loopAnimation(){return this.QE}get delay(){return Math.max(this.Egt,1)}playAnimation(t,i,e,s,n){this.ggt=t,this.Sgt=i,this.QE=e,this.Egt=s||1,this.vgt=!0,this.Cgt=n,t<i?this.GP=1:(this.GP=-1,this.Sgt=t,this.ggt=i),this.cellIndex=t,this.Agt=0}stopAnimation(){this.vgt=!1}bS(t){this.vgt&&(this.Agt+=t,this.Agt>this.Egt&&(this.Agt=this.Agt%this.Egt,this.cellIndex+=this.GP,(this.GP>0&&this.cellIndex>this.Sgt||this.GP<0&&this.cellIndex<this.ggt)&&(this.QE?this.cellIndex=this.GP>0?this.ggt:this.Sgt:(this.cellIndex=this.Sgt,this.vgt=!1,this.Cgt&&this.Cgt()))))}}class JR extends ZR{constructor(t,i){super(),this.name=t,this.animations=new Array,this.isPickable=!1,this.useAlphaForPicking=!1,this.onDisposeObservable=new h,this.wgt=null,this.xgt=()=>{this.wgt&&this.wgt(),this.disposeWhenFinishedAnimating&&this.dispose()},this.color=new y(1,1,1,1),this.position=w.Zero(),this.Tgt=i,this.Tgt.sprites.push(this),this.uniqueId=this.Tgt.scene.getUniqueId()}get size(){return this.width}set size(t){this.width=t,this.height=t}get manager(){return this.Tgt}getClassName(){return"Sprite"}get fromIndex(){return this.ggt}set fromIndex(t){this.playAnimation(t,this.Sgt,this.QE,this.Egt,this.wgt)}get toIndex(){return this.Sgt}set toIndex(t){this.playAnimation(this.ggt,t,this.QE,this.Egt,this.wgt)}get loopAnimation(){return this.QE}set loopAnimation(t){this.playAnimation(this.ggt,this.Sgt,t,this.Egt,this.wgt)}get delay(){return Math.max(this.Egt,1)}set delay(t){this.playAnimation(this.ggt,this.Sgt,this.QE,t,this.wgt)}playAnimation(t,i,e,s,n=null){this.wgt=n,super.playAnimation(t,i,e,s,this.xgt)}dispose(){for(let t=0;t<this.Tgt.sprites.length;t++)this.Tgt.sprites[t]==this&&this.Tgt.sprites.splice(t,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}serialize(){const t={};return t.name=this.name,t.position=this.position.asArray(),t.color=this.color.asArray(),t.width=this.width,t.height=this.height,t.angle=this.angle,t.cellIndex=this.cellIndex,t.cellRef=this.cellRef,t.invertU=this.invertU,t.invertV=this.invertV,t.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,t.isPickable=this.isPickable,t.isVisible=this.isVisible,t.useAlphaForPicking=this.useAlphaForPicking,t.animationStarted=this.animationStarted,t.fromIndex=this.fromIndex,t.toIndex=this.toIndex,t.loopAnimation=this.loopAnimation,t.delay=this.delay,t}static Parse(t,i){const e=new JR(t.name,i);return e.position=w.FromArray(t.position),e.color=y.FromArray(t.color),e.width=t.width,e.height=t.height,e.angle=t.angle,e.cellIndex=t.cellIndex,e.cellRef=t.cellRef,e.invertU=t.invertU,e.invertV=t.invertV,e.disposeWhenFinishedAnimating=t.disposeWhenFinishedAnimating,e.isPickable=t.isPickable,e.isVisible=t.isVisible,e.useAlphaForPicking=t.useAlphaForPicking,e.fromIndex=t.fromIndex,e.toIndex=t.toIndex,e.loopAnimation=t.loopAnimation,e.delay=t.delay,t.animationStarted&&e.playAnimation(e.fromIndex,e.toIndex,e.loopAnimation,e.delay),e}}ke.prototype.Rgt=function(t,i,e,s){if(!oe)return null;let n=null;if(!s){if(!this.activeCamera)return null;s=this.activeCamera}if(this.spriteManagers.length>0)for(let r=0;r<this.spriteManagers.length;r++){const h=this.spriteManagers[r];if(!h.isPickable)continue;const o=h.intersects(t,s,i,e);if(o&&o.hit&&((e||null==n||!(o.distance>=n.distance))&&(n=o,e)))break}return n||new oe},ke.prototype.Igt=function(t,i,e){if(!oe)return null;let s=new Array;if(!e){if(!this.activeCamera)return null;e=this.activeCamera}if(this.spriteManagers.length>0)for(let n=0;n<this.spriteManagers.length;n++){const r=this.spriteManagers[n];if(!r.isPickable)continue;const h=r.multiIntersects(t,e,i);null!==h&&(s=s.concat(h))}return s},ke.prototype.pickSprite=function(t,i,e,s,n){if(!this.Mgt)return null;this.createPickingRayInCameraSpaceToRef(t,i,this.Mgt,n);const r=this.Rgt(this.Mgt,e,s,n);return r&&(r.ray=this.createPickingRayInCameraSpace(t,i,n)),r},ke.prototype.pickSpriteWithRay=function(t,i,e,s){if(!this.Mgt)return null;if(!s){if(!this.activeCamera)return null;s=this.activeCamera}vn.TransformToRef(t,s.getViewMatrix(),this.Mgt);const n=this.Rgt(this.Mgt,i,e,s);return n&&(n.ray=t),n},ke.prototype.multiPickSprite=function(t,i,e,s){return this.createPickingRayInCameraSpaceToRef(t,i,this.Mgt,s),this.Igt(this.Mgt,e,s)},ke.prototype.multiPickSpriteWithRay=function(t,i,e){if(!this.Mgt)return null;if(!e){if(!this.activeCamera)return null;e=this.activeCamera}return vn.TransformToRef(t,e.getViewMatrix(),this.Mgt),this.Igt(this.Mgt,i,e)},ke.prototype.setPointerOverSprite=function(t){this.bgt!==t&&(this.bgt&&this.bgt.actionManager&&this.bgt.actionManager.processTrigger(10,D.CreateNewFromSprite(this.bgt,this)),this.bgt=t,this.bgt&&this.bgt.actionManager&&this.bgt.actionManager.processTrigger(9,D.CreateNewFromSprite(this.bgt,this)))},ke.prototype.getPointerOverSprite=function(){return this.bgt};class tI{constructor(t){this.name=fe.NAME_SPRITE,this.scene=t,this.scene.spriteManagers=new Array,this.scene.Mgt=vn?vn.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new h,this.scene.onAfterSpritesRenderingObservable=new h,this._gt=t=>!!t.actionManager&&(t.isPickable&&t.actionManager.hasPointerTriggers)}register(){this.scene.tm.registerStep(fe.STEP_POINTERMOVE_SPRITE,this,this.ygt),this.scene.um.registerStep(fe.STEP_POINTERDOWN_SPRITE,this,this.Ngt),this.scene.pm.registerStep(fe.STEP_POINTERUP_SPRITE,this,this.Pgt)}rebuild(){}dispose(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();const t=this.scene.spriteManagers;for(;t.length;)t[0].dispose()}Dgt(t,i,e,s,n){const r=this.scene.pickSprite(i,e,this._gt,s,n);return r&&(r.ray=t?t.ray:null),r}ygt(t,i,e,s,n){const r=this.scene;return s?r.setPointerOverSprite(null):(e=this.Dgt(e,t,i,!1,r.cameraToUseForPointers||void 0))&&e.hit&&e.pickedSprite?(r.setPointerOverSprite(e.pickedSprite),!r.doNotHandleCursors&&n&&(r.bgt&&r.bgt.actionManager&&r.bgt.actionManager.hoverCursor?n.style.cursor=r.bgt.actionManager.hoverCursor:n.style.cursor=r.hoverCursor)):r.setPointerOverSprite(null),e}Ngt(t,i,e,s){const n=this.scene;if(n.Lgt=null,n.spriteManagers.length>0&&(e=n.pickSprite(t,i,this._gt,!1,n.cameraToUseForPointers||void 0))&&e.hit&&e.pickedSprite&&e.pickedSprite.actionManager){switch(n.Lgt=e.pickedSprite,s.button){case 0:e.pickedSprite.actionManager.processTrigger(2,D.CreateNewFromSprite(e.pickedSprite,n,s));break;case 1:e.pickedSprite.actionManager.processTrigger(4,D.CreateNewFromSprite(e.pickedSprite,n,s));break;case 2:e.pickedSprite.actionManager.processTrigger(3,D.CreateNewFromSprite(e.pickedSprite,n,s))}e.pickedSprite.actionManager&&e.pickedSprite.actionManager.processTrigger(5,D.CreateNewFromSprite(e.pickedSprite,n,s))}return e}Pgt(t,i,e,s,n){const r=this.scene;if(r.spriteManagers.length>0){const e=r.pickSprite(t,i,this._gt,!1,r.cameraToUseForPointers||void 0);e&&(e.hit&&e.pickedSprite&&e.pickedSprite.actionManager&&(e.pickedSprite.actionManager.processTrigger(7,D.CreateNewFromSprite(e.pickedSprite,r,s)),e.pickedSprite.actionManager&&(this.scene.ud.lm()||e.pickedSprite.actionManager.processTrigger(1,D.CreateNewFromSprite(e.pickedSprite,r,s)),n&&e.pickedSprite.actionManager.processTrigger(6,D.CreateNewFromSprite(e.pickedSprite,r,s)))),r.Lgt&&r.Lgt.actionManager&&r.Lgt!==e.pickedSprite&&r.Lgt.actionManager.processTrigger(16,D.CreateNewFromSprite(r.Lgt,r,s)))}return e}}const iI="imageProcessingCompatibility",eI="#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));\n#endif\n";ii.IncludesShadersStore[iI]=eI;const sI="spritesPixelShader",nI="uniform bool alphaTest;\nvarying vec4 vColor;\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 color=texture2D(diffuseSampler,vUV);\nif (float(alphaTest) != 0.)\n{\nif (color.a<0.95)\ndiscard;\n}\ncolor*=vColor;\n#include<fogFragment>\ngl_FragColor=color;\n#include<imageProcessingCompatibility>\n#define CUSTOM_FRAGMENT_MAIN_END\n}";ii.ShadersStore[sI]=nI;const rI="spritesVertexShader",hI="attribute vec4 position;\nattribute vec2 options;\nattribute vec2 offsets;\nattribute vec2 inverts;\nattribute vec4 cellInfo;\nattribute vec4 color;\nuniform mat4 view;\nuniform mat4 projection;\nvarying vec2 vUV;\nvarying vec4 vColor;\n#include<fogVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; \nvec2 cornerPos;\nfloat angle=position.w;\nvec2 size=vec2(options.x,options.y);\nvec2 offset=offsets.xy;\ncornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \nvColor=color;\nvec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));\nvec2 uvPlace=cellInfo.xy;\nvec2 uvSize=cellInfo.zw;\nvUV.x=uvPlace.x+uvSize.x*uvOffset.x;\nvUV.y=uvPlace.y+uvSize.y*uvOffset.y;\n#ifdef FOG\nvFogDistance=viewPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}";ii.ShadersStore[rI]=hI;class oI{constructor(t,i,e=.01,s=null){this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this.fogEnabled=!0,this.Ogt=!1,this.K0=!1,this.ff={},this.lK=i,this.Oj=e,this.Ls=t,this.K0=t.getCaps().instancedArrays&&t.hs.supportSpriteInstancing,this.Ogt=t.getCaps().vertexArrayObject&&!t.disableVertexArrayObjects,this.Kt=s,this.Fgt=new vi(t),this.Bgt=new vi(t),this.Ugt=new vi(t,!1),this.Vgt=new vi(t,!1),this.K0||this.pf(),this.Fgt.drawContext&&(this.Fgt.drawContext.useInstancing=this.K0),this.Bgt.drawContext&&(this.Bgt.drawContext.useInstancing=this.K0),this.Ugt.drawContext&&(this.Ugt.drawContext.useInstancing=this.K0),this.Vgt.drawContext&&(this.Vgt.drawContext.useInstancing=this.K0),this.fct=this.K0?16:18,this.dct=new Float32Array(i*this.fct*(this.K0?1:4)),this.Yn=new re(t,this.dct,!0,this.fct);const n=this.Yn.createVertexBuffer(he.PositionKind,0,4,this.fct,this.K0),r=this.Yn.createVertexBuffer("options",4,2,this.fct,this.K0);let h,o=6;if(this.K0){const i=new Float32Array([0,0,1,0,0,1,1,1]);this.uct=new re(t,i,!1,2),h=this.uct.createVertexBuffer("offsets",0,2)}else h=this.Yn.createVertexBuffer("offsets",o,2,this.fct,this.K0),o+=2;const a=this.Yn.createVertexBuffer("inverts",o,2,this.fct,this.K0),l=this.Yn.createVertexBuffer("cellInfo",o+2,4,this.fct,this.K0),c=this.Yn.createVertexBuffer(he.ColorKind,o+6,4,this.fct,this.K0);this.ff[he.PositionKind]=n,this.ff.options=r,this.ff.offsets=h,this.ff.inverts=a,this.ff.cellInfo=l,this.ff[he.ColorKind]=c,this.Fgt.effect=this.Ls.createEffect("sprites",[he.PositionKind,"options","offsets","inverts","cellInfo",he.ColorKind],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],""),this.Ugt.effect=this.Fgt.effect,this.Ugt.materialContext=this.Fgt.materialContext,this.Kt&&(this.Bgt.effect=this.Kt.getEngine().createEffect("sprites",[he.PositionKind,"options","offsets","inverts","cellInfo",he.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],"#define FOG"),this.Vgt.effect=this.Bgt.effect,this.Vgt.materialContext=this.Bgt.materialContext)}get capacity(){return this.lK}render(t,i,e,s,n=null){if(!this.texture||!this.texture.isReady()||!t.length)return;let r=this.Fgt,h=this.Ugt,o=!1;this.fogEnabled&&this.Kt&&this.Kt.fogEnabled&&0!==this.Kt.fogMode&&(r=this.Bgt,h=this.Vgt,o=!0);const a=r.effect;if(!a.isReady())return;const l=this.Ls,c=!(!this.Kt||!this.Kt.useRightHandedSystem),u=this.texture.getBaseSize(),f=Math.min(this.lK,t.length);let d=0,p=!0;for(let e=0;e<f;e++){const s=t[e];s&&s.isVisible&&(p=!1,s.bS(i),this.kgt(d++,s,0,0,u,c,n),this.K0||(this.kgt(d++,s,1,0,u,c,n),this.kgt(d++,s,1,1,u,c,n),this.kgt(d++,s,0,1,u,c,n)))}if(p)return;this.Yn.update(this.dct);const m=!!l.depthCullingState.cull,v=l.depthCullingState.zOffset,g=l.depthCullingState.zOffsetUnits;if(l.setState(m,v,!1,!1,void 0,void 0,g),l.enableEffect(r),a.setTexture("diffuseSampler",this.texture),a.setMatrix("view",e),a.setMatrix("projection",s),o){const t=this.Kt;a.setFloat4("vFogInfos",t.fogMode,t.fogStart,t.fogEnd,t.fogDensity),a.setColor3("vFogColor",t.fogColor)}this.Ogt?(this.Qlt||(this.Qlt=l.recordVertexArrayObject(this.ff,this.Xu,a)),l.bindVertexArrayObject(this.Qlt,this.Xu)):l.bindBuffers(this.ff,this.Xu,a),l.depthCullingState.depthFunc=l.useReverseDepthBuffer?518:515,this.disableDepthWrite||(a.setBool("alphaTest",!0),l.setColorWrite(!1),l.enableEffect(h),this.K0?l.drawArraysType(7,0,4,d):l.drawElementsType(0,0,d/4*6),l.enableEffect(r),l.setColorWrite(!0),a.setBool("alphaTest",!1)),l.setAlphaMode(this.blendMode),this.K0?l.drawArraysType(7,0,4,d):l.drawElementsType(0,0,d/4*6),this.autoResetAlpha&&l.setAlphaMode(0),c&&this.Kt.getEngine().setState(m,v,!1,!0,void 0,void 0,g),l.unbindInstanceAttributes()}kgt(t,i,e,s,n,r,h){let o=t*this.fct;if(0===e?e=this.Oj:1===e&&(e=1-this.Oj),0===s?s=this.Oj:1===s&&(s=1-this.Oj),h)h(i,n);else{i.cellIndex||(i.cellIndex=0);const t=n.width/this.cellWidth,e=i.cellIndex/t>>0;i.Ggt=(i.cellIndex-e*t)*this.cellWidth/n.width,i.zgt=e*this.cellHeight/n.height,i.Hgt=this.cellWidth,i.Xgt=this.cellHeight}this.dct[o]=i.position.x,this.dct[o+1]=i.position.y,this.dct[o+2]=i.position.z,this.dct[o+3]=i.angle,this.dct[o+4]=i.width,this.dct[o+5]=i.height,this.K0?o-=2:(this.dct[o+6]=e,this.dct[o+7]=s),this.dct[o+8]=r?i.invertU?0:1:i.invertU?1:0,this.dct[o+9]=i.invertV?1:0,this.dct[o+10]=i.Ggt,this.dct[o+11]=i.zgt,this.dct[o+12]=i.Hgt/n.width,this.dct[o+13]=i.Xgt/n.height,this.dct[o+14]=i.color.r,this.dct[o+15]=i.color.g,this.dct[o+16]=i.color.b,this.dct[o+17]=i.color.a}pf(){const t=[];let i=0;for(let e=0;e<this.lK;e++)t.push(i),t.push(i+1),t.push(i+2),t.push(i),t.push(i+2),t.push(i+3),i+=4;this.Xu=this.Ls.createIndexBuffer(t)}rebuild(){var t;this.Xu&&this.pf(),this.Ogt&&(this.Qlt=void 0),this.Yn.br();for(const t in this.ff){this.ff[t].br()}null===(t=this.uct)||void 0===t||t.br()}dispose(){this.Yn&&(this.Yn.dispose(),this.Yn=null),this.uct&&(this.uct.dispose(),this.uct=null),this.Xu&&(this.Ls.ca(this.Xu),this.Xu=null),this.Qlt&&(this.Ls.releaseVertexArrayObject(this.Qlt),this.Qlt=null),this.texture&&(this.texture.dispose(),this.texture=null),this.Fgt.dispose(),this.Bgt.dispose(),this.Ugt.dispose(),this.Vgt.dispose()}}class aI{constructor(t,i,e,s,n,r=.01,o=an.TRILINEAR_SAMPLINGMODE,a=!1,l=null){this.name=t,this.sprites=new Array,this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.metadata=null,this.sd=!1,this.onDisposeObservable=new h,this.Wgt=!1,this.$gt=!1,this.Ygt=(t,i)=>{t.cellRef||(t.cellIndex=0);const e=t.cellIndex;"number"==typeof e&&isFinite(e)&&Math.floor(e)===e&&(t.cellRef=this.jgt[t.cellIndex]),t.Ggt=this.Kgt[t.cellRef].frame.x/i.width,t.zgt=this.Kgt[t.cellRef].frame.y/i.height,t.Hgt=this.Kgt[t.cellRef].frame.w,t.Xgt=this.Kgt[t.cellRef].frame.h},n||(n=E.LastCreatedScene),n.Mg(fe.NAME_SPRITE)||n.Ig(new tI(n)),this.qgt=a,this.Kt=n;const c=this.Kt.getEngine();if(this.Qgt=new oI(c,e,r,n),s.width&&s.height)this.cellWidth=s.width,this.cellHeight=s.height;else{if(void 0===s)return void(this.Qgt=null);this.cellWidth=s,this.cellHeight=s}this.Kt.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),i&&(this.texture=new an(i,n,!0,!1,o)),this.qgt&&this.Zgt(i,l)}set onDispose(t){this.Li&&this.onDisposeObservable.remove(this.Li),this.Li=this.onDisposeObservable.add(t)}get children(){return this.sprites}get scene(){return this.Kt}get capacity(){return this.Qgt.capacity}get texture(){return this.Qgt.texture}set texture(t){t.wrapU=an.CLAMP_ADDRESSMODE,t.wrapV=an.CLAMP_ADDRESSMODE,this.Qgt.texture=t,this.Jgt=null}get cellWidth(){return this.Qgt.cellWidth}set cellWidth(t){this.Qgt.cellWidth=t}get cellHeight(){return this.Qgt.cellHeight}set cellHeight(t){this.Qgt.cellHeight=t}get fogEnabled(){return this.Qgt.fogEnabled}set fogEnabled(t){this.Qgt.fogEnabled=t}get blendMode(){return this.Qgt.blendMode}set blendMode(t){this.Qgt.blendMode=t}get disableDepthWrite(){return this.Wgt}set disableDepthWrite(t){this.Wgt=t,this.Qgt.disableDepthWrite=t}getClassName(){return"SpriteManager"}Zgt(t,i){if(null!==i)try{let t;if(t="string"==typeof i?JSON.parse(i):i,t.frames.length){const i={};for(let e=0;e<t.frames.length;e++){const s=t.frames[e];if("string"!=typeof Object.keys(s)[0])throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");i[s[Object.keys(s)[0]]]=s}t.frames=i}const e=Reflect.ownKeys(t.frames);this.jgt=e,this.$gt=!0,this.Kgt=t.frames}catch(t){throw this.qgt=!1,this.$gt=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{const i=/\./g;let e;do{e=i.lastIndex,i.test(t)}while(i.lastIndex>0);const s=t.substring(0,e-1)+".json",n=()=>{F.Error("JSON ERROR: Unable to load JSON file."),this.qgt=!1,this.$gt=!1},r=t=>{try{const i=JSON.parse(t),e=Reflect.ownKeys(i.frames);this.jgt=e,this.$gt=!0,this.Kgt=i.frames}catch(t){throw this.qgt=!1,this.$gt=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}};ki.LoadFile(s,r,void 0,void 0,!1,n)}}tSt(t,i,e,s,n){if(!t.useAlphaForPicking||!this.texture)return!0;const r=this.texture.getSize();this.Jgt||(this.Jgt=new Uint8Array(r.width*r.height*4),this.texture.readPixels(0,0,this.Jgt));const h=M.Vector3[0];h.copyFrom(i.direction),h.normalize(),h.scaleInPlace(e),h.addInPlace(i.origin);const o=(h.x-s.x)/(n.x-s.x)-.5,a=1-(h.y-s.y)/(n.y-s.y)-.5,l=t.angle,c=o*Math.cos(l)-a*Math.sin(l)+.5,u=o*Math.sin(l)+a*Math.cos(l)+.5,f=t.Ggt*r.width+c*t.Hgt|0,d=t.zgt*r.height+u*t.Xgt|0;return this.Jgt[4*(f+d*r.width)+3]>.5}intersects(t,i,e,s){const n=Math.min(this.capacity,this.sprites.length),r=w.Zero(),h=w.Zero();let o=Number.MAX_VALUE,a=null;const l=M.Vector3[0],c=M.Vector3[1],u=i.getViewMatrix();let f=t,d=t;for(let i=0;i<n;i++){const n=this.sprites[i];if(n){if(e){if(!e(n))continue}else if(!n.isPickable)continue;if(w.TransformCoordinatesToRef(n.position,u,c),n.angle?(R.TranslationToRef(-c.x,-c.y,0,M.Matrix[1]),R.TranslationToRef(c.x,c.y,0,M.Matrix[2]),R.RotationZToRef(n.angle,M.Matrix[3]),M.Matrix[1].multiplyToRef(M.Matrix[3],M.Matrix[4]),M.Matrix[4].multiplyToRef(M.Matrix[2],M.Matrix[0]),f=t.clone(),w.TransformCoordinatesToRef(t.origin,M.Matrix[0],f.origin),w.TransformNormalToRef(t.direction,M.Matrix[0],f.direction)):f=t,r.copyFromFloats(c.x-n.width/2,c.y-n.height/2,c.z),h.copyFromFloats(c.x+n.width/2,c.y+n.height/2,c.z),f.intersectsBoxMinMax(r,h)){const t=w.Distance(c,f.origin);if(o>t){if(!this.tSt(n,f,t,r,h))continue;if(d=f,o=t,a=n,s)break}}}}if(a){const t=new oe;u.invertToRef(M.Matrix[0]),t.hit=!0,t.pickedSprite=a,t.distance=o;const i=M.Vector3[2];return i.copyFrom(d.direction),i.normalize(),i.scaleInPlace(o),d.origin.addToRef(i,l),t.pickedPoint=w.TransformCoordinates(l,M.Matrix[0]),t}return null}multiIntersects(t,i,e){const s=Math.min(this.capacity,this.sprites.length),n=w.Zero(),r=w.Zero();let h;const o=[],a=M.Vector3[0].copyFromFloats(0,0,0),l=M.Vector3[1].copyFromFloats(0,0,0),c=i.getViewMatrix();for(let i=0;i<s;i++){const s=this.sprites[i];if(s){if(e){if(!e(s))continue}else if(!s.isPickable)continue;if(w.TransformCoordinatesToRef(s.position,c,l),n.copyFromFloats(l.x-s.width/2,l.y-s.height/2,l.z),r.copyFromFloats(l.x+s.width/2,l.y+s.height/2,l.z),t.intersectsBoxMinMax(n,r)){if(h=w.Distance(l,t.origin),!this.tSt(s,t,h,n,r))continue;const i=new oe;o.push(i),c.invertToRef(M.Matrix[0]),i.hit=!0,i.pickedSprite=s,i.distance=h;const e=M.Vector3[2];e.copyFrom(t.direction),e.normalize(),e.scaleInPlace(h),t.origin.addToRef(e,a),i.pickedPoint=w.TransformCoordinates(a,M.Matrix[0])}}}return o}render(){if(this.qgt&&(!this.$gt||!this.jgt||!this.Kgt))return;const t=this.Kt.getEngine().getDeltaTime();this.$gt?this.Qgt.render(this.sprites,t,this.Kt.getViewMatrix(),this.Kt.getProjectionMatrix(),this.Ygt):this.Qgt.render(this.sprites,t,this.Kt.getViewMatrix(),this.Kt.getProjectionMatrix())}rebuild(){var t;null===(t=this.Qgt)||void 0===t||t.rebuild()}dispose(){this.Qgt&&(this.Qgt.dispose(),this.Qgt=null),this.Jgt=null;const t=this.Kt.spriteManagers.indexOf(this);this.Kt.spriteManagers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null}serialize(t=!1){const i={};i.name=this.name,i.capacity=this.capacity,i.cellWidth=this.cellWidth,i.cellHeight=this.cellHeight,this.texture&&(t?i.texture=this.texture.serialize():(i.textureUrl=this.texture.name,i.invertY=this.texture.t_)),i.sprites=[];for(const t of this.sprites)i.sprites.push(t.serialize());return i.metadata=this.metadata,i}static Parse(t,i,e){const s=new aI(t.name,"",t.capacity,{width:t.cellWidth,height:t.cellHeight},i);void 0!==t.metadata&&(s.metadata=t.metadata),t.texture?s.texture=an.Parse(t.texture,i,e):t.textureName&&(s.texture=new an(e+t.textureUrl,i,!1,void 0===t.invertY||t.invertY));for(const i of t.sprites)JR.Parse(i,s);return s}static ParseFromFileAsync(t,i,e,s=""){return new Promise(((n,r)=>{const h=new mt;h.addEventListener("readystatechange",(()=>{if(4==h.readyState)if(200==h.status){const i=JSON.parse(h.responseText),r=aI.Parse(i,e||E.LastCreatedScene,s);t&&(r.name=t),n(r)}else r("Unable to load the sprite manager")})),h.open("GET",i),h.send()}))}static ParseFromSnippetAsync(t,i,e=""){return"_BLANK"===t?Promise.resolve(new aI("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,i)):new Promise(((s,n)=>{const r=new mt;r.addEventListener("readystatechange",(()=>{if(4==r.readyState)if(200==r.status){const n=JSON.parse(JSON.parse(r.responseText).jsonPayload),h=JSON.parse(n.spriteManager),o=aI.Parse(h,i||E.LastCreatedScene,e);o.snippetId=t,s(o)}else n("Unable to load the snippet "+t)})),r.open("GET",this.SnippetUrl+"/"+t.replace(/#/g,"/")),r.send()}))}}aI.SnippetUrl="https://snippet.babylonjs.com",aI.CreateFromSnippetAsync=aI.ParseFromSnippetAsync;const lI="spriteMapPixelShader",cI="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nprecision highp float;\nvarying vec3 vPosition;\nvarying vec2 vUV;\nvarying vec2 tUV;\nuniform float time;\nuniform float spriteCount;\nuniform sampler2D spriteSheet;\nuniform vec2 spriteMapSize;\nuniform vec2 outputSize;\nuniform vec2 stageSize;\nuniform sampler2D frameMap;\nuniform sampler2D tileMaps[LAYERS];\nuniform sampler2D animationMap;\nuniform vec3 colorMul;\nfloat mt;\nconst float fdStep=1./4.;\nconst float aFrameSteps=1./MAX_ANIMATION_FRAMES;\nmat4 getFrameData(float frameID){\nfloat fX=frameID/spriteCount;\nreturn mat4(\ntexture2D(frameMap,vec2(fX,0.),0.),\ntexture2D(frameMap,vec2(fX,fdStep*1.),0.),\ntexture2D(frameMap,vec2(fX,fdStep*2.),0.),\nvec4(0.)\n);\n}\nvoid main(){\nvec4 color=vec4(0.);\nvec2 tileUV=fract(tUV);\n#ifdef FLIPU\ntileUV.y=1.0-tileUV.y;\n#endif\nvec2 tileID=floor(tUV);\nvec2 sheetUnits=1./spriteMapSize;\nfloat spriteUnits=1./spriteCount;\nvec2 stageUnits=1./stageSize;\nfor(int i=0; i<LAYERS; i++) {\nfloat frameID;\n#define LAYER_ID_SWITCH\nvec4 animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,0.),0.);\nif(animationData.y>0.) {\nmt=mod(time*animationData.z,1.0);\nfor(float f=0.; f<MAX_ANIMATION_FRAMES; f++){\nif(animationData.y>mt){\nframeID=animationData.x;\nbreak;\n}\nanimationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.);\n}\n}\nmat4 frameData=getFrameData(frameID+0.5);\nvec2 frameSize=(frameData[0].zw)/spriteMapSize;\nvec2 offset=frameData[0].xy*sheetUnits;\nvec2 ratio=frameData[2].xy/frameData[0].zw;\nif (frameData[2].z==1.){\ntileUV.xy=tileUV.yx;\n}\nvec4 nc=texture2D(spriteSheet,tileUV*frameSize+offset);\nif (i==0){\ncolor=nc;\n} else {\nfloat alpha=min(color.a+nc.a,1.0);\nvec3 mixed=mix(color.xyz,nc.xyz,nc.a);\ncolor=vec4(mixed,alpha);\n}\n}\ncolor.xyz*=colorMul;\ngl_FragColor=color;\n}";ii.ShadersStore[lI]=cI;const uI="spriteMapVertexShader",fI="precision highp float;\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nvarying vec3 vPosition;\nvarying vec2 vUV;\nvarying vec2 tUV;\nvarying vec2 stageUnits;\nvarying vec2 levelUnits;\nvarying vec2 tileID;\nuniform float time;\nuniform mat4 worldViewProjection;\nuniform vec2 outputSize;\nuniform vec2 stageSize;\nuniform vec2 spriteMapSize;\nuniform float stageScale;\nvoid main() {\nvec4 p=vec4( position,1. );\nvPosition=p.xyz;\nvUV=uv;\ntUV=uv*stageSize; \ngl_Position=worldViewProjection*p;\n}";ii.ShadersStore[uI]=fI;var dI;!function(t){t[t.INIT=0]="INIT",t[t.RUNNING=1]="RUNNING",t[t.DONE=2]="DONE",t[t.ERROR=3]="ERROR"}(dI||(dI={}));h.prototype.notifyObserversWithPromise=async function(t,i=-1,e,s,n){let r=Promise.resolve(t);if(!this.observers.length)return r;const h=this.I;return h.mask=i,h.target=e,h.currentTarget=s,h.skipNextObservers=!1,h.userInfo=n,this.observers.forEach((e=>{h.skipNextObservers||e.S||e.mask&i&&(r=e.scope?r.then((i=>(h.lastReturnValue=i,e.callback.apply(e.scope,[t,h])))):r.then((i=>(h.lastReturnValue=i,e.callback(t,h)))),e.unregisterOnNextCall&&this._(e))})),await r,t};class pI{constructor(t=0){this.priority=t}getDescription(){return""}apply(t,i){return!0}}class mI extends pI{constructor(){super(...arguments),this.iSt=t=>{if(!(t instanceof Ys))return!1;const i=t;return!i.isDisposed()&&(!(!i.isVisible||!i.isEnabled())&&(!(i.instances.length>0)&&(!i.skeleton&&!i.hasLODLevels)))}}static get UpdateSelectionTree(){return mI.eSt}static set UpdateSelectionTree(t){mI.eSt=t}getDescription(){return"Merging similar meshes together"}apply(t,i,e){const s=t.meshes.slice(0);let n=s.length;for(let t=0;t<n;t++){const i=new Array,e=s[t];if(this.iSt(e)){i.push(e);for(let r=t+1;r<n;r++){const t=s[r];this.iSt(t)&&(t.material===e.material&&t.checkCollisions===e.checkCollisions&&(i.push(t),n--,s.splice(r,1),r--))}i.length<2||Ys.MergeMeshes(i,void 0,!0)}}const r=t;return r.createOrUpdateSelectionOctree&&(null!=e?e&&r.createOrUpdateSelectionOctree():mI.UpdateSelectionTree&&r.createOrUpdateSelectionOctree()),!0}}mI.eSt=!1;let vI=[];const gI=(t,i)=>{t.doNotSerialize||(i.vertexData.push(t.serializeVerticeData()),vI[t.id]=!0)},SI=(t,i)=>{const e={},s=t.qC;return s&&(t.getScene().getGeometryById(s.id)||gI(s,i.geometries)),t.serialize&&t.serialize(e),e};class EI{static ClearCache(){vI=[]}static Serialize(t){return EI.Tct(t)}static Tct(t,i=!0){const e={};if(i&&!t.getEngine().hs.supportSyncTextureRead&&an.ForceSerializeBuffers&&console.warn("The serialization object may not contain the proper base64 encoded texture data! You should use the SerializeAsync method instead."),EI.ClearCache(),e.useDelayedTextureLoading=t.useDelayedTextureLoading,e.autoClear=t.autoClear,e.clearColor=t.clearColor.asArray(),e.ambientColor=t.ambientColor.asArray(),e.gravity=t.gravity.asArray(),e.collisionsEnabled=t.collisionsEnabled,e.useRightHandedSystem=t.useRightHandedSystem,t.fogMode&&0!==t.fogMode&&(e.fogMode=t.fogMode,e.fogColor=t.fogColor.asArray(),e.fogStart=t.fogStart,e.fogEnd=t.fogEnd,e.fogDensity=t.fogDensity),t.isPhysicsEnabled()){const i=t.getPhysicsEngine();i&&(e.physicsEnabled=!0,e.physicsGravity=i.gravity.asArray(),e.physicsEngine=i.getPhysicsPluginName())}t.metadata&&(e.metadata=t.metadata),e.morphTargetManagers=[];for(const i of t.meshes){const t=i.morphTargetManager;t&&e.morphTargetManagers.push(t.serialize())}let s,n,r;for(e.lights=[],s=0;s<t.lights.length;s++)n=t.lights[s],n.doNotSerialize||e.lights.push(n.serialize());for(e.cameras=[],s=0;s<t.cameras.length;s++){const i=t.cameras[s];i.doNotSerialize||e.cameras.push(i.serialize())}if(t.activeCamera&&(e.activeCameraID=t.activeCamera.id),ot.AppendSerializedAnimations(t,e),t.animationGroups&&t.animationGroups.length>0){e.animationGroups=[];for(let i=0;i<t.animationGroups.length;i++){const s=t.animationGroups[i];e.animationGroups.push(s.serialize())}}if(t.reflectionProbes&&t.reflectionProbes.length>0)for(e.reflectionProbes=[],s=0;s<t.reflectionProbes.length;s++){const i=t.reflectionProbes[s];e.reflectionProbes.push(i.serialize())}for(e.materials=[],e.multiMaterials=[],s=0;s<t.materials.length;s++)r=t.materials[s],r.doNotSerialize||e.materials.push(r.serialize());for(e.multiMaterials=[],s=0;s<t.multiMaterials.length;s++){const i=t.multiMaterials[s];e.multiMaterials.push(i.serialize())}for(t.environmentTexture&&(t.environmentTexture.Jn?e.environmentTexture=t.environmentTexture.serialize():(e.environmentTexture=t.environmentTexture.name,e.environmentTextureRotationY=t.environmentTexture.rotationY)),e.environmentIntensity=t.environmentIntensity,e.skeletons=[],s=0;s<t.skeletons.length;s++){const i=t.skeletons[s];i.doNotSerialize||e.skeletons.push(i.serialize())}for(e.transformNodes=[],s=0;s<t.transformNodes.length;s++)t.transformNodes[s].doNotSerialize||e.transformNodes.push(t.transformNodes[s].serialize());e.geometries={},e.geometries.boxes=[],e.geometries.spheres=[],e.geometries.cylinders=[],e.geometries.toruses=[],e.geometries.grounds=[],e.geometries.planes=[],e.geometries.torusKnots=[],e.geometries.vertexData=[],vI=[];const h=t.getGeometries();for(s=0;s<h.length;s++){const t=h[s];t.isReady()&&gI(t,e.geometries)}for(e.meshes=[],s=0;s<t.meshes.length;s++){const i=t.meshes[s];if(i instanceof Ys){const t=i;t.doNotSerialize||1!==t.delayLoadState&&0!==t.delayLoadState||e.meshes.push(SI(t,e))}}for(e.particleSystems=[],s=0;s<t.particleSystems.length;s++)e.particleSystems.push(t.particleSystems[s].serialize(!1));for(e.postProcesses=[],s=0;s<t.postProcesses.length;s++)e.postProcesses.push(t.postProcesses[s].serialize());t.actionManager&&(e.actions=t.actionManager.serialize("scene"));for(const i of t.Bv)i.serialize(e);return e}static SerializeAsync(t){const i=EI.Tct(t,!1),e=[];return this.sSt(i,e),Promise.all(e).then((()=>i))}static sSt(t,i){if(Array.isArray(t))for(let e=0;e<t.length;++e){const s=t[e];s instanceof Promise?i.push(s.then((i=>t[e]=i))):(s instanceof Object||Array.isArray(s))&&this.sSt(s,i)}else if(t instanceof Object)for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){const s=t[e];s instanceof Promise?i.push(s.then((i=>t[e]=i))):(s instanceof Object||Array.isArray(s))&&this.sSt(s,i)}}static SerializeMesh(t,i=!1,e=!1){const s={};if(EI.ClearCache(),t=t instanceof Array?t:[t],i||e)for(let s=0;s<t.length;++s)e&&t[s].getDescendants().forEach((i=>{i instanceof Ys&&t.indexOf(i)<0&&!i.doNotSerialize&&t.push(i)})),i&&t[s].parent&&t.indexOf(t[s].parent)<0&&!t[s].parent.doNotSerialize&&t.push(t[s].parent);return t.forEach((t=>{((t,i)=>{if(1===t.delayLoadState||0===t.delayLoadState){const e=e=>{i.materials=i.materials||[],t.material&&!i.materials.some((i=>i.id===t.material.id))&&i.materials.push(e.serialize())};if(t.material&&!t.material.doNotSerialize)if(t.material instanceof ks){if(i.multiMaterials=i.multiMaterials||[],!i.multiMaterials.some((i=>i.id===t.material.id))){i.multiMaterials.push(t.material.serialize());for(const i of t.material.subMaterials)i&&e(i)}}else e(t.material);else t.material||e(t.getScene().defaultMaterial);const s=t.qC;s&&(i.geometries||(i.geometries={},i.geometries.boxes=[],i.geometries.spheres=[],i.geometries.cylinders=[],i.geometries.toruses=[],i.geometries.grounds=[],i.geometries.planes=[],i.geometries.torusKnots=[],i.geometries.vertexData=[]),gI(s,i.geometries)),t.skeleton&&!t.skeleton.doNotSerialize&&(i.skeletons=i.skeletons||[],i.skeletons.push(t.skeleton.serialize())),i.meshes=i.meshes||[],i.meshes.push(SI(t,i))}})(t,s)})),s}}class AI{constructor(t,i={}){if(!AI.IsSupported(t))throw"Your browser does not support recording so far.";const e=t.getRenderingCanvas();if(!e)throw"The babylon engine must have a canvas to be recorded";this.GW=e,this.GW.isRecording=!1,this.wb={...AI.Brt,...i};const s=this.GW.captureStream(this.wb.fps);if(this.wb.audioTracks)for(const t of this.wb.audioTracks)s.addTrack(t);this.nSt=new MediaRecorder(s,{mimeType:this.wb.mimeType}),this.nSt.ondataavailable=this.rSt.bind(this),this.nSt.onerror=this.hSt.bind(this),this.nSt.onstop=this.oSt.bind(this)}static IsSupported(t){const i=t.getRenderingCanvas();return!!i&&"function"==typeof i.captureStream}get isRecording(){return!!this.GW&&this.GW.isRecording}stopRecording(){this.GW&&this.nSt&&this.isRecording&&(this.GW.isRecording=!1,this.nSt.stop())}startRecording(t="babylonjs.webm",i=7){if(!this.GW||!this.nSt)throw"Recorder has already been disposed";if(this.isRecording)throw"Recording already in progress";return i>0&&setTimeout((()=>{this.stopRecording()}),1e3*i),this.aSt=t,this.lSt=[],this.cSt=null,this.uSt=null,this.GW.isRecording=!0,this.nSt.start(this.wb.recordChunckSize),new Promise(((t,i)=>{this.cSt=t,this.uSt=i}))}dispose(){this.GW=null,this.nSt=null,this.lSt=[],this.aSt=null,this.cSt=null,this.uSt=null}rSt(t){t.data.size>0&&this.lSt.push(t.data)}hSt(t){if(this.stopRecording(),!this.uSt)throw new t.error;this.uSt(t.error)}oSt(){this.stopRecording();const t=new Blob(this.lSt);this.cSt&&this.cSt(t),window.URL.createObjectURL(t),this.aSt&&ki.Download(t,this.aSt)}}AI.Brt={mimeType:"video/webm",fps:25,recordChunckSize:3e3};let CI=null;function wI(t,i,e,s,n="image/png",r=!1){const{height:h,width:o}=II(t,i,e);if(!h||!o)return void F.Error("Invalid 'size' parameter !");CI||(CI=document.createElement("canvas")),CI.width=o,CI.height=h;const a=CI.getContext("2d"),l=t.getRenderWidth()/t.getRenderHeight();let c=o,u=c/l;u>h&&(u=h,c=u*l);const f=Math.max(0,o-c)/2,d=Math.max(0,h-u)/2;i.getScene().activeCamera!==i?TI(t,i,e,(t=>{if(r){const i=new Blob([t]);ki.DownloadBlob(i),s&&s("")}else s&&s(t)}),n,1,t.getCreationOptions().antialias):t.onEndFrameObservable.addOnce((()=>{const i=t.getRenderingCanvas();a&&i&&a.drawImage(i,f,d,c,u),CI&&(r?(ki.EncodeScreenshotCanvasData(CI,void 0,n),s&&s("")):ki.EncodeScreenshotCanvasData(CI,s,n))}))}function xI(t,i,e,s="image/png"){return new Promise(((n,r)=>{wI(t,i,e,(t=>{void 0!==t?n(t):r(new Error("Data is undefined"))}),s)}))}function TI(t,i,e,s,n="image/png",r=1,h=!1,o,a=!1,l=!1,c=!0){const{height:u,width:f}=II(t,i,e),d={width:f,height:u};if(!u||!f)return void F.Error("Invalid 'size' parameter !");const p={width:t.getRenderWidth(),height:t.getRenderHeight()};t.setSize(f,u);const m=i.getScene(),v=new br("screenShot",d,m,!1,!1,0,!1,an.NEAREST_SAMPLINGMODE,void 0,l,void 0,void 0,void 0,r);v.renderList=m.meshes.slice(),v.samples=r,v.renderSprites=a,v.activeCamera=i,v.forceLayerMaskCheck=c;const g=()=>{t.onEndFrameObservable.addOnce((()=>{v.readPixels(void 0,void 0,void 0,!1).then((t=>{Mr.DumpData(f,u,t,s,n,o,!0),v.dispose()}))})),m.incrementRenderId(),m.resetCachedMaterial(),v.render(!0),m.incrementRenderId(),m.resetCachedMaterial(),t.setSize(p.width,p.height),i.getProjectionMatrix(!0),m.render()};if(h){const t=new Ax("antialiasing",1,m.activeCamera);v.addPostProcess(t),t.getEffect().isReady()?g():t.getEffect().onCompiled=()=>{g()}}else g()}function RI(t,i,e,s="image/png",n=1,r=!1,h,o=!1,a=!1,l=!0){return new Promise(((c,u)=>{TI(t,i,e,(t=>{void 0!==t?c(t):u(new Error("Data is undefined"))}),s,n,r,h,o,a,l)}))}function II(t,i,e){let s=0,n=0;if("object"==typeof e){const r=e.precision?Math.abs(e.precision):1;e.width&&e.height?(s=e.height*r,n=e.width*r):e.width&&!e.height?(n=e.width*r,s=Math.round(n/t.getAspectRatio(i))):e.height&&!e.width?(s=e.height*r,n=Math.round(s*t.getAspectRatio(i))):(n=Math.round(t.getRenderWidth()*r),s=Math.round(n/t.getAspectRatio(i)))}else isNaN(e)||(s=e,n=e);return n&&(n=Math.floor(n)),s&&(s=Math.floor(s)),{height:0|s,width:0|n}}var MI,bI;ki.CreateScreenshot=wI,ki.CreateScreenshotAsync=xI,ki.CreateScreenshotUsingRenderTarget=TI,ki.CreateScreenshotUsingRenderTargetAsync=RI,function(t){t[t.Checkbox=0]="Checkbox",t[t.Slider=1]="Slider",t[t.Vector3=2]="Vector3",t[t.Quaternion=3]="Quaternion",t[t.Color3=4]="Color3",t[t.String=5]="String",t[t.Button=6]="Button",t[t.Options=7]="Options",t[t.Tab=8]="Tab",t[t.FileButton=9]="FileButton",t[t.Vector2=10]="Vector2"}(MI||(MI={}));class _I{static fSt(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch(t){const i={};return{getItem:t=>{const e=i[t];return void 0===e?null:e},setItem:(t,e)=>{i[t]=e}}}}static ReadString(t,i){const e=this.dSt.getItem(t);return null!==e?e:i}static WriteString(t,i){this.dSt.setItem(t,i)}static ReadBoolean(t,i){const e=this.dSt.getItem(t);return null!==e?"true"===e:i}static WriteBoolean(t,i){this.dSt.setItem(t,i?"true":"false")}static ReadNumber(t,i){const e=this.dSt.getItem(t);return null!==e?parseFloat(e):i}static WriteNumber(t,i){this.dSt.setItem(t,i.toString())}}_I.dSt=_I.fSt();!function(t){class i{constructor(t,i=null,e=null,s=null){let n;i=null!=i?i:()=>1,e=null!=e?e:()=>1,s=null!=s?s:(t,i)=>t===i?0:1,this.pSt=new Map,this.mSt=new Array(t.length),this.vSt=new Array(t.length),this.gSt=new Array(t.length);for(let r=0;r<t.length;++r){n=t[r],this.pSt.set(n,r),this.mSt[r]=i(n),this.vSt[r]=e(n),this.gSt[r]=new Array(t.length);for(let i=r;i<t.length;++i)this.gSt[r][i]=s(n,t[i])}}serialize(){const t={},i=new Array(this.pSt.size);return this.pSt.forEach(((t,e)=>{i[t]=e})),t.characters=i,t.insertionCosts=this.mSt,t.deletionCosts=this.vSt,t.substitutionCosts=this.gSt,JSON.stringify(t)}static Deserialize(t){const e=JSON.parse(t),s=new i(e.characters);return s.mSt=e.insertionCosts,s.vSt=e.deletionCosts,s.gSt=e.substitutionCosts,s}getCharacterIdx(t){return this.pSt.get(t)}getInsertionCost(t){return this.mSt[t]}getDeletionCost(t){return this.vSt[t]}getSubstitutionCost(t,i){const e=Math.min(t,i),s=Math.max(t,i);return this.gSt[e][s]}}t.Alphabet=i;class e{constructor(t,i){if(t.length>e.SSt)throw new Error("Sequences longer than "+e.SSt+" not supported.");this.ESt=i,this.ASt=t.map((t=>this.ESt.getCharacterIdx(t)))}serialize(){return JSON.stringify(this.ASt)}static Deserialize(t,i){const s=new e([],i);return s.ASt=JSON.parse(t),s}distance(t){return e.CSt(this,t)}static CSt(t,i){const s=t.ESt;if(s!==i.ESt)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");const n=t.ASt,r=i.ASt,h=n.length,o=r.length,a=e.wSt;a[0][0]=0;for(let t=0;t<h;++t)a[t+1][0]=a[t][0]+s.getInsertionCost(n[t]);for(let t=0;t<o;++t)a[0][t+1]=a[0][t]+s.getInsertionCost(r[t]);for(let t=0;t<h;++t)for(let i=0;i<o;++i)e.xSt=a[t+1][i]+s.getInsertionCost(r[i]),e.TSt=a[t][i+1]+s.getDeletionCost(n[t]),e.RSt=a[t][i]+s.getSubstitutionCost(n[t],r[i]),a[t+1][i+1]=Math.min(e.xSt,e.TSt,e.RSt);return a[h][o]}}e.SSt=256,e.wSt=[...Array(e.SSt+1)].map((()=>new Array(e.SSt+1))),t.Sequence=e}(bI||(bI={}));class yI{constructor(t=.01){this._E=[],this.ISt=t}serialize(){return JSON.stringify(this)}static Deserialize(t){const i=JSON.parse(t),e=new yI(i.ISt);return e._E=i._E.map((t=>new w(t.U,t.V,t.k))),e}getLength(){return this._E.length*this.ISt}add(t){let i=this._E.length;if(0===i)this._E.push(t.clone());else{const e=()=>this.ISt/w.Distance(this._E[i-1],t);for(let s=e();s<=1;s=e()){const e=this._E[i-1].scale(1-s);t.scaleAndAddToRef(s,e),this._E.push(e),++i}}}resampleAtTargetResolution(t){const i=new yI(this.getLength()/t);return this._E.forEach((t=>{i.add(t)})),i}tokenize(t){const i=[],e=new w;for(let s=2;s<this._E.length;++s)yI.MSt(this._E[s-2],this._E[s-1],this._E[s],e)&&i.push(yI.bSt(e,t));return i}static MSt(t,i,e,s){return i.subtractToRef(t,yI._St),yI._St.normalize(),i.scaleToRef(-1,yI.ySt),yI.ySt.normalize(),!(Math.abs(w.Dot(yI._St,yI.ySt))>.98)&&(w.CrossToRef(yI._St,yI.ySt,yI.NSt),yI.NSt.normalize(),R.LookAtLHToRef(t,i,yI.NSt,yI.PSt),e.subtractToRef(i,yI.DSt),yI.DSt.normalize(),w.TransformNormalToRef(yI.DSt,yI.PSt,s),!0)}static bSt(t,i){yI.LSt=0,yI.OSt=w.Dot(t,i[0]),yI.FSt=yI.OSt;for(let e=1;e<i.length;++e)yI.OSt=w.Dot(t,i[e]),yI.OSt>yI.FSt&&(yI.LSt=e,yI.FSt=yI.OSt);return yI.LSt}}yI._St=new w,yI.ySt=new w,yI.NSt=new w,yI.DSt=new w,yI.PSt=new R;class NI{constructor(){this.BSt=[]}serialize(){return JSON.stringify(this.BSt.map((t=>t.serialize())))}static Deserialize(t,i){const e=new NI;return e.BSt=JSON.parse(t).map((t=>bI.Sequence.Deserialize(t,i))),e}static CreateFromTrajectory(t,i,e){return NI.CreateFromTokenizationPyramid(NI.USt(t,i),e)}static CreateFromTokenizationPyramid(t,i){const e=new NI;return e.BSt=t.map((t=>new bI.Sequence(t,i))),e}static USt(t,i,e=NI.VSt){const s=[];for(let n=e;n>4;n=Math.floor(n/2))s.push(t.resampleAtTargetResolution(n).tokenize(i.chars));return s}distance(t){let i,e=0;for(let s=0;s<this.BSt.length;++s)i=Math.pow(2,s),e+=i*this.BSt[s].distance(t.BSt[s]);return e}}NI.VSt=32;class PI{constructor(t=[]){this.kSt=t,this.GSt=-1,this.zSt=0,this.HSt()}serialize(){const t={};return t.descriptors=this.kSt.map((t=>t.serialize())),t.centroidIdx=this.GSt,t.averageDistance=this.zSt,JSON.stringify(t)}static Deserialize(t,i){const e=JSON.parse(t),s=new PI;return s.kSt=e.descriptors.map((t=>NI.Deserialize(t,i))),s.GSt=e.centroidIdx,s.zSt=e.averageDistance,s}add(t){this.kSt.push(t),this.HSt()}getMatchCost(t){return t.distance(this.kSt[this.GSt])/this.zSt}getMatchMinimumDistance(t){return Math.min(...this.kSt.map((i=>i.distance(t))))}HSt(){let t;this.GSt=-1;const i=this.kSt.map((i=>(t=0,this.kSt.forEach((e=>{t+=i.distance(e)})),t)));for(let t=0;t<i.length;++t)(this.GSt<0||i[t]<i[this.GSt])&&(this.GSt=t);this.zSt=0,this.kSt.forEach((t=>{this.zSt+=t.distance(this.kSt[this.GSt])})),this.kSt.length>0&&(this.zSt=Math.max(this.zSt/this.kSt.length,PI.XSt))}}PI.XSt=1;class DI{constructor(t,i,e){this.Kt=t,F.Log(`[Reflector] Connecting to ws://${i}:${e}`),this.WSt=new WebSocket(`ws://${i}:${e}`),this.WSt.onmessage=t=>{const i=t.data;if(i.startsWith(DI.$St)){const t=i.substr(DI.$St.length);return F.Log(`[Reflector] Received server message: ${t.substr(0,64)}`),void this.YSt(t)}F.Log(`[Reflector] Received client message: ${i.substr(0,64)}`),this.jSt()},this.WSt.onclose=t=>{F.Log(`[Reflector] Disconnected ${t.code} ${t.reason}`)}}close(){this.WSt.close()}YSt(t){if("connected"===t)EI.SerializeAsync(this.Kt).then((t=>{this.WSt.send(`load|${JSON.stringify(t)}`)}))}jSt(){}}DI.$St="$$";class LI{constructor(t){this.KSt=new Float32Array(t),this.qSt=0}get itemLength(){return this.qSt}at(t){return t<0||t>=this.qSt?NaN:this.KSt[t]}subarray(t,i){return t>=i||t<0?new Float32Array(0):(i>this.qSt&&(i=this.qSt),this.KSt.subarray(t,i))}push(t){this.KSt[this.qSt]=t,this.qSt++,this.qSt>=this.KSt.length&&this.QSt()}QSt(){const t=Math.floor(1.5*this.KSt.length),i=new Float32Array(t);i.set(this.KSt),this.KSt=i}}const OI=1800,FI="timestamp",BI="numPoints",UI=/\r/g;class VI{constructor(t,i){this.Kt=t,this.ZSt=()=>{const t=bt.Now-this.JSt,i=this.datasets.ids.length,e=this.datasets.startingIndices.itemLength;let s=0;if(e>0){const t=this.datasets.startingIndices.at(e-1);s=t+this.datasets.data.at(t+VI.NumberOfPointsOffset)+VI.SliceDataOffset}if(this.datasets.startingIndices.push(s),this.datasets.data.push(t),this.datasets.data.push(i),this.datasets.ids.forEach((t=>{const i=this.tEt.get(t);i&&this.datasets.data.push(i.getData())})),this.datasetObservable.hasObservers()){const e=[t,i];for(let t=0;t<i;t++)e.push(this.datasets.data.at(s+VI.SliceDataOffset+t));this.datasetObservable.notifyObservers(e)}},this.datasets={ids:[],data:new LI(OI),startingIndices:new LI(OI)},this.tEt=new Map,this.iEt=new Map,this.eEt=new Set,this.sEt=new h,this.datasetObservable=new h,this.metadataObservable=new h((t=>t.callback(this.iEt,new n(0)))),i&&this.addCollectionStrategies(...i)}static get SliceDataOffset(){return 2}static get NumberOfPointsOffset(){return 1}registerEvent(t,i,e){var s;if(this.tEt.has(t)&&!i)return;this.tEt.has(t)&&i&&(null===(s=this.tEt.get(t))||void 0===s||s.dispose(),this.tEt.delete(t));const n={name:t};return this.eEt.add(t),this.addCollectionStrategies({strategyCallback:i=>{let e=0,s=0;const n=i.onAfterRenderObservable.add((()=>{s=e,e=0})),r=this.sEt.add((i=>{t===i.name&&(void 0!==i.value?e=i.value:e++)}));return{id:t,getData:()=>s,dispose:()=>{i.onAfterRenderObservable.remove(n),this.sEt.remove(r)}}},category:e}),n}sendEvent(t){this.sEt.notifyObservers(t)}nEt(){this.eEt.size!==this.sEt.observers.length&&this.eEt.forEach((t=>{this.registerEvent(t,!0)}))}addCollectionStrategies(...t){for(let{strategyCallback:i,category:e,hidden:s}of t){const t=i(this.Kt);this.tEt.has(t.id)?t.dispose():(this.datasets.ids.push(t.id),e&&(e=e.replace(new RegExp("@","g"),"")),this.iEt.set(t.id,{color:this.rEt(t.id),category:e,hidden:s}),this.tEt.set(t.id,t))}this.metadataObservable.notifyObservers(this.iEt)}rEt(t){let i=0;for(let e=0;e<t.length;e++)i=t.charCodeAt(e)+((i<<5)-i);let e="#";for(let t=0;t<24;t+=8){e+=("0"+(i>>t&255).toString(16)).substr(-2)}return e}getCurrentSlice(){const t=[bt.Now-this.JSt,this.datasets.ids.length];this.datasets.ids.forEach((i=>{const e=this.tEt.get(i);e&&this.datasetObservable.hasObservers()&&t.push(e.getData())})),this.datasetObservable.hasObservers()&&this.datasetObservable.notifyObservers(t)}updateMetadata(t,i,e){const s=this.iEt.get(t);s&&(s[i]=e,this.metadataObservable.notifyObservers(this.iEt))}clear(t){this.datasets.data=new LI(OI),this.datasets.ids.length=0,this.datasets.startingIndices=new LI(OI),this.iEt.clear(),this.tEt.forEach((t=>t.dispose())),this.tEt.clear(),t||this.eEt.clear(),this.hEt=!1}get hasLoadedData(){return this.hEt}loadFromFileData(t,i){const e=t.replace(UI,"").split("\n").map((t=>t.split(",").filter((t=>t.length>0)))).filter((t=>t.length>0)),s=VI.NumberOfPointsOffset;if(e.length<2)return!1;const n={ids:[],data:new LI(OI),startingIndices:new LI(OI)},[r,...h]=e;if(r.length<2||r[0]!==FI||r[s]!==BI)return!1;const o=new Map;for(let t=VI.SliceDataOffset;t<r.length;t++){const[i,e]=r[t].split("@");n.ids.push(i),o.set(i,e)}let a=0;for(const t of h){if(t.length<2)return!1;const i=parseFloat(t[0]),e=parseInt(t[s]);if(isNaN(e)||isNaN(i))return!1;if(n.data.push(i),n.data.push(e),e+VI.SliceDataOffset!==t.length)return!1;for(let i=VI.SliceDataOffset;i<t.length;i++){const e=parseFloat(t[i]);if(isNaN(e))return!1;n.data.push(e)}n.startingIndices.push(a),a+=t.length}if(this.datasets.ids=n.ids,this.datasets.data=n.data,this.datasets.startingIndices=n.startingIndices,i||this.iEt.clear(),this.tEt.forEach((t=>t.dispose())),this.tEt.clear(),!i)for(const t of this.datasets.ids){const i=o.get(t);this.iEt.set(t,{category:i,color:this.rEt(t)})}return this.metadataObservable.notifyObservers(this.iEt),this.hEt=!0,!0}exportDataToCsv(){let t="";t+=`${FI},${BI}`;for(let i=0;i<this.datasets.ids.length;i++)if(t+=`,${this.datasets.ids[i]}`,this.iEt){const e=this.iEt.get(this.datasets.ids[i]);(null==e?void 0:e.category)&&(t+=`@${e.category}`)}t+="\n";for(let i=0;i<this.datasets.startingIndices.itemLength;i++){const e=this.datasets.startingIndices.at(i),s=this.datasets.data.at(e),n=this.datasets.data.at(e+VI.NumberOfPointsOffset);t+=`${s},${n}`;for(let i=0;i<n;i++)t+=`,${this.datasets.data.at(e+VI.SliceDataOffset+i)}`;for(let i=0;i<this.datasets.ids.length-n;i++)t+=",";t+="\n"}const i=`${(new Date).toISOString()}-perfdata.csv`;ki.Download(new Blob([t],{type:"text/csv"}),i)}start(t){t?void 0===this.JSt&&(this.JSt=bt.Now):(this.datasets.data=new LI(OI),this.datasets.startingIndices=new LI(OI),this.JSt=bt.Now),this.Kt.onAfterRenderObservable.add(this.ZSt),this.nEt(),this.tA=!0}stop(){this.Kt.onAfterRenderObservable.removeCallback(this.ZSt),this.tA=!1}get isStarted(){return this.tA}dispose(){this.Kt.onAfterRenderObservable.removeCallback(this.ZSt),this.iEt.clear(),this.tEt.forEach((t=>{t.dispose()})),this.datasetObservable.clear(),this.metadataObservable.clear(),this.tA=!1,this.datasets=null}}ke.prototype.getPerfCollector=function(){return this.dg||(this.dg=new VI(this)),this.dg},h.prototype.runCoroutineAsync=function(t){if(!this.oEt){const t=function(t){const i=new Array,e=new Array,s=new Array,n=t.add((()=>{const t=i.length;for(let n=0;n<t;n++)is(i.shift(),e.shift(),s.shift())}));return{scheduler:(t,n,r)=>{i.push(t),e.push(n),s.push(r)},dispose:()=>{t.remove(n)}}}(this);this.oEt=t.scheduler,this.aEt=t.dispose}return ns(t,this.oEt)},h.prototype.cancelAllCoroutines=function(){this.aEt&&this.aEt(),this.oEt=void 0,this.aEt=void 0};class kI extends xn{constructor(t,i={}){super(t),this.options=i,this.GP=new w(0,0,-1),this.lEt=new R,this.cEt=!1,this.uEt=new w(0,0,0),this.lastNativeXRHitResults=[],this.onHitTestResultObservable=new h,this.fEt=t=>{const i=t.map((t=>{const i=R.FromArray(t.hitMatrix);return this.RN.scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),this.options.worldParentNode&&i.multiplyToRef(this.options.worldParentNode.getWorldMatrix(),i),{xrHitResult:t,transformationMatrix:i}}));this.lastNativeXRHitResults=t,this.onHitTestResultObservable.notifyObservers(i)},this.dEt=t=>{this.cEt&&kI.XRHitTestWithSelectEvent(t,this.RN.referenceSpace)},this.xrNativeFeatureName="hit-test",ki.Warn("A newer version of this plugin is available")}static XRHitTestWithRay(t,i,e,s){return t.requestHitTest(i,e).then((t=>{const i=s||(t=>!!t.hitMatrix);return t.filter(i)}))}static XRHitTestWithSelectEvent(t,i){const e=t.frame.getPose(t.inputSource.targetRaySpace,i);if(!e)return Promise.resolve([]);const s=new XRRay(e.transform);return this.XRHitTestWithRay(t.frame.session,s,i)}attach(){return!!super.attach()&&(this.options.testOnPointerDownOnly&&this.RN.session.addEventListener("select",this.dEt,!1),!0)}detach(){return!!super.detach()&&(this.cEt=!1,this.RN.session.removeEventListener("select",this.dEt),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}PN(t){if(!this.attached||this.options.testOnPointerDownOnly)return;const i=t.getViewerPose(this.RN.referenceSpace);if(!i)return;R.FromArrayToRef(i.transform.matrix,0,this.lEt),w.TransformCoordinatesFromFloatsToRef(0,0,0,this.lEt,this.uEt),w.TransformCoordinatesFromFloatsToRef(0,0,-1,this.lEt,this.GP),this.GP.subtractInPlace(this.uEt),this.GP.normalize();const e=new XRRay({x:this.uEt.x,y:this.uEt.y,z:this.uEt.z,w:0},{x:this.GP.x,y:this.GP.y,z:this.GP.z,w:0});kI.XRHitTestWithRay(this.RN.session,e,this.RN.referenceSpace).then(this.fEt)}}kI.Name=Cn.HIT_TEST,kI.Version=1,wn.AddWebXRFeature(kI.Name,((t,i)=>()=>new kI(t,i)),kI.Version,!1);let GI=0;class zI extends xn{constructor(t,i={}){super(t),this.wb=i,this.pEt=new Set,this.mEt=[],this.vEt=[],this.onAnchorAddedObservable=new h,this.onAnchorRemovedObservable=new h,this.onAnchorUpdatedObservable=new h,this.iN=new w,this.Lk=new T,this.xrNativeFeatureName="anchors"}set referenceSpaceForFrameAnchors(t){this.gEt=t}SEt(t,i){return this.iN.copyFrom(t),this.Lk.copyFrom(i),this.RN.scene.useRightHandedSystem||(this.iN.z*=-1,this.Lk.z*=-1,this.Lk.w*=-1),{position:this.iN,rotationQuaternion:this.Lk}}async addAnchorPointUsingHitTestResultAsync(t,i=new w,e=new T){this.SEt(i,e);const s=new XRRigidTransform({x:this.iN.x,y:this.iN.y,z:this.iN.z},{x:this.Lk.x,y:this.Lk.y,z:this.Lk.z,w:this.Lk.w});if(!t.xrHitResult.createAnchor)throw this.detach(),new Error("Anchors not enabled in this environment/browser");try{const i=await t.xrHitResult.createAnchor(s);return new Promise(((t,e)=>{this.vEt.push({nativeAnchor:i,resolved:!1,submitted:!0,xrTransformation:s,resolve:t,reject:e})}))}catch(t){throw new Error(t)}}async addAnchorAtPositionAndRotationAsync(t,i=new T,e=!1){this.SEt(t,i);const s=new XRRigidTransform({x:this.iN.x,y:this.iN.y,z:this.iN.z},{x:this.Lk.x,y:this.Lk.y,z:this.Lk.z,w:this.Lk.w}),n=e&&this.attached&&this.RN.currentFrame?await this.EEt(s,this.RN.currentFrame):void 0;return new Promise(((t,i)=>{this.vEt.push({nativeAnchor:n,resolved:!1,submitted:!1,xrTransformation:s,resolve:t,reject:i})}))}get anchors(){return this.mEt}detach(){if(!super.detach())return!1;if(!this.wb.doNotRemoveAnchorsOnSessionEnded)for(;this.mEt.length;){const t=this.mEt.pop();if(t){try{t.remove()}catch(t){}this.onAnchorRemovedObservable.notifyObservers(t)}}return!0}dispose(){this.vEt.length=0,super.dispose(),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()}PN(t){if(!this.attached||!t)return;const i=t.trackedAnchors;if(i){const e=this.mEt.filter((t=>!i.has(t.xrAnchor))).map((t=>this.mEt.indexOf(t)));let s=0;e.forEach((t=>{const i=this.mEt.splice(t-s,1)[0];this.onAnchorRemovedObservable.notifyObservers(i),s++})),i.forEach((i=>{if(this.pEt.has(i)){const e=this.AEt(i),s=this.mEt[e];try{this.CEt(i,s,t),s.attachedNode&&(s.attachedNode.rotationQuaternion=s.attachedNode.rotationQuaternion||new T,s.transformationMatrix.decompose(s.attachedNode.scaling,s.attachedNode.rotationQuaternion,s.attachedNode.position)),this.onAnchorUpdatedObservable.notifyObservers(s)}catch(t){ki.Warn("Anchor could not be updated")}}else{const e={id:GI++,xrAnchor:i,remove:()=>i.delete()},s=this.CEt(i,e,t);this.mEt.push(s),this.onAnchorAddedObservable.notifyObservers(s);const n=this.vEt.filter((t=>t.nativeAnchor===i))[0];n&&(n.resolve(s),n.resolved=!0)}})),this.pEt=i}this.vEt.forEach((i=>{i.resolved||i.submitted||(this.EEt(i.xrTransformation,t).then((t=>{i.nativeAnchor=t}),(t=>{i.resolved=!0,i.reject(t)})),i.submitted=!0)}))}AEt(t){for(let i=0;i<this.mEt.length;++i)if(this.mEt[i].xrAnchor===t)return i;return-1}CEt(t,i,e){const s=e.getPose(t.anchorSpace,this.RN.referenceSpace);if(s){const t=i.transformationMatrix||new R;R.FromArrayToRef(s.transform.matrix,0,t),this.RN.scene.useRightHandedSystem||t.toggleModelMatrixHandInPlace(),i.transformationMatrix=t,this.wb.worldParentNode&&t.multiplyToRef(this.wb.worldParentNode.getWorldMatrix(),t)}return i}async EEt(t,i){var e;if(!i.createAnchor)throw this.detach(),new Error("Anchors are not enabled in your browser");try{return i.createAnchor(t,null!==(e=this.gEt)&&void 0!==e?e:this.RN.referenceSpace)}catch(t){throw new Error(t)}}}zI.Name=Cn.ANCHOR_SYSTEM,zI.Version=1,wn.AddWebXRFeature(zI.Name,((t,i)=>()=>new zI(t,i)),zI.Version);let HI=0;class XI extends xn{constructor(t,i={}){super(t),this.wb=i,this.wEt=[],this.ih=!1,this.pEt=new Set,this.onPlaneAddedObservable=new h,this.onPlaneRemovedObservable=new h,this.onPlaneUpdatedObservable=new h,this.xrNativeFeatureName="plane-detection",this.RN.session?this.YN():this.RN.onXRSessionInit.addOnce((()=>{this.YN()}))}detach(){if(!super.detach())return!1;if(!this.wb.doNotRemovePlanesOnSessionEnded)for(;this.wEt.length;){const t=this.wEt.pop();t&&this.onPlaneRemovedObservable.notifyObservers(t)}return!0}dispose(){super.dispose(),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()}isCompatible(){return"undefined"!=typeof XRPlane}PN(t){var i;if(!this.attached||!this.ih||!t)return;const e=t.detectedPlanes||(null===(i=t.worldInformation)||void 0===i?void 0:i.detectedPlanes);if(e){for(let t=0;t<this.wEt.length;t++){const i=this.wEt[t];e.has(i.xrPlane)||(this.wEt.splice(t--,1),this.onPlaneRemovedObservable.notifyObservers(i))}e.forEach((i=>{if(this.pEt.has(i)){if(i.lastChangedTime===this.RN.currentTimestamp){const e=this.xEt(i),s=this.wEt[e];this.TEt(i,s,t),this.onPlaneUpdatedObservable.notifyObservers(s)}}else{const e={id:HI++,xrPlane:i,polygonDefinition:[]},s=this.TEt(i,e,t);this.wEt.push(s),this.onPlaneAddedObservable.notifyObservers(s)}})),this.pEt=e}}YN(){const t=()=>{this.ih=!0,this.wEt.length&&(this.wEt.length=0)};this.RN.isNative&&this.wb.preferredDetectorOptions&&this.RN.session.trySetPreferredPlaneDetectorOptions&&this.RN.session.trySetPreferredPlaneDetectorOptions(this.wb.preferredDetectorOptions),this.RN.session.updateWorldTrackingState?(this.RN.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),t()):t()}TEt(t,i,e){i.polygonDefinition=t.polygon.map((t=>{const i=this.RN.scene.useRightHandedSystem?1:-1;return new w(t.x,t.y,t.z*i)}));const s=e.getPose(t.planeSpace,this.RN.referenceSpace);if(s){const t=i.transformationMatrix||new R;R.FromArrayToRef(s.transform.matrix,0,t),this.RN.scene.useRightHandedSystem||t.toggleModelMatrixHandInPlace(),i.transformationMatrix=t,this.wb.worldParentNode&&t.multiplyToRef(this.wb.worldParentNode.getWorldMatrix(),t)}return i}xEt(t){for(let i=0;i<this.wEt.length;++i)if(this.wEt[i].xrPlane===t)return i;return-1}}XI.Name=Cn.PLANE_DETECTION,XI.Version=1,wn.AddWebXRFeature(XI.Name,((t,i)=>()=>new XI(t,i)),XI.Version);class WI extends xn{constructor(t,i={}){super(t),this.options=i,this.onBackgroundStateChangedObservable=new h}attach(){return this.REt(!1),super.attach()}detach(){return this.REt(!0),super.detach()}dispose(){super.dispose(),this.onBackgroundStateChangedObservable.clear()}PN(t){}REt(t){const i=this.RN.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){const e=i.getMeshByName("BackgroundSkybox");e&&e.setEnabled(t)}if(this.options.environmentHelperRemovalFlags.ground){const e=i.getMeshByName("BackgroundPlane");e&&e.setEnabled(t)}}else{const e=i.getMeshByName("BackgroundHelper");e&&e.setEnabled(t)}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach((i=>i.setEnabled(t))),this.onBackgroundStateChangedObservable.notifyObservers(t)}}WI.Name=Cn.BACKGROUND_REMOVER,WI.Version=1,wn.AddWebXRFeature(WI.Name,((t,i)=>()=>new WI(t,i)),WI.Version,!0);class $I extends xn{constructor(t,i){super(t),this.wb=i,this.I9=t=>{this.M9[t.uniqueId]||(this.RN.scene.isPhysicsEnabled()||F.Warn("physics engine not enabled, skipped. Please add this controller manually."),this.wb.physicsProperties.useControllerMesh&&t.inputSource.gamepad?t.onMotionControllerInitObservable.addOnce((i=>{i.q7?this.IEt(t):i.onModelLoadedObservable.addOnce((()=>{const e=new Rn(i.rootMesh,Rn.MeshImpostor,{mass:0,...this.wb.physicsProperties}),s=t.grip||t.pointer;this.M9[t.uniqueId]={xrController:t,impostor:e,oldPos:s.position.clone(),oldRotation:s.rotationQuaternion.clone()}}))})):this.IEt(t))},this.M9={},this.Jy=!1,this.MEt=0,this.V7=0,this.Lk=new T,this.iN=new w,this.wb.physicsProperties||(this.wb.physicsProperties={})}IEt(t){const i=this.wb.physicsProperties.impostorType||Rn.SphereImpostor,e=this.wb.physicsProperties.impostorSize||.1,s=Qc("impostor-mesh-"+t.uniqueId,{diameterX:"number"==typeof e?e:e.width,diameterY:"number"==typeof e?e:e.height,diameterZ:"number"==typeof e?e:e.depth});s.isVisible=this.Jy,s.isPickable=!1,s.rotationQuaternion=new T;const n=t.grip||t.pointer;s.position.copyFrom(n.position),s.rotationQuaternion.copyFrom(n.rotationQuaternion);const r=new Rn(s,i,{mass:0,...this.wb.physicsProperties});this.M9[t.uniqueId]={xrController:t,impostor:r,impostorMesh:s}}bEt(){this.Jy=!0,Object.keys(this.M9).forEach((t=>{const i=this.M9[t];i.impostorMesh&&(i.impostorMesh.isVisible=!0)}))}addController(t){this.I9(t)}attach(){if(!super.attach())return!1;if(!this.wb.xrInput)return!0;if(this.wb.xrInput.controllers.forEach(this.I9),this.NN(this.wb.xrInput.onControllerAddedObservable,this.I9),this.NN(this.wb.xrInput.onControllerRemovedObservable,(t=>{this.B9(t.uniqueId)})),this.wb.enableHeadsetImpostor){const t=this.wb.headsetImpostorParams||{impostorType:Rn.SphereImpostor,restitution:.8,impostorSize:.3},i=t.impostorSize||.3;this._Et=Qc("headset-mesh",{diameterX:"number"==typeof i?i:i.width,diameterY:"number"==typeof i?i:i.height,diameterZ:"number"==typeof i?i:i.depth}),this._Et.rotationQuaternion=new T,this._Et.isVisible=!1,this.yEt=new Rn(this._Et,t.impostorType,{mass:0,...t})}return!0}detach(){return!!super.detach()&&(Object.keys(this.M9).forEach((t=>{this.B9(t)})),this._Et&&this._Et.dispose(),!0)}getHeadsetImpostor(){return this.yEt}getImpostorForController(t){const i="string"==typeof t?t:t.uniqueId;return this.M9[i]?this.M9[i].impostor:null}setPhysicsProperties(t){this.wb.physicsProperties={...this.wb.physicsProperties,...t}}PN(t){var i,e;if(this.MEt=this.RN.currentTimestamp-this.V7,this.V7=this.RN.currentTimestamp,this._Et&&this.yEt){if(this._Et.position.copyFrom(this.wb.xrInput.xrCamera.globalPosition),this._Et.rotationQuaternion.copyFrom(this.wb.xrInput.xrCamera.absoluteRotation),null===(i=this.wb.xrInput.xrCamera.P7)||void 0===i?void 0:i.linearVelocity){const t=this.wb.xrInput.xrCamera.P7.linearVelocity;this.iN.set(t.x,t.y,t.z),this.yEt.setLinearVelocity(this.iN)}if(null===(e=this.wb.xrInput.xrCamera.P7)||void 0===e?void 0:e.angularVelocity){const t=this.wb.xrInput.xrCamera.P7.angularVelocity;this.iN.set(t.x,t.y,t.z),this.yEt.setAngularVelocity(this.iN)}}Object.keys(this.M9).forEach((t=>{var i,e;const s=this.M9[t],n=s.xrController.grip||s.xrController.pointer,r=s.oldPos||s.impostorMesh.position;if(null===(i=s.xrController.A9)||void 0===i?void 0:i.linearVelocity){const t=s.xrController.A9.linearVelocity;this.iN.set(t.x,t.y,t.z),s.impostor.setLinearVelocity(this.iN)}else n.position.subtractToRef(r,this.iN),this.iN.scaleInPlace(1e3/this.MEt),s.impostor.setLinearVelocity(this.iN);r.copyFrom(n.position),this.Jy&&console.log(this.iN,"linear");const h=s.oldRotation||s.impostorMesh.rotationQuaternion;if(null===(e=s.xrController.A9)||void 0===e?void 0:e.angularVelocity){const t=s.xrController.A9.angularVelocity;this.iN.set(t.x,t.y,t.z),s.impostor.setAngularVelocity(this.iN)}else if(!h.equalsWithEpsilon(n.rotationQuaternion)){h.conjugateInPlace().multiplyToRef(n.rotationQuaternion,this.Lk);const t=Math.sqrt(this.Lk.x*this.Lk.x+this.Lk.y*this.Lk.y+this.Lk.z*this.Lk.z);if(this.iN.set(this.Lk.x,this.Lk.y,this.Lk.z),t<.001)this.iN.scaleInPlace(2);else{const i=2*Math.atan2(t,this.Lk.w);this.iN.scaleInPlace(i/(t*(this.MEt/1e3)))}s.impostor.setAngularVelocity(this.iN)}h.copyFrom(n.rotationQuaternion),this.Jy&&console.log(this.iN,this.Lk,"angular")}))}B9(t){const i=this.M9[t];i&&(i.impostorMesh&&i.impostorMesh.dispose(),delete this.M9[t])}}$I.Name=Cn.PHYSICS_CONTROLLERS,$I.Version=1,wn.AddWebXRFeature($I.Name,((t,i)=>()=>new $I(t,i)),$I.Version,!0);class YI extends xn{constructor(t,i={}){super(t),this.options=i,this.NEt=new R,this.PEt=new w,this.GN=new T,this.DEt=t=>{if(!t)return;const i=new XRRay(this.options.offsetRay||{}),e={space:this.options.useReferenceSpace?t:this.RN.viewerReferenceSpace,offsetRay:i};this.options.entityTypes&&(e.entityTypes=this.options.entityTypes),e.space?this.RN.session.requestHitTestSource(e).then((t=>{this.LEt&&this.LEt.cancel(),this.LEt=t})):ki.Warn("waiting for viewer reference space to initialize")},this.autoCloneTransformation=!1,this.onHitTestResultObservable=new h,this.paused=!1,this.xrNativeFeatureName="hit-test",ki.Warn("Hit test is an experimental and unstable feature.")}attach(){if(!super.attach())return!1;if(!this.RN.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this.RN.referenceSpace&&this.DEt(this.RN.referenceSpace),this.RN.onXRReferenceSpaceChanged.add(this.DEt)),this.options.enableTransientHitTest){const t=new XRRay(this.options.transientOffsetRay||{});this.RN.session.requestHitTestSourceForTransientInput({profile:this.options.transientHitTestProfile||"generic-touchscreen",offsetRay:t,entityTypes:this.options.entityTypes}).then((t=>{this.OEt=t}))}return!0}detach(){return!!super.detach()&&(this.LEt&&(this.LEt.cancel(),this.LEt=null),this.RN.onXRReferenceSpaceChanged.removeCallback(this.DEt),this.OEt&&(this.OEt.cancel(),this.OEt=null),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}PN(t){if(this.attached&&!this.paused){if(this.LEt){const i=t.getHitTestResults(this.LEt);this.FEt(i)}if(this.OEt){t.getHitTestResultsForTransientInput(this.OEt).forEach((t=>{this.FEt(t.results,t.inputSource)}))}}}FEt(t,i){const e=[];t.forEach((t=>{const s=t.getPose(this.RN.referenceSpace);if(!s)return;const n=s.transform.position,r=s.transform.orientation;this.PEt.set(n.x,n.y,n.z),this.GN.set(r.x,r.y,r.z,r.w),R.FromFloat32ArrayToRefScaled(s.transform.matrix,0,1,this.NEt),this.RN.scene.useRightHandedSystem||(this.PEt.z*=-1,this.GN.z*=-1,this.GN.w*=-1,this.NEt.toggleModelMatrixHandInPlace());const h={position:this.autoCloneTransformation?this.PEt.clone():this.PEt,rotationQuaternion:this.autoCloneTransformation?this.GN.clone():this.GN,transformationMatrix:this.autoCloneTransformation?this.NEt.clone():this.NEt,inputSource:i,isTransient:!!i,xrHitResult:t};e.push(h)})),this.onHitTestResultObservable.notifyObservers(e)}}YI.Name=Cn.HIT_TEST,YI.Version=2,wn.AddWebXRFeature(YI.Name,((t,i)=>()=>new YI(t,i)),YI.Version,!1);class jI extends xn{constructor(t){super(t),this.ih=!1,this.BEt=[],this.onFeaturePointsAddedObservable=new h,this.onFeaturePointsUpdatedObservable=new h,this.xrNativeFeatureName="bjsfeature-points",this.RN.session?this.YN():this.RN.onXRSessionInit.addOnce((()=>{this.YN()}))}get featurePointCloud(){return this.BEt}detach(){return!!super.detach()&&(this.featurePointCloud.length=0,!0)}dispose(){super.dispose(),this.BEt.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()}PN(t){if(!this.attached||!this.ih||!t)return;const i=t.featurePointCloud;if(i&&0!==i.length){if(i.length%5!=0)throw new Error("Received malformed feature point cloud of length: "+i.length);const t=i.length/5,e=new Array,s=new Array;for(let n=0;n<t;n++){const t=5*n,r=i[t+4];this.BEt[r]?e.push(r):(this.BEt[r]={position:new w,confidenceValue:0},s.push(r)),this.BEt[r].position.x=i[t],this.BEt[r].position.y=i[t+1],this.BEt[r].position.z=i[t+2],this.BEt[r].confidenceValue=i[t+3]}s.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(s),e.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(e)}}YN(){this.RN.session.trySetFeaturePointCloudEnabled&&this.RN.session.trySetFeaturePointCloudEnabled(!0)&&(this.ih=!0)}}jI.Name=Cn.FEATURE_POINTS,jI.Version=1,wn.AddWebXRFeature(jI.Name,(t=>()=>new jI(t)),jI.Version);let KI=0;class qI extends xn{constructor(t,i={}){super(t),this.wb=i,this.UEt=new Map,this.onMeshAddedObservable=new h,this.onMeshRemovedObservable=new h,this.onMeshUpdatedObservable=new h,this.xrNativeFeatureName="mesh-detection",this.RN.session?this.YN():this.RN.onXRSessionInit.addOnce((()=>{this.YN()}))}detach(){return!!super.detach()&&(this.RN.isNative&&this.RN.session.trySetMeshDetectorEnabled&&this.RN.session.trySetMeshDetectorEnabled(!1),this.wb.doNotRemoveMeshesOnSessionEnded||(this.UEt.forEach((t=>{this.onMeshRemovedObservable.notifyObservers(t)})),this.UEt.clear()),!0)}dispose(){super.dispose(),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()}PN(t){var i;try{if(!this.attached||!t)return;const e=null===(i=t.worldInformation)||void 0===i?void 0:i.detectedMeshes;if(e){const i=new Set;this.UEt.forEach(((t,s)=>{e.has(s)||i.add(s)})),i.forEach((t=>{const i=this.UEt.get(t);i&&(this.onMeshRemovedObservable.notifyObservers(i),this.UEt.delete(t))})),e.forEach((i=>{if(this.UEt.has(i)){if(i.lastChangedTime===this.RN.currentTimestamp){const e=this.UEt.get(i);e&&(this.VEt(i,e,t),this.onMeshUpdatedObservable.notifyObservers(e))}}else{const e={id:KI++,xrMesh:i},s=this.VEt(i,e,t);this.UEt.set(i,s),this.onMeshAddedObservable.notifyObservers(s)}}))}}catch(t){console.log(t.stack)}}YN(){this.RN.isNative&&(this.RN.session.trySetMeshDetectorEnabled&&this.RN.session.trySetMeshDetectorEnabled(!0),this.wb.preferredDetectorOptions&&this.RN.session.trySetPreferredMeshDetectorOptions&&this.RN.session.trySetPreferredMeshDetectorOptions(this.wb.preferredDetectorOptions))}VEt(t,i,e){if(i.xrMesh=t,i.worldParentNode=this.wb.worldParentNode,this.wb.convertCoordinateSystems){if(this.RN.scene.useRightHandedSystem)i.positions=t.positions,i.normals=t.normals;else{i.positions=new Float32Array(t.positions.length);for(let e=0;e<t.positions.length;e+=3)i.positions[e]=t.positions[e],i.positions[e+1]=t.positions[e+1],i.positions[e+2]=-1*t.positions[e+2];if(t.normals){i.normals=new Float32Array(t.normals.length);for(let e=0;e<t.normals.length;e+=3)i.normals[e]=t.normals[e],i.normals[e+1]=t.normals[e+1],i.normals[e+2]=-1*t.normals[e+2]}}i.indices=t.indices;const s=e.getPose(t.meshSpace,this.RN.referenceSpace);if(s){const t=i.transformationMatrix||new R;R.FromArrayToRef(s.transform.matrix,0,t),this.RN.scene.useRightHandedSystem||t.toggleModelMatrixHandInPlace(),i.transformationMatrix=t,this.wb.worldParentNode&&t.multiplyToRef(this.wb.worldParentNode.getWorldMatrix(),t)}}return i}}var QI;qI.Name=Cn.MESH_DETECTION,qI.Version=1,wn.AddWebXRFeature(qI.Name,((t,i)=>()=>new qI(t,i)),qI.Version,!1),function(t){t[t.NotReceived=0]="NotReceived",t[t.Waiting=1]="Waiting",t[t.Received=2]="Received"}(QI||(QI={}));class ZI extends xn{constructor(t,i){super(t),this.options=i,this.onUntrackableImageFoundObservable=new h,this.onTrackableImageFoundObservable=new h,this.onTrackedImageUpdatedObservable=new h,this.kEt=QI.NotReceived,this.GEt=[],this.xrNativeFeatureName="image-tracking"}attach(){return super.attach()}detach(){return super.detach()}getTrackedImageById(t){return this.GEt[t]||null}dispose(){super.dispose(),this.GEt.forEach((t=>{t.originalBitmap.close()})),this.GEt.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()}async getXRSessionInitExtension(){if(!this.options.images||!this.options.images.length)return{};const t=this.options.images.map((t=>"string"==typeof t.src?this.RN.scene.getEngine().Fw(t.src):Promise.resolve(t.src)));try{const i=await Promise.all(t);return this.zEt=i.map(((t,i)=>({image:t,widthInMeters:this.options.images[i].estimatedRealWorldWidth}))),{trackedImages:this.zEt}}catch(t){return ki.Error("Error loading images for tracking, WebXRImageTracking disabled for this session."),{}}}PN(t){if(!t.getImageTrackingResults||this.kEt===QI.Waiting)return;if(this.kEt===QI.NotReceived)return void this.HEt();const i=t.getImageTrackingResults();for(const e of i){let i=!1;const s=e.index,n=this.GEt[s];if(!n)continue;n.xrTrackingResult=e,n.realWorldWidth!==e.measuredWidthInMeters&&(n.realWorldWidth=e.measuredWidthInMeters,i=!0);const r=t.getPose(e.imageSpace,this.RN.referenceSpace);if(r){const t=n.transformationMatrix;R.FromArrayToRef(r.transform.matrix,0,t),this.RN.scene.useRightHandedSystem||t.toggleModelMatrixHandInPlace(),i=!0}const h="emulated"===e.trackingState;n.emulated!==h&&(n.emulated=h,i=!0),i&&this.onTrackedImageUpdatedObservable.notifyObservers(n)}}async HEt(){if(!this.RN.session.getTrackedImageScores||this.kEt!==QI.NotReceived)return;this.kEt=QI.Waiting;const t=await this.RN.session.getTrackedImageScores();if(t&&0!==t.length){for(let i=0;i<t.length;++i)if("untrackable"==t[i])this.onUntrackableImageFoundObservable.notifyObservers(i);else{const t=this.zEt[i].image,e={id:i,originalBitmap:t,transformationMatrix:new R,ratio:t.width/t.height};this.GEt[i]=e,this.onTrackableImageFoundObservable.notifyObservers(e)}this.kEt=t.length>0?QI.Received:QI.NotReceived}else this.kEt=QI.NotReceived}}ZI.Name=Cn.IMAGE_TRACKING,ZI.Version=1,wn.AddWebXRFeature(ZI.Name,((t,i)=>()=>new ZI(t,i)),ZI.Version,!1);class JI extends xn{constructor(t,i){super(t),this.options=i,this.XEt=null,this.WEt=null,this.tV=null,this.xrNativeFeatureName="dom-overlay",ki.Warn("dom-overlay is an experimental and unstable feature.")}attach(){return!!super.attach()&&(!(!this.RN.session.domOverlayState||null===this.RN.session.domOverlayState.type)&&(this.XEt=this.RN.session.domOverlayState.type,null!==this.tV&&!0===this.options.supressXRSelectEvents&&(this.WEt=t=>{t.preventDefault()},this.tV.addEventListener("beforexrselect",this.WEt)),!0))}get domOverlayType(){return this.XEt}dispose(){super.dispose(),null!==this.tV&&this.WEt&&this.tV.removeEventListener("beforexrselect",this.WEt)}PN(t){}async getXRSessionInitExtension(){if(void 0===this.options.element)return ki.Warn('"element" option must be provided to attach xr-dom-overlay feature.'),{};if("string"==typeof this.options.element){const t=document.querySelector(this.options.element);if(null===t)return ki.Warn(`element not found '${this.options.element}' (not requesting xr-dom-overlay)`),{};this.tV=t}else this.tV=this.options.element;return{domOverlay:{root:this.tV}}}}JI.Name=Cn.DOM_OVERLAY,JI.Version=1,wn.AddWebXRFeature(JI.Name,((t,i)=>()=>new JI(t,i)),JI.Version,!1);class tM extends xn{constructor(t,i){var e,s,n,r,h,o;super(t),this.M9={},this.$Et=[],this.YEt=null,this.jEt=R.Identity(),this.KEt=new w,this.qEt=new w,this.I9=t=>{if(this.M9[t.uniqueId])return;this.M9[t.uniqueId]={xrController:t,registeredComponents:[]};const i=this.M9[t.uniqueId];if("tracked-pointer"===i.xrController.inputSource.targetRayMode&&i.xrController.inputSource.gamepad){const e=()=>{if(t.motionController)for(const e of this.$Et){let s=null;if(e.allowedComponentTypes)for(const i of e.allowedComponentTypes){const e=t.motionController.getComponentOfType(i);if(null!==e){s=e;break}}if(e.mainComponentOnly){const i=t.motionController.getMainComponent();if(null===i)continue;s=i}if("function"==typeof e.componentSelectionPredicate&&(s=e.componentSelectionPredicate(t)),s&&e.forceHandedness&&t.inputSource.handedness!==e.forceHandedness)continue;if(null===s)continue;const n={registrationConfiguration:e,component:s};i.registeredComponents.push(n),"axisChangedHandler"in e&&(n.onAxisChangedObserver=s.onAxisValueChangedObservable.add((t=>{e.axisChangedHandler(t,this.QEt,this.ZEt,this.JEt)}))),"buttonChangedhandler"in e&&(n.onButtonChangedObserver=s.onButtonStateChangedObservable.add((()=>{s.changes.pressed&&e.buttonChangedhandler(s.changes.pressed,this.QEt,this.ZEt,this.JEt)})))}};t.motionController?e():t.onMotionControllerInitObservable.addOnce((()=>{e()}))}},i&&void 0!==i.xrInput?(Array.isArray(i.customRegistrationConfigurations)?this.$Et=i.customRegistrationConfigurations:this.$Et=tM.REGISTRATIONS.default,this.ZEt={movementEnabled:i.movementEnabled||!0,movementOrientationFollowsViewerPose:null===(e=i.movementOrientationFollowsViewerPose)||void 0===e||e,movementSpeed:null!==(s=i.movementSpeed)&&void 0!==s?s:1,movementThreshold:null!==(n=i.movementThreshold)&&void 0!==n?n:.25,rotationEnabled:null===(r=i.rotationEnabled)||void 0===r||r,rotationSpeed:null!==(h=i.rotationSpeed)&&void 0!==h?h:1,rotationThreshold:null!==(o=i.rotationThreshold)&&void 0!==o?o:.25},this.QEt={moveX:0,moveY:0,rotateX:0,rotateY:0},this.JEt=i.xrInput):ki.Error('WebXRControllerMovement feature requires "xrInput" option.')}get movementDirection(){return this.YEt}get movementEnabled(){return this.ZEt.movementEnabled}set movementEnabled(t){this.ZEt.movementEnabled=t}get movementOrientationFollowsViewerPose(){return this.ZEt.movementOrientationFollowsViewerPose}set movementOrientationFollowsViewerPose(t){this.ZEt.movementOrientationFollowsViewerPose=t}get movementSpeed(){return this.ZEt.movementSpeed}set movementSpeed(t){this.ZEt.movementSpeed=t}get movementThreshold(){return this.ZEt.movementThreshold}set movementThreshold(t){this.ZEt.movementThreshold=t}get rotationEnabled(){return this.ZEt.rotationEnabled}set rotationEnabled(t){this.ZEt.rotationEnabled=t}get rotationSpeed(){return this.ZEt.rotationSpeed}set rotationSpeed(t){this.ZEt.rotationSpeed=t}get rotationThreshold(){return this.ZEt.rotationThreshold}set rotationThreshold(t){this.ZEt.rotationThreshold=t}attach(){return!!super.attach()&&(this.JEt.controllers.forEach(this.I9),this.NN(this.JEt.onControllerAddedObservable,this.I9),this.NN(this.JEt.onControllerRemovedObservable,(t=>{this.B9(t.uniqueId)})),!0)}detach(){return!!super.detach()&&(Object.keys(this.M9).forEach((t=>{this.B9(t)})),this.M9={},!0)}PN(t){if(this.attach){if(null===this.YEt&&(this.YEt=this.JEt.xrCamera.rotationQuaternion.clone()),0!==this.QEt.rotateX&&this.ZEt.rotationEnabled){const t=.001*this.RN.scene.getEngine().getDeltaTime()*this.ZEt.rotationSpeed*this.QEt.rotateX*(this.RN.scene.useRightHandedSystem?-1:1);!0===this.ZEt.movementOrientationFollowsViewerPose?(this.JEt.xrCamera.cameraRotation.y+=t,this.YEt=this.JEt.xrCamera.rotationQuaternion.multiply(T.RotationYawPitchRoll(t,0,0))):this.YEt.multiplyInPlace(T.RotationYawPitchRoll(3*t,0,0))}else!0===this.ZEt.movementOrientationFollowsViewerPose&&this.YEt.copyFrom(this.JEt.xrCamera.rotationQuaternion);0===this.QEt.moveX&&0===this.QEt.moveY||!this.ZEt.movementEnabled||(R.FromQuaternionToRef(this.YEt,this.jEt),this.KEt.set(this.QEt.moveX,0,this.QEt.moveY*(this.RN.scene.useRightHandedSystem?1:-1)),w.TransformCoordinatesToRef(this.KEt,this.jEt,this.qEt),this.qEt.scaleInPlace(this.JEt.xrCamera.jU()*this.ZEt.movementSpeed),this.JEt.xrCamera.cameraDirection.addInPlace(this.qEt))}}B9(t){const i=this.M9[t];if(i){for(const t of i.registeredComponents)t.onAxisChangedObserver&&t.component.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.component.onButtonStateChangedObservable.remove(t.onButtonChangedObserver);delete this.M9[t]}}}tM.Name=Cn.MOVEMENT,tM.REGISTRATIONS={default:[{allowedComponentTypes:[jg.THUMBSTICK_TYPE,jg.TOUCHPAD_TYPE],forceHandedness:"left",axisChangedHandler:(t,i,e)=>{i.rotateX=Math.abs(t.x)>e.rotationThreshold?t.x:0,i.rotateY=Math.abs(t.y)>e.rotationThreshold?t.y:0}},{allowedComponentTypes:[jg.THUMBSTICK_TYPE,jg.TOUCHPAD_TYPE],forceHandedness:"right",axisChangedHandler:(t,i,e)=>{i.moveX=Math.abs(t.x)>e.movementThreshold?t.x:0,i.moveY=Math.abs(t.y)>e.movementThreshold?t.y:0}}]},tM.Version=1,wn.AddWebXRFeature(tM.Name,((t,i)=>()=>new tM(t,i)),tM.Version,!0);class iM extends xn{constructor(t,i){super(t),this.options=i,this.tAt=null,this.iAt=null,this.eAt=null,this.sAt=null,this.nAt=null,this.tet=w.Up().negateInPlace(),this.rAt=_.White(),this.Ait=1,this.hAt=new Nu,this.oAt=Date.now(),this.aAt=Date.now(),this.lAt=16,this.directionalLight=null,this.onReflectionCubeMapUpdatedObservable=new h,this.cAt=()=>{var t;if(!this.sAt)return;if(this.options.cubeMapPollInterval){const t=Date.now();if(t-this.oAt<this.options.cubeMapPollInterval)return;this.oAt=t}const i=this.uAt().getReflectionCubeMap(this.sAt);if(i&&this.iAt){if(this.iAt.Lb)null===(t=this.iAt.Lb.Er)||void 0===t||t.set(i),this.iAt.Lb.getEngine().resetTextureCache();else{const t=new ai(this.RN.scene.getEngine(),oi.Unknown);t.isCube=!0,t.invertY=!1,t.ur="srgba8"===this.options.reflectionFormat,t.format=5,t.generateMipMaps=!0,t.type="srgba8"!==this.options.reflectionFormat?2:0,t.samplingMode=3,t.width=this.lAt,t.height=this.lAt,t.Vn=1,t.kn=1,t.Er=new mi(i,this.fAt()),this.iAt.Lb=t}this.iAt.Lb.isReady=!0,this.RN.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this.iAt)}},this.xrNativeFeatureName="light-estimation",this.options.createDirectionalLightSource&&(this.directionalLight=new em("light estimation directional",this.tet,this.RN.scene),this.directionalLight.position=new w(0,8,0),this.directionalLight.intensity=0,this.directionalLight.falloffType=Oe.FALLOFF_GLTF),ki.Warn("light-estimation is an experimental and unstable feature.")}get reflectionCubeMapTexture(){return this.iAt}get xrLightingEstimate(){return this.eAt?{lightColor:this.rAt,lightDirection:this.tet,lightIntensity:this.Ait,sphericalHarmonics:this.hAt}:this.eAt}fAt(){return null===this.tAt&&(this.tAt=this.RN.scene.getEngine().lo),this.tAt}uAt(){if(null===this.nAt){const t=this.fAt();this.nAt=new XRWebGLBinding(this.RN.session,t)}return this.nAt}attach(){var t;if(!super.attach())return!1;const i=null!==(t=this.options.reflectionFormat)&&void 0!==t?t:this.RN.session.preferredReflectionFormat||"srgba8";return this.options.reflectionFormat=i,this.RN.session.requestLightProbe({reflectionFormat:i}).then((t=>{this.sAt=t,this.options.disableCubeMapReflection||(this.iAt||(this.iAt=new nn(this.RN.scene),this.iAt.Xb=!0,this.iAt.coordinatesMode=3,this.options.setSceneEnvironmentTexture&&(this.RN.scene.environmentTexture=this.iAt)),this.sAt.addEventListener("reflectionchange",this.cAt))})),!0}detach(){const t=super.detach();return null===this.sAt||this.options.disableCubeMapReflection||(this.sAt.removeEventListener("reflectionchange",this.cAt),this.sAt=null),this.tAt=null,this.eAt=null,this.nAt=null,t}dispose(){super.dispose(),this.onReflectionCubeMapUpdatedObservable.clear(),this.directionalLight&&(this.directionalLight.dispose(),this.directionalLight=null),null!==this.iAt&&(this.iAt.Lb&&this.iAt.Lb.dispose(),this.iAt.dispose(),this.iAt=null)}PN(t){var i;if(null!==this.sAt){if(this.options.lightEstimationPollInterval){const t=Date.now();if(t-this.aAt<this.options.lightEstimationPollInterval)return;this.aAt=t}if(this.eAt=t.getLightEstimate(this.sAt),this.eAt){this.Ait=Math.max(1,this.eAt.primaryLightIntensity.x,this.eAt.primaryLightIntensity.y,this.eAt.primaryLightIntensity.z);const t=this.RN.scene.useRightHandedSystem?1:-1;this.options.disableVectorReuse&&(this.tet=new w,this.rAt=new _,this.directionalLight&&(this.directionalLight.direction=this.tet,this.directionalLight.diffuse=this.rAt)),this.tet.copyFromFloats(this.eAt.primaryLightDirection.x,this.eAt.primaryLightDirection.y,this.eAt.primaryLightDirection.z*t),this.rAt.copyFromFloats(this.eAt.primaryLightIntensity.x/this.Ait,this.eAt.primaryLightIntensity.y/this.Ait,this.eAt.primaryLightIntensity.z/this.Ait),this.hAt.updateFromFloatsArray(this.eAt.sphericalHarmonicsCoefficients),this.iAt&&!this.options.disableSphericalPolynomial&&(this.iAt.sphericalPolynomial=this.iAt.sphericalPolynomial||new Pu,null===(i=this.iAt.sphericalPolynomial)||void 0===i||i.updateFromHarmonics(this.hAt)),this.tet.negateInPlace(),this.directionalLight&&(this.directionalLight.direction.copyFrom(this.tet),this.directionalLight.intensity=Math.min(this.Ait,1),this.directionalLight.diffuse.copyFrom(this.rAt))}}}}iM.Name=Cn.LIGHT_ESTIMATION,iM.Version=1,wn.AddWebXRFeature(iM.Name,((t,i)=>()=>new iM(t,i)),iM.Version,!1);class eM extends xn{constructor(t){super(t),this.onEyeTrackingStartedObservable=new h,this.onEyeTrackingEndedObservable=new h,this.onEyeTrackingFrameUpdateObservable=new h,this.dAt=t=>{this.pAt=t.gazeSpace,this.mAt=new vn(w.Zero(),w.Forward()),this.onEyeTrackingStartedObservable.notifyObservers(this.mAt)},this.vAt=()=>{this.pAt=null,this.mAt=null,this.onEyeTrackingEndedObservable.notifyObservers()},this.xrNativeFeatureName="eye-tracking",this.RN.session?this.YN():this.RN.onXRSessionInit.addOnce((()=>{this.YN()}))}dispose(){super.dispose(),this.RN.session.removeEventListener("eyetrackingstart",this.dAt),this.RN.session.removeEventListener("eyetrackingend",this.vAt),this.onEyeTrackingStartedObservable.clear(),this.onEyeTrackingEndedObservable.clear(),this.onEyeTrackingFrameUpdateObservable.clear()}get isEyeGazeValid(){return!!this.mAt}getEyeGaze(){return this.mAt}PN(t){if(this.attached&&t&&this.pAt&&this.mAt){const i=t.getPose(this.pAt,this.RN.referenceSpace);if(i){this.mAt.origin.set(i.transform.position.x,i.transform.position.y,i.transform.position.z);const t=i.transform.orientation;M.Quaternion[0].set(t.x,t.y,t.z,t.w),this.RN.scene.useRightHandedSystem?w.RightHandedForwardReadOnly.rotateByQuaternionToRef(M.Quaternion[0],this.mAt.direction):(this.mAt.origin.z*=-1,M.Quaternion[0].z*=-1,M.Quaternion[0].w*=-1,w.LeftHandedForwardReadOnly.rotateByQuaternionToRef(M.Quaternion[0],this.mAt.direction)),this.onEyeTrackingFrameUpdateObservable.notifyObservers(this.mAt)}}}YN(){this.RN.isNative&&(this.RN.session.addEventListener("eyetrackingstart",this.dAt),this.RN.session.addEventListener("eyetrackingend",this.vAt))}}eM.Name=Cn.EYE_TRACKING,eM.Version=1,wn.AddWebXRFeature(eM.Name,(t=>()=>new eM(t)),eM.Version,!1);class sM{constructor(t,i){this.dw=[],this.Aq=0;for(let e=0;e<t;++e)this.dw.push(i?i():C.Zero())}get length(){return this.dw.length}push(t,i){this.Aq=(this.Aq+this.dw.length-1)%this.dw.length,this.at(0).copyFromFloats(t,i)}at(t){if(t>=this.dw.length)throw new Error("Index out of bounds");return this.dw[(this.Aq+t)%this.dw.length]}}class nM{constructor(){this.dw=new sM(20),this.gAt=0,this.onFirstStepDetected=new h}update(t,i,e,s){this.dw.push(t,i);const n=this.dw.at(0);if(this.gAt*=this.SAt,this.gAt+=C.Distance(n,this.dw.at(1)),this.gAt>this.EAt)return;let r;for(r=this.AAt;r<this.dw.length&&!(C.DistanceSquared(n,this.dw.at(r))<this.CAt);++r);if(r===this.dw.length)return;let h=-1,o=0;for(let t,i=1;i<r;++i)t=C.DistanceSquared(n,this.dw.at(i)),t>h&&(o=i,h=t);if(h<this.wAt)return;const a=this.dw.at(o),l=a.subtract(n);l.normalize();const c=M.Vector2[0];let u,f,d=0;for(let t=1;t<r;++t)f=this.dw.at(t),f.subtractToRef(n,c),u=C.Dot(l,c),d+=c.lengthSquared()-u*u;if(d>r*this.xAt)return;const p=M.Vector3[0];p.set(e,s,0);const m=M.Vector3[1];m.set(l.x,l.y,0);const v=w.Cross(p,m).z>0,g=n.clone(),S=n.clone();a.subtractToRef(n,l),v?(l.scaleAndAddToRef(this.TAt,g),l.scaleAndAddToRef(this.RAt,S)):(l.scaleAndAddToRef(this.RAt,g),l.scaleAndAddToRef(this.TAt,S)),this.onFirstStepDetected.notifyObservers({leftApex:g,rightApex:S,currentPosition:n,currentStepDirection:v?"right":"left"})}reset(){for(let t=0;t<this.dw.length;++t)this.dw.at(t).copyFromFloats(0,0)}get AAt(){return Math.floor(this.dw.length/3)}get CAt(){return 9e-4}get wAt(){return.0081}get xAt(){return 9e-4}get TAt(){return.8}get RAt(){return-1.6}get SAt(){return.93}get EAt(){return.4}}class rM{constructor(t,i,e,s){this.IAt=new C,this.MAt=new C,this.bAt=new C,this._At=new C,this.yAt=-1,this.Tx=new C,this.NAt=!1,this.PAt=-1,this.DAt=-1,this.LAt=new C,this.OAt=0,this.onMovement=new h,this.onFootfall=new h,this.HL(t,i,e,"left"===s)}HL(t,i,e,s){this.IAt.copyFrom(t),this.MAt.copyFrom(i),this.NAt=s,this.NAt?(this.IAt.subtractToRef(this.MAt,this._At),this.Tx.copyFromFloats(-this._At.y,this._At.x)):(this.MAt.subtractToRef(this.IAt,this._At),this.Tx.copyFromFloats(this._At.y,-this._At.x)),this.yAt=this._At.length(),this.Tx.scaleInPlace(1/this.yAt),this.FAt(e.x,e.y),this.DAt=this.PAt,this.LAt.copyFrom(e),this.OAt=1}FAt(t,i){this.bAt.copyFromFloats(t,i),this.NAt?this.bAt.subtractInPlace(this.MAt):this.bAt.subtractInPlace(this.IAt);const e=this.PAt,s=C.Dot(this.bAt,this._At);this.PAt=s/(this.yAt*this.yAt);const n=this.bAt.lengthSquared()-s/this.yAt*(s/this.yAt);this.OAt*=.92-100*Math.max(n-.0016,0)+Math.max(this.PAt-e,0)}update(t,i){if(this.OAt<this.BAt)return!1;const e=this.PAt;return this.FAt(t,i),this.PAt>this.DAt&&(this.DAt=this.PAt,this.LAt.copyFromFloats(t,i)),!(this.OAt<this.BAt)&&(this.PAt>e&&(this.onMovement.notifyObservers({deltaT:this.PAt-e}),e<.5&&this.PAt>=.5&&this.onFootfall.notifyObservers({foot:this.NAt?"left":"right"})),this.PAt<.95*this.DAt&&(this.bAt.copyFromFloats(t,i),this.NAt?this.IAt.copyFrom(this.LAt):this.MAt.copyFrom(this.LAt),this.HL(this.IAt,this.MAt,this.bAt,!this.NAt)),!(this.yAt<.03))}get BAt(){return.1}get forward(){return this.Tx}}class hM{constructor(t){this.UAt=new nM,this.VAt=null,this.kAt=new C,this.GAt=hM.zAt,this.movementThisFrame=w.Zero(),this.Ls=t,this.UAt.onFirstStepDetected.add((t=>{this.VAt||(this.VAt=new rM(t.leftApex,t.rightApex,t.currentPosition,t.currentStepDirection),this.VAt.onFootfall.add((()=>{console.log("Footfall!")})),this.VAt.onMovement.add((t=>{this.VAt.forward.scaleAndAddToRef(.024*t.deltaT,this.kAt)})))}))}static get zAt(){return 1e3/15}update(t,i){if(i.y=0,i.normalize(),this.GAt+=this.Ls.getDeltaTime(),this.GAt>=hM.zAt){if(this.GAt-=hM.zAt,this.UAt.update(t.x,t.z,i.x,i.z),this.VAt){this.VAt.update(t.x,t.z)||(this.VAt=null)}this.kAt.scaleInPlace(.85)}this.movementThisFrame.set(this.kAt.x,0,this.kAt.y)}}class oM extends xn{constructor(t,i){super(t),this.Rx=new w,this.Tx=new w,this.rA=new w,this.kAt=new w,this.HAt=t,this.locomotionTarget=i.locomotionTarget,this.XAt&&F.Warn("Using walking locomotion directly on a WebXRCamera may have unintended interactions with other XR techniques. Using an XR space parent is highly recommended")}static get Name(){return Cn.WALKING_LOCOMOTION}static get Version(){return 1}get locomotionTarget(){return this.WAt}set locomotionTarget(t){this.WAt=t,this.XAt="WebXRCamera"===this.WAt.getClassName()}isCompatible(){return void 0===this.HAt.sessionMode||"immersive-vr"===this.HAt.sessionMode}attach(){return!(!this.isCompatible||!super.attach())&&(this.VAt=new hM(this.HAt.scene.getEngine()),!0)}detach(){return!!super.detach()&&(this.VAt=null,!0)}PN(t){const i=t.getViewerPose(this.HAt.baseReferenceSpace);if(!i)return;const e=this.locomotionTarget.getScene().useRightHandedSystem?1:-1,s=i.transform.matrix;this.Rx.copyFromFloats(s[4],s[5],e*s[6]),this.Tx.copyFromFloats(s[8],s[9],e*s[10]),this.rA.copyFromFloats(s[12],s[13],e*s[14]),this.Tx.scaleAndAddToRef(.05,this.rA),this.Rx.scaleAndAddToRef(-.05,this.rA),this.VAt.update(this.rA,this.Tx),this.kAt.copyFrom(this.VAt.movementThisFrame),this.XAt||w.TransformNormalToRef(this.kAt,this.locomotionTarget.getWorldMatrix(),this.kAt),this.locomotionTarget.position.addInPlace(this.kAt)}}wn.AddWebXRFeature(oM.Name,((t,i)=>()=>new oM(t,i)),oM.Version,!1);class aM extends ac{constructor(t,i,e,s,n,r){super(t,i,e,s,r),this.getWidth=t,this.getHeight=i,this.layer=e,this.layerType=s,this.isMultiview=n,this.createRTTProvider=r}}class lM extends lc{constructor(t,i,e){super(t.scene,e),this.RN=t,this.nAt=i,this.layerWrapper=e,this.$At=new Map,this.YAt=e.layer}jAt(t,i){const e=this.$At.get(i),s="left"==i?0:1;return this.WW[s]&&(null==e?void 0:e.textureWidth)===t.textureWidth&&(null==e?void 0:e.textureHeight)==t.textureHeight||(this.WW[s]=this.dL(t.textureWidth,t.textureHeight,null,t.colorTexture,t.depthStencilTexture,this.layerWrapper.isMultiview),this.YW={framebufferWidth:t.textureWidth,framebufferHeight:t.textureHeight}),this.$At.set(i,t),this.WW[s]}KAt(t){const i=this.RN.currentFrame;return i?this.nAt.getSubImage(this.YAt,i,t):null}getRenderTargetTextureForEye(t){const i=this.KAt(t);return i?this.jAt(i,t):null}getRenderTargetTextureForView(t){return this.getRenderTargetTextureForEye(t.eye)}qAt(t,i){const e=i.textureWidth,s=i.textureHeight,n=i.viewport;t.x=n.x/e,t.y=n.y/s,t.width=n.width/e,t.height=n.height/s}trySetViewportForView(t,i){const e=this.$At.get(i.eye)||this.KAt(i.eye);return!!e&&(this.qAt(t,e),!0)}}class cM extends aM{constructor(t,i,e){super((()=>t.textureWidth),(()=>t.textureHeight),t,"XRProjectionLayer",i,(t=>new uM(t,e,this))),this.layer=t}}class uM extends lM{constructor(t,i,e){super(t,i,e),this.layerWrapper=e,this.QAt=e.layer}ZAt(t){return this.nAt.getViewSubImage(this.QAt,t)}getRenderTargetTextureForView(t){return this.jAt(this.ZAt(t),t.eye)}getRenderTargetTextureForEye(t){const i=this.$At.get(t);return i?this.jAt(i,t):null}trySetViewportForView(t,i){const e=this.$At.get(i.eye)||this.ZAt(i);return!!e&&(this.qAt(t,e),!0)}}const fM={},dM={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1};class pM extends xn{constructor(t,i={}){super(t),this.wb=i,this.JAt=[],this.xrNativeFeatureName="layers"}attach(){if(!super.attach())return!1;const t=this.RN.scene.getEngine();this.tCt=t.lo,this.nAt=new XRWebGLBinding(this.RN.session,this.tCt),this.JAt.length=0;const i={...dM},e=this.wb.preferMultiviewOnInit&&t.getCaps().multiview;return e&&(i.textureType="texture-array"),this.addXRSessionLayer(this.createProjectionLayer(i,e)),!0}detach(){return!!super.detach()&&(this.JAt.length=0,!0)}createXRWebGLLayer(t=fM){const i=new XRWebGLLayer(this.RN.session,this.tCt,t);return new cc(i)}createProjectionLayer(t=dM,i=!1){if(i&&"texture-array"!==t.textureType)throw new Error("Projection layers can only be made multiview if they use texture arrays. Set the textureType parameter to 'texture-array'.");if(!i&&"texture-array"===t.textureType)throw new Error("We currently only support multiview rendering when the textureType parameter is set to 'texture-array'.");const e=this.nAt.createProjectionLayer(t);return new cM(e,i,this.nAt)}addXRSessionLayer(t){this.setXRSessionLayers([...this.JAt,t])}setXRSessionLayers(t){this.JAt=t;const i={...this.RN.session.renderState};i.baseLayer=void 0,i.layers=t.map((t=>t.layer)),this.RN.updateRenderState(i),this.RN.u$(t.length>0?t[0]:null)}isCompatible(){return!this.RN.isNative&&"undefined"!=typeof XRWebGLBinding&&!!XRWebGLBinding.prototype.createProjectionLayer}dispose(){super.dispose()}PN(t){}}pM.Name=Cn.LAYERS,pM.Version=1,wn.AddWebXRFeature(pM.Name,((t,i)=>()=>new pM(t,i)),pM.Version,!1);class mM extends Kg{constructor(t,i,e){super(t,vM[e],i,e,!0),this.profileId="generic-hand-select-grasp"}e9(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}t9(){return!0}r9(t){}n9(t){}l9(){}}tS.RegisterController("generic-hand-select-grasp",((t,i)=>new mM(i,t.gamepad,t.handedness)));const vM={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-none",assetPath:"none.glb"}};class gM extends Kg{constructor(t,i,e){super(t,SM["left-right"],i,e),this.G3={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},this.profileId="microsoft-mixed-reality"}e9(){let t="";t="left"===this.handedness?gM.MODEL_LEFT_FILENAME:gM.MODEL_RIGHT_FILENAME;return{filename:t,path:gM.MODEL_BASE_URL+"default/"}}t9(){const t=On.IsPluginForExtensionAvailable(".glb");return t||F.Warn("glTF / glb loaded was not registered, using generic controller instead"),t}r9(t){this.rootMesh&&(this.getComponentIds().forEach(((t,i)=>{if(!this.disableAnimation&&t&&this.rootMesh){const e=this.G3.buttons[t],s=e.rootNodeName;if(!s)return void F.Log("Skipping unknown button at index: "+i+" with mapped name: "+t);const n=this.h9(this.rootMesh,s);if(!n)return void F.Warn("Missing button mesh with name: "+s);if(e.valueMesh=this.o9(n,this.G3.defaultButton.valueNodeName),e.pressedMesh=this.o9(n,this.G3.defaultButton.pressedNodeName),e.unpressedMesh=this.o9(n,this.G3.defaultButton.unpressedNodeName),e.valueMesh&&e.pressedMesh&&e.unpressedMesh){const i=this.getComponent(t);i&&i.onButtonStateChangedObservable.add((t=>{this.a9(e,t.value)}),void 0,!0)}else F.Warn("Missing button submesh under mesh with name: "+s)}})),this.getComponentIds().forEach((t=>{const i=this.getComponent(t);i.isAxes()&&["x-axis","y-axis"].forEach((e=>{if(!this.rootMesh)return;const s=this.G3.axes[t][e],n=this.h9(this.rootMesh,s.rootNodeName);n?(s.valueMesh=this.o9(n,this.G3.defaultAxis.valueNodeName),s.minMesh=this.o9(n,this.G3.defaultAxis.minNodeName),s.maxMesh=this.o9(n,this.G3.defaultAxis.maxNodeName),s.valueMesh&&s.minMesh&&s.maxMesh?i&&i.onAxisValueChangedObservable.add((t=>{const i="x-axis"===e?t.x:t.y;this.a9(s,i,!0)}),void 0,!0):F.Warn("Missing axis submesh under mesh with name: "+s.rootNodeName)):F.Warn("Missing axis mesh with name: "+s.rootNodeName)}))})))}n9(t){let i;this.rootMesh=new Ys(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let e=0;e<t.length;e++){const s=t[e];s.isPickable=!1,s.parent||(i=s)}i&&i.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=T.FromEulerAngles(0,Math.PI,0))}l9(){}}gM.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",gM.MODEL_LEFT_FILENAME="left.glb",gM.MODEL_RIGHT_FILENAME="right.glb",tS.RegisterController("windows-mixed-reality",((t,i)=>new gM(i,t.gamepad,t.handedness)));const SM={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}};class EM extends Kg{constructor(t,i,e,s=!1,n=!1){super(t,AM[e],i,e),this.iCt=n,this.profileId="oculus-touch"}e9(){let t="";t="left"===this.handedness?EM.MODEL_LEFT_FILENAME:EM.MODEL_RIGHT_FILENAME;return{filename:t,path:this.eCt()?EM.QUEST_MODEL_BASE_URL:EM.MODEL_BASE_URL}}t9(){return!0}r9(t){const i=this.eCt(),e="right"===this.handedness?-1:1;this.getComponentIds().forEach((t=>{const s=t&&this.getComponent(t);s&&s.onButtonStateChangedObservable.add((s=>{if(this.rootMesh&&!this.disableAnimation)switch(t){case"xr-standard-trigger":return void(i||(this.sCt.getChildren()[3].rotation.x=.2*-s.value,this.sCt.getChildren()[3].position.y=.005*-s.value,this.sCt.getChildren()[3].position.z=.005*-s.value));case"xr-standard-squeeze":return void(i||(this.sCt.getChildren()[4].position.x=e*s.value*.0035));case"xr-standard-thumbstick":return;case"a-button":case"x-button":return void(i||(s.pressed?this.sCt.getChildren()[1].position.y=-.001:this.sCt.getChildren()[1].position.y=0));case"b-button":case"y-button":return void(i||(s.pressed?this.sCt.getChildren()[2].position.y=-.001:this.sCt.getChildren()[2].position.y=0))}}),void 0,!0)}))}n9(t){this.rootMesh=new Ys(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=T.FromEulerAngles(0,Math.PI,0)),t.forEach((t=>{t.isPickable=!1})),this.eCt()?this.sCt=t[0]:(this.sCt=t[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this.sCt.parent=this.rootMesh}l9(){}eCt(){return!!navigator.userAgent.match(/Quest/gi)&&!this.iCt}}EM.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",EM.MODEL_LEFT_FILENAME="left.babylon",EM.MODEL_RIGHT_FILENAME="right.babylon",EM.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",tS.RegisterController("oculus-touch",((t,i)=>new EM(i,t.gamepad,t.handedness))),tS.RegisterController("oculus-touch-legacy",((t,i)=>new EM(i,t.gamepad,t.handedness,!0)));const AM={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}};class CM extends Kg{constructor(t,i,e){super(t,wM[e],i,e),this.profileId="htc-vive"}e9(){return{filename:CM.MODEL_FILENAME,path:CM.MODEL_BASE_URL}}t9(){return!0}r9(t){this.getComponentIds().forEach((t=>{const i=t&&this.getComponent(t);i&&i.onButtonStateChangedObservable.add((i=>{if(this.rootMesh&&!this.disableAnimation)switch(t){case"xr-standard-trigger":return void(this.sCt.getChildren()[6].rotation.x=.15*-i.value);case"xr-standard-touchpad":case"xr-standard-squeeze":return}}),void 0,!0)}))}n9(t){this.rootMesh=new Ys(this.profileId+" "+this.handedness,this.scene),t.forEach((t=>{t.isPickable=!1})),this.sCt=t[1],this.sCt.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=T.FromEulerAngles(0,Math.PI,0))}l9(){}}CM.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",CM.MODEL_FILENAME="wand.babylon",tS.RegisterController("htc-vive",((t,i)=>new CM(i,t.gamepad,t.handedness)));const wM={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}};!async function(t,i){(await new Promise((t=>{"undefined"==typeof _native?cf.addOnce((i=>t(i))):t(_native)})))[t]=i}("NativeXRFrame",class{constructor(t){this.nCt=t,this.rCt=new XRRigidTransform,this.hCt={transform:this.rCt,emulatedPosition:!1},this.oCt=new Float32Array(8),this.fillPoses=this.nCt.fillPoses.bind(this.nCt),this.getViewerPose=this.nCt.getViewerPose.bind(this.nCt),this.getHitTestResults=this.nCt.getHitTestResults.bind(this.nCt),this.getHitTestResultsForTransientInput=()=>{throw new Error("XRFrame.getHitTestResultsForTransientInput not supported on native.")},this.createAnchor=this.nCt.createAnchor.bind(this.nCt),this.getJointPose=this.nCt.getJointPose.bind(this.nCt),this.fillJointRadii=this.nCt.fillJointRadii.bind(this.nCt),this.getLightEstimate=()=>{throw new Error("XRFrame.getLightEstimate not supported on native.")},this.getImageTrackingResults=()=>{var t;return null!==(t=this.nCt.aCt)&&void 0!==t?t:[]}}get session(){return this.nCt.session}getPose(t,i){if(!this.nCt.getPoseData(t,i,this.oCt.buffer,this.rCt.matrix.buffer))return;const e=this.rCt.position;e.x=this.oCt[0],e.y=this.oCt[1],e.z=this.oCt[2],e.w=this.oCt[3];const s=this.rCt.orientation;return s.x=this.oCt[4],s.y=this.oCt[5],s.z=this.oCt[6],s.w=this.oCt[7],this.hCt}get trackedAnchors(){return this.nCt.trackedAnchors}get worldInformation(){return this.nCt.worldInformation}get detectedPlanes(){return this.nCt.detectedPlanes}get featurePointCloud(){return this.nCt.featurePointCloud}});var xM=function(){function t(t,i,e,s,n){void 0===n&&(n=!1);var r=this;this.lCt=null,this.KS=null,this.cCt=9.8,this.uCt=30,this.fCt=45,this.dCt=Math.PI*this.uCt/180,this.pCt=Math.PI*this.fCt/180,this.mCt=.25,this.vCt=0,this.gCt=w.Zero(),this.SCt=new IM,this.ECt=!0,this.ACt=w.Zero(),this.CCt=!1,this.uA=0,this.wCt=0,this.xCt=!1,this.TCt=-1,this.Ult=!1,this.RCt=!1,this.ICt=null,this.MCt=w.Zero(),this.bCt=!1,this._Ct=0,this.yCt=50,this.NCt=0,this.PCt=!1,this.DCt=!1,this.LCt=!1,this.OCt=700,this.FCt=null,this.BCt=0,this.UCt=0,this.VCt=0,this.kCt=1,this.GCt=!1,this.zCt=!1,this.HCt=0,this.XCt=0,this.WCt=10,this.$Ct=!0,this.YCt=!1,this.jCt=new Map,this.KCt=new vn(w.Zero(),w.One(),1),this.qCt=w.Zero(),this.QCt=.5,this.ZCt=new Array,this.JCt=!1,this.twt=50,this.iwt=!1,this.ewt=!0,this.swt=!1,this.nwt=!1,this.rwt=!0,this.JD=i,null==this.JD&&(this.rwt=!1,this.setMode(1)),this.Kt=e,console.log("fsdfsdf"),this.setAvatar(t,n)||console.error("unable to set avatar");null!=s&&this.setActionMap(s),this.swt||null==this.KS||this.hwt(this.KS),this.swt,this.rwt&&(this.$Ct=this.JD.checkCollisions),this.owt=new TM,this.sgt=function(){r.awt()},this.lwt=function(t){r.Mm(t)},this.cwt=function(t){r.Im(t)}}return t.prototype.getScene=function(){return this.Kt},t.prototype.setSlopeLimit=function(t,i){this.uCt=t,this.fCt=i,this.dCt=Math.PI*this.uCt/180,this.pCt=Math.PI*this.fCt/180},t.prototype.setStepOffset=function(t){this.mCt=t},t.prototype.setWalkSpeed=function(t){this.SCt.walk.speed=t},t.prototype.setRunSpeed=function(t){this.SCt.run.speed=t},t.prototype.setBackSpeed=function(t){this.SCt.walkBack.speed=t},t.prototype.setBackFastSpeed=function(t){this.SCt.walkBackFast.speed=t},t.prototype.setJumpSpeed=function(t){this.SCt.idleJump.speed=t,this.SCt.runJump.speed=t},t.prototype.setLeftSpeed=function(t){this.SCt.strafeLeft.speed=t},t.prototype.setLeftFastSpeed=function(t){this.SCt.strafeLeftFast.speed=t},t.prototype.setRightSpeed=function(t){this.SCt.strafeRight.speed=t},t.prototype.setRightFastSpeed=function(t){this.SCt.strafeLeftFast.speed=t},t.prototype.setTurnSpeed=function(t){this.SCt.turnLeft.speed=t*Math.PI/180,this.SCt.turnRight.speed=t*Math.PI/180},t.prototype.setTurnFastSpeed=function(t){this.SCt.turnLeftFast.speed=t*Math.PI/180,this.SCt.turnRightFast.speed=t*Math.PI/180},t.prototype.setGravity=function(t){this.cCt=t},t.prototype.setAnimationGroups=function(t){null!=this.ICt&&this.ICt.exist&&this.ICt.ag.stop(),this.swt=!0,this.setActionMap(t)},t.prototype.setAnimationRanges=function(t){this.swt=!1,this.setActionMap(t)},t.prototype.setActionMap=function(t){for(var i,e=!1,s=0,n=Object.keys(this.SCt);s<n.length;s++){var r=n[s],h=this.SCt[r];h instanceof RM&&(h.exist=!1,null!=(i=t[h.id])&&(i instanceof ts?(h.ag=i,h.name=h.ag.name,h.exist=!0,e=!0,this.nwt=!0):i.exist&&(this.nwt=!0,h.exist=!0,i instanceof Object?(i.ag&&(h.ag=i.ag,e=!0),i.name&&(h.name=i.name),null!=i.loop&&(h.loop=i.loop),i.rate&&(h.rate=i.rate),i.speed&&(h.speed=i.speed),i.sound&&(h.sound=i.sound)):h.name=i)))}return this.uwt(),this.ICt=null,e?"ag":"ar"},t.prototype.getActionMap=function(){for(var t=new IM,i=0,e=Object.keys(this.SCt);i<e.length;i++){var s=e[i],n=this.SCt[s];if(n instanceof RM&&n.exist){var r=t[n.id];r.ag=n.ag,r.name=n.name,r.loop=n.loop,r.rate=n.rate,r.speed=n.speed,r.key=n.key,r.sound=n.sound,r.exist=n.exist}}return t},t.prototype.getSettings=function(){var t=new MM;return t.faceForward=this.isFaceForward(),t.topDown=1==this.getMode(),t.turningOff=this.isTurningOff(),t.cameraTarget=this.ACt.clone(),t.cameraElastic=this.ECt,t.elasticSteps=this.twt,t.makeInvisble=this.JCt,t.gravity=this.cCt,t.keyboard=this.ewt,t.maxSlopeLimit=this.fCt,t.minSlopeLimit=this.uCt,t.noFirstPerson=this.CCt,t.stepOffset=this.mCt,t.sound=this.fwt,t},t.prototype.setSettings=function(t){this.setFaceForward(t.faceForward),this.setMode(t.topDown?1:0),this.setTurningOff(t.turningOff),this.setCameraTarget(t.cameraTarget),this.setCameraElasticity(t.cameraElastic),this.setElasticiSteps(t.elasticSteps),this.makeObstructionInvisible(t.makeInvisble),this.setGravity(t.gravity),this.enableKeyBoard(t.keyboard),this.setSlopeLimit(t.minSlopeLimit,t.maxSlopeLimit),this.setNoFirstPerson(t.noFirstPerson),this.setStepOffset(t.stepOffset),this.setSound(t.sound)},t.prototype.dwt=function(t,i,e,s){if(this.swt||null!=this.KS){if(null!=i)if(this.swt){if(!(i instanceof ts))return;t.ag=i,t.exist=!0}else{if(null==this.KS.getAnimationRange(t.name))return void(t.exist=!1);t.name=i,t.exist=!0}null!=s&&(t.loop=s),null!=e&&(t.rate=e)}},t.prototype.enableBlending=function(t){if(this.swt)for(var i=0,e=Object.keys(this.SCt);i<e.length;i++){var s=e[i],n=this.SCt[s];if(n instanceof RM&&n.exist)for(var r=0,h=n.ag.targetedAnimations;r<h.length;r++){var o=h[r];o.animation.enableBlending=!0,o.animation.blendingSpeed=t}}else null!==this.KS&&this.KS.enableBlending(t)},t.prototype.disableBlending=function(){if(this.swt)for(var t=0,i=Object.keys(this.SCt);t<i.length;t++){var e=i[t],s=this.SCt[e];if(s instanceof RM&&s.exist)for(var n=0,r=s.ag.targetedAnimations;n<r.length;n++){r[n].animation.enableBlending=!1}}},t.prototype.setWalkAnim=function(t,i,e){this.dwt(this.SCt.walk,t,i,e)},t.prototype.setRunAnim=function(t,i,e){this.dwt(this.SCt.run,t,i,e)},t.prototype.setWalkBackAnim=function(t,i,e){this.dwt(this.SCt.walkBack,t,i,e),this.pwt(this.SCt.walkBackFast,this.SCt.walkBack)},t.prototype.setWalkBackFastAnim=function(t,i,e){this.dwt(this.SCt.walkBackFast,t,i,e)},t.prototype.setSlideBackAnim=function(t,i,e){this.dwt(this.SCt.slideBack,t,i,e)},t.prototype.setIdleAnim=function(t,i,e){this.dwt(this.SCt.idle,t,i,e)},t.prototype.setTurnRightAnim=function(t,i,e){this.dwt(this.SCt.turnRight,t,i,e),this.pwt(this.SCt.turnRightFast,this.SCt.turnRight)},t.prototype.setTurnRightFastAnim=function(t,i,e){this.dwt(this.SCt.turnRightFast,t,i,e)},t.prototype.setTurnLeftAnim=function(t,i,e){this.dwt(this.SCt.turnLeft,t,i,e),this.pwt(this.SCt.turnLeftFast,this.SCt.turnLeft)},t.prototype.setTurnLeftFastAnim=function(t,i,e){this.dwt(this.SCt.turnLeftFast,t,i,e)},t.prototype.setStrafeRightAnim=function(t,i,e){this.dwt(this.SCt.strafeRight,t,i,e),this.pwt(this.SCt.strafeRightFast,this.SCt.strafeRight)},t.prototype.setStrafeRightFastAnim=function(t,i,e){this.dwt(this.SCt.strafeRightFast,t,i,e)},t.prototype.setStrafeLeftAnim=function(t,i,e){this.dwt(this.SCt.strafeLeft,t,i,e),this.pwt(this.SCt.strafeLeftFast,this.SCt.strafeLeft)},t.prototype.setStrafeLeftFastAnim=function(t,i,e){this.dwt(this.SCt.strafeLeftFast,t,i,e)},t.prototype.setIdleJumpAnim=function(t,i,e){this.dwt(this.SCt.idleJump,t,i,e)},t.prototype.setRunJumpAnim=function(t,i,e){this.dwt(this.SCt.runJump,t,i,e)},t.prototype.setFallAnim=function(t,i,e){this.dwt(this.SCt.fall,t,i,e)},t.prototype.setSound=function(t){if(null!=t){this.fwt=t;var i=Object.keys(this.SCt);t.loop=!1;for(var e=0,s=i;e<s.length;e++){var n=s[e],r=this.SCt[n];r instanceof RM&&(r.sound=t,r.sound.attachToMesh(this.lCt))}this.SCt.idle.sound=null,this.SCt.fall.sound=null,this.SCt.slideBack.sound=null}},t.prototype.setWalkKey=function(t){this.SCt.walk.key=t.toLowerCase()},t.prototype.setWalkBackKey=function(t){this.SCt.walkBack.key=t.toLowerCase()},t.prototype.setTurnLeftKey=function(t){this.SCt.turnLeft.key=t.toLowerCase()},t.prototype.setTurnRightKey=function(t){this.SCt.turnRight.key=t.toLowerCase()},t.prototype.setStrafeLeftKey=function(t){this.SCt.strafeLeft.key=t.toLowerCase()},t.prototype.setStrafeRightKey=function(t){this.SCt.strafeRight.key=t.toLowerCase()},t.prototype.setJumpKey=function(t){this.SCt.idleJump.key=t.toLowerCase()},t.prototype.setCameraElasticity=function(t){this.ECt=t},t.prototype.setElasticiSteps=function(t){this.twt=t},t.prototype.makeObstructionInvisible=function(t){this.JCt=t},t.prototype.setCameraTarget=function(t){this.ACt.copyFrom(t)},t.prototype.cameraCollisionChanged=function(){this.$Ct=this.JD.checkCollisions},t.prototype.setNoFirstPerson=function(t){this.CCt=t},t.prototype.hwt=function(t){for(var i=0,e=Object.keys(this.SCt);i<e.length;i++){var s=e[i],n=this.SCt[s];n instanceof RM&&(null!=t?null!=t.getAnimationRange(n.id)&&(n.name=n.id,n.exist=!0,this.nwt=!0):n.exist=!1)}this.uwt()},t.prototype.uwt=function(){this.pwt(this.SCt.walkBackFast,this.SCt.walkBack),this.pwt(this.SCt.turnRightFast,this.SCt.turnRight),this.pwt(this.SCt.turnLeftFast,this.SCt.turnLeft),this.pwt(this.SCt.strafeRightFast,this.SCt.strafeRight),this.pwt(this.SCt.strafeLeftFast,this.SCt.strafeLeft)},t.prototype.pwt=function(t,i){t.exist||i.exist&&(t.exist=!0,t.ag=i.ag,t.name=i.name,t.rate=2*i.rate)},t.prototype.setMode=function(t){this.rwt?(this.uA=t,this.wCt=t):(this.uA=1,this.wCt=1)},t.prototype.getMode=function(){return this.uA},t.prototype.setTurningOff=function(t){this.zCt=t},t.prototype.isTurningOff=function(){return this.zCt},t.prototype.mwt=function(t){var i=t.getWorldMatrix(),e=w.FromArray(i.m,0),s=w.FromArray(i.m,4),n=w.FromArray(i.m,8),r=w.Cross(e,s);w.Dot(r,n)<0?(this.xCt=!0,this.TCt=1):(this.xCt=!1,this.TCt=-1)},t.prototype.setFaceForward=function(t){if(this.vwt=t,this.gwt=this.Kt.useRightHandedSystem?-1:1,!this.rwt)return this.Swt=0,void(this.Ewt=1);this.xCt?(this.Swt=t?Math.PI/2:3*Math.PI/2,this.Ewt=t?1:-1):(this.Swt=t?3*Math.PI/2:Math.PI/2,this.Ewt=t?-1:1)},t.prototype.isFaceForward=function(){return this.vwt},t.prototype.checkAGs=function(t){for(var i=0,e=Object.keys(this.SCt);i<e.length;i++){var s=e[i],n=this.SCt[s];n instanceof RM&&(null!=t[n.name]&&(n.ag=t[n.name],n.exist=!0))}},t.prototype.Awt=function(t,i,e){var s;s=e?this.Cwt(t).getChildren((function(t){return t instanceof Is}),!1):[t];for(var n=0,r=i;n<r.length;n++)for(var h=0,o=r[n].targetedAnimations;h<o.length;h++){var a=o[h];if(s.indexOf(a.target)>-1)return!0}return!1},t.prototype.Cwt=function(t){return null==t.parent?t:this.Cwt(t.parent)},t.prototype.start=function(){this.Ult||(this.Ult=!0,this.owt.reset(),this.VCt=0,this.HCt=.001,this.bCt=!1,this.wwt(),this.ewt&&this.xwt(),this.Kt.registerBeforeRender(this.sgt))},t.prototype.stop=function(){this.Ult&&(this.Ult=!1,this.Kt.unregisterBeforeRender(this.sgt),this.Twt(),this.ICt=null)},t.prototype.pauseAnim=function(){this.RCt=!0,null!=this.ICt&&this.ICt.exist&&(this.swt?this.ICt.ag.stop():this.Kt.stopAnimation(this.KS),null!=this.ICt.sound&&this.ICt.sound.stop(),clearInterval(this.FCt),this.Kt.unregisterBeforeRender(this.sgt))},t.prototype.resumeAnim=function(){this.RCt=!1,this.ICt=null,this.Kt.registerBeforeRender(this.sgt)},t.prototype.Rwt=function(){return this.rwt?w.Dot(this.lCt.forward,this.lCt.position.subtract(this.JD.position))<0?1:-1:1},t.prototype.awt=function(){this.MCt.copyFrom(this.lCt.position);var t=null,i=this.Kt.getEngine().getDeltaTime()/1e3;if(this.owt.Iwt&&!this.PCt?(this.bCt=!1,this.HCt=0,t=this.Mwt(i)):this.anyMovement()||this.PCt?(this.bCt=!1,this.HCt=0,t=this.bwt(i)):this.PCt||(t=this._wt(i)),!this.RCt&&this.nwt&&null!=t&&this.ICt!==t){if(t.exist){var e=void 0,s=30;if(this.swt)null!=this.ICt&&this.ICt.exist&&this.ICt.ag.stop(),t.ag.start(t.loop,t.rate),s=t.ag.targetedAnimations[0].animation.framePerSecond,e=t.ag.to-t.ag.from;else s=this.KS.beginAnimation(t.name,t.loop,t.rate).getAnimations()[0].animation.framePerSecond,e=this.KS.getAnimationRange(t.name).to-this.KS.getAnimationRange(t.name).from;null!=this.ICt&&null!=this.ICt.sound&&this.ICt.sound.stop(),clearInterval(this.FCt),null!=t.sound&&(t.sound.play(),this.FCt=setInterval((function(){t.sound.play()}),1e3*e/(s*Math.abs(t.rate)*2)))}this.ICt=t}this.wwt()},t.prototype.Mwt=function(t){var i=null;i=this.SCt.runJump,0===this.UCt&&(this.BCt=this.lCt.position.y),this.UCt=this.UCt+t;var e,s=0,n=0;if(this.rwt&&1!=this.uA&&!this.zCt&&(this.lCt.rotation.y=this.Swt-this.JD.alpha),this.LCt||this.DCt?(this.LCt?s=this.SCt.run.speed*t:this.DCt&&(s=this.SCt.walk.speed*t),(e=this.ywt.clone()).y=0,(e=e.normalize()).scaleToRef(s,e),n=this.Nwt(this.SCt.runJump.speed,t),e.y=n):(n=this.Nwt(this.SCt.idleJump.speed,t),e=new w(0,n,0),i=this.SCt.idleJump),this.lCt.moveWithCollisions(e),n<0)if(this.lCt.position.y>this.MCt.y||this.lCt.position.y===this.MCt.y&&e.length()>.001)this.Pwt();else if(this.lCt.position.y<this.BCt){var r=this.lCt.position.subtract(this.MCt);this.Dwt(r,e,.001)?i=this.SCt.fall:this.Lwt(r)<=this.dCt&&this.Pwt()}return i},t.prototype.Nwt=function(t,i){return(t-this.cCt*this.UCt)*i-.5*this.cCt*i*i},t.prototype.Pwt=function(){this.owt.Iwt=!1,this.UCt=0,this.DCt=!1,this.LCt=!1},t.prototype.Dwt=function(t,i,e){return Math.abs(t.x-i.x)<e&&Math.abs(t.y-i.y)<e&&Math.abs(t.z-i.z)<e},t.prototype.Lwt=function(t){return Math.atan(Math.abs(t.y/Math.sqrt(t.x*t.x+t.z*t.z)))},t.prototype.bwt=function(t){var i=this.VCt*this.cCt;this._Ct=i*t+this.cCt*t*t/2,this.VCt=this.VCt+t;var e=!1,s=null;if(this.PCt&&(this.ywt.y=-this._Ct,e=!0),this.Owt(),s=this.Fwt(s,e,t),!this.PCt){this.DCt=!1,this.LCt=!1;var n=void 0,r=0;switch(!0){case this.owt.Bwt:n=this.TCt*this.Rwt(),r=this.SCt.strafeLeft.speed*t,this.owt.Uwt?(r=this.SCt.strafeLeftFast.speed*t,s=-this.Ewt*n>0?this.SCt.strafeLeftFast:this.SCt.strafeRightFast):s=-this.Ewt*n>0?this.SCt.strafeLeft:this.SCt.strafeRight,this.ywt=this.lCt.calcMovePOV(n*r,-this._Ct,0),e=!0;break;case this.owt.Vwt:n=-this.TCt*this.Rwt(),r=this.SCt.strafeRight.speed*t,this.owt.Uwt?(r=this.SCt.strafeRightFast.speed*t,s=-this.Ewt*n>0?this.SCt.strafeLeftFast:this.SCt.strafeRightFast):s=-this.Ewt*n>0?this.SCt.strafeLeft:this.SCt.strafeRight,this.ywt=this.lCt.calcMovePOV(n*r,-this._Ct,0),e=!0;break;case this.owt.kwt||this.zCt&&0==this.uA:this.owt.Uwt?(this.LCt=!0,r=this.SCt.run.speed*t,s=this.SCt.run):(this.DCt=!0,r=this.SCt.walk.speed*t,s=this.SCt.walk),this.ywt=this.lCt.calcMovePOV(0,-this._Ct,this.Ewt*r),e=!0;break;case this.owt.Gwt:r=this.SCt.walkBack.speed*t,this.owt.Uwt?(r=this.SCt.walkBackFast.speed*t,s=this.SCt.walkBackFast):s=this.SCt.walkBack,this.ywt=this.lCt.calcMovePOV(0,-this._Ct,-this.Ewt*r),e=!0}}if(e&&this.ywt.length()>.001)if(this.lCt.moveWithCollisions(this.ywt),this.lCt.position.y>this.MCt.y){var h=this.lCt.position.subtract(this.MCt),o=this.Lwt(h);o>=this.pCt?this.mCt>0?(0==this.vCt&&this.gCt.copyFrom(this.MCt),this.vCt=this.vCt+(this.lCt.position.y-this.MCt.y),this.vCt>this.mCt&&(this.vCt=0,this.lCt.position.copyFrom(this.gCt),this.zwt())):(this.lCt.position.copyFrom(this.MCt),this.zwt()):(this.vCt=0,o>this.dCt?(this.NCt=0,this.PCt=!1):this.zwt())}else if(this.lCt.position.y<this.MCt.y){h=this.lCt.position.subtract(this.MCt);this.Dwt(h,this.ywt,.001)?(this.PCt=!0,this.NCt++,this.NCt>this.yCt&&(s=this.SCt.fall)):this.Lwt(h)<=this.dCt?this.zwt():(this.NCt=0,this.PCt=!1)}else this.zwt();return s},t.prototype.Owt=function(){if(this.rwt&&1!=this.uA){var t=this.rwt?this.Swt-this.JD.alpha:0;if(this.zCt)switch(!0){case this.owt.kwt&&this.owt.Hwt:this.lCt.rotation.y=t+this.gwt*Math.PI/4;break;case this.owt.kwt&&this.owt.Xwt:this.lCt.rotation.y=t-this.gwt*Math.PI/4;break;case this.owt.Gwt&&this.owt.Hwt:this.lCt.rotation.y=t+3*this.gwt*Math.PI/4;break;case this.owt.Gwt&&this.owt.Xwt:this.lCt.rotation.y=t-3*this.gwt*Math.PI/4;break;case this.owt.kwt:this.lCt.rotation.y=t;break;case this.owt.Gwt:this.lCt.rotation.y=t+Math.PI;break;case this.owt.Hwt:this.lCt.rotation.y=t+this.gwt*Math.PI/2;break;case this.owt.Xwt:this.lCt.rotation.y=t-this.gwt*Math.PI/2}else this.rwt&&(this.lCt.rotation.y=t)}},t.prototype.Fwt=function(t,i,e){if((!this.zCt||0!=this.uA)&&!this.owt.Bwt&&!this.owt.Vwt&&(this.owt.Xwt||this.owt.Hwt)){var s=this.SCt.turnLeft.speed*e;this.owt.Uwt&&(s*=2);var n=void 0;1==this.uA?(this.GCt||(this.kCt=-this.Ewt*this.Rwt(),this.xCt&&(this.kCt=-this.kCt),this.GCt=!0),n=this.kCt,this.owt.Xwt?this.owt.kwt||(this.owt.Gwt?n=-this.kCt:t=this.kCt>0?this.SCt.turnRight:this.SCt.turnLeft):this.owt.kwt?n=-this.kCt:this.owt.Gwt||(n=-this.kCt,t=this.kCt>0?this.SCt.turnLeft:this.SCt.turnRight)):(n=1,this.owt.Xwt?(this.owt.Gwt&&(n=-1),i||(t=this.SCt.turnLeft)):(this.owt.kwt&&(n=-1),i||(n=-1,t=this.SCt.turnRight)),this.rwt&&(this.JD.alpha=this.JD.alpha+this.gwt*s*n)),this.lCt.rotation.y=this.lCt.rotation.y+s*n}return t},t.prototype.zwt=function(){this.VCt=0,this.NCt=0,this.PCt=!1},t.prototype._wt=function(t){if(this.bCt)return this.SCt.idle;this.DCt=!1,this.LCt=!1,this.VCt=0;var i=this.SCt.idle;if(this.NCt=0,0===t)this._Ct=5;else{var e=this.HCt*this.cCt;this._Ct=e*t+this.cCt*t*t/2,this.HCt=this.HCt+t}if(this._Ct<.01)return i;var s=new w(0,-this._Ct,0);if(this.rwt&&1!=this.uA&&!this.zCt&&(this.lCt.rotation.y=this.Swt-this.JD.alpha),this.lCt.moveWithCollisions(s),this.lCt.position.y>this.MCt.y||this.lCt.position.y===this.MCt.y)this.Wwt();else if(this.lCt.position.y<this.MCt.y){var n=this.lCt.position.subtract(this.MCt);this.Dwt(n,s,.001)||(this.Lwt(n)<=this.dCt?(this.Wwt(),this.lCt.position.copyFrom(this.MCt)):(this.$wt(),i=this.SCt.slideBack))}return i},t.prototype.Wwt=function(){this.XCt++,this.XCt>this.WCt&&(this.bCt=!0,this.HCt=0)},t.prototype.$wt=function(){this.bCt=!1,this.XCt=0},t.prototype.wwt=function(){this.rwt&&(0==this.vCt&&this.lCt.position.addToRef(this.ACt,this.JD.target),this.JD.radius>this.JD.lowerRadiusLimit&&(this.ECt||this.JCt)&&this.Ywt(),this.JD.radius<=this.JD.lowerRadiusLimit?this.CCt||this.YCt||(this.jwt(this.lCt),this.JD.checkCollisions=!1,this.wCt=this.uA,this.uA=0,this.YCt=!0):this.YCt&&(this.YCt=!1,this.uA=this.wCt,this.Kwt(this.lCt),this.JD.checkCollisions=this.$Ct))},t.prototype.jwt=function(t){var i=this;this.jCt.set(t,t.visibility),t.visibility=0,t.getChildMeshes(!1,(function(t){return t instanceof Ys&&(i.jCt.set(t,t.visibility),t.visibility=0),!1}))},t.prototype.Kwt=function(t){var i=this;t.visibility=this.jCt.get(t),t.getChildMeshes(!1,(function(t){return t instanceof Ys&&(t.visibility=i.jCt.get(t)),!1}))},t.prototype.Ywt=function(){var t=this;this.JD.position.subtractToRef(this.JD.target,this.qCt),this.KCt.origin=this.JD.target,this.KCt.length=this.qCt.length(),this.KCt.direction=this.qCt.normalize();var i=this.Kt.multiPickWithRay(this.KCt,(function(i){return i!=t.lCt&&!(t.lCt.getChildMeshes(!1,(function(t){return t instanceof Ys&&t==i})).length>0)}));if(this.JCt)if(this.qwt=this.ZCt,i.length>0){this.ZCt=new Array;for(var e=0,s=i;e<s.length;e++){var n=s[e];(n.pickedMesh.isVisible||this.qwt.includes(n.pickedMesh))&&(n.pickedMesh.isVisible=!1,this.ZCt.push(n.pickedMesh))}for(var r=0,h=this.qwt;r<h.length;r++){var o=h[r];this.ZCt.includes(o)||(o.isVisible=!0)}}else{for(var a=0,l=this.qwt;a<l.length;a++){(o=l[a]).isVisible=!0}this.qwt.length=0}if(this.ECt&&i.length>0){if(!(1!=i.length||this.Qwt(i[0].pickedMesh)||i[0].pickedMesh.checkCollisions&&this.JD.checkCollisions))return;for(var c=null,u=0;u<i.length;u++){o=i[u].pickedMesh;if(this.Qwt(o)){c=i[u].pickedPoint;break}if(o.checkCollisions){c=i[u].pickedPoint;break}}if(null==c)return;var f=this.JD.position.subtract(c),d=f.length();if(this.JD.checkCollisions){var p=void 0;p=d<=1?f.addInPlace(f.normalizeToNew().scaleInPlace(this.QCt)):f.normalize().scaleInPlace(d/this.twt),this.JD.position=this.JD.position.subtract(p)}else{p=void 0;p=d<=1?d+this.QCt:d/this.twt,this.JD.radius=this.JD.radius-p}}},t.prototype.Qwt=function(t){return!!t.isVisible&&(0!=t.visibility&&(null==t.material||0==t.material.alphaMode||0!=t.material.alpha))},t.prototype.anyMovement=function(){return this.owt.kwt||this.owt.Gwt||this.owt.Xwt||this.owt.Hwt||this.owt.Bwt||this.owt.Vwt},t.prototype.Im=function(t){if(t.key&&!t.repeat){switch(t.key.toLowerCase()){case this.SCt.idleJump.key:this.owt.Iwt=!0;break;case"capslock":this.owt.Uwt=!this.owt.Uwt;break;case"shift":this.owt.Uwt=!0;break;case"up":case"arrowup":case this.SCt.walk.key:this.owt.kwt=!0;break;case"left":case"arrowleft":case this.SCt.turnLeft.key:this.owt.Xwt=!0;break;case"right":case"arrowright":case this.SCt.turnRight.key:this.owt.Hwt=!0;break;case"down":case"arrowdown":case this.SCt.walkBack.key:this.owt.Gwt=!0;break;case this.SCt.strafeLeft.key:this.owt.Bwt=!0;break;case this.SCt.strafeRight.key:this.owt.Vwt=!0}this.iwt=this.anyMovement()}},t.prototype.Mm=function(t){if(t.key){switch(t.key.toLowerCase()){case"shift":this.owt.Uwt=!1;break;case"up":case"arrowup":case this.SCt.walk.key:this.owt.kwt=!1;break;case"left":case"arrowleft":case this.SCt.turnLeft.key:this.owt.Xwt=!1,this.GCt=!1;break;case"right":case"arrowright":case this.SCt.turnRight.key:this.owt.Hwt=!1,this.GCt=!1;break;case"down":case"arrowdown":case this.SCt.walkBack.key:this.owt.Gwt=!1;break;case this.SCt.strafeLeft.key:this.owt.Bwt=!1;break;case this.SCt.strafeRight.key:this.owt.Vwt=!1}this.iwt=this.anyMovement()}},t.prototype.isKeyBoardEnabled=function(){return this.ewt},t.prototype.enableKeyBoard=function(t){this.ewt=t,t?this.xwt():this.Twt()},t.prototype.xwt=function(){var t=this.Kt.getEngine().getRenderingCanvas();t.addEventListener("keyup",this.lwt,!1),t.addEventListener("keydown",this.cwt,!1)},t.prototype.Twt=function(){var t=this.Kt.getEngine().getRenderingCanvas();t.removeEventListener("keyup",this.lwt,!1),t.removeEventListener("keydown",this.cwt,!1)},t.prototype.walk=function(t){this.owt.kwt=t},t.prototype.walkBack=function(t){this.owt.Gwt=t},t.prototype.walkBackFast=function(t){this.owt.Gwt=t,this.owt.Uwt=t},t.prototype.run=function(t){this.owt.kwt=t,this.owt.Uwt=t},t.prototype.turnLeft=function(t){this.owt.Xwt=t,t||(this.GCt=t)},t.prototype.turnLeftFast=function(t){this.owt.Xwt=t,t||(this.GCt=t),this.owt.Uwt=t},t.prototype.turnRight=function(t){this.owt.Hwt=t,t||(this.GCt=t)},t.prototype.turnRightFast=function(t){this.owt.Hwt=t,t||(this.GCt=t),this.owt.Uwt=t},t.prototype.strafeLeft=function(t){this.owt.Bwt=t},t.prototype.strafeLeftFast=function(t){this.owt.Bwt=t,this.owt.Uwt=t},t.prototype.strafeRight=function(t){this.owt.Vwt=t},t.prototype.strafeRightFast=function(t){this.owt.Vwt=t,this.owt.Uwt=t},t.prototype.jump=function(){this.owt.Iwt=!0},t.prototype.idle=function(){this.owt.reset()},t.prototype.isAg=function(){return this.swt},t.prototype.Zwt=function(t){var i=this.Jwt(t);if(i instanceof Ys&&i.skeleton)return i.skeleton;var e=i.getChildMeshes(!1,(function(t){return!!(t instanceof Ys&&t.skeleton)}));return e.length>0?e[0].skeleton:null},t.prototype.Jwt=function(t){return null==t.parent?t:this.Jwt(t.parent)},t.prototype.setAvatar=function(t,i){void 0===i&&(i=!1);var e=this.Jwt(t);return e instanceof Ys?(this.lCt=e,this.KS=this.Zwt(t),this.swt=this.Awt(t,this.Kt.animationGroups,!0),this.SCt.reset(),this.swt||null==this.KS||this.hwt(this.KS),this.mwt(t),this.setFaceForward(i),!0):(console.error("Cannot move this mesh. The root node of the mesh provided is not a mesh"),!1)},t.prototype.getAvatar=function(){return this.lCt},t.prototype.setAvatarSkeleton=function(t){this.KS=t,null!=this.KS&&this.txt(t)?this.swt=!0:this.swt=!1,this.swt||null==this.KS||this.hwt(this.KS)},t.prototype.txt=function(t){var i=this;return t.animations.some((function(t){return i.Kt.animationGroups.some((function(i){return i.children.some((function(i){return i.animation==t}))}))}))},t.prototype.getSkeleton=function(){return this.KS},t}(),TM=function(){function t(){this.kwt=!1,this.Gwt=!1,this.Hwt=!1,this.Xwt=!1,this.Vwt=!1,this.Bwt=!1,this.Iwt=!1,this.Uwt=!1,this.reset()}return t.prototype.reset=function(){this.kwt=!1,this.Gwt=!1,this.Hwt=!1,this.Xwt=!1,this.Vwt=!1,this.Bwt=!1,this.Iwt=!1,this.Uwt=!1},t}(),RM=function(){function t(t,i,e){void 0===i&&(i=1),this.name="",this.loop=!0,this.rate=1,this.exist=!1,this.id=t,this.speed=i,this.ds=i,this.key=e,this.dk=e}return t.prototype.reset=function(){this.name="",this.speed=this.ds,this.key=this.dk,this.loop=!0,this.rate=1,this.sound=null,this.exist=!1},t}(),IM=function(){function t(){this.walk=new RM("walk",3,"w"),this.walkBack=new RM("walkBack",1.5,"s"),this.walkBackFast=new RM("walkBackFast",3,"na"),this.idle=new RM("idle",0,"na"),this.idleJump=new RM("idleJump",6," "),this.run=new RM("run",6,"na"),this.runJump=new RM("runJump",6,"na"),this.fall=new RM("fall",0,"na"),this.turnLeft=new RM("turnLeft",Math.PI/8,"a"),this.turnLeftFast=new RM("turnLeftFast",Math.PI/4,"na"),this.turnRight=new RM("turnRight",Math.PI/8,"d"),this.turnRightFast=new RM("turnRightFast",Math.PI/4,"na"),this.strafeLeft=new RM("strafeLeft",1.5,"q"),this.strafeLeftFast=new RM("strafeLeftFast",3,"na"),this.strafeRight=new RM("strafeRight",1.5,"e"),this.strafeRightFast=new RM("strafeRightFast",3,"na"),this.slideBack=new RM("slideBack",0,"na")}return t.prototype.reset=function(){for(var t=0,i=Object.keys(this);t<i.length;t++){var e=this[i[t]];e instanceof RM&&e.reset()}},t}(),MM=function(){this.cameraElastic=!0,this.makeInvisble=!0,this.cameraTarget=w.Zero(),this.noFirstPerson=!1,this.topDown=!0,this.turningOff=!0,this.keyboard=!0};return i})()));
//# sourceMappingURL=CharacterController.js.map